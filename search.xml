<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Operator 部署服务数据持久化</title>
      <link href="/2022/06/05/Operator-%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/"/>
      <url>/2022/06/05/Operator-%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><h3 id="1-1"><a href="#1-1" class="headerlink" title="1.1"></a>1.1</h3><p>默认使用<code>Operator</code>部署的<code>prometheus</code>和<code>grafana</code>存储数据都是使用的<code>emptyDir</code>格式的，所以服务重启后数据就会清空，生产环境肯定是不行的所以需要将数据持久化到磁盘</p><h1 id="二、配置"><a href="#二、配置" class="headerlink" title="二、配置"></a>二、配置</h1><h3 id="2-1-Prometheus持久化"><a href="#2-1-Prometheus持久化" class="headerlink" title="2.1 Prometheus持久化"></a>2.1 Prometheus持久化</h3><p>prometheus使用的是sts控制器，这边直接使用StorageClass</p><p>首先需要创建StorageClass存储（需要配置nfs 这里就不多赘述了）</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat nfs-sc.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01  </span><span class="token comment" spellcheck="true"># 此处供应者名字供storageclass调用</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/lnmp/prometheus_data  <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/lnmp/prometheus_data   <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span><span class="token comment" spellcheck="true"># Supported policies: Delete、 Retain ， default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#启动</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nfs-sc.yaml</span><span class="token comment" spellcheck="true">#查看</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n kube-system</span>NAME                                       READY   STATUS    RESTARTS   AGnfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>01<span class="token punctuation">-</span>7f7ccdb7bb<span class="token punctuation">-</span>nfsxb        1/1     Running   0          5h10m<span class="token comment" spellcheck="true">#修改prometheus存储配置</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring edit prometheus k8s</span>spec<span class="token punctuation">...</span><span class="token punctuation">...</span>  <span class="token key atrule">storage</span><span class="token punctuation">:</span>    <span class="token key atrule">volumeClaimTemplate</span><span class="token punctuation">:</span>      <span class="token key atrule">spec</span><span class="token punctuation">:</span>        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> ReadWriteMany        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge<span class="token comment" spellcheck="true">#稍后可以看到StorageClass会自动创建PVC和PV</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc -n monitoring</span>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEprometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0   Bound    pvc<span class="token punctuation">-</span>263e60ad<span class="token punctuation">-</span>44c1<span class="token punctuation">-</span>41a8<span class="token punctuation">-</span>9f2a<span class="token punctuation">-</span>77a35f507ad0   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       6h7mprometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>1   Bound    pvc<span class="token punctuation">-</span>73ee2d7f<span class="token punctuation">-</span>180c<span class="token punctuation">-</span>40b9<span class="token punctuation">-</span>925a<span class="token punctuation">-</span>0bddc58c4604   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       6h7m<span class="token comment" spellcheck="true">#登陆pod查看挂载</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it -n monitoring prometheus-k8s-0 -- /bin/sh</span>/prometheus $ df <span class="token punctuation">-</span>hFilesystem                Size      Used Available Use% Mounted onoverlay                  40.0G     13.1G     26.8G  33% /tmpfs                    64.0M         0     64.0M   0% /devtmpfs                     1.9G         0      1.9G   0% /sys/fs/cgroup10.7.48.223<span class="token punctuation">:</span>/data/lnmp/prometheus_data/monitoring<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>263e60ad<span class="token punctuation">-</span>44c1<span class="token punctuation">-</span>41a8<span class="token punctuation">-</span>9f2a<span class="token punctuation">-</span>77a35f507ad0/prometheus<span class="token punctuation">-</span>db</code></pre><h3 id="2-2Grafana持久化"><a href="#2-2Grafana持久化" class="headerlink" title="2.2Grafana持久化"></a>2.2Grafana持久化</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建Grafana的pvc</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat grafana-pvc.yaml</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token comment" spellcheck="true">#部署</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f grafana-pvc.yaml</span><span class="token comment" spellcheck="true">#查看pvc是否创建</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc -n monitoring</span>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEgrafana                              Bound    pvc<span class="token punctuation">-</span>c16d1015<span class="token punctuation">-</span>f1ed<span class="token punctuation">-</span>40be<span class="token punctuation">-</span>bfb2<span class="token punctuation">-</span>d980377692ea   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       5h23m<span class="token comment" spellcheck="true">#编辑grafana的deployment资源配置</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring edit deployments.apps grafan</span><span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span><span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>storage<span class="token comment" spellcheck="true">#更改为</span><span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>storage      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> grafana<span class="token comment" spellcheck="true">#同时建议添加环境变量配置默认密码</span><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_SECURITY_ADMIN_USER<span class="token key atrule">value</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_SECURITY_ADMIN_PASSWORD<span class="token key atrule">value</span><span class="token punctuation">:</span> admin321<span class="token comment" spellcheck="true">#保存退出</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Operator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubeadm卸载</title>
      <link href="/2022/06/05/Kubeadm%E5%8D%B8%E8%BD%BD/"/>
      <url>/2022/06/05/Kubeadm%E5%8D%B8%E8%BD%BD/</url>
      
        <content type="html"><![CDATA[<h1 id="删除kubeadm构建的Kubernetes集群"><a href="#删除kubeadm构建的Kubernetes集群" class="headerlink" title="删除kubeadm构建的Kubernetes集群"></a>删除kubeadm构建的Kubernetes集群</h1><p>所有通过 <a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/deployment/bootstrap_kubernetes_single/kubeadm.html#kubeadm">kubeadm</a> 工具构建的Kubernetes集群以及节点，都可以通过 <code>kubeadm</code> 工具反向卸载(删除)，这是一个非常方便的操作。我的实践是因为在开发测试环境， <a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/administer/kubeadm_administer/upgrade_kubeadm_cluster.html#upgrade-kubeadm-cluster">升级kubeadm集群</a> 失败，为了快速开始下一阶段测试工作，所以准备重建Kubernetes集群。</p><ul><li><p><code>kubeadm reset</code> 命令执行会提示:</p><pre><code>[reset] WARNING: Changes made to this host by &#39;kubeadm init&#39; or &#39;kubeadm join&#39; will be reverted.[reset] Are you sure you want to proceed? [y/N]:</code></pre></li></ul><p>也就是说，不管是加入集群的工作节点，还是初始化的管控节点，都可以用这个工具反向操作</p><ul><li><p>检查集群:</p><pre><code>kubectl get nodes</code></pre></li></ul><p>当前节点:</p><pre><code>NAME         STATUS   ROLES    AGE    VERSIONpi-master1   Ready    master   241d   v1.20.9pi-worker1   Ready    &lt;none&gt;   237d   v1.20.9pi-worker2   Ready    &lt;none&gt;   237d   v1.21.3zcloud       Ready    &lt;none&gt;   127d   v1.21.3</code></pre><ul><li><p>首先在 <code>zcloud</code> 上执行节点清理:</p><pre><code>kubeadm reset[reset] WARNING: Changes made to this host by &#39;kubeadm init&#39; or &#39;kubeadm join&#39; will be reverted.[reset] Are you sure you want to proceed? [y/N]: y</code></pre></li></ul><p>提示信息:</p><pre><code>[preflight] Running pre-flight checksW0728 23:50:09.914348 3734557 removeetcdmember.go:79] [reset] No kubeadm config, using etcd pod spec to get data directory[reset] No etcd config found. Assuming external etcd[reset] Please, manually reset etcd to prevent further issues[reset] Stopping the kubelet service[reset] Unmounting mounted directories in &quot;/var/lib/kubelet&quot;[reset] Deleting contents of config directories: [/etc/kubernetes/manifests /etc/kubernetes/pki][reset] Deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf][reset] Deleting contents of stateful directories: [/var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni]The reset process does not clean CNI configuration. To do so, you must remove /etc/cni/net.dThe reset process does not reset or clean up iptables rules or IPVS tables.If you wish to reset iptables, you must do so manually by using the &quot;iptables&quot; command.If your cluster was setup to utilize IPVS, run ipvsadm --clear (or similar)to reset your system&#39;s IPVS tables.The reset process does not clean your kubeconfig files and you must remove them manually.Please, check the contents of the $HOME/.kube/config file.</code></pre><p>可以看到 <code>reset</code> 过程不会清理CNI配置，也不会清理iptables规则，两者需要手工处理</p><ul><li><p>完成以后，在管控服务器上检查，可以看到该工作节点已经 <code>NotReady</code></p><pre><code>kubectl get nodes</code></pre></li></ul><p>显示:</p><pre><code>NAME         STATUS     ROLES    AGE    VERSIONpi-master1   Ready      master   241d   v1.20.9pi-worker1   Ready      &lt;none&gt;   237d   v1.20.9pi-worker2   Ready      &lt;none&gt;   237d   v1.21.3zcloud       NotReady   &lt;none&gt;   127d   v1.21.3</code></pre><ul><li><p>删除节点:</p><pre><code>kubectl delete node zcloud</code></pre></li><li><p>在工作节点上再执行一次清理 <code>iptables</code> 和 <code>cni</code></p><pre><code>rm -rf /etc/cni/net.diptables -F</code></pre></li><li><p>所有工作节点清理以后，最后执行管控节点卸载:</p><pre><code>kubeadm reset</code></pre></li></ul><p>输出信息:</p><pre><code>[preflight] Running pre-flight checks[reset] Removing info for node &quot;pi-master1&quot; from the ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; NamespaceW0729 00:23:55.555252 3406560 removeetcdmember.go:61] [reset] failed to remove etcd member: error syncing endpoints with etcd: context deadline exceeded, please manually remove this etcd member using etcdctl[reset] Stopping the kubelet service[reset] Unmounting mounted directories in &quot;/var/lib/kubelet&quot;[reset] Deleting contents of config directories: [/etc/kubernetes/manifests /etc/kubernetes/pki][reset] Deleting files: [/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf][reset] Deleting contents of stateful directories: [/var/lib/etcd /var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni]The reset process does not clean CNI configuration. To do so, you must remove /etc/cni/net.dThe reset process does not reset or clean up iptables rules or IPVS tables.If you wish to reset iptables, you must do so manually by using the &quot;iptables&quot; command.If your cluster was setup to utilize IPVS, run ipvsadm --clear (or similar)to reset your system&#39;s IPVS tables.The reset process does not clean your kubeconfig files and you must remove them manually.Please, check the contents of the $HOME/.kube/config file.</code></pre><ul><li><p>清理完好干净:</p><pre><code>root@pi-master1:~# docker psCONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMESroot@pi-master1:~# docker ps --allCONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> kubeadm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s中配置lnmp环境</title>
      <link href="/2022/06/05/K8s%E4%B8%AD%E9%85%8D%E7%BD%AElnmp%E7%8E%AF%E5%A2%83/"/>
      <url>/2022/06/05/K8s%E4%B8%AD%E9%85%8D%E7%BD%AElnmp%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h1 id="一、配置用于存储的NFS服务"><a href="#一、配置用于存储的NFS服务" class="headerlink" title="一、配置用于存储的NFS服务"></a>一、配置用于存储的NFS服务</h1><h3 id="1-1服务端配置-nfs"><a href="#1-1服务端配置-nfs" class="headerlink" title="1.1服务端配置 nfs"></a>1.1服务端配置 nfs</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#yum安装</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install nfs-utils</span><span class="token comment" spellcheck="true">#编辑 配置文件 （确保目录存在）</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># vim /etc/exports</span>/data/lnmp 10.7.0.0/16(rw<span class="token punctuation">,</span>no_root_squash)<span class="token comment" spellcheck="true">#启动服务</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl start nfs</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl status  nfs</span>● nfs<span class="token punctuation">-</span>server.service <span class="token punctuation">-</span> NFS server and services   <span class="token key atrule">Loaded</span><span class="token punctuation">:</span> loaded (/usr/lib/systemd/system/nfs<span class="token punctuation">-</span>server.service; disabled; vendor preset<span class="token punctuation">:</span> disabled)  <span class="token key atrule">Drop-In</span><span class="token punctuation">:</span> /run/systemd/generator/nfs<span class="token punctuation">-</span>server.service.d           └─order<span class="token punctuation">-</span>with<span class="token punctuation">-</span>mounts.conf   <span class="token key atrule">Active</span><span class="token punctuation">:</span> active (exited) since Sat 2021<span class="token punctuation">-</span>09<span class="token punctuation">-</span>11 17<span class="token punctuation">:</span>32<span class="token punctuation">:</span>16 HKT; 1 weeks 0 days ago Main PID<span class="token punctuation">:</span> 21698 (code=exited<span class="token punctuation">,</span> status=0/SUCCESS)    <span class="token key atrule">Tasks</span><span class="token punctuation">:</span> <span class="token number">0</span>   <span class="token key atrule">Memory</span><span class="token punctuation">:</span> 0B   <span class="token key atrule">CGroup</span><span class="token punctuation">:</span> /system.slice/nfs<span class="token punctuation">-</span>server.service<span class="token comment" spellcheck="true">#showmount确认</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># showmount -e</span>Export list for k8smaster<span class="token punctuation">:</span>/data/lnmp 10.7.0.0/16</code></pre><h3 id="1-2客户端挂载服务"><a href="#1-2客户端挂载服务" class="headerlink" title="1.2客户端挂载服务"></a>1.2客户端挂载服务</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#安装nfs客户端 </span><span class="token punctuation">[</span>root@k8snode ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install nfs-utils.x86_64</span><span class="token comment" spellcheck="true">#showmount -e查看</span><span class="token punctuation">[</span>root@k8snode ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># showmount -e 10.7.48.223</span>Export list for 10.7.48.223<span class="token punctuation">:</span>/data/lnmp 10.7.0.0/16<span class="token comment" spellcheck="true">#创建挂载点挂载</span><span class="token punctuation">[</span>root@k8snode data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /data</span><span class="token punctuation">[</span>root@k8snode data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mount -t nfs 10.7.48.223/data/lnmp /data</span></code></pre><h1 id="二-、配置LNMP环境"><a href="#二-、配置LNMP环境" class="headerlink" title="二 、配置LNMP环境"></a>二 、配置LNMP环境</h1><h3 id="2-1mysql配置清单"><a href="#2-1mysql配置清单" class="headerlink" title="2.1mysql配置清单"></a>2.1mysql配置清单</h3><p>配置前先创建需要的命名空间</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create ns  lnmp</span></code></pre><p>mysql清单配置如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pass              <span class="token key atrule">key</span><span class="token punctuation">:</span> password        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lnmp<span class="token punctuation">-</span>mysql          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lnmp<span class="token punctuation">-</span>mysql        <span class="token key atrule">nfs</span><span class="token punctuation">:</span>         <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token comment" spellcheck="true">#nfs server服务器IP</span>         <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/data/lnmp/mysql"</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql</code></pre><p>这里面mysql 密码是通过环境 变量的方式导入的密码配置参考下面方法</p><pre class=" language-yaml"><code class="language-yaml">kubectl create secret generic mysql<span class="token punctuation">-</span>pass <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>literal=password=123456 <span class="token punctuation">-</span>n lnmp</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#启动</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f mysql.yaml -n lnmp</span>deployment.apps/mysql createdservice/mysql unchanged<span class="token comment" spellcheck="true">#查看pod状态</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po  -n lnmp</span>NAME                        READY   STATUS    RESTARTS   AGEmysql<span class="token punctuation">-</span>6cc8488986<span class="token punctuation">-</span>2wf62      1/1     Running   0          13m<span class="token comment" spellcheck="true">#查看svc地址并确认端口连通性</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get svc  -n lnmp</span>NAME        TYPE        CLUSTER<span class="token punctuation">-</span>IP      EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)        AGEmysql       ClusterIP   10.97.108.119   &lt;none<span class="token punctuation">></span>        3306/TCP       2d20h<span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># telnet  10.97.108.119  3306</span>Trying 10.97.108.119<span class="token punctuation">...</span>Connected to 10.97.108.119.Escape character is '^<span class="token punctuation">]</span>'<span class="token comment" spellcheck="true">#端口可以正常访问mysql的配置就是正常的</span></code></pre><h3 id="2-2-nginx-php配置清单"><a href="#2-2-nginx-php配置清单" class="headerlink" title="2.2 nginx+php配置清单"></a>2.2 nginx+php配置清单</h3><p>清单文件如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com/user<span class="token punctuation">-</span>sum/php        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/www/html/       <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com/user<span class="token punctuation">-</span>sum/alpine<span class="token punctuation">:</span>nginx1.18.0        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/conf.d/       <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data        <span class="token key atrule">nfs</span><span class="token punctuation">:</span>         <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token comment" spellcheck="true">#nfs server服务器IP</span>         <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/data/lnmp/app"</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf         <span class="token key atrule">items</span><span class="token punctuation">:</span>         <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> default.conf           <span class="token key atrule">path</span><span class="token punctuation">:</span> add.conf <span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30010</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php</code></pre><p>nginx服务配置文件</p><pre class=" language-yaml"><code class="language-yaml">server &amp;<span class="token comment" spellcheck="true">#123;</span>    listen       80;    server_name  localhost;    location / &amp;<span class="token comment" spellcheck="true">#123;</span>        root   /usr/share/nginx/html;        index  index.html index.htm;    &amp;<span class="token comment" spellcheck="true">#125;</span>    error_page   500 502 503 504  /50x.html;    location = /50x.html &amp;<span class="token comment" spellcheck="true">#123;</span>        root   /usr/share/nginx/html;    &amp;<span class="token comment" spellcheck="true">#125;</span>    location ~ \.php$ &amp;<span class="token comment" spellcheck="true">#123;</span>        fastcgi_pass   127.0.0.1<span class="token punctuation">:</span>9000;        fastcgi_index  index.php;        fastcgi_param  SCRIPT_FILENAME  /var/www/html/$fastcgi_script_name;        include        fastcgi_params;    &amp;<span class="token comment" spellcheck="true">#125;</span>&amp;<span class="token comment" spellcheck="true">#125;</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建configmap</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create cm ngin-conf --from-file=default.conf -n lnmp</span><span class="token comment" spellcheck="true">#启动</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nginx-php.yaml -n lnmp</span></code></pre><h3 id="2-3测试"><a href="#2-3测试" class="headerlink" title="2.3测试"></a>2.3测试</h3><p>测试 php连通性</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建测试文件测试</span><span class="token punctuation">[</span>root@k8snode app<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test.php </span>&lt;<span class="token punctuation">?</span>php phpinfo(); <span class="token punctuation">?</span><span class="token punctuation">></span></code></pre><p><img src="http://www.huhuhahei.cn/usr/uploads/2021/09/3394303815.png" alt="企业微信截图_16320409578191.png"></p><p>测试 mysql连通性</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8snode app<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat mysql.php </span>&lt;h1<span class="token punctuation">></span>Test php<span class="token punctuation">-</span>mysql &lt;/h1<span class="token punctuation">></span>&lt;<span class="token punctuation">?</span>phpmysqli_connect('10.97.108.119'<span class="token punctuation">,</span><span class="token string">'root'</span><span class="token punctuation">,</span>'123456') or die('failed');echo 'success';phpinfo();<span class="token punctuation">?</span><span class="token punctuation">></span></code></pre><p><img src="http://www.huhuhahei.cn/usr/uploads/2021/09/3128067845.png" alt="企业微信截图_16320411749468.png"><br>至此配置完成后面就可以吧自己的项目放到nginx工作目录愉快的玩耍了(๑•̀ㅁ•́ฅ)</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> lnmp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s数据持久化StorageClass</title>
      <link href="/2022/06/05/K8s%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96StorageClass/"/>
      <url>/2022/06/05/K8s%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96StorageClass/</url>
      
        <content type="html"><![CDATA[<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a><strong>一、简介</strong></h1><h3 id="1-1什么是StorageClass"><a href="#1-1什么是StorageClass" class="headerlink" title="1.1什么是StorageClass"></a><strong>1.1什么是StorageClass</strong></h3><p>Kubernetes提供了一套可以自动创建PV的机制，即：Dynamic Provisioning。而这个机制的核心在于StorageClass这个API对象。</p><p>StorageClass对象会定义下面两部分内容:</p><ul><li>PV的属性。比如，存储类型，Volume的大小等。</li><li>创建这种PV需要用到的存储插件，即存储制备器。<br>有了这两个信息之后，Kubernetes就能够根据用户提交的PVC，找到一个对应的StorageClass，之后Kubernetes就会调用该StorageClass声明的存储插件，进而创建出需要的PV。</li></ul><p>但是其实使用起来是一件很简单的事情，你只需要根据自己的需求，编写YAML文件即可，然后使用kubectl create命令执行即可。</p><hr><h3 id="1-2StorageClass架构"><a href="#1-2StorageClass架构" class="headerlink" title="1.2StorageClass架构"></a><strong>1.2StorageClass架构</strong></h3><p>在动态资源供应模式下，通过StorageClass和PVC完成资源动态绑定（系统自动生成PV），并供Pod使用的存储管理机制。<br><img src="https://www.huhuhahei.cn/usr/uploads/2021/10/3784991912.png" alt="企业微信截图_16345341913159.png"></p><hr><h1 id="二、创建"><a href="#二、创建" class="headerlink" title="二、创建"></a><strong>二、创建</strong></h1><h3 id="2-1创建StorageClass存储服务"><a href="#2-1创建StorageClass存储服务" class="headerlink" title="2.1创建StorageClass存储服务"></a><strong>2.1创建StorageClass存储服务</strong></h3><p>利用nfs-client-provisioner来生成一个基于nfs的StorageClass，部署配置yaml配置如下，保持为nfs-sc.yaml：</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01  </span><span class="token comment" spellcheck="true"># 此处供应者名字供storageclass调用</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/lnmp/test  <span class="token comment" spellcheck="true"># 填入NFS挂载的目录</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/lnmp/test   <span class="token comment" spellcheck="true"># 填入NFS挂载的目录</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>test<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span><span class="token comment" spellcheck="true"># Supported policies: Delete、 Retain ， default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#部署服务</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nfs-sc.yaml</span><span class="token comment" spellcheck="true">#因为是偏向系统层面的服务所以放到了kube-system命名空间</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n kube-system get pod</span><span class="token comment" spellcheck="true">#查看sc状态</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get sc</span>NAME       PROVISIONER          RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGEnfs<span class="token punctuation">-</span>test   nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>01   Retain          Immediate           false             2m43s</code></pre><hr><h3 id="2-2-基于SC创建PVC测试"><a href="#2-2-基于SC创建PVC测试" class="headerlink" title="2.2 基于SC创建PVC测试"></a><strong>2.2 基于SC创建PVC测试</strong></h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>sc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>test  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Mi</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f pvc-sc.yaml</span>persistentvolumeclaim/pvc<span class="token punctuation">-</span>sc created<span class="token comment" spellcheck="true">#查看pv和pvc</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pv</span>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                                           STORAGECLASS   REASON   AGEpvc<span class="token punctuation">-</span>bc40c73b<span class="token punctuation">-</span>cf4a<span class="token punctuation">-</span>4c2d<span class="token punctuation">-</span>a551<span class="token punctuation">-</span>c2fdbd7e245a   1Mi        RWX            Retain        Bound      default/pvc<span class="token punctuation">-</span>sc                                  nfs<span class="token punctuation">-</span>test             52s<span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc</span>NAME     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEpvc<span class="token punctuation">-</span>sc   Bound    pvc<span class="token punctuation">-</span>bc40c73b<span class="token punctuation">-</span>cf4a<span class="token punctuation">-</span>4c2d<span class="token punctuation">-</span>a551<span class="token punctuation">-</span>c2fdbd7e245a   1Mi        RWX         nfs<span class="token punctuation">-</span>test       2m31s</code></pre><p>使用nginx测试</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 我们这里将nginx容器默认的页面目录挂载</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>files            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"/usr/share/nginx/html"</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>files          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>sc</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nginx.yaml</span>deployment.apps/nginx created<span class="token comment" spellcheck="true">#查看pod是否运行</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po</span>NAME                     READY   STATUS    RESTARTS   AGEnginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m   1/1     Running   0          46s<span class="token comment" spellcheck="true">#进入pod测试是否设置成功</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it nginx-76f5df5fcf-f8x9m -- bash</span>root@nginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m<span class="token punctuation">:</span>/<span class="token comment" spellcheck="true"># echo 'test' > /usr/share/nginx/html/index.html</span>root@nginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m<span class="token punctuation">:</span>/<span class="token comment" spellcheck="true"># exit</span>exit<span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /data/lnmp/test/default-pvc-sc-pvc-bc40c73b-cf4a-4c2d-a551-c2fdbd7e245a/index.html</span>test</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s强制删除Terminating的命名空间</title>
      <link href="/2022/06/05/K8s%E5%BC%BA%E5%88%B6%E5%88%A0%E9%99%A4Terminating%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4/"/>
      <url>/2022/06/05/K8s%E5%BC%BA%E5%88%B6%E5%88%A0%E9%99%A4Terminating%E7%9A%84%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4/</url>
      
        <content type="html"><![CDATA[<p>我们在日常的k8s维护中，经常遇到k8s删除命名空间一直处于Terminating的状态 让人抓狂::(怒) 下面总结下强制删除的方法</p><h3 id="1-1-将ns资源保存为json文件"><a href="#1-1-将ns资源保存为json文件" class="headerlink" title="1.1 将ns资源保存为json文件"></a>1.1 将ns资源保存为json文件</h3><pre class=" language-bash"><code class="language-bash">kubectl get ns istio-system -o json <span class="token operator">></span>istis.json</code></pre><h3 id="2-1-删除json文件finalizers字段"><a href="#2-1-删除json文件finalizers字段" class="headerlink" title="2.1 删除json文件finalizers字段"></a>2.1 删除json文件finalizers字段</h3><pre class=" language-json"><code class="language-json"><span class="token property">"spec"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token property">"finalizers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token string">"kubernetes"</span>        <span class="token punctuation">]</span>    &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span></code></pre><h3 id="3-1启动一个kube-proxy"><a href="#3-1启动一个kube-proxy" class="headerlink" title="3.1启动一个kube proxy"></a>3.1启动一个kube proxy</h3><pre class=" language-bash"><code class="language-bash">kubectl proxy --port<span class="token operator">=</span>8081</code></pre><p>在启动一个终端并执行下面命令</p><pre class=" language-bash"><code class="language-bash">curl -k -H <span class="token string">"Content-Type: application/json"</span> -X PUT --data-binary @istis.json http://127.0.0.1:8081/api/v1/namespaces/istio-system/finalize</code></pre><p>再次查看就发现已经正常删除这个ns了::(滑稽)</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s配置ingress-nginx暴露服务</title>
      <link href="/2022/06/05/K8s%E9%85%8D%E7%BD%AEingress-nginx%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1/"/>
      <url>/2022/06/05/K8s%E9%85%8D%E7%BD%AEingress-nginx%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><h4 id="1-1-介绍"><a href="#1-1-介绍" class="headerlink" title="1.1 介绍"></a><strong>1.1 介绍</strong></h4><p>在kubernetes中，POD，SVC的IP地址只能集群内部使用，集群外部是无法访问的。</p><p>为了能让外部的应用访问进来，kubernetes提供了如下几种方案：</p><ul><li>NodePort</li><li>LoadBalancer</li><li>Ingress</li></ul><h4 id="1-2-工作原理"><a href="#1-2-工作原理" class="headerlink" title="1.2 工作原理"></a><strong>1.2 工作原理</strong></h4><ul><li>本质：7层http&#x2F;https代理</li><li>ingress controller通过和kubernetes apiserver交互，动态的获取集群中的ingress规则</li><li>解析ingress规则，生成proxy服务的配置，比如nginx配置</li><li>再写到ingress proxy的pod中，如果pod运行的是nginx服务，就生成nginx配置，并放到&#x2F;etc&#x2F;nginx&#x2F;nginx.conf中</li><li>然后reload服务</li></ul><h1 id="二、配置"><a href="#二、配置" class="headerlink" title="二、配置"></a><strong>二、配置</strong></h1><h4 id="2-1-ingress-controller配置"><a href="#2-1-ingress-controller配置" class="headerlink" title="2.1 ingress-controller配置"></a><strong>2.1 ingress-controller配置</strong></h4><blockquote><p>配置如下</p></blockquote><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps      <span class="token punctuation">-</span> endpoints      <span class="token punctuation">-</span> nodes      <span class="token punctuation">-</span> pods      <span class="token punctuation">-</span> secrets      <span class="token punctuation">-</span> namespaces      <span class="token punctuation">-</span> services    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"extensions"</span>      <span class="token punctuation">-</span> <span class="token string">"networking.k8s.io"</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> events    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create      <span class="token punctuation">-</span> patch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"extensions"</span>      <span class="token punctuation">-</span> <span class="token string">"networking.k8s.io"</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses/status    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> update  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"ingress-controller-leader-nginx"</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> update<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>lb  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10254</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>configuration  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">keep-alive</span><span class="token punctuation">:</span> <span class="token string">"75"</span>  <span class="token key atrule">keep-alive-requests</span><span class="token punctuation">:</span> <span class="token string">"100"</span>  <span class="token key atrule">upstream-keepalive-connections</span><span class="token punctuation">:</span> <span class="token string">"10000"</span>  <span class="token key atrule">upstream-keepalive-requests</span><span class="token punctuation">:</span> <span class="token string">"100"</span>  <span class="token key atrule">upstream-keepalive-timeout</span><span class="token punctuation">:</span> <span class="token string">"60"</span>  <span class="token key atrule">allow-backend-server-header</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">enable-underscores-in-headers</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">generate-request-id</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">http-redirect-code</span><span class="token punctuation">:</span> <span class="token string">"301"</span>  <span class="token key atrule">ignore-invalid-headers</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">log-format-upstream</span><span class="token punctuation">:</span> '&amp;<span class="token comment" spellcheck="true">#123;"@timestamp": "$time_iso8601","remote_addr": "$remote_addr","x-forward-for": "$proxy_add_x_forwarded_for","request_id": "$req_id","remote_user": "$remote_user","bytes_sent": $bytes_sent,"request_time": $request_time,"status": $status,"vhost": "$host","request_proto": "$server_protocol","path": "$uri","request_query": "$args","request_length": $request_length,"duration": $request_time,"method": "$request_method","http_referrer": "$http_referer","http_user_agent":  "$http_user_agent","upstream-sever":"$proxy_upstream_name","proxy_alternative_upstream_name":"$proxy_alternative_upstream_name","upstream_addr":"$upstream_addr","upstream_response_length":$upstream_response_length,"upstream_response_time":$upstream_response_time,"upstream_status":$upstream_status&amp;#125;'</span>  <span class="token key atrule">max-worker-connections</span><span class="token punctuation">:</span> <span class="token string">"65536"</span>  <span class="token key atrule">worker-processes</span><span class="token punctuation">:</span> <span class="token string">"2"</span>  <span class="token key atrule">proxy-body-size</span><span class="token punctuation">:</span> 20m  <span class="token key atrule">proxy-connect-timeout</span><span class="token punctuation">:</span> <span class="token string">"10"</span>  <span class="token key atrule">proxy_next_upstream</span><span class="token punctuation">:</span> error timeout http_502  <span class="token key atrule">reuse-port</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">server-tokens</span><span class="token punctuation">:</span> <span class="token string">"false"</span>  <span class="token key atrule">ssl-ciphers</span><span class="token punctuation">:</span> ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>kEDH+AESGCM<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES<span class="token punctuation">:</span>CAMELLIA<span class="token punctuation">:</span>DES<span class="token punctuation">-</span>CBC3<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span><span class="token tag">!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA</span>  <span class="token key atrule">ssl-protocols</span><span class="token punctuation">:</span> TLSv1 TLSv1.1 TLSv1.2  <span class="token key atrule">ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"false"</span>  <span class="token key atrule">worker-cpu-affinity</span><span class="token punctuation">:</span> auto<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>services  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> udp<span class="token punctuation">-</span>services  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">component.version</span><span class="token punctuation">:</span> <span class="token string">"v0.30.0"</span>    <span class="token key atrule">component.revision</span><span class="token punctuation">:</span> <span class="token string">"v1"</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> <span class="token string">"10254"</span>        <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span>        <span class="token key atrule">scheduler.alpha.kubernetes.io/critical-pod</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>node<span class="token punctuation">-</span>critical      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                  <span class="token key atrule">values</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> ingress<span class="token punctuation">-</span>nginx              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname            <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> type                <span class="token key atrule">operator</span><span class="token punctuation">:</span> NotIn                <span class="token key atrule">values</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> virtual<span class="token punctuation">-</span>kubelet      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/acs/aliyun<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">:</span>v0.30.0.2<span class="token punctuation">-</span>9597b3685<span class="token punctuation">-</span>aliyun          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/nginx<span class="token punctuation">-</span>configuration            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tcp<span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/tcp<span class="token punctuation">-</span>services            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>udp<span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/udp<span class="token punctuation">-</span>services            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>publish<span class="token punctuation">-</span>service=$(POD_NAMESPACE)/nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>lb            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>annotations<span class="token punctuation">-</span>prefix=nginx.ingress.kubernetes.io            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enable<span class="token punctuation">-</span>dynamic<span class="token punctuation">-</span>certificates=true            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>v=2          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>            <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>            <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>              <span class="token key atrule">drop</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> ALL              <span class="token key atrule">add</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> NET_BIND_SERVICE            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">101</span>          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime            <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime            <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime          <span class="token key atrule">type</span><span class="token punctuation">:</span> File      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> /bin/sh        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          mount -o remount rw /proc/sys          sysctl -w net.core.somaxconn=65535          sysctl -w net.ipv4.ip_local_port_range="1024 65535"          sysctl -w fs.file-max=1048576          sysctl -w fs.inotify.max_user_instances=16384          sysctl -w fs.inotify.max_user_watches=524288          sysctl -w fs.inotify.max_queued_events=16384</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/acs/busybox<span class="token punctuation">:</span>v1.29.2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>sysctl        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">procMount</span><span class="token punctuation">:</span> Default</code></pre><h4 id="2-2配置用于测试的nginx-pod"><a href="#2-2配置用于测试的nginx-pod" class="headerlink" title="2.2配置用于测试的nginx pod"></a><strong>2.2配置用于测试的nginx pod</strong></h4><blockquote><p>yaml清单如下</p></blockquote><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</code></pre><h4 id="2-3配置ingress"><a href="#2-3配置ingress" class="headerlink" title="2.3配置ingress"></a><strong>2.3配置ingress</strong></h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.boge.com      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">paths</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /          <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix          <span class="token key atrule">backend</span><span class="token punctuation">:</span>            <span class="token key atrule">service</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx              <span class="token key atrule">port</span><span class="token punctuation">:</span>                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><h4 id="2-4-部署"><a href="#2-4-部署" class="headerlink" title="2.4 部署"></a><strong>2.4 部署</strong></h4><blockquote><p>yaml清单中有指定nodeselector 所以需要确认node都有这个标签，pod才会被正常调度</p></blockquote><pre class=" language-yaml"><code class="language-yaml">kubectl label node 10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>48<span class="token punctuation">-</span>223 boge/ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>ready=truekubectl label node 10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>110<span class="token punctuation">-</span>221 boge/ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>ready=true<span class="token comment" spellcheck="true">#标签配置完成即可启动ingress-controller</span>kubectl apply <span class="token punctuation">-</span>f ingress.yaml<span class="token comment" spellcheck="true"># 查看pod是否都正常运行</span>kubectl <span class="token punctuation">-</span>n ingress<span class="token punctuation">-</span>nginx get pod <span class="token punctuation">-</span>o wideNAME                             READY   STATUS    RESTARTS   AGE   IP             NODE           NOMINATED NODE   READINESS GATESnginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>6pgmj   1/1     Running   0          70m   10.7.110.221   10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>110<span class="token punctuation">-</span>221   &lt;none<span class="token punctuation">></span>           &lt;none<span class="token punctuation">></span>nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>gfksc   1/1     Running   0          70m   10.7.48.223    10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>48<span class="token punctuation">-</span>223    &lt;none<span class="token punctuation">></span>           &lt;none<span class="token punctuation">></span><span class="token comment" spellcheck="true">#启动nginx deploy</span>kubectl apply <span class="token punctuation">-</span>f nginx.yaml<span class="token comment" spellcheck="true">#启动ingress</span>kubectl apply <span class="token punctuation">-</span>f nginx<span class="token punctuation">-</span>ingress.yaml<span class="token comment" spellcheck="true">#查看ingress资源</span>kubectl get ingressNAME            CLASS    HOSTS            ADDRESS          PORTS   AGEnginx<span class="token punctuation">-</span>ingress   &lt;none<span class="token punctuation">></span>   nginx.boge.com   10.102.200.157   80      70m</code></pre><h1 id="三、测试"><a href="#三、测试" class="headerlink" title="三、测试"></a><strong>三、测试</strong></h1><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#可以在其他的节点，绑定hosts测试</span>curl nginx.boge.com&lt;<span class="token tag">!DOCTYPE</span> html<span class="token punctuation">></span>&lt;html<span class="token punctuation">></span>&lt;head<span class="token punctuation">></span>&lt;title<span class="token punctuation">></span>Welcome to nginx<span class="token tag">!&lt;/title></span>&lt;style<span class="token punctuation">></span>html &amp;<span class="token comment" spellcheck="true">#123; color-scheme: light dark; &amp;#125;</span>body &amp;<span class="token comment" spellcheck="true">#123; width: 35em; margin: 0 auto;</span><span class="token key atrule">font-family</span><span class="token punctuation">:</span> Tahoma<span class="token punctuation">,</span> Verdana<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans<span class="token punctuation">-</span>serif; &amp;<span class="token comment" spellcheck="true">#125;</span>&lt;/style<span class="token punctuation">></span>&lt;/head<span class="token punctuation">></span>&lt;body<span class="token punctuation">></span>&lt;h1<span class="token punctuation">></span>Welcome to nginx<span class="token tag">!&lt;/h1></span>&lt;p<span class="token punctuation">></span>If you see this page<span class="token punctuation">,</span> the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p<span class="token punctuation">></span>&lt;p<span class="token punctuation">></span>For online documentation and support please refer to&lt;a href="http<span class="token punctuation">:</span>//nginx.org/"<span class="token punctuation">></span>nginx.org&lt;/a<span class="token punctuation">></span>.&lt;br/<span class="token punctuation">></span>Commercial support is available at&lt;a href="http<span class="token punctuation">:</span>//nginx.com/"<span class="token punctuation">></span>nginx.com&lt;/a<span class="token punctuation">></span>.&lt;/p<span class="token punctuation">></span>&lt;p<span class="token punctuation">></span>&lt;em<span class="token punctuation">></span>Thank you for using nginx.&lt;/em<span class="token punctuation">></span>&lt;/p<span class="token punctuation">></span>&lt;/body<span class="token punctuation">></span>&lt;/html<span class="token punctuation">></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s配置4层转发nginx</title>
      <link href="/2022/06/05/K8s%E9%85%8D%E7%BD%AE4%E5%B1%82%E8%BD%AC%E5%8F%91nginx/"/>
      <url>/2022/06/05/K8s%E9%85%8D%E7%BD%AE4%E5%B1%82%E8%BD%AC%E5%8F%91nginx/</url>
      
        <content type="html"><![CDATA[<h1 id="一-四层转发和七层转发"><a href="#一-四层转发和七层转发" class="headerlink" title="一 四层转发和七层转发"></a>一 四层转发和七层转发</h1><h3 id="1-1四层负载均衡"><a href="#1-1四层负载均衡" class="headerlink" title="1.1四层负载均衡"></a>1.1四层负载均衡</h3><p>四层负载均衡工作在OSI模型的传输层，由于在传输层，只有TCP&#x2F;UDP协议，这两种协议中除了包含源IP、目标IP以外，还包含源端口号及目的端口号。四层负载均衡服务器在接受到客户端请求后，以后通过修改数据包的地址信息（IP+端口号）将流量转发到应用服务器。</p><h3 id="1-2七层负载均衡"><a href="#1-2七层负载均衡" class="headerlink" title="1.2七层负载均衡"></a>1.2七层负载均衡</h3><p>七层负载均衡工作在OSI模型的应用层，应用层协议较多，常用http、radius、dns等。七层负载就可以基于这些协议来负载。这些应用层协议中会包含很多有意义的内容。比如同一个Web服务器的负载均衡，除了根据IP加端口进行负载外，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。<br><img src="http://www.huhuhahei.cn/usr/uploads/2022/03/1508471474.jpeg" alt="xcdkyuw83o.jpeg"></p><h1 id="二-Nginx4层转发的配置"><a href="#二-Nginx4层转发的配置" class="headerlink" title="二 Nginx4层转发的配置"></a>二 Nginx4层转发的配置</h1><p>生产业务中很多端口只能使用tcp连接 比如mysql ssh 这些端口是无法使用普通的7层代理进行转发的 因此需要我们配置nginx的四层转发</p><h3 id="2-1-Nginx-Dockerfile配置"><a href="#2-1-Nginx-Dockerfile配置" class="headerlink" title="2.1 Nginx Dockerfile配置"></a>2.1 Nginx Dockerfile配置</h3><p>创建Nginx Dockerfile nginx编译需要–with-stream 模块 否则无法配置</p><pre class=" language-bash"><code class="language-bash">FROM centos:7.8.2003MAINTAINER huhuhaheiADD nginx-1.12.0.tar.gz /optRUN yum -y <span class="token function">install</span> gcc gcc-c++ lrzsz pcre-devel zlib-devel openssl openssl-devel <span class="token operator">&amp;&amp;</span> <span class="token function">useradd</span> -M -s /sbin/nologin nginx <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> /opt/nginx-1.12.0/ <span class="token operator">&amp;&amp;</span> ./configure --prefix<span class="token operator">=</span>/usr/local/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_stub_status_module --with-http_ssl_module --with-stream <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><h3 id="2-2-创建转发的配置文件"><a href="#2-2-创建转发的配置文件" class="headerlink" title="2.2 创建转发的配置文件"></a>2.2 创建转发的配置文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    user  root;    worker_processes  auto;    error_log  logs/error.log  info;    pid        logs/nginx.pid;</span>    events &amp;<span class="token comment" spellcheck="true">#123;</span>        use epoll;    &amp;<span class="token comment" spellcheck="true">#125;</span>    stream &amp;<span class="token comment" spellcheck="true">#123;</span>      upstream backend &amp;<span class="token comment" spellcheck="true">#123;</span>          server *****<span class="token punctuation">:</span>8080 max_fails=3 fail_timeout=30s;      &amp;<span class="token comment" spellcheck="true">#125;</span>      server &amp;<span class="token comment" spellcheck="true">#123;</span>          listen 8080;          proxy_connect_timeout 1s;          proxy_timeout 3s;          proxy_pass backend;      &amp;<span class="token comment" spellcheck="true">#125;</span>      log_format proxy '$remote_addr <span class="token punctuation">[</span>$time_local<span class="token punctuation">]</span>'                '$protocol $status $bytes_sent $bytes_received'                '$session_time "$upstream_addr" '                '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';            access_log /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>access.log proxy ;      error_log  /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>error.log warn ;          &amp;<span class="token comment" spellcheck="true">#125;</span>    http &amp;<span class="token comment" spellcheck="true">#123;</span>        include       /usr/local/nginx/conf/mime.types;        default_type  application/octet<span class="token punctuation">-</span>stream;      &amp;<span class="token comment" spellcheck="true">#125;</span></code></pre><h3 id="2-3-创建Nginx-deploy文件"><a href="#2-3-创建Nginx-deploy文件" class="headerlink" title="2.3 创建Nginx deploy文件"></a>2.3 创建Nginx deploy文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf            <span class="token key atrule">items</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx.conf                <span class="token key atrule">path</span><span class="token punctuation">:</span> nginx.conf            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs          <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'harbor.huhuhahei.cn/test/nginx_proxy:v2'</span>          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> ./usr/local/nginx/sbin/nginx          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">'-g daemon off;'</span>            <span class="token punctuation">-</span> <span class="token string">'-c'</span>            <span class="token punctuation">-</span> /opt/nginx.conf          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_proxy<span class="token punctuation">-</span>access<span class="token punctuation">-</span>log              <span class="token key atrule">value</span><span class="token punctuation">:</span> /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>access.log            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_proxy<span class="token punctuation">-</span>error<span class="token punctuation">-</span>log              <span class="token key atrule">value</span><span class="token punctuation">:</span> /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>error.log            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai          <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/logs/          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> proxy      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ingress </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s集群内配置coredns解析</title>
      <link href="/2022/06/05/k8s%E9%9B%86%E7%BE%A4%E5%86%85%E9%85%8D%E7%BD%AEcoredns%E8%A7%A3%E6%9E%90/"/>
      <url>/2022/06/05/k8s%E9%9B%86%E7%BE%A4%E5%86%85%E9%85%8D%E7%BD%AEcoredns%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>编辑coredns的confmap</p><pre class=" language-bash"><code class="language-bash">kubectl -n kube-system edit configmaps coredns</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">Corefile</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    .:53 &amp;#123;        errors        health        ready</span><span class="token comment" spellcheck="true"># 添加下面</span>        log        rewrite stop &amp;<span class="token comment" spellcheck="true">#123;</span>          name regex git.boge.com gitlab.gitlab<span class="token punctuation">-</span>ver130806.svc.cluster.local<span class="token comment" spellcheck="true"># 将域名解析到默认的svc域名</span>          answer name gitlab.gitlab<span class="token punctuation">-</span>ver130806.svc.cluster.local git.boge.com<span class="token comment" spellcheck="true"># 反向解析</span>        &amp;<span class="token comment" spellcheck="true">#125;</span><span class="token comment" spellcheck="true"># </span>        kubernetes cluster.local in<span class="token punctuation">-</span>addr.arpa ip6.arpa &amp;<span class="token comment" spellcheck="true">#123;</span>          pods verified          fallthrough in<span class="token punctuation">-</span>addr.arpa ip6.arpa        &amp;<span class="token comment" spellcheck="true">#125;</span>        autopath @kubernetes        prometheus <span class="token punctuation">:</span><span class="token number">9153</span>        forward . /etc/resolv.conf        cache 30        loop        reload        loadbalance    &amp;<span class="token comment" spellcheck="true">#125;</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system  </code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s基础yaml文件</title>
      <link href="/2022/06/05/K8s%E5%9F%BA%E7%A1%80yaml%E6%96%87%E4%BB%B6/"/>
      <url>/2022/06/05/K8s%E5%9F%BA%E7%A1%80yaml%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h1 id="一、基础Pod配置"><a href="#一、基础Pod配置" class="headerlink" title="一、基础Pod配置"></a>一、基础Pod配置</h1><p><strong>nginx：</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>    <span class="token punctuation">-</span> <span class="token string">"-c"</span>    <span class="token punctuation">-</span> <span class="token string">"sleep 3600"</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd</code></pre><hr><p><strong>存活性探针配置：</strong><br>exec</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>pod  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"touch /tmp/healthy sleep 60; rm -f /tmp/healthy; sleep 3600"</span><span class="token punctuation">]</span>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">exec</span><span class="token punctuation">:</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"-e"</span><span class="token punctuation">,</span><span class="token string">"/tmp/healthy"</span><span class="token punctuation">]</span>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></code></pre><p>HttpGet</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>httpget  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> http        <span class="token key atrule">path</span><span class="token punctuation">:</span> /index.html      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></code></pre><hr><p><strong>就绪性探针：</strong><br>HttpGet</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness<span class="token punctuation">-</span>httpget  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> http        <span class="token key atrule">path</span><span class="token punctuation">:</span> /index.html      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></code></pre><hr><h1 id="二、调度器基础配置"><a href="#二、调度器基础配置" class="headerlink" title="二、调度器基础配置"></a>二、调度器基础配置</h1><p><strong>ReplicaSet</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp      <span class="token key atrule">release</span><span class="token punctuation">:</span> canary  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp        <span class="token key atrule">release</span><span class="token punctuation">:</span> canary        <span class="token key atrule">environment</span><span class="token punctuation">:</span> qa    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>container        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><hr><p><strong>Deployment</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/lnmp_php<span class="token punctuation">:</span>v1        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/html      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/lnmp_nginx<span class="token punctuation">:</span>v2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/html        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/conf/conf.d/        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>logs          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> blog<span class="token punctuation">-</span>nginx      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>logs        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> blog<span class="token punctuation">-</span>logs      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf         <span class="token key atrule">items</span><span class="token punctuation">:</span>         <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx.conf           <span class="token key atrule">path</span><span class="token punctuation">:</span> add.conf</code></pre><p><strong>DaemonSet</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> redis      <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> redis        <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis        <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>4.0<span class="token punctuation">-</span>alpine        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>ds  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat      <span class="token key atrule">release</span><span class="token punctuation">:</span> stable  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat        <span class="token key atrule">release</span><span class="token punctuation">:</span> stable    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/filebeat<span class="token punctuation">:</span>5.6.5<span class="token punctuation">-</span>alpine        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_HOST          <span class="token key atrule">value</span><span class="token punctuation">:</span> redis.default.svc.cluster.local        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_LOG_LEVEL          <span class="token key atrule">value</span><span class="token punctuation">:</span> info</code></pre><p><strong>statefulset</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>statefulset  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> web        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myappdata          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> myappdata    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"ReadWriteOnce"</span> <span class="token punctuation">]</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi</code></pre><h1 id="三、Service配置"><a href="#三、Service配置" class="headerlink" title="三、Service配置"></a>三、Service配置</h1><p><strong>NodePort</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">release</span><span class="token punctuation">:</span> canary  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.99.99.99  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30080</span></code></pre><p><strong>ClusterIP</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redis    <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.97.97.97  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span></code></pre><h1 id="四、持久卷配置"><a href="#四、持久卷配置" class="headerlink" title="四、持久卷配置"></a>四、持久卷配置</h1><p><strong>emptyDir</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/    <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>    <span class="token punctuation">-</span> <span class="token string">"-c"</span>    <span class="token punctuation">-</span> <span class="token string">"while true; do echo $(date) >> /data/index.html; sleep 2;done"</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span></code></pre><p><strong>hostpath</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>hostpath  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/pod/volume1      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate</code></pre><p><strong>nfs</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>nfs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">nfs</span><span class="token punctuation">:</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/test      <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223</code></pre><p><strong>PV</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv001  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0001<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v1    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv002  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0002<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v2    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv003  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0003<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v3    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv004  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0004<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v4    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv005  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0005<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v5    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span></code></pre><p><strong>pvc</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypvc  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">]</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 6Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>nfs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> mypvc</code></pre><h1 id="五、配置中心（configmap）"><a href="#五、配置中心（configmap）" class="headerlink" title="五、配置中心（configmap）"></a>五、配置中心（configmap）</h1><p><strong>通过环境变量注入配置</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>cm<span class="token punctuation">-</span><span class="token number">1</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NGINX_SERVER_PORT      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config          <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx_port    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NGINX_SERVER_NAME      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config          <span class="token key atrule">key</span><span class="token punctuation">:</span> server_name</code></pre><p><strong>通过配置文件注入</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>cm<span class="token punctuation">-</span><span class="token number">2</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginxconf      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/config.d/      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginxconf    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ingress高级配置</title>
      <link href="/2022/06/05/Ingress%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/"/>
      <url>/2022/06/05/Ingress%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="一-配置ingress路径重写"><a href="#一-配置ingress路径重写" class="headerlink" title="一.配置ingress路径重写"></a>一.配置ingress路径重写</h1><p>若后端路径是&#x2F;app 默认访问是不带路径的会导致出现404的情况 因此需要配置下路径重写</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/app-root</span><span class="token punctuation">:</span> /nacos  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>discovery<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> port<span class="token punctuation">-</span>forward<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nacos.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nacos          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /nacos</code></pre><hr><h1 id="二-配置ingress白名单访问"><a href="#二-配置ingress白名单访问" class="headerlink" title="二.配置ingress白名单访问"></a>二.配置ingress白名单访问</h1><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/whitelist-source-range</span><span class="token punctuation">:</span> 117.50.34.153  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> prometheus.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">9090</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix</code></pre><p>其他ip访问测试</p><pre class=" language-yaml"><code class="language-yaml">curl <span class="token punctuation">-</span>I prometheus.huhuhahei.cnHTTP/1.1 403 Forbidden<span class="token key atrule">Date</span><span class="token punctuation">:</span> Fri<span class="token punctuation">,</span> 04 Mar 2022 03<span class="token punctuation">:</span>08<span class="token punctuation">:</span>38 GMT<span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> text/html<span class="token key atrule">Content-Length</span><span class="token punctuation">:</span> <span class="token number">146</span><span class="token key atrule">Connection</span><span class="token punctuation">:</span> keep<span class="token punctuation">-</span>alive</code></pre><p>白名单访问测试</p><pre class=" language-bash"><code class="language-bash">curl -I prometheus.huhuhahei.cnHTTP/1.1 405 Method Not AllowedDate: Fri, 04 Mar 2022 03:10:19 GMTContent-Type: text/plain<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf-8Content-Length: 19Connection: keep-aliveAllow: GET, OPTIONSX-Content-Type-Options: nosniff</code></pre><hr><h1 id="三-配置登录验证"><a href="#三-配置登录验证" class="headerlink" title="三. 配置登录验证"></a>三. 配置登录验证</h1><p>首先需要创建密码文件</p><pre class=" language-bash"><code class="language-bash">htpasswd -c auth adminNew password: Re-type new password: Adding password <span class="token keyword">for</span> user admin</code></pre><p>创建secret</p><pre class=" language-bash"><code class="language-bash">kubectl create secret generic  kibana-auth --from-file<span class="token operator">=</span>auth -n logssecret/kibana-auth created</code></pre><p>配置ingress</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-realm</span><span class="token punctuation">:</span> Need to longin    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-secret</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>auth    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-type</span><span class="token punctuation">:</span> basic  <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> kibana.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kibana          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">5601</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /</code></pre><p>登录测试</p><p><img src="https://www.huhuhahei.cn/usr/uploads/2022/03/1537476990.png" alt="AB6F7373-335A-4ea6-9330-DC55E8895879.png"></p><hr><h1 id="四-配置域名重定向"><a href="#四-配置域名重定向" class="headerlink" title="四.配置域名重定向"></a>四.配置域名重定向</h1><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/permanent-redirect</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.huhuhahei.cn  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> web.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kibana          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">5601</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /</code></pre><p>测试</p><pre class=" language-bash"><code class="language-bash">curl -I web.huhuhahei.cnHTTP/1.1 301 Moved PermanentlyDate: Fri, 04 Mar 2022 03:30:07 GMTContent-Type: text/htmlContent-Length: 162Connection: keep-aliveLocation: https://www.huhuhahei.cn</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ingress-nginx配置 https访问</title>
      <link href="/2022/06/05/Ingress-nginx%E9%85%8D%E7%BD%AE-https%E8%AE%BF%E9%97%AE/"/>
      <url>/2022/06/05/Ingress-nginx%E9%85%8D%E7%BD%AE-https%E8%AE%BF%E9%97%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="一、配置证书"><a href="#一、配置证书" class="headerlink" title="一、配置证书"></a>一、配置证书</h1><h3 id="1-1-创建证书secret"><a href="#1-1-创建证书secret" class="headerlink" title="1.1 创建证书secret"></a>1.1 创建证书secret</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster TSL<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create secret  tls huhuhahei  --key=private.key --cert=public.pem  -n  lnmp</span>secret/huhuhahei created</code></pre><h1 id="二-、配置Ingress"><a href="#二-、配置Ingress" class="headerlink" title="二 、配置Ingress"></a>二 、配置Ingress</h1><h3 id="2-1-创建ingress"><a href="#2-1-创建ingress" class="headerlink" title="2.1  创建ingress"></a>2.1  创建ingress</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">tls</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> web.huhuhahei.cn    <span class="token punctuation">-</span> <span class="token key atrule">secretName</span><span class="token punctuation">:</span> huhuhahei  <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> web.huhuhahei.cn      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">paths</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /          <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix          <span class="token key atrule">backend</span><span class="token punctuation">:</span>            <span class="token key atrule">service</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php              <span class="token key atrule">port</span><span class="token punctuation">:</span>                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><h1 id="三-、测试"><a href="#三-、测试" class="headerlink" title="三 、测试"></a>三 、测试</h1><h3 id="3-1浏览器查看证书"><a href="#3-1浏览器查看证书" class="headerlink" title="3.1浏览器查看证书"></a>3.1浏览器查看证书</h3><p><img src="https://www.huhuhahei.cn/usr/uploads/2021/09/207112106.png" alt="企业微信截图_16320493117369.png"></p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker清理无用镜像及卷组占用的空间</title>
      <link href="/2022/06/05/Docker%E6%B8%85%E7%90%86%E6%97%A0%E7%94%A8%E9%95%9C%E5%83%8F%E5%8F%8A%E5%8D%B7%E7%BB%84%E5%8D%A0%E7%94%A8%E7%9A%84%E7%A9%BA%E9%97%B4/"/>
      <url>/2022/06/05/Docker%E6%B8%85%E7%90%86%E6%97%A0%E7%94%A8%E9%95%9C%E5%83%8F%E5%8F%8A%E5%8D%B7%E7%BB%84%E5%8D%A0%E7%94%A8%E7%9A%84%E7%A9%BA%E9%97%B4/</url>
      
        <content type="html"><![CDATA[<p>生产过程中，总是会遇到服务器磁盘被docker占满的情况<br>比如这样<br><img src="http://www.huhuhahei.cn/usr/uploads/2022/03/479329848.jpg" alt="1648304987(1).jpg"><br>也就跑了几个容器，莫名其妙磁盘就没了::(泪)<br>于是上网找方案</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system df </span>TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLEImages          46        46        14.44GB   435MB <span class="token punctuation">(</span>3%<span class="token punctuation">)</span>Containers      121       108       1.359GB   3.478kB <span class="token punctuation">(</span>0%<span class="token punctuation">)</span>Local Volumes   32        2         5.273GB   5.273GB <span class="token punctuation">(</span>100%<span class="token punctuation">)</span></code></pre><p>这个命令可以查看目前我们可以清理的docker缓存，分别为镜像，容器，数据卷</p><p>可以执行下面的命令清理</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system prune -a</span>WARNING<span class="token operator">!</span> This will remove:  - all stopped containers  - all networks not used by at least one container  - all dangling images  - all dangling build cacheAre you sure you want to continue? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span> y</code></pre><p>-a 参数清理的更加彻底 可以将没有容器使用Docker镜像都删掉。注意，这两个命令会把你暂时关闭的容器，以及暂时没有用到的Docker镜像都删掉了……所以使用之前一定要想清楚吶。</p><p>清理后发现空间并没有减少 仔细查看发现是32磁盘 但是只有2个再用 在执行这个命令看看</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker volume ls -qf dangling=true</span>0d322472e941707dc9cdf72ae21647ace2e866d061781c1b3102f026454ff1bb0fd37de5d1b7e9a7b047ef7564dc2f7cff9a430e091afaf8b3bce80d967160795cf16842c76f2b5ac32a37bb4cff4b1b691a1323b59db01adcf0569966746d919cb673514123500c7f6f0c0c777d99813c6489832638c261bfaffb9cea01c30f23e3eb4e2c4ce36b484278c882a4ff77b8b73a0afcb42f9d4fb4bbd9da04b30551a3a18fe7339d97627c894d636a07503244f15f05a945f8ba0e326e53bac4fd61bc3ad6461da6f126e6191509e7964a34c8b9514a2c488462e9b2a465ddd54189c4921a2c858db86534e0924f5f64786dfcb193b95d98bb468eb2b4e401443c146ee0f6e0a42cdfa112a69780637f6a28120fdd56d129e3f697c68a01e6791b176b4fa0c65897c355aafff690bf7a97b419ecf9877b1d518b8574cf86b88971517bd77537b86937ec43778a171b027ed3200f9ba4405740343dc748a366103b540c32012f161afee2abab0ea62f9621612c99392d51bbb266c4e8953f8e3302976d1335e32ea78551c0b8ebf96cd626d5cdae78379a4e3b685672ff30911628····</code></pre><p>可以看到有很多没有挂载的磁盘</p><p>可以使用这个命令清理</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker volume rm $(docker volume ls -qf dangling=true)</span>0d322472e941707dc9cdf72ae21647ace2e866d061781c1b3102f026454ff1bb0fd37de5d1b7e9a7b047ef7564dc2f7cff9a430e091afaf8b3bce80d967160795cf16842c76f2b5ac32a37bb4cff4b1b691a1323b59db01adcf0569966746d919cb673514123500c7f6f0c0c777d99813c6489832638c261bfaffb9cea01c30f23e3eb4e2c4ce36b484278c882a4ff77b8b73a0afcb42f9d4fb4bbd9da04b30551a3a18fe7339d97627c894d636a07503244f15f05a945f8ba0e326e53bac4fd61bc3ad6461da6f126e6191509e7964a34c8b9514a2c488462e9b2a465ddd541</code></pre><p>清理完成再次查看</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system df </span>TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLEImages          46        46        14.44GB   435MB <span class="token punctuation">(</span>3%<span class="token punctuation">)</span>Containers      121       108       1.359GB   3.478kB <span class="token punctuation">(</span>0%<span class="token punctuation">)</span>Local Volumes   2         2         0B        0BBuild Cache     0         0         0B        0B</code></pre><p>当然也可以手动清理无tag的镜像</p><pre class=" language-bash"><code class="language-bash">docker rmi <span class="token punctuation">$(</span>docker images <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"^&lt;none>"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">"&amp;#123;print <span class="token variable">$3</span>&amp;#125;"</span><span class="token punctuation">)</span></code></pre><p>手动清理关闭的容器</p><pre class=" language-bash"><code class="language-bash">docker <span class="token function">ps</span> -a <span class="token operator">|</span> <span class="token function">grep</span> Exit <span class="token operator">|</span> <span class="token function">cut</span> -d <span class="token string">' '</span> -f 1 <span class="token operator">|</span> <span class="token function">xargs</span> docker <span class="token function">rm</span></code></pre><p>空间已经下来了 ::(酷)</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>卡死导致K8sNode节点NotReady</title>
      <link href="/2022/06/05/%E5%8D%A1%E6%AD%BB%E5%AF%BC%E8%87%B4K8sNode%E8%8A%82%E7%82%B9NotReady/"/>
      <url>/2022/06/05/%E5%8D%A1%E6%AD%BB%E5%AF%BC%E8%87%B4K8sNode%E8%8A%82%E7%82%B9NotReady/</url>
      
        <content type="html"><![CDATA[<p>某天发现测试环境节点忽然变为NotRead 导致服务异常:@(内伤)<br>现象是这样的<br><img src="http://www.huhuhahei.cn/usr/uploads/2022/02/4059467715.png" alt="5BE9C01C-080C-4fe5-B384-ECBBCB784F9A.png"><br>describe查看是这样的<br><img src="http://www.huhuhahei.cn/usr/uploads/2022/02/3548693712.png" alt="B3ECBCD8-0721-4007-8223-4A354D6BAC2D.png"><br>初步感觉是节点有问题了 一般出现节点NotReady无非是 节点CPU 内存 磁盘 和网络出问题了<br>结果这样一排查 发现都没问题:@(喷血)<br>下面只能看下kubelet和docker的状态和日志<br>kubelet</p><pre class=" language-bash"><code class="language-bash">systemctl status kubelet● kubelet.service - Kubernetes KubeletLoaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/kubelet.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2022-02-14 11:04:52 CST<span class="token punctuation">;</span> 3min 28s agoDocs: https://github.com/GoogleCloudPlatform/kubernetesProcess: 24722 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/systemd/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24719 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/pids/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24716 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/memory/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24713 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/hugetlb/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24710 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/cpuset/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24707 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/cpuacct/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span></code></pre><p>docker</p><pre class=" language-bash"><code class="language-bash">systemctl status docker● docker.service - Docker Application Container EngineLoaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/docker.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2022-02-14 11:04:42 CST<span class="token punctuation">;</span> 6s agoDocs: http://docs.docker.ioProcess: 24482 ExecStartPost<span class="token operator">=</span>/sbin/iptables -I FORWARD -s 0.0.0.0/0 -j ACCEPT <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Main PID: 24480 <span class="token punctuation">(</span>dockerd<span class="token punctuation">)</span>Tasks: 123Memory: 946.6MCGroup: /system.slice/docker.service</code></pre><p>两个状态都是running状态 只能看下日志信息了<br>查看kubelet日志信息<br><img src="http://www.huhuhahei.cn/usr/uploads/2022/02/1507988096.png" alt="F12D2C89-8FD0-4713-9686-7E1705516DF1.png"></p><p>可以看到kubelet连接docker有问题 一直在重启</p><p>只能在看下docker日志信息了</p><p><img src="http://www.huhuhahei.cn/usr/uploads/2022/02/3767755695.png" alt="3D68EEAD-13A8-49b2-97C2-61283CCAE8E3.png"><br>看这个报错在网上搜索没什么发现 于是我好奇docker ps了下 发现一直卡死没有输出<br>这就很奇怪 docker服务正常 不应该没有输出呀 于是又是一番百度找到一个类似的<br><a href="https://www.bianchengquan.com/article/155669.html">https://www.bianchengquan.com/article/155669.html</a><br>发现应该是docker版本过低触发的版本不兼容 临时先kill掉runc进程后重启kubelet和docker就恢复了 后面还是要时常关注服务的版本</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NACOS部署</title>
      <link href="/2022/06/03/NACOS%E9%83%A8%E7%BD%B2/"/>
      <url>/2022/06/03/NACOS%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h1><h3 id="1-1简介"><a href="#1-1简介" class="headerlink" title="1.1简介"></a>1.1简介</h3><p><a href="https://so.csdn.net/so/search?q=Nacos">Nacos</a>是阿里巴巴开源的一款支持服务注册与发现，配置管理以及微服务管理的组件。用来取代以前常用的注册中心（zookeeper , eureka等等），以及配置中心（spring cloud config等等）。Nacos是集成了注册中心和配置中心的功能，做到了二合一。</p><h1 id="二-Nacos部署"><a href="#二-Nacos部署" class="headerlink" title="二.Nacos部署"></a>二.Nacos部署</h1><h3 id="2-1-创建数据库用户并初始化配置"><a href="#2-1-创建数据库用户并初始化配置" class="headerlink" title="2.1 创建数据库用户并初始化配置"></a>2.1 创建数据库用户并初始化配置</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> nacos <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span><span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> nacos<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> nacos@'<span class="token operator">%</span><span class="token string">' identified by '</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>' <span class="token keyword">with</span> <span class="token keyword">grant</span> <span class="token keyword">option</span><span class="token punctuation">;</span>flush privilages<span class="token punctuation">;</span></code></pre><p>导入nacos初始化sql</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* * Copyright 1999-2018 Alibaba Group Holding Ltd. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * *      http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_use<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>effect<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_schema<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfo_datagrouptenant<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info_aggr   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_aggr<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'datum_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'内容'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfoaggr_datagrouptenantdatum<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'增加租户字段'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info_beta   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_beta<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>beta_ips<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'betaIps'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfobeta_datagrouptenant<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_beta'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info_tag   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_tag<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfotag_datagrouptenanttag<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_tag'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_tags_relation   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_tags_relation<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_type'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>nid<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>nid<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configtagrelation_configidtag<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_tag_relation'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = group_capacity   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>group_capacity<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Group ID，空字符表示整个集群'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>quota<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'配额，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">usage</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'聚合子配置最大个数，，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大变更历史数量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_group_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'集群、各Group容量信息表'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = his_config_info   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>his_config_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>nid<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>op_type<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>nid<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_gmt_create<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_gmt_modified<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_did<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'多租户改造'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = tenant_capacity   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tenant_capacity<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Tenant ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>quota<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'配额，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">usage</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'聚合子配置最大个数'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大变更历史数量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'租户容量信息表'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tenant_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>kp<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'kp'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_desc'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>create_source<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'create_source'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_tenant_info_kptenantid<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>kp<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'tenant_info'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>enabled<span class="token punctuation">`</span> <span class="token keyword">boolean</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>roles<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>idx_user_role<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">ASC</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>permissions<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>resource<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>uk_role_permission<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>role<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>resource<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu'</span><span class="token punctuation">,</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> roles <span class="token punctuation">(</span>username<span class="token punctuation">,</span> role<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'ROLE_ADMIN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="2-2-创建存储"><a href="#2-2-创建存储" class="headerlink" title="2.2 创建存储"></a>2.2 创建存储</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token comment" spellcheck="true"># 此处供应者名字供storageclass调用</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.46.8.18   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/nacos_data  <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/nacos_data   <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>nacos<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos<span class="token comment" spellcheck="true"># Supported policies: Delete、 Retain ， default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><h3 id="2-3-创建mysql配置文件"><a href="#2-3-创建mysql配置文件" class="headerlink" title="2.3 创建mysql配置文件"></a>2.3 创建mysql配置文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">mysql.db.name</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">mysql.host</span><span class="token punctuation">:</span> mysql.blog.svc.cluster.local  <span class="token key atrule">mysql.password</span><span class="token punctuation">:</span> *******  <span class="token key atrule">mysql.port</span><span class="token punctuation">:</span> <span class="token string">"3306"</span>  <span class="token key atrule">mysql.user</span><span class="token punctuation">:</span> nacos<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm</code></pre><h3 id="2-4-创建sts控制器"><a href="#2-4-创建sts控制器" class="headerlink" title="2.4 创建sts控制器"></a>2.4 创建sts控制器</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> OrderedReady  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                <span class="token key atrule">values</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> nacos            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_REPLICAS          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"3"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SERVICE_NAME          <span class="token key atrule">value</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOMAIN_NAME          <span class="token key atrule">value</span><span class="token punctuation">:</span> cluster.local        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>              <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_DB_NAME          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.db.name              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_HOST          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.host              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PORT          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.port              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_USER          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.user              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PASSWORD          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.password              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_SERVER_PORT          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"8848"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_APPLICATION_PORT          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"8848"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PREFER_HOST_MODE          <span class="token key atrule">value</span><span class="token punctuation">:</span> hostname        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMS          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMX          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMN          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>server<span class="token punctuation">:</span>2.0.1        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>port          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512m        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/plugins/peer<span class="token punctuation">-</span>finder          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/data          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> data        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/logs          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logs      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>finder<span class="token punctuation">-</span>plugin<span class="token punctuation">:</span><span class="token number">1.1</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">name</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder<span class="token punctuation">-</span>plugin<span class="token punctuation">-</span>install        <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/plugins/peer<span class="token punctuation">-</span>finder          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1    <span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> data    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ReadWriteOnce      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 50Gi      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>storageclass      <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem</code></pre><h3 id="2-5-创建svc"><a href="#2-5-创建svc" class="headerlink" title="2.5 创建svc"></a>2.5 创建svc</h3><p>nacos_headless.svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">service.alpha.kubernetes.io/tolerate-unready-endpoints</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> server    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</code></pre><p>nacos_svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>service<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span><span class="token number">8</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span><span class="token number">9</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><p>部署完成即可web访问</p><p><img src="http://www.huhuhahei.cn/usr/uploads/2022/01/2162338859.png" alt="A9E8D512-BE84-4a0e-A57B-E81C50F0EBAF.png"></p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> 开源项目 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
