<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>记录一个nacos部署报错处理过程</title>
      <link href="/5d7d0bc/"/>
      <url>/5d7d0bc/</url>
      
        <content type="html"><![CDATA[<p>K8s默认只有ready的pod才能被作为svc的后端,但有时希望即使pod没有准备就绪，服务发现机制也能够发现所有匹配服务标签选择器的pod<br>针对这个需求可以配置一个注释</p><pre class=" language-bash"><code class="language-bash">service.alpha.kubernetes.io/tolerate-unready-endpoints：true</code></pre><p>表示允许将未就绪的pod作为后端服务<br>Nacos的svc就需要这个配置</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">service.alpha.kubernetes.io/tolerate-unready-endpoints</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> server      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7848</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None</code></pre><p>但是今日部署新的集群发现会出现这个报错</p><pre class=" language-bash"><code class="language-bash">2022/05/10 19:04:03 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:04 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:05 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:06 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:07 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:08 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:09 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:10 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:11 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:12 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:13 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:14 lookup nacos-headless on 192.168.0.10:53: no such host</code></pre><p>看报错是无法解析svc的域名 但是这个域名又不太对 svc的域名不应该是这个呀::(怒)这个报错上网搜索也没有记录 一顿操作后看到新的集群是1.20版本的 忽然想到是不是有地方和新版本不适配呢</p><p>上网一搜还真找到 这个注释可能会在新版本被去掉<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/05/2014853700.png"></p><p>于是添加新的字段<code> publishNotReadyAddresses: true</code><br>再次启动果然启动成功了</p><pre class=" language-bash"><code class="language-bash">NAME      READY   STATUS    RESTARTS   AGEnacos-0   1/1     Running   0          5m31snacos-1   1/1     Running   0          4m9snacos-2   1/1     Running   0          2m10s</code></pre><p>不禁感叹 真的是一个小配置 能让人忙活一下午:@(内伤)<br>记录下 看看是否有人会碰到这个问题</p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fortio压测工具配置</title>
      <link href="/2d5d1649/"/>
      <url>/2d5d1649/</url>
      
        <content type="html"><![CDATA[<h1 id="一-Fortio简介"><a href="#一-Fortio简介" class="headerlink" title="一.Fortio简介"></a>一.Fortio简介</h1><p>Fortio这个名字来自希腊语φορτίο，意思是负载&#x2F;负担。最初是Istio的负载测试工具，现在为独立的项目。</p><p>Fortio是一个快速，小型（3Mb docker映像，具有最小的依赖性），可重用，可嵌入的go库以及命令行工具和服务器进程，该服务器包括简单的Web UI和结果的图形表示（均为单个延迟图）以及多重结果比较最小，最大，平均，qps和百分位图。</p><h1 id="二-Fortio部署"><a href="#二-Fortio部署" class="headerlink" title="二.Fortio部署"></a>二.Fortio部署</h1><p>yaml文件</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> fortio  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio    <span class="token key atrule">service</span><span class="token punctuation">:</span> fortio<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> http  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> fortio<span class="token punctuation">-</span>deploy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># This annotation causes Envoy to serve cluster.outbound statistics via 15000/stats</span>        <span class="token comment" spellcheck="true"># in addition to the stats normally served by Istio. The Circuit Breaking example task</span>        <span class="token comment" spellcheck="true"># gives an example of inspecting Envoy stats via proxy config.</span>        <span class="token key atrule">proxy.istio.io/config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>          <span class="token key atrule">proxyStatsMatcher</span><span class="token punctuation">:</span>            <span class="token key atrule">inclusionPrefixes</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">"cluster.outbound"</span>            <span class="token punctuation">-</span> <span class="token string">"cluster_manager"</span>            <span class="token punctuation">-</span> <span class="token string">"listener_manager"</span>            <span class="token punctuation">-</span> <span class="token string">"server"</span>            <span class="token punctuation">-</span> <span class="token string">"cluster.xds-grpc"</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> fortio        <span class="token key atrule">image</span><span class="token punctuation">:</span> fortio/fortio<span class="token punctuation">:</span>latest_release        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>fortio        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8079</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span>ping</code></pre><h1 id="三-压力测试"><a href="#三-压力测试" class="headerlink" title="三.压力测试"></a>三.压力测试</h1><h3 id="1-简单访问"><a href="#1-简单访问" class="headerlink" title="1.简单访问"></a>1.简单访问</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">export</span> FORTIO_POD<span class="token operator">=</span><span class="token punctuation">$(</span>kubectl get pods -l app<span class="token operator">=</span>fortio -o <span class="token string">'jsonpath=&amp;#123;.items[0].metadata.name&amp;#125;'</span><span class="token punctuation">)</span>kubectl <span class="token function">exec</span> <span class="token string">"<span class="token variable">$FORTIO_POD</span>"</span> -c fortio -- /usr/bin/fortio curl -quiet http://www.huhuhahei.cn</code></pre><h3 id="2-发送并发数为-2-的连接（-c-2），请求-20-次（-n-20）"><a href="#2-发送并发数为-2-的连接（-c-2），请求-20-次（-n-20）" class="headerlink" title="2.发送并发数为 2 的连接（-c 2），请求 20 次（-n 20）"></a>2.发送并发数为 2 的连接（<code>-c 2</code>），请求 20 次（<code>-n 20</code>）</h3><pre class=" language-bash"><code class="language-bash">kubectl <span class="token function">exec</span> <span class="token string">"<span class="token variable">$FORTIO_POD</span>"</span> -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 -loglevel Warning https://www.huhuhahei.cn</code></pre><blockquote><p>命令解释如下：</p><p>-c 表示并发数</p><p>-n 一共多少请求</p><p>-qps 每秒查询数，0 表示不限制</p><p>-loglevel 指定日志级别</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录一个Ceph集群数据卷挂载的问题</title>
      <link href="/7eaaabae/"/>
      <url>/7eaaabae/</url>
      
        <content type="html"><![CDATA[<p>当我们用ceph做k8s的动态存储时,特别是使用rdb存储,在pod重启是总会遇到无法挂载pvc的问题</p><p>关键报错</p><pre class=" language-bash"><code class="language-bash">MountVolume.WaitForAttach failed <span class="token keyword">for</span> volume <span class="token string">"pvc-9bb7c438-2328-47ed-bfbd-c261d111644e"</span> <span class="token keyword">:</span> rbd image k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47 is still being used</code></pre><p>这里显示pvc已经被其他的pod使用了,根本原因是之前的pod删除但是挂载的rbd文件并没有删除</p><p>解决方法是需要在ceph集群查看这个rbd文件挂载的位置</p><pre class=" language-bash"><code class="language-bash">rbd info k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47<span class="token comment" spellcheck="true">#通过这个命令可以查看到这个rbd文件的信息</span>rbd image <span class="token string">'kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47'</span><span class="token keyword">:</span>    size 10 GiB <span class="token keyword">in</span> 2560 objects    order 22 <span class="token punctuation">(</span>4 MiB objects<span class="token punctuation">)</span>    snapshot_count: 0    id: 3bfff12997ae2    block_name_prefix: rbd_data.3bfff12997ae2    format: 2    features:    op_features:    flags:    create_timestamp: Sat Dec 25 11:55:16 2021    access_timestamp: Sat Dec 25 11:55:16 2021    modify_timestamp: Sat Dec 25 11:55:16 2021</code></pre><pre class=" language-bash"><code class="language-bash">rados listwatchers -p k8s-pool rbd_header.3bfff12997ae2watcher<span class="token operator">=</span>192.168.0.135:0/1321540337 client.685758 cookie<span class="token operator">=</span>18446462598732840974<span class="token comment" spellcheck="true">#上面的命令可以查看到这个rbd文件挂载的节点</span></code></pre><p>查看到具体的节点到节点上查看rbd文件</p><pre class=" language-bash"><code class="language-bash"><span class="token function">ls</span> /dev/rbd/k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47 -llrwxrwxrwx 1 root root 10 May 27 15:46 /dev/rbd/k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47 -<span class="token operator">></span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/rbd7</code></pre><p>可以查看具体的rbd文件,然后卸载掉</p><pre class=" language-bash"><code class="language-bash">rbd unmap -o force /dev/rbd7</code></pre><p>在观察pod就可以正常挂载了</p>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Promethues通过node_export监控linux服务器</title>
      <link href="/93493f88/"/>
      <url>/93493f88/</url>
      
        <content type="html"><![CDATA[<p><strong>1.node_export下载</strong><br>这里直接使用wget下载，也可以通过官网下载<a href="https://prometheus.io/download/#node_exporter">https://prometheus.io/download/#node_exporter</a></p><pre class=" language-yaml"><code class="language-yaml">wget https<span class="token punctuation">:</span>//github.com/prometheus/node_exporter/releases/download/v1.2.2/node_exporter<span class="token punctuation">-</span>1.2.2.linux<span class="token punctuation">-</span>amd64.tar.gz</code></pre><hr><p><strong>2.安装</strong></p><pre class=" language-yaml"><code class="language-yaml">tar xf node_exporter<span class="token punctuation">-</span>1.2.2.linux<span class="token punctuation">-</span>amd64.tar.gzmv node_exporter<span class="token punctuation">-</span>1.2.2.linux<span class="token punctuation">-</span>amd64 /usr/local/node_exporterr</code></pre><hr><p><strong>3.启动服务</strong></p><pre class=" language-yaml"><code class="language-yaml">cd /usr/local/node_exporternohup ./node_exporter <span class="token punctuation">></span> node_export.log &amp;</code></pre><hr><p><strong>4.promethues添加job</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'Linux'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">'106.75.x.x:9100'</span></code></pre><hr><p><strong>5.grafana 添加模板并展示</strong><br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/1224276126.jpg"><br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2525040169.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus通过Pushgateway监控网络链路</title>
      <link href="/d4b67256/"/>
      <url>/d4b67256/</url>
      
        <content type="html"><![CDATA[<p><strong>1.docker启动pushgateway</strong></p><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>itd <span class="token punctuation">-</span><span class="token punctuation">-</span>name PushGateway <span class="token punctuation">-</span>p 9091<span class="token punctuation">:</span>9091 prom/pushgateway</code></pre><hr><p><strong>2.服务器内编写脚本监控网络并将格式转化为prometheus支持的</strong></p><p>&#96;&#96;&#96;yaml<br>#!&#x2F;bin&#x2F;bash<br>#<br>#####################################<br>#@brief 功能：监控网路丢包率和延迟 -s 是一个ping包的大小 -W 是延迟timeout -c 是发生多少数据包<br>#@author xiajing<br>#@version 1.0<br>#@date 2021&#x2F;01&#x2F;13<br>#@log no<br>#####################################<br>#shell Env<br>#ping发包数<br>c_times&#x3D;200<br>#IP列表数组<br>ip_arr&#x3D;( 118.193.x.x)<br>for (( i &#x3D; 0; i &lt; $</p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Pushgateway </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheus配置nginx监控</title>
      <link href="/bd372af0/"/>
      <url>/bd372af0/</url>
      
        <content type="html"><![CDATA[<p>本篇主要介绍通过nginx-vts来获取nginx监控情况 <strong>1.nginx编译安装需要添加vts模块</strong></p><pre class=" language-bash"><code class="language-bash">./configure --prefix<span class="token operator">=</span>/usr/local/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_stub_status_module --add-module<span class="token operator">=</span><span class="token punctuation">..</span>/nginx-module-vts/ --with-http_ssl_module<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><p>nginx -V查看模块是否添加成功 <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/644249520.png"></p><p><strong>2.nginx配置文件添加配置</strong></p><pre class=" language-bash"><code class="language-bash">http下配置这两个参数vhost_traffic_status_zone<span class="token punctuation">;</span>vhost_traffic_status_filter_by_host on<span class="token punctuation">;</span>server段server <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>        listen 8089<span class="token punctuation">;</span>        server_name localhost<span class="token punctuation">;</span>        root html<span class="token punctuation">;</span>        index index.html index.php<span class="token punctuation">;</span>    location /status <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        vhost_traffic_status_display<span class="token punctuation">;</span>                        vhost_traffic_status_display_format html<span class="token punctuation">;</span>      <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span></code></pre><p><strong>3.配置完成重启服务 通过ip+prot&#x2F;status访问</strong></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/462020058.png"></p><p><strong>4.nginx-vts-exporter下载并配置</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> -c https://github.com/hnlq715/nginx-vts-exporter/releases/download/v0.9.1/nginx-vts-exporter-0.9.1.linux-amd64.tar.gz<span class="token function">mkdir</span> /usr/local/nginx-vts-exporter<span class="token function">tar</span> xf nginx-vts-exporter-0.9.1.linux-amd64.tar.gz -C /usr/local/nginx-vts-exporter<span class="token function">nohup</span> ./nginx-vts-exporter -nginx.scrape_timeout 10 -nginx.scrape_uri http://172.19.0.3:8082/status/format/json <span class="token operator">&amp;</span></code></pre><p><strong>5.promethues添加配置</strong></p><pre class=" language-bash"><code class="language-bash">- job_name: <span class="token string">'Nginx'</span>    static_configs:    - targets:      - <span class="token string">'106.75.x.x:9913'</span></code></pre><p><strong>6.grafana导入模板并查看</strong></p><blockquote><p>导入nginx模板</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/501805390.png"></p><blockquote><p>结果展示</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/3857789207.png"></p><p>[[[<strong>1</strong>]   ]   ]    <a href="https://www.huhuhahei.cn/usr/uploads/2021/08/644249520.png">https://www.huhuhahei.cn/usr/uploads/2021/08/644249520.png</a> </p><p>[[[<strong>2</strong>]   ]   ]    <a href="http://www.huhuhahei.cn/usr/uploads/2021/08/462020058.png">http://www.huhuhahei.cn/usr/uploads/2021/08/462020058.png</a> </p><p>[[[<strong>3</strong>]   ]   ]    <a href="https://www.huhuhahei.cn/usr/uploads/2021/08/501805390.png">https://www.huhuhahei.cn/usr/uploads/2021/08/501805390.png</a> </p><p>[[[<strong>4</strong>]   ]   ]    <a href="https://www.huhuhahei.cn/usr/uploads/2021/08/3857789207.png">https://www.huhuhahei.cn/usr/uploads/2021/08/3857789207.png</a> </p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus监控Mysql</title>
      <link href="/db43c3bf/"/>
      <url>/db43c3bf/</url>
      
        <content type="html"><![CDATA[<p><strong>1.安装mysql_exporter</strong></p><pre class=" language-yaml"><code class="language-yaml">wget  https<span class="token punctuation">:</span>//github.com/prometheus/mysqld_exporter/releases/download/v0.12.1/mysqld_exporter<span class="token punctuation">-</span>0.12.1.linux<span class="token punctuation">-</span>amd64.tar.gz</code></pre><p>解压</p><pre class=" language-yaml"><code class="language-yaml">tar zxvf mysqld_exporter<span class="token punctuation">-</span>0.12.1.linux<span class="token punctuation">-</span>amd64.tar.gzmv mysqld_exporter<span class="token punctuation">-</span>0.12.1.linux<span class="token punctuation">-</span>amd64 /usr/local/mysql_exportercd /usr/local/mysql_exporter</code></pre><hr><p><strong>2.在mysql中创建exporter用户并赋予权限</strong></p><pre class=" language-yaml"><code class="language-yaml">CREATE USER 'exporter'@'localhost' IDENTIFIED BY '123456';  GRANT PROCESS<span class="token punctuation">,</span> REPLICATION CLIENT<span class="token punctuation">,</span> SELECT ON *.* TO 'exporter'@'localhost';flush privileges;</code></pre><hr><p><strong>3.创建配置文件</strong></p><pre class=" language-yaml"><code class="language-yaml">vim /usr/local/mysql_exporter/.my.cnf<span class="token punctuation">[</span>client<span class="token punctuation">]</span>user=exporterpassword=000000</code></pre><hr><p><strong>4.启动</strong></p><pre class=" language-yaml"><code class="language-yaml">nohup ./mysqld_exporter <span class="token punctuation">-</span><span class="token punctuation">-</span>config.my<span class="token punctuation">-</span>cnf=.my.cnf &amp;</code></pre><hr><p><strong>5.测试访问ip：9104</strong><br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2077839008.png"></p><hr><p><strong>6.Prometheus添加节点</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'Mysql'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">'10.7.110.221:9104'</span></code></pre><hr><p><strong>7.Grafana添加模板7362后查看监控</strong></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2547906164.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Operator监控Ingress-nginx</title>
      <link href="/717770d1/"/>
      <url>/717770d1/</url>
      
        <content type="html"><![CDATA[<h1 id="一、创建ServiceMonitor"><a href="#一、创建ServiceMonitor" class="headerlink" title="一、创建ServiceMonitor"></a>一、创建ServiceMonitor</h1><p>yaml文件如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>scraping  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s    <span class="token key atrule">path</span><span class="token punctuation">:</span> /metrics    <span class="token key atrule">port</span><span class="token punctuation">:</span> metrics  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> app  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx</code></pre><p>创建并查看</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master servicemonitor<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f servicemonitor.yaml</span><span class="token punctuation">[</span>root@master servicemonitor<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get servicemonitor -n ingress-nginx</span>NAME                     AGEnginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>scraping   4h18m</code></pre><h1 id="二、查看Prometheus日志"><a href="#二、查看Prometheus日志" class="headerlink" title="二、查看Prometheus日志"></a>二、查看Prometheus日志</h1><pre class=" language-yaml"><code class="language-yaml">level=error ts=2020<span class="token punctuation">-</span>12<span class="token punctuation">-</span>13T09<span class="token punctuation">:</span>52<span class="token punctuation">:</span>35.565Z caller=klog.go<span class="token punctuation">:</span>96 component=k8s_client_runtime func=ErrorDepth msg="/app/discovery/kubernetes/kubernetes.go<span class="token punctuation">:</span><span class="token key atrule">426</span><span class="token punctuation">:</span> Failed to watch <span class="token important">*v1</span>.Endpoints<span class="token punctuation">:</span> failed to list <span class="token important">*v1</span>.Endpoints<span class="token punctuation">:</span> endpoints is forbidden<span class="token punctuation">:</span> User \"system<span class="token punctuation">:</span>serviceaccount<span class="token punctuation">:</span>monitoring<span class="token punctuation">:</span>prometheus<span class="token punctuation">-</span>k8s\" cannot list resource \"endpoints\" in API group \"\" in the namespace \"ingress<span class="token punctuation">-</span>nginx\""</code></pre><p>可以看到是prometheus权限不足 需要修改下prometheus的clusterrole</p><pre class=" language-yaml"><code class="language-yaml">kubectl edit clusterrole prometheus<span class="token punctuation">-</span>k8s</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#rules的内容修改为以下参数</span><span class="token key atrule">rules</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">""</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> nodes  <span class="token punctuation">-</span> services  <span class="token punctuation">-</span> endpoints  <span class="token punctuation">-</span> pods  <span class="token punctuation">-</span> nodes/proxy  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> get  <span class="token punctuation">-</span> list  <span class="token punctuation">-</span> watch<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">""</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> configmaps  <span class="token punctuation">-</span> nodes/metrics  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> get<span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> /metrics  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> get</code></pre><p>再次查看prometheus上已经正常了</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>serviceMonitor/ingress-nginx/nginx-ingress-scraping/0 <span class="token punctuation">(</span>2/2 up<span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre><h1 id="三、Grafana添加模板"><a href="#三、Grafana添加模板" class="headerlink" title="三、Grafana添加模板"></a>三、Grafana添加模板</h1><p>ingress-nginx模板id <code>9614</code></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1026964335.png"></p><p>查看监控<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/2909168757.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Operator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Operator监控ETCD</title>
      <link href="/a00be237/"/>
      <url>/a00be237/</url>
      
        <content type="html"><![CDATA[<h1 id="一、配置etcd证书到prometheus"><a href="#一、配置etcd证书到prometheus" class="headerlink" title="一、配置etcd证书到prometheus"></a>一、配置etcd证书到prometheus</h1><p>对于 etcd 集群一般情况下，为了安全都会开启 https 证书认证的方式，所以要想让 Prometheus 访问到 etcd 集群的监控数据，就需要提供相应的证书校验。这里配置的是kubeadm</p><p>查看证书文件位置</p><pre><code>[root@master servicemonitor]# kubectl get pod etcd-master -n kube-system -o yaml......volumeMounts:    - mountPath: /var/lib/etcd      name: etcd-data    - mountPath: /etc/kubernetes/pki/etcd      name: etcd-certs</code></pre><p>可以看到etcd-certs挂载路径是&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd</p><p>获取证书文件后生成secret 挂载到pormetheus</p><pre><code>kubectl -n monitoring create secret generic etcd-certs --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.crt --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.key --from-file=/etc/kubernetes/pki/etcd/ca.crt</code></pre><h1 id="二、配置prometheus"><a href="#二、配置prometheus" class="headerlink" title="二、配置prometheus"></a>二、配置prometheus</h1><pre><code>[root@master servicemonitor]# kubectl -n monitoring edit prometheus k8s#spec添加下面字段spec......  secrets:  - etcd-certs#保存退出 进入prometheus确认证书是否配置成功[root@master servicemonitor]# kubectl -n monitoring exec -it prometheus-k8s-0 -c prometheus  -- sh/prometheus $ ls /etc/prometheus/secrets/etcd-certs/ca.crt                  healthcheck-client.crt  healthcheck-client.key#证书已经配置成功</code></pre><h1 id="三、创建ServiceMonitor"><a href="#三、创建ServiceMonitor" class="headerlink" title="三、创建ServiceMonitor"></a>三、创建ServiceMonitor</h1><p>ServiceMonitor</p><pre><code>apiVersion: monitoring.coreos.com/v1kind: ServiceMonitormetadata:  name: etcd-k8s  namespace: monitoring  labels:    k8s-app: etcd-k8sspec:  jobLabel: k8s-app  endpoints:  - port: port    interval: 30s    scheme: https    tlsConfig:      caFile: /etc/prometheus/secrets/etcd-certs/ca.crt      certFile: /etc/prometheus/secrets/etcd-certs/healthcheck-client.crt      keyFile: /etc/prometheus/secrets/etcd-certs/healthcheck-client.key      insecureSkipVerify: true  selector:    matchLabels:      k8s-app: etcd  namespaceSelector:    matchNames:    - kube-system</code></pre><p>server</p><pre><code>apiVersion: v1kind: Servicemetadata:  name: etcd-k8s  namespace: kube-system  labels:    k8s-app: etcdspec:  type: ClusterIP  clusterIP: None  ports:  - name: port    port: 2379    protocol: TCP---apiVersion: v1kind: Endpointsmetadata:  name: etcd-k8s  namespace: kube-system  labels:    k8s-app: etcdsubsets:- addresses:  - ip: 10.46.8.18    nodeName: etcd-master  ports:  - name: port    port: 2379    protocol: TCP</code></pre><p>apply</p><pre><code>[root@master servicemonitor]# kubectl apply -f etcd_servicemonitor.yaml[root@master servicemonitor]# kubectl apply -f etcdService.yaml</code></pre><p>可以查看prometheus中监控已经有了 <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1569924190.png"></p><p>grafana添加监控 模板3070 效果如下 <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1217887458.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Operator </tag>
            
            <tag> ETCD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux部署process_exporter监控进程情况</title>
      <link href="/7f800f4/"/>
      <url>/7f800f4/</url>
      
        <content type="html"><![CDATA[<p><strong>1.简介</strong> process-exporter主要用来做进程监控，比如某个服务的进程数、消耗了多少CPU、内存、IO资源等</p><p><strong>2.安装配置</strong></p><pre><code>wget http://github.com/ncabatoff/process-exporter/releases/download/v0.7.2/process-exporter-0.7.2.linux-amd64.tar.gztar -xvf process-exporter-0.7.2.linux-amd64.tar.gz  -C /usr/local/cd /usr/local/ln -s process-exporter-0.7.2.linux-amd64 process_exportercd process_exporter/ln -s process-exporter process_exportermkdir logs</code></pre><p><strong>3.添加需要监控的进程配置（需要自己创建）</strong> 配置文件路径<code>/usr/local/process_exporter/config.yaml</code></p><pre><code>process_names:  - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot;    cmdline:    - &#39;elasticsearch&#39;  - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot;    cmdline:    - &#39;logstash&#39;  - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot;    cmdline:    - &#39;kibana&#39;</code></pre><p><strong>4.启动</strong></p><pre><code>nohup ./process-exporter  -config.path=&quot;config.yaml&quot;  -web.listen-address=&quot;:9256&quot;&gt;&gt; logs/process-exporter.log 2&gt;&amp;1 &amp;#-config.path 指定进程配置文件#-web.listen-address 指定监听端口</code></pre><p><strong>5.prometheus添加对应配置</strong></p><pre><code>- job_name: &#39;process&#39;    static_configs:      - targets: [&#39;106.75.x.x:9256&#39;]</code></pre><p><strong>6.grafana添加对应模板</strong> <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/3998995538.png"> 最终展示 <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2866754558.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux部署Alertmanager对prometheus监控进行告警</title>
      <link href="/e5fe49d2/"/>
      <url>/e5fe49d2/</url>
      
        <content type="html"><![CDATA[<p><strong>1.简介</strong><br>Prometheus发出告警时分为两部分。首先，Prometheus按告警规则(rule_files配置块)向Alertmanager发送告警（即告警规则是在Prometheus上定义的）。然后，由Alertmanager来管理这些告警，包括去重(Deduplicating)、分组(Grouping)、静音(silencing)、抑制(inhibition)、聚合(aggregation )，最终将面要发出的告警通过电子邮件、webhook等方式将告警通知路由(route)给对应的联系人</p><hr><p><strong>2.安装Alertmanager</strong></p><pre class=" language-yaml"><code class="language-yaml">wget http<span class="token punctuation">:</span>//github.com/prometheus/alertmanager/releases/download/v0.20.0/alertmanager<span class="token punctuation">-</span>0.20.0.linux<span class="token punctuation">-</span>amd64.tar.gztar <span class="token punctuation">-</span>xvf alertmanager<span class="token punctuation">-</span>0.20.0.linux<span class="token punctuation">-</span>amd64.tar.gz mv alertmanager<span class="token punctuation">-</span>0.20.0.linux<span class="token punctuation">-</span>amd64 /usr/local/alertmanager</code></pre><hr><p><strong>3.编辑配置文件</strong><br>配置文件路径<code>/usr/local/alertmanager/alertmanager.yml</code></p><p>配置如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">global</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true">#全局配置</span>  <span class="token key atrule">resolve_timeout</span><span class="token punctuation">:</span> 5m    <span class="token key atrule">smtp_smarthost</span><span class="token punctuation">:</span> <span class="token string">'smtp.163.com:465'</span>  <span class="token comment" spellcheck="true">#smtp服务器的地址 我这里使用的是163的</span>  <span class="token key atrule">smtp_from</span><span class="token punctuation">:</span> <span class="token string">'liyonghui_1997@163.com'</span>  <span class="token comment" spellcheck="true">#发送邮件使用的邮箱</span>  <span class="token key atrule">smtp_auth_username</span><span class="token punctuation">:</span> <span class="token string">'liyonghui_1997@163.com'</span> <span class="token comment" spellcheck="true">#用于发送邮件时登录邮箱服务器的邮箱地址</span>  <span class="token key atrule">smtp_auth_password</span><span class="token punctuation">:</span> <span class="token string">'DRHMxxxxxxxxx'</span> <span class="token comment" spellcheck="true">#邮箱授权码 可以在163的邮箱设置中获取</span>  <span class="token key atrule">smtp_require_tls</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">templates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">'/usr/local/alertmanager/template/default.tmpl'</span> <span class="token comment" spellcheck="true">#发送邮件的模板 不需要的话可以不配置的 但是Alertmanager默认模板告警项不直观 且时间是UTC时间查看不方便</span><span class="token key atrule">route</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#默认路由规则</span>  <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">]</span>  <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 30s  <span class="token comment" spellcheck="true">#组等待同组告警默认等待30s</span>  <span class="token key atrule">group_interval</span><span class="token punctuation">:</span> 1m  <span class="token comment" spellcheck="true">#当一个新的告警组被创建时，需要等待'group_wait'后才发送初始通知。这样可以确保在发送等待前能聚合更多具有相同标签的告警，最后合并为一个通知发送</span>  <span class="token key atrule">repeat_interval</span><span class="token punctuation">:</span> 5m <span class="token comment" spellcheck="true">#告警发送间隔时间</span>  <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'mail'</span><span class="token key atrule">receivers</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'mail'</span> <span class="token comment" spellcheck="true">#发送方式</span>  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#接受方的邮箱</span>  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'www.2668416023@foxmail.com'</span>    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true  </span><span class="token comment" spellcheck="true">#是否发送恢复告警</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; template "default.html" . &amp;#125;&amp;#125;'  #模板的配置规则 如果不想配置的这里可以忽略</span>    <span class="token key atrule">headers</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123; Subject: "&amp;#123;&amp;#123; .GroupLabels.SortedPairs.Values &amp;#125;&amp;#125; [&amp;#123;&amp;#123; .Status | toUpper &amp;#125;&amp;#125;:&amp;#123;&amp;#123; .Alerts.Firing | len &amp;#125;&amp;#125;]" &amp;#125;</span>  <span class="token key atrule">inhibit_rules</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#告警抑制规则</span>  <span class="token punctuation">-</span> <span class="token key atrule">source_match</span><span class="token punctuation">:</span>      <span class="token key atrule">severity</span><span class="token punctuation">:</span> <span class="token string">'critical'</span>    <span class="token key atrule">target_match</span><span class="token punctuation">:</span>      <span class="token key atrule">severity</span><span class="token punctuation">:</span> <span class="token string">'warning'</span>    <span class="token key atrule">equal</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">,</span> <span class="token string">'dev'</span><span class="token punctuation">,</span> <span class="token string">'instance'</span><span class="token punctuation">]</span></code></pre><p>模板配置<br>路径<code>/usr/local/alertmanager/template/default.tmpl</code></p><pre class=" language-yaml"><code class="language-yaml">&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; define "default.html" &amp;#125;&amp;#125;</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123;- if gt (len .Alerts.Firing) 0 -&amp;#125;&amp;#125;</span><span class="token punctuation">[</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; .Status | toUpper &amp;#125;&amp;#125;:&amp;#123;&amp;#123; .Alerts.Firing | len &amp;#125;&amp;#125;]</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; range $i, $alert := .Alerts &amp;#125;&amp;#125;</span>&lt;pre<span class="token punctuation">></span>告警节点：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Labels "instance" &amp;#125;&amp;#125;</span>告警服务：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Labels "alertname" &amp;#125;&amp;#125;</span>报警详情：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Annotations "summary" &amp;#125;&amp;#125;</span>开始时间：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $alert.StartsAt.Local &amp;#125;&amp;#125;</span>&lt;/pre<span class="token punctuation">></span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; end &amp;#125;&amp;#125;</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; end &amp;#125;&amp;#125;</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123;- if gt (len .Alerts.Resolved) 0 -&amp;#125;&amp;#125;</span><span class="token punctuation">[</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; .Status | toUpper &amp;#125;&amp;#125;:&amp;#123;&amp;#123; .Alerts.Resolved | len &amp;#125;&amp;#125;]</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; range $i, $alert := .Alerts &amp;#125;&amp;#125;</span>&lt;pre<span class="token punctuation">></span>恢复节点：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Labels "instance" &amp;#125;&amp;#125;</span>恢复服务：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Labels "alertname" &amp;#125;&amp;#125;</span>状 <span class="token punctuation">?</span> <span class="token punctuation">?</span>态：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Status &amp;#125;&amp;#125;</span>开始时间：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $alert.StartsAt.Local &amp;#125;&amp;#125;</span>恢复时间：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $alert.EndsAt.Local &amp;#125;&amp;#125;</span>&lt;/pre<span class="token punctuation">></span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; end &amp;#125;&amp;#125;</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; end &amp;#125;&amp;#125;</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123;- end &amp;#125;&amp;#125;</span></code></pre><p>配置完成后可以使用自带的工具检查下格式</p><pre class=" language-yaml"><code class="language-yaml">./amtool check<span class="token punctuation">-</span>config alertmanager.ymlChecking 'alertmanager.yml'  SUCCESS<span class="token key atrule">Found</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> global config <span class="token punctuation">-</span> route <span class="token punctuation">-</span> 1 inhibit rules <span class="token punctuation">-</span> 1 receivers <span class="token punctuation">-</span> 1 templates  SUCCESS</code></pre><hr><p><strong>4.启动</strong><br>我是使用的nohup启动的 也可以使用systemctl来启动</p><pre class=" language-yaml"><code class="language-yaml">nohup /usr/local/alertmanager/alertmanager <span class="token punctuation">-</span><span class="token punctuation">-</span>config.file=/usr/local/alertmanager/alertmanager.yml <span class="token punctuation">-</span><span class="token punctuation">-</span>storage.path=/usr/local/alertmanager/data <span class="token punctuation">-</span><span class="token punctuation">-</span>web.listen<span class="token punctuation">-</span>address=0.0.0.0<span class="token punctuation">:</span>9093 <span class="token punctuation">-</span><span class="token punctuation">-</span>data.retention=120h<span class="token punctuation">></span><span class="token punctuation">></span> /usr/local/alertmanager/logs/alertmanager.log 2<span class="token punctuation">></span><span class="token important">&amp;1</span> &amp;</code></pre><p>查看进程是否正常运行</p><pre class=" language-yaml"><code class="language-yaml">ps <span class="token punctuation">-</span>ef <span class="token punctuation">|</span> grep alerroot     16687 30885  0 15<span class="token punctuation">:</span>08 pts/1    00<span class="token punctuation">:</span>00<span class="token punctuation">:</span>00 grep <span class="token punctuation">-</span><span class="token punctuation">-</span>color=auto alerroot     30680     1  0 13<span class="token punctuation">:</span>16 <span class="token punctuation">?</span>        00<span class="token punctuation">:</span>00<span class="token punctuation">:</span>05 /usr/local/alertmanager/alertmanager <span class="token punctuation">-</span><span class="token punctuation">-</span>config.file=/usr/local/alertmanager/alertmanager.yml <span class="token punctuation">-</span><span class="token punctuation">-</span>storage.path=/usr/local/alertmanager/data <span class="token punctuation">-</span><span class="token punctuation">-</span>web.listen<span class="token punctuation">-</span>address=0.0.0.0<span class="token punctuation">:</span>9093 <span class="token punctuation">-</span><span class="token punctuation">-</span>data.retention=120h</code></pre><hr><p><strong>5.prometheus添加配置</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">alerting</span><span class="token punctuation">:</span>  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token string">'118.193.x.x:9093'</span> <span class="token comment" spellcheck="true">#Alertmanager节点</span><span class="token comment" spellcheck="true"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span><span class="token key atrule">rule_files</span><span class="token punctuation">:</span>   <span class="token punctuation">-</span> <span class="token string">"rules/*_rules.yml"</span>   <span class="token comment" spellcheck="true">#告警规则配置文件</span>   <span class="token punctuation">-</span> <span class="token string">"rules/*_alerts.yml"</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'alertmanager'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'118.193.37.64:9093'</span><span class="token punctuation">]</span></code></pre><p>重载配置</p><pre class=" language-yaml"><code class="language-yaml">kill <span class="token punctuation">-</span>HUP 18892</code></pre><p>配置没问题的话 就可以在prometheus界面看到Alertmanager<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/939254483.jpg"></p><hr><p><strong>6.配置告警规则</strong><br>分为两个文件：<br><code>node_alerts.yml</code>这个主要配置告警的阈值和发送的文本<br><code>node_rules.yml</code>主要配置告警的规则</p><p>配置如下<br><code>node_rules.yml</code></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> node_rules    <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_cpu_usage      <span class="token key atrule">expr</span><span class="token punctuation">:</span> 100 <span class="token punctuation">-</span> avg(irate(node_cpu_seconds_total&amp;<span class="token comment" spellcheck="true">#123;mode="idle"&amp;#125;[1m])) by (instance) * 100</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_type</span><span class="token punctuation">:</span> CPU_monitor    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_1m_load      <span class="token key atrule">expr</span><span class="token punctuation">:</span> node_load1      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_yepe</span><span class="token punctuation">:</span> load1m_monitor    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_mem_usage      <span class="token key atrule">expr</span><span class="token punctuation">:</span> 100 <span class="token punctuation">-</span> (node_memory_MemAvailable_bytes)/(node_memory_MemTotal_bytes) * 100      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_type</span><span class="token punctuation">:</span> Memory_monitor    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_root_partition_predit      <span class="token key atrule">expr</span><span class="token punctuation">:</span> node_filesystem_free_bytes&amp;<span class="token comment" spellcheck="true">#123;device="/dev/vda1", mountpoint="/"&amp;#125;/(1024*1024*1024)</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_type</span><span class="token punctuation">:</span> root_partition_monitor</code></pre><p><code>node_alerts.yml</code></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> node_alerts    <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> CPU使用率      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_cpu_usage <span class="token punctuation">></span> 80      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> 主机 &amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 CPU使用率持续1分钟超出阈值,当前为 &amp;#123;&amp;#123;humanize $value&amp;#125;&amp;#125; %</span>        <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> 系统一分钟负载      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_1m_load <span class="token punctuation">></span> 20      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> 主机 &amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 1分负载超出阈值,当前为 &amp;#123;&amp;#123;humanize $value&amp;#125;&amp;#125;</span>        <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> 内存使用率      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_mem_usage <span class="token punctuation">></span> 80      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> 主机 &amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 内存 使用率持续1分钟超出阈值,当前为 &amp;#123;&amp;#123;humanize $value&amp;#125;&amp;#125; %</span>        <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> 系统盘磁盘使用      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_root_partition_predit &lt; 10      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> 主机 &amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 根分区 剩余可用空间只有 &amp;#123;&amp;#123;humanize $value&amp;#125;&amp;#125;GB,，请及时扩容和清理空间!!!!!</span></code></pre><p>配置完成重载<code>kill -HUP 18892</code></p><p>访问prometheus界面即可查看配置的规则<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/1841199424.jpg"><br>告警的状态<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/3354612842.jpg"></p><hr><p><strong>7.测试</strong><br>压测cpu看下是否可以正常收到告警</p><p><code>stress -c 2 -t 100000</code></p><p>prometheus查看告警规则已经变为pending状态 证明已经检测到这个告警<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/1183408278.jpg"><br>根据配置一分钟会如果没有恢复会变为firing状态<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2775594136.jpg"><br>稍等三十秒即可收到告警<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2705797334.jpg"><br>取消压测稍后会收到恢复告警<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2428281774.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Linux </tag>
            
            <tag> Alertmanager </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s Operater部署prometheus</title>
      <link href="/1fd45d82/"/>
      <url>/1fd45d82/</url>
      
        <content type="html"><![CDATA[<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><h3 id="1-1-Prometheus-Operator工作原理"><a href="#1-1-Prometheus-Operator工作原理" class="headerlink" title="1.1 Prometheus Operator工作原理"></a>1.1 Prometheus Operator工作原理</h3><p>从概念上来讲Operator就是针对管理特定应用程序的，在Kubernetes基本的Resource和Controller的概念上，以扩展Kubernetes api的形式。帮助用户创建，配置和管理复杂的有状态应用程序。从而实现特定应用程序的常见操作以及运维自动化。</p><p>在Kubernetes中我们使用Deployment、DamenSet，StatefulSet来管理应用Workload，使用Service，Ingress来管理应用的访问方式，使用ConfigMap和Secret来管理应用配置。我们在集群中对这些资源的创建，更新，删除的动作都会被转换为事件(Event)，Kubernetes的Controller Manager负责监听这些事件并触发相应的任务来满足用户的期望。这种方式我们成为声明式，用户只需要关心应用程序的最终状态，其它的都通过Kubernetes来帮助我们完成，通过这种方式可以大大简化应用的配置管理复杂度。</p><p>而除了这些原生的Resource资源以外，Kubernetes还允许用户添加自己的自定义资源(Custom Resource)。并且通过实现自定义Controller来实现对Kubernetes的扩展。</p><p>如下所示，是Prometheus Operator的架构示意图：<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/814160233.png"><br>Prometheus的本质就是一组用户自定义的CRD资源以及Controller的实现，Prometheus Operator负责监听这些自定义资源的变化，并且根据这些资源的定义自动化地完成如Prometheus Server自身以及配置的自动化管理工作。</p><h3 id="1-2-Prometheus-Operator作用"><a href="#1-2-Prometheus-Operator作用" class="headerlink" title="1.2 Prometheus Operator作用"></a>1.2 Prometheus Operator作用</h3><p>要了解Prometheus Operator能做什么，其实就是要了解Prometheus Operator为我们提供了哪些自定义的Kubernetes资源，列出了Prometheus Operator目前提供的️4类资源：</p><ul><li>Prometheus：声明式创建和管理Prometheus Server实例；</li><li>ServiceMonitor：负责声明式的管理监控配置；</li><li>PrometheusRule：负责声明式的管理告警配置；</li><li>Alertmanager：声明式的创建和管理Alertmanager实例。</li></ul><p>简言之，Prometheus Operator能够帮助用户自动化的创建以及管理Prometheus Server以及其相应的配置。</p><h1 id="二、实战配置"><a href="#二、实战配置" class="headerlink" title="二、实战配置"></a>二、实战配置</h1><h3 id="2-1部署Prometheus-Operator"><a href="#2-1部署Prometheus-Operator" class="headerlink" title="2.1部署Prometheus Operator"></a>2.1部署Prometheus Operator</h3><pre class=" language-docker"><code class="language-docker"><span class="token comment" spellcheck="true">#github项目地址，直接使用git拉下来即可</span>https<span class="token punctuation">:</span>//github.com/prometheus<span class="token punctuation">-</span>operator/kube<span class="token punctuation">-</span>prometheus<span class="token punctuation">[</span>root@k8smaster ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#git clone https://github.com/prometheus-operator/kube-prometheus</span><span class="token comment" spellcheck="true">#主要使用项目目录为`manifests`</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># pwd</span>/root/kube<span class="token punctuation">-</span>prometheus/manifests<span class="token comment" spellcheck="true">#开始创建所有服务</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span>kubectl create <span class="token punctuation">-</span>f ./setup<span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span>kubectl create <span class="token punctuation">-</span>f .<span class="token comment" spellcheck="true">#部署完成确认</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring get all</span>NAME                                       READY   STATUS    RESTARTS   AGEpod/alertmanager<span class="token punctuation">-</span>main<span class="token punctuation">-</span>0                    2/2     Running   0          13dpod/alertmanager<span class="token punctuation">-</span>main<span class="token punctuation">-</span>1                    2/2     Running   0          13dpod/alertmanager<span class="token punctuation">-</span>main<span class="token punctuation">-</span>2                    2/2     Running   0          13dpod/blackbox<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>6798fb5bb4<span class="token punctuation">-</span>64knd     3/3     Running   0          13dpod/grafana<span class="token punctuation">-</span>77f997786c<span class="token punctuation">-</span>4gbrh               1/1     Running   0          3h58mpod/kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>bdb774b4d<span class="token punctuation">-</span>mkrvk     3/3     Running   0          13dpod/node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>hn54g                    2/2     Running   0          13dpod/node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>jjxmr                    2/2     Running   0          13dpod/node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>qnppx                    2/2     Running   0          13dpod/prometheus<span class="token punctuation">-</span>adapter<span class="token punctuation">-</span>5b8db7955f<span class="token punctuation">-</span>6s97n    1/1     Running   0          13dpod/prometheus<span class="token punctuation">-</span>adapter<span class="token punctuation">-</span>5b8db7955f<span class="token punctuation">-</span>bp9bb    1/1     Running   0          13dpod/prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0                       2/2     Running   0          5h20mpod/prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>1                       2/2     Running   0          5h20mpod/prometheus<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>5685494db7<span class="token punctuation">-</span>tphkp   2/2     Running   0          13d<span class="token punctuation">...</span><span class="token punctuation">...</span>.</code></pre><h3 id="2-2-web界面查看"><a href="#2-2-web界面查看" class="headerlink" title="2.2 web界面查看"></a>2.2 web界面查看</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#通过查看server端口访问web界面</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get svc -n monitoring</span>NAME                    TYPE        CLUSTER<span class="token punctuation">-</span>IP       EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)prometheus<span class="token punctuation">-</span>k8s          NodePort    10.107.194.41    &lt;none<span class="token punctuation">></span>        9090<span class="token punctuation">:</span>32523/TC</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/586635708.png"></p><blockquote><p>所有监控都正常即可打开grafana查看服务自带的监控面板</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/1635828218.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker部署cadvisor监控容器</title>
      <link href="/985781f7/"/>
      <url>/985781f7/</url>
      
        <content type="html"><![CDATA[<p><strong>1.服务器直接docker启动cadvisor容器</strong></p><pre><code>docker run -d --volume=/:/rootfs:ro --volume=/var/run:/var/run:ro --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --volume=/dev/disk:/dev/disk:ro --publish=8080:8080 --detach=true --name=bj_agent_docker google/cadvisor:latest</code></pre><blockquote><p>主要方式就是通过映射本地文件来监控容器中cpu，内存，网络的使用情况</p></blockquote><p><strong>2.容器启动完成可以访问ip:8080打开cadvisor页面</strong> <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3454901946.jpg"></p><p><strong>3.prometheus添加监控项</strong></p><pre><code>- job_name: &#39;docker&#39;    static_configs:    - targets:      - &#39;106.75.x.x:8080&#39;</code></pre><p><strong>4.重载配置</strong></p><pre><code>kill -HUP 14083</code></pre><p><strong>5.grafana查看监控</strong> <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4223136120.jpg"></p><p>[[<strong>1</strong>]   ]   <a href="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3454901946.jpg">https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3454901946.jpg</a> </p><p>[[<strong>2</strong>]   ]    <a href="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4223136120.jpg">https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4223136120.jpg</a> </p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Docker部署Prometheus+Grafana监控云主机</title>
      <link href="/db991cc/"/>
      <url>/db991cc/</url>
      
        <content type="html"><![CDATA[<p><strong>1.需要先添加prometheus的默认配置文件</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># my global config</span><span class="token key atrule">global</span><span class="token punctuation">:</span>  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span>     15s <span class="token comment" spellcheck="true"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span>  <span class="token key atrule">evaluation_interval</span><span class="token punctuation">:</span> 15s <span class="token comment" spellcheck="true"># Evaluate rules every 15 seconds. The default is every 1 minute.</span>  <span class="token comment" spellcheck="true"># scrape_timeout is set to the global default (10s).</span> <span class="token comment" spellcheck="true"># Alertmanager configuration</span><span class="token key atrule">alerting</span><span class="token punctuation">:</span>  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> alertmanager<span class="token punctuation">:</span><span class="token number">9093</span> <span class="token comment" spellcheck="true"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span><span class="token key atrule">rule_files</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># - "first_rules.yml"</span>  <span class="token comment" spellcheck="true"># - "second_rules.yml"</span> <span class="token comment" spellcheck="true"># A scrape configuration containing exactly one endpoint to scrape:</span><span class="token comment" spellcheck="true"># Here it's Prometheus itself.</span><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># The job name is added as a label `job=&lt;job_name>` to any timeseries scraped from this config.</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'prometheus'</span>     <span class="token comment" spellcheck="true"># metrics_path defaults to '/metrics'</span>    <span class="token comment" spellcheck="true"># scheme defaults to 'http'.</span>    <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 5s    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9090'</span><span class="token punctuation">]</span></code></pre><hr><p><strong>2.直接直接使用官方镜像启动</strong></p><blockquote><p>我这边文件是在&#x2F;tmp下的</p></blockquote><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name=promethues <span class="token punctuation">-</span>p 9090<span class="token punctuation">:</span>9090 <span class="token punctuation">-</span>v /tmp/prometheus.yml<span class="token punctuation">:</span>/etc/prometheus/prometheus.yml prom/prometheus</code></pre><blockquote><p>默认端口是9090 可以直接ip：prot访问</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4279283483.jpg"></p><blockquote><p>页面可以正常打开 证明prometheus已经安装完成</p></blockquote><hr><p><strong>3.安装监控节点node_exporter</strong></p><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span>p 9100<span class="token punctuation">:</span>9100 <span class="token punctuation">-</span>v "/proc<span class="token punctuation">:</span>/host/proc<span class="token punctuation">:</span>ro" <span class="token punctuation">-</span>v "/sys<span class="token punctuation">:</span>/host/sys<span class="token punctuation">:</span>ro" <span class="token punctuation">-</span>v "/<span class="token punctuation">:</span>/rootfs<span class="token punctuation">:</span>ro"  prom/node<span class="token punctuation">-</span>exporter</code></pre><blockquote><p>默认端口是9100 可以直接ip：prot访问确认是否已经收集到数据</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2013638144.jpg"></p><blockquote><p>也可以在prometheus中查看是否有数据</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1268918424.jpg"></p><hr><p><strong>4.安装grafana做页面展示</strong></p><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name=grafana <span class="token punctuation">-</span>p 3000<span class="token punctuation">:</span>3000 grafana/grafana</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3958860042.jpg"></p><blockquote><p>默认账号密码均为admin</p><p>添加数据源选择prometheus，url选择promethues访问链接，并保存</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2130166801.jpg"></p><blockquote><p>导入模板选择9276（可以自己选择喜欢的）并保存</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1685660091.jpg"></p><blockquote><p>查看监控</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3583263766.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Prometheus </tag>
            
            <tag> Grafana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker部署smokeping监控网络质量</title>
      <link href="/ce36882f/"/>
      <url>/ce36882f/</url>
      
        <content type="html"><![CDATA[<p><strong>1.简介</strong></p><p>smokeping是一款监控网络稳定的开源软件，通过它可以监控到本地到各地的网络状况，如延时，丢包，并通过rrdtool制图方式，图形化地展示网络的延时。</p><hr><p><strong>2.配置</strong></p><blockquote><p>创建一个目录做数据持久化<br>mkdir -p &#x2F;data&#x2F;smokeping</p></blockquote><blockquote><p>防火墙放行11111端口并使用docker创建</p></blockquote><pre class=" language-yaml"><code class="language-yaml">docker create <span class="token punctuation">-</span><span class="token punctuation">-</span>name=smokeping <span class="token punctuation">-</span>e TZ=Asia/Chongqing <span class="token punctuation">-</span>p 11111<span class="token punctuation">:</span>80 <span class="token punctuation">-</span><span class="token punctuation">-</span>restart unless<span class="token punctuation">-</span>stopped <span class="token punctuation">-</span>v /data/smokeping/data<span class="token punctuation">:</span>/data <span class="token punctuation">-</span>v /data/smokeping/config<span class="token punctuation">:</span>/config linuxserver/smokeping</code></pre><blockquote><p>访问 <a href="http://ip:11111/">http://ip:11111</a></p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/205928601.png"></p><hr><p><strong>3.配置文件（主要有三个）</strong></p><blockquote><p>Database</p></blockquote><pre class=" language-yaml"><code class="language-yaml">*** Database ***step     = 60pings    = 60<span class="token comment" spellcheck="true"># consfn mrhb steps total</span>AVERAGE  0.5   1  1008AVERAGE  0.5  12  4320    MIN  0.5  12  4320    MAX  0.5  12  4320AVERAGE  0.5 144   720    MAX  0.5 144   720    MIN  0.5 144   720</code></pre><blockquote><p>Presentation 主要是 smokeping 的图表和第一栏的设置</p></blockquote><pre class=" language-yaml"><code class="language-yaml">*** Presentation ***template = /etc/smokeping/basepage.htmlcharset  = utf<span class="token punctuation">-</span><span class="token number">8</span>+ chartsmenu = 排行榜title = 排行榜++ stddevsorter = StdDev(entries=<span class="token punctuation">></span>4)title = 综合指标排名menu = 综合指标format = 综合指数 %f++ maxsorter = Max(entries=<span class="token punctuation">></span>5)title = 最大延迟menu = 最大延迟format = 最大延迟时间 %f 秒++ losssorter = Loss(entries=<span class="token punctuation">></span>5)title = 丢包率menu = 丢包率format = 丢包 %f++ mediansorter = Median(entries=<span class="token punctuation">></span>5)title = 中间数据包延迟menu = 中间数据包延迟format = 中间数据包延迟 RTT %f 秒+ overviewwidth = 600height = 50range = 10h+ detailwidth = 600height = 200unison_tolerance = 2"Last 1 Hours"    1h"Last 24 Hours"   24h"Last 7 Days"     7d"Last 30 Days"   30d<span class="token comment" spellcheck="true">#+ hierarchies</span><span class="token comment" spellcheck="true">#++ owner</span><span class="token comment" spellcheck="true">#title = Host Owner</span><span class="token comment" spellcheck="true">#++ location</span><span class="token comment" spellcheck="true">#title = Location</span></code></pre><blockquote><p>Targets 内则是监控的主体</p></blockquote><pre class=" language-yaml"><code class="language-yaml">Targets   probe = FPing        menu = Top title = Network Latency Grapher remark = Welcome to the SmokePing website of WORKS Company. \             Here you will learn all about the latency of our network.        + InternetSites        + baidu menu = 百度 title = 百度        ++ baidu menu = 百度 title = 百度 host = www.baidu.com        +Europe</code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> 开源项目 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql修改非事务引擎</title>
      <link href="/1aa41b34/"/>
      <url>/1aa41b34/</url>
      
        <content type="html"><![CDATA[<p>1.Mysql获取非事务引擎的命令</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> table_schema database_name<span class="token punctuation">,</span>table_name<span class="token punctuation">,</span><span class="token keyword">engine</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">,</span><span class="token string">'information_schema'</span><span class="token punctuation">,</span><span class="token string">'performance_schema'</span><span class="token punctuation">,</span><span class="token string">'sys'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token keyword">engine</span> <span class="token operator">&lt;></span> <span class="token string">'InnoDB'</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/248870415.png"></p><hr><p>2.获取修改存储引擎的脚本（执行表中的语句即可修改非事务引擎）</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> CONCAT<span class="token punctuation">(</span><span class="token string">'ALTER TABLE'</span><span class="token punctuation">,</span>table_schema<span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span>table_name<span class="token punctuation">,</span><span class="token string">'ENGINE=InnoDB;'</span><span class="token punctuation">)</span> sql_text <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">TABLES</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">,</span><span class="token string">'information_schema'</span><span class="token punctuation">,</span><span class="token string">'performance_schema'</span><span class="token punctuation">,</span><span class="token string">'sys'</span><span class="token punctuation">)</span><span class="token operator">AND</span> <span class="token keyword">engine</span> <span class="token operator">&lt;></span> <span class="token string">'InnoDB'</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/473742447.png"></p><hr><p>3.执行语句修改<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2944975847.png"></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql清理binlog日志</title>
      <link href="/ba01084/"/>
      <url>/ba01084/</url>
      
        <content type="html"><![CDATA[<p>Mysql 清理binlog日志</p><p>1.MySQL Binlog介绍</p><p>MySQL Binlog是以事件形式记录所有DDL(Data Definition Language 数据定义语言：Create、Drop和Alter)和DML(Data Manipulation Language 数据操控语言：Insert、Delete和Update)操作的二进制日志。</p><p>Binlog日志的两个重要的使用场景：</p><p>（1）MySQL主从复制</p><p>（2）数据库回档[数据恢复]</p><hr><p>2.MySQL Binlog过期时间</p><p>MySQL默认Binlog过期时间是7天，这里需要注意：Binlog日志过期时间是按照最新一个Binlog时间t1减7，而不是当前时间减7。比如：今天是14号，而最新Binlog最后的修改时间是9号，那么几号之前的Binlog会被清理呢？答案可能有点出乎意料，没错是9-7&#x3D;2，即2号之前的Binlog会被自动清理。</p><hr><p>3.MySQL Binlog日志清理</p><p>查看binlog文件列表</p><blockquote><p>show binary logs;</p></blockquote><p>查看当前写的binglog</p><blockquote><p>show master status\G</p></blockquote><p>方式一：清理除mysql-bin.000003日志以外的所有binlog日志</p><blockquote><p>purge binary logs to “mysql-bin.000003”;</p></blockquote><p>方式二：清理begin_time时间点前的日志</p><blockquote><p>purge binary logs before “$begin_time”;<br>日期格式：’2018-02-01 12:00:00’;</p></blockquote><hr><p>4.MySQL Binlog日志定时清理脚本</p><p>详情参考：<a href="https://blogs.starcto.com/purge-binary-logs/">https://blogs.starcto.com/purge-binary-logs/</a></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql修改密码</title>
      <link href="/f3a1699d/"/>
      <url>/f3a1699d/</url>
      
        <content type="html"><![CDATA[<p>Mysql修改密码的方法</p><p>1.使用set password 方式修改</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">set</span> password <span class="token keyword">for</span> root<span class="token variable">@localhost</span> <span class="token operator">=</span> password<span class="token punctuation">(</span><span class="token string">'123456'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3836760803.png"></p><hr><p>2.使用mysqladmin修改</p><pre class=" language-sql"><code class="language-sql">mysqladmin <span class="token operator">-</span>u root <span class="token operator">-</span>p123456 password <span class="token number">12345678</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3822327575.png"></p><hr><p>3.使用update user表的方式来修改</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">UPDATE</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">SET</span> authentication_string<span class="token operator">=</span>PASSWORD<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">;</span>flush <span class="token keyword">privileges</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4000690710.png"></p><p>注：mysql5.7以下 应该需要把authentication_string替换为password</p><hr><p>4.忘记密码可以选择这个方法</p><p>修改mysl配置文件添加skip-grant-tables（启动MySQL服务的时候跳过权限表认证）<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2702070504.png"></p><p>重启mysqld 并使用mysql -uroot -p 直接回车登陆<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/297340355.png"></p><p>使用第三种方法来修改密码</p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql数据表损坏恢复</title>
      <link href="/55893a1f/"/>
      <url>/55893a1f/</url>
      
        <content type="html"><![CDATA[<h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><p>某日登陆发现mysql表损坏，无法启动 ，可以借用如下方法恢复。</p><h1 id="二、恢复"><a href="#二、恢复" class="headerlink" title="二、恢复"></a>二、恢复</h1><h2 id="启动一个新库"><a href="#启动一个新库" class="headerlink" title="启动一个新库"></a>启动一个新库</h2><pre class=" language-sql"><code class="language-sql"><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqld_safe --defaults-file=/data/3308/my.conf &amp;</span><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ps -ef | grep 3308</span>root     <span class="token number">25776</span> <span class="token number">17533</span>  <span class="token number">0</span> <span class="token number">10</span>:<span class="token number">11</span> pts<span class="token operator">/</span><span class="token number">1</span>    <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">/</span>bin<span class="token operator">/</span>sh <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysqld_safe <span class="token comment" spellcheck="true">--defaults-file=/data/3308/my.conf</span>mysql    <span class="token number">25927</span> <span class="token number">25776</span>  <span class="token number">0</span> <span class="token number">10</span>:<span class="token number">11</span> pts<span class="token operator">/</span><span class="token number">1</span>    <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysqld <span class="token comment" spellcheck="true">--defaults-file=/data/3308/my.conf --basedir=/application/mysql/ --datadir=/data/3308/data --plugin-dir=/application/mysql//lib/plugin --user=mysql --log-error=db.err --pid-file=db.pid --socket=/data/3308/data/mysql.sock --port=3308</span>root     <span class="token number">25950</span> <span class="token number">17533</span>  <span class="token number">0</span> <span class="token number">10</span>:<span class="token number">12</span> pts<span class="token operator">/</span><span class="token number">1</span>    <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> grep <span class="token comment" spellcheck="true">--color=auto 3308</span></code></pre><h2 id="登陆3308恢复数据"><a href="#登陆3308恢复数据" class="headerlink" title="登陆3308恢复数据"></a>登陆3308恢复数据</h2><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#创建world库</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> world<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#使用之前的建表语句创建数据表</span>mysql<span class="token operator">></span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>city<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>ID<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>Name<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>CountryCode<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>District<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>Population<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>ID<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token keyword">KEY</span> <span class="token punctuation">`</span>CountryCode<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>CountryCode<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_district<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>District<span class="token punctuation">`</span><span class="token punctuation">)</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">4080</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>latin1<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#目前是没有数据的</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city<span class="token punctuation">;</span>Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#删除表空间</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> world<span class="token punctuation">.</span>city <span class="token keyword">discard</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#拷贝损坏表的表空间</span><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cp -a /application/mysql/data/world/city.ibd /data/3307/data/world/</span><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll /data/3307/data/world/</span>total <span class="token number">736</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql   8710 Nov  4 14:41 city.frm</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql 737280 Nov  2 16:26 city.ibd</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql     61 Nov  4 14:39 db.opt</span><span class="token comment" spellcheck="true">#导入表空间</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> world<span class="token punctuation">.</span>city <span class="token keyword">import</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#数据恢复</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">limit</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+----------------+-------------+---------------+------------+</span><span class="token operator">|</span> ID <span class="token operator">|</span> Name           <span class="token operator">|</span> CountryCode <span class="token operator">|</span> District      <span class="token operator">|</span> Population <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+----------------+-------------+---------------+------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> Kabul          <span class="token operator">|</span> AFG         <span class="token operator">|</span> Kabol         <span class="token operator">|</span>    <span class="token number">1780000</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> Qandahar       <span class="token operator">|</span> AFG         <span class="token operator">|</span> Qandahar      <span class="token operator">|</span>     <span class="token number">237500</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> Herat          <span class="token operator">|</span> AFG         <span class="token operator">|</span> Herat         <span class="token operator">|</span>     <span class="token number">186800</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> Mazar<span class="token number">-e</span><span class="token operator">-</span>Sharif <span class="token operator">|</span> AFG         <span class="token operator">|</span> Balkh         <span class="token operator">|</span>     <span class="token number">127800</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> Amsterdam      <span class="token operator">|</span> NLD         <span class="token operator">|</span> Noord<span class="token operator">-</span>Holland <span class="token operator">|</span>     <span class="token number">731200</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+----------------+-------------+---------------+------------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql CSR自动恢复</title>
      <link href="/fa85a72c/"/>
      <url>/fa85a72c/</url>
      
        <content type="html"><![CDATA[<h1 id="一、数据修改后没有commit-也没有记录redo-log"><a href="#一、数据修改后没有commit-也没有记录redo-log" class="headerlink" title="一、数据修改后没有commit 也没有记录redo.log"></a>一、数据修改后没有commit 也没有记录redo.log</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1584144069.jpg"><br><strong>数据更新后，尚未commit设备断电。服务启动后自动加载数据进入内存，因为redo.log无数据，所以数据根据undo.log拍摄的快照回滚并重新落盘</strong></p><h1 id="二、数据没有commit-但是写入了redo-log"><a href="#二、数据没有commit-但是写入了redo-log" class="headerlink" title="二、数据没有commit,但是写入了redo.log"></a>二、数据没有commit,但是写入了redo.log</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/447963019.png"><br><strong>redo buffer根据参数定时写入redo.log，但实际事务并未真正提交。此时设备断电，服务启动后加载数据到内存。</strong></p><ul><li>首先根据redo.log记录变更信息修改data buffer数据 将id 1修改为2</li><li>在根据undo buffer信息 发现没有commit 再次将数据进行回滚 将id 2修改为1</li><li>最后将id&#x3D;1 lsn&#x3D;100 txid&#x3D;100 写入磁盘</li></ul><h1 id="三、事务成功commit"><a href="#三、事务成功commit" class="headerlink" title="三、事务成功commit"></a>三、事务成功commit</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/39761923.png"><br>事务成功提交，变更写入redo.log 并且undo.log记录commit</p><ul><li>首先根据redo.log记录变更信息修改data buffer数据 将id 1修改为2</li><li>undo.log有记录commit因此数据不会发生回滚</li><li>将id&#x3D;2 lsn&#x3D;101 txid&#x3D;101写入磁盘</li></ul>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql根据binlog恢复数据</title>
      <link href="/a6515af6/"/>
      <url>/a6515af6/</url>
      
        <content type="html"><![CDATA[<h1 id="一、准备数据"><a href="#一、准备数据" class="headerlink" title="一、准备数据"></a>一、准备数据</h1><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#创建db</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token number">db1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token number">db2</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token comment" spellcheck="true">#db1创建表并插入测试数据</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> <span class="token number">db1</span><span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> ti<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> ti <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">5</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">5</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ti<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#db2创建表并插入数据</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> <span class="token number">db2</span><span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> t2<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> t2 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t2<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="二、模拟删除数据"><a href="#二、模拟删除数据" class="headerlink" title="二、模拟删除数据"></a>二、模拟删除数据</h1><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">drop</span> <span class="token keyword">table</span> ti<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="三、使用binlog恢复"><a href="#三、使用binlog恢复" class="headerlink" title="三、使用binlog恢复"></a>三、使用binlog恢复</h1><p>使用mysqlbinlog工具查看日志的起始点</p><pre class=" language-sql"><code class="language-sql">mysqlbinlog <span class="token comment" spellcheck="true">--base64-output=decode-rows -vvv /application/mysql/data/mysql-bin.000008</span><span class="token comment" spellcheck="true">#起点</span><span class="token comment" spellcheck="true"># at 2787</span><span class="token comment" spellcheck="true">#211108 13:26:12 server id 1  end_log_pos 2878 CRC32 0x0357015f Querythread_id=exec_time=0error_code=0</span><span class="token keyword">SET</span> <span class="token keyword">TIMESTAMP</span><span class="token operator">=</span><span class="token number">1636349172</span><span class="token comment" spellcheck="true">/*!*/</span><span class="token punctuation">;</span><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token number">db1</span><span class="token comment" spellcheck="true">#结束</span><span class="token comment" spellcheck="true"># at 3722</span><span class="token comment" spellcheck="true">#211108 13:29:20 server id 1  end_log_pos 3753 CRC32 0x958a7d9c Xid = 230</span><span class="token keyword">COMMIT</span><span class="token comment" spellcheck="true">/*!*/</span><span class="token punctuation">;</span></code></pre><p>截取这一段日志，但是我们会发现这一段日志不只有db1的操作还有db2的操作 我们需要截取db1库的 所以需要添加参数-d</p><pre class=" language-sql"><code class="language-sql">mysqlbinlog <span class="token operator">-</span><span class="token number">d</span> <span class="token number">db1</span> <span class="token comment" spellcheck="true">--start-position=2787 --stop-position=3722 /application/mysql/data/mysql-bin.000008 >/tmp/back2.sql</span></code></pre><p>登陆db导入数据</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#先关闭binlog记录</span>mysql<span class="token operator">></span> <span class="token keyword">set</span> sql_log_bin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#导入截取的binlog</span>mysql<span class="token operator">></span> source <span class="token operator">/</span>tmp<span class="token operator">/</span>back2<span class="token punctuation">.</span>sql<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#查看数据已经恢复</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> <span class="token number">db1</span><span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+</span><span class="token operator">|</span> Tables_in_db1 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+</span><span class="token operator">|</span> ti            <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ti<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>当然这个方法其实局限性比较大只能恢复近期的数据 如果是很早之前创建的库的话 代价就比较大了</p><ul><li>1）可以用备份恢复+短时间内二进制日志，恢复到故障之前</li><li>2）非官方方法，binlog2sql，binlog取反，类似于Oracle的flushback</li><li>3）延时从库</li></ul><hr><h1 id="四、binlog日志的日常操作"><a href="#四、binlog日志的日常操作" class="headerlink" title="四、binlog日志的日常操作"></a>四、binlog日志的日常操作</h1><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#物理查看</span><span class="token punctuation">[</span>root<span class="token variable">@db01</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll /application/mysql/data/</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql      285 Mar  6  2017 mysql-bin.000001</span><span class="token comment" spellcheck="true">#命令行查看</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">binary</span> logs<span class="token punctuation">;</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#查看binlog事件</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> binlog events <span class="token operator">in</span> <span class="token string">'mysql-bin.000007'</span><span class="token punctuation">;</span></code></pre><p>设置binlog保留时间</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#临时生效</span><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> expire_logs_days <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#永久生效</span><span class="token punctuation">[</span>root<span class="token variable">@db01</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># vim /etc/my.cnf</span><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>expire_logs_days <span class="token operator">=</span> <span class="token number">7</span></code></pre><p>清除binlog</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#根据时间删除</span><span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS BEFORE <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> INTERVAL <span class="token number">3</span> day<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#根据文件名删除</span><span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS <span class="token keyword">TO</span> <span class="token string">'mysql-bin.000010'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#重置binlog</span>mysql<span class="token operator">></span> reset master<span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql开启慢日志</title>
      <link href="/414a2e2c/"/>
      <url>/414a2e2c/</url>
      
        <content type="html"><![CDATA[<h1 id="一、开启慢日志参数"><a href="#一、开启慢日志参数" class="headerlink" title="一、开启慢日志参数"></a>一、开启慢日志参数</h1><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#指定是否开启慢查询日志</span>slow_query_log <span class="token operator">=</span> <span class="token number">1</span><span class="token comment" spellcheck="true">#指定慢日志文件存放位置（默认在data）</span>slow_query_log_file<span class="token operator">=</span><span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>slow<span class="token punctuation">.</span>log<span class="token comment" spellcheck="true">#设定慢查询的阀值(默认10s)</span>long_query_time<span class="token operator">=</span><span class="token number">0.05</span><span class="token comment" spellcheck="true">#不使用索引的慢查询日志是否记录到日志</span>log_queries_not_using_indexes</code></pre><hr><h1 id="二、Mysqldumpslow"><a href="#二、Mysqldumpslow" class="headerlink" title="二、Mysqldumpslow"></a>二、Mysqldumpslow</h1><pre class=" language-bash"><code class="language-bash">参数说明:-s:是表示按照何种方式排序，c、t、l、r分别是按照记录次数、时间、查询时间、返回的记录数来排序，ac、at、al、ar，表示相应的倒叙；-t:是top n的意思，即为返回前面多少条的数据；-g:后边可以写一个正则匹配模式，大小写不敏感的；</code></pre><pre class=" language-sql"><code class="language-sql"><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqldumpslow -s c -t 10 /application/mysql/data/slow.log</span>Reading mysql slow query log <span class="token keyword">from</span> <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>slow<span class="token punctuation">.</span>logCount: <span class="token number">8</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>69s <span class="token punctuation">(</span>5s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">insert</span> <span class="token keyword">into</span> city_new <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city_newCount: <span class="token number">2</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>24s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">275000.0</span> <span class="token punctuation">(</span><span class="token number">550000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city_new <span class="token keyword">limit</span> NCount: <span class="token number">1</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>04s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>01s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">create</span> <span class="token keyword">table</span> city_new <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cityCount: <span class="token number">1</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>66s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">1.0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> city_newDied at <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysqldumpslow line <span class="token number">161</span><span class="token punctuation">,</span> <span class="token operator">&lt;></span> chunk <span class="token number">10</span><span class="token punctuation">.</span></code></pre><hr><h1 id="三、pt-query-digest日志分析工具"><a href="#三、pt-query-digest日志分析工具" class="headerlink" title="三、pt-query-digest日志分析工具"></a>三、pt-query-digest日志分析工具</h1><p>下载</p><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> https://downloads.percona.com/downloads/percona-toolkit/3.3.1/binary/redhat/7/x86_64/percona-toolkit-3.3.1-1.el7.x86_64.rpm</code></pre><p>yum安装</p><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> -y percona-toolkit-3.3.1-1.el7.x86_64.rpm</code></pre><p>分析日志</p><pre class=" language-bash"><code class="language-bash">pt-query-digest /application/mysql/data/slow.log</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql物理备份之Xtrabackup</title>
      <link href="/247e674/"/>
      <url>/247e674/</url>
      
        <content type="html"><![CDATA[<h1 id="一、Xtrabackup介绍"><a href="#一、Xtrabackup介绍" class="headerlink" title="一、Xtrabackup介绍"></a>一、Xtrabackup介绍</h1><p>MySQL冷备、<code>mysqldump</code>、MySQL热拷贝都无法实现对数据库进行增量备份。在实际生产环境中增量备份是非常实用的，如果数据大于50G或100G，存储空间足够的情况下，可以每天进行完整备份，如果每天产生的数据量较大，需要定制数据备份策略。例如每周实用完整备份，周一到周六实用增量备份。而<code>Percona-Xtrabackup</code>就是为了实现增量备份而出现的一款主流备份工具，<code>xtrabakackup</code>有2个工具，分别是<code>xtrabakup</code>、<code>innobakupe</code>。</p><p><code>Percona-xtrabackup</code>是 <code>Percona</code>公司开发的一个用于MySQL数据库物理热备的备份工具，支持MySQL、Percona server和MariaDB，开源免费，是目前较为受欢迎的主流备份工具。xtrabackup只能备份innoDB和xtraDB两种数据引擎的表，而不能备份MyISAM数据表。</p><hr><h1 id="二、Xtrabackup配置"><a href="#二、Xtrabackup配置" class="headerlink" title="二、Xtrabackup配置"></a>二、Xtrabackup配置</h1><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#安装依赖</span>yum -y <span class="token function">install</span> perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL<span class="token comment" spellcheck="true">#下载Xtrabackup</span><span class="token function">wget</span> <span class="token string">"https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/6/x86_64/percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm"</span><span class="token comment" spellcheck="true">#安装</span>yum localinstall percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm</code></pre><hr><h1 id="三、测试全量备份恢复"><a href="#三、测试全量备份恢复" class="headerlink" title="三、测试全量备份恢复"></a>三、测试全量备份恢复</h1><p>全量备份</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp /backup/full</code></pre><p>备份完成目录</p><pre class=" language-bash"><code class="language-bash">drwxr-x--- 2 root root      122 Nov  9 17:50 backup-rw-r----- 1 root root      430 Nov  9 17:50 backup-my.cnfdrwxr-x--- 2 root root       56 Nov  9 17:50 binlogdrwxr-x--- 2 root root       50 Nov  9 17:50 blogdrwxr-x--- 2 root root       62 Nov  9 17:50 ceshidrwxr-x--- 2 root root       54 Nov  9 17:50 chayidrwxr-x--- 2 root root       56 Nov  9 17:50 chayi2drwxr-x--- 2 root root       48 Nov  9 17:50 db1drwxr-x--- 2 root root       48 Nov  9 17:50 db2drwxr-x--- 2 root root       20 Nov  9 17:50 hhhhdrwxr-x--- 2 root root       92 Nov  9 17:50 huhuhaheidrwxr-x--- 2 root root       20 Nov  9 17:50 huhuhahei1-rw-r----- 1 root root 79691776 Nov  9 17:50 ibdata1-rw-r----- 1 root root 52428800 Nov  9 17:50 ibdata2drwxr-x--- 2 root root       60 Nov  9 17:50 inc1drwxr-x--- 2 root root       60 Nov  9 17:50 inc2drwxr-x--- 2 root root     4096 Nov  9 17:50 mysqldrwxr-x--- 2 root root       76 Nov  9 17:50 oldboydrwxr-x--- 2 root root     4096 Nov  9 17:50 performance_schemadrwxr-x--- 2 root root      160 Nov  9 17:50 slow_query_logdrwxr-x--- 2 root root      284 Nov  9 17:50 <span class="token function">test</span>drwxr-x--- 2 root root       66 Nov  9 17:50 test_binlogdrwxr-x--- 2 root root       76 Nov  9 17:50 wordpressdrwxr-x--- 2 root root      184 Nov  9 17:50 world-rw-r----- 1 root root       21 Nov  9 17:50 xtrabackup_binlog_info    <span class="token comment" spellcheck="true">#记录binlog文件名和binlog的位置点</span>-rw-r----- 1 root root      117 Nov  9 17:50 xtrabackup_checkpoints    <span class="token comment" spellcheck="true">#备份的类型、状态和LSN状态信息文件  </span>-rw-r----- 1 root root      458 Nov  9 17:50 xtrabackup_info    <span class="token comment" spellcheck="true">#备份汇总信息</span>-rw-r----- 1 root root     2560 Nov  9 17:50 xtrabackup_logfile    <span class="token comment" spellcheck="true">#备份的redo文件</span></code></pre><p>模拟mysql数据丢失</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#关闭数据库</span>/etc/init.d/mysqld stopShutting down MySQL<span class="token punctuation">..</span> SUCCESS<span class="token comment" spellcheck="true">#删除数据目录</span><span class="token function">rm</span> -rf /application/mysql/data/</code></pre><p>准备备份<br>将redo进行重做，已提交的写到数据文件，未提交的使用undo回滚，模拟CSR的过程</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log /backup/full</code></pre><p>拷贝数据</p><pre class=" language-bash"><code class="language-bash">innobackupex --copy-back /backup/full</code></pre><blockquote><p>这里需要注意恢复数据时没有指定数据目录 默认会从&#x2F;etc&#x2F;my.cnf中寻找 所以配置文件中需要指定数据库目录</p></blockquote><p>给拷贝的data目录权限</p><pre class=" language-bash"><code class="language-bash"><span class="token function">chown</span> -R mysql:mysql /application/mysql/data/</code></pre><p>启动数据库</p><pre class=" language-bash"><code class="language-bash">/etc/init.d/mysqld startStarting MySQL.Logging to <span class="token string">'/application/mysql/data/db.err'</span><span class="token keyword">.</span>SUCCESS<span class="token operator">!</span></code></pre><p>确认数据恢复</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> <span class="token keyword">backup</span>             <span class="token operator">|</span><span class="token operator">|</span> binlog             <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> ceshi              <span class="token operator">|</span><span class="token operator">|</span> chayi              <span class="token operator">|</span><span class="token operator">|</span> chayi2             <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">db1</span>                <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">db2</span>                <span class="token operator">|</span><span class="token operator">|</span> hhhh               <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> huhuhahei1         <span class="token operator">|</span><span class="token operator">|</span> inc1               <span class="token operator">|</span><span class="token operator">|</span> inc2               <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> oldboy             <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> slow_query_log     <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> test_binlog        <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">|</span> world              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">22</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec</code></pre><hr><h1 id="四、测试增量备份"><a href="#四、测试增量备份" class="headerlink" title="四、测试增量备份"></a>四、测试增量备份</h1><p>先进行全量备份</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp /backup/full</code></pre><p>模拟增加数据</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test1<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> test1<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> test1<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> test1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>进行增量备份</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp --incremental --incremental-basedir<span class="token operator">=</span>/backup/full /backup/test1--incremental：开启增量备份功能--incremental-basedir：上一次备份的路径</code></pre><p>确认备份是否完整</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#全备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-backupedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160492594last_lsn <span class="token operator">=</span> 160492594compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#增备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test1/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160492594to_lsn <span class="token operator">=</span> 160498235last_lsn <span class="token operator">=</span> 160498235compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>可以看到增备的from_lsn是全备的last_lsn 证明数据是完整的</p><p>再次模拟增加数据</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test2<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> test2<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> test2<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> test2 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test2<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>进行第二次增量备份</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp --incremental --incremental-basedir<span class="token operator">=</span>/backup/test1 /backup/test2</code></pre><p>再次确认备份完整性</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#全备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-backupedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160492594last_lsn <span class="token operator">=</span> 160492594compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#增备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test1/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160492594to_lsn <span class="token operator">=</span> 160498235last_lsn <span class="token operator">=</span> 160498235compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#二次增备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test2/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160498235to_lsn <span class="token operator">=</span> 160503761last_lsn <span class="token operator">=</span> 160503761compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>可以发现数据是完整的</p><p>模拟数据丢失</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#关闭数据库</span>/etc/init.d/mysqld stopShutting down MySQL<span class="token punctuation">..</span> SUCCESS<span class="token comment" spellcheck="true">#删除数据目录</span><span class="token function">rm</span> -rf /application/mysql/data/</code></pre><p>准备备份<br>1）full+inc1+inc2<br>2）需要将inc1和inc2按顺序合并到full中<br>3）分步骤进行–apply-log</p><p>第一步：在全备中apply-log时，只应用redo，不应用undo</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --redo-only /backup/full</code></pre><p>第二步：合并inc1合并到full中，并且apply-log，只应用redo，不应用undo</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --redo-only --incremental-dir<span class="token operator">=</span>/backup/test1 /backup/full</code></pre><p>第三步：合并inc2合并到full中，redo和undo都应用</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --incremental-dir<span class="token operator">=</span>/backup/test2 /backup/full</code></pre><p>第四步：整体full执行apply-log，redo和undo都应用</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log /backup/full</code></pre><p>确认数据完整</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-preparedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160503761last_lsn <span class="token operator">=</span> 160503761compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>恢复数据</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#拷贝数据</span>innobackupex --copy-back /backup/full<span class="token comment" spellcheck="true">#权限</span><span class="token function">chown</span> -R mysql:mysql /application/mysql/data<span class="token comment" spellcheck="true">#启动</span>/etc/init.d/mysqld start</code></pre><p>确认数据是否恢复</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test1<span class="token punctuation">.</span>test1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> secmysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test2<span class="token punctuation">.</span>test2<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><h1 id="五、测试差异备份"><a href="#五、测试差异备份" class="headerlink" title="五、测试差异备份"></a>五、测试差异备份</h1><p>首先还是进行增量备份</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp /backup/full</code></pre><p>模拟数据变更</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> chayi1<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> chayi1<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ERROR <span class="token number">1046</span> <span class="token punctuation">(</span>3D000<span class="token punctuation">)</span>: <span class="token keyword">No</span> <span class="token keyword">database</span> selectedmysql<span class="token operator">></span> <span class="token keyword">use</span> chayi1<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> chayi1<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> chayi1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">2</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>模拟第二次数据变化</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> chayi2<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> chayi2<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> chayi22<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec）mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> chayi22 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">2</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi22<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>确认数据完整性</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#全备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-backupedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160504901last_lsn <span class="token operator">=</span> 160504901compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#第一次差异备份</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat chayi1/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160504901to_lsn <span class="token operator">=</span> 160510578last_lsn <span class="token operator">=</span> 160510578compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#第二次差异备份</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat chayi2/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160504901to_lsn <span class="token operator">=</span> 160517449last_lsn <span class="token operator">=</span> 160517449compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>可以发现差异备份第一次和第二次的起点都是901</p><p>模拟数据丢失</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#关闭数据库</span>/etc/init.d/mysqld stopShutting down MySQL<span class="token punctuation">..</span> SUCCESS<span class="token comment" spellcheck="true">#删除数据目录</span><span class="token function">rm</span> -rf /application/mysql/data/</code></pre><p>准备数据</p><p>第一步：在全备中apply-log时，只应用redo，不应用undo</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --redo-only /backup/full</code></pre><p>第二步：合并最后一次差异备份，redo undo都做</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --incremental-dir<span class="token operator">=</span>/backup/chayi2 /backup/full</code></pre><p>第三步：整体full执行apply-log，redo和undo都应用</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log /backup/full</code></pre><p>恢复数据</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#拷贝数据</span>innobackupex --copy-back /backup/full<span class="token comment" spellcheck="true">#权限</span><span class="token function">chown</span> -R mysql:mysql /application/mysql/data<span class="token comment" spellcheck="true">#启动</span>/etc/init.d/mysqld start</code></pre><p>测试数据是否恢复</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi1<span class="token punctuation">.</span>chayi1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi2<span class="token punctuation">.</span>chayi22<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql逻辑备份之Mysqldump</title>
      <link href="/23a9b713/"/>
      <url>/23a9b713/</url>
      
        <content type="html"><![CDATA[<h1 id="一、mysqldump简介"><a href="#一、mysqldump简介" class="headerlink" title="一、mysqldump简介"></a>一、mysqldump简介</h1><p><code>mysqldump</code>是<code>mysql</code>自带的逻辑备份工具，它的备份原理是通过协议连接到 <code>MySQL</code> 数据库，将需要备份的数据查询出来，将查询出的数据转换成对应的<code>insert</code> 语句，当我们需要还原这些数据时，只要执行这些 <code>insert</code> 语句，即可将对应的数据还原。</p><hr><h1 id="二、备份命令"><a href="#二、备份命令" class="headerlink" title="二、备份命令"></a>二、备份命令</h1><p><strong>2.1命令格式</strong></p><pre class=" language-mysql"><code class="language-mysql">mysqldump [选项] 数据库名 [表名] > 脚本名</code></pre><p><strong>2.2 选项说明</strong></p><table><thead><tr><th>参数名</th><th>缩写</th><th>含义</th></tr></thead><tbody><tr><td>–host</td><td>-h</td><td>服务器IP地址</td></tr><tr><td>–port</td><td>-P</td><td>服务器端口号</td></tr><tr><td>–user</td><td>-u</td><td>MySQL 用户名</td></tr><tr><td>–pasword</td><td>-p</td><td>MySQL 密码</td></tr><tr><td>–databases</td><td></td><td>指定要备份的数据库</td></tr><tr><td>–all-databases</td><td></td><td>备份mysql服务器上的所有数据库</td></tr><tr><td>–compact</td><td></td><td>压缩模式，产生更少的输出</td></tr><tr><td>–comments</td><td></td><td>添加注释信息</td></tr><tr><td>–complete-insert</td><td></td><td>输出完成的插入语句</td></tr><tr><td>–lock-tables</td><td></td><td>备份前，锁定所有数据库表</td></tr><tr><td>–no-create-db&#x2F;–no-create-info</td><td></td><td>禁止生成创建数据库语句</td></tr><tr><td>–force</td><td></td><td>当出现错误时仍然继续备份操作</td></tr><tr><td>–default-character-set</td><td></td><td>指定默认字符集</td></tr><tr><td>–add-locks</td><td></td><td>备份数据库表时锁定数据库表</td></tr></tbody></table><p><strong>2.3演示</strong><br>备份指定数据库</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -uroot -p -h 172.19.0.3 typecho > typecho.sql</code></pre><p>备份所有数据库</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -uroot -p --all-databases > all.db</code></pre><p>备份指定数据库指定表</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -u root -p -h 172.19.0.3 typecho.typecho_access_log > typecho.db2</code></pre><p>备份指定排除某些表</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -uroot -p test --ignore-table=test.t1 --ignore-table=test.t2 > /backup/mysqldump/test2.db</code></pre><p>-B：指定库备份</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>B <span class="token number">db1</span> <span class="token operator">></span><span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span><span class="token number">db2</span><span class="token punctuation">.</span>sql</code></pre><p>-d：仅表结构</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span><span class="token number">d</span> <span class="token comment" spellcheck="true">--master-data=1 >/backup/full4.sql</span></code></pre><p>-t：仅数据</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span>t <span class="token comment" spellcheck="true">--master-data=1 >/backup/full4.sql</span></code></pre><p>–single-transaction：快照备份（热备）</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span>R <span class="token comment" spellcheck="true">--triggers --single-transaction --master-data=2 >/backup/full6.sql</span></code></pre><p>gzip:压缩备份（热备常用）</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span>R <span class="token comment" spellcheck="true">--triggers --single-transaction --master-data=2 | gzip >/backup/full_$(date +%F).sql.gz</span><span class="token comment" spellcheck="true">#zcat直接导出压缩</span>zcat <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span>full1<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>gz <span class="token operator">></span> <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span>full2<span class="token punctuation">.</span>sql</code></pre><hr><h1 id="三、数据导入"><a href="#三、数据导入" class="headerlink" title="三、数据导入"></a>三、数据导入</h1><p>3.1db命令导入（需要确认这个库或者表存在）</p><pre class=" language-mysql"><code class="language-mysql">mysql -u root -p -h 10.102.175.143 typecho < ./typecho.sql</code></pre><p>3.2 soure导入</p><pre class=" language-mysql"><code class="language-mysql">mysql > use db_namemysql > source /backup/mysqldump/db_name.db</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql延迟复制、半同步复制、过滤复制、GTID复制</title>
      <link href="/b0f44f6e/"/>
      <url>/b0f44f6e/</url>
      
        <content type="html"><![CDATA[<h1 id="一、延迟复制"><a href="#一、延迟复制" class="headerlink" title="一、延迟复制"></a>一、延迟复制</h1><h2 id="主库操作"><a href="#主库操作" class="headerlink" title="主库操作"></a>主库操作</h2><p>修改配置文件</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#开启binlog</span>log-bin<span class="token operator">=</span>mysql-binbinlog_format<span class="token operator">=</span>row<span class="token comment" spellcheck="true">#设置server_id</span>server_id<span class="token operator">=</span>1</code></pre><p>重启db</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># /etc/init.d/mysqld restart</span>Shutting down MySQL<span class="token punctuation">..</span><span class="token punctuation">..</span> SUCCESS<span class="token operator">!</span>Starting MySQL. SUCCESS<span class="token operator">!</span></code></pre><p>数据库中创建复制用户</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">grant</span> <span class="token keyword">replication</span> slave <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> rep@'<span class="token operator">%</span><span class="token string">' indetified by '</span><span class="token number">123456</span>'<span class="token punctuation">;</span></code></pre><hr><h2 id="从库操作"><a href="#从库操作" class="headerlink" title="从库操作"></a>从库操作</h2><p>修改配置文件</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#设置server_id 需要不等于1</span>server_id<span class="token operator">=</span>7</code></pre><p>查看主库binlog</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+----------+--------------+------------------+-------------------+</span><span class="token operator">|</span> <span class="token keyword">File</span>             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+----------+--------------+------------------+-------------------+</span><span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token number">.000006</span> <span class="token operator">|</span>      <span class="token number">120</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+----------+--------------+------------------+-------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>从库change master</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> change master <span class="token keyword">to</span> master_host<span class="token operator">=</span><span class="token string">'192.168.0.49'</span><span class="token punctuation">,</span>master_user<span class="token operator">=</span><span class="token string">'rep'</span><span class="token punctuation">,</span>master_password<span class="token operator">=</span><span class="token string">'123456'</span><span class="token punctuation">,</span>master_log_file<span class="token operator">=</span><span class="token string">'mysql-bin.000006'</span><span class="token punctuation">,</span>master_log_pos<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">,</span>master_delay<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">start</span> slave<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event                  Master_Host: <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.49</span>                  Master_User: rep                  Master_Port: <span class="token number">3306</span>                Connect_Retry: <span class="token number">60</span>              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000006</span>   <span class="token comment" spellcheck="true">#主库目前的binlog日志</span>          Read_Master_Log_Pos: <span class="token number">120</span>              <span class="token comment" spellcheck="true">#主库目前的binlog日志pos点</span>               Relay_Log_File: <span class="token number">db</span><span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token number">.000002</span>                                                Relay_Log_Pos: <span class="token number">283</span>        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000006</span>             Slave_IO_Running: Yes            Slave_SQL_Running: Yes              Replicate_Do_DB:          Replicate_Ignore_DB:           Replicate_Do_Table:       Replicate_Ignore_Table:      Replicate_Wild_Do_Table:  Replicate_Wild_Ignore_Table:                   Last_Errno: <span class="token number">0</span>                   Last_Error:                 Skip_Counter: <span class="token number">0</span>          Exec_Master_Log_Pos: <span class="token number">120</span>              Relay_Log_Space: <span class="token number">453</span>              Until_Condition: None               Until_Log_File:                Until_Log_Pos: <span class="token number">0</span>           Master_SSL_Allowed: <span class="token keyword">No</span>           Master_SSL_CA_File:           Master_SSL_CA_Path:              Master_SSL_Cert:            Master_SSL_Cipher:               Master_SSL_Key:        Seconds_Behind_Master: <span class="token number">0</span>Master_SSL_Verify_Server_Cert: <span class="token keyword">No</span>                Last_IO_Errno: <span class="token number">0</span>                Last_IO_Error:               Last_SQL_Errno: <span class="token number">0</span>               Last_SQL_Error:  Replicate_Ignore_Server_Ids:             Master_Server_Id: <span class="token number">1</span>                  Master_UUID: <span class="token number">32ab32d8</span><span class="token operator">-</span><span class="token number">414f</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">9cba</span><span class="token operator">-</span><span class="token number">5254003a3847</span>             Master_Info_File: <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span><span class="token number">3307</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>master<span class="token punctuation">.</span>info                    SQL_Delay: <span class="token number">3600</span>                  <span class="token comment" spellcheck="true">#从库延迟3600s执行sql</span>          SQL_Remaining_Delay: <span class="token boolean">NULL</span>        <span class="token comment" spellcheck="true">#距离下次执行sql的时间</span>      Slave_SQL_Running_State: Slave has <span class="token keyword">read</span> <span class="token keyword">all</span> relay log<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> the slave I<span class="token operator">/</span>O thread <span class="token keyword">to</span> <span class="token keyword">update</span> it           Master_Retry_Count: <span class="token number">86400</span>                  Master_Bind:      Last_IO_Error_Timestamp:     Last_SQL_Error_Timestamp:               Master_SSL_Crl:           Master_SSL_Crlpath:           Retrieved_Gtid_Set:            Executed_Gtid_Set:                Auto_Position: <span class="token number">0</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="二、半同步复制"><a href="#二、半同步复制" class="headerlink" title="二、半同步复制"></a>二、半同步复制</h1><h2 id="主库操作-1"><a href="#主库操作-1" class="headerlink" title="主库操作"></a>主库操作</h2><p>开启半同步配置</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#查看是否支持动态开启</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">'have_dynamic_loading'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token operator">|</span> Variable_name        <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token operator">|</span> have_dynamic_loading <span class="token operator">|</span> YES   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#安装插件</span>mysql<span class="token operator">></span> INSTALL PLUGIN rpl_semi_sync_master <span class="token keyword">SONAME</span><span class="token string">'semisync_master.so'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#开启插件</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#设置默认的超时时间</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_master_timeout <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#查看</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span><span class="token string">'rpl%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------------------------+----------+</span><span class="token operator">|</span> Variable_name                      <span class="token operator">|</span> <span class="token keyword">Value</span>    <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------------------------+----------+</span><span class="token operator">|</span> rpl_semi_sync_master_enabled       <span class="token operator">|</span> <span class="token keyword">ON</span>       <span class="token operator">|</span><span class="token operator">|</span> rpl_semi_sync_master_timeout       <span class="token operator">|</span> <span class="token number">1000</span>     <span class="token operator">|</span><span class="token operator">|</span> rpl_semi_sync_master_trace_level   <span class="token operator">|</span> <span class="token number">32</span>       <span class="token operator">|</span><span class="token operator">|</span> rpl_semi_sync_master_wait_no_slave <span class="token operator">|</span> <span class="token keyword">ON</span>       <span class="token operator">|</span><span class="token operator">|</span> rpl_stop_slave_timeout             <span class="token operator">|</span> <span class="token number">31536000</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------------------------+----------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>永久开启</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>rpl_semi_sync_master_enabled<span class="token operator">=</span>1rpl_semi_sync_master_timeout<span class="token operator">=</span>1000</code></pre><hr><h2 id="从库操作-1"><a href="#从库操作-1" class="headerlink" title="从库操作"></a>从库操作</h2><p>开启配置</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> INSTALL PLUGIN rpl_semi_sync_slave <span class="token keyword">SONAME</span><span class="token string">'semisync_slave.so'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_slave_enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#重启io线程（如果之前没有配置主从的话 还需要change master）</span>mysql<span class="token operator">></span> stop slave io_thread<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">start</span> slave io_thread<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>查看并验证</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#主库添加数据测试同步情况</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test3<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test4<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">295</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">590</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">416</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">833</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token comment" spellcheck="true">#这里是2 证明刚才两条sql走了半同步复制</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#关闭半同步在测试</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test5<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test6<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">295</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">590</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token comment" spellcheck="true">#OFF表示半同步关闭</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">OFF</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">416</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">833</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token comment" spellcheck="true">#还是2证明刚才两条sql 没有走半同步</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="三、过滤复制"><a href="#三、过滤复制" class="headerlink" title="三、过滤复制"></a>三、过滤复制</h1><h2 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h2><p>可以选择在主库配置 也可以在从库</p><p>主库：</p><p>白名单:只记录白名单中列出的库的二进制日志</p><pre class=" language-bash"><code class="language-bash">binlog-do-db</code></pre><p>黑名单：不记录黑名单列出的库的二进制日志</p><pre class=" language-bash"><code class="language-bash">binlog-ignore-db</code></pre><p>从库：</p><p>白名单：只执行白名单中列出的库或者表的中继日志</p><pre class=" language-bash"><code class="language-bash">--replicate-do-db<span class="token operator">=</span>test--replicate-do-table<span class="token operator">=</span>test.t1--replicate-wild-do-table<span class="token operator">=</span>test.t2</code></pre><p>黑名单：不执行黑名单中列出的库或者表的中继日志</p><pre class=" language-bash"><code class="language-bash">--replicate-ignore-db--replicate-ignore-table--replicate-wild-ignore-table</code></pre><p>这里测试从库配置</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#配置文件添加</span>replicate<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span><span class="token number">db</span><span class="token operator">=</span>wangzherongyao<span class="token comment" spellcheck="true">#重启从库生效</span>mysqladmin <span class="token operator">-</span>uroot <span class="token operator">-</span>p3308 <span class="token operator">-</span>S <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span><span class="token number">3308</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token punctuation">.</span>sock <span class="token keyword">shutdown</span>mysqld_safe <span class="token comment" spellcheck="true">--defaults-file=/data/3308/my.conf &amp;</span></code></pre><p>查看复制状态（一样需要之前配置主从）</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event                  Master_Host: <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.49</span>                  Master_User: rep                  Master_Port: <span class="token number">3306</span>                Connect_Retry: <span class="token number">60</span>              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000009</span>          Read_Master_Log_Pos: <span class="token number">335</span>               Relay_Log_File: <span class="token number">db</span><span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token number">.000010</span>                Relay_Log_Pos: <span class="token number">498</span>        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000009</span>             Slave_IO_Running: Yes            Slave_SQL_Running: Yes              Replicate_Do_DB: wangzherongyao  <span class="token comment" spellcheck="true">#这里显示的就是复制白名单</span></code></pre><p>测试</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#主库创建数据</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> wangzherongyao<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> lol<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> <span class="token keyword">backup</span>             <span class="token operator">|</span><span class="token operator">|</span> binlog             <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> ceshi              <span class="token operator">|</span><span class="token operator">|</span> chayi1             <span class="token operator">|</span><span class="token operator">|</span> chayi2             <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> huhuhahei1         <span class="token operator">|</span><span class="token operator">|</span> lol                <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> oldboy             <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> slow_query_log     <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> test1              <span class="token operator">|</span><span class="token operator">|</span> test2              <span class="token operator">|</span><span class="token operator">|</span> test3              <span class="token operator">|</span><span class="token operator">|</span> test4              <span class="token operator">|</span><span class="token operator">|</span> test5              <span class="token operator">|</span><span class="token operator">|</span> test6              <span class="token operator">|</span><span class="token operator">|</span> test_binlog        <span class="token operator">|</span><span class="token operator">|</span> wangzherongyao     <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">|</span> world              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">25</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#从库查看</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> <span class="token keyword">backup</span>             <span class="token operator">|</span><span class="token operator">|</span> binlog             <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> ceshi              <span class="token operator">|</span><span class="token operator">|</span> chayi1             <span class="token operator">|</span><span class="token operator">|</span> chayi2             <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> huhuhahei1         <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> oldboy             <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> slow_query_log     <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> test1              <span class="token operator">|</span><span class="token operator">|</span> test2              <span class="token operator">|</span><span class="token operator">|</span> test3              <span class="token operator">|</span><span class="token operator">|</span> test4              <span class="token operator">|</span><span class="token operator">|</span> test5              <span class="token operator">|</span><span class="token operator">|</span> test6              <span class="token operator">|</span><span class="token operator">|</span> test_binlog        <span class="token operator">|</span><span class="token operator">|</span> wangzherongyao     <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">|</span> world              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">24</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#可以发现从库是没有新创建的lol库的 只复制了wangzherongyao</span></code></pre><h1 id="四、GTID复制"><a href="#四、GTID复制" class="headerlink" title="四、GTID复制"></a>四、GTID复制</h1><h2 id="配置文件需要添加参数"><a href="#配置文件需要添加参数" class="headerlink" title="配置文件需要添加参数"></a>配置文件需要添加参数</h2><h2 id="主库"><a href="#主库" class="headerlink" title="主库"></a>主库</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#mysqld下添加 </span><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>gtid_mode<span class="token operator">=</span>ONenforce_gtid_consistencylog-slave-updatesbinlog_format<span class="token operator">=</span>rowlog-bin<span class="token operator">=</span>mysql-binserver_id<span class="token operator">=</span>1</code></pre><h2 id="从库"><a href="#从库" class="headerlink" title="从库"></a>从库</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>gtid_mode<span class="token operator">=</span>ONenforce_gtid_consistencylog-slave-updatesserver_id<span class="token operator">=</span>5log-bin<span class="token operator">=</span>mysql-binbinlog_format<span class="token operator">=</span>row</code></pre><p>修改后都需要重启</p><pre class=" language-bash"><code class="language-bash">/etc/init.d/mysqld restart</code></pre><p>创建复制用户</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">grant</span> <span class="token keyword">replication</span> slave <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> rep@'<span class="token operator">%</span><span class="token string">' identified by '</span><span class="token number">123</span>'<span class="token punctuation">;</span></code></pre><p>从库change master</p><pre class=" language-sql"><code class="language-sql">change master <span class="token keyword">to</span> master_host<span class="token operator">=</span><span class="token string">'10.60.222.142'</span><span class="token punctuation">,</span> master_user<span class="token operator">=</span><span class="token string">'rep'</span><span class="token punctuation">,</span>master_password<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">,</span>master_auto_position<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></code></pre><p>查看</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event                  Master_Host: <span class="token number">10.60</span><span class="token punctuation">.</span><span class="token number">222.142</span>                  Master_User: rep                  Master_Port: <span class="token number">3306</span>                Connect_Retry: <span class="token number">60</span>              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000001</span>          Read_Master_Log_Pos: <span class="token number">2009</span>               Relay_Log_File: <span class="token number">10</span><span class="token operator">-</span><span class="token number">60</span><span class="token operator">-</span><span class="token number">92</span><span class="token operator">-</span><span class="token number">80</span><span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token number">.000002</span>                Relay_Log_Pos: <span class="token number">2219</span>        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000001</span>             Slave_IO_Running: Yes            Slave_SQL_Running: Yes              Replicate_Do_DB:          Replicate_Ignore_DB:           Replicate_Do_Table:       Replicate_Ignore_Table:      Replicate_Wild_Do_Table:  Replicate_Wild_Ignore_Table:                   Last_Errno: <span class="token number">0</span>                   Last_Error:                 Skip_Counter: <span class="token number">0</span>          Exec_Master_Log_Pos: <span class="token number">2009</span>              Relay_Log_Space: <span class="token number">2429</span>              Until_Condition: None               Until_Log_File:                Until_Log_Pos: <span class="token number">0</span>           Master_SSL_Allowed: <span class="token keyword">No</span>           Master_SSL_CA_File:           Master_SSL_CA_Path:              Master_SSL_Cert:            Master_SSL_Cipher:               Master_SSL_Key:        Seconds_Behind_Master: <span class="token number">0</span>Master_SSL_Verify_Server_Cert: <span class="token keyword">No</span>                Last_IO_Errno: <span class="token number">0</span>                Last_IO_Error:               Last_SQL_Errno: <span class="token number">0</span>               Last_SQL_Error:  Replicate_Ignore_Server_Ids:             Master_Server_Id: <span class="token number">1</span>                  Master_UUID: <span class="token number">4c8ebc2b</span><span class="token operator">-</span><span class="token number">42d5</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">a6aa</span><span class="token operator">-</span><span class="token number">52540094f3a0</span>             Master_Info_File: <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token number">-5.6</span><span class="token punctuation">.</span><span class="token number">40</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>master<span class="token punctuation">.</span>info                    SQL_Delay: <span class="token number">0</span>          SQL_Remaining_Delay: <span class="token boolean">NULL</span>      Slave_SQL_Running_State: Slave has <span class="token keyword">read</span> <span class="token keyword">all</span> relay log<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> the slave I<span class="token operator">/</span>O thread <span class="token keyword">to</span> <span class="token keyword">update</span> it           Master_Retry_Count: <span class="token number">86400</span>                  Master_Bind:      Last_IO_Error_Timestamp:     Last_SQL_Error_Timestamp:               Master_SSL_Crl:           Master_SSL_Crlpath:           Retrieved_Gtid_Set: <span class="token number">4c8ebc2b</span><span class="token operator">-</span><span class="token number">42d5</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">a6aa</span><span class="token operator">-</span><span class="token number">52540094f3a0</span>:<span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span>     <span class="token comment" spellcheck="true">#io线程收到的GTID</span>            Executed_Gtid_Set: <span class="token number">4c8ebc2b</span><span class="token operator">-</span><span class="token number">42d5</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">a6aa</span><span class="token operator">-</span><span class="token number">52540094f3a0</span>:<span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span>     <span class="token comment" spellcheck="true">#sql线程执行的GTID</span>                Auto_Position: <span class="token number">1</span>              <span class="token comment" spellcheck="true">#是否开启GTID</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>主库查看</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>processlist <span class="token keyword">where</span> Command <span class="token operator">like</span> <span class="token string">'%Binlog%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+---------------------+------+------------------+------+------------------------------------------------------------------+------+</span><span class="token operator">|</span> ID <span class="token operator">|</span> <span class="token keyword">USER</span> <span class="token operator">|</span> HOST                <span class="token operator">|</span> DB   <span class="token operator">|</span> COMMAND          <span class="token operator">|</span> TIME <span class="token operator">|</span> STATE                                                            <span class="token operator">|</span> INFO <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+---------------------+------+------------------+------+------------------------------------------------------------------+------+</span><span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> rep  <span class="token operator">|</span> <span class="token number">10.60</span><span class="token punctuation">.</span><span class="token number">157.113</span>:<span class="token number">24552</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Binlog <span class="token keyword">Dump</span> GTID <span class="token operator">|</span> <span class="token number">1284</span> <span class="token operator">|</span> Master has sent <span class="token keyword">all</span> binlog <span class="token keyword">to</span> slave<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> binlog <span class="token keyword">to</span> <span class="token number">be</span> up <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> rep  <span class="token operator">|</span> <span class="token number">10.60</span><span class="token punctuation">.</span><span class="token number">92.80</span>:<span class="token number">40700</span>   <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Binlog <span class="token keyword">Dump</span> GTID <span class="token operator">|</span> <span class="token number">1262</span> <span class="token operator">|</span> Master has sent <span class="token keyword">all</span> binlog <span class="token keyword">to</span> slave<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> binlog <span class="token keyword">to</span> <span class="token number">be</span> up <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+---------------------+------+------------------+------+------------------------------------------------------------------+------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql 索引管理</title>
      <link href="/ad2c14ec/"/>
      <url>/ad2c14ec/</url>
      
        <content type="html"><![CDATA[<h1 id="一、索引算法简介"><a href="#一、索引算法简介" class="headerlink" title="一、索引算法简介"></a>一、索引算法简介</h1><h3 id="1-1-B-Tree"><a href="#1-1-B-Tree" class="headerlink" title="1.1 B+Tree"></a>1.1 B+Tree</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/460933094.png"></p><hr><h3 id="1-2-B-Tree"><a href="#1-2-B-Tree" class="headerlink" title="1.2 B*Tree"></a>1.2 B*Tree</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/3363888615.png"></p><hr><h1 id="二、索引管理"><a href="#二、索引管理" class="headerlink" title="二、索引管理"></a>二、索引管理</h1><h3 id="2-1-基础概念"><a href="#2-1-基础概念" class="headerlink" title="2.1 基础概念"></a>2.1 基础概念</h3><pre class=" language-sql"><code class="language-sql">索引建立在表的列上<span class="token punctuation">(</span>字段<span class="token punctuation">)</span>的。在<span class="token keyword">where</span>后面的列建立索引才会加快查询速度。pages<span class="token operator">&lt;</span><span class="token comment" spellcheck="true">---索引（属性）&lt;----查数据。</span></code></pre><hr><h3 id="2-2-索引分类"><a href="#2-2-索引分类" class="headerlink" title="2.2 索引分类"></a>2.2 索引分类</h3><pre class=" language-sql"><code class="language-sql">主键索引普通索引<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>唯一索引</code></pre><hr><h3 id="2-3-索引创建"><a href="#2-3-索引创建" class="headerlink" title="2.3 索引创建"></a>2.3 索引创建</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#创建普通索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_id<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#创建主键索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> pri_name<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#创建唯一索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">unique</span> <span class="token keyword">key</span> uni_age<span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#查看索引</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> student1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> <span class="token keyword">Table</span>    <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> Index_type <span class="token operator">|</span><span class="token keyword">Comment</span> <span class="token operator">|</span> Index_comment <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>  <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> name        <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> uni_age  <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> age         <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_id   <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id          <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#删除索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">drop</span> <span class="token keyword">key</span> idx_id<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#添加前缀索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_name<span class="token punctuation">(</span>name<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#创建联合索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_all<span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>sex<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> student1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> <span class="token keyword">Table</span>    <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> Index_type <span class="token operator">|</span><span class="token keyword">Comment</span> <span class="token operator">|</span> Index_comment <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id          <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">2</span> <span class="token operator">|</span> name        <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">3</span> <span class="token operator">|</span> age         <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">4</span> <span class="token operator">|</span> sex         <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#注 联合索引主要针对多条件查询，因此需要把最常用的条件放到最前面 规则遵循前缀生效特性</span></code></pre><hr><h3 id="2-4-索引创建规则"><a href="#2-4-索引创建规则" class="headerlink" title="2.4 索引创建规则"></a>2.4 索引创建规则</h3><ol><li>创建唯一索引</li><li>如果该列重复值较多，采用联合索引</li><li>经常需要排序、分组和联合操作的字段建立索引</li><li>常作为查询条件的字段建立索引</li><li>索引字段的值很长，尽量使用前缀索引</li><li>限制索引数目</li><li>删除不再使用或者很少使用的素引</li></ol><hr><h3 id="2-5-索引优化规则"><a href="#2-5-索引优化规则" class="headerlink" title="2.5 索引优化规则"></a>2.5 索引优化规则</h3><ol><li><p>没有查询条件，或者查询条件没有索引。</p><ul><li>a）添加查询条件。</li><li>b）为查询条件创建素引</li></ul></li><li><p>查询结果集是原表中的大部分数据，应该是25%以上不走索引a）使用limit去查询数据</p></li><li><p>索引本身损坏（失效），不走索引</p><ul><li>a）监控索引</li><li>b）删除索引，重新建立素引</li></ul></li><li><p>使用函数在索引列上或者对索引列进行运算，不走索引</p></li><li><p>隐式转换导致索引失效</p></li><li><p>&lt;&gt;，not in 不走索引</p></li><li><p>like%”百分号在最前面不走索引</p></li><li><p>单独引用联合索引里非第一位置的索引列.</p></li></ol><hr><h1 id="三、Explain使用"><a href="#三、Explain使用" class="headerlink" title="三、Explain使用"></a>三、Explain使用</h1><h3 id="3-1-Explain详解"><a href="#3-1-Explain详解" class="headerlink" title="3.1 Explain详解"></a>3.1 Explain详解</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#命令常见使用方法</span>mysql<span class="token operator">></span>  <span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>countrycode <span class="token keyword">from</span> city <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><blockquote><p>各字段含义</p></blockquote><ul><li><strong>id</strong>: select查询的序列号,包含一组数字，表示查询中执行select子句或操作表的顺序</li><li><strong>select_type</strong>: 查询的类型，主要是用于区别,普通查询、联合查询、子查询等的复杂查询（SIMPLE，PRIMARY，DERIVED，SUBQUERY，DEPENDENT SUBQUERY，UNCACHEABLE SUBQUREY等）</li><li><strong>table</strong>：显示这一行的数据是关于哪张表的</li><li><strong>type</strong>：type显示的是访问类型，是较为重要的一个指标，结果值从最好到最坏依次是： system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range(尽量保证) &gt; index &gt; ALL。一般来说，得保证查询至少达到range级别，最好能达到ref。</li><li><strong>possible_keys</strong>：显示可能应用在这张表中的索引，一个或多个。查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询实际使用</li><li><strong>key</strong>：实际使用的索引。如果为NULL，则没有使用索引</li><li><strong>key_len</strong>：表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。</li><li><strong>ref</strong>：显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值</li><li><strong>rows</strong>：rows列显示MySQL认为它执行查询时必须检查的行数。（越少越好）</li><li><strong>Extra</strong>：包含不适合在其他列中显示但十分重要的额外信息<ul><li><strong>Using filesort</strong><br>说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。</li><li><strong>Using temporary</strong><br>使了用临时表保存中间结果,MySQL在对查询结果排序时使用临时表。常见于排序 order by 和分组查询 group by。</li><li><strong>USING index</strong><br>表示相应的select操作中使用了覆盖索引(Covering Index)，避免访问了表的数据行，效率不错！</li><li><strong>Using where</strong><br>表明使用了where过滤</li><li><strong>using join buffer</strong><br>使用了连接缓存：</li><li><strong>impossible where</strong><br>where子句的值总是false，不能用来获取任何元组</li><li><strong>select tables optimized away</strong><br>在没有GROUPBY子句的情况下，基于索引优化MIN&#x2F;MAX操作或者</li></ul></li></ul><hr><h3 id="3-2-Type字段分析"><a href="#3-2-Type字段分析" class="headerlink" title="3.2 Type字段分析"></a>3.2 Type字段分析</h3><ul><li>ALL：全表扫描</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">4188</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>index：Full Index Scan，index与ALL区别为index类型只遍历索引树。</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> countrycode <span class="token keyword">from</span> city <span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> CountryCode <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">4188</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>range：索引范围扫描，对索引的扫描开始于某一点，返回匹配值域的行。显而易见的索引范围扫描是带有between或者where子句里带有&lt;,&gt;查询</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'CHN'</span><span class="token punctuation">,</span><span class="token string">'USA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-----------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra                 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-----------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> range <span class="token operator">|</span> CountryCode   <span class="token operator">|</span> CountryCode <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>  <span class="token number">637</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-----------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>ref：使用非唯一索引扫描或者唯一索引的前缀扫描，返回匹配某个单独值的记录行。</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+-------------+---------+-------+------+-----------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra                 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+-------------+---------+-------+------+-----------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> ref  <span class="token operator">|</span> CountryCode   <span class="token operator">|</span> CountryCode <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> const <span class="token operator">|</span>  <span class="token number">363</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+-------------+---------+-------+------+-----------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>eq_ref：类似ref，区别就在使用的索引是唯一索引，对于每个索引键值，表中只有一条记录匹配，简单来说，就是多表连接中使用primary key或者 unique key作为关联条件A</li><li>const、system：当MySQL对查询某部分进行优化，并转换为一个常量时，使用这些类型访问。</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>NULL：MySQL在优化过程中分解语句，执行时甚至不用访问表或索引，例如从一个索引列里选取最小值可以通过单独索引查找完成。</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">10000000000000000000000000</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-----------------------------------------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-----------------------------------------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Impossible <span class="token keyword">WHERE</span> noticed <span class="token keyword">after</span> reading const <span class="token keyword">tables</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-----------------------------------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>转载：<a href="https://blog.driverzeng.com/zenglaoshi/668.html">drz</a></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql 5.6配置多实例</title>
      <link href="/2d4ca71e/"/>
      <url>/2d4ca71e/</url>
      
        <content type="html"><![CDATA[<h1 id="一、准备环境"><a href="#一、准备环境" class="headerlink" title="一、准备环境"></a>一、准备环境</h1><h3 id="1-1-创建数据目录准备配置文件"><a href="#1-1-创建数据目录准备配置文件" class="headerlink" title="1.1 创建数据目录准备配置文件"></a>1.1 创建数据目录准备配置文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /data/&amp;#123;3307,3308&amp;#125;</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat 3307/my.conf</span><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>basedir=/application/mysql/datadir=/data/3307/datasocket=/data/3307/data/mysql.sockport=3307log_err=/data/3307/mysql.errlog<span class="token punctuation">-</span>bin=/data/3307/mysql<span class="token punctuation">-</span>binserver_id=7<span class="token comment" spellcheck="true">#复制配置文件到3308</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cp 3307/my.conf 3308/</span><span class="token comment" spellcheck="true">#给数据目录属主属组</span>chown <span class="token punctuation">-</span>R mysql<span class="token punctuation">:</span>mysql /data</code></pre><h1 id="二、配置启动"><a href="#二、配置启动" class="headerlink" title="二、配置启动"></a>二、配置启动</h1><h3 id="2-1-初始化"><a href="#2-1-初始化" class="headerlink" title="2.1 初始化"></a>2.1 初始化</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#需要到mysql安装目录下的script中执行</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cd /application/mysql/scripts/</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./mysql_install_db --defaults-file=/data/3307/my.conf --basedir=/application/mysql --datadir=/data/3307/data</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./mysql_install_db --defaults-file=/data/3308/my.conf --basedir=/application/mysql --datadir=/data/3308/data</span><span class="token comment" spellcheck="true">#查看目录结果</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tree -L 2 /data</span>/data├── 3307│   ├── data│   ├── my.conf│   ├── mysql<span class="token punctuation">-</span>bin.000001│   ├── mysql<span class="token punctuation">-</span>bin.000002│   ├── mysql<span class="token punctuation">-</span>bin.000003│   ├── mysql<span class="token punctuation">-</span>bin.index│   └── mysql.err└── 3308    ├── data    ├── my.conf    ├── mysql<span class="token punctuation">-</span>bin.000001    ├── mysql<span class="token punctuation">-</span>bin.000002    ├── mysql<span class="token punctuation">-</span>bin.000003    ├── mysql<span class="token punctuation">-</span>bin.index    └── mysql.err</code></pre><h3 id="2-2-启动"><a href="#2-2-启动" class="headerlink" title="2.2 启动"></a>2.2 启动</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqld_safe --defaults-file=/data/3307/my.conf &amp;</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqld_safe --defaults-file=/data/3308/my.conf &amp;</span><span class="token comment" spellcheck="true">#查看端口确认是否启动</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># netstat -anpt</span>Active Internet connections (servers and established)Proto Recv<span class="token punctuation">-</span>Q Send<span class="token punctuation">-</span>Q Local Address           Foreign Address         State       PID/Program nametcp        0      0 0.0.0.0<span class="token punctuation">:</span>22              0.0.0.0<span class="token punctuation">:</span>*               LISTEN      1530/sshdtcp        0      0 127.0.0.1<span class="token punctuation">:</span>25            0.0.0.0<span class="token punctuation">:</span>*               LISTEN      1182/mastertcp        0     52 192.168.0.49<span class="token punctuation">:</span>22         106.75.220.2<span class="token punctuation">:</span>54310      ESTABLISHED 17531/sshd<span class="token punctuation">:</span> root@pttcp        0      0 192.168.0.49<span class="token punctuation">:</span>22         106.75.220.2<span class="token punctuation">:</span>58731      ESTABLISHED 8275/sshd<span class="token punctuation">:</span> root@ptstcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>22                   <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      1530/sshdtcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span>1<span class="token punctuation">:</span>25                  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      1182/mastertcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>3306                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      17293/mysqldtcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>3307                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      16924/mysqldtcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>3308                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      17104/mysqld</code></pre><h3 id="2-3-修改密码"><a href="#2-3-修改密码" class="headerlink" title="2.3 修改密码"></a>2.3 修改密码</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqladmin -uroot -p -S /data/3307/data/mysql.sock password '3307'</span>Enter password<span class="token punctuation">:</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqladmin -uroot -p -S /data/3308/data/mysql.sock password '3308'</span>Enter password<span class="token punctuation">:</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.</code></pre><h3 id="2-4-登陆确认"><a href="#2-4-登陆确认" class="headerlink" title="2.4 登陆确认"></a>2.4 登陆确认</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql -uroot -p3307 -S /data/3307/data/mysql.sock -e "show variables like 'server_id';"</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 7     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql -uroot -p3308 -S /data/3308/data/mysql.sock -e "show variables like 'server_id';"</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 8     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+</code></pre><h1 id="三、调优"><a href="#三、调优" class="headerlink" title="三、调优"></a>三、调优</h1><h3 id="3-1-配置启动脚本"><a href="#3-1-配置启动脚本" class="headerlink" title="3.1 配置启动脚本"></a>3.1 配置启动脚本</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /usr/local/bin/mysql3307</span>mysql <span class="token punctuation">-</span>uroot <span class="token punctuation">-</span>p3307 <span class="token punctuation">-</span>S /data/3307/data/mysql.sock<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># chmod 700 /usr/local/bin/mysql3307</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /usr/local/bin/mysql3308</span>mysql <span class="token punctuation">-</span>uroot <span class="token punctuation">-</span>p3308 <span class="token punctuation">-</span>S /data/3308/data/mysql.sock<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># chmod 700 /usr/local/bin/mysql3308</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#测试连接</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql3307</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.Welcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 11Server version<span class="token punctuation">:</span> 5.6.40<span class="token punctuation">-</span>log Source distributionCopyright (c) 2000<span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql<span class="token punctuation">></span> show variables like 'server_id';+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 7     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+1 row in set (0.00 sec)<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql3308</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.Welcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 4Server version<span class="token punctuation">:</span> 5.6.40<span class="token punctuation">-</span>log Source distributionCopyright (c) 2000<span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql<span class="token punctuation">></span> show variables like 'server_id';+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 8     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+1 row in set (0.00 sec)</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Msql 5.6.40编译安装</title>
      <link href="/61745c5a/"/>
      <url>/61745c5a/</url>
      
        <content type="html"><![CDATA[<h1 id="一、准备环境"><a href="#一、准备环境" class="headerlink" title="一、准备环境"></a><strong>一、准备环境</strong></h1><h3 id="1-1-安装包"><a href="#1-1-安装包" class="headerlink" title="1.1 安装包"></a>1.1 安装包</h3><p>可以直接在这个页面下载，也可以到官网下载mysql.com</p><p><a href="https://video-emlog.cn-sh2.ufileos.com/mysql-5.6.40.tar.gz">mysql-5.6.40.tar.gz</a></p><h3 id="1-2-安装需要的依赖"><a href="#1-2-安装需要的依赖" class="headerlink" title="1.2 安装需要的依赖"></a>1.2 安装需要的依赖</h3><pre class=" language-bash"><code class="language-bash">curl -O http://kode.huhuhahei.cn/index.php?user/publicLink\<span class="token operator">&amp;</span>fid<span class="token operator">=</span>2493D9TIfgnJtc4FvMKOj1EJ5_skR0B695C3of0ZsbNu2mp0WCIPHYOfdZXyzQ6aBAUQbYWtb6pVAhQBB1jzdpFW5M2TxJZtyLLchhvJUUSFGXLuXI5xaocqSsBdj0LsGhA\<span class="token operator">&amp;</span>file_name<span class="token operator">=</span>/mysql-5.6.40.tar.gz</code></pre><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> -y ncurses-devel libaio-devel cmake gcc-c++ autoconf lrzsz</code></pre><h3 id="1-3-解压tar包"><a href="#1-3-解压tar包" class="headerlink" title="1.3 解压tar包"></a>1.3 解压tar包</h3><pre class=" language-yaml"><code class="language-yaml">tar xf mysql<span class="token punctuation">-</span>5.6.40.tar.gzcd mysql<span class="token punctuation">-</span>5.6.40</code></pre><h1 id="二、编译配置"><a href="#二、编译配置" class="headerlink" title="二、编译配置"></a><strong>二、编译配置</strong></h1><h3 id="2-1-编译"><a href="#2-1-编译" class="headerlink" title="2.1 编译"></a>2.1 编译</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建安装目录</span>mkdir /application</code></pre><pre class=" language-yaml"><code class="language-yaml">cmake . <span class="token punctuation">-</span>DCMAKE_INSTALL_PREFIX=/application/mysql<span class="token punctuation">-</span>5.6.40 <span class="token punctuation">-</span>DMYSQL_DATADIR=/application/mysql<span class="token punctuation">-</span>5.6.40/data <span class="token punctuation">-</span>DMYSQL_UNIX_ADDR=/application/mysql<span class="token punctuation">-</span>5.6.40/tmp/mysql.sock <span class="token punctuation">-</span>DDEFAULT_CHARSET=utf8 <span class="token punctuation">-</span>DDEFAULT_COLLATION=utf8_general_ci <span class="token punctuation">-</span>DWITH_EXTRA_CHARSETS=all <span class="token punctuation">-</span>DWITH_INNOBASE_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITH_FEDERATED_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITH_BLACKHOLE_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITH_ZLIB=bundled<span class="token punctuation">-</span>DWITH_SSL=bundled <span class="token punctuation">-</span>DENABLED_LOCAL_INFILE=1 <span class="token punctuation">-</span>DWITH_EMBEDDED_SERVER=1 <span class="token punctuation">-</span>DENABLE_DOWNLOADS=1 <span class="token punctuation">-</span>DWITH_DEBUG=0</code></pre><pre class=" language-yaml"><code class="language-yaml">make &amp;&amp; make install</code></pre><h1 id="三、配置优化"><a href="#三、配置优化" class="headerlink" title="三、配置优化"></a><strong>三、配置优化</strong></h1><h3 id="3-1-文件路径调优"><a href="#3-1-文件路径调优" class="headerlink" title="3.1 文件路径调优"></a>3.1 文件路径调优</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建用户</span>useradd mysql <span class="token punctuation">-</span>s /sbin/nologin <span class="token punctuation">-</span>M<span class="token comment" spellcheck="true">#创建socket文件目录</span>mkdir <span class="token punctuation">-</span>p /application/mysql<span class="token punctuation">-</span>5.6.40/tmp<span class="token comment" spellcheck="true">#配置软连接</span>ln <span class="token punctuation">-</span>s /application/mysql<span class="token punctuation">-</span>5.6.40/ /application/mysql<span class="token comment" spellcheck="true">#复制配置文件</span>cp support<span class="token punctuation">-</span>files/my<span class="token punctuation">-</span>default.cnf /etc/my.cnf<span class="token comment" spellcheck="true">#配置启动命令</span>cp support<span class="token punctuation">-</span>files/mysql.server /etc/init.d/mysqld<span class="token comment" spellcheck="true">#修改属主属组</span>chown <span class="token punctuation">-</span>R mysql<span class="token punctuation">:</span>mysql /application/mysqlchown <span class="token punctuation">-</span>R mysql<span class="token punctuation">:</span>mysql /application/mysql<span class="token punctuation">-</span>5.6.40/</code></pre><h3 id="3-2-初始化数据库"><a href="#3-2-初始化数据库" class="headerlink" title="3.2 初始化数据库"></a>3.2 初始化数据库</h3><pre class=" language-yaml"><code class="language-yaml">cd scripts/./mysql_install_db <span class="token punctuation">-</span><span class="token punctuation">-</span>user=mysql <span class="token punctuation">-</span><span class="token punctuation">-</span>basedir=/application/mysql/ <span class="token punctuation">-</span><span class="token punctuation">-</span>datadir=/application/mysql/data</code></pre><h3 id="3-3-配置环境变量"><a href="#3-3-配置环境变量" class="headerlink" title="3.3 配置环境变量"></a>3.3 配置环境变量</h3><pre class=" language-yaml"><code class="language-yaml">cat /etc/profile.d/mysql.shexport PATH="/application/mysql/bin<span class="token punctuation">:</span>$PATH"source /etc/profile.d/mysql.sh</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#启动mysql</span>/etc/init.d/mysqld start<span class="token comment" spellcheck="true">#可以登陆了</span>mysqlWelcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 1Server version<span class="token punctuation">:</span> 5.6.40 Source distributionCopyright (c) 2000<span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql<span class="token punctuation">></span></code></pre><h3 id="3-4-配置systemctl控制"><a href="#3-4-配置systemctl控制" class="headerlink" title="3.4 配置systemctl控制"></a>3.4 配置systemctl控制</h3><pre class=" language-yaml"><code class="language-yaml">cat /usr/lib/systemd/system/mysqld.service<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>Description=MySQL ServerDocumentation=man<span class="token punctuation">:</span>mysqld(8)Documentation=https<span class="token punctuation">:</span>//dev.mysql.com/doc/refman/en/using<span class="token punctuation">-</span>systemd.htmlAfter=network.targetAfter=syslog.target<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>WantedBy=multi<span class="token punctuation">-</span>user.target<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>User=mysqlGroup=mysqlExecStart=/application/mysql/bin/mysqld <span class="token punctuation">-</span><span class="token punctuation">-</span>defaults<span class="token punctuation">-</span>file=/etc/my.cnfLimitNOFILE = 5000</code></pre><pre class=" language-yaml"><code class="language-yaml">systemctl start mysqldsystemctl status mysqld● mysqld.service <span class="token punctuation">-</span> MySQL Server   <span class="token key atrule">Loaded</span><span class="token punctuation">:</span> loaded (/usr/lib/systemd/system/mysqld.service; disabled; vendor preset<span class="token punctuation">:</span> disabled)   <span class="token key atrule">Active</span><span class="token punctuation">:</span> active (running) since Thu 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 CST; 8s ago     <span class="token key atrule">Docs</span><span class="token punctuation">:</span> man<span class="token punctuation">:</span>mysqld(8)           https<span class="token punctuation">:</span>//dev.mysql.com/doc/refman/en/using<span class="token punctuation">-</span>systemd.html Main PID<span class="token punctuation">:</span> 12236 (mysqld)    <span class="token key atrule">Tasks</span><span class="token punctuation">:</span> <span class="token number">21</span>   <span class="token key atrule">CGroup</span><span class="token punctuation">:</span> /system.slice/mysqld.service           └─12236 /application/mysql/bin/mysqld <span class="token punctuation">-</span><span class="token punctuation">-</span>defaults<span class="token punctuation">-</span>file=/etc/my.cnfOct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>tOct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>7Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> S<span class="token punctuation">...</span>6Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span>  <span class="token punctuation">...</span>;Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> S<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> E<span class="token punctuation">...</span>sOct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> /<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Version</span><span class="token punctuation">:</span> '5.6.40'  socket<span class="token punctuation">:</span> '/appli<span class="token punctuation">...</span>n<span class="token key atrule">Hint</span><span class="token punctuation">:</span> Some lines were ellipsized<span class="token punctuation">,</span> use <span class="token punctuation">-</span>l to show in full.</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Operator 部署服务数据持久化</title>
      <link href="/f26ab3f9/"/>
      <url>/f26ab3f9/</url>
      
        <content type="html"><![CDATA[<h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><h3 id="1-1"><a href="#1-1" class="headerlink" title="1.1"></a>1.1</h3><p>默认使用<code>Operator</code>部署的<code>prometheus</code>和<code>grafana</code>存储数据都是使用的<code>emptyDir</code>格式的，所以服务重启后数据就会清空，生产环境肯定是不行的所以需要将数据持久化到磁盘</p><h1 id="二、配置"><a href="#二、配置" class="headerlink" title="二、配置"></a>二、配置</h1><h3 id="2-1-Prometheus持久化"><a href="#2-1-Prometheus持久化" class="headerlink" title="2.1 Prometheus持久化"></a>2.1 Prometheus持久化</h3><p>prometheus使用的是sts控制器，这边直接使用StorageClass</p><p>首先需要创建StorageClass存储（需要配置nfs 这里就不多赘述了）</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat nfs-sc.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01  </span><span class="token comment" spellcheck="true"># 此处供应者名字供storageclass调用</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/lnmp/prometheus_data  <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/lnmp/prometheus_data   <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span><span class="token comment" spellcheck="true"># Supported policies: Delete、 Retain ， default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#启动</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nfs-sc.yaml</span><span class="token comment" spellcheck="true">#查看</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n kube-system</span>NAME                                       READY   STATUS    RESTARTS   AGnfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>01<span class="token punctuation">-</span>7f7ccdb7bb<span class="token punctuation">-</span>nfsxb        1/1     Running   0          5h10m<span class="token comment" spellcheck="true">#修改prometheus存储配置</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring edit prometheus k8s</span>spec<span class="token punctuation">...</span><span class="token punctuation">...</span>  <span class="token key atrule">storage</span><span class="token punctuation">:</span>    <span class="token key atrule">volumeClaimTemplate</span><span class="token punctuation">:</span>      <span class="token key atrule">spec</span><span class="token punctuation">:</span>        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> ReadWriteMany        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge<span class="token comment" spellcheck="true">#稍后可以看到StorageClass会自动创建PVC和PV</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc -n monitoring</span>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEprometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0   Bound    pvc<span class="token punctuation">-</span>263e60ad<span class="token punctuation">-</span>44c1<span class="token punctuation">-</span>41a8<span class="token punctuation">-</span>9f2a<span class="token punctuation">-</span>77a35f507ad0   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       6h7mprometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>1   Bound    pvc<span class="token punctuation">-</span>73ee2d7f<span class="token punctuation">-</span>180c<span class="token punctuation">-</span>40b9<span class="token punctuation">-</span>925a<span class="token punctuation">-</span>0bddc58c4604   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       6h7m<span class="token comment" spellcheck="true">#登陆pod查看挂载</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it -n monitoring prometheus-k8s-0 -- /bin/sh</span>/prometheus $ df <span class="token punctuation">-</span>hFilesystem                Size      Used Available Use% Mounted onoverlay                  40.0G     13.1G     26.8G  33% /tmpfs                    64.0M         0     64.0M   0% /devtmpfs                     1.9G         0      1.9G   0% /sys/fs/cgroup10.7.48.223<span class="token punctuation">:</span>/data/lnmp/prometheus_data/monitoring<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>263e60ad<span class="token punctuation">-</span>44c1<span class="token punctuation">-</span>41a8<span class="token punctuation">-</span>9f2a<span class="token punctuation">-</span>77a35f507ad0/prometheus<span class="token punctuation">-</span>db</code></pre><h3 id="2-2Grafana持久化"><a href="#2-2Grafana持久化" class="headerlink" title="2.2Grafana持久化"></a>2.2Grafana持久化</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建Grafana的pvc</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat grafana-pvc.yaml</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token comment" spellcheck="true">#部署</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f grafana-pvc.yaml</span><span class="token comment" spellcheck="true">#查看pvc是否创建</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc -n monitoring</span>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEgrafana                              Bound    pvc<span class="token punctuation">-</span>c16d1015<span class="token punctuation">-</span>f1ed<span class="token punctuation">-</span>40be<span class="token punctuation">-</span>bfb2<span class="token punctuation">-</span>d980377692ea   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       5h23m<span class="token comment" spellcheck="true">#编辑grafana的deployment资源配置</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring edit deployments.apps grafan</span><span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span><span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>storage<span class="token comment" spellcheck="true">#更改为</span><span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>storage      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> grafana<span class="token comment" spellcheck="true">#同时建议添加环境变量配置默认密码</span><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_SECURITY_ADMIN_USER<span class="token key atrule">value</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_SECURITY_ADMIN_PASSWORD<span class="token key atrule">value</span><span class="token punctuation">:</span> admin321<span class="token comment" spellcheck="true">#保存退出</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Operator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubeadm卸载</title>
      <link href="/b7046e9b/"/>
      <url>/b7046e9b/</url>
      
        <content type="html"><![CDATA[<h1 id="删除kubeadm构建的Kubernetes集群"><a href="#删除kubeadm构建的Kubernetes集群" class="headerlink" title="删除kubeadm构建的Kubernetes集群"></a>删除kubeadm构建的Kubernetes集群</h1><p>所有通过 <a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/deployment/bootstrap_kubernetes_single/kubeadm.html#kubeadm">kubeadm</a> 工具构建的Kubernetes集群以及节点，都可以通过 <code>kubeadm</code> 工具反向卸载(删除)，这是一个非常方便的操作。我的实践是因为在开发测试环境， <a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/administer/kubeadm_administer/upgrade_kubeadm_cluster.html#upgrade-kubeadm-cluster">升级kubeadm集群</a> 失败，为了快速开始下一阶段测试工作，所以准备重建Kubernetes集群。</p><p><code>kubeadm reset</code> 命令执行会提示:</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> WARNING: Changes made to this host by <span class="token string">'kubeadm init'</span> or <span class="token string">'kubeadm join'</span> will be reverted.<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Are you sure you want to proceed? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>:</code></pre><p>也就是说，不管是加入集群的工作节点，还是初始化的管控节点，都可以用这个工具反向操作</p><p>检查集群:</p><pre class=" language-bash"><code class="language-bash">kubectl get nodes</code></pre><p>当前节点:</p><pre class=" language-bash"><code class="language-bash">NAME         STATUS   ROLES    AGE    VERSIONpi-master1   Ready    master   241d   v1.20.9pi-worker1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.20.9pi-worker2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.21.3zcloud       Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   127d   v1.21.3</code></pre><p>首先在 <code>zcloud</code> 上执行节点清理:</p><pre class=" language-bash"><code class="language-bash">kubeadm reset<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> WARNING: Changes made to this host by <span class="token string">'kubeadm init'</span> or <span class="token string">'kubeadm join'</span> will be reverted.<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Are you sure you want to proceed? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: y</code></pre><p>提示信息:</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checksW0728 23:50:09.914348 3734557 removeetcdmember.go:79<span class="token punctuation">]</span> <span class="token punctuation">[</span>reset<span class="token punctuation">]</span> No kubeadm config, using etcd pod spec to get data directory<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> No etcd config found. Assuming external etcd<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Please, manually reset etcd to prevent further issues<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Stopping the kubelet <span class="token function">service</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Unmounting mounted directories <span class="token keyword">in</span> <span class="token string">"/var/lib/kubelet"</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of config directories: <span class="token punctuation">[</span>/etc/kubernetes/manifests /etc/kubernetes/pki<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting files: <span class="token punctuation">[</span>/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of stateful directories: <span class="token punctuation">[</span>/var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni<span class="token punctuation">]</span>The reset process does not clean CNI configuration. To <span class="token keyword">do</span> so, you must remove /etc/cni/net.dThe reset process does not reset or clean up iptables rules or IPVS tables.If you wish to reset iptables, you must <span class="token keyword">do</span> so manually by using the <span class="token string">"iptables"</span> command.If your cluster was setup to utilize IPVS, run ipvsadm --clear <span class="token punctuation">(</span>or similar<span class="token punctuation">)</span>to reset your system's IPVS tables.The reset process does not clean your kubeconfig files and you must remove them manually.Please, check the contents of the <span class="token variable">$HOME</span>/.kube/config file.</code></pre><p>可以看到 <code>reset</code> 过程不会清理CNI配置，也不会清理iptables规则，两者需要手工处理</p><p>完成以后，在管控服务器上检查，可以看到该工作节点已经 <code>NotReady</code></p><pre class=" language-bash"><code class="language-bash">kubectl get nodes</code></pre><p>显示:</p><pre class=" language-bash"><code class="language-bash">NAME         STATUS     ROLES    AGE    VERSIONpi-master1   Ready      master   241d   v1.20.9pi-worker1   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.20.9pi-worker2   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.21.3zcloud       NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>   127d   v1.21.3</code></pre><p>删除节点:</p><pre class=" language-bash"><code class="language-bash">kubectl delete node zcloud</code></pre><p>在工作节点上再执行一次清理 <code>iptables</code> 和 <code>cni</code></p><pre class=" language-bash"><code class="language-bash"><span class="token function">rm</span> -rf /etc/cni/net.diptables -F</code></pre><p>所有工作节点清理以后，最后执行管控节点卸载:</p><pre class=" language-bash"><code class="language-bash">kubeadm reset</code></pre><p>输出信息:</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Removing info <span class="token keyword">for</span> node <span class="token string">"pi-master1"</span> from the ConfigMap <span class="token string">"kubeadm-config"</span> <span class="token keyword">in</span> the <span class="token string">"kube-system"</span> NamespaceW0729 00:23:55.555252 3406560 removeetcdmember.go:61<span class="token punctuation">]</span> <span class="token punctuation">[</span>reset<span class="token punctuation">]</span> failed to remove etcd member: error syncing endpoints with etcd: context deadline exceeded, please manually remove this etcd member using etcdctl<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Stopping the kubelet <span class="token function">service</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Unmounting mounted directories <span class="token keyword">in</span> <span class="token string">"/var/lib/kubelet"</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of config directories: <span class="token punctuation">[</span>/etc/kubernetes/manifests /etc/kubernetes/pki<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting files: <span class="token punctuation">[</span>/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of stateful directories: <span class="token punctuation">[</span>/var/lib/etcd /var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni<span class="token punctuation">]</span>The reset process does not clean CNI configuration. To <span class="token keyword">do</span> so, you must remove /etc/cni/net.dThe reset process does not reset or clean up iptables rules or IPVS tables.If you wish to reset iptables, you must <span class="token keyword">do</span> so manually by using the <span class="token string">"iptables"</span> command.If your cluster was setup to utilize IPVS, run ipvsadm --clear <span class="token punctuation">(</span>or similar<span class="token punctuation">)</span>to reset your system's IPVS tables.The reset process does not clean your kubeconfig files and you must remove them manually.Please, check the contents of the <span class="token variable">$HOME</span>/.kube/config file.</code></pre><p>清理完好干净:</p><pre class=" language-bash"><code class="language-bash">root@pi-master1:~<span class="token comment" spellcheck="true"># docker ps</span>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMESroot@pi-master1:~<span class="token comment" spellcheck="true"># docker ps --all</span>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> kubeadm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s中配置lnmp环境</title>
      <link href="/eb76ee24/"/>
      <url>/eb76ee24/</url>
      
        <content type="html"><![CDATA[<h1 id="一、配置用于存储的NFS服务"><a href="#一、配置用于存储的NFS服务" class="headerlink" title="一、配置用于存储的NFS服务"></a>一、配置用于存储的NFS服务</h1><h3 id="1-1服务端配置-nfs"><a href="#1-1服务端配置-nfs" class="headerlink" title="1.1服务端配置 nfs"></a>1.1服务端配置 nfs</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#yum安装</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install nfs-utils</span><span class="token comment" spellcheck="true">#编辑 配置文件 （确保目录存在）</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># vim /etc/exports</span>/data/lnmp 10.7.0.0/16(rw<span class="token punctuation">,</span>no_root_squash)<span class="token comment" spellcheck="true">#启动服务</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl start nfs</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl status  nfs</span>● nfs<span class="token punctuation">-</span>server.service <span class="token punctuation">-</span> NFS server and services   <span class="token key atrule">Loaded</span><span class="token punctuation">:</span> loaded (/usr/lib/systemd/system/nfs<span class="token punctuation">-</span>server.service; disabled; vendor preset<span class="token punctuation">:</span> disabled)  <span class="token key atrule">Drop-In</span><span class="token punctuation">:</span> /run/systemd/generator/nfs<span class="token punctuation">-</span>server.service.d           └─order<span class="token punctuation">-</span>with<span class="token punctuation">-</span>mounts.conf   <span class="token key atrule">Active</span><span class="token punctuation">:</span> active (exited) since Sat 2021<span class="token punctuation">-</span>09<span class="token punctuation">-</span>11 17<span class="token punctuation">:</span>32<span class="token punctuation">:</span>16 HKT; 1 weeks 0 days ago Main PID<span class="token punctuation">:</span> 21698 (code=exited<span class="token punctuation">,</span> status=0/SUCCESS)    <span class="token key atrule">Tasks</span><span class="token punctuation">:</span> <span class="token number">0</span>   <span class="token key atrule">Memory</span><span class="token punctuation">:</span> 0B   <span class="token key atrule">CGroup</span><span class="token punctuation">:</span> /system.slice/nfs<span class="token punctuation">-</span>server.service<span class="token comment" spellcheck="true">#showmount确认</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># showmount -e</span>Export list for k8smaster<span class="token punctuation">:</span>/data/lnmp 10.7.0.0/16</code></pre><h3 id="1-2客户端挂载服务"><a href="#1-2客户端挂载服务" class="headerlink" title="1.2客户端挂载服务"></a>1.2客户端挂载服务</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#安装nfs客户端 </span><span class="token punctuation">[</span>root@k8snode ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install nfs-utils.x86_64</span><span class="token comment" spellcheck="true">#showmount -e查看</span><span class="token punctuation">[</span>root@k8snode ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># showmount -e 10.7.48.223</span>Export list for 10.7.48.223<span class="token punctuation">:</span>/data/lnmp 10.7.0.0/16<span class="token comment" spellcheck="true">#创建挂载点挂载</span><span class="token punctuation">[</span>root@k8snode data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /data</span><span class="token punctuation">[</span>root@k8snode data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mount -t nfs 10.7.48.223/data/lnmp /data</span></code></pre><h1 id="二-、配置LNMP环境"><a href="#二-、配置LNMP环境" class="headerlink" title="二 、配置LNMP环境"></a>二 、配置LNMP环境</h1><h3 id="2-1mysql配置清单"><a href="#2-1mysql配置清单" class="headerlink" title="2.1mysql配置清单"></a>2.1mysql配置清单</h3><p>配置前先创建需要的命名空间</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create ns  lnmp</span></code></pre><p>mysql清单配置如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pass              <span class="token key atrule">key</span><span class="token punctuation">:</span> password        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lnmp<span class="token punctuation">-</span>mysql          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lnmp<span class="token punctuation">-</span>mysql        <span class="token key atrule">nfs</span><span class="token punctuation">:</span>         <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token comment" spellcheck="true">#nfs server服务器IP</span>         <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/data/lnmp/mysql"</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql</code></pre><p>这里面mysql 密码是通过环境 变量的方式导入的密码配置参考下面方法</p><pre class=" language-yaml"><code class="language-yaml">kubectl create secret generic mysql<span class="token punctuation">-</span>pass <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>literal=password=123456 <span class="token punctuation">-</span>n lnmp</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#启动</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f mysql.yaml -n lnmp</span>deployment.apps/mysql createdservice/mysql unchanged<span class="token comment" spellcheck="true">#查看pod状态</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po  -n lnmp</span>NAME                        READY   STATUS    RESTARTS   AGEmysql<span class="token punctuation">-</span>6cc8488986<span class="token punctuation">-</span>2wf62      1/1     Running   0          13m<span class="token comment" spellcheck="true">#查看svc地址并确认端口连通性</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get svc  -n lnmp</span>NAME        TYPE        CLUSTER<span class="token punctuation">-</span>IP      EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)        AGEmysql       ClusterIP   10.97.108.119   &lt;none<span class="token punctuation">></span>        3306/TCP       2d20h<span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># telnet  10.97.108.119  3306</span>Trying 10.97.108.119<span class="token punctuation">...</span>Connected to 10.97.108.119.Escape character is '^<span class="token punctuation">]</span>'<span class="token comment" spellcheck="true">#端口可以正常访问mysql的配置就是正常的</span></code></pre><h3 id="2-2-nginx-php配置清单"><a href="#2-2-nginx-php配置清单" class="headerlink" title="2.2 nginx+php配置清单"></a>2.2 nginx+php配置清单</h3><p>清单文件如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com/user<span class="token punctuation">-</span>sum/php        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/www/html/       <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com/user<span class="token punctuation">-</span>sum/alpine<span class="token punctuation">:</span>nginx1.18.0        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/conf.d/       <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data        <span class="token key atrule">nfs</span><span class="token punctuation">:</span>         <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token comment" spellcheck="true">#nfs server服务器IP</span>         <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/data/lnmp/app"</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf         <span class="token key atrule">items</span><span class="token punctuation">:</span>         <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> default.conf           <span class="token key atrule">path</span><span class="token punctuation">:</span> add.conf <span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30010</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php</code></pre><p>nginx服务配置文件</p><pre class=" language-yaml"><code class="language-yaml">server &amp;<span class="token comment" spellcheck="true">#123;</span>    listen       80;    server_name  localhost;    location / &amp;<span class="token comment" spellcheck="true">#123;</span>        root   /usr/share/nginx/html;        index  index.html index.htm;    &amp;<span class="token comment" spellcheck="true">#125;</span>    error_page   500 502 503 504  /50x.html;    location = /50x.html &amp;<span class="token comment" spellcheck="true">#123;</span>        root   /usr/share/nginx/html;    &amp;<span class="token comment" spellcheck="true">#125;</span>    location ~ \.php$ &amp;<span class="token comment" spellcheck="true">#123;</span>        fastcgi_pass   127.0.0.1<span class="token punctuation">:</span>9000;        fastcgi_index  index.php;        fastcgi_param  SCRIPT_FILENAME  /var/www/html/$fastcgi_script_name;        include        fastcgi_params;    &amp;<span class="token comment" spellcheck="true">#125;</span>&amp;<span class="token comment" spellcheck="true">#125;</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建configmap</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create cm ngin-conf --from-file=default.conf -n lnmp</span><span class="token comment" spellcheck="true">#启动</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nginx-php.yaml -n lnmp</span></code></pre><h3 id="2-3测试"><a href="#2-3测试" class="headerlink" title="2.3测试"></a>2.3测试</h3><p>测试 php连通性</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建测试文件测试</span><span class="token punctuation">[</span>root@k8snode app<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test.php </span>&lt;<span class="token punctuation">?</span>php phpinfo(); <span class="token punctuation">?</span><span class="token punctuation">></span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/3394303815.png"></p><p>测试 mysql连通性</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8snode app<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat mysql.php </span>&lt;h1<span class="token punctuation">></span>Test php<span class="token punctuation">-</span>mysql &lt;/h1<span class="token punctuation">></span>&lt;<span class="token punctuation">?</span>phpmysqli_connect('10.97.108.119'<span class="token punctuation">,</span><span class="token string">'root'</span><span class="token punctuation">,</span>'123456') or die('failed');echo 'success';phpinfo();<span class="token punctuation">?</span><span class="token punctuation">></span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/3128067845.png"><br>至此配置完成后面就可以吧自己的项目放到nginx工作目录愉快的玩耍了(๑•̀ㅁ•́ฅ)</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> lnmp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s数据持久化StorageClass</title>
      <link href="/c062e948/"/>
      <url>/c062e948/</url>
      
        <content type="html"><![CDATA[<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a><strong>一、简介</strong></h1><h3 id="1-1什么是StorageClass"><a href="#1-1什么是StorageClass" class="headerlink" title="1.1什么是StorageClass"></a><strong>1.1什么是StorageClass</strong></h3><p>Kubernetes提供了一套可以自动创建PV的机制，即：Dynamic Provisioning。而这个机制的核心在于StorageClass这个API对象。</p><p>StorageClass对象会定义下面两部分内容:</p><ul><li>PV的属性。比如，存储类型，Volume的大小等。</li><li>创建这种PV需要用到的存储插件，即存储制备器。<br>有了这两个信息之后，Kubernetes就能够根据用户提交的PVC，找到一个对应的StorageClass，之后Kubernetes就会调用该StorageClass声明的存储插件，进而创建出需要的PV。</li></ul><p>但是其实使用起来是一件很简单的事情，你只需要根据自己的需求，编写YAML文件即可，然后使用kubectl create命令执行即可。</p><hr><h3 id="1-2StorageClass架构"><a href="#1-2StorageClass架构" class="headerlink" title="1.2StorageClass架构"></a><strong>1.2StorageClass架构</strong></h3><p>在动态资源供应模式下，通过StorageClass和PVC完成资源动态绑定（系统自动生成PV），并供Pod使用的存储管理机制。<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/10/3784991912.png"></p><hr><h1 id="二、创建"><a href="#二、创建" class="headerlink" title="二、创建"></a><strong>二、创建</strong></h1><h3 id="2-1创建StorageClass存储服务"><a href="#2-1创建StorageClass存储服务" class="headerlink" title="2.1创建StorageClass存储服务"></a><strong>2.1创建StorageClass存储服务</strong></h3><p>利用nfs-client-provisioner来生成一个基于nfs的StorageClass，部署配置yaml配置如下，保持为nfs-sc.yaml：</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01  </span><span class="token comment" spellcheck="true"># 此处供应者名字供storageclass调用</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/lnmp/test  <span class="token comment" spellcheck="true"># 填入NFS挂载的目录</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/lnmp/test   <span class="token comment" spellcheck="true"># 填入NFS挂载的目录</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>test<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span><span class="token comment" spellcheck="true"># Supported policies: Delete、 Retain ， default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#部署服务</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nfs-sc.yaml</span><span class="token comment" spellcheck="true">#因为是偏向系统层面的服务所以放到了kube-system命名空间</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n kube-system get pod</span><span class="token comment" spellcheck="true">#查看sc状态</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get sc</span>NAME       PROVISIONER          RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGEnfs<span class="token punctuation">-</span>test   nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>01   Retain          Immediate           false             2m43s</code></pre><hr><h3 id="2-2-基于SC创建PVC测试"><a href="#2-2-基于SC创建PVC测试" class="headerlink" title="2.2 基于SC创建PVC测试"></a><strong>2.2 基于SC创建PVC测试</strong></h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>sc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>test  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Mi</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f pvc-sc.yaml</span>persistentvolumeclaim/pvc<span class="token punctuation">-</span>sc created<span class="token comment" spellcheck="true">#查看pv和pvc</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pv</span>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                                           STORAGECLASS   REASON   AGEpvc<span class="token punctuation">-</span>bc40c73b<span class="token punctuation">-</span>cf4a<span class="token punctuation">-</span>4c2d<span class="token punctuation">-</span>a551<span class="token punctuation">-</span>c2fdbd7e245a   1Mi        RWX            Retain        Bound      default/pvc<span class="token punctuation">-</span>sc                                  nfs<span class="token punctuation">-</span>test             52s<span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc</span>NAME     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEpvc<span class="token punctuation">-</span>sc   Bound    pvc<span class="token punctuation">-</span>bc40c73b<span class="token punctuation">-</span>cf4a<span class="token punctuation">-</span>4c2d<span class="token punctuation">-</span>a551<span class="token punctuation">-</span>c2fdbd7e245a   1Mi        RWX         nfs<span class="token punctuation">-</span>test       2m31s</code></pre><p>使用nginx测试</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 我们这里将nginx容器默认的页面目录挂载</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>files            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"/usr/share/nginx/html"</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>files          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>sc</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nginx.yaml</span>deployment.apps/nginx created<span class="token comment" spellcheck="true">#查看pod是否运行</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po</span>NAME                     READY   STATUS    RESTARTS   AGEnginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m   1/1     Running   0          46s<span class="token comment" spellcheck="true">#进入pod测试是否设置成功</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it nginx-76f5df5fcf-f8x9m -- bash</span>root@nginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m<span class="token punctuation">:</span>/<span class="token comment" spellcheck="true"># echo 'test' > /usr/share/nginx/html/index.html</span>root@nginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m<span class="token punctuation">:</span>/<span class="token comment" spellcheck="true"># exit</span>exit<span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /data/lnmp/test/default-pvc-sc-pvc-bc40c73b-cf4a-4c2d-a551-c2fdbd7e245a/index.html</span>test</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s强制删除Terminating的命名空间</title>
      <link href="/fafe3e8d/"/>
      <url>/fafe3e8d/</url>
      
        <content type="html"><![CDATA[<p>我们在日常的k8s维护中，经常遇到k8s删除命名空间一直处于Terminating的状态 让人抓狂::(怒) 下面总结下强制删除的方法</p><h3 id="1-1-将ns资源保存为json文件"><a href="#1-1-将ns资源保存为json文件" class="headerlink" title="1.1 将ns资源保存为json文件"></a>1.1 将ns资源保存为json文件</h3><pre class=" language-bash"><code class="language-bash">kubectl get ns istio-system -o json <span class="token operator">></span>istis.json</code></pre><h3 id="2-1-删除json文件finalizers字段"><a href="#2-1-删除json文件finalizers字段" class="headerlink" title="2.1 删除json文件finalizers字段"></a>2.1 删除json文件finalizers字段</h3><pre class=" language-json"><code class="language-json"><span class="token property">"spec"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token property">"finalizers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token string">"kubernetes"</span>        <span class="token punctuation">]</span>    &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span></code></pre><h3 id="3-1启动一个kube-proxy"><a href="#3-1启动一个kube-proxy" class="headerlink" title="3.1启动一个kube proxy"></a>3.1启动一个kube proxy</h3><pre class=" language-bash"><code class="language-bash">kubectl proxy --port<span class="token operator">=</span>8081</code></pre><p>在启动一个终端并执行下面命令</p><pre class=" language-bash"><code class="language-bash">curl -k -H <span class="token string">"Content-Type: application/json"</span> -X PUT --data-binary @istis.json http://127.0.0.1:8081/api/v1/namespaces/istio-system/finalize</code></pre><p>再次查看就发现已经正常删除这个ns了::(滑稽)</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s配置ingress-nginx暴露服务</title>
      <link href="/3033822e/"/>
      <url>/3033822e/</url>
      
        <content type="html"><![CDATA[<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><h4 id="1-1-介绍"><a href="#1-1-介绍" class="headerlink" title="1.1 介绍"></a><strong>1.1 介绍</strong></h4><p>在kubernetes中，POD，SVC的IP地址只能集群内部使用，集群外部是无法访问的。</p><p>为了能让外部的应用访问进来，kubernetes提供了如下几种方案：</p><ul><li>NodePort</li><li>LoadBalancer</li><li>Ingress</li></ul><h4 id="1-2-工作原理"><a href="#1-2-工作原理" class="headerlink" title="1.2 工作原理"></a><strong>1.2 工作原理</strong></h4><ul><li>本质：7层http&#x2F;https代理</li><li>ingress controller通过和kubernetes apiserver交互，动态的获取集群中的ingress规则</li><li>解析ingress规则，生成proxy服务的配置，比如nginx配置</li><li>再写到ingress proxy的pod中，如果pod运行的是nginx服务，就生成nginx配置，并放到&#x2F;etc&#x2F;nginx&#x2F;nginx.conf中</li><li>然后reload服务</li></ul><h1 id="二、配置"><a href="#二、配置" class="headerlink" title="二、配置"></a><strong>二、配置</strong></h1><h4 id="2-1-ingress-controller配置"><a href="#2-1-ingress-controller配置" class="headerlink" title="2.1 ingress-controller配置"></a><strong>2.1 ingress-controller配置</strong></h4><blockquote><p>配置如下</p></blockquote><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps      <span class="token punctuation">-</span> endpoints      <span class="token punctuation">-</span> nodes      <span class="token punctuation">-</span> pods      <span class="token punctuation">-</span> secrets      <span class="token punctuation">-</span> namespaces      <span class="token punctuation">-</span> services    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"extensions"</span>      <span class="token punctuation">-</span> <span class="token string">"networking.k8s.io"</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> events    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create      <span class="token punctuation">-</span> patch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"extensions"</span>      <span class="token punctuation">-</span> <span class="token string">"networking.k8s.io"</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses/status    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> update  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"ingress-controller-leader-nginx"</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> update<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>lb  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10254</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>configuration  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">keep-alive</span><span class="token punctuation">:</span> <span class="token string">"75"</span>  <span class="token key atrule">keep-alive-requests</span><span class="token punctuation">:</span> <span class="token string">"100"</span>  <span class="token key atrule">upstream-keepalive-connections</span><span class="token punctuation">:</span> <span class="token string">"10000"</span>  <span class="token key atrule">upstream-keepalive-requests</span><span class="token punctuation">:</span> <span class="token string">"100"</span>  <span class="token key atrule">upstream-keepalive-timeout</span><span class="token punctuation">:</span> <span class="token string">"60"</span>  <span class="token key atrule">allow-backend-server-header</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">enable-underscores-in-headers</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">generate-request-id</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">http-redirect-code</span><span class="token punctuation">:</span> <span class="token string">"301"</span>  <span class="token key atrule">ignore-invalid-headers</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">log-format-upstream</span><span class="token punctuation">:</span> '&amp;<span class="token comment" spellcheck="true">#123;"@timestamp": "$time_iso8601","remote_addr": "$remote_addr","x-forward-for": "$proxy_add_x_forwarded_for","request_id": "$req_id","remote_user": "$remote_user","bytes_sent": $bytes_sent,"request_time": $request_time,"status": $status,"vhost": "$host","request_proto": "$server_protocol","path": "$uri","request_query": "$args","request_length": $request_length,"duration": $request_time,"method": "$request_method","http_referrer": "$http_referer","http_user_agent":  "$http_user_agent","upstream-sever":"$proxy_upstream_name","proxy_alternative_upstream_name":"$proxy_alternative_upstream_name","upstream_addr":"$upstream_addr","upstream_response_length":$upstream_response_length,"upstream_response_time":$upstream_response_time,"upstream_status":$upstream_status&amp;#125;'</span>  <span class="token key atrule">max-worker-connections</span><span class="token punctuation">:</span> <span class="token string">"65536"</span>  <span class="token key atrule">worker-processes</span><span class="token punctuation">:</span> <span class="token string">"2"</span>  <span class="token key atrule">proxy-body-size</span><span class="token punctuation">:</span> 20m  <span class="token key atrule">proxy-connect-timeout</span><span class="token punctuation">:</span> <span class="token string">"10"</span>  <span class="token key atrule">proxy_next_upstream</span><span class="token punctuation">:</span> error timeout http_502  <span class="token key atrule">reuse-port</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">server-tokens</span><span class="token punctuation">:</span> <span class="token string">"false"</span>  <span class="token key atrule">ssl-ciphers</span><span class="token punctuation">:</span> ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>kEDH+AESGCM<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES<span class="token punctuation">:</span>CAMELLIA<span class="token punctuation">:</span>DES<span class="token punctuation">-</span>CBC3<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span><span class="token tag">!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA</span>  <span class="token key atrule">ssl-protocols</span><span class="token punctuation">:</span> TLSv1 TLSv1.1 TLSv1.2  <span class="token key atrule">ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"false"</span>  <span class="token key atrule">worker-cpu-affinity</span><span class="token punctuation">:</span> auto<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>services  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> udp<span class="token punctuation">-</span>services  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">component.version</span><span class="token punctuation">:</span> <span class="token string">"v0.30.0"</span>    <span class="token key atrule">component.revision</span><span class="token punctuation">:</span> <span class="token string">"v1"</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> <span class="token string">"10254"</span>        <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span>        <span class="token key atrule">scheduler.alpha.kubernetes.io/critical-pod</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>node<span class="token punctuation">-</span>critical      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                  <span class="token key atrule">values</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> ingress<span class="token punctuation">-</span>nginx              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname            <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> type                <span class="token key atrule">operator</span><span class="token punctuation">:</span> NotIn                <span class="token key atrule">values</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> virtual<span class="token punctuation">-</span>kubelet      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/acs/aliyun<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">:</span>v0.30.0.2<span class="token punctuation">-</span>9597b3685<span class="token punctuation">-</span>aliyun          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/nginx<span class="token punctuation">-</span>configuration            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tcp<span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/tcp<span class="token punctuation">-</span>services            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>udp<span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/udp<span class="token punctuation">-</span>services            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>publish<span class="token punctuation">-</span>service=$(POD_NAMESPACE)/nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>lb            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>annotations<span class="token punctuation">-</span>prefix=nginx.ingress.kubernetes.io            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enable<span class="token punctuation">-</span>dynamic<span class="token punctuation">-</span>certificates=true            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>v=2          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>            <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>            <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>              <span class="token key atrule">drop</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> ALL              <span class="token key atrule">add</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> NET_BIND_SERVICE            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">101</span>          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime            <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime            <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime          <span class="token key atrule">type</span><span class="token punctuation">:</span> File      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> /bin/sh        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          mount -o remount rw /proc/sys          sysctl -w net.core.somaxconn=65535          sysctl -w net.ipv4.ip_local_port_range="1024 65535"          sysctl -w fs.file-max=1048576          sysctl -w fs.inotify.max_user_instances=16384          sysctl -w fs.inotify.max_user_watches=524288          sysctl -w fs.inotify.max_queued_events=16384</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/acs/busybox<span class="token punctuation">:</span>v1.29.2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>sysctl        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">procMount</span><span class="token punctuation">:</span> Default</code></pre><h4 id="2-2配置用于测试的nginx-pod"><a href="#2-2配置用于测试的nginx-pod" class="headerlink" title="2.2配置用于测试的nginx pod"></a><strong>2.2配置用于测试的nginx pod</strong></h4><blockquote><p>yaml清单如下</p></blockquote><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</code></pre><h4 id="2-3配置ingress"><a href="#2-3配置ingress" class="headerlink" title="2.3配置ingress"></a><strong>2.3配置ingress</strong></h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.boge.com      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">paths</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /          <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix          <span class="token key atrule">backend</span><span class="token punctuation">:</span>            <span class="token key atrule">service</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx              <span class="token key atrule">port</span><span class="token punctuation">:</span>                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><h4 id="2-4-部署"><a href="#2-4-部署" class="headerlink" title="2.4 部署"></a><strong>2.4 部署</strong></h4><blockquote><p>yaml清单中有指定nodeselector 所以需要确认node都有这个标签，pod才会被正常调度</p></blockquote><pre class=" language-yaml"><code class="language-yaml">kubectl label node 10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>48<span class="token punctuation">-</span>223 boge/ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>ready=truekubectl label node 10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>110<span class="token punctuation">-</span>221 boge/ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>ready=true<span class="token comment" spellcheck="true">#标签配置完成即可启动ingress-controller</span>kubectl apply <span class="token punctuation">-</span>f ingress.yaml<span class="token comment" spellcheck="true"># 查看pod是否都正常运行</span>kubectl <span class="token punctuation">-</span>n ingress<span class="token punctuation">-</span>nginx get pod <span class="token punctuation">-</span>o wideNAME                             READY   STATUS    RESTARTS   AGE   IP             NODE           NOMINATED NODE   READINESS GATESnginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>6pgmj   1/1     Running   0          70m   10.7.110.221   10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>110<span class="token punctuation">-</span>221   &lt;none<span class="token punctuation">></span>           &lt;none<span class="token punctuation">></span>nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>gfksc   1/1     Running   0          70m   10.7.48.223    10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>48<span class="token punctuation">-</span>223    &lt;none<span class="token punctuation">></span>           &lt;none<span class="token punctuation">></span><span class="token comment" spellcheck="true">#启动nginx deploy</span>kubectl apply <span class="token punctuation">-</span>f nginx.yaml<span class="token comment" spellcheck="true">#启动ingress</span>kubectl apply <span class="token punctuation">-</span>f nginx<span class="token punctuation">-</span>ingress.yaml<span class="token comment" spellcheck="true">#查看ingress资源</span>kubectl get ingressNAME            CLASS    HOSTS            ADDRESS          PORTS   AGEnginx<span class="token punctuation">-</span>ingress   &lt;none<span class="token punctuation">></span>   nginx.boge.com   10.102.200.157   80      70m</code></pre><h1 id="三、测试"><a href="#三、测试" class="headerlink" title="三、测试"></a><strong>三、测试</strong></h1><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#可以在其他的节点，绑定hosts测试</span>curl nginx.boge.com&lt;<span class="token tag">!DOCTYPE</span> html<span class="token punctuation">></span>&lt;html<span class="token punctuation">></span>&lt;head<span class="token punctuation">></span>&lt;title<span class="token punctuation">></span>Welcome to nginx<span class="token tag">!&lt;/title></span>&lt;style<span class="token punctuation">></span>html &amp;<span class="token comment" spellcheck="true">#123; color-scheme: light dark; &amp;#125;</span>body &amp;<span class="token comment" spellcheck="true">#123; width: 35em; margin: 0 auto;</span><span class="token key atrule">font-family</span><span class="token punctuation">:</span> Tahoma<span class="token punctuation">,</span> Verdana<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans<span class="token punctuation">-</span>serif; &amp;<span class="token comment" spellcheck="true">#125;</span>&lt;/style<span class="token punctuation">></span>&lt;/head<span class="token punctuation">></span>&lt;body<span class="token punctuation">></span>&lt;h1<span class="token punctuation">></span>Welcome to nginx<span class="token tag">!&lt;/h1></span>&lt;p<span class="token punctuation">></span>If you see this page<span class="token punctuation">,</span> the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p<span class="token punctuation">></span>&lt;p<span class="token punctuation">></span>For online documentation and support please refer to&lt;a href="http<span class="token punctuation">:</span>//nginx.org/"<span class="token punctuation">></span>nginx.org&lt;/a<span class="token punctuation">></span>.&lt;br/<span class="token punctuation">></span>Commercial support is available at&lt;a href="http<span class="token punctuation">:</span>//nginx.com/"<span class="token punctuation">></span>nginx.com&lt;/a<span class="token punctuation">></span>.&lt;/p<span class="token punctuation">></span>&lt;p<span class="token punctuation">></span>&lt;em<span class="token punctuation">></span>Thank you for using nginx.&lt;/em<span class="token punctuation">></span>&lt;/p<span class="token punctuation">></span>&lt;/body<span class="token punctuation">></span>&lt;/html<span class="token punctuation">></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s配置4层转发nginx</title>
      <link href="/54433e83/"/>
      <url>/54433e83/</url>
      
        <content type="html"><![CDATA[<h1 id="一-四层转发和七层转发"><a href="#一-四层转发和七层转发" class="headerlink" title="一 四层转发和七层转发"></a>一 四层转发和七层转发</h1><h3 id="1-1四层负载均衡"><a href="#1-1四层负载均衡" class="headerlink" title="1.1四层负载均衡"></a>1.1四层负载均衡</h3><p>四层负载均衡工作在OSI模型的传输层，由于在传输层，只有TCP&#x2F;UDP协议，这两种协议中除了包含源IP、目标IP以外，还包含源端口号及目的端口号。四层负载均衡服务器在接受到客户端请求后，以后通过修改数据包的地址信息（IP+端口号）将流量转发到应用服务器。</p><h3 id="1-2七层负载均衡"><a href="#1-2七层负载均衡" class="headerlink" title="1.2七层负载均衡"></a>1.2七层负载均衡</h3><p>七层负载均衡工作在OSI模型的应用层，应用层协议较多，常用http、radius、dns等。七层负载就可以基于这些协议来负载。这些应用层协议中会包含很多有意义的内容。比如同一个Web服务器的负载均衡，除了根据IP加端口进行负载外，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/1508471474.jpeg"></p><h1 id="二-Nginx4层转发的配置"><a href="#二-Nginx4层转发的配置" class="headerlink" title="二 Nginx4层转发的配置"></a>二 Nginx4层转发的配置</h1><p>生产业务中很多端口只能使用tcp连接 比如mysql ssh 这些端口是无法使用普通的7层代理进行转发的 因此需要我们配置nginx的四层转发</p><h3 id="2-1-Nginx-Dockerfile配置"><a href="#2-1-Nginx-Dockerfile配置" class="headerlink" title="2.1 Nginx Dockerfile配置"></a>2.1 Nginx Dockerfile配置</h3><p>创建Nginx Dockerfile nginx编译需要–with-stream 模块 否则无法配置</p><pre class=" language-bash"><code class="language-bash">FROM centos:7.8.2003MAINTAINER huhuhaheiADD nginx-1.12.0.tar.gz /optRUN yum -y <span class="token function">install</span> gcc gcc-c++ lrzsz pcre-devel zlib-devel openssl openssl-devel <span class="token operator">&amp;&amp;</span> <span class="token function">useradd</span> -M -s /sbin/nologin nginx <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> /opt/nginx-1.12.0/ <span class="token operator">&amp;&amp;</span> ./configure --prefix<span class="token operator">=</span>/usr/local/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_stub_status_module --with-http_ssl_module --with-stream <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><h3 id="2-2-创建转发的配置文件"><a href="#2-2-创建转发的配置文件" class="headerlink" title="2.2 创建转发的配置文件"></a>2.2 创建转发的配置文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    user  root;    worker_processes  auto;    error_log  logs/error.log  info;    pid        logs/nginx.pid;</span>    events &amp;<span class="token comment" spellcheck="true">#123;</span>        use epoll;    &amp;<span class="token comment" spellcheck="true">#125;</span>    stream &amp;<span class="token comment" spellcheck="true">#123;</span>      upstream backend &amp;<span class="token comment" spellcheck="true">#123;</span>          server *****<span class="token punctuation">:</span>8080 max_fails=3 fail_timeout=30s;      &amp;<span class="token comment" spellcheck="true">#125;</span>      server &amp;<span class="token comment" spellcheck="true">#123;</span>          listen 8080;          proxy_connect_timeout 1s;          proxy_timeout 3s;          proxy_pass backend;      &amp;<span class="token comment" spellcheck="true">#125;</span>      log_format proxy '$remote_addr <span class="token punctuation">[</span>$time_local<span class="token punctuation">]</span>'                '$protocol $status $bytes_sent $bytes_received'                '$session_time "$upstream_addr" '                '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';            access_log /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>access.log proxy ;      error_log  /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>error.log warn ;          &amp;<span class="token comment" spellcheck="true">#125;</span>    http &amp;<span class="token comment" spellcheck="true">#123;</span>        include       /usr/local/nginx/conf/mime.types;        default_type  application/octet<span class="token punctuation">-</span>stream;      &amp;<span class="token comment" spellcheck="true">#125;</span></code></pre><h3 id="2-3-创建Nginx-deploy文件"><a href="#2-3-创建Nginx-deploy文件" class="headerlink" title="2.3 创建Nginx deploy文件"></a>2.3 创建Nginx deploy文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf            <span class="token key atrule">items</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx.conf                <span class="token key atrule">path</span><span class="token punctuation">:</span> nginx.conf            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs          <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'harbor.huhuhahei.cn/test/nginx_proxy:v2'</span>          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> ./usr/local/nginx/sbin/nginx          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">'-g daemon off;'</span>            <span class="token punctuation">-</span> <span class="token string">'-c'</span>            <span class="token punctuation">-</span> /opt/nginx.conf          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_proxy<span class="token punctuation">-</span>access<span class="token punctuation">-</span>log              <span class="token key atrule">value</span><span class="token punctuation">:</span> /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>access.log            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_proxy<span class="token punctuation">-</span>error<span class="token punctuation">-</span>log              <span class="token key atrule">value</span><span class="token punctuation">:</span> /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>error.log            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai          <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/logs/          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> proxy      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ingress </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s集群内配置coredns解析</title>
      <link href="/69f5e54a/"/>
      <url>/69f5e54a/</url>
      
        <content type="html"><![CDATA[<p>编辑coredns的confmap</p><pre class=" language-bash"><code class="language-bash">kubectl -n kube-system edit configmaps coredns</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">Corefile</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    .:53 &amp;#123;        errors        health        ready</span><span class="token comment" spellcheck="true"># 添加下面</span>        log        rewrite stop &amp;<span class="token comment" spellcheck="true">#123;</span>          name regex git.boge.com gitlab.gitlab<span class="token punctuation">-</span>ver130806.svc.cluster.local<span class="token comment" spellcheck="true"># 将域名解析到默认的svc域名</span>          answer name gitlab.gitlab<span class="token punctuation">-</span>ver130806.svc.cluster.local git.boge.com<span class="token comment" spellcheck="true"># 反向解析</span>        &amp;<span class="token comment" spellcheck="true">#125;</span><span class="token comment" spellcheck="true"># </span>        kubernetes cluster.local in<span class="token punctuation">-</span>addr.arpa ip6.arpa &amp;<span class="token comment" spellcheck="true">#123;</span>          pods verified          fallthrough in<span class="token punctuation">-</span>addr.arpa ip6.arpa        &amp;<span class="token comment" spellcheck="true">#125;</span>        autopath @kubernetes        prometheus <span class="token punctuation">:</span><span class="token number">9153</span>        forward . /etc/resolv.conf        cache 30        loop        reload        loadbalance    &amp;<span class="token comment" spellcheck="true">#125;</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system  </code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s基础yaml文件</title>
      <link href="/b19e20d5/"/>
      <url>/b19e20d5/</url>
      
        <content type="html"><![CDATA[<h1 id="一、基础Pod配置"><a href="#一、基础Pod配置" class="headerlink" title="一、基础Pod配置"></a>一、基础Pod配置</h1><p><strong>nginx：</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>    <span class="token punctuation">-</span> <span class="token string">"-c"</span>    <span class="token punctuation">-</span> <span class="token string">"sleep 3600"</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd</code></pre><hr><p><strong>存活性探针配置：</strong><br>exec</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>pod  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"touch /tmp/healthy sleep 60; rm -f /tmp/healthy; sleep 3600"</span><span class="token punctuation">]</span>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">exec</span><span class="token punctuation">:</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"-e"</span><span class="token punctuation">,</span><span class="token string">"/tmp/healthy"</span><span class="token punctuation">]</span>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></code></pre><p>HttpGet</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>httpget  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> http        <span class="token key atrule">path</span><span class="token punctuation">:</span> /index.html      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></code></pre><hr><p><strong>就绪性探针：</strong><br>HttpGet</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness<span class="token punctuation">-</span>httpget  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> http        <span class="token key atrule">path</span><span class="token punctuation">:</span> /index.html      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></code></pre><hr><h1 id="二、调度器基础配置"><a href="#二、调度器基础配置" class="headerlink" title="二、调度器基础配置"></a>二、调度器基础配置</h1><p><strong>ReplicaSet</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp      <span class="token key atrule">release</span><span class="token punctuation">:</span> canary  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp        <span class="token key atrule">release</span><span class="token punctuation">:</span> canary        <span class="token key atrule">environment</span><span class="token punctuation">:</span> qa    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>container        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><hr><p><strong>Deployment</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/lnmp_php<span class="token punctuation">:</span>v1        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/html      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/lnmp_nginx<span class="token punctuation">:</span>v2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/html        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/conf/conf.d/        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>logs          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> blog<span class="token punctuation">-</span>nginx      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>logs        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> blog<span class="token punctuation">-</span>logs      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf         <span class="token key atrule">items</span><span class="token punctuation">:</span>         <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx.conf           <span class="token key atrule">path</span><span class="token punctuation">:</span> add.conf</code></pre><p><strong>DaemonSet</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> redis      <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> redis        <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis        <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>4.0<span class="token punctuation">-</span>alpine        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>ds  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat      <span class="token key atrule">release</span><span class="token punctuation">:</span> stable  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat        <span class="token key atrule">release</span><span class="token punctuation">:</span> stable    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/filebeat<span class="token punctuation">:</span>5.6.5<span class="token punctuation">-</span>alpine        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_HOST          <span class="token key atrule">value</span><span class="token punctuation">:</span> redis.default.svc.cluster.local        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_LOG_LEVEL          <span class="token key atrule">value</span><span class="token punctuation">:</span> info</code></pre><p><strong>statefulset</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>statefulset  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> web        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myappdata          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> myappdata    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"ReadWriteOnce"</span> <span class="token punctuation">]</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi</code></pre><h1 id="三、Service配置"><a href="#三、Service配置" class="headerlink" title="三、Service配置"></a>三、Service配置</h1><p><strong>NodePort</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">release</span><span class="token punctuation">:</span> canary  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.99.99.99  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30080</span></code></pre><p><strong>ClusterIP</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redis    <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.97.97.97  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span></code></pre><h1 id="四、持久卷配置"><a href="#四、持久卷配置" class="headerlink" title="四、持久卷配置"></a>四、持久卷配置</h1><p><strong>emptyDir</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/    <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>    <span class="token punctuation">-</span> <span class="token string">"-c"</span>    <span class="token punctuation">-</span> <span class="token string">"while true; do echo $(date) >> /data/index.html; sleep 2;done"</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span></code></pre><p><strong>hostpath</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>hostpath  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/pod/volume1      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate</code></pre><p><strong>nfs</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>nfs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">nfs</span><span class="token punctuation">:</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/test      <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223</code></pre><p><strong>PV</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv001  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0001<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v1    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv002  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0002<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v2    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv003  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0003<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v3    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv004  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0004<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v4    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv005  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0005<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v5    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span></code></pre><p><strong>pvc</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypvc  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">]</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 6Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>nfs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> mypvc</code></pre><h1 id="五、配置中心（configmap）"><a href="#五、配置中心（configmap）" class="headerlink" title="五、配置中心（configmap）"></a>五、配置中心（configmap）</h1><p><strong>通过环境变量注入配置</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>cm<span class="token punctuation">-</span><span class="token number">1</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NGINX_SERVER_PORT      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config          <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx_port    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NGINX_SERVER_NAME      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config          <span class="token key atrule">key</span><span class="token punctuation">:</span> server_name</code></pre><p><strong>通过配置文件注入</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>cm<span class="token punctuation">-</span><span class="token number">2</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginxconf      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/config.d/      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginxconf    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ingress高级配置</title>
      <link href="/893a2674/"/>
      <url>/893a2674/</url>
      
        <content type="html"><![CDATA[<h1 id="一-配置ingress路径重写"><a href="#一-配置ingress路径重写" class="headerlink" title="一.配置ingress路径重写"></a>一.配置ingress路径重写</h1><p>若后端路径是&#x2F;app 默认访问是不带路径的会导致出现404的情况 因此需要配置下路径重写</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/app-root</span><span class="token punctuation">:</span> /nacos  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>discovery<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> port<span class="token punctuation">-</span>forward<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nacos.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nacos          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /nacos</code></pre><hr><h1 id="二-配置ingress白名单访问"><a href="#二-配置ingress白名单访问" class="headerlink" title="二.配置ingress白名单访问"></a>二.配置ingress白名单访问</h1><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/whitelist-source-range</span><span class="token punctuation">:</span> 117.50.34.153  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> prometheus.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">9090</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix</code></pre><p>其他ip访问测试</p><pre class=" language-yaml"><code class="language-yaml">curl <span class="token punctuation">-</span>I prometheus.huhuhahei.cnHTTP/1.1 403 Forbidden<span class="token key atrule">Date</span><span class="token punctuation">:</span> Fri<span class="token punctuation">,</span> 04 Mar 2022 03<span class="token punctuation">:</span>08<span class="token punctuation">:</span>38 GMT<span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> text/html<span class="token key atrule">Content-Length</span><span class="token punctuation">:</span> <span class="token number">146</span><span class="token key atrule">Connection</span><span class="token punctuation">:</span> keep<span class="token punctuation">-</span>alive</code></pre><p>白名单访问测试</p><pre class=" language-bash"><code class="language-bash">curl -I prometheus.huhuhahei.cnHTTP/1.1 405 Method Not AllowedDate: Fri, 04 Mar 2022 03:10:19 GMTContent-Type: text/plain<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf-8Content-Length: 19Connection: keep-aliveAllow: GET, OPTIONSX-Content-Type-Options: nosniff</code></pre><hr><h1 id="三-配置登录验证"><a href="#三-配置登录验证" class="headerlink" title="三. 配置登录验证"></a>三. 配置登录验证</h1><p>首先需要创建密码文件</p><pre class=" language-bash"><code class="language-bash">htpasswd -c auth adminNew password: Re-type new password: Adding password <span class="token keyword">for</span> user admin</code></pre><p>创建secret</p><pre class=" language-bash"><code class="language-bash">kubectl create secret generic  kibana-auth --from-file<span class="token operator">=</span>auth -n logssecret/kibana-auth created</code></pre><p>配置ingress</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-realm</span><span class="token punctuation">:</span> Need to longin    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-secret</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>auth    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-type</span><span class="token punctuation">:</span> basic  <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> kibana.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kibana          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">5601</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /</code></pre><p>登录测试</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/1537476990.png"></p><hr><h1 id="四-配置域名重定向"><a href="#四-配置域名重定向" class="headerlink" title="四.配置域名重定向"></a>四.配置域名重定向</h1><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/permanent-redirect</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.huhuhahei.cn  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> web.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kibana          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">5601</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /</code></pre><p>测试</p><pre class=" language-bash"><code class="language-bash">curl -I web.huhuhahei.cnHTTP/1.1 301 Moved PermanentlyDate: Fri, 04 Mar 2022 03:30:07 GMTContent-Type: text/htmlContent-Length: 162Connection: keep-aliveLocation: https://www.huhuhahei.cn</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ingress-nginx配置 https访问</title>
      <link href="/f619b970/"/>
      <url>/f619b970/</url>
      
        <content type="html"><![CDATA[<h1 id="一、配置证书"><a href="#一、配置证书" class="headerlink" title="一、配置证书"></a>一、配置证书</h1><h3 id="1-1-创建证书secret"><a href="#1-1-创建证书secret" class="headerlink" title="1.1 创建证书secret"></a>1.1 创建证书secret</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster TSL<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create secret  tls huhuhahei  --key=private.key --cert=public.pem  -n  lnmp</span>secret/huhuhahei created</code></pre><h1 id="二-、配置Ingress"><a href="#二-、配置Ingress" class="headerlink" title="二 、配置Ingress"></a>二 、配置Ingress</h1><h3 id="2-1-创建ingress"><a href="#2-1-创建ingress" class="headerlink" title="2.1  创建ingress"></a>2.1  创建ingress</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">tls</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> web.huhuhahei.cn    <span class="token punctuation">-</span> <span class="token key atrule">secretName</span><span class="token punctuation">:</span> huhuhahei  <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> web.huhuhahei.cn      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">paths</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /          <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix          <span class="token key atrule">backend</span><span class="token punctuation">:</span>            <span class="token key atrule">service</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php              <span class="token key atrule">port</span><span class="token punctuation">:</span>                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><h1 id="三-、测试"><a href="#三-、测试" class="headerlink" title="三 、测试"></a>三 、测试</h1><h3 id="3-1浏览器查看证书"><a href="#3-1浏览器查看证书" class="headerlink" title="3.1浏览器查看证书"></a>3.1浏览器查看证书</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/207112106.png"></p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker清理无用镜像及卷组占用的空间</title>
      <link href="/2d895da1/"/>
      <url>/2d895da1/</url>
      
        <content type="html"><![CDATA[<p>生产过程中，总是会遇到服务器磁盘被docker占满的情况<br>比如这样<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/479329848.jpg"><br>也就跑了几个容器，莫名其妙磁盘就没了::(泪)<br>于是上网找方案</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system df </span>TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLEImages          46        46        14.44GB   435MB <span class="token punctuation">(</span>3%<span class="token punctuation">)</span>Containers      121       108       1.359GB   3.478kB <span class="token punctuation">(</span>0%<span class="token punctuation">)</span>Local Volumes   32        2         5.273GB   5.273GB <span class="token punctuation">(</span>100%<span class="token punctuation">)</span></code></pre><p>这个命令可以查看目前我们可以清理的docker缓存，分别为镜像，容器，数据卷</p><p>可以执行下面的命令清理</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system prune -a</span>WARNING<span class="token operator">!</span> This will remove:  - all stopped containers  - all networks not used by at least one container  - all dangling images  - all dangling build cacheAre you sure you want to continue? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span> y</code></pre><p>-a 参数清理的更加彻底 可以将没有容器使用Docker镜像都删掉。注意，这两个命令会把你暂时关闭的容器，以及暂时没有用到的Docker镜像都删掉了……所以使用之前一定要想清楚吶。</p><p>清理后发现空间并没有减少 仔细查看发现是32磁盘 但是只有2个再用 在执行这个命令看看</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker volume ls -qf dangling=true</span>0d322472e941707dc9cdf72ae21647ace2e866d061781c1b3102f026454ff1bb0fd37de5d1b7e9a7b047ef7564dc2f7cff9a430e091afaf8b3bce80d967160795cf16842c76f2b5ac32a37bb4cff4b1b691a1323b59db01adcf0569966746d919cb673514123500c7f6f0c0c777d99813c6489832638c261bfaffb9cea01c30f23e3eb4e2c4ce36b484278c882a4ff77b8b73a0afcb42f9d4fb4bbd9da04b30551a3a18fe7339d97627c894d636a07503244f15f05a945f8ba0e326e53bac4fd61bc3ad6461da6f126e6191509e7964a34c8b9514a2c488462e9b2a465ddd54189c4921a2c858db86534e0924f5f64786dfcb193b95d98bb468eb2b4e401443c146ee0f6e0a42cdfa112a69780637f6a28120fdd56d129e3f697c68a01e6791b176b4fa0c65897c355aafff690bf7a97b419ecf9877b1d518b8574cf86b88971517bd77537b86937ec43778a171b027ed3200f9ba4405740343dc748a366103b540c32012f161afee2abab0ea62f9621612c99392d51bbb266c4e8953f8e3302976d1335e32ea78551c0b8ebf96cd626d5cdae78379a4e3b685672ff30911628····</code></pre><p>可以看到有很多没有挂载的磁盘</p><p>可以使用这个命令清理</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker volume rm $(docker volume ls -qf dangling=true)</span>0d322472e941707dc9cdf72ae21647ace2e866d061781c1b3102f026454ff1bb0fd37de5d1b7e9a7b047ef7564dc2f7cff9a430e091afaf8b3bce80d967160795cf16842c76f2b5ac32a37bb4cff4b1b691a1323b59db01adcf0569966746d919cb673514123500c7f6f0c0c777d99813c6489832638c261bfaffb9cea01c30f23e3eb4e2c4ce36b484278c882a4ff77b8b73a0afcb42f9d4fb4bbd9da04b30551a3a18fe7339d97627c894d636a07503244f15f05a945f8ba0e326e53bac4fd61bc3ad6461da6f126e6191509e7964a34c8b9514a2c488462e9b2a465ddd541</code></pre><p>清理完成再次查看</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system df </span>TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLEImages          46        46        14.44GB   435MB <span class="token punctuation">(</span>3%<span class="token punctuation">)</span>Containers      121       108       1.359GB   3.478kB <span class="token punctuation">(</span>0%<span class="token punctuation">)</span>Local Volumes   2         2         0B        0BBuild Cache     0         0         0B        0B</code></pre><p>当然也可以手动清理无tag的镜像</p><pre class=" language-bash"><code class="language-bash">docker rmi <span class="token punctuation">$(</span>docker images <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"^&lt;none>"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">"&amp;#123;print <span class="token variable">$3</span>&amp;#125;"</span><span class="token punctuation">)</span></code></pre><p>手动清理关闭的容器</p><pre class=" language-bash"><code class="language-bash">docker <span class="token function">ps</span> -a <span class="token operator">|</span> <span class="token function">grep</span> Exit <span class="token operator">|</span> <span class="token function">cut</span> -d <span class="token string">' '</span> -f 1 <span class="token operator">|</span> <span class="token function">xargs</span> docker <span class="token function">rm</span></code></pre><p>空间已经下来了 ::(酷)</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>卡死导致K8sNode节点NotReady</title>
      <link href="/undefined/"/>
      <url>/undefined/</url>
      
        <content type="html"><![CDATA[<p>某天发现测试环境节点忽然变为NotRead 导致服务异常:@(内伤)<br>现象是这样的<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/4059467715.png"><br>describe查看是这样的<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/3548693712.png"><br>初步感觉是节点有问题了 一般出现节点NotReady无非是 节点CPU 内存 磁盘 和网络出问题了<br>结果这样一排查 发现都没问题:@(喷血)<br>下面只能看下kubelet和docker的状态和日志<br>kubelet</p><pre class=" language-bash"><code class="language-bash">systemctl status kubelet● kubelet.service - Kubernetes KubeletLoaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/kubelet.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2022-02-14 11:04:52 CST<span class="token punctuation">;</span> 3min 28s agoDocs: https://github.com/GoogleCloudPlatform/kubernetesProcess: 24722 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/systemd/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24719 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/pids/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24716 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/memory/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24713 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/hugetlb/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24710 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/cpuset/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24707 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/cpuacct/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span></code></pre><p>docker</p><pre class=" language-bash"><code class="language-bash">systemctl status docker● docker.service - Docker Application Container EngineLoaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/docker.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2022-02-14 11:04:42 CST<span class="token punctuation">;</span> 6s agoDocs: http://docs.docker.ioProcess: 24482 ExecStartPost<span class="token operator">=</span>/sbin/iptables -I FORWARD -s 0.0.0.0/0 -j ACCEPT <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Main PID: 24480 <span class="token punctuation">(</span>dockerd<span class="token punctuation">)</span>Tasks: 123Memory: 946.6MCGroup: /system.slice/docker.service</code></pre><p>两个状态都是running状态 只能看下日志信息了<br>查看kubelet日志信息<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/1507988096.png"></p><p>可以看到kubelet连接docker有问题 一直在重启</p><p>只能在看下docker日志信息了</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/3767755695.png"><br>看这个报错在网上搜索没什么发现 于是我好奇docker ps了下 发现一直卡死没有输出<br>这就很奇怪 docker服务正常 不应该没有输出呀 于是又是一番百度找到一个类似的<br><a href="https://www.bianchengquan.com/article/155669.html">https://www.bianchengquan.com/article/155669.html</a><br>发现应该是docker版本过低触发的版本不兼容 临时先kill掉runc进程后重启kubelet和docker就恢复了 后面还是要时常关注服务的版本</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NACOS部署</title>
      <link href="/c2586a0/"/>
      <url>/c2586a0/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h1><h3 id="1-1简介"><a href="#1-1简介" class="headerlink" title="1.1简介"></a>1.1简介</h3><p><a href="https://so.csdn.net/so/search?q=Nacos">Nacos</a>是阿里巴巴开源的一款支持服务注册与发现，配置管理以及微服务管理的组件。用来取代以前常用的注册中心（zookeeper , eureka等等），以及配置中心（spring cloud config等等）。Nacos是集成了注册中心和配置中心的功能，做到了二合一。</p><h1 id="二-Nacos部署"><a href="#二-Nacos部署" class="headerlink" title="二.Nacos部署"></a>二.Nacos部署</h1><h3 id="2-1-创建数据库用户并初始化配置"><a href="#2-1-创建数据库用户并初始化配置" class="headerlink" title="2.1 创建数据库用户并初始化配置"></a>2.1 创建数据库用户并初始化配置</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> nacos <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span><span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> nacos<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> nacos@'<span class="token operator">%</span><span class="token string">' identified by '</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>' <span class="token keyword">with</span> <span class="token keyword">grant</span> <span class="token keyword">option</span><span class="token punctuation">;</span>flush privilages<span class="token punctuation">;</span></code></pre><p>导入nacos初始化sql</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* * Copyright 1999-2018 Alibaba Group Holding Ltd. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * *      http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_use<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>effect<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_schema<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfo_datagrouptenant<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info_aggr   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_aggr<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'datum_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'内容'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfoaggr_datagrouptenantdatum<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'增加租户字段'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info_beta   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_beta<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>beta_ips<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'betaIps'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfobeta_datagrouptenant<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_beta'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info_tag   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_tag<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfotag_datagrouptenanttag<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_tag'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_tags_relation   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_tags_relation<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_type'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>nid<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>nid<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configtagrelation_configidtag<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_tag_relation'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = group_capacity   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>group_capacity<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Group ID，空字符表示整个集群'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>quota<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'配额，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">usage</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'聚合子配置最大个数，，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大变更历史数量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_group_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'集群、各Group容量信息表'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = his_config_info   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>his_config_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>nid<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>op_type<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>nid<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_gmt_create<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_gmt_modified<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_did<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'多租户改造'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = tenant_capacity   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tenant_capacity<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Tenant ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>quota<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'配额，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">usage</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'聚合子配置最大个数'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大变更历史数量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'租户容量信息表'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tenant_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>kp<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'kp'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_desc'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>create_source<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'create_source'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_tenant_info_kptenantid<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>kp<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'tenant_info'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>enabled<span class="token punctuation">`</span> <span class="token keyword">boolean</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>roles<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>idx_user_role<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">ASC</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>permissions<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>resource<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>uk_role_permission<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>role<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>resource<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu'</span><span class="token punctuation">,</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> roles <span class="token punctuation">(</span>username<span class="token punctuation">,</span> role<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'ROLE_ADMIN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="2-2-创建存储"><a href="#2-2-创建存储" class="headerlink" title="2.2 创建存储"></a>2.2 创建存储</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token comment" spellcheck="true"># 此处供应者名字供storageclass调用</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.46.8.18   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/nacos_data  <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/nacos_data   <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>nacos<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos<span class="token comment" spellcheck="true"># Supported policies: Delete、 Retain ， default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><h3 id="2-3-创建mysql配置文件"><a href="#2-3-创建mysql配置文件" class="headerlink" title="2.3 创建mysql配置文件"></a>2.3 创建mysql配置文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">mysql.db.name</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">mysql.host</span><span class="token punctuation">:</span> mysql.blog.svc.cluster.local  <span class="token key atrule">mysql.password</span><span class="token punctuation">:</span> *******  <span class="token key atrule">mysql.port</span><span class="token punctuation">:</span> <span class="token string">"3306"</span>  <span class="token key atrule">mysql.user</span><span class="token punctuation">:</span> nacos<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm</code></pre><h3 id="2-4-创建sts控制器"><a href="#2-4-创建sts控制器" class="headerlink" title="2.4 创建sts控制器"></a>2.4 创建sts控制器</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> OrderedReady  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                <span class="token key atrule">values</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> nacos            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_REPLICAS          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"3"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SERVICE_NAME          <span class="token key atrule">value</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOMAIN_NAME          <span class="token key atrule">value</span><span class="token punctuation">:</span> cluster.local        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>              <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_DB_NAME          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.db.name              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_HOST          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.host              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PORT          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.port              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_USER          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.user              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PASSWORD          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.password              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_SERVER_PORT          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"8848"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_APPLICATION_PORT          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"8848"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PREFER_HOST_MODE          <span class="token key atrule">value</span><span class="token punctuation">:</span> hostname        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMS          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMX          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMN          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>server<span class="token punctuation">:</span>2.0.1        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>port          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512m        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/plugins/peer<span class="token punctuation">-</span>finder          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/data          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> data        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/logs          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logs      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>finder<span class="token punctuation">-</span>plugin<span class="token punctuation">:</span><span class="token number">1.1</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">name</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder<span class="token punctuation">-</span>plugin<span class="token punctuation">-</span>install        <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/plugins/peer<span class="token punctuation">-</span>finder          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1    <span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> data    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ReadWriteOnce      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 50Gi      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>storageclass      <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem</code></pre><h3 id="2-5-创建svc"><a href="#2-5-创建svc" class="headerlink" title="2.5 创建svc"></a>2.5 创建svc</h3><p>nacos_headless.svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">service.alpha.kubernetes.io/tolerate-unready-endpoints</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> server    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</code></pre><p>nacos_svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>service<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span><span class="token number">8</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span><span class="token number">9</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><p>部署完成即可web访问</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/2162338859.png"></p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
