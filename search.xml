<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Curl详解</title>
      <link href="/e7586c26/"/>
      <url>/e7586c26/</url>
      
        <content type="html"><![CDATA[<h1 id="Curl详解"><a href="#Curl详解" class="headerlink" title="Curl详解"></a>Curl详解</h1><h3 id="1-Post请求"><a href="#1-Post请求" class="headerlink" title="1.Post请求"></a>1.Post请求</h3><pre class=" language-bash"><code class="language-bash">curl -H <span class="token string">"Accept: application/json"</span> -H <span class="token string">"Content-type: application/json"</span> -X POST -d <span class="token string">'&amp;#123;"phone": "18000011005","password": "xxxxx", "status":40,"order_no":"1998708","config":&amp;#123;"loading":true&amp;#125;,"data": "123", "appVersion": "1.2.3","CHEN_ZHE_TEST_ONE_TWO_THREE": 1&amp;#125;'</span>  http://192.168.57.80/mjyx-mall-gateway2/web/index.php/auth/login</code></pre><h4 id="设置POST-Header"><a href="#设置POST-Header" class="headerlink" title="设置POST Header"></a>设置POST Header</h4><blockquote><p>-H “Accept: application&#x2F;json” -H “Content-type: application&#x2F;json” -X POST -d </p></blockquote><h4 id="请求参数-parames"><a href="#请求参数-parames" class="headerlink" title="请求参数 parames"></a>请求参数 parames</h4><blockquote><p>‘{“phone”: “18000011005”,”password”: “xxxxx”, “status”:4,”order_no”:”1998708”,”config”:{“loading”:true},”data”: “123”, “appVersion”: “1.2.3”,”CHEN_ZHE_TEST_ONE_TWO_THREE”: 1}’ </p></blockquote><h4 id="请求路径-URL"><a href="#请求路径-URL" class="headerlink" title="请求路径 URL"></a>请求路径 URL</h4><blockquote><p><a href="http://192.168.57.80/gateway/login">http://192.168.57.80/gateway/login</a></p></blockquote><h3 id="2-指定User-Agent"><a href="#2-指定User-Agent" class="headerlink" title="2. 指定User-Agent"></a>2. 指定User-Agent</h3><p><code>-A</code>参数指定客户端的用户代理标头，即<code>User-Agent</code>。curl 的默认用户代理字符串是<code>curl/[version]</code>。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -A <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36'</span> https://google.com</code></pre></blockquote><p>上面命令将<code>User-Agent</code>改成 Chrome 浏览器。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -A <span class="token string">''</span> https://google.com</code></pre></blockquote><p>上面命令会移除<code>User-Agent</code>标头。</p><p>也可以通过<code>-H</code>参数直接指定标头，更改<code>User-Agent</code>。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -H <span class="token string">'User-Agent: php/1.0'</span> https://google.com</code></pre></blockquote><h3 id="3-指定Cookie"><a href="#3-指定Cookie" class="headerlink" title="3.指定Cookie"></a>3.指定Cookie</h3><p><code>-b</code>参数用来向服务器发送 Cookie。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -b <span class="token string">'foo=bar'</span> https://google.com</code></pre></blockquote><p>上面命令会生成一个标头<code>Cookie: foo=bar</code>，向服务器发送一个名为<code>foo</code>、值为<code>bar</code>的 Cookie。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -b <span class="token string">'foo1=bar;foo2=bar2'</span> https://google.com</code></pre></blockquote><p>上面命令发送两个 Cookie。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -b cookies.txt https://www.google.com</code></pre></blockquote><p>上面命令读取本地文件<code>cookies.txt</code>，里面是服务器设置的 Cookie（参见<code>-c</code>参数），将其发送到服务器。</p><p><code>-c</code>参数将服务器设置的 Cookie 写入一个文件。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -c cookies.txt https://www.google.com</code></pre></blockquote><p>上面命令将服务器的 HTTP 回应所设置 Cookie 写入文本文件<code>cookies.txt</code></p><h3 id="4-指定referer"><a href="#4-指定referer" class="headerlink" title="4.指定referer"></a>4.指定referer</h3><p><code>-e</code>参数用来设置 HTTP 的标头<code>Referer</code>，表示请求的来源。</p><blockquote><pre class=" language-bash"><code class="language-bash">curl -e <span class="token string">'https://google.com?q=example'</span> https://www.example.com</code></pre></blockquote><p>上面命令将<code>Referer</code>标头设为<code>https://google.com?q=example</code>。</p><p><code>-H</code>参数可以通过直接添加标头<code>Referer</code>，达到同样效果。</p><blockquote><pre class=" language-bash"><code class="language-bash">curl -H <span class="token string">'Referer: https://google.com?q=example'</span> https://www.example.com</code></pre></blockquote><h3 id="5-指定Header"><a href="#5-指定Header" class="headerlink" title="5.指定Header"></a>5.指定Header</h3><p><code>-H</code>参数添加 HTTP 请求的标头。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -H <span class="token string">'Accept-Language: en-US'</span> https://google.com</code></pre></blockquote><p>上面命令添加 HTTP 标头<code>Accept-Language: en-US</code>。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -H <span class="token string">'Accept-Language: en-US'</span> -H <span class="token string">'Secret-Message: xyzzy'</span> https://google.com</code></pre></blockquote><p>上面命令添加两个 HTTP 标头。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -d <span class="token string">'&amp;#123;"login": "emma", "pass": "123"&amp;#125;'</span> -H <span class="token string">'Content-Type: application/json'</span> https://google.com/login</code></pre></blockquote><p>上面命令添加 HTTP 请求的标头是<code>Content-Type: application/json</code>，然后用<code>-d</code>参数发送 JSON 数据。</p><h3 id="6-指定跳过SSl监测"><a href="#6-指定跳过SSl监测" class="headerlink" title="6.指定跳过SSl监测"></a>6.指定跳过SSl监测</h3><p><code>-k</code>参数指定跳过 SSL 检测。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -k https://www.example.com</code></pre></blockquote><p>上面命令不会检查服务器的 SSL 证书是否正确。</p><h3 id="7-跟随重定向"><a href="#7-跟随重定向" class="headerlink" title="7.跟随重定向"></a>7.跟随重定向</h3><p><code>-L</code>参数会让 HTTP 请求跟随服务器的重定向。curl 默认不跟随重定向。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -L -d <span class="token string">'tweet=hi'</span> https://api.twitter.com/tweet</code></pre></blockquote><h2 id="–limit-rate"><a href="#–limit-rate" class="headerlink" title="–limit-rate"></a>–limit-rate</h2><p><code>--limit-rate</code>用来限制 HTTP 请求和回应的带宽，模拟慢网速的环境。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl --limit-rate 200k https://google.com</code></pre></blockquote><p>上面命令将带宽限制在每秒 200K 字节。</p><h3 id="8-下载文件"><a href="#8-下载文件" class="headerlink" title="8.下载文件"></a>8.下载文件</h3><p><code>-o</code>参数将服务器的回应保存成文件，等同于<code>wget</code>命令。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -o example.html https://www.example.com</code></pre></blockquote><p>上面命令将<code>www.example.com</code>保存成<code>example.html</code>。</p><p><code>-O</code>参数将服务器回应保存成文件，并将 URL 的最后部分当作文件名。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -O https://www.example.com/foo/bar.html</code></pre></blockquote><p>上面命令将服务器回应保存成文件，文件名为<code>bar.html</code>。</p><h3 id="9-静默输出"><a href="#9-静默输出" class="headerlink" title="9.静默输出"></a>9.静默输出</h3><p><code>-s</code>参数将不输出错误和进度信息。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -s https://www.example.com</code></pre></blockquote><p>上面命令一旦发生错误，不会显示错误信息。不发生错误的话，会正常显示运行结果。</p><p>如果想让 curl 不产生任何输出，可以使用下面的命令。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -s -o /dev/null https://google.com</code></pre></blockquote><h3 id="10-用户认证"><a href="#10-用户认证" class="headerlink" title="10.用户认证"></a>10.用户认证</h3><p><code>-u</code>参数用来设置服务器认证的用户名和密码。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -u <span class="token string">'bob:12345'</span> https://google.com/login</code></pre></blockquote><p>上面命令设置用户名为<code>bob</code>，密码为<code>12345</code>，然后将其转为 HTTP 标头<code>Authorization: Basic Ym9iOjEyMzQ1</code>。</p><p>curl 能够识别 URL 里面的用户名和密码。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl https://bob:12345@google.com/login</code></pre></blockquote><p>上面命令能够识别 URL 里面的用户名和密码，将其转为上个例子里面的 HTTP 标头。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -u <span class="token string">'bob'</span> https://google.com/login</code></pre></blockquote><p>上面命令只设置了用户名，执行后，curl 会提示用户输入密码。</p><h3 id="11-显示通信过程"><a href="#11-显示通信过程" class="headerlink" title="11.显示通信过程"></a>11.显示通信过程</h3><p><code>-v</code>参数输出通信的整个过程，用于调试。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -v https://www.example.com</code></pre></blockquote><p><code>--trace</code>参数也可以用于调试，还会输出原始的二进制数据。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl --trace - https://www.example.com</code></pre></blockquote><h3 id="12-指定代理"><a href="#12-指定代理" class="headerlink" title="12.指定代理"></a>12.指定代理</h3><p><code>-x</code>参数指定 HTTP 请求的代理。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -x socks5://james:cats@myproxy.com:8080 https://www.example.com</code></pre></blockquote><p>上面命令指定 HTTP 请求通过<code>myproxy.com:8080</code>的 socks5 代理发出。</p><p>如果没有指定代理协议，默认为 HTTP。</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -x james:cats@myproxy.com:8080 https://www.example.com</code></pre></blockquote><p>上面命令中，请求的代理使用 HTTP 协议。</p><h3 id="13-指定解析"><a href="#13-指定解析" class="headerlink" title="13.指定解析"></a>13.指定解析</h3><p>–resolve 指定解析的ip</p><pre class=" language-bash"><code class="language-bash">curl --resolve html.uu898.com:80:125.254.136.140 http://html.uu898.com/protocol/userProtocol_yinsi.htm</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux pidstat 命令详解</title>
      <link href="/e08f072d/"/>
      <url>/e08f072d/</url>
      
        <content type="html"><![CDATA[<p><strong>1.pidstat 概述</strong><br>pidstat是sysstat工具的一个命令，用于监控全部或指定进程的cpu、内存、线程、设备IO等系统资源的占用情况。pidstat首次运行时显示自系统启动开始的各项统计信息，之后运行pidstat将显示自上次运行该命令以后的统计信息。用户可以通过指定统计的次数和时间来获得所需的统计信息。</p><hr><p><strong>2.pidstat 安装</strong><br>pidstat 是sysstat软件套件的一部分，sysstat包含很多监控linux系统状态的工具，它能够从大多数linux发行版的软件源中获得。</p><p>在Debian&#x2F;Ubuntu系统中可以使用下面的命令来安装:</p><pre class=" language-yaml"><code class="language-yaml">apt<span class="token punctuation">-</span>get install sysstat</code></pre><p>CentOS&#x2F;Fedora&#x2F;RHEL版本的linux中则使用下面的命令：</p><pre class=" language-yaml"><code class="language-yaml">yum install sysstat</code></pre><hr><p><strong>3.pidstat 示例</strong><br>pidstat 的用法：</p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">[</span> 选项 <span class="token punctuation">]</span> <span class="token punctuation">[</span> &lt;时间间隔<span class="token punctuation">></span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> &lt;次数<span class="token punctuation">></span> <span class="token punctuation">]</span></code></pre><p>常用的参数：</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span>u：默认的参数，显示各个进程的cpu使用统计<span class="token punctuation">-</span>r：显示各个进程的内存使用统计<span class="token punctuation">-</span>d：显示各个进程的IO使用情况<span class="token punctuation">-</span>p：指定进程号<span class="token punctuation">-</span>w：显示每个进程的上下文切换情况<span class="token punctuation">-</span>t：显示选择任务的线程的统计信息外的额外信息<span class="token punctuation">-</span>T &amp;<span class="token comment" spellcheck="true">#123; TASK | CHILD | ALL &amp;#125;</span> 这个选项指定了pidstat监控的。TASK表示报告独立的task，CHILD关键字表示报告进程下所有线程统计信息。ALL表示报告独立的task和task下面的所有线程。 注意：task和子线程的全局的统计信息和pidstat选项无关。这些统计信息不会对应到当前的统计间隔，这些统计信息只有在子线程kill或者完成的时候才会被收集。<span class="token punctuation">-</span>V：版本号<span class="token punctuation">-</span>h：在一行上显示了所有活动，这样其他程序可以容易解析。<span class="token punctuation">-</span>I：在SMP环境，表示任务的CPU使用率/内核数量<span class="token punctuation">-</span>l：显示命令名和所有参数</code></pre><hr><p><strong>示例一：查看所有进程的  CPU 使用情况（ -u -p ALL）</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstatpidstat <span class="token punctuation">-</span>u <span class="token punctuation">-</span>p ALL</code></pre><p>pidstat 和 pidstat -u -p ALL 是等效的。 pidstat 默认显示了所有进程的cpu使用率。</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3952490352.png"></p><pre class=" language-yaml"><code class="language-yaml">详细说明PID：进程ID<span class="token directive important">%usr：进程在用户空间占用cpu的百分比</span><span class="token directive important">%system：进程在内核空间占用cpu的百分比</span><span class="token directive important">%guest：进程在虚拟机占用cpu的百分比</span><span class="token directive important">%CPU：进程占用cpu的百分比</span>CPU：处理进程的cpu编号Command：当前进程对应的命令</code></pre><hr><p><strong>示例二:  cpu使用情况统计(-u)</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">-</span>u</code></pre><p>使用-u选项，pidstat将显示各活动进程的cpu使用统计，执行”pidstat -u”与单独执行”pidstat”的效果一样。</p><hr><p><strong>示例三： 内存使用情况统计(-r)</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">-</span>r</code></pre><p>使用-r选项，pidstat将显示各活动进程的内存使用统计：</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/822281650.png"></p><pre class=" language-yaml"><code class="language-yaml">PID：进程标识符Minflt/s<span class="token punctuation">:</span>任务每秒发生的次要错误，不需要从磁盘中加载页Majflt/s<span class="token punctuation">:</span>任务每秒发生的主要错误，需要从磁盘中加载页VSZ：虚拟地址大小，虚拟内存的使用KBRSS：常驻集合大小，非交换区五里内存使用KBCommand：task命令名</code></pre><hr><p><strong>示例四：显示各个进程的IO使用情况（-d）</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">-</span>d</code></pre><p>报告IO统计显示以下信息：<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/920875551.png"></p><pre class=" language-yaml"><code class="language-yaml">PID：进程idkB_rd/s：每秒从磁盘读取的KBkB_wr/s：每秒写入磁盘KBkB_ccwr/s：任务取消的写入磁盘的KB。当任务截断脏的pagecache的时候会发生。COMMAND<span class="token punctuation">:</span>task的命令名</code></pre><hr><p><strong>示例五：显示每个进程的上下文切换情况（-w）</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">-</span>w <span class="token punctuation">-</span>p 2503</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2038492984.png"></p><pre class=" language-yaml"><code class="language-yaml">PID<span class="token punctuation">:</span>进程idCswch/s<span class="token punctuation">:</span>每秒主动任务上下文切换数量Nvcswch/s<span class="token punctuation">:</span>每秒被动任务上下文切换数量Command<span class="token punctuation">:</span>命令名</code></pre><hr><p><strong>示例六：显示选择任务的线程的统计信息外的额外信息 (-t)</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">-</span>t <span class="token punctuation">-</span>p 2503</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3915054774.png"></p><pre class=" language-yaml"><code class="language-yaml">TGID<span class="token punctuation">:</span>主线程的表示TID<span class="token punctuation">:</span>线程id<span class="token directive important">%usr：进程在用户空间占用cpu的百分比</span><span class="token directive important">%system：进程在内核空间占用cpu的百分比</span><span class="token directive important">%guest：进程在虚拟机占用cpu的百分比</span><span class="token directive important">%CPU：进程占用cpu的百分比</span>CPU：处理进程的cpu编号Command：当前进程对应的命令</code></pre><p>参考<a href="https://cloud.tencent.com/developer/article/1130004">https://cloud.tencent.com/developer/article/1130004</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 压测命令stress详解</title>
      <link href="/a32afd17/"/>
      <url>/a32afd17/</url>
      
        <content type="html"><![CDATA[<p><strong>1.命令介绍</strong><br>stress是一个linux系统压力测试工具，顾名思义主要用来进行压力测试。</p><hr><p><strong>2.安装stress</strong></p><pre class=" language-vim"><code class="language-vim">yum <span class="token operator">-</span><span class="token keyword">y</span> install stress</code></pre><hr><p><strong>3.参数详解</strong></p><pre class=" language-vim"><code class="language-vim"><span class="token operator">-</span><span class="token operator">?</span> 显示帮助信息<span class="token operator">-</span>v 显示版本号<span class="token operator">-</span><span class="token keyword">q</span> 不显示运行信息<span class="token operator">-</span><span class="token keyword">n</span> 显示已完成的指令情况<span class="token operator">-</span><span class="token keyword">t</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token builtin">timeout</span> <span class="token keyword">N</span> 指定运行<span class="token keyword">N</span>秒后停止   <span class="token operator">-</span><span class="token operator">-</span>backoff <span class="token keyword">N</span> 等待<span class="token keyword">N</span>微妙后开始运行<span class="token operator">-</span><span class="token keyword">c</span> 产生<span class="token keyword">n</span>个进程 每个进程都反复不停的计算随机数的平方根<span class="token operator">-</span>i 产生<span class="token keyword">n</span>个进程 每个进程反复调用<span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>，<span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>用于将内存上的内容写到硬盘上<span class="token operator">-</span><span class="token keyword">m</span> <span class="token operator">-</span><span class="token operator">-</span>vm <span class="token keyword">n</span> 产生<span class="token keyword">n</span>个进程<span class="token punctuation">,</span>每个进程不断调用内存分配malloc和内存释放free函数   <span class="token operator">-</span><span class="token operator">-</span>vm<span class="token operator">-</span>bytes B 指定malloc时内存的字节数 （默认256MB）   <span class="token operator">-</span><span class="token operator">-</span>vm<span class="token operator">-</span>hang <span class="token keyword">N</span> 指定在free钱的秒数<span class="token operator">-</span><span class="token keyword">d</span> <span class="token operator">-</span><span class="token operator">-</span>hadd <span class="token keyword">n</span> 产生<span class="token keyword">n</span>个执行<span class="token keyword">write</span>和unlink函数的进程   <span class="token operator">-</span>hadd<span class="token operator">-</span>bytes B 指定写的字节数   <span class="token operator">-</span><span class="token operator">-</span>hadd<span class="token operator">-</span>noclean 不unlink</code></pre><blockquote><p>时间单位可以为秒s，分m，小时h，天d，年y，文件大小单位可以为K，M，G</p></blockquote><hr><p><strong>4.命令示范</strong></p><p><strong>（1） 使用-c选项对cpu进行压测</strong></p><pre class=" language-vim"><code class="language-vim">stress <span class="token operator">-</span><span class="token keyword">c</span> <span class="token number">1</span> <span class="token operator">-</span><span class="token keyword">t</span> <span class="token number">100</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3334698846.png"></p><p>使用mpstat和pidstat命令可以看到此时cpu使用率为100%<br>mpstat -P ALL 5<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1584319245.png"></p><hr><p><strong>（2） 使用-i选项对io进行压测</strong></p><blockquote><p>注意sync（）是将内存缓冲区中的数据立即写入磁盘中，对于新建的虚拟机缓冲区内本来就没多少数据，那写到磁盘中的数据也就不多，也就没法产生<br>I&#x2F;O<br>压力。这样大部分就都是系统调用的消耗了，可以看到%iowait只有0.1%，而%system却有98%（%system：表示内核进程所使用cpu的百分比；%iowait表示等待IO所使用cpu的百分比）</p></blockquote><pre class=" language-vim"><code class="language-vim">stress <span class="token operator">-</span>i <span class="token number">1</span> <span class="token operator">-</span><span class="token keyword">t</span> <span class="token number">600</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1310550567.png"></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3950618545.png"></p><p>对于这种情况我们要去测IO，可以使用-d选项。再次查看发现iowait 已经飙上来了</p><pre class=" language-vim"><code class="language-vim">stress <span class="token operator">-</span><span class="token keyword">d</span> <span class="token number">1</span> <span class="token operator">-</span><span class="token operator">-</span>hdd<span class="token operator">-</span>bytes 1024G</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2646425403.png"></p><hr><p><strong>（3） 使用-m选项对内存进行压测</strong></p><pre class=" language-vim"><code class="language-vim">stress <span class="token operator">-</span><span class="token keyword">m</span> <span class="token number">1</span> <span class="token operator">-</span><span class="token operator">-</span>vm<span class="token operator">-</span>bytes 1G <span class="token operator">-</span><span class="token operator">-</span>vm<span class="token operator">-</span>hang <span class="token number">10</span>pidstat <span class="token operator">-</span>C <span class="token string">"stress"</span>  <span class="token operator">-</span><span class="token keyword">p</span> ALL <span class="token operator">-</span><span class="token keyword">r</span> <span class="token number">2</span> <span class="token number">1</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2006229297.png"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux内核优化参数</title>
      <link href="/d9f22803/"/>
      <url>/d9f22803/</url>
      
        <content type="html"><![CDATA[<pre class=" language-vim"><code class="language-vim"><span class="token builtin">fs</span><span class="token operator">.</span><span class="token keyword">file</span><span class="token operator">-</span>max <span class="token operator">=</span> <span class="token number">999999</span>：这个参数表示进程（比如一个worker进程）可以同时打开的最大句柄数，这个参数直线限制最大并发连接数，需根据实际情况配置。net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_max_tw_buckets <span class="token operator">=</span> <span class="token number">6000</span> #这个参数表示操作系统允许TIME_WAIT套接字数量的最大值，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。该参数默认为<span class="token number">180000</span>，过多的TIME_WAIT套接字会使Web服务器变慢。</code></pre><blockquote><p>注：主动关闭连接的服务端会产生TIME_WAIT状态的连接</p></blockquote><pre class=" language-vim"><code class="language-vim">net<span class="token operator">.</span>ipv4<span class="token operator">.</span>ip_local_port_range <span class="token operator">=</span> <span class="token number">1024</span> <span class="token number">65000</span> #允许系统打开的端口范围。net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_tw_recycle <span class="token operator">=</span> <span class="token number">1</span> #启用timewait快速回收。net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_tw_reuse <span class="token operator">=</span> <span class="token number">1</span> #开启重用。允许将TIME<span class="token operator">-</span>WAIT</code></pre><blockquote><p>sockets重新用于新的TCP连接。这对于服务器来说很有意义，因为服务器上总会有大量TIME-WAIT状态的连接。</p></blockquote><pre class=" language-vim"><code class="language-vim">net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_keepalive_time <span class="token operator">=</span> <span class="token number">30</span>：这个参数表示当keepalive启用时，TCP发送keepalive消息的频度。默认是<span class="token number">2</span>小时，若将其设置的小一些，可以更快地清理无效的连接。net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_syncookies <span class="token operator">=</span> <span class="token number">1</span> #开启SYN Cookies，当出现SYN等待队列溢出时，启用cookies来处理。net<span class="token operator">.</span>core<span class="token operator">.</span>somaxconn <span class="token operator">=</span> <span class="token number">40960</span> #web 应用中 listen 函数的 backlog 默认会给我们内核参数的 net<span class="token operator">.</span>core<span class="token operator">.</span>somaxconn 限制到<span class="token number">128</span>，而nginx定义的NGX_LISTEN_BACKLOG 默认为<span class="token number">511</span>，所以有必要调整这个值。</code></pre><blockquote><p>注：对于一个TCP连接，Server与Client需要通过三次握手来建立网络连接.当三次握手成功后,我们可以看到端口的状态由LISTEN转变为ESTABLISHED,接着这条链路上就可以开始传送数据了.每一个处于监听(Listen)状态的端口,都有自己的监听队列.监听队列的长度与如somaxconn参数和使用该端口的程序中listen()函数有关</p><p>somaxconn 参数:定义了系统中每一个端口最大的监听队列的长度,这是个全局的参数,默认值为128，对于一个经常处理新连接的高负载<br>web服务环境来说，默认的 128 太小了。大多数环境这个值建议增加到 1024 或者更多。大的侦听队列对防止拒绝服务 DoS<br>攻击也会有所帮助。</p></blockquote><pre class=" language-vim"><code class="language-vim">net<span class="token operator">.</span>core<span class="token operator">.</span>netdev_max_backlog <span class="token operator">=</span> <span class="token number">262144</span> <span class="token punctuation">:</span>#每个网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目。net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_max_syn_backlog <span class="token operator">=</span> <span class="token number">262144</span><span class="token punctuation">:</span>#这个参数标示TCP三次握手建立阶段接受SYN请求队列的最大长度，默认为<span class="token number">1024</span>，将其设置得大一些可以使出现Nginx繁忙来不及accept新连接的情况时，Linux不至于丢失客户端发起的连接请求。net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_rmem <span class="token operator">=</span> <span class="token number">10240</span>  <span class="token number">87380</span>  <span class="token number">12582912</span><span class="token punctuation">:</span>#这个参数定义了TCP接受缓存（用于TCP接受滑动窗口）的最小值、默认值、最大值。net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_wmem <span class="token operator">=</span> <span class="token number">10240</span> <span class="token number">87380</span> <span class="token number">12582912</span>：这个参数定义了TCP发送缓存（用于TCP发送滑动窗口）的最小值、默认值、最大值。net<span class="token operator">.</span>core<span class="token operator">.</span>rmem_default <span class="token operator">=</span> <span class="token number">6291456</span>：这个参数表示内核套接字接受缓存区默认的大小。net<span class="token operator">.</span>core<span class="token operator">.</span>wmem_default <span class="token operator">=</span> <span class="token number">6291456</span>：这个参数表示内核套接字发送缓存区默认的大小。net<span class="token operator">.</span>core<span class="token operator">.</span>rmem_max <span class="token operator">=</span> <span class="token number">12582912</span>：这个参数表示内核套接字接受缓存区的最大大小。net<span class="token operator">.</span>core<span class="token operator">.</span>wmem_max <span class="token operator">=</span> <span class="token number">12582912</span>：这个参数表示内核套接字发送缓存区的最大大小。net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_syncookies <span class="token operator">=</span> <span class="token number">1</span>：该参数与性能无关，用于解决TCP的SYN攻击。</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用IPerf3对带宽进行测速</title>
      <link href="/9958581e/"/>
      <url>/9958581e/</url>
      
        <content type="html"><![CDATA[<p>1.简介<br>　iperf3是一个网络速度测试工具，支持IPv4与IPv6，支持TCP、UDP、SCTP传输协议，可在Windows、Mac OS X、Linux、FreeBSD等各种平台使用，是一个简单又实用的小工具。因我已配置好yum源，因此执行yum install iperf3即可安装</p><hr><p>2.常用参数</p><pre class=" language-vim"><code class="language-vim"><span class="token operator">-</span>s 服务器模式下运行<span class="token operator">-</span><span class="token keyword">c</span>  在客户端模式下运行，连接到的主机ip。如果Iperf运行在服务器模式，并且用<span class="token operator">-</span><span class="token keyword">c</span>参数指定一个主机，那么Iperf将只接受指定主机的连接。此参数不能工作于UDP模式<span class="token operator">-</span><span class="token keyword">u</span> 使用UDP而不是TCP<span class="token operator">-</span><span class="token keyword">b</span> 目标带宽 以位<span class="token operator">/</span>秒为单位。UDP模式使用的带宽，单位bits<span class="token operator">/</span>sec。此选项与<span class="token operator">-</span><span class="token keyword">u</span>选项相关。默认值是<span class="token number">1</span> Mbit<span class="token operator">/</span>sec<span class="token operator">-</span><span class="token keyword">n</span> 要传输的字节数 M<span class="token operator">-</span><span class="token number">4</span> 使用ipv4<span class="token operator">-</span><span class="token number">6</span> 使用ipv6<span class="token operator">-</span><span class="token keyword">p</span> 指定端口</code></pre><hr><p>3.使用方法</p><pre class=" language-vim"><code class="language-vim">服务器iperf3 <span class="token operator">-</span>s</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/917389051.png"></p><pre class=" language-vim"><code class="language-vim">客户端 iperf3 <span class="token operator">-</span><span class="token keyword">c</span> <span class="token number">172.10</span><span class="token operator">.</span><span class="token number">0.2</span> <span class="token operator">-</span><span class="token keyword">b</span> 50M <span class="token operator">-</span><span class="token keyword">n</span> 200M</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4069506333.png"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 路由配置</title>
      <link href="/1d5f327f/"/>
      <url>/1d5f327f/</url>
      
        <content type="html"><![CDATA[<p>一、命令格式</p><pre class=" language-vim"><code class="language-vim">route <span class="token punctuation">[</span><span class="token operator">-</span><span class="token keyword">f</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token keyword">p</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Command <span class="token punctuation">[</span>Destination<span class="token punctuation">]</span> <span class="token punctuation">[</span>mask Netmask<span class="token punctuation">]</span> <span class="token punctuation">[</span>Gateway<span class="token punctuation">]</span> <span class="token punctuation">[</span>metric Metric<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">if</span> Interface<span class="token punctuation">]</span><span class="token punctuation">]</span></code></pre><hr><p>二、命令参数</p><pre class=" language-vim"><code class="language-vim"><span class="token operator">-</span><span class="token keyword">c</span> 显示更多信息<span class="token operator">-</span><span class="token keyword">n</span> 不解析名字<span class="token operator">-</span>v 显示详细的处理信息<span class="token operator">-</span>F 显示发送信息<span class="token operator">-</span>C 显示路由缓存<span class="token operator">-</span><span class="token keyword">f</span> 清除所有网关入口的路由表。 <span class="token operator">-</span><span class="token keyword">p</span> 与 add 命令一起使用时使路由具有永久性。add<span class="token punctuation">:</span>添加一条新路由。del<span class="token punctuation">:</span>删除一条路由。<span class="token operator">-</span>net<span class="token punctuation">:</span>目标地址是一个网络。<span class="token operator">-</span>host<span class="token punctuation">:</span>目标地址是一个主机。netmask<span class="token punctuation">:</span>当添加一个网络路由时，需要使用网络掩码。gw<span class="token punctuation">:</span>路由数据包通过网关。注意，你指定的网关必须能够达到。metric：设置路由跳数。Command <span class="token punctuation">:</span>指定您想运行的命令 <span class="token punctuation">(</span>Add<span class="token operator">/</span>Change<span class="token operator">/</span>Delete<span class="token operator">/</span><span class="token keyword">Print</span><span class="token punctuation">)</span>。 Destination<span class="token punctuation">:</span> 指定该路由的网络目标。 mask Netmask<span class="token punctuation">:</span> 指定与网络目标相关的网络掩码（也被称作子网掩码）。 Gateway<span class="token punctuation">:</span> 指定网络目标定义的地址集和子网掩码可以到达的前进或下一跃点 IP 地址。 metric Metric<span class="token punctuation">:</span> 为路由指定一个整数成本值标（从 <span class="token number">1</span> 至 <span class="token number">9999</span>），当在路由表<span class="token punctuation">(</span>与转发的数据包目标地址最匹配<span class="token punctuation">)</span>的多个路由中进行选择时可以使用。 <span class="token keyword">if</span> Interface<span class="token punctuation">:</span> 为可以访问目标的接口指定接口索引。若要获得一个接口列表和它们相应的接口索引，使用 route <span class="token keyword">print</span> 命令的显示功能。可以使用十进制或十六进制值进行接口索引。</code></pre><hr><p>三、参考案例</p><p>1.显示路由</p><p>route -n<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/240257448.png"></p><p>注：Flags标志说明：</p><pre class=" language-vim"><code class="language-vim">U Up表示此路由当前为启动状态H Host，表示此网关为一主机G Gateway，表示此网关为一路由器R Reinstate Route，使用动态路由重新初始化的路由D Dynamically<span class="token punctuation">,</span>此路由是动态性地写入M Modified，此路由是由路由守护程序或导向器动态修改<span class="token operator">!</span> 表示此路由当前为关闭状态</code></pre><p>2.添加网关</p><pre class=" language-vim"><code class="language-vim">route add <span class="token operator">-</span>net <span class="token number">224.0</span><span class="token operator">.</span><span class="token number">0.0</span> netmask <span class="token number">240.0</span><span class="token operator">.</span><span class="token number">0.0</span> dev eth0</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1356161704.png"></p><p>3.屏蔽一条路由</p><pre class=" language-vim"><code class="language-vim">route add <span class="token operator">-</span>net <span class="token number">224.0</span><span class="token operator">.</span><span class="token number">0.0</span> netmask <span class="token number">240.0</span><span class="token operator">.</span><span class="token number">0.0</span> reject</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/113431270.png"></p><p>4.删除路由</p><pre class=" language-vim"><code class="language-vim">route del <span class="token operator">-</span>net <span class="token number">224.0</span><span class="token operator">.</span><span class="token number">0.0</span> netmask <span class="token number">240.0</span><span class="token operator">.</span><span class="token number">0.0</span>route del <span class="token operator">-</span>net <span class="token number">224.0</span><span class="token operator">.</span><span class="token number">0.0</span> netmask <span class="token number">240.0</span><span class="token operator">.</span><span class="token number">0.0</span> reject</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3890504857.png"></p><p>5.添加默认网关</p><pre class=" language-vim"><code class="language-vim">route add default gw <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">0.11</span>route del default gw <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">120.240</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/506673885.png"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux通过top查看cpu&amp;内存使用最高的进程</title>
      <link href="/880aa2df/"/>
      <url>/880aa2df/</url>
      
        <content type="html"><![CDATA[<p>前言：今日碰到一个问题，客户反馈每日凌晨3点服务器的内存都会飙升，但是也没有定时任务，晚上也没有数据备份，所以想要通过脚本监控下具体是什么进程导致的。</p><p>我们使用的命令是</p><pre class=" language-vim"><code class="language-vim"><span class="token builtin">top</span> <span class="token operator">-</span><span class="token keyword">bn</span> <span class="token number">1</span> <span class="token operator">-</span>i <span class="token operator">-</span><span class="token keyword">c</span></code></pre><p>输出如下：<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2626793770.png"></p><p>但是输入前面的信息都不是我们需要的所以需要awk筛选下，命令如下</p><pre class=" language-vim"><code class="language-vim"><span class="token builtin">top</span> <span class="token operator">-</span><span class="token keyword">bn</span> <span class="token number">1</span> <span class="token operator">-</span>i <span class="token operator">-</span><span class="token keyword">c</span> |awk <span class="token string">'&amp;#123; if (NR > 6) print &amp;#125;'</span></code></pre><p>输出如下：<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3801311281.png"></p><p>最后通过awk筛选需要的信息即可，命令如下</p><pre class=" language-vim"><code class="language-vim"><span class="token builtin">top</span> <span class="token operator">-</span><span class="token keyword">bn</span> <span class="token number">1</span> <span class="token operator">-</span>i <span class="token operator">-</span><span class="token keyword">c</span> |awk <span class="token string">'&amp;#123; if (NR > 6) print &amp;#125;'</span> |awk <span class="token string">'&amp;#123; if ($9 > 0.1) print $1,$9,$12&amp;#125;'</span></code></pre><p>输出如下：<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1943897181.png"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Iptables 详解</title>
      <link href="/1972c4d3/"/>
      <url>/1972c4d3/</url>
      
        <content type="html"><![CDATA[<p>一、IPtables简介<br>IPtables的表，链结构</p><p>规则链</p><p>规则的作用：对数据包进行过滤处理</p><p>链的作用：容纳各种防火墙规则</p><p>链的分类依据：处理数据包的不同时机</p><p>默认包括5中规则链</p><p>INPUT：处理入站数据包</p><p>OUTPUT：处理出站数据包</p><p>FORWARD：处理转发数据包</p><p>POSTROUTING：在进行路由选择后处理数据包</p><p>PREROUTING：在进行路由选择前处理数据包</p><p>规则表</p><p>表的作用：容纳各种规则链</p><p>表的划分依据：防火墙规则的作用相似</p><p>默认的4个规则表</p><p>raw表：确定是否对数据包进行跟踪</p><p>mangle表：为数据包设置标记</p><p>nat表：修改数据包的源，目标IP地址或端口</p><p>filter表：确定是否放行该数据包（过滤）</p><hr><p>二、参数详解</p><pre class=" language-vim"><code class="language-vim"><span class="token operator">-</span>F 清空规则链 iptables <span class="token operator">-</span>F<span class="token operator">-</span>L 查看规则链 iptables <span class="token operator">-</span>L<span class="token operator">-</span>A 追加规则 iptables <span class="token operator">-</span>A INPUT<span class="token operator">-</span>D 删除规则 iptables <span class="token operator">-</span>D INPUT <span class="token number">1</span><span class="token operator">-</span>R 修改规则 iptable <span class="token operator">-</span>R INPUT <span class="token number">1</span> <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">120.0</span> <span class="token operator">-</span><span class="token keyword">j</span> DROP<span class="token operator">-</span>I 在头部插入规则 iptables <span class="token operator">-</span>I INPUT <span class="token number">1</span> <span class="token operator">-</span><span class="token operator">-</span>dport <span class="token number">80</span> <span class="token operator">-</span><span class="token keyword">j</span> ACCEPT<span class="token operator">-</span>L 查看规则 iptables <span class="token operator">-</span>L INPUT<span class="token operator">-</span><span class="token keyword">N</span> 新的规则 iptables <span class="token operator">-</span><span class="token keyword">N</span> allowed<span class="token operator">-</span>V 查看iptables版本 iptables <span class="token operator">-</span>V<span class="token operator">-</span><span class="token keyword">p</span> 协议（tcp<span class="token operator">/</span>udp<span class="token operator">/</span>icmp） iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span><span class="token keyword">p</span> tcp<span class="token operator">-</span>s 匹配原地址，加<span class="token string">" ! "</span>表示除这个IP外 iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">1.1</span><span class="token operator">-</span><span class="token keyword">d</span> 匹配目的地址 iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span><span class="token keyword">d</span> <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">12.1</span><span class="token operator">-</span><span class="token operator">-</span>sport 匹配源端口流入的数据 iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span><span class="token keyword">p</span> tcp <span class="token operator">-</span><span class="token operator">-</span>sport <span class="token number">22</span><span class="token operator">-</span><span class="token operator">-</span>dport 匹配目的端口流出的数据 iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span><span class="token keyword">p</span> tcp <span class="token operator">-</span><span class="token operator">-</span>dport <span class="token number">22</span><span class="token operator">-</span>i 匹配入口网卡流入的数据 iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span>i eth0<span class="token operator">-</span><span class="token keyword">o</span> 匹配出口网卡流出的数据 iptables <span class="token operator">-</span>A FORWARD <span class="token operator">-</span><span class="token keyword">o</span> eth0<span class="token operator">-</span><span class="token keyword">j</span> 要进行的处理动作<span class="token punctuation">:</span><span class="token function">DROP</span><span class="token punctuation">(</span>丢弃<span class="token punctuation">)</span>，<span class="token function">REJECT</span><span class="token punctuation">(</span>拒绝<span class="token punctuation">)</span>，<span class="token function">ACCEPT</span><span class="token punctuation">(</span>接受<span class="token punctuation">)</span>，<span class="token function">SANT</span><span class="token punctuation">(</span>基于原地址的转换<span class="token punctuation">)</span> iptable <span class="token operator">-</span>A INPUT <span class="token number">1</span> <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">120.0</span> <span class="token operator">-</span><span class="token keyword">j</span> DROP<span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span><span class="token keyword">source</span> 指定SANT转换后的地址 iptables <span class="token operator">-</span><span class="token keyword">t</span> nat <span class="token operator">-</span>A POSTROUTING <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">10.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">-</span><span class="token keyword">j</span> SANT <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span><span class="token keyword">source</span> <span class="token number">172.16</span><span class="token operator">.</span><span class="token number">100.1</span><span class="token operator">-</span><span class="token keyword">t</span> 表名<span class="token punctuation">(</span>raw、mangle、nat、filter<span class="token punctuation">)</span> iptables <span class="token operator">-</span><span class="token keyword">t</span> nat<span class="token operator">-</span><span class="token keyword">m</span> 使用扩展模块来进行数据包的匹配<span class="token punctuation">(</span>multiport<span class="token operator">/</span>tcp<span class="token operator">/</span>state<span class="token operator">/</span>addrtype<span class="token punctuation">)</span> iptables <span class="token operator">-</span><span class="token keyword">m</span> multiport</code></pre><hr><p>三、案例参考</p><p>在链的末尾追加一条规则</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span><span class="token keyword">p</span> tcp <span class="token operator">-</span><span class="token keyword">j</span> ACCEPT</code></pre><p>在链的开头(或指定序号)插入一条规则</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span>I INPUT <span class="token number">2</span> <span class="token operator">-</span><span class="token keyword">p</span> icmp <span class="token operator">-</span><span class="token keyword">j</span> ACCEPT</code></pre><p>删除链内指定序号（或内容）的一条规则</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span>D INPUT <span class="token number">3</span></code></pre><p>清空所有规则</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span>F</code></pre><p>SNAT源地址转换</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span><span class="token keyword">t</span> nat <span class="token operator">-</span>A POSTROUTING <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">-</span><span class="token keyword">o</span> eth0 <span class="token operator">-</span><span class="token keyword">j</span> SNAT <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span><span class="token keyword">source</span> <span class="token number">218.29</span><span class="token operator">.</span><span class="token number">30.31</span></code></pre><p>MASQUERADE 地址伪装</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span><span class="token keyword">t</span> nat <span class="token operator">-</span>A POSTROUTING <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">-</span><span class="token keyword">o</span> eth0 <span class="token operator">-</span><span class="token keyword">j</span> MASQUERADE</code></pre><p>DNAT目标地址转换</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span><span class="token keyword">t</span> nat <span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>i eth0 <span class="token operator">-</span><span class="token keyword">d</span> <span class="token number">218.29</span><span class="token operator">.</span><span class="token number">30.31</span> <span class="token operator">-</span><span class="token keyword">p</span> tcp <span class="token operator">-</span><span class="token operator">-</span>dport <span class="token number">80</span> <span class="token operator">-</span><span class="token keyword">j</span> DNAT <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span>destination <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">1.6</span></code></pre><p>修改端口转换</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span><span class="token keyword">t</span> nat <span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>i eth0 <span class="token operator">-</span><span class="token keyword">d</span> <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">11.11</span> <span class="token operator">-</span><span class="token keyword">p</span> tcp <span class="token operator">-</span><span class="token operator">-</span>dport <span class="token number">2346</span> <span class="token operator">-</span><span class="token keyword">j</span> DNAT <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span>destination <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">1.11</span><span class="token punctuation">:</span><span class="token number">22</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s基础命令</title>
      <link href="/d25065dc/"/>
      <url>/d25065dc/</url>
      
        <content type="html"><![CDATA[<h1 id="一、kubectl-基本命令"><a href="#一、kubectl-基本命令" class="headerlink" title="一、kubectl 基本命令"></a>一、kubectl 基本命令</h1><p><strong>kubectl get</strong><br>查看pod节点详细信息</p><pre class=" language-xml"><code class="language-xml">kubectl get pods -o wide</code></pre><p>查看deploy</p><pre class=" language-yaml"><code class="language-yaml">kubectl get deploy</code></pre><p>查看service</p><pre class=" language-vim"><code class="language-vim">kubectl get svc</code></pre><hr><p><strong>kubectl create</strong></p><p>创建pod并指定deploy</p><pre class=" language-vim"><code class="language-vim">kubectl create deploy nginx <span class="token operator">-</span><span class="token operator">-</span>image<span class="token operator">=</span>nginx</code></pre><p>创建pod并指定deploy 和副本数量为3</p><pre class=" language-vim"><code class="language-vim">kubectl create deployment my<span class="token operator">-</span>dep <span class="token operator">-</span><span class="token operator">-</span>image<span class="token operator">=</span>nginx <span class="token operator">-</span><span class="token operator">-</span>replicas<span class="token operator">=</span><span class="token number">3</span></code></pre><p>创建pod并指定deploy 和副本数量为3 开放80端口</p><pre class=" language-vim"><code class="language-vim">kubectl create deployment my<span class="token operator">-</span>dep <span class="token operator">-</span><span class="token operator">-</span>image<span class="token operator">=</span>nginx <span class="token operator">-</span><span class="token operator">-</span>replicas<span class="token operator">=</span><span class="token number">3</span> <span class="token operator">-</span><span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">80</span></code></pre><p>模拟创建pod，并输出yaml文件到deploy.yaml（不真正创建，只是向apiserver提交请求）</p><pre class=" language-docker"><code class="language-docker">kubectl create deployment my<span class="token punctuation">-</span>dep <span class="token punctuation">-</span><span class="token punctuation">-</span>image=nginx <span class="token punctuation">-</span><span class="token punctuation">-</span>replicas=3 <span class="token punctuation">-</span><span class="token punctuation">-</span>port=80 <span class="token punctuation">-</span><span class="token punctuation">-</span>dry<span class="token punctuation">-</span>run=client <span class="token punctuation">-</span>o yaml <span class="token punctuation">></span> deploy.yaml</code></pre><hr><p><strong>kubectl describe</strong><br>查看pod详细信息</p><pre class=" language-vim"><code class="language-vim">kubectl describe pod nginx<span class="token operator">-</span>6799fc88d8<span class="token operator">-</span>hr8bg</code></pre><p>查看调度器详细信息</p><pre class=" language-vim"><code class="language-vim">kubectl describe deploy nginx</code></pre><p>查看service详细信息</p><pre class=" language-vim"><code class="language-vim">kubectl describe svc nginx</code></pre><hr><p><strong>kubectl logs</strong><br>查看pod日志</p><pre class=" language-vim"><code class="language-vim">kubectl logs nginx<span class="token operator">-</span>6799fc88d8<span class="token operator">-</span>hr8bg</code></pre><p>查看日志并指定ns</p><pre class=" language-vim"><code class="language-vim">kubectl logs nginx<span class="token operator">-</span>6799fc88d8<span class="token operator">-</span>hr8bg <span class="token operator">-</span><span class="token keyword">n</span> default</code></pre><p>动态输出日志</p><pre class=" language-vim"><code class="language-vim">kubectl logs <span class="token operator">-</span><span class="token keyword">f</span> nginx<span class="token operator">-</span>6799fc88d8<span class="token operator">-</span>hr8bg</code></pre><hr><p><strong>kubectl expose</strong><br>映射pod端口</p><pre class=" language-docker"><code class="language-docker">kubectl expose deployment springboot<span class="token punctuation">-</span>k8s <span class="token punctuation">-</span><span class="token punctuation">-</span>port=8080</code></pre><p>映射pod端口，并指定模式为NodePort</p><pre class=" language-vim"><code class="language-vim">kubectl expose deployment springboot<span class="token operator">-</span>k8s<span class="token operator">-</span><span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">8080</span> <span class="token operator">-</span><span class="token operator">-</span>type<span class="token operator">=</span>NodePort</code></pre><hr><p><strong>kubectl scale</strong><br>修改pod的副本数量</p><pre class=" language-docker"><code class="language-docker">kubectl scale <span class="token punctuation">-</span><span class="token punctuation">-</span>replicas=5 deploy myapp</code></pre><hr><p><strong>kubectl set image</strong><br>pod的动态更新</p><pre class=" language-docker"><code class="language-docker">kubectl set image deploy myapp myapp=ikubernetes/myapp<span class="token punctuation">:</span>v2kubectl rollout status deploy myapp</code></pre><hr><p><strong>kubectl rollout</strong><br>pod的动态回滚</p><pre class=" language-docker"><code class="language-docker">kubectl rollout undo deploy myapp</code></pre><hr><p><strong>configmap</strong><br>通过from-literal指定配置项</p><pre class=" language-yaml"><code class="language-yaml">kubectl create configmap nginx<span class="token punctuation">-</span>config <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>literal=nginx_port=80 <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>literal=server_name=myapp.magedu.com</code></pre><p>通过from-file指定配置文件</p><pre class=" language-yaml"><code class="language-yaml">kubectl create configmap nginx_www <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>file=./www.conf</code></pre><hr><p><strong>secret</strong><br>指定mysql的登陆密码（secret默认会进行编码）</p><pre class=" language-yaml"><code class="language-yaml">kubectl creare secret generic mysql<span class="token punctuation">-</span>root<span class="token punctuation">-</span>password <span class="token punctuation">-</span><span class="token punctuation">-</span>frome<span class="token punctuation">-</span>literal=password=123456</code></pre><hr><p><strong>explain</strong><br>查看pod清单列表</p><pre class=" language-yaml"><code class="language-yaml">kubectl explain pod.spec</code></pre><hr><p><strong>autoscale</strong><br>对delpoy进行动态伸缩</p><pre class=" language-yaml"><code class="language-yaml">kubectl autoscale deployment myapp <span class="token punctuation">-</span><span class="token punctuation">-</span>min=1 <span class="token punctuation">-</span><span class="token punctuation">-</span>max=8 <span class="token punctuation">-</span><span class="token punctuation">-</span>cpu<span class="token punctuation">-</span>percent=60</code></pre><p><strong>K8s集群默认svc访问域名</strong></p><pre class=" language-docker"><code class="language-docker"><span class="token comment" spellcheck="true">#示例</span>mysvc.myns.svc.cluster.localbash<span class="token punctuation">-</span>4.2<span class="token comment" spellcheck="true"># curl -vo /dev/null http://wiz.wiz.svc.cluster.local</span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current                                 Dload  Upload   Total   Spent    Left  Speed  0     0    0     0    0     0      0      0 <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span>     0* About to connect() to wiz.wiz.svc.cluster.local port 80 (<span class="token comment" spellcheck="true">#0)</span>*   Trying 10.101.24.253<span class="token punctuation">...</span>* Connected to wiz.wiz.svc.cluster.local (10.101.24.253) port 80 (<span class="token comment" spellcheck="true">#0)</span><span class="token punctuation">></span> GET / HTTP/1.1<span class="token punctuation">></span> User<span class="token punctuation">-</span>Agent<span class="token punctuation">:</span> curl/7.29.0<span class="token punctuation">></span> Host<span class="token punctuation">:</span> wiz.wiz.svc.cluster.local<span class="token punctuation">></span> Accept<span class="token punctuation">:</span> */*<span class="token punctuation">></span>&lt; HTTP/1.1 200 OK&lt; Server<span class="token punctuation">:</span> nginx/1.20.1&lt; Date<span class="token punctuation">:</span> Tue<span class="token punctuation">,</span> 02 Nov 2021 08<span class="token punctuation">:</span>43<span class="token punctuation">:</span>37 GMT&lt; Content<span class="token punctuation">-</span>Type<span class="token punctuation">:</span> text/html; charset=utf<span class="token punctuation">-</span>8&lt; Content<span class="token punctuation">-</span>Length<span class="token punctuation">:</span> 2986&lt; Connection<span class="token punctuation">:</span> keep<span class="token punctuation">-</span>alive&lt; Vary<span class="token punctuation">:</span> Accept<span class="token punctuation">-</span>Encoding&lt; Last<span class="token punctuation">-</span>Modified<span class="token punctuation">:</span> Fri<span class="token punctuation">,</span> 15 Oct 2021 04<span class="token punctuation">:</span>13<span class="token punctuation">:</span>04 GMT&lt; Cache<span class="token punctuation">-</span>Control<span class="token punctuation">:</span> max<span class="token punctuation">-</span>age=0&lt;&amp;<span class="token comment" spellcheck="true">#123; [data not shown]</span>100  2986  100  2986    0     0   374k      0 <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span>  416k* Connection <span class="token comment" spellcheck="true">#0 to host wiz.wiz.svc.cluster.local left intact</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql赋予root超级用户权限</title>
      <link href="/bccd58e4/"/>
      <url>/bccd58e4/</url>
      
        <content type="html"><![CDATA[<pre class=" language-yaml"><code class="language-yaml">update mysql.user set Super_priv='Y' where User='root';flush privileges;</code></pre><blockquote><p>注意权限更新完成需要退出session重新连接，否则还会提供没有权限</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Databases </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Databases </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql常用SQL</title>
      <link href="/ce3ad0fe/"/>
      <url>/ce3ad0fe/</url>
      
        <content type="html"><![CDATA[<h1 id="一、DDL（数据定义语言）"><a href="#一、DDL（数据定义语言）" class="headerlink" title="一、DDL（数据定义语言）"></a>一、DDL（数据定义语言）</h1><h3 id="1-1-Create"><a href="#1-1-Create" class="headerlink" title="1.1 Create"></a>1.1 Create</h3><h2 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#创建数据库huhuhahei</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> huhuhahei<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#创建数据库并指定属性</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> huhuhahei1 <span class="token keyword">charset</span> utf8<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><h2 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#创建student表</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>student<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>sno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'学号'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>sname<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'学生姓名'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>sage<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'学生年龄'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>ssex<span class="token punctuation">`</span> <span class="token keyword">enum</span><span class="token punctuation">(</span><span class="token string">'男'</span><span class="token punctuation">,</span><span class="token string">'女'</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'男'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>sbirthday<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>class<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>sno<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token comment" spellcheck="true">#创建course表</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>course<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>cno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程号'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>cname<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程名称'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程编号'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>cno<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token comment" spellcheck="true">#创建score表</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>score<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>sno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'学号'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>cno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程号'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>mark<span class="token punctuation">`</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'成绩'</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token comment" spellcheck="true">#创建teacher表</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>teacher<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>tno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'教师编号'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tname<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'教师名称'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tage<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'教师年龄'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tsex<span class="token punctuation">`</span> <span class="token keyword">enum</span><span class="token punctuation">(</span><span class="token string">'男'</span><span class="token punctuation">,</span><span class="token string">'女'</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'男'</span> <span class="token keyword">COMMENT</span> <span class="token string">'教师性别'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>prof<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'null'</span> <span class="token keyword">COMMENT</span> <span class="token string">'教师职称'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>depart<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'教师部门'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tno<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8</code></pre><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#查看表结构</span>mysql<span class="token operator">></span> <span class="token keyword">desc</span> score<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+------------+------+-----+---------+-------+</span><span class="token operator">|</span> Field <span class="token operator">|</span> <span class="token keyword">Type</span>       <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> <span class="token keyword">Key</span> <span class="token operator">|</span> <span class="token keyword">Default</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+------------+------+-----+---------+-------+</span><span class="token operator">|</span> sno   <span class="token operator">|</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>    <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span><span class="token operator">|</span> cno   <span class="token operator">|</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>    <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span><span class="token operator">|</span> mark  <span class="token operator">|</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+------------+------+-----+---------+-------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><blockquote><p>数据类型</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#数据类型</span><span class="token keyword">int</span>： 整数 <span class="token operator">-</span><span class="token number">231</span> <span class="token operator">~</span> <span class="token number">231</span> <span class="token operator">-</span><span class="token number">1</span><span class="token keyword">varchar</span>：字符类型 （变长）char： 字符类型 （定长）<span class="token keyword">tinyint</span>： 整数 <span class="token operator">-</span><span class="token number">128</span> <span class="token operator">~</span> <span class="token number">128</span><span class="token keyword">enum</span>： 枚举类型<span class="token keyword">datetime</span>： 时间类型 年月日时分秒<span class="token comment" spellcheck="true">#数据属性</span><span class="token operator">not</span> <span class="token boolean">null</span>： 非空<span class="token keyword">primary</span> <span class="token keyword">key</span>： 主键（唯一且非空的）<span class="token keyword">auto_increment</span>： 自增（此列必须是：<span class="token keyword">primary</span> <span class="token keyword">key</span>或者<span class="token keyword">unique</span> <span class="token keyword">key</span>）<span class="token keyword">unique</span> <span class="token keyword">key</span>： 单独的唯一的<span class="token keyword">default</span>： 默认值unsigned： 非负数<span class="token keyword">comment</span>： 注释</code></pre><h3 id="1-2-Drop"><a href="#1-2-Drop" class="headerlink" title="1.2 Drop"></a>1.2 Drop</h3><h2 id="Database-1"><a href="#Database-1" class="headerlink" title="Database"></a>Database</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#删除数据库</span>mysql<span class="token operator">></span> <span class="token keyword">drop</span> <span class="token keyword">database</span> huhuhahei<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span></code></pre><h2 id="Table-1"><a href="#Table-1" class="headerlink" title="Table"></a>Table</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#删除表</span>mysql<span class="token operator">></span> <span class="token keyword">drop</span> <span class="token keyword">table</span> test<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span></code></pre><h3 id="1-3-Alter"><a href="#1-3-Alter" class="headerlink" title="1.3 Alter"></a>1.3 Alter</h3><h2 id="Database-2"><a href="#Database-2" class="headerlink" title="Database"></a>Database</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#修改数据属性</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">database</span> huhuhahei1 <span class="token keyword">charset</span> gbk<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><h2 id="Table-2"><a href="#Table-2" class="headerlink" title="Table"></a>Table</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#修改表名</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">rename</span> test2<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#添加列</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">add</span> age <span class="token keyword">int</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#添加多个列</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">add</span> test <span class="token keyword">int</span> <span class="token punctuation">,</span><span class="token keyword">add</span> test2 <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#添加列到表首</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">add</span> <span class="token number">aaaa</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">first</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#添加列到指定位置</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">add</span> <span class="token number">bbb</span> <span class="token keyword">int</span> <span class="token keyword">after</span> age<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#删除列</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">drop</span> <span class="token number">bbb</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#修改列的属性</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">modify</span> <span class="token number">aaaa</span> <span class="token keyword">int</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#修改列明和属性</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 change <span class="token number">aaaa</span> <span class="token number">aaa</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#修改数据库字符集</span><span class="token keyword">alter</span> <span class="token keyword">database</span> oldboy <span class="token keyword">CHARACTER SET</span> utf8 <span class="token keyword">collate</span> utf8_general_ci<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#修改表字符集</span><span class="token keyword">alter</span> <span class="token keyword">table</span> t1 <span class="token keyword">CHARACTER SET</span> utf8<span class="token punctuation">;</span></code></pre><hr><h1 id="二、DCL（数据控制语言）"><a href="#二、DCL（数据控制语言）" class="headerlink" title="二、DCL（数据控制语言）"></a>二、DCL（数据控制语言）</h1><h3 id="2-1-Grant"><a href="#2-1-Grant" class="headerlink" title="2.1 Grant"></a>2.1 Grant</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#创建test@127.0.0.1用户并授予所有权限（非超级管理员）</span>mysql<span class="token operator">></span> <span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> test@'<span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token string">' identified by '</span><span class="token number">123</span>'<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#创建用户给授权为超级管理员</span>mysql<span class="token operator">></span> <span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> test@'<span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token string">' identified by '</span><span class="token number">123</span>' <span class="token keyword">with</span> <span class="token keyword">grant</span> <span class="token keyword">option</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#授予用户单列权限</span>mysql<span class="token operator">></span> <span class="token keyword">grant</span> <span class="token keyword">select</span><span class="token punctuation">(</span>sno<span class="token punctuation">)</span> <span class="token keyword">on</span> huhuhahei<span class="token punctuation">.</span>score <span class="token keyword">to</span> test11<span class="token variable">@localhost</span> identified <span class="token keyword">by</span> <span class="token string">'123'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#扩展权限</span>max_queries_per_hour：一个用户每小时可发出的查询数量 max_updates_per_hour：一个用户每小时可发出的更新数量 max_connetions_per_hour：一个用户每小时可连接到服务器的次数 max_user_connetions：允许同时连接数量</code></pre><h3 id="2-2-Revoke"><a href="#2-2-Revoke" class="headerlink" title="2.2 Revoke"></a>2.2 Revoke</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#收回select权限</span>mysql<span class="token operator">></span> <span class="token keyword">revoke</span> <span class="token keyword">select</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token variable">@'127.0.0.1'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="三、DML（数据操作语言）"><a href="#三、DML（数据操作语言）" class="headerlink" title="三、DML（数据操作语言）"></a>三、DML（数据操作语言）</h1><h3 id="3-1-Insert"><a href="#3-1-Insert" class="headerlink" title="3.1 Insert"></a>3.1 Insert</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#插入数据</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> student<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>class<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'徐导'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'曾导'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'李导'</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span></code></pre><h3 id="3-2-Update"><a href="#3-2-Update" class="headerlink" title="3.2 Update"></a>3.2 Update</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#更新数据</span>mysql<span class="token operator">></span> <span class="token keyword">update</span> student <span class="token keyword">set</span> sage<span class="token operator">=</span><span class="token string">'100'</span> <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#全表更新（::(狗头)慎用）</span>mysql<span class="token operator">></span> <span class="token keyword">update</span> student <span class="token keyword">set</span> sage<span class="token operator">=</span><span class="token string">'100'</span> <span class="token keyword">where</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">3</span>  Changed: <span class="token number">2</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span></code></pre><h3 id="3-3-Delete"><a href="#3-3-Delete" class="headerlink" title="3.3 Delete"></a>3.3 Delete</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#删除指定数据</span>mysql<span class="token operator">></span> <span class="token keyword">delete</span> <span class="token keyword">from</span> test2 <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#删除表:@(吐舌)</span>mysql<span class="token operator">></span> <span class="token keyword">truncate</span> <span class="token keyword">table</span> test2<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><blockquote><p>使用update代替delete实现伪删除</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#创建状态列</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student <span class="token keyword">add</span> <span class="token keyword">status</span> <span class="token keyword">enum</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#更新目前所有列</span>mysql<span class="token operator">></span> <span class="token keyword">update</span> student <span class="token keyword">set</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">3</span>  Changed: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#根据状态列查询</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----+--------+------+------+---------------------+-------+--------+</span><span class="token operator">|</span> sno <span class="token operator">|</span> sname  <span class="token operator">|</span> sage <span class="token operator">|</span> ssex <span class="token operator">|</span> sbirthday           <span class="token operator">|</span> class <span class="token operator">|</span> <span class="token keyword">status</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----+--------+------+------+---------------------+-------+--------+</span><span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> 徐导   <span class="token operator">|</span>  <span class="token number">100</span> <span class="token operator">|</span> 男   <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span>:<span class="token number">19</span>:<span class="token number">51</span> <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">2</span> <span class="token operator">|</span> 曾导   <span class="token operator">|</span>  <span class="token number">100</span> <span class="token operator">|</span> 男   <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span>:<span class="token number">19</span>:<span class="token number">51</span> <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span> 李导   <span class="token operator">|</span>  <span class="token number">100</span> <span class="token operator">|</span> 男   <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span>:<span class="token number">19</span>:<span class="token number">51</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----+--------+------+------+---------------------+-------+--------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><h1 id="四、DQL（数据查询语句）"><a href="#四、DQL（数据查询语句）" class="headerlink" title="四、DQL（数据查询语句）"></a>四、DQL（数据查询语句）</h1><h3 id="4-1-Select"><a href="#4-1-Select" class="headerlink" title="4.1 Select"></a>4.1 Select</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#简单查询</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> countrycode<span class="token punctuation">,</span>name <span class="token keyword">from</span> city<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#行级查询</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> countrycode<span class="token punctuation">,</span>name <span class="token keyword">from</span> city <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> countrycode<span class="token punctuation">,</span>name <span class="token keyword">from</span> city <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#条件查询</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>population<span class="token punctuation">,</span>district <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#多条件查询</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>population <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span> <span class="token operator">and</span> district<span class="token operator">=</span><span class="token string">'Shandong'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#模糊查询</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>population <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span> <span class="token operator">and</span> district<span class="token operator">=</span><span class="token string">'heilongjiang'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#排序查询</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>population<span class="token punctuation">,</span>countrycode <span class="token keyword">from</span> city <span class="token keyword">order</span> <span class="token keyword">by</span> countrycode <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#倒序查询</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>population<span class="token punctuation">,</span>countrycode <span class="token keyword">from</span> city <span class="token keyword">order</span> <span class="token keyword">by</span> countrycode <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#范围查询</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> population<span class="token operator">>=</span><span class="token number">1410000</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#OR语句使用</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span> <span class="token operator">or</span> countrycode<span class="token operator">=</span><span class="token string">'USA'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#IN语句使用</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'CHN'</span><span class="token punctuation">,</span><span class="token string">'USA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#select union all 实现or用法</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'USA'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#union 实现in用法</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">union</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'USA'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#查询表的行数</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> world<span class="token punctuation">.</span>city<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#去重</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> countrycode<span class="token punctuation">)</span> <span class="token keyword">from</span> world<span class="token punctuation">.</span>city<span class="token punctuation">;</span></code></pre><h2 id="Select高级用法"><a href="#Select高级用法" class="headerlink" title="Select高级用法"></a>Select高级用法</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#传统连接查询</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> country<span class="token punctuation">.</span>name<span class="token punctuation">,</span>countrylanguage<span class="token punctuation">.</span>language<span class="token punctuation">,</span>city<span class="token punctuation">.</span>name<span class="token punctuation">,</span>country<span class="token punctuation">.</span>population    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">from</span> city<span class="token punctuation">,</span>country<span class="token punctuation">,</span>countrylanguage    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">where</span> countrylanguage<span class="token punctuation">.</span>countrycode<span class="token operator">=</span>country<span class="token punctuation">.</span>code    <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">and</span> city<span class="token punctuation">.</span>countrycode<span class="token operator">=</span>country<span class="token punctuation">.</span>code    <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">and</span> country<span class="token punctuation">.</span>population<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+-------------+-----------+------------+</span><span class="token operator">|</span> name     <span class="token operator">|</span> language    <span class="token operator">|</span> name      <span class="token operator">|</span> population <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+-------------+-----------+------------+</span><span class="token operator">|</span> Pitcairn <span class="token operator">|</span> Pitcairnese <span class="token operator">|</span> Adamstown <span class="token operator">|</span>         <span class="token number">50</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+-------------+-----------+------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#natural join查询（自连接的表中有共同的列名称）</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> city<span class="token punctuation">.</span>name<span class="token punctuation">,</span>countrylanguage<span class="token punctuation">.</span>language<span class="token punctuation">,</span>city<span class="token punctuation">.</span>countrycode    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">from</span> city <span class="token keyword">natural</span> <span class="token keyword">join</span> countrylanguage    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">where</span> population <span class="token operator">=</span> <span class="token number">2352121</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+------------+-------------+</span><span class="token operator">|</span> name      <span class="token operator">|</span> language   <span class="token operator">|</span> countrycode <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+------------+-------------+</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Afrikaans  <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> English    <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Ndebele    <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Northsotho <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Southsotho <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Swazi      <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Tsonga     <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Tswana     <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Venda      <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Xhosa      <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Zulu       <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+------------+-------------+</span><span class="token number">11</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#内连接join on（小表驱动大表）</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> city<span class="token punctuation">.</span>name<span class="token punctuation">,</span>city<span class="token punctuation">.</span>countrycode<span class="token punctuation">,</span>country<span class="token punctuation">.</span>name    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">from</span> city <span class="token keyword">join</span> country    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">on</span> city<span class="token punctuation">.</span>countrycode<span class="token operator">=</span>country<span class="token punctuation">.</span>code    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">where</span> city<span class="token punctuation">.</span>population<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+-------------+----------+</span><span class="token operator">|</span> name      <span class="token operator">|</span> countrycode <span class="token operator">|</span> name     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+-------------+----------+</span><span class="token operator">|</span> Adamstown <span class="token operator">|</span> PCN         <span class="token operator">|</span> Pitcairn <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+-------------+----------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#外连接（左）</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> city<span class="token punctuation">.</span>name<span class="token punctuation">,</span>city<span class="token punctuation">.</span>countrycode<span class="token punctuation">,</span>country<span class="token punctuation">.</span>name    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">from</span> city <span class="token keyword">left</span> <span class="token keyword">join</span> country    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">on</span> city<span class="token punctuation">.</span>countrycode<span class="token operator">=</span>country<span class="token punctuation">.</span>code    <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">and</span> city<span class="token punctuation">.</span>population<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span>外连接（右）mysql<span class="token operator">></span> <span class="token keyword">select</span> city<span class="token punctuation">.</span>name<span class="token punctuation">,</span>city<span class="token punctuation">.</span>countrycode<span class="token punctuation">,</span>country<span class="token punctuation">.</span>name    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">from</span> city <span class="token keyword">right</span> <span class="token keyword">join</span> country    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">on</span> city<span class="token punctuation">.</span>countrycode<span class="token operator">=</span>country<span class="token punctuation">.</span>code    <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">and</span> city<span class="token punctuation">.</span>population<span class="token operator">&lt;</span><span class="token number">100</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span></code></pre><h3 id="4-2-Show"><a href="#4-2-Show" class="headerlink" title="4.2 Show"></a>4.2 Show</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#查看所有数据库</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">7</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#查看数据库创建sql</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">database</span> huhuhahei<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+--------------------------------------------------------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>  <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Database</span>                                                    <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+--------------------------------------------------------------------+</span><span class="token operator">|</span> huhuhahei <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">`</span>huhuhahei<span class="token punctuation">`</span> <span class="token comment" spellcheck="true">/*!40100 DEFAULT CHARACTER SET utf8 */</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+--------------------------------------------------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#查看数据表</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------------+</span><span class="token operator">|</span> Tables_in_world <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------------+</span><span class="token operator">|</span> city            <span class="token operator">|</span><span class="token operator">|</span> country         <span class="token operator">|</span><span class="token operator">|</span> countrylanguage <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#查看创表语句</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> score<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token operator">|</span> <span class="token keyword">Table</span> <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Table</span>                                                                                                                                                                                       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token operator">|</span> score <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>score<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>sno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'学号'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>cno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'课程号'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>mark<span class="token punctuation">`</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'成绩'</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8        <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token comment" spellcheck="true">#查看现有权限</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> grants <span class="token keyword">for</span> test<span class="token variable">@'127.0.0.1'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token operator">|</span> Grants <span class="token keyword">for</span> test<span class="token variable">@127.0.0.1</span>                                                                                                                                                                                                                                                                                                                                                                                                                   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token operator">|</span> <span class="token keyword">GRANT</span> <span class="token keyword">INSERT</span><span class="token punctuation">,</span> <span class="token keyword">UPDATE</span><span class="token punctuation">,</span> <span class="token keyword">DELETE</span><span class="token punctuation">,</span> <span class="token keyword">CREATE</span><span class="token punctuation">,</span> <span class="token keyword">DROP</span><span class="token punctuation">,</span> RELOAD<span class="token punctuation">,</span> <span class="token keyword">SHUTDOWN</span><span class="token punctuation">,</span> PROCESS<span class="token punctuation">,</span> <span class="token keyword">FILE</span><span class="token punctuation">,</span> <span class="token keyword">REFERENCES</span><span class="token punctuation">,</span> <span class="token keyword">INDEX</span><span class="token punctuation">,</span> <span class="token keyword">ALTER</span><span class="token punctuation">,</span> <span class="token keyword">SHOW</span> <span class="token keyword">DATABASES</span><span class="token punctuation">,</span> SUPER<span class="token punctuation">,</span> <span class="token keyword">CREATE</span> <span class="token keyword">TEMPORARY</span> <span class="token keyword">TABLES</span><span class="token punctuation">,</span> <span class="token keyword">LOCK</span> <span class="token keyword">TABLES</span><span class="token punctuation">,</span> <span class="token keyword">EXECUTE</span><span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> SLAVE<span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> CLIENT<span class="token punctuation">,</span> <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span><span class="token punctuation">,</span> <span class="token keyword">SHOW</span> <span class="token keyword">VIEW</span><span class="token punctuation">,</span> <span class="token keyword">CREATE</span> <span class="token keyword">ROUTINE</span><span class="token punctuation">,</span> <span class="token keyword">ALTER</span> <span class="token keyword">ROUTINE</span><span class="token punctuation">,</span> <span class="token keyword">CREATE</span> <span class="token keyword">USER</span><span class="token punctuation">,</span> EVENT<span class="token punctuation">,</span> <span class="token keyword">TRIGGER</span><span class="token punctuation">,</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLESPACE</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'test'</span>@'<span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token string">' IDENTIFIED BY PASSWORD '</span><span class="token operator">*</span>23AE809DDACAF96AF0FD78ED04B6A265E05AA257' <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#查看字符集</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">charset</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#查看校验规则</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> collation<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#查看db最大连接数；</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%connections%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token operator">|</span> Variable_name        <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token operator">|</span> max_connections      <span class="token operator">|</span> <span class="token number">151</span>   <span class="token operator">|</span><span class="token operator">|</span> max_user_connections <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#查看事务隔离级别</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">"%iso%"</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+------------------+</span><span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span>            <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+------------------+</span><span class="token operator">|</span> tx_isolation  <span class="token operator">|</span> <span class="token keyword">READ</span><span class="token operator">-</span><span class="token keyword">UNCOMMITTED</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>转载 <a href="https://blog.driverzeng.com/zenglaoshi/668.html">drz</a></p>]]></content>
      
      
      <categories>
          
          <category> Databases </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Databases </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s部署ELK分析日志</title>
      <link href="/8eafa1a6/"/>
      <url>/8eafa1a6/</url>
      
        <content type="html"><![CDATA[<h1 id="一-环境准备"><a href="#一-环境准备" class="headerlink" title="一.环境准备"></a>一.环境准备</h1><p>创建需要的命名空间并准备持久化的数据目录</p><pre class=" language-bash"><code class="language-bash">kubectl create ns logs<span class="token comment" spellcheck="true">#创建elasticsearch和kibana的持久化目录</span><span class="token function">mkdir</span> kibana elk<span class="token comment" spellcheck="true">#给下全权限</span><span class="token function">chmod</span> -R 777 kibana elk</code></pre><h1 id="二-ELK架构"><a href="#二-ELK架构" class="headerlink" title="二.ELK架构"></a>二.ELK架构</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/2999989110.jpg"></p><h1 id="三-部署elasticsearch"><a href="#三-部署elasticsearch" class="headerlink" title="三.部署elasticsearch"></a>三.部署elasticsearch</h1><h3 id="3-1-部署pvc"><a href="#3-1-部署pvc" class="headerlink" title="3.1 部署pvc"></a>3.1 部署pvc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> elastic<span class="token punctuation">-</span>logs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> elastic<span class="token punctuation">-</span>logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/elk    <span class="token key atrule">server</span><span class="token punctuation">:</span> master<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> elastic<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> elastic<span class="token punctuation">-</span>logs</code></pre><h3 id="3-2-部署deploy控制器"><a href="#3-2-部署deploy控制器" class="headerlink" title="3.2 部署deploy控制器"></a>3.2 部署deploy控制器</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">generation</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging    <span class="token key atrule">version</span><span class="token punctuation">:</span> v1  <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">minReadySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> discovery.type          <span class="token key atrule">value</span><span class="token punctuation">:</span> single<span class="token punctuation">-</span>node        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ES_JAVA_OPTS          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>Xms512m <span class="token punctuation">-</span>Xmx512m        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIMUM_MASTER_NODES          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"1"</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/elasticsearch/elasticsearch<span class="token punctuation">:</span>7.12.0<span class="token punctuation">-</span>amd64        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9200</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9200</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9200</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> db          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9300</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> transport          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">limits</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2Gi          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/elasticsearch/data          <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> /sbin/sysctl        <span class="token punctuation">-</span> <span class="token punctuation">-</span>w        <span class="token punctuation">-</span> vm.max_map_count=262144        <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine<span class="token punctuation">:</span><span class="token number">3.6</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging<span class="token punctuation">-</span>init        <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">procMount</span><span class="token punctuation">:</span> Default        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> elastic<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>pvc</code></pre><h3 id="3-3-部署svc"><a href="#3-3-部署svc" class="headerlink" title="3.3 部署svc"></a>3.3 部署svc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs  <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9200</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch    <span class="token key atrule">selector</span><span class="token punctuation">:</span>     <span class="token key atrule">app</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging</code></pre><h3 id="3-4-交付k8s"><a href="#3-4-交付k8s" class="headerlink" title="3.4 交付k8s"></a>3.4 交付k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f elastic_pvc.yamlkubectl apply <span class="token punctuation">-</span>f elastic_deploy.yamlkubectl apply <span class="token punctuation">-</span>f elastic_svc.yaml</code></pre><h1 id="四-配置logstash"><a href="#四-配置logstash" class="headerlink" title="四.配置logstash"></a>四.配置logstash</h1><h3 id="4-1-配置logstash配置文件"><a href="#4-1-配置logstash配置文件" class="headerlink" title="4.1 配置logstash配置文件"></a>4.1 配置logstash配置文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash<span class="token punctuation">-</span>config  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">logstash.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>    input &amp;<span class="token comment" spellcheck="true">#123;</span>      beats &amp;<span class="token comment" spellcheck="true">#123;</span>        port =<span class="token punctuation">></span> 5016      &amp;<span class="token comment" spellcheck="true">#125;</span>    &amp;<span class="token comment" spellcheck="true">#125;</span>    filter &amp;<span class="token comment" spellcheck="true">#123;</span>      grok &amp;<span class="token comment" spellcheck="true">#123;</span>        match =<span class="token punctuation">></span> &amp;<span class="token comment" spellcheck="true">#123; "message" => "%&amp;#123;IPORHOST:client_ip&amp;#125; - %&amp;#123;USER:auth&amp;#125; \[%&amp;#123;HTTPDATE:timestamp&amp;#125;\] \"(?:%&amp;#123;WORD:verb&amp;#125; %&amp;#123;NOTSPACE:request&amp;#125;(?: HTTP/%&amp;#123;NUMBER:http_version&amp;#125;)?|-)\" (%&amp;#123;IPORHOST:domain&amp;#125;|%&amp;#123;URIHOST:domain&amp;#125;|-) %&amp;#123;NUMBER:response&amp;#125; %&amp;#123;NUMBER:bytes&amp;#125; %&amp;#123;QS:referrer&amp;#125; %&amp;#123;QS:agent&amp;#125; \"(%&amp;#123;WORD:x_forword&amp;#125;|-)\" (%&amp;#123;URIHOST:upstream_host&amp;#125;|-) (%&amp;#123;NUMBER:upstream_response&amp;#125;|-) (%&amp;#123;WORD:upstream_cache_status&amp;#125;|-) %&amp;#123;QS:upstream_content_type&amp;#125; (%&amp;#123;BASE16FLOAT:upstream_response_time&amp;#125;|-) > %&amp;#123;BASE16FLOAT:request_time&amp;#125;" &amp;#125;</span>        match =<span class="token punctuation">></span> &amp;<span class="token comment" spellcheck="true">#123; "message" => "%&amp;#123;IPORHOST:upstream_host&amp;#125; - %&amp;#123;USER:auth&amp;#125; \[%&amp;#123;HTTPDATE:timestamp&amp;#125;\] \"(?:%&amp;#123;WORD:verb&amp;#125; %&amp;#123;NOTSPACE:request&amp;#125;(?: HTTP/%&amp;#123;NUMBER:http_version&amp;#125;)?|-)\" (%&amp;#123;IPORHOST:domain&amp;#125;|%&amp;#123;URIHOST:domain&amp;#125;|-) %&amp;#123;NUMBER:response&amp;#125; %&amp;#123;NUMBER:bytes&amp;#125; %&amp;#123;QS:referrer&amp;#125; %&amp;#123;QS:agent&amp;#125; \"%&amp;#123;IP:client_ip&amp;#125;\" (%&amp;#123;URIHOST:upstream_host&amp;#125;|-) (%&amp;#123;NUMBER:upstream_response&amp;#125;|-) (%&amp;#123;WORD:upstream_cache_status&amp;#125;|-) %&amp;#123;QS:upstream_content_type&amp;#125; (%&amp;#123;BASE16FLOAT:upstream_response_time&amp;#125;|-) > %&amp;#123;BASE16FLOAT:request_time&amp;#125;" &amp;#125;</span>        match =<span class="token punctuation">></span> &amp;<span class="token comment" spellcheck="true">#123; "message" => "%&amp;#123;IPORHOST:client_ip&amp;#125; - (%&amp;#123;USER:auth&amp;#125;|-) \[%&amp;#123;HTTPDATE:timestamp&amp;#125;\] \"%&amp;#123;WORD:verb&amp;#125; %&amp;#123;NOTSPACE:request&amp;#125; HTTP/%&amp;#123;NUMBER:http_version&amp;#125;\" (%&amp;#123;IPORHOST:domain&amp;#125;|%&amp;#123;URIHOST:domain&amp;#125;|-) %&amp;#123;NUMBER:response&amp;#125; %&amp;#123;NUMBER:bytes&amp;#125; %&amp;#123;QS:referrer&amp;#125; %&amp;#123;QS:agent&amp;#125; \"(%&amp;#123;WORD:x_forword&amp;#125;|%&amp;#123;IPORHOST:x_forword&amp;#125;|-)\" (%&amp;#123;IPORHOST:upstream_host&amp;#125;|-)\:%&amp;#123;NUMBER:upstream_port&amp;#125; (%&amp;#123;NUMBER:upstream_response&amp;#125;|-) (%&amp;#123;WORD:upstream_cache_status&amp;#125;|-) \"%&amp;#123;NOTSPACE:upstream_content_type&amp;#125;; charset\=%&amp;#123;NOTSPACE:upstream_content_charset&amp;#125;\" (%&amp;#123;BASE16FLOAT:upstream_response_time&amp;#125;|-) > %&amp;#123;BASE16FLOAT:request_time&amp;#125;" &amp;#125;</span>        match =<span class="token punctuation">></span> &amp;<span class="token comment" spellcheck="true">#123; "message" => "%&amp;#123;IPORHOST:client_ip&amp;#125; - (%&amp;#123;USER:auth&amp;#125;|-) \[%&amp;#123;HTTPDATE:timestamp&amp;#125;\] \"%&amp;#123;WORD:verb&amp;#125; %&amp;#123;NOTSPACE:request&amp;#125; HTTP/%&amp;#123;NUMBER:http_version&amp;#125;\" (%&amp;#123;IPORHOST:domain&amp;#125;|%&amp;#123;URIHOST:domain&amp;#125;|-) %&amp;#123;NUMBER:response&amp;#125; %&amp;#123;NUMBER:bytes&amp;#125; %&amp;#123;QS:referrer&amp;#125; %&amp;#123;QS:agent&amp;#125; \"(%&amp;#123;WORD:x_forword&amp;#125;|%&amp;#123;IPORHOST:x_forword&amp;#125;|-)\" (%&amp;#123;IPORHOST:upstream_host&amp;#125;|-)\:%&amp;#123;NUMBER:upstream_port&amp;#125; (%&amp;#123;NUMBER:upstream_response&amp;#125;|-) (%&amp;#123;WORD:upstream_cache_status&amp;#125;|-) \"%&amp;#123;NOTSPACE:upstream_content_type&amp;#125;;charset\=%&amp;#123;NOTSPACE:upstream_content_charset&amp;#125;\" (%&amp;#123;BASE16FLOAT:upstream_response_time&amp;#125;|-) > %&amp;#123;BASE16FLOAT:request_time&amp;#125;" &amp;#125;</span>        match =<span class="token punctuation">></span> &amp;<span class="token comment" spellcheck="true">#123; "message" => "%&amp;#123;IPORHOST:client_ip&amp;#125; - %&amp;#123;USER:auth&amp;#125; \[%&amp;#123;HTTPDATE:timestamp&amp;#125;\] \"(?:%&amp;#123;WORD:verb&amp;#125; %&amp;#123;NOTSPACE:request&amp;#125;(?: HTTP/%&amp;#123;NUMBER:http_version&amp;#125;)?|-)\" %&amp;#123;NUMBER:response&amp;#125; (?:%&amp;#123;NUMBER:bytes&amp;#125;|-) %&amp;#123;QS:referrer&amp;#125; %&amp;#123;QS:agent&amp;#125;" &amp;#125;</span>        match =<span class="token punctuation">></span> &amp;<span class="token comment" spellcheck="true">#123; "message" => "%&amp;#123;IPORHOST:client_ip&amp;#125; - %&amp;#123;USER:auth&amp;#125; \[%&amp;#123;HTTPDATE:timestamp&amp;#125;\] \"(%&amp;#123;NOTSPACE:request&amp;#125;(?: HTTP/%&amp;#123;NUMBER:http_version&amp;#125;)?|-)\" %&amp;#123;NUMBER:response&amp;#125; (?:%&amp;#123;NUMBER:bytes&amp;#125;|-) %&amp;#123;QS:referrer&amp;#125; %&amp;#123;QS:agent&amp;#125;" &amp;#125;</span>        match =<span class="token punctuation">></span> &amp;<span class="token comment" spellcheck="true">#123; "message" => "%&amp;#123;IPORHOST:client_ip&amp;#125; - %&amp;#123;USER:auth&amp;#125; \[%&amp;#123;HTTPDATE:timestamp&amp;#125;\] \"((%&amp;#123;NOTSPACE:request&amp;#125;(?: HTTP/%&amp;#123;NUMBER:http_version&amp;#125;)?|-)|)\" %&amp;#123;NUMBER:response&amp;#125; (?:%&amp;#123;NUMBER:bytes&amp;#125;|-) %&amp;#123;QS:referrer&amp;#125; %&amp;#123;QS:agent&amp;#125;" &amp;#125;</span>        match =<span class="token punctuation">></span> &amp;<span class="token comment" spellcheck="true">#123; "message" => "%&amp;#123;IPORHOST:client_ip&amp;#125; - %&amp;#123;USER:auth&amp;#125; \[%&amp;#123;HTTPDATE:timestamp&amp;#125;\] %&amp;#123;QS:request&amp;#125; %&amp;#123;NUMBER:response&amp;#125; (?:%&amp;#123;NUMBER:bytes&amp;#125;|-) %&amp;#123;QS:referrer&amp;#125; %&amp;#123;QS:agent&amp;#125;" &amp;#125;</span>      &amp;<span class="token comment" spellcheck="true">#125;</span>      geoip &amp;<span class="token comment" spellcheck="true">#123;</span>        source =<span class="token punctuation">></span> "client_ip"      &amp;<span class="token comment" spellcheck="true">#125;</span>      geoip &amp;<span class="token comment" spellcheck="true">#123;</span>        source =<span class="token punctuation">></span> "x_forword_ip"        target =<span class="token punctuation">></span> "x_forword<span class="token punctuation">-</span>geo"      &amp;<span class="token comment" spellcheck="true">#125;</span>      date &amp;<span class="token comment" spellcheck="true">#123;</span>        match =<span class="token punctuation">></span> <span class="token punctuation">[</span> <span class="token string">"timestamp"</span> <span class="token punctuation">,</span> <span class="token string">"dd/MMM/YYYY:HH:mm:ss Z"</span> <span class="token punctuation">]</span>      &amp;<span class="token comment" spellcheck="true">#125;</span>      useragent &amp;<span class="token comment" spellcheck="true">#123;</span>        source =<span class="token punctuation">></span> "agent"        target =<span class="token punctuation">></span> "ua"      &amp;<span class="token comment" spellcheck="true">#125;</span>      mutate &amp;<span class="token comment" spellcheck="true">#123;</span>        split =<span class="token punctuation">></span> &amp;<span class="token comment" spellcheck="true">#123; "x_forword" => ", "&amp;#125;</span>      &amp;<span class="token comment" spellcheck="true">#125;</span>    &amp;<span class="token comment" spellcheck="true">#125;</span>    output &amp;<span class="token comment" spellcheck="true">#123;</span>      elasticsearch &amp;<span class="token comment" spellcheck="true">#123;</span>        hosts =<span class="token punctuation">></span> <span class="token punctuation">[</span><span class="token string">"10.98.214.187:9200"</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#这里是es的svc ip</span>        manage_template =<span class="token punctuation">></span> false        index =<span class="token punctuation">></span> "public<span class="token punctuation">-</span>ngx<span class="token punctuation">-</span>alias"      &amp;<span class="token comment" spellcheck="true">#125;</span>    &amp;<span class="token comment" spellcheck="true">#125;</span></code></pre><h3 id="4-2-配置deploy"><a href="#4-2-配置deploy" class="headerlink" title="4.2 配置deploy"></a>4.2 配置deploy</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>     <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>       <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>         <span class="token key atrule">app</span><span class="token punctuation">:</span> logstash        <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/logstash/logstash<span class="token punctuation">:</span>7.12.0        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5044</span>          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9600</span>          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash<span class="token punctuation">-</span>config          <span class="token comment" spellcheck="true">#mountPath: /usr/share/logstash/logstash-simple.conf</span>          <span class="token comment" spellcheck="true">#mountPath: /usr/share/logstash/config/logstash-sample.conf</span>          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/logstash/pipeline/logstash.conf          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logstash.conf        <span class="token comment" spellcheck="true">#ports:</span>        <span class="token comment" spellcheck="true">#  - containerPort: 80</span>        <span class="token comment" spellcheck="true">#    protocol: TCP</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash<span class="token punctuation">-</span>config        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>          <span class="token comment" spellcheck="true">#defaultMode: 0644</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash<span class="token punctuation">-</span>config</code></pre><h3 id="4-3-配置svc"><a href="#4-3-配置svc" class="headerlink" title="4.3 配置svc"></a>4.3 配置svc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs  <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> logstash<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5016</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash  <span class="token key atrule">selector</span><span class="token punctuation">:</span>     <span class="token key atrule">app</span><span class="token punctuation">:</span> logstash</code></pre><h3 id="4-4-交付k8s"><a href="#4-4-交付k8s" class="headerlink" title="4.4 交付k8s"></a>4.4 交付k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f logstash.yamlkubectl apply <span class="token punctuation">-</span>f logstash_deploy.yamlkubectl apply <span class="token punctuation">-</span>f logstash_svc.yaml</code></pre><h1 id="五-配置kinana"><a href="#五-配置kinana" class="headerlink" title="五.配置kinana"></a>五.配置kinana</h1><h3 id="5-1-pvc文件"><a href="#5-1-pvc文件" class="headerlink" title="5.1 pvc文件"></a>5.1 pvc文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>logs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/kibana    <span class="token key atrule">server</span><span class="token punctuation">:</span> master<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>logs</code></pre><h3 id="5-2-deploy文件"><a href="#5-2-deploy文件" class="headerlink" title="5.2 deploy文件"></a>5.2 deploy文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> kibana        <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/kibana/kibana<span class="token punctuation">:</span>7.12.0        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5601</span>          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5601</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5601</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ELASTICSEARCH_URL          <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//elasticsearch.logs.svc.cluster.local<span class="token punctuation">:</span><span class="token number">9200</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/kibana/data          <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>pvc</code></pre><h3 id="5-3-svc配置"><a href="#5-3-svc配置" class="headerlink" title="5.3 svc配置"></a>5.3 svc配置</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>   <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5601</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">5601</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>     <span class="token key atrule">app</span><span class="token punctuation">:</span> kibana</code></pre><h3 id="5-4-交付k8s"><a href="#5-4-交付k8s" class="headerlink" title="5.4 交付k8s"></a>5.4 交付k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f kibana_pvc.yamlkubectl apply <span class="token punctuation">-</span>f kibana_deploy.yamlkubectl apply <span class="token punctuation">-</span>f kibana_svc.yaml</code></pre><h1 id="六-配置filebeat"><a href="#六-配置filebeat" class="headerlink" title="六.配置filebeat"></a>六.配置filebeat</h1><h3 id="6-1-deploy文件"><a href="#6-1-deploy文件" class="headerlink" title="6.1 deploy文件"></a>6.1 deploy文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/filebeat<span class="token punctuation">:</span>6.5.1        <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>config          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/filebeat.yml          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> filebeat.yml        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>logs          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/filebeat/logs        <span class="token comment" spellcheck="true">#使用配置文件启动filebeat</span>        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"/etc/filebeat.yml"</span><span class="token punctuation">,</span>          <span class="token string">"-e"</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi          <span class="token key atrule">limits</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 500Mi        <span class="token comment" spellcheck="true">#设置访问容器的用户ID本次设置为0即访问容器为root用户</span>        <span class="token comment" spellcheck="true">#不设置默认容器用户为filebeat则会出现访问日志文件没权限的问题</span>        <span class="token comment" spellcheck="true">#设置该参数使用kubelet exec登录容器的用户为root用户</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">0</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>config        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>config      <span class="token comment" spellcheck="true">#这里挂载的是nginx的日志目录</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>logs        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/logs/blog<span class="token punctuation">-</span>blog<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>51d8fa72<span class="token punctuation">-</span>8d0b<span class="token punctuation">-</span>4bf9<span class="token punctuation">-</span>9271<span class="token punctuation">-</span>2fc7ddc6636d</code></pre><h3 id="6-2-配置文件"><a href="#6-2-配置文件" class="headerlink" title="6.2 配置文件"></a>6.2 配置文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">paths</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> /data/logs  <span class="token key atrule">fields</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> k8s    <span class="token key atrule">type</span><span class="token punctuation">:</span> module<span class="token key atrule">filebeat.config.modules</span><span class="token punctuation">:</span>  <span class="token key atrule">path</span><span class="token punctuation">:</span> $&amp;<span class="token comment" spellcheck="true">#123;path.config&amp;#125;/modules.d/*.yml</span>  <span class="token key atrule">reload.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token key atrule">setup.kibana</span><span class="token punctuation">:</span><span class="token key atrule">output.logstash</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.97.125.215:5016"</span><span class="token punctuation">]</span><span class="token key atrule">processors</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">add_host_metadata</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">add_cloud_metadata</span><span class="token punctuation">:</span></code></pre><h3 id="6-3-交付k8s"><a href="#6-3-交付k8s" class="headerlink" title="6.3 交付k8s"></a>6.3 交付k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl create cm filebeat<span class="token punctuation">-</span>config <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>file=filebeat.yml <span class="token punctuation">-</span>n logskubectl apply <span class="token punctuation">-</span>f filebeat_deploy.yaml</code></pre><h1 id="七-访问kibana配置索引"><a href="#七-访问kibana配置索引" class="headerlink" title="七.访问kibana配置索引"></a>七.访问kibana配置索引</h1><h3 id="7-1-查看svc确认kibana的端口"><a href="#7-1-查看svc确认kibana的端口" class="headerlink" title="7.1 查看svc确认kibana的端口"></a>7.1 查看svc确认kibana的端口</h3><pre class=" language-yaml"><code class="language-yaml">kubectl get svc <span class="token punctuation">-</span>n logsNAME            TYPE        CLUSTER<span class="token punctuation">-</span>IP      EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)          AGEelasticsearch   ClusterIP   10.98.214.187   &lt;none<span class="token punctuation">></span>        9200/TCP         22hkibana          NodePort    10.97.10.70     &lt;none<span class="token punctuation">></span>        5601<span class="token punctuation">:</span>30774/TCP   22h</code></pre><p>浏览器访问ip＋30774,可以参考之前的ELK文章创建索引和模板<br><a href="https://www.huhuhahei.cn/index.php/archives/281/"># Linux部署ELK（二）</a></p><h1 id="配置nginx转发"><a href="#配置nginx转发" class="headerlink" title="配置nginx转发"></a>配置nginx转发</h1><p>配置文件</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    server &amp;#123;        listen       80;        server_name  localhost;        location / &amp;#123;            proxy_pass http://kibana.logs.svc.cluster.local:5601;        auth_basic "secret";        auth_basic_user_file /usr/local/nginx/conf/.test.db;        &amp;#125;    &amp;#125;</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs</code></pre><p>deploy文件</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/lnmp_nginx<span class="token punctuation">:</span>v2        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/conf/conf.d/      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">items</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx.conf            <span class="token key atrule">path</span><span class="token punctuation">:</span> add.conf</code></pre><p>svc文件</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><p>ingress文件</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>   <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> kibana.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /        <span class="token key atrule">backend</span><span class="token punctuation">:</span>           <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><p>全部配置后需要进入容器添加密码详细配置参考这个文章<br><a href="https://www.huhuhahei.cn/index.php/archives/297/"># 使用nginx做反向代理为kibana登陆添加密码</a></p>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ansible playbook</title>
      <link href="/ca9d1912/"/>
      <url>/ca9d1912/</url>
      
        <content type="html"><![CDATA[<h1 id="一-简介"><a href="#一-简介" class="headerlink" title="一.简介"></a>一.简介</h1><h3 id="1-1-playbook命令"><a href="#1-1-playbook命令" class="headerlink" title="1.1 playbook命令"></a>1.1 playbook命令</h3><p>格式</p><pre class=" language-bash"><code class="language-bash">ansible-playbook <span class="token operator">&lt;</span>filename.yml<span class="token operator">></span> <span class="token punctuation">..</span>. <span class="token punctuation">[</span>options<span class="token punctuation">]</span></code></pre><p>常见选项</p><pre class=" language-bash"><code class="language-bash">--syntax-check      <span class="token comment" spellcheck="true">#语法检查,可缩写为--syntax,相当于bash -n</span>-C --check             <span class="token comment" spellcheck="true">#模拟执行,值检测可能会发生的改变,但不真正执行操作</span>--list-hosts             <span class="token comment" spellcheck="true">#列出运行任务的主机</span>--list-tags               <span class="token comment" spellcheck="true">#贴出tag</span>--list-tasks              <span class="token comment" spellcheck="true">#列出task</span>--limit 主机列表       <span class="token comment" spellcheck="true">#只针对主机列表中的铁定主机执行</span>-i INVENTORY         <span class="token comment" spellcheck="true">#指定主机清单文件,通常一个项对应一个主机清单文件</span>--start-at-task START_AT_TASK   <span class="token comment" spellcheck="true">#从指定task开始执行,而非从头开始,START_AT_TASK为任务的name</span>-v -vv-vvv        <span class="token comment" spellcheck="true">#显示过程</span></code></pre><p>范例</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master playbook<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#cat hello.yaml </span>---- hosts: all  remote_user: root  tasks:    - name: hello      command: <span class="token function">hostname</span><span class="token punctuation">[</span>root@master playbook<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible-playbook hello.yaml</span><span class="token comment" spellcheck="true">#-C参数只监测不执行</span><span class="token punctuation">[</span>root@master playbook<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible-playbook -C hello.yaml</span></code></pre><h1 id="二-实战应用"><a href="#二-实战应用" class="headerlink" title="二.实战应用"></a>二.实战应用</h1><h3 id="2-1nginx-playbok"><a href="#2-1nginx-playbok" class="headerlink" title="2.1nginx_playbok"></a>2.1nginx_playbok</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create new file      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/data/newfile state=touch    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=nginx    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/root/ansible/file/index.html dest=/usr/share/nginx/html    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=started enabled=yes</code></pre><h3 id="2-2-httpd-palybook"><a href="#2-2-httpd-palybook" class="headerlink" title="2.2 httpd_palybook"></a>2.2 httpd_palybook</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#install httpd</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Instal1 httpd       <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Modify config list port      <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/httpd/conf/httpd.conf        <span class="token key atrule">regexp</span><span class="token punctuation">:</span> <span class="token string">'^Listen'</span>        <span class="token key atrule">line</span><span class="token punctuation">:</span> <span class="token string">'Listen 8080'</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Modify config data1      <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/httpd/conf/httpd.conf        <span class="token key atrule">regexp</span><span class="token punctuation">:</span> <span class="token string">'^DocumentRoot "/var/www/html"'</span>        <span class="token key atrule">line</span><span class="token punctuation">:</span> <span class="token string">'DocumentRoot "/data/html"'</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Modify config data2      <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/httpd/conf/httpd.conf        <span class="token key atrule">regexp</span><span class="token punctuation">:</span> <span class="token string">'^&lt;Directory "/var/www/html">'</span>        <span class="token key atrule">line</span><span class="token punctuation">:</span> <span class="token string">'&lt;Directory "/data/html">'</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Mkdir website dir      <span class="token key atrule">file</span><span class="token punctuation">:</span> path=/data/html state=directory    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Web html      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/root/ansible/file/index.html dest=/data/html/    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Start service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes</code></pre><h1 id="三-Playbook中使用handlers和notify"><a href="#三-Playbook中使用handlers和notify" class="headerlink" title="三.Playbook中使用handlers和notify"></a>三.Playbook中使用handlers和notify</h1><p>Handlers本质是task list ，类似于MySQL中的触发器触发的行为，其中的task与前述的task并没有本质上的不同，主要用于当关注的资源发生变化时，才会采取一定的操作。而Notify对应的action可用于在每个play的最后被触发，这样可避免多次有改变发生时每次都执行指定的操作，仅在所有的变化发生完 成后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作<br>注意:</p><ul><li>如果多个task通知了相同的handlers， 此handlers仅会在所有tasks结束后运行一 次。</li><li>只有notify对应的task发生改变了才会通知handlers， 没有改变则不会触发handlers</li><li>handlers  是在所有前面的tasks都成功执行才会执行,如果前面任何一个task失败,会导致handler跳过执行,可以使用force_handlers: yes 强制执行handler</li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root   <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no   <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install httpd      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd state=present    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install configure file      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=files/httpd.conf dest=/etc/httpd/conf/<span class="token comment" spellcheck="true">#当配置文件内容改变时触发下面两个触发器</span>      <span class="token key atrule">notify</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> restart httpd        <span class="token punctuation">-</span> wall    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure apache is running      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes  <span class="token key atrule">handlers</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#定义触发器</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart httpd      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=restarted    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wall      <span class="token key atrule">command</span><span class="token punctuation">:</span> wall "The config file is changed"</code></pre><h1 id="四-Playbook中使用tags组件"><a href="#四-Playbook中使用tags组件" class="headerlink" title="四.Playbook中使用tags组件"></a>四.Playbook中使用tags组件</h1><p>在playbook文件中，可以利用tags组件，为特定 task 指定标签，当在执行playbook时，可以只执行特定tags的task,而非整个playbook文件</p><p>可以一个task对应多个tag,也可以多个task对应一个tag</p><p>还有另外3个特殊关键字用于标签, tagged, untagged 和 all,它们分别是仅运行已标记，只有未标记和所有任务。</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install httpd      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd state=present    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install configure file      copy src=files/httpd.conf dest=/etc/httpd/conf      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>conf<span class="token punctuation">,</span>file<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">#写成一行</span>        <span class="token punctuation">-</span> conf              <span class="token comment" spellcheck="true">#写为多行</span>        <span class="token punctuation">-</span> file    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start httpd service      <span class="token key atrule">tags</span><span class="token punctuation">:</span> service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enable=yes</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ansible ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#ansible-playbook –-list-tagshttpd.yml </span><span class="token punctuation">[</span>root@ansible ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#ansible-playbook –t conf,servicehttpd.yml </span><span class="token punctuation">[</span>root@ansible ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#ansible-playbook --skip-tags confhttpd.yml </span><span class="token punctuation">[</span>root@ansible ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#ansible-playbook httpd.yml --skip-tags untagged</span></code></pre><h1 id="五-Playbook中使用变量"><a href="#五-Playbook中使用变量" class="headerlink" title="五.## Playbook中使用变量"></a>五.## Playbook中使用变量</h1><p>变量名:  仅能由字母,数字和下划线组成,且只能以数字开头<br>变量定义:</p><pre class=" language-yaml"><code class="language-yaml">variable=value<span class="token key atrule">variable</span><span class="token punctuation">:</span> value</code></pre><p>调用方式:<br>通过<code> &#123;&#123; variable_name &#125;&#125;</code> 调用变量，且变量名前后建议加空格，有时用”<code>&#123;&#123; variable_name &#125;&#125;</code>“才生效</p><p>变量来源:</p><ul><li>ansible 的 setup facts 远程主机的所有变量都可直接调用</li><li>通过命令行指定变量，优先级最高</li></ul><pre class=" language-bash"><code class="language-bash">ansible-playbook -e varname<span class="token operator">=</span>value test.yml</code></pre><ul><li>在playbook文件中定义</li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">vars</span><span class="token punctuation">:</span>  <span class="token key atrule">var1</span><span class="token punctuation">:</span> value1  <span class="token key atrule">var2</span><span class="token punctuation">:</span> value2</code></pre><ul><li>在独立的变量YAML文件中定义</li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all   <span class="token key atrule">vars_files</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> vars.yml</code></pre><ul><li>在主机清单中定义</li></ul><pre class=" language-bash"><code class="language-bash">主机（普通）变量：主机组中主机单独定义，优先级高于公共变量组（公共）变量：针对主机组中所有主机定义统一变量</code></pre><ul><li>在项目中针对主机和主机组定义</li></ul><pre class=" language-bash"><code class="language-bash">在项目目录创建host_vars和group_vars目录</code></pre><ul><li>在role中定义</li></ul><p><strong>变量的优先级从高到低如下</strong></p><pre class=" language-bash"><code class="language-bash">-e 选项定义变量 --<span class="token operator">></span>playbook中vars_files --<span class="token operator">></span> playbook中vars变量定义 --<span class="token operator">></span>host_vars/主机名文件 --<span class="token operator">></span>主机清单中主机变量--<span class="token operator">></span>group_vars/主机组名文件--<span class="token operator">></span>group_vars/all文件--<span class="token operator">></span> 主机清单组变量</code></pre><h1 id="六-使用setup模块中变量"><a href="#六-使用setup模块中变量" class="headerlink" title="六 使用setup模块中变量"></a>六 使用setup模块中变量</h1><p>本模块自动在playbook调用，不要用ansible命令调用,生成的系统状态信息, 并存放在facts变量中</p><p>facts 包括的信息很多,如: 主机名,IP,CPU,内存,网卡等</p><p>facts 变量有以下使用场景</p><ul><li>通过facts变量获取被控端CPU的个数信息,从而生成不同的Nginx配置文件</li><li>通过facts变量获取被控端内存大小信息,从而生成不同的memcached的配置文件</li><li>通过facts变量获取被控端主机名称信息,从而生成不同的Zabbix配置文件</li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master playbook<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m setup -a "filter='ansible_default_ipv4'"</span>10.46.40.183 <span class="token punctuation">|</span> SUCCESS =<span class="token punctuation">></span> &amp;<span class="token comment" spellcheck="true">#123;</span>    <span class="token key atrule">"ansible_facts"</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;</span>        <span class="token key atrule">"ansible_default_ipv4"</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;</span>            <span class="token key atrule">"address"</span><span class="token punctuation">:</span> <span class="token string">"10.46.40.183"</span><span class="token punctuation">,</span>             <span class="token key atrule">"alias"</span><span class="token punctuation">:</span> <span class="token string">"eth0"</span><span class="token punctuation">,</span>             <span class="token key atrule">"broadcast"</span><span class="token punctuation">:</span> <span class="token string">"10.46.255.255"</span><span class="token punctuation">,</span>             <span class="token key atrule">"gateway"</span><span class="token punctuation">:</span> <span class="token string">"10.46.0.1"</span><span class="token punctuation">,</span>             <span class="token key atrule">"interface"</span><span class="token punctuation">:</span> <span class="token string">"eth0"</span><span class="token punctuation">,</span>             <span class="token key atrule">"macaddress"</span><span class="token punctuation">:</span> <span class="token string">"52:54:00:d2:23:85"</span><span class="token punctuation">,</span>             <span class="token key atrule">"mtu"</span><span class="token punctuation">:</span> <span class="token number">1454</span><span class="token punctuation">,</span>             <span class="token key atrule">"netmask"</span><span class="token punctuation">:</span> <span class="token string">"255.255.0.0"</span><span class="token punctuation">,</span>             <span class="token key atrule">"network"</span><span class="token punctuation">:</span> <span class="token string">"10.46.0.0"</span><span class="token punctuation">,</span>             <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"ether"</span>        &amp;<span class="token comment" spellcheck="true">#125;, </span>        <span class="token key atrule">"discovered_interpreter_python"</span><span class="token punctuation">:</span> <span class="token string">"/usr/bin/python"</span>    &amp;<span class="token comment" spellcheck="true">#125;, </span>    <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre><p>playbook中使用</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> show eth0 ip address      <span class="token key atrule">debug</span><span class="token punctuation">:</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> IP address &amp;<span class="token comment" spellcheck="true">#123;&amp;#123; ansible_eth0.ipv4.address &amp;#125;&amp;#125;</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> show eth0 ip address      <span class="token key atrule">debug</span><span class="token punctuation">:</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> IP address &amp;<span class="token comment" spellcheck="true">#123;&amp;#123; ansible_eth0.ipv4.address.split('.')[-1] &amp;#125;&amp;#125;</span></code></pre><h1 id="七-register注册变量"><a href="#七-register注册变量" class="headerlink" title="七.register注册变量"></a>七.register注册变量</h1><p>在playbook中可以使用register将捕获命令的输出保存在临时变量中，然后使用debug模块进行显示输出</p><p>范例: 利用debug 模块输出变量</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> get variable      <span class="token key atrule">shell</span><span class="token punctuation">:</span> hostname      <span class="token key atrule">register</span><span class="token punctuation">:</span> name    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"print variable"</span>      <span class="token key atrule">debug</span><span class="token punctuation">:</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> "&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; name &amp;#125;&amp;#125;"                          #输出register注册的name变量的全部信息</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> "&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; name.cmd &amp;#125;&amp;#125;"                   #显示命令</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> "&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; name.rc &amp;#125;&amp;#125;"                        #显示命令成功与否</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> "&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; name.stdout &amp;#125;&amp;#125;"                 #显示命令的输出结果为字符串形式</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> "&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; name.stdout_lines &amp;#125;&amp;#125;"        #显示命令的输出结果为列表形式</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> "&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; name.stdout_lines[0] &amp;#125;&amp;#125;"     #显示命令的输出结果的列表中的第一个元素</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> "&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; name['stdout_lines'] &amp;#125;&amp;#125;"       #显示命令的执行结果为列表形式</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ansible </tag>
            
            <tag> DevOps </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ansible详解</title>
      <link href="/a1695b73/"/>
      <url>/a1695b73/</url>
      
        <content type="html"><![CDATA[<h1 id="一-Ansible简介"><a href="#一-Ansible简介" class="headerlink" title="一. Ansible简介"></a>一. Ansible简介</h1><p>Ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。</p><p>ansible是基于模块工作的，本身没有批量部署的能力。真正具有批量部署的是ansible所运行的模块，ansible只是提供一种框架。主要包括：</p><ul><li>连接插件connection plugins：负责和被监控端实现通信；</li><li>host inventory：指定操作的主机，是一个配置文件里面定义监控的主机；</li><li>各种模块核心模块、command模块、自定义模块；</li><li>借助于插件完成记录日志邮件等功能；</li><li>playbook：剧本执行多个任务时，非必需可以让节点一次性运行多个任务。</li></ul><hr><h1 id="二-Ansbile架构"><a href="#二-Ansbile架构" class="headerlink" title="二.Ansbile架构"></a>二.Ansbile架构</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/1060232853.jpg"></p><ul><li>INVENTORY：Ansible 管 理 主 机 的 清 单 &#x2F;etc&#x2F;anaible&#x2F;hosts</li><li>MODULES：Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</li><li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等</li><li>API：供第三方程序调用的应用程序编程接口</li></ul><hr><h1 id="三-Ansible安装"><a href="#三-Ansible安装" class="headerlink" title="三.Ansible安装"></a>三.Ansible安装</h1><p>ansible的安装方法有多种</p><p>官方文档</p><pre class=" language-bash"><code class="language-bash">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.ht ml</code></pre><ul><li>ubuntu18.04安装</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># apt update</span><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># apt install software-properties-common </span><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># apt-add-repository --yes --update ppa:ansible/ansible </span><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># apt install ansible</span><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible --version ansible 2.9.17</span>config <span class="token function">file</span> <span class="token operator">=</span> /etc/ansible/ansible.cfgconfigured module search path <span class="token operator">=</span> <span class="token punctuation">[</span>u<span class="token string">'/root/.ansible/plugins/modules'</span>,u<span class="token string">'/usr/share/ansible/plugins/modules'</span><span class="token punctuation">]</span>ansible python module location <span class="token operator">=</span> /usr/lib/python2.7/dist-packages/ansible executable location <span class="token operator">=</span> /usr/bin/ansiblepython version <span class="token operator">=</span> 2.7.17 <span class="token punctuation">(</span>default, Sep 30 2020, 13:38:04<span class="token punctuation">)</span> <span class="token punctuation">[</span>GCC 7.5.0<span class="token punctuation">]</span></code></pre><ul><li>Centos安装</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum install ansible -y </span><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible --version ansible 2.9.16</span>config <span class="token function">file</span> <span class="token operator">=</span> /etc/ansible/ansible.cfgconfigured module search path <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'/root/.ansible/plugins/modules'</span>, <span class="token string">'/usr/share/ansible/plugins/modules'</span><span class="token punctuation">]</span>ansible python module location <span class="token operator">=</span> /usr/lib/python3.6/site-packages/ansible executable location <span class="token operator">=</span> /usr/bin/ansiblepython version <span class="token operator">=</span> 3.6.8 <span class="token punctuation">(</span>default, Apr 16 2020, 01:36:27<span class="token punctuation">)</span> <span class="token punctuation">[</span>GCC 8.3.1 20191121<span class="token punctuation">(</span>Red Hat 8.3.1-5<span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre><ul><li>pip安装</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#yum install python-pip </span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#pip install--upgrade pip </span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#pip install ansible --upgrade </span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#ansible --version</span>/usr/lib64/python2.7/site-packages/cryptography/ init .py:39: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support <span class="token keyword">for</span> it is now deprecated <span class="token keyword">in</span> cryptography, and will be removed <span class="token keyword">in</span> a future release.CryptographyDeprecationWarning, ansible 2.9.12config <span class="token function">file</span> <span class="token operator">=</span> Noneconfigured module search path <span class="token operator">=</span> <span class="token punctuation">[</span>u<span class="token string">'/root/.ansible/plugins/modules'</span>,u<span class="token string">'/usr/share/ansible/plugins/modules'</span><span class="token punctuation">]</span>ansible python module location <span class="token operator">=</span> /usr/lib/python2.7/site-packages/ansible executable location <span class="token operator">=</span> /usr/bin/ansiblepython version <span class="token operator">=</span> 2.7.5 <span class="token punctuation">(</span>default, Apr2 2020, 13:16:51<span class="token punctuation">)</span> <span class="token punctuation">[</span>GCC 4.8.5 20150623<span class="token punctuation">(</span>Red Hat 4.8.5-39<span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre><hr><h1 id="四-Ansible相关文件"><a href="#四-Ansible相关文件" class="headerlink" title="四.Ansible相关文件"></a>四.Ansible相关文件</h1><h3 id="4-1-配置文件"><a href="#4-1-配置文件" class="headerlink" title="4.1 配置文件"></a>4.1 配置文件</h3><ul><li>&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg   主配置文件，配置ansible工作特性,也可以在项目的目录中创建此文件, 当前目录下如果也有ansible.cfg,则此文件优先生效,建议每个项目目录下,创建独有的ansible.cfg文  件</li><li>&#x2F;etc&#x2F;ansible&#x2F;hosts 主机清单</li><li>&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F; 存放角色的目录</li></ul><h3 id="4-2-主配置文件"><a href="#4-2-主配置文件" class="headerlink" title="4.2 主配置文件"></a>4.2 主配置文件</h3><p>Ansible 的配置文件可以放在多个不同地方,优先级从高到低顺序如下</p><pre class=" language-bash"><code class="language-bash">ANSIBLE_CONFIG            <span class="token comment" spellcheck="true">#环境变量</span>./ansible.cfg                    <span class="token comment" spellcheck="true">#当前目录下的ansible.cfg</span>~/.ansible.cfg                  <span class="token comment" spellcheck="true">#当前用户家目录下的.ansible.cfg</span>/etc/ansible/ansible.cfg  <span class="token comment" spellcheck="true">#系统默认配置文件</span></code></pre><p>Ansible 的默认配置文件 &#x2F;etc&#x2F;ansible&#x2F;ansible.cfg ,其中大部分的配置内容无需进行修改</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>defaults<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#inventory      = /etc/ansible/hosts        #主机列表配置文件</span><span class="token comment" spellcheck="true">#library        = /usr/share/my_modules/    #库文件存放目录</span><span class="token comment" spellcheck="true">#remote_tmp     = ~/.ansible/tmp              #临时py命令文件存放在远程主机的目录</span><span class="token comment" spellcheck="true">#local_tmp      = ~/.ansible/tmp                  #本地临时命令执行目录</span><span class="token comment" spellcheck="true">#forks          = 5                                            #默认并发数</span><span class="token comment" spellcheck="true">#sudo_user      = root                                   #默认速度用户</span><span class="token comment" spellcheck="true">#ask_sudo_pass = True                                 #每次执行ansible命令是否询问ssh密码</span><span class="token comment" spellcheck="true">#host_key_checking = False                          #检查对应服务器的host_key,建议取消此行注释,实现第一次连接自动信任目标主机</span><span class="token comment" spellcheck="true">#log_path = /var/log/ansible.log                  #建议开启 日志文件存放目录</span><span class="token comment" spellcheck="true">#module_name = command                         #默认的模块 可以修改为shell模块</span> <span class="token punctuation">[</span>privilege_escalation<span class="token punctuation">]</span>                                     <span class="token comment" spellcheck="true">#普通用户提权配置</span><span class="token comment" spellcheck="true">#become=True </span><span class="token comment" spellcheck="true">#become_method=sudo </span><span class="token comment" spellcheck="true">#become_user=root</span><span class="token comment" spellcheck="true">#become_ask_pass=False</span></code></pre><h3 id="4-3-Ansible相关工具"><a href="#4-3-Ansible相关工具" class="headerlink" title="4.3 Ansible相关工具"></a>4.3 Ansible相关工具</h3><ul><li>&#x2F;usr&#x2F;bin&#x2F;ansible主程序，临时命令执行工具</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-doc查看配置文档，模块功能查看工具,相当于man</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-playbook定制自动化任务，编排剧本工具,相当于脚本</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-pull远程执行命令的工具</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-vault文件加密工具</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-console基于Console界面与用户交互的执行工具</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-galaxy下载&#x2F;上传优秀代码或Roles模块的官网平台</li></ul><h3 id="4-4-ansible命令执行过程"><a href="#4-4-ansible命令执行过程" class="headerlink" title="4.4 ansible命令执行过程"></a>4.4 ansible命令执行过程</h3><ol><li>加载自己的配置文件,默认&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</li><li>加载自己对应的模块文件，如：command</li><li>通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服务器的对应执行用户$HOME&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-数字&#x2F;XXX.PY文件</li><li>给文件+x执行</li><li>执行并返回结果</li><li>删除临时py文件，退出</li></ol><hr><h1 id="五-Ansible常用模块"><a href="#五-Ansible常用模块" class="headerlink" title="五. Ansible常用模块"></a>五. Ansible常用模块</h1><h3 id="5-1-Command模块"><a href="#5-1-Command模块" class="headerlink" title="5.1 Command模块"></a>5.1 Command模块</h3><p>功能：在远程主机执行命令，此为默认模块，可忽略-m选项</p><p>注意：此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等，可能用shell模块实现注意：此模块不具有幂等性<br>范例：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m command -a 'cat /etc/centos-release'</span>10.46.40.183 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>CentOS Linux release 7.6.1810 <span class="token punctuation">(</span>Core<span class="token punctuation">)</span> 10.46.74.222 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>CentOS Linux release 7.6.1810 <span class="token punctuation">(</span>Core<span class="token punctuation">)</span><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m command -a 'ls /root/'</span>10.46.74.222 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span><span class="token function">test</span>10.46.40.183 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span><span class="token function">test</span></code></pre><hr><h3 id="5-2-Shell模块"><a href="#5-2-Shell模块" class="headerlink" title="5.2 Shell模块"></a>5.2 Shell模块</h3><p>功能：和command相似，用shell执行命令,支持各种符号,比如:*,$, &gt;</p><p>注意：此模块不具有幂等性<br>范例：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m shell -a 'echo $HOSTNAME'</span>10.46.40.183 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>node0210.46.74.222 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>node01<span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m shell -a "echo 'hello' > /root/test &amp;&amp; cat /root/test"</span>10.46.74.222 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>hello10.46.40.183 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>hello</code></pre><hr><h3 id="5-3-Script模块"><a href="#5-3-Script模块" class="headerlink" title="5.3 Script模块"></a>5.3 Script模块</h3><p>功能：在远程主机上运行ansible服务器上的脚本(无需执行权限)</p><p>注意：此模块不具有幂等性<br>范例：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m script -a ./test.sh </span>10.46.74.222 <span class="token operator">|</span> CHANGED <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>    <span class="token string">"changed"</span><span class="token keyword">:</span> true,     <span class="token string">"rc"</span><span class="token keyword">:</span> 0,     <span class="token string">"stderr"</span><span class="token keyword">:</span> <span class="token string">"Shared connection to 10.46.74.222 closed.\r\n"</span>,     <span class="token string">"stderr_lines"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>        <span class="token string">"Shared connection to 10.46.74.222 closed."</span>    <span class="token punctuation">]</span>,     <span class="token string">"stdout"</span><span class="token keyword">:</span> <span class="token string">"10.46.74.222 \r\n"</span>,     <span class="token string">"stdout_lines"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>        <span class="token string">"10.46.74.222 "</span>    <span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span>10.46.40.183 <span class="token operator">|</span> CHANGED <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>    <span class="token string">"changed"</span><span class="token keyword">:</span> true,     <span class="token string">"rc"</span><span class="token keyword">:</span> 0,     <span class="token string">"stderr"</span><span class="token keyword">:</span> <span class="token string">"Shared connection to 10.46.40.183 closed.\r\n"</span>,     <span class="token string">"stderr_lines"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>        <span class="token string">"Shared connection to 10.46.40.183 closed."</span>    <span class="token punctuation">]</span>,     <span class="token string">"stdout"</span><span class="token keyword">:</span> <span class="token string">"10.46.40.183 \r\n"</span>,     <span class="token string">"stdout_lines"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>        <span class="token string">"10.46.40.183 "</span>    <span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span></code></pre><hr><h3 id="5-4-Copy模块"><a href="#5-4-Copy模块" class="headerlink" title="5.4 Copy模块"></a>5.4 Copy模块</h3><p>功能：从ansible服务器主控端复制文件到远程主机</p><p>注意: src&#x3D;file 如果是没指明路径,则为当前目录或当前目录下的files目录下的file文件</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m copy -a "src=./test.sh dest=/root/test.sh owner=root </span><span class="token comment" spellcheck="true">#指定内容，直接生成目标文件</span><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible websrvs -m copy -a "content='test line1\ntest line2\n' dest=/tmp/test.txt"</span><span class="token comment" spellcheck="true">#复制/etc目录自身,注意/etc/后面没有</span><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># /ansible websrvs -m copy -a "src=/etc dest=/backup"</span><span class="token comment" spellcheck="true">#复制/etc/下的文件，不包括/etc/目录自身,注意/etc/后面有/ </span><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible websrvs -m copy -a "src=/etc/ dest=/backup"</span></code></pre><hr><h3 id="5-5-Ger-url模块"><a href="#5-5-Ger-url模块" class="headerlink" title="5.5 Ger_url模块"></a>5.5 Ger_url模块</h3><p>功能:  用于将文件从http、https或ftp下载到被管理机节点上<br>常用参数如下：</p><pre class=" language-bash"><code class="language-bash">url: 下载文件的URL,支持HTTP，HTTPS或FTP协议dest:  下载到目标路径（绝对路径），如果目标是一个目录，就用服务器上面文件的名称，如果目标设置了名称就用目标设置的名称owner：指定属主group：指定属组mode：指定权限force:  如果yes，dest不是目录，将每次下载文件，如果内容改变，替换文件。如果否，则只有在目标不存在时才会下载该文件checksum: 对目标文件在下载后计算摘要，以确保其完整性<span class="token comment" spellcheck="true">#示 例 : checksum="sha256:D98291AC[...]B6DC7B97", [checksum="sha256:http://example.com/path/sha256](http://example.com/path/sha256sum.txt)sum.txt"</span>url_username: 用于HTTP基本认证的用户名。 对于允许空密码的站点，此参数可以不使用`url_password<span class="token string">'url_password: 用于HTTP基本认证的密码。 如果未指定`url_username'</span>参数，则不会使用`url_password'参数validate_certs：如果“no”，SSL证书将不会被验证。 适用于自签名证书在私有网站上使用timeout: URL请求的超时时间,秒为单位</code></pre><p>范例:</p><pre class=" language-bash"><code class="language-bash">ansible all -m get_url -a <span class="token string">'url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src/nginx.tar.gz'</span></code></pre><hr><h3 id="5-6-Fetch模块"><a href="#5-6-Fetch模块" class="headerlink" title="5.6 Fetch模块"></a>5.6 Fetch模块</h3><p>功能：从远程主机提取文件至ansible的主控端，copy相反，目前不支持目录<br>范例：</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -mfetch -a 'src=/etc/redhat-release dest=/data/os'</span><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tree /data/os/</span>/data/os/├── 10.46.40.183│   └── etc│       └── redhat-release└── 10.46.74.222    └── etc        └── redhat-release4 directories, 2 files</code></pre><hr><h3 id="5-7-File模块"><a href="#5-7-File模块" class="headerlink" title="5.7 File模块"></a>5.7 File模块</h3><p>功能：设置文件属性,创建软链接等<br>范例：</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#创建空文件</span>ansible all -m <span class="token function">file</span> -a <span class="token string">'path=/data/test.txt state=touch'</span> ansible all -m <span class="token function">file</span> -a <span class="token string">'path=/data/test.txt state=absent'</span> ansible all -m <span class="token function">file</span> -a <span class="token string">"path=/root/test.sh owner=wang mode=755"</span> <span class="token comment" spellcheck="true">#创建目录</span>ansible all -m <span class="token function">file</span> -a <span class="token string">"path=/data/mysql state=directory owner=mysql group=mysql"</span><span class="token comment" spellcheck="true">#创建软链接</span>ansible all -m <span class="token function">file</span> -a <span class="token string">'src=/data/testfilepath|dest|name=/data/testfile-link state=link'</span><span class="token comment" spellcheck="true">#创建目录</span>ansible all -m <span class="token function">file</span> -a <span class="token string">'path=/data/testdir state=directory'</span><span class="token comment" spellcheck="true">#递归修改目录属性,但不递归至子目录</span>ansible all -m <span class="token function">file</span> -a <span class="token string">"path=/data/mysql state=directory owner=mysql group=mysql"</span><span class="token comment" spellcheck="true">#递归修改目录及子目录的属性</span>ansible all -m <span class="token function">file</span> -a <span class="token string">"path=/data/mysql state=directory owner=mysql group=mysql recurse=yes"</span>``</code></pre><hr><h3 id="5-8-Unarchive模块"><a href="#5-8-Unarchive模块" class="headerlink" title="5.8 Unarchive模块"></a>5.8 Unarchive模块</h3><p>功能：解包解压缩<br>实现有两种用法：</p><ol><li>将ansible主机上的压缩包传到远程主机后解压缩至特定目录，设置copy&#x3D;yes</li><li>将远程主机上的某个压缩包解压缩到指定路径下，设置copy&#x3D;no<br>常见参数：</li></ol><pre class=" language-bash"><code class="language-bash">copy：默认为yes，当copy<span class="token operator">=</span>yes，拷贝的文件是从ansible主机复制到远程主机上，如果设置为copy<span class="token operator">=</span>no，会在远程主机上寻找src源文件remote_src：和copy功能一样且互斥，yes表示在远程主机，不在ansible主机，no表示文件在ansible主机上src：源路径，可以是ansible主机上的路径，也可以是远程主机<span class="token punctuation">(</span>被管理端或者第三方主机<span class="token punctuation">)</span>上的路径，如果  是远程主机上的路径，则需要设置copy<span class="token operator">=</span>nodest：远程主机上的目标路径mode：设置解压缩后的文件权限</code></pre><pre class=" language-bash"><code class="language-bash">ansible all -m unarchive -a <span class="token string">'src=/usr/local/src/nginx.tar.gz dest=/usr/local copy=no'</span>ansible all -m unarchive -a <span class="token string">'src=./file/nginx-1.18.0.tar.gz dest=/tmp copy=yes'</span></code></pre><hr><h3 id="5-9-Archive模块"><a href="#5-9-Archive模块" class="headerlink" title="5.9 Archive模块"></a>5.9 Archive模块</h3><p>功能：打包压缩保存在被管理节点<br>范例：</p><pre class=" language-bash"><code class="language-bash">ansible all -m archive -a <span class="token string">'path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=root mode=0600'</span></code></pre><hr><h3 id="5-10-Hostname模块"><a href="#5-10-Hostname模块" class="headerlink" title="5.10 Hostname模块"></a>5.10 Hostname模块</h3><p>功能：管理主机名<br>范例：</p><pre class=" language-bash"><code class="language-bash">ansible node1 -m <span class="token function">hostname</span> -a <span class="token string">"name=websrv"</span>ansible 10.0.0.18 -m <span class="token function">hostname</span> -a <span class="token string">'name=huhuhahei'</span></code></pre><h3 id="5-11-Cron模块"><a href="#5-11-Cron模块" class="headerlink" title="5.11 Cron模块"></a>5.11 Cron模块</h3><p>功能：计划任务</p><p>支持时间：minute，hour，day，month，weekday</p><p>范例：</p><pre class=" language-bash"><code class="language-bash">ansible all -m <span class="token function">cron</span> -a <span class="token string">"minute=* weekday=1,4,5 job='/usr/bin/wall warnging' name=warn"</span><span class="token comment" spellcheck="true">#禁用计划任务</span>ansible all -m <span class="token function">cron</span> -a <span class="token string">"minute=* weekday=1,4,5 job='/usr/bin/wall warnging' name=warn disabled=yes"</span><span class="token comment" spellcheck="true">#删除计划任务</span>ansible all -m <span class="token function">cron</span> -a <span class="token string">"state=absent name=warn"</span></code></pre><h3 id="5-12-Yum模块"><a href="#5-12-Yum模块" class="headerlink" title="5.12 Yum模块"></a>5.12 Yum模块</h3><p>功能：</p><p>yum 管理软件包，只支持RHEL，CentOS，fedora，不支持Ubuntu其它版本</p><p>apt 模块管理 Debian 相关版本的软件包</p><p>范例:</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#安装vsftpd</span>ansible all -m yum -a <span class="token string">"name=vsftpd"</span><span class="token comment" spellcheck="true">#卸载</span>ansible all -m yum -a <span class="token string">"name=vsftpd state=absent"</span><span class="token comment" spellcheck="true">#安装网络中的rpm包</span>ansible all -m yum -a <span class="token string">"name=https://mirror.tuna.tsinghua.edu.cn/zabbix/zabbix/5.2/rhel/7/x86_64/zabbix-agent-5.2.5-1.el7.x86_64.rpm validate_certs=no"</span><span class="token comment" spellcheck="true">#清除缓存安装软件包</span>ansible all -m yum -a <span class="token string">"name=dstat update_cache=yes"</span><span class="token comment" spellcheck="true">#查看所有安装包</span>ansible all -m yum -a <span class="token string">"list=installed"</span></code></pre><h3 id="5-13-Service-模块"><a href="#5-13-Service-模块" class="headerlink" title="5.13 Service 模块"></a>5.13 Service 模块</h3><p>功能：管理服务<br>范例：</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#启动服务并开机自启</span>ansible all -m <span class="token function">service</span> -a <span class="token string">"name=httpd state=started enabled=yes"</span><span class="token comment" spellcheck="true">#关闭服务</span>ansible all -m <span class="token function">service</span> -a <span class="token string">"name=httpd state=stopped enabled=yes"</span></code></pre><h3 id="5-14-User模块"><a href="#5-14-User模块" class="headerlink" title="5.14 User模块"></a>5.14 User模块</h3><p>功能：管理用户<br>范例:</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#创建用户</span>ansible all -m user -a <span class="token string">'name=user1 comment="test user" uid=2048 home=/app/user1 group=root'</span>ansible all -m user -a <span class="token string">'name=nginx comment=nginx uid=88 group=root groups="root,daemon" shell=/sbin/nologin system=yes create_home=no home=/data/nginx non_unique=yes'</span><span class="token comment" spellcheck="true">#删除用户</span>ansible all -m user -a <span class="token string">'name=nginx state=absent remove=yes'</span></code></pre><h3 id="5-15-Group模块"><a href="#5-15-Group模块" class="headerlink" title="5.15 Group模块"></a>5.15 Group模块</h3><p>功能：管理组<br>范例：</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#创建组</span>ansible all -m group -a <span class="token string">'name=nginx gid=88 system=yes'</span><span class="token comment" spellcheck="true">#删除组</span>ansible all -m group -a <span class="token string">'name=nginx state=absent'</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ansible </tag>
            
            <tag> DevOps </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ceph 块存储使用</title>
      <link href="/e37d425d/"/>
      <url>/e37d425d/</url>
      
        <content type="html"><![CDATA[<h1 id="Ceph块存储使用"><a href="#Ceph块存储使用" class="headerlink" title="Ceph块存储使用"></a>Ceph块存储使用</h1><ul><li>创建一个存储块</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rbd create mypool/rbd-demo1.img --size 10Gash<span class="token comment" spellcheck="true">#查看</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rbd -p mypool <span class="token function">ls</span>rbd-demo.img<span class="token comment" spellcheck="true">#查看详细信息</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rbd info mypool/rbd-demo.imgrbd image <span class="token string">'rbd-demo.img'</span><span class="token keyword">:</span>    size 10 GiB <span class="token keyword">in</span> 2560 objects    order 22 <span class="token punctuation">(</span>4 MiB objects<span class="token punctuation">)</span>    id: 37bd6b8b4567    block_name_prefix: rbd_data.37bd6b8b4567    format: 2    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten    op_features:     flags:     create_timestamp: Sat Dec  4 18:51:43 2021<span class="token comment" spellcheck="true">#去除rbd设备特性</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rbd feature disable ceph-demo/rbd-demo.img exclusive-lock</span><span class="token comment" spellcheck="true">#删除块设备</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rbd <span class="token function">rm</span> mypool/rbd-demo1.imgRemoving image: 100% complete<span class="token punctuation">..</span>.done.</code></pre><ul><li>客户端挂载设备</li></ul><p>客户端需要安装ceph程序</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install ceph</span><span class="token comment" spellcheck="true">#拷贝配置文件到客户端</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy admin 10.46.8.18</span></code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#挂载</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ <span class="token function">sudo</span> rbd map mypool/rbd-demo.img/dev/rbd0<span class="token comment" spellcheck="true">#查看设备</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rbd device list<span class="token function">id</span> pool   image        snap device    0  mypool rbd-demo.img -    /dev/rbd0 <span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ lsblk NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINTrbd0   252:0    0  10G  0 disk vda    253:0    0  40G  0 disk └─vda1 253:1    0  40G  0 part /<span class="token comment" spellcheck="true">#格式化挂载使用</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ <span class="token function">sudo</span> mkfs.xfs /dev/rbd0meta-data<span class="token operator">=</span>/dev/rbd0              isize<span class="token operator">=</span>512    agcount<span class="token operator">=</span>16, agsize<span class="token operator">=</span>163840 blks         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>512   attr<span class="token operator">=</span>2, projid32bit<span class="token operator">=</span>1         <span class="token operator">=</span>                       crc<span class="token operator">=</span>1        finobt<span class="token operator">=</span>0, sparse<span class="token operator">=</span>0data     <span class="token operator">=</span>                       bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2621440, imaxpct<span class="token operator">=</span>25         <span class="token operator">=</span>                       sunit<span class="token operator">=</span>1024   swidth<span class="token operator">=</span>1024 blksnaming   <span class="token operator">=</span>version 2              bsize<span class="token operator">=</span>4096   ascii-ci<span class="token operator">=</span>0 ftype<span class="token operator">=</span>1log      <span class="token operator">=</span>internal log           bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2560, version<span class="token operator">=</span>2         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>512   sunit<span class="token operator">=</span>8 blks, lazy-count<span class="token operator">=</span>1realtime <span class="token operator">=</span>none                   extsz<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>0, rtextents<span class="token operator">=</span>0<span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">mkdir</span> /mnt/rbd-demo<span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">mount</span> /dev/rbd0 /mnt/rbd-demo<span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ <span class="token function">df</span> -ThFilesystem     Type      Size  Used Avail Use% Mounted ondevtmpfs       devtmpfs  947M     0  947M   0% /devtmpfs          tmpfs     959M     0  959M   0% /dev/shmtmpfs          tmpfs     959M   17M  943M   2% /runtmpfs          tmpfs     959M     0  959M   0% /sys/fs/cgroup/dev/vda1      xfs        40G  2.1G   38G   6% /tmpfs          tmpfs     192M     0  192M   0% /run/user/0/dev/rbd0      xfs        10G   33M   10G   1% /mnt/rbd-demo<span class="token comment" spellcheck="true">#测试读写</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># echo "huhuhahei" > test</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test</span>huhuhahei</code></pre><ul><li>块设备扩容</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rbd resize mypool/rbd-demo.img --size 20G</span>Resizing image: 100% complete<span class="token punctuation">..</span>.done.<span class="token comment" spellcheck="true">#查看已经扩容生效</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rbd info mypool/rbd-demo.img</span>rbd image <span class="token string">'rbd-demo.img'</span><span class="token keyword">:</span>    size 20 GiB <span class="token keyword">in</span> 5120 objects    order 22 <span class="token punctuation">(</span>4 MiB objects<span class="token punctuation">)</span>    id: 37bd6b8b4567    block_name_prefix: rbd_data.37bd6b8b4567    format: 2    features: layering    op_features:     flags:     create_timestamp: Sat Dec  4 18:51:43 2021<span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># lsblk </span>NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINTrbd0   252:0    0  20G  0 disk /mnt/rbd-demovda    253:0    0  40G  0 disk └─vda1 253:1    0  40G  0 part /<span class="token comment" spellcheck="true">#但是文件系统没有增加 还是10G</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -h</span>Filesystem      Size  Used Avail Use% Mounted ondevtmpfs        947M     0  947M   0% /devtmpfs           959M     0  959M   0% /dev/shmtmpfs           959M   17M  943M   2% /runtmpfs           959M     0  959M   0% /sys/fs/cgroup/dev/vda1        40G  2.1G   38G   6% /tmpfs           192M     0  192M   0% /run/user/0/dev/rbd0        10G   33M   10G   1% /mnt/rbd-demo<span class="token comment" spellcheck="true">#使用xfs_growfs扩容xfs文件系统</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># xfs_growfs /dev/rbd0</span>meta-data<span class="token operator">=</span>/dev/rbd0              isize<span class="token operator">=</span>512    agcount<span class="token operator">=</span>16, agsize<span class="token operator">=</span>163840 blks         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>512   attr<span class="token operator">=</span>2, projid32bit<span class="token operator">=</span>1         <span class="token operator">=</span>                       crc<span class="token operator">=</span>1        finobt<span class="token operator">=</span>0 spinodes<span class="token operator">=</span>0data     <span class="token operator">=</span>                       bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2621440, imaxpct<span class="token operator">=</span>25         <span class="token operator">=</span>                       sunit<span class="token operator">=</span>1024   swidth<span class="token operator">=</span>1024 blksnaming   <span class="token operator">=</span>version 2              bsize<span class="token operator">=</span>4096   ascii-ci<span class="token operator">=</span>0 ftype<span class="token operator">=</span>1log      <span class="token operator">=</span>internal               bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2560, version<span class="token operator">=</span>2         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>512   sunit<span class="token operator">=</span>8 blks, lazy-count<span class="token operator">=</span>1realtime <span class="token operator">=</span>none                   extsz<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>0, rtextents<span class="token operator">=</span>0data blocks changed from 2621440 to 5242880<span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -Th</span>Filesystem     Type      Size  Used Avail Use% Mounted ondevtmpfs       devtmpfs  947M     0  947M   0% /devtmpfs          tmpfs     959M     0  959M   0% /dev/shmtmpfs          tmpfs     959M   17M  943M   2% /runtmpfs          tmpfs     959M     0  959M   0% /sys/fs/cgroup/dev/vda1      xfs        40G  2.1G   38G   6% /tmpfs          tmpfs     192M     0  192M   0% /run/user/0/dev/rbd0      xfs        20G   34M   20G   1% /mnt/rbd-demo<span class="token comment" spellcheck="true">#查看已经扩容完成 20G</span></code></pre><ul><li>HEALTH_WARN修复</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph -s</span>  cluster:    id:     b5fa13e6-6b7f-4eeb-bac3-a7b6bc535109    health: HEALTH_WARN            application not enabled on 1 pool<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#这个报错是之前创建块设备没有指定类型 </span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool application enable mypool rbd</span>enabled application <span class="token string">'rbd'</span> on pool <span class="token string">'mypool'</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool application get mypool</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>    <span class="token string">"rbd"</span><span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;&amp;#125;</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span><span class="token comment" spellcheck="true">#可以使用下面命令查看详细信息</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph health detail</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ceph 对象存储使用</title>
      <link href="/ef7636ef/"/>
      <url>/ef7636ef/</url>
      
        <content type="html"><![CDATA[<h1 id="一-配置Radosgw"><a href="#一-配置Radosgw" class="headerlink" title="一.配置Radosgw"></a>一.配置Radosgw</h1><h3 id="1-1-创建radosgw"><a href="#1-1-创建radosgw" class="headerlink" title="1.1 创建radosgw"></a>1.1 创建radosgw</h3><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy rgw create node-1</span>---nts/ceph-radosgw@rgw.node-1.service to /usr/lib/systemd/system/ceph-radosgw@.service.<span class="token punctuation">[</span>node-1<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: systemctl start ceph-radosgw@rgw.node-1<span class="token punctuation">[</span>node-1<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: systemctl <span class="token function">enable</span> ceph.target<span class="token punctuation">[</span>ceph_deploy.rgw<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> The Ceph Object Gateway <span class="token punctuation">(</span>RGW<span class="token punctuation">)</span> is now running on host node-1 and default port 7480<span class="token comment" spellcheck="true">#访问url </span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># curl http://node-1:7480</span><span class="token operator">&lt;</span>?xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span>?<span class="token operator">></span><span class="token operator">&lt;</span>ListAllMyBucketsResult xmlns<span class="token operator">=</span><span class="token string">"http://s3.amazonaws.com/doc/2006-03-01/"</span><span class="token operator">></span><span class="token operator">&lt;</span>Owner<span class="token operator">></span><span class="token operator">&lt;</span>ID<span class="token operator">></span>anonymous<span class="token operator">&lt;</span>/ID<span class="token operator">></span><span class="token operator">&lt;</span>DisplayName<span class="token operator">></span><span class="token operator">&lt;</span>/DisplayName<span class="token operator">></span><span class="token operator">&lt;</span>/Owner<span class="token operator">></span><span class="token operator">&lt;</span>Buckets<span class="token operator">></span><span class="token operator">&lt;</span>/Buckets<span class="token operator">></span><span class="token operator">&lt;</span>/ListAllMyBucketsResult<span class="token operator">></span><span class="token comment" spellcheck="true">#可以正常打开证明安装没有问题</span></code></pre><h3 id="1-2-修改radosgw访问端口"><a href="#1-2-修改radosgw访问端口" class="headerlink" title="1.2 修改radosgw访问端口"></a>1.2 修改radosgw访问端口</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#修改配置文件 添加</span><span class="token punctuation">[</span>client.rgw.node-1<span class="token punctuation">]</span>rgw_frontends <span class="token operator">=</span> <span class="token string">"civetweb port=80"</span><span class="token comment" spellcheck="true">#拷贝配置文件到其他节点</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy --overwrite-conf config push node-1 node-2 node-3 </span><span class="token comment" spellcheck="true">#重启服务</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl restart ceph-radosgw.target </span><span class="token comment" spellcheck="true">#确认是否生效</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># netstat -anpt | grep :80</span>tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      40358/radosgw</code></pre><h1 id="二-使用s3方式访问ceph"><a href="#二-使用s3方式访问ceph" class="headerlink" title="二.使用s3方式访问ceph"></a>二.使用s3方式访问ceph</h1><h3 id="2-1-使用sdk访问"><a href="#2-1-使用sdk访问" class="headerlink" title="2.1 使用sdk访问"></a>2.1 使用sdk访问</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#创建用户</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># radosgw-admin user create --uid ceph-s3-user --display-name "Ceph S3 User Demo"</span><span class="token comment" spellcheck="true">#编写python sdk</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install python-boto</span><span class="token function">import</span> boto.s3.connectionaccess_key <span class="token operator">=</span> <span class="token string">'HWOT3KMNOG1V2xxxxxx'</span>secret_key <span class="token operator">=</span> <span class="token string">'7GxvrRfevA5cyiOy207J2Sn5RmIdoYyP7kixxxx'</span>conn <span class="token operator">=</span> boto.connect_s3<span class="token punctuation">(</span>        aws_access_key_id<span class="token operator">=</span>access_key,        aws_secret_access_key<span class="token operator">=</span>secret_key,        host<span class="token operator">=</span><span class="token string">'10.46.36.234'</span>, port<span class="token operator">=</span>80,        is_secure<span class="token operator">=</span>False, calling_format<span class="token operator">=</span>boto.s3.connection.OrdinaryCallingFormat<span class="token punctuation">(</span><span class="token punctuation">)</span>,       <span class="token punctuation">)</span>bucket <span class="token operator">=</span> conn.create_bucket<span class="token punctuation">(</span><span class="token string">'ceph-s3-bucket'</span><span class="token punctuation">)</span><span class="token keyword">for</span> bucket <span class="token keyword">in</span> conn.get_all_buckets<span class="token punctuation">(</span><span class="token punctuation">)</span>:    print <span class="token string">"&amp;#123;name&amp;#125; &amp;#123;created&amp;#125;"</span>.format<span class="token punctuation">(</span>        name<span class="token operator">=</span>bucket.name,        created<span class="token operator">=</span>bucket.creation_date,    <span class="token punctuation">)</span><span class="token comment" spellcheck="true">#执行</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># python s3client.py </span>ceph-s3-bucket 2021-12-05T06:17:12.784Z<span class="token comment" spellcheck="true">#上传文件也是需要编写sdk上传,相对比较麻烦 我们是用第二种方法</span></code></pre><h3 id="2-2-s3cmd访问"><a href="#2-2-s3cmd访问" class="headerlink" title="2.2 s3cmd访问"></a>2.2 s3cmd访问</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#安装s3cmd工具</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install s3cmd</span><span class="token comment" spellcheck="true">#配置</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd --configure</span>Enter new values or accept defaults <span class="token keyword">in</span> brackets with Enter.Refer to user manual <span class="token keyword">for</span> detailed description of all options.Access key and Secret key are your identifiers <span class="token keyword">for</span> Amazon S3. Leave them empty <span class="token keyword">for</span> using the <span class="token function">env</span> variables.Access Key: HWOT3KMNOG1xxxxxxxx Secret Key: 7GxvrRfevA5cyiOy207J2Sn5RmIxxxxxxxxDefault Region <span class="token punctuation">[</span>US<span class="token punctuation">]</span>: Use <span class="token string">"s3.amazonaws.com"</span> <span class="token keyword">for</span> S3 Endpoint and not modify it to the target Amazon S3.S3 Endpoint <span class="token punctuation">[</span>s3.amazonaws.com<span class="token punctuation">]</span>: 10.46.36.234Use <span class="token string">"%(bucket)s.s3.amazonaws.com"</span> to the target Amazon S3. <span class="token string">"%(bucket)s"</span> and <span class="token string">"%(location)s"</span> vars can be used<span class="token keyword">if</span> the target S3 system supports dns based buckets.DNS-style bucket+hostname:port template <span class="token keyword">for</span> accessing a bucket <span class="token punctuation">[</span>%<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>s.s3.amazonaws.com<span class="token punctuation">]</span>: 10.46.36.234:80/%<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>s       Encryption password is used to protect your files from readingby unauthorized persons <span class="token keyword">while</span> <span class="token keyword">in</span> transfer to S3Encryption password: Path to GPG program <span class="token punctuation">[</span>/usr/bin/gpg<span class="token punctuation">]</span>: When using secure HTTPS protocol all communication with Amazon S3servers is protected from 3rd party eavesdropping. This method isslower than plain HTTP, and can only be proxied with Python 2.7 or newerUse HTTPS protocol <span class="token punctuation">[</span>Yes<span class="token punctuation">]</span>: noOn some networks all internet access must go through a HTTP proxy.Try setting it here <span class="token keyword">if</span> you can<span class="token string">'t connect to S3 directlyHTTP Proxy server name: New settings:  Access Key: HWOT3KMNOG1V2Txxxxx  Secret Key: 7GxvrRfevA5cyiOy207J2Snxxxxxxx  Default Region: US  S3 Endpoint: 10.46.36.234  DNS-style bucket+hostname:port template for accessing a bucket: 10.46.36.234:80/%(bucket)s  Encryption password:   Path to GPG program: /usr/bin/gpg  Use HTTPS protocol: False  HTTP Proxy server name:   HTTP Proxy server port: 0Test access with supplied credentials? [Y/n] yPlease wait, attempting to list all buckets...Success. Your access key and secret key worked fine :-)Now verifying that encryption works...Not configured. Never mind.Save settings? [y/N] yConfiguration saved to '</span>/root/.s3cfg'</code></pre><p>s3cmd常用命令</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#查看目前的bucket</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd ls</span>2021-12-05 06:17  s3://ceph-s3-bucket<span class="token comment" spellcheck="true">#创建bucket</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd mb s3://s3cmd-demo</span>ERROR: S3 error: 403 <span class="token punctuation">(</span>SignatureDoesNotMatch<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#如果有下面报错 需要修改s3cmd配置文件</span>signature_v2 <span class="token operator">=</span> True<span class="token comment" spellcheck="true">#将此配置开启</span><span class="token comment" spellcheck="true">#测试上传文件</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd  put /etc/hosts s3://s3cmd-demo/hosts</span>upload: <span class="token string">'/etc/hosts'</span> -<span class="token operator">></span> <span class="token string">'s3://s3cmd-demo/hosts'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span> 266 of 266   100% <span class="token keyword">in</span>    0s    15.60 KB/s  <span class="token keyword">done</span><span class="token comment" spellcheck="true">#查看文件</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd ls s3://s3cmd-demo</span>2021-12-05 06:49          380  s3://s3cmd-demo/fstab2021-12-05 06:50          266  s3://s3cmd-demo/hosts<span class="token comment" spellcheck="true">#上传目录</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd  put /etc s3://s3cmd-demo/etc/ --recursive</span><span class="token comment" spellcheck="true">#查看目录文件</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd ls s3://s3cmd-demo/etc/etc/</span><span class="token comment" spellcheck="true">#下载文件</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd get s3://s3cmd-demo/etc/etc/yum.conf yum.download</span>download: <span class="token string">'s3://s3cmd-demo/etc/etc/yum.conf'</span> -<span class="token operator">></span> <span class="token string">'yum.download'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span> 1066 of 1066   100% <span class="token keyword">in</span>    0s    65.45 KB/s  <span class="token keyword">done</span><span class="token comment" spellcheck="true">#删除文件</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd rm --recursive s3://s3cmd-demo/etc/</span></code></pre><p>#注 如果有测试上传报错 416 可以参考下面的方法修复</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd put /etc/fstab s3://s3cmd-demo/fstab</span>upload: <span class="token string">'/etc/fstab'</span> -<span class="token operator">></span> <span class="token string">'s3://s3cmd-demo/fstab'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>380 of 380   100% <span class="token keyword">in</span>    0s   800.52 B/s  <span class="token keyword">done</span>ERROR: S3 error: 416 <span class="token punctuation">(</span>InvalidRange<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#修改配置文件global添加</span>mon_max_pg_per_osd <span class="token operator">=</span> 300<span class="token comment" spellcheck="true">#将配置文件分发其他节点</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy --overwrite-conf config push node-1 node-2 node-3</span><span class="token comment" spellcheck="true">#重启mon和mgr进程所有节点都需要重启</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl restart ceph-mgr@node-1</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl restart ceph-mon@node-1</span><span class="token comment" spellcheck="true">#再次测试应该就可以正常上传了</span></code></pre><h1 id="三-使用swift方式访问ceph"><a href="#三-使用swift方式访问ceph" class="headerlink" title="三.使用swift方式访问ceph"></a>三.使用swift方式访问ceph</h1><h3 id="3-1-配置swift"><a href="#3-1-配置swift" class="headerlink" title="3.1 配置swift"></a>3.1 配置swift</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#根据之前的用户创建swift用户</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># radosgw-admin subuser create --uid ceph-s3-user  --subuser=ceph-s3-user:swift --access=full</span><span class="token comment" spellcheck="true">#创建公私钥</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># radosgw-admin key create --subuser=ceph-s3-user:swift --key-type=swift --gen-secret</span><span class="token comment" spellcheck="true">#安装swift客户端工具</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install python-pip</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># pip install --upgrade python-swiftclient</span></code></pre><h3 id="3-2-swift客户端使用"><a href="#3-2-swift客户端使用" class="headerlink" title="3.2 swift客户端使用"></a>3.2 swift客户端使用</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#直接访问</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift -A http://10.46.36.234/auth -U ceph-s3-user:swift -K SgNvHZvkjpDIHudg281qb3rbA33DJd39UoCYnHbl list</span><span class="token comment" spellcheck="true">#直接访问参数比较多 比较麻烦可以设置环境变量访问</span><span class="token function">export</span> ST_AUTH<span class="token operator">=</span>http://10.46.36.234/auth<span class="token function">export</span> ST_USER<span class="token operator">=</span>ceph-s3-user:swift<span class="token function">export</span> ST_KEY<span class="token operator">=</span>SgNvHZvkjpDIHudg281qb3rbA33DJd39UoCYnHbl<span class="token comment" spellcheck="true">#直接命令访问</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift list</span>ceph-s3-buckets3cmd-demo<span class="token comment" spellcheck="true">#创建bucket</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift post swift-demo</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift list</span>ceph-s3-buckets3cmd-demoswift-dem<span class="token comment" spellcheck="true">#上传文件</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift upload swift-demo/hosts /etc/hosts</span>hosts/etc/hosts<span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift list swift-demo </span>hosts/etc/hosts<span class="token comment" spellcheck="true">#上传文件夹</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift upload swift-demo/etc/ /etc</span><span class="token comment" spellcheck="true">#下载文件</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift download swift-demo etc/etc/passwd </span>etc/etc/passwd <span class="token punctuation">[</span>auth 0.004s, headers 0.007s, total 0.007s, 0.336 MB/s<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#删除文件</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift delete swift-demo etc/etc/yum.repos.d/CentOS-fasttrack.repo</span>etc/etc/yum.repos.d/CentOS-fasttrack.repo</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ceph 文件系统使用</title>
      <link href="/bff996ef/"/>
      <url>/bff996ef/</url>
      
        <content type="html"><![CDATA[<h1 id="一-配置filesystem"><a href="#一-配置filesystem" class="headerlink" title="一.配置filesystem"></a>一.配置filesystem</h1><h3 id="1-1-配置mds服务"><a href="#1-1-配置mds服务" class="headerlink" title="1.1 配置mds服务"></a>1.1 配置mds服务</h3><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy mds create node</span>---<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> Created symlink from /etc/systemd/system/ceph-mds.target.wants/ceph-mds@node.service to /usr/lib/systemd/system/ceph-mds@.service.<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: systemctl start ceph-mds@node<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: systemctl <span class="token function">enable</span> ceph.target</code></pre><h3 id="1-2-创建pool"><a href="#1-2-创建pool" class="headerlink" title="1.2 创建pool"></a>1.2 创建pool</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#需要创建两个pool分别存储metadata和data</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool create cephfs_metadata 16 16</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool create cephfs_data 10 10</span><span class="token comment" spellcheck="true">#查看pool</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool ls</span>huhuhahei.rgw.rootdefault.rgw.controldefault.rgw.metadefault.rgw.logdefault.rgw.buckets.indexdefault.rgw.buckets.datacephfs_metadatacephfs_data<span class="token comment" spellcheck="true">#创建文件系统</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph fs new cephfs-demo cephfs_metadata cephfs_data</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph fs ls</span>name: cephfs-demo, metadata pool: cephfs_metadata, data pools: <span class="token punctuation">[</span>cephfs_data <span class="token punctuation">]</span></code></pre><h3 id="1-3-内核态挂载"><a href="#1-3-内核态挂载" class="headerlink" title="1.3 内核态挂载"></a>1.3 内核态挂载</h3><p>客户端需要这个包 可以yum安装</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rpm -qf /usr/sbin/mount.ceph</span>ceph-common-14.2.22-0.el7.x86_64</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#创建目录挂载</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /cephfs</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mount -t ceph master:6789:/ /cephfs -o name=admin</span><span class="token comment" spellcheck="true">#确认</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -Th</span>/dev/rbd1         xfs        10G   87M   10G   1% /backup10.46.8.18:6789:/ ceph       47G     0   47G   0% /cephfs<span class="token comment" spellcheck="true">#这里默认的空间大小就是ceph集群的总空间</span></code></pre><h3 id="1-4-用户态挂载"><a href="#1-4-用户态挂载" class="headerlink" title="1.4 用户态挂载"></a>1.4 用户态挂载</h3><p>需要安装包</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master cephfuse<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install ceph-fuse</span><span class="token punctuation">[</span>root@master cephfuse<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rpm -qa ceph-fuse</span>ceph-fuse-14.2.22-0.el7.x86_64<span class="token comment" spellcheck="true">#挂载</span><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /cephfuse</span><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-fuse -n client.admin -m node:6789 /cephfuse</span>ceph-fuse<span class="token punctuation">[</span>3688325<span class="token punctuation">]</span>: starting ceph client2021-12-06 14:58:36.599 7fb6268e0f80 -1 init, newargv <span class="token operator">=</span> 0x556cff6153e0 newargc<span class="token operator">=</span>9<span class="token comment" spellcheck="true">#查看</span><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -h</span>/dev/rbd1           10G   87M   10G   1% /backup10.46.8.18:6789:/   47G     0   47G   0% /cephfsceph-fuse           47G     0   47G   0% /cephfuse<span class="token comment" spellcheck="true">#之前挂载的文件也是共享的</span><span class="token punctuation">[</span>root@master cephfuse<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll</span>total 1-rw-r--r-- 1 root root 10 Dec  6 14:50 <span class="token function">test</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rabbitmq单节点安装配置</title>
      <link href="/35052cd1/"/>
      <url>/35052cd1/</url>
      
        <content type="html"><![CDATA[<h1 id="一-简介"><a href="#一-简介" class="headerlink" title="一. 简介"></a>一. 简介</h1><h3 id="1-1-RabbitMQ介绍"><a href="#1-1-RabbitMQ介绍" class="headerlink" title="1.1 RabbitMQ介绍"></a>1.1 RabbitMQ介绍</h3><p>消息系统通过将消息的发送和接收分离来实现应用程序的异步和解偶。<br>或许你正在考虑进行数据投递，非阻塞操作或推送通知。或许你想要实现发布／订阅，异步处理，或者工作队列。所有这些都属于消息系统的模式。<br>RabbitMQ是一个消息代理，一个消息系统的媒介。它可以为你的应用提供一个通用的消息发送和接收平台，并且保证消息再传输过程中的安全。<br>RabbitMQ是一个在AMQP协议标准上完整的、可复用的企业消息系统。它遵循Mozilla Public License开源协议，采用Erlang语言实现的工业级的消息队列。</p><h3 id="1-2-RabbitMQ运行原理"><a href="#1-2-RabbitMQ运行原理" class="headerlink" title="1.2 RabbitMQ运行原理"></a>1.2 RabbitMQ运行原理</h3><p>RabbitMQ的两大核心组件是Exchange和Queue，以下是它的运行原理图：<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/1943029678.png"></p><h3 id="1-3-RabbitMQ重要术语"><a href="#1-3-RabbitMQ重要术语" class="headerlink" title="1.3 RabbitMQ重要术语"></a>1.3 RabbitMQ重要术语</h3><ol><li>Server(broker): 接受客户端连接，实现AMQP消息队列和路由功能的进程。</li><li>Vitual Host: 这是一个虚拟概念，类似于权限控制组，一个Vitual Host里面可以有若干个Exchange和Queue，但是权限控制的最小粒度是Vitual Host。</li><li>Exchange: 接收生产者发送的消息，并根据Binding规则将消息路由给服务器中的队列。ExchangeType决定了Exchange路由消息的行为，例如，在RabbitMQ中，ExchangeType有direct、Fanout和Topic三种，不同类型的Exchange路由的行为是不一样的。</li><li>Message Queue: 消息队列，用于存储还未被消费者消费的消息。</li><li>Message: 由Header和Body组成，Header是由生产者添加的各种属性的集合，包括Message是否被持久化、由哪个Message Queue接受、优先级是多少等。而body是真正需要传输的APP数据。</li><li>BindingKey: 所谓绑定就是将一个特定的一个Exchange和一个特定的Queue绑定起来，绑定关键字称为BindingKey。</li></ol><h1 id="二-安装"><a href="#二-安装" class="headerlink" title="二.安装"></a>二.安装</h1><p>rabbitmq是通过Erlang语言编写所以需要Erlang环境</p><h3 id="2-1-配置Erlang环境"><a href="#2-1-配置Erlang环境" class="headerlink" title="2.1 配置Erlang环境"></a>2.1 配置Erlang环境</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#安装依赖</span>yum <span class="token function">install</span> –y epel-release ncurses-devel gcc openssl openssl-devel socat</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#下载安装包</span><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/tar包/Rabbitmq/otp_src_20.0.tar.gz</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#编译安装</span><span class="token function">tar</span> -xzvf otp_src_20.0.tar.gz<span class="token function">cd</span> otp_src_20.0./configure -prefix<span class="token operator">=</span>/usr/local/erlang<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#配置环境变量</span><span class="token function">vi</span> /etc/profileER_LANG<span class="token operator">=</span>/usr/local/erlang/binPATH<span class="token operator">=</span><span class="token variable">$PATH</span><span class="token keyword">:</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$JRE_HOME</span>/bin:<span class="token variable">$MAVEN_HOME</span>/bin:<span class="token variable">$ER_LANG</span><span class="token keyword">:</span><span class="token function">source</span> /etc/profile</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#测试</span>erl -versionErlang <span class="token punctuation">(</span>SMP,ASYNC_THREADS<span class="token punctuation">)</span> <span class="token punctuation">(</span>BEAM<span class="token punctuation">)</span> emulator version 10.4</code></pre><h3 id="2-2-安装rabbitmq"><a href="#2-2-安装rabbitmq" class="headerlink" title="2.2 安装rabbitmq"></a>2.2 安装rabbitmq</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#下载rpm包</span><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/tar包/Rabbitmq/rabbitmq-server-3.6.15-1.el7.noarch.rpm yum <span class="token function">install</span> rabbitmq-server-3.6.15-1.el7.noarch.rpm</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#启动并配置开机自启</span>systemctl start rabbitmq-serversystemctl <span class="token function">enable</span> rabbitmq-serversystemctl status rabbitmq-server● rabbitmq-server.service - LSB: Enable AMQP <span class="token function">service</span> provided by RabbitMQ broker   Loaded: loaded <span class="token punctuation">(</span>/etc/rc.d/init.d/rabbitmq-server<span class="token punctuation">;</span> bad<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu 2021-12-23 11:10:55 CST<span class="token punctuation">;</span> 20min ago     Docs: man:systemd-sysv-generator<span class="token punctuation">(</span>8<span class="token punctuation">)</span>   CGroup: /system.slice/rabbitmq-server.service           ├─43082 /bin/sh /etc/rc.d/init.d/rabbitmq-server start           ├─43101 /bin/bash -c <span class="token function">ulimit</span> -S -c 0 <span class="token operator">></span>/dev/null 2<span class="token operator">></span><span class="token operator">&amp;</span>1 <span class="token punctuation">;</span> /usr/<span class="token punctuation">..</span>.           └─43103 /bin/sh /usr/sbin/rabbitmq-serverDec 23 11:10:45 10-46-155-130 systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting LSB: Enable AMQP s<span class="token punctuation">..</span><span class="token punctuation">..</span>Dec 23 11:10:45 10-46-155-130 su<span class="token punctuation">[</span>42974<span class="token punctuation">]</span>: <span class="token punctuation">(</span>to rabbitmq<span class="token punctuation">)</span> root on none</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#安装插件</span>rabbitmq-plugins <span class="token function">enable</span> rabbitmq_management<span class="token comment" spellcheck="true">#赋予权限</span><span class="token function">chown</span> -R rabbitmq:rabbitmq /var/lib/rabbitmq/<span class="token comment" spellcheck="true">#添加用户</span>rabbitmqctl add_user admin passwordrabbitmqctl set_user_tags admin administratorrabbitmqctl set_permissions -p / admin “.*” “.*” “.*”</code></pre><p>访问测试<br>ip+15672<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/1987447132.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 中间件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rabbitmq集群配置</title>
      <link href="/acda943d/"/>
      <url>/acda943d/</url>
      
        <content type="html"><![CDATA[<h1 id="一-环境准备"><a href="#一-环境准备" class="headerlink" title="一. 环境准备"></a>一. 环境准备</h1><p>环境如下</p><table><thead><tr><th>主机名</th><th>ip</th></tr></thead><tbody><tr><td>rabbitmq01</td><td>10.9.132.128</td></tr><tr><td>rabbitmq02</td><td>10.9.67.10</td></tr></tbody></table><p>单节点部署可以参考上一篇文章</p><h1 id="二-部署集群"><a href="#二-部署集群" class="headerlink" title="二. 部署集群"></a>二. 部署集群</h1><h3 id="2-1-修改host"><a href="#2-1-修改host" class="headerlink" title="2.1 修改host"></a>2.1 修改host</h3><pre class=" language-bash"><code class="language-bash">10.9.132.128 rabbitmq0110.9.67.10 rabbitmq02</code></pre><h3 id="2-2-修改erlang-cookie文件中cookie值一致"><a href="#2-2-修改erlang-cookie文件中cookie值一致" class="headerlink" title="2.2 修改erlang.cookie文件中cookie值一致"></a>2.2 修改erlang.cookie文件中cookie值一致</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> /var/lib/rabbitmq/.erlang.cookie YIHXTAVFVTEWSDSXWVLY<span class="token function">chmod</span> 600 /var/lib/rabbitmq/.erlang.cookie</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#查看集群状态</span>rabbitmqctl cluster_statusCluster status of node rabbit@rabbitmq01<span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;nodes,[&amp;#123;disc,[rabbit@rabbitmq01]&amp;#125;]&amp;#125;,</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;running_nodes,[rabbit@rabbitmq01]&amp;#125;,</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;cluster_name,&lt;&lt;"rabbit@rabbitmq01">>&amp;#125;,</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;partitions,[]&amp;#125;,</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;alarms,[&amp;#123;rabbit@rabbitmq01,[]&amp;#125;]&amp;#125;]</span><span class="token comment" spellcheck="true">#停止服务</span>rabbitmqctl stop_app<span class="token comment" spellcheck="true">#加入集群</span>rabbitmqctl join_cluster --ram rabbit@rabbitmq02<span class="token comment" spellcheck="true">#启动服务</span>rabbitmqctl start_app<span class="token comment" spellcheck="true">#再次查看集群</span>rabbitmqctl cluster_statusCluster status of node rabbit@rabbitmq01<span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;nodes,[&amp;#123;disc,[rabbit@rabbitmq02]&amp;#125;,&amp;#123;ram,[rabbit@rabbitmq01]&amp;#125;]&amp;#125;,</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;running_nodes,[rabbit@rabbitmq02,rabbit@rabbitmq01]&amp;#125;,</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;cluster_name,&lt;&lt;"rabbit@rabbitmq01">>&amp;#125;,</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;partitions,[]&amp;#125;,</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;alarms,[&amp;#123;rabbit@rabbitmq02,[]&amp;#125;,&amp;#123;rabbit@rabbitmq01,[]&amp;#125;]&amp;#125;]</span></code></pre><h3 id="2-3-开启HA-镜像队列"><a href="#2-3-开启HA-镜像队列" class="headerlink" title="2.3 开启HA 镜像队列"></a>2.3 开启HA 镜像队列</h3><pre class=" language-bash"><code class="language-bash">rabbitmqctl set_policy -p / ha <span class="token string">"^"</span> <span class="token string">'&amp;#123;"ha-mode":"all"&amp;#125;'</span>Setting policy <span class="token string">"ha"</span> <span class="token keyword">for</span> pattern <span class="token string">"^"</span> to <span class="token string">"&amp;#123;\"ha-mode\":\"all\"&amp;#125;"</span> with priority <span class="token string">"0"</span>rabbitmqctl list_policies -p /Listing policies/haall^<span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;"ha-mode":"all"&amp;#125;0</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 中间件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Node.js环境配置</title>
      <link href="/9676ee43/"/>
      <url>/9676ee43/</url>
      
        <content type="html"><![CDATA[<h1 id="一-下载安装包"><a href="#一-下载安装包" class="headerlink" title="一 下载安装包"></a>一 下载安装包</h1><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/tar包/Node.js/node-v10.15.3-linux-x64.tar.xz<span class="token comment" spellcheck="true">#官网下载地址 http://maven.apache.org/download.cgi</span></code></pre><h1 id="二-解压配置环境"><a href="#二-解压配置环境" class="headerlink" title="二 解压配置环境"></a>二 解压配置环境</h1><pre class=" language-bash"><code class="language-bash"><span class="token function">tar</span> -xvf node-v10.15.3-linux-x64.tar.xz<span class="token function">mv</span> node-v10.15.3-linux-x64 nodejs<span class="token function">cd</span> nodejs/<span class="token function">ln</span> -s /root/nodejs/bin/node /usr/local/bin/node<span class="token function">ln</span> -s /root/nodejs/bin/npm /usr/local/bin/npm</code></pre><h1 id="三-测试"><a href="#三-测试" class="headerlink" title="三 测试"></a>三 测试</h1><pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> -v6.4.1node -vv10.15.3</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jdk1.8&amp;Maven环境配置</title>
      <link href="/9f29a45e/"/>
      <url>/9f29a45e/</url>
      
        <content type="html"><![CDATA[<h1 id="一-配置JDK环境"><a href="#一-配置JDK环境" class="headerlink" title="一 配置JDK环境"></a>一 配置JDK环境</h1><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#下载rpm包</span><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/tar包/tomcat/jdk-8u171-linux-x64.rpm</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#安装</span>rpm -ivh jdk-8u171-linux-x64.rpm</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#配置环境变量</span><span class="token function">export</span> JAVA_HOME<span class="token operator">=</span>/usr/java/jdk1.8.0_171-amd64<span class="token function">export</span> CLASSPATH<span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/lib/tools.jar:<span class="token variable">$JAVA_HOME</span>/lib/dt.jar<span class="token function">export</span> PATH<span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$PATH</span><span class="token comment" spellcheck="true">#生效</span><span class="token function">source</span> /etc/profile</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#测试</span>java -versionjava version <span class="token string">"1.8.0_171"</span>Java<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> SE Runtime Environment <span class="token punctuation">(</span>build 1.8.0_171-b11<span class="token punctuation">)</span>Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> 64-Bit Server VM <span class="token punctuation">(</span>build 25.171-b11, mixed mode<span class="token punctuation">)</span></code></pre><h1 id="二-Maven配置"><a href="#二-Maven配置" class="headerlink" title="二 Maven配置"></a>二 Maven配置</h1><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#下载</span><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/tar包/Maven/apache-maven-3.8.4-bin.tar.gz</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#环境配置</span><span class="token function">tar</span> xf apache-maven-3.8.4-bin.tar.gz<span class="token function">mv</span> apache-maven-3.8.4 /usr/local/<span class="token comment" spellcheck="true">#修改环境变量</span><span class="token function">export</span> MAVEN_HOME<span class="token operator">=</span>/usr/local/apache-maven-3.6.1<span class="token function">export</span> PATH<span class="token operator">=</span><span class="token variable">$MAVEN_HOME</span>/bin:<span class="token variable">$PATH</span><span class="token comment" spellcheck="true">#生效</span><span class="token function">source</span> /etc/profile</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#测试</span>mvn -vApache Maven 3.8.4 <span class="token punctuation">(</span>9b656c72d54e5bacbed989b64718c159fe39b537<span class="token punctuation">)</span>Maven home: /usr/local/apache-maven-3.8.4Java version: 1.8.0_171, vendor: Oracle Corporation, runtime: /usr/java/jdk1.8.0_171-amd64/jreDefault locale: en_US, platform encoding: UTF-8OS name: <span class="token string">"linux"</span>, version: <span class="token string">"3.10.0-1160.49.1.el7.x86_64"</span>, arch: <span class="token string">"amd64"</span>, family: <span class="token string">"unix"</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xxl-job分布式调度系统部署</title>
      <link href="/cc07b68b/"/>
      <url>/cc07b68b/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h1><h3 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h3><p>XXL-JOB是一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/1565206452.png"></p><h1 id="二-项目部署"><a href="#二-项目部署" class="headerlink" title="二.项目部署"></a>二.项目部署</h1><h3 id="2-1-拉取代码构建"><a href="#2-1-拉取代码构建" class="headerlink" title="2.1 拉取代码构建"></a>2.1 拉取代码构建</h3><p><a href="https://github.com/xuxueli/xxl-job">Github地址</a><br>可以直接在这里下载打好的压缩包 下载完成之后解压即可<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/1367955538.jpg"></p><p>maven构建(这里需要java和maven环境 没有的可以看之前的文档)</p><pre class=" language-bash"><code class="language-bash">/usr/local/apache-maven-3.8.4/bin/mvn -f pom.xml clean <span class="token function">install</span></code></pre><p>构建完成会<code>xxl-job-admin</code>出现这个<code>target</code>目录下面是构建完成的jar包</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master target<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll</span>total 39992drwxr-xr-x 7 root root      131 Jan 11 13:46 classesdrwxr-xr-x 3 root root       25 Jan 11 13:46 generated-sourcesdrwxr-xr-x 2 root root       28 Jan 11 13:46 maven-archiverdrwxr-xr-x 3 root root       35 Jan 11 13:46 maven-status-rw-r--r-- 1 root root 38997788 Jan 11 13:47 xxl-job-admin-2.3.0.jar-rw-r--r-- 1 root root  1950567 Jan 11 13:46 xxl-job-admin-2.3.0.jar.original</code></pre><h3 id="2-2-配置数据库"><a href="#2-2-配置数据库" class="headerlink" title="2.2 配置数据库"></a>2.2 配置数据库</h3><p>创建用户和数据库</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>xxl_job<span class="token punctuation">`</span> <span class="token keyword">default</span> <span class="token keyword">character set</span> utf8mb4 <span class="token keyword">collate</span> utf8mb4_unicode_ci<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token punctuation">`</span>xxl_job<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token punctuation">`</span>xxl_job<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'xxljob'</span>@'<span class="token operator">%</span><span class="token string">' IDENTIFIED BY '</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>'<span class="token punctuation">;</span></code></pre><p>初始化sql</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># XXL-JOB v2.3.1-SNAPSHOT</span><span class="token comment" spellcheck="true"># Copyright (c) 2015-present, xuxueli.</span><span class="token keyword">CREATE</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>xxl_job<span class="token punctuation">`</span> <span class="token keyword">default</span> <span class="token keyword">character set</span> utf8mb4 <span class="token keyword">collate</span> utf8mb4_unicode_ci<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token punctuation">`</span>xxl_job<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>job_group<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器主键ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>job_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>add_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>author<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'作者'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>alarm_email<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'报警邮件'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>schedule_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'NONE'</span> <span class="token keyword">COMMENT</span> <span class="token string">'调度类型'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>schedule_conf<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'调度配置，值含义取决于调度类型'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>misfire_strategy<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'DO_NOTHING'</span> <span class="token keyword">COMMENT</span> <span class="token string">'调度过期策略'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_route_strategy<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器路由策略'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_handler<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器任务handler'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_param<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器任务参数'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_block_strategy<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'阻塞处理策略'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_timeout<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'任务执行超时时间，单位秒'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_fail_retry_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'失败重试次数'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUE类型'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_source<span class="token punctuation">`</span> <span class="token keyword">mediumtext</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUE源代码'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_remark<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUE备注'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_updatetime<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUE更新时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>child_jobid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'子任务ID，多个逗号分隔'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_status<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'调度状态：0-停止，1-运行'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_last_time<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'上次调度时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_next_time<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'下次调度时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_log<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>job_group<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器主键ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>job_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'任务，主键ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_address<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器地址，本次执行的地址'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_handler<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器任务handler'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_param<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器任务参数'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_sharding_param<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器任务分片参数，格式如 1/2'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_fail_retry_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'失败重试次数'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'调度-时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_code<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'调度-结果'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_msg<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'调度-日志'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>handle_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行-时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>handle_code<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行-状态'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>handle_msg<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行-日志'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>alarm_status<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'告警状态：0-默认、1-无需告警、2-告警成功、3-告警失败'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>I_trigger_time<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trigger_time<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>I_handle_code<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>handle_code<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_log_report<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_day<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'调度-时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>running_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'运行中-日志数量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>suc_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行成功-日志数量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>fail_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行失败-日志数量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>i_trigger_day<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trigger_day<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_logglue<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>job_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'任务，主键ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUE类型'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_source<span class="token punctuation">`</span> <span class="token keyword">mediumtext</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUE源代码'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_remark<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUE备注'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>add_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_registry<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>registry_group<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>registry_key<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>registry_value<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>i_g_k_v<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>registry_group<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>registry_key<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>registry_value<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_group<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器AppName'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>title<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器名称'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>address_type<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器地址类型：0=自动注册、1=手动录入'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>address_list<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'执行器地址列表，多地址逗号分隔'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_user<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'账号'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'密码'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'角色：0-普通用户、1-管理员'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>permission<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'权限：执行器ID列表，多个逗号分割'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>i_username<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_lock<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>lock_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'锁名称'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>lock_name<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>xxl_job_group<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>title<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address_list<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'xxl-job-executor-sample'</span><span class="token punctuation">,</span> <span class="token string">'示例执行器'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'2018-11-03 22:21:31'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>xxl_job_info<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>job_group<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>job_desc<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>add_time<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>author<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>alarm_email<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>schedule_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>schedule_conf<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>misfire_strategy<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_route_strategy<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_handler<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_param<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_block_strategy<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_timeout<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_fail_retry_count<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>glue_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>glue_source<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>glue_remark<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>glue_updatetime<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>child_jobid<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'测试任务1'</span><span class="token punctuation">,</span> <span class="token string">'2018-11-03 22:21:31'</span><span class="token punctuation">,</span> <span class="token string">'2018-11-03 22:21:31'</span><span class="token punctuation">,</span> <span class="token string">'XXL'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'CRON'</span><span class="token punctuation">,</span> <span class="token string">'0 0 0 * * ? *'</span><span class="token punctuation">,</span> <span class="token string">'DO_NOTHING'</span><span class="token punctuation">,</span> <span class="token string">'FIRST'</span><span class="token punctuation">,</span> <span class="token string">'demoJobHandler'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'SERIAL_EXECUTION'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'BEAN'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'GLUE代码初始化'</span><span class="token punctuation">,</span> <span class="token string">'2018-11-03 22:21:31'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>xxl_job_user<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>permission<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'e10adc3949ba59abbe56e057f20f883e'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>xxl_job_lock<span class="token punctuation">`</span> <span class="token punctuation">(</span> <span class="token punctuation">`</span>lock_name<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span> <span class="token string">'schedule_lock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">commit</span><span class="token punctuation">;</span></code></pre><h3 id="2-3-交付k8s"><a href="#2-3-交付k8s" class="headerlink" title="2.3 交付k8s"></a>2.3 交付k8s</h3><p>deploy</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin  <span class="token key atrule">name</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> XXL_JOB_ACCESSTOKEN          <span class="token key atrule">value</span><span class="token punctuation">:</span> *****************        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPRING_DATASOURCE_URL          <span class="token key atrule">value</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//mysql.blog.svc.cluster.local<span class="token punctuation">:</span>3306/xxl_job<span class="token punctuation">?</span>Unicode=true<span class="token important">&amp;characterEncoding</span>=UTF<span class="token punctuation">-</span>8<span class="token important">&amp;useSSL</span>=false        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPRING_DATASOURCE_USERNAME          <span class="token key atrule">value</span><span class="token punctuation">:</span> xxljob        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPRING_DATASOURCE_PASSWORD          <span class="token key atrule">value</span><span class="token punctuation">:</span> *********        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/xxl<span class="token punctuation">-</span>job<span class="token punctuation">:</span>v2.3.0        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> harbor<span class="token punctuation">-</span>huhuhahei        <span class="token key atrule">name</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span></code></pre><p>svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> xxljob<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> xxljob    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><p><code>kubectl apply -f .</code> 部署</p><h3 id="2-4-查看"><a href="#2-4-查看" class="headerlink" title="2.4 查看"></a>2.4 查看</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/1083008058.png"></p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Neo4j 图形数据库部署</title>
      <link href="/b7e47e6a/"/>
      <url>/b7e47e6a/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h1><h3 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h3><p><a href="https://baike.baidu.com/item/Neo4j">Neo4j</a>是一个高性能的,NOSQL图形数据库，它将结构化数据存储在网络上而不是表中。它是一个<a href="https://baike.baidu.com/item/%E5%B5%8C%E5%85%A5%E5%BC%8F/575465">嵌入式</a>的、基于<a href="https://baike.baidu.com/item/%E7%A3%81%E7%9B%98/2842227">磁盘</a>的、具备完全的事务特性的Java持久化引擎，但是它将结构化数据存储在网络(从数学角度叫做图)上而不是表中。Neo4j也可以被看作是一个高性能的图引擎，该引擎具有成熟数据库的所有特性。程序员工作在一个面向对象的、灵活的网络结构下而不是严格、静态的表中——但是他们可以享受到具备完全的事务特性、企业级的数据库的所有好处。</p><h1 id="二-安装配置"><a href="#二-安装配置" class="headerlink" title="二.安装配置"></a>二.安装配置</h1><h3 id="2-1-部署master节点"><a href="#2-1-部署master节点" class="headerlink" title="2.1 部署master节点"></a>2.1 部署master节点</h3><p>master使用sts部署</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> neo4j  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2 </span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core        <span class="token key atrule">image</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">:</span>3.5.5<span class="token punctuation">-</span>enterprise   <span class="token comment" spellcheck="true"># 官方镜像，3.5.5企业版</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 这里通过env，配置镜像环境参数，这是因为此镜像是通过这样来进行配置参数的</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_ACCEPT_LICENSE_AGREEMENT    <span class="token comment" spellcheck="true"># 接受证书协议，必须的</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"yes"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_dbms_connectors_default__advertised__address  <span class="token comment" spellcheck="true"># 指定自身pod的ip地址，默认为localhost，在集群中必须注明自身地址，这里直接用ip</span>            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>              <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.podIP          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_dbms_mode  <span class="token comment" spellcheck="true"># 节点的模式，选择CORE，就是核心节点</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"CORE"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_AUTH   <span class="token comment" spellcheck="true"># 一定要自定义初始验证的用户名/密码</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"neo4j/*******"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_minimum__core__cluster__size__at__formation            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"2"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_minimum__core__cluster__size__at__runtime            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"2"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_discovery__type  <span class="token comment" spellcheck="true"># 默认集群发现方式为LIST，这里写不写都行</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"LIST"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_initial__discovery__members  <span class="token comment" spellcheck="true"># 手动写明集群中所有成员的ip:port，5000端口为集群发现端口</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"neo4j-core-0.neo4j.svc.cluster.local:5000,neo4j-core-1.neo4j.svc.cluster.local:5000"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_discovery__advertised__address  <span class="token comment" spellcheck="true"># 下面这三个必须定义，为节点自身的ip:port，相当于节点自身的名称，因为默认是会用自身hostname，但是在k8s中，无法单单通过hostname解析到ip地址，这样定义的自身地址会无法识别</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> $(NEO4J_dbms_connectors_default__advertised__address)<span class="token punctuation">:</span><span class="token number">5000</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causalClustering_transactionAdvertisedAddress            <span class="token key atrule">value</span><span class="token punctuation">:</span> $(NEO4J_dbms_connectors_default__advertised__address)<span class="token punctuation">:</span><span class="token number">6000</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causalClustering_raftAdvertisedAddress            <span class="token key atrule">value</span><span class="token punctuation">:</span> $(NEO4J_dbms_connectors_default__advertised__address)<span class="token punctuation">:</span><span class="token number">7000</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/neo4j  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ReadWriteOnce      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 50Gi      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>storageclass      <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem</code></pre><p>master节点svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> neo4j<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort      <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7474</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31474</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7474</span>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">name</span><span class="token punctuation">:</span> blot      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7687</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31687</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7687</span></code></pre><h3 id="2-2-部署slave节点"><a href="#2-2-部署slave节点" class="headerlink" title="2.2 部署slave节点"></a>2.2 部署slave节点</h3><p>slave使用deploy部署</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> neo4j  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica        <span class="token key atrule">image</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">:</span>3.5.5<span class="token punctuation">-</span>enterprise        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">env</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_ACCEPT_LICENSE_AGREEMENT            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"yes"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_dbms_connectors_default__advertised__address            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>              <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.podIP          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_dbms_mode   <span class="token comment" spellcheck="true"># 指定模式为只读节点模式</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"READ_REPLICA"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_AUTH            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"neo4j/*******"</span>             <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_discovery__type            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"LIST"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_initial__discovery__members            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"neo4j-core-0.neo4j.svc.cluster.local:5000,neo4j-core-1.neo4j.svc.cluster.local:5000"</span></code></pre><p>slave svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> neo4j<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7687</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7687</span></code></pre><p>创建namespace并部署</p><pre class=" language-yaml"><code class="language-yaml">kubectl create ns neo4jkubectl apply <span class="token punctuation">-</span>f .</code></pre><h3 id="2-3-web页面访问"><a href="#2-3-web页面访问" class="headerlink" title="2.3 web页面访问"></a>2.3 web页面访问</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/1622614954.png"></p>]]></content>
      
      
      <categories>
          
          <category> Databases </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Databases </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitlab k8s部署</title>
      <link href="/5a0dac76/"/>
      <url>/5a0dac76/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h1><h3 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h3><p>GitLab 是一个用于仓库管理系统的开源项目，使用<a href="https://baike.baidu.com/item/Git">Git</a>作为代码管理工具，并在此基础上搭建起来的Web服务。安装方法是参考GitLab在GitHub上的Wiki页面。</p><h1 id="二-部署"><a href="#二-部署" class="headerlink" title="二.部署"></a>二.部署</h1><h3 id="2-1-创建持久化目录"><a href="#2-1-创建持久化目录" class="headerlink" title="2.1 创建持久化目录"></a>2.1 创建持久化目录</h3><pre class=" language-yaml"><code class="language-yaml">mkdir /data/&amp;<span class="token comment" spellcheck="true">#123;gitlab_etc,gitlab_log,gitlab_opt,gitlab_postgresql_data&amp;#125;</span></code></pre><h3 id="2-2-创建命名空间"><a href="#2-2-创建命名空间" class="headerlink" title="2.2 创建命名空间"></a>2.2 创建命名空间</h3><pre class=" language-yaml"><code class="language-yaml">kubectl create namespace gitlab</code></pre><h3 id="2-3-配置postgresql和redis"><a href="#2-3-配置postgresql和redis" class="headerlink" title="2.3 配置postgresql和redis"></a>2.3 配置postgresql和redis</h3><p>postgresql 配置</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># pv</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>data  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>data<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/gitlab_postgresql_data    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18<span class="token comment" spellcheck="true"># pvc</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>data<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5432</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab      <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab        <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>12.6<span class="token punctuation">-</span>alpine          <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_USER              <span class="token key atrule">value</span><span class="token punctuation">:</span> gitlab            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_DB              <span class="token key atrule">value</span><span class="token punctuation">:</span> gitlabhq_production            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_PASSWORD              <span class="token key atrule">value</span><span class="token punctuation">:</span> bogeusepg            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5432</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> exec pg_isready <span class="token punctuation">-</span>U gitlab <span class="token punctuation">-</span>h 127.0.0.1 <span class="token punctuation">-</span>p 5432 <span class="token punctuation">-</span>d gitlabhq_production            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">110</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> exec pg_isready <span class="token punctuation">-</span>U gitlab <span class="token punctuation">-</span>h 127.0.0.1 <span class="token punctuation">-</span>p 5432 <span class="token punctuation">-</span>d gitlabhq_production            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">20</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">resources</span><span class="token punctuation">:</span>            <span class="token key atrule">requests</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi            <span class="token key atrule">limits</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/postgresql/data      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc</code></pre><p>redis 配置</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> backend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> backend<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> backend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab      <span class="token key atrule">tier</span><span class="token punctuation">:</span> backend  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab        <span class="token key atrule">tier</span><span class="token punctuation">:</span> backend    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>6.2.0<span class="token punctuation">-</span>alpine3.13          <span class="token key atrule">name</span><span class="token punctuation">:</span> redis          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">"redis-server"</span>          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">"--requirepass"</span>            <span class="token punctuation">-</span> <span class="token string">"bogeuseredis"</span><span class="token comment" spellcheck="true">#          resources:</span><span class="token comment" spellcheck="true">#            requests:</span><span class="token comment" spellcheck="true">#              cpu: "1"</span><span class="token comment" spellcheck="true">#              memory: 2Gi</span><span class="token comment" spellcheck="true">#            limits:</span><span class="token comment" spellcheck="true">#              cpu: "1"</span><span class="token comment" spellcheck="true">#              memory: 2Gi</span>          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> redis          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> <span class="token string">"redis-cli ping"</span>            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> <span class="token string">"redis-cli ping"</span>            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> /bin/sh        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          ulimit -n 65536          mount -o remount rw /sys          echo never > /sys/kernel/mm/transparent_hugepage/enabled          mount -o remount rw /proc/sys          echo 2000 > /proc/sys/net/core/somaxconn          echo 1 > /proc/sys/vm/overcommit_memory</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/acs/busybox<span class="token punctuation">:</span>v1.29.2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>redis        <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">procMount</span><span class="token punctuation">:</span> Default</code></pre><p>交付k8s</p><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f postgres.yaml <span class="token punctuation">-</span>n gitlabkubectl apply <span class="token punctuation">-</span>f redis.yaml <span class="token punctuation">-</span>n gitlab</code></pre><h3 id="2-4-配置gitlab"><a href="#2-4-配置gitlab" class="headerlink" title="2.4 配置gitlab"></a>2.4 配置gitlab</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># pv</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>etc  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>etc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/gitlab_etc    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18<span class="token comment" spellcheck="true"># pvc</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>etc<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>etc<span class="token comment" spellcheck="true"># pv</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>log  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>log<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/gitlab_log    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18<span class="token comment" spellcheck="true"># pvc</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>log<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>log      <span class="token comment" spellcheck="true"># pv</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>opt  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>opt<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/gitlab_opt    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18<span class="token comment" spellcheck="true"># pvc</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>opt<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>opt<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>ui      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>ssh      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">22</span>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">22</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>cb<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>admin<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> gitlab      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/gitlab<span class="token punctuation">-</span>ce<span class="token punctuation">:</span>13.8.6<span class="token punctuation">-</span>ce.0          <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab          <span class="token key atrule">resources</span><span class="token punctuation">:</span>            <span class="token key atrule">requests</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 400m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2200Mi            <span class="token key atrule">limits</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 2000m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2800Mi          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GITLAB_OMNIBUS_CONFIG              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">                postgresql['enable'] = false                gitlab_rails['db_username'] = "gitlab"                gitlab_rails['db_password'] = "bogeusepg"                gitlab_rails['db_host'] = "postgresql"                gitlab_rails['db_port'] = "5432"                gitlab_rails['db_database'] = "gitlabhq_production"                gitlab_rails['db_adapter'] = 'postgresql'                gitlab_rails['db_encoding'] = 'utf8'                redis['enable'] = false                gitlab_rails['redis_host'] = 'redis'                gitlab_rails['redis_port'] = '6379'                gitlab_rails['redis_password'] = 'bogeuseredis'                gitlab_rails['gitlab_shell_ssh_port'] = 22                external_url 'http://git.huhuhahei.cn/'                nginx['listen_port'] = 80                nginx['listen_https'] = false                #-------------------------------------------                gitlab_rails['gitlab_email_enabled'] = true                gitlab_rails['gitlab_email_from'] = 'admin@huhuhahei.cn'                gitlab_rails['gitlab_email_display_name'] = 'huhuhahei'                gitlab_rails['gitlab_email_reply_to'] = 'gitlab@boge.com'                gitlab_rails['gitlab_default_can_create_group'] = true                gitlab_rails['gitlab_username_changing_enabled'] = true                gitlab_rails['smtp_enable'] = true                gitlab_rails['smtp_address'] = "smtp.exmail.qq.com"                gitlab_rails['smtp_port'] = 465                gitlab_rails['smtp_user_name'] = "gitlab@boge.com"                gitlab_rails['smtp_password'] = "bogesendmail"                gitlab_rails['smtp_domain'] = "exmail.qq.com"                gitlab_rails['smtp_authentication'] = "login"                gitlab_rails['smtp_enable_starttls_auto'] = true                gitlab_rails['smtp_tls'] = true                #-------------------------------------------                # 关闭 promethues                prometheus['enable'] = false                # 关闭 grafana                grafana['enable'] = false                # 减少内存占用                unicorn['worker_memory_limit_min'] = "200 * 1 &lt;&lt; 20"                unicorn['worker_memory_limit_max'] = "300 * 1 &lt;&lt; 20"                # 减少 sidekiq 的并发数                sidekiq['concurrency'] = 16                # 减少 postgresql 数据库缓存                postgresql['shared_buffers'] = "256MB"                # 减少 postgresql 数据库并发数量                postgresql['max_connections'] = 8                # 减少进程数   worker=CPU核数+1                unicorn['worker_processes'] = 2                nginx['worker_processes'] = 2                puma['worker_processes'] = 2                # puma['per_worker_max_memory_mb'] = 850                # 保留3天备份的数据文件                gitlab_rails['backup_keep_time'] = 259200                #-------------------------------------------</span>          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> <span class="token string">"curl -s http://127.0.0.1/-/health|grep -w 'GitLab OK'"</span>            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">120</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> <span class="token string">"curl -s http://127.0.0.1/-/health|grep -w 'GitLab OK'"</span>            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">120</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/gitlab              <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab1            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/gitlab              <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab2            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/opt/gitlab              <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab3            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime              <span class="token key atrule">name</span><span class="token punctuation">:</span> tz<span class="token punctuation">-</span>config      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab1          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>etc<span class="token punctuation">-</span>pvc        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab2          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>log<span class="token punctuation">-</span>pvc        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab3          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>opt<span class="token punctuation">-</span>pvc        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tz<span class="token punctuation">-</span>config          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/share/zoneinfo/Asia/Shanghai      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">0</span>        <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre><p>ingress 配置</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token comment" spellcheck="true">#  annotations:</span><span class="token comment" spellcheck="true">#    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"</span><span class="token comment" spellcheck="true">#    nginx.ingress.kubernetes.io/proxy-body-size: "20m"</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> git.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix        <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">service</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab            <span class="token key atrule">port</span><span class="token punctuation">:</span>              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><p>交付k8s</p><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f gitlab_ingress.yaml <span class="token punctuation">-</span>n gitlabkubectl apply <span class="token punctuation">-</span>f gitlab.yaml <span class="token punctuation">-</span>n gitlab</code></pre><h3 id="2-5-访问测试"><a href="#2-5-访问测试" class="headerlink" title="2.5 访问测试"></a>2.5 访问测试</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/3771605948.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git常用命令总结</title>
      <link href="/3b0bf668/"/>
      <url>/3b0bf668/</url>
      
        <content type="html"><![CDATA[<h1 id="一-文件操作"><a href="#一-文件操作" class="headerlink" title="一.文件操作"></a>一.文件操作</h1><h3 id="1-1-添加"><a href="#1-1-添加" class="headerlink" title="1.1 添加"></a>1.1 添加</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> add <span class="token operator">&lt;</span>filename<span class="token operator">></span>                     //添加到暂存区（stage<span class="token punctuation">)</span><span class="token function">git</span> add <span class="token keyword">.</span>                              //全部提交到暂存区</code></pre><h3 id="1-2-提交"><a href="#1-2-提交" class="headerlink" title="1.2 提交"></a>1.2 提交</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> commit -m <span class="token operator">&lt;</span>description<span class="token operator">></span>           //提交到本地库<span class="token punctuation">(</span>必须先add<span class="token punctuation">)</span><span class="token function">git</span> commit -am                        //可提交未add文件，但是不包括未创建文件<span class="token function">git</span> commit --amend -m <span class="token string">"description"</span>                    //这个命令会将暂存区中的文件提交。 如果自上次提交以来你还未做任何修改<span class="token punctuation">(</span>例如，在上次提交后马上执行了此命令<span class="token punctuation">)</span>，那么快照会保持不变，而你所修改的只是提交信息。</code></pre><h3 id="1-3-删除"><a href="#1-3-删除" class="headerlink" title="1.3 删除"></a>1.3 删除</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> <span class="token function">rm</span> <span class="token operator">&lt;</span>file<span class="token operator">></span>             //从暂存区删除（stage<span class="token punctuation">)</span>  <span class="token function">git</span> <span class="token function">rm</span> -f <span class="token operator">&lt;</span>file<span class="token operator">></span>          //删除之前修改过并且已经放到暂存区域<span class="token function">git</span> <span class="token function">rm</span> --cached <span class="token operator">&lt;</span>file<span class="token operator">></span>    //如果把文件从暂存区域移除，但仍然希望保留在当前工作目录中，换句话说，仅是从跟踪清单中删除</code></pre><h3 id="1-4-撤销"><a href="#1-4-撤销" class="headerlink" title="1.4 撤销"></a>1.4 撤销</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> HEAD<span class="token function">git</span> HEAD~        //上一个版本<span class="token function">git</span> HEAD~100     //往上100个版本<span class="token comment" spellcheck="true">#撤销add</span><span class="token function">git</span> checkout <span class="token operator">&lt;</span>file<span class="token operator">></span>          //恢复未提交的更改<span class="token function">git</span> reset HEAD <span class="token operator">&lt;</span>file<span class="token operator">></span>        //取消之前 <span class="token function">git</span> add 添加<span class="token comment" spellcheck="true">#撤销commit</span><span class="token function">git</span> reset --hard HEAD~              //回退到上一个版本<span class="token function">git</span> reset --hard <span class="token operator">&lt;</span>commit ID<span class="token operator">></span>        //回退到指定版本</code></pre><h1 id="二-分支操作"><a href="#二-分支操作" class="headerlink" title="二.分支操作"></a>二.分支操作</h1><h3 id="2-1-创建分支"><a href="#2-1-创建分支" class="headerlink" title="2.1 创建分支"></a>2.1 创建分支</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> branch <span class="token operator">&lt;</span>branch name<span class="token operator">></span>               //创建分支<span class="token function">git</span> checkout <span class="token operator">&lt;</span>branch name<span class="token operator">></span>             //切换到分支<span class="token function">git</span> checkout -b <span class="token operator">&lt;</span>branch name<span class="token operator">></span>          //创建并切换到分支</code></pre><h3 id="2-2-删除分支"><a href="#2-2-删除分支" class="headerlink" title="2.2 删除分支"></a>2.2 删除分支</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> branch -d <span class="token operator">&lt;</span>branch name<span class="token operator">></span><span class="token function">git</span> branch -D <span class="token operator">&lt;</span>branch name<span class="token operator">></span>       //强制删除分支</code></pre><h3 id="2-3-查看分支"><a href="#2-3-查看分支" class="headerlink" title="2.3 查看分支"></a>2.3 查看分支</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> branch <span class="token operator">&lt;</span>name<span class="token operator">></span><span class="token function">git</span> branch -a      //查看所有分支<span class="token function">git</span> branch -r      //查看远程分支</code></pre><h3 id="2-4-重命名分支"><a href="#2-4-重命名分支" class="headerlink" title="2.4 重命名分支"></a>2.4 重命名分支</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> branch -m <span class="token operator">&lt;</span>old name<span class="token operator">></span> <span class="token operator">&lt;</span>new name<span class="token operator">></span></code></pre><h3 id="2-5-合并分支"><a href="#2-5-合并分支" class="headerlink" title="2.5 合并分支"></a>2.5 合并分支</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> checkout master                    //切换到master<span class="token function">git</span> merge <span class="token operator">&lt;</span>branch name<span class="token operator">></span>                //合并分支</code></pre><h1 id="三-拉取和提交"><a href="#三-拉取和提交" class="headerlink" title="三.拉取和提交"></a>三.拉取和提交</h1><h3 id="3-1-拉取数据"><a href="#3-1-拉取数据" class="headerlink" title="3.1 拉取数据"></a>3.1 拉取数据</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> pull origin master</code></pre><h3 id="3-2-推送本地数据到远程仓库"><a href="#3-2-推送本地数据到远程仓库" class="headerlink" title="3.2 推送本地数据到远程仓库"></a>3.2 推送本地数据到远程仓库</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> push origin master</code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DevOps </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s配置log-pilot收集服务日志</title>
      <link href="/2f425938/"/>
      <url>/2f425938/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h1><h3 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h3><p>Log-Pilot具有自动发现机制: 容器配置好tag后就会被采集组件发现<br>CheckPoint句柄保持的机制: 对于日志文件的句柄做跟踪<br>自动日志数据打标: 通过对容器加tag，这个tag会被记录到日志中，取出日志的时候就可以通过这个tag来区分数据<br>有效应对动态配置: 容器扩缩容的时候能够自动处理<br>日志重复和丢失以及日志源标记等问题: 通过句柄保持实现</p><h1 id="二-部署服务"><a href="#二-部署服务" class="headerlink" title="二.部署服务"></a>二.部署服务</h1><h3 id="2-1-配置log-pilot"><a href="#2-1-配置log-pilot" class="headerlink" title="2.1 配置log-pilot"></a>2.1 配置log-pilot</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>pilot  <span class="token key atrule">name</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>pilot  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>pilot  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>pilot    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NODE_NAME          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>              <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> spec.nodeName        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PILOT_LOG_PREFIX          <span class="token key atrule">value</span><span class="token punctuation">:</span> aliyun        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LOGGING_OUTPUT          <span class="token key atrule">value</span><span class="token punctuation">:</span> elasticsearch        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ELASTICSEARCH_HOSTS          <span class="token key atrule">value</span><span class="token punctuation">:</span> elasticsearch.logs<span class="token punctuation">:</span><span class="token number">9200</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/log<span class="token punctuation">-</span>pilot<span class="token punctuation">:</span>filebeat<span class="token punctuation">-</span>7.9.2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /pilot/healthz          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">2</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>pilot        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">limits</span><span class="token punctuation">:</span>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 500Mi          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 200Mi        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>            <span class="token key atrule">add</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> SYS_ADMIN        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/docker.sock          <span class="token key atrule">name</span><span class="token punctuation">:</span> sock        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host          <span class="token key atrule">name</span><span class="token punctuation">:</span> root          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/filebeat          <span class="token key atrule">name</span><span class="token punctuation">:</span> varlib        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/filebeat          <span class="token key atrule">name</span><span class="token punctuation">:</span> varlog        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime          <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule        <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/docker.sock          <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">""</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> sock      <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /          <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">""</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> root      <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/filebeat          <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate        <span class="token key atrule">name</span><span class="token punctuation">:</span> varlib      <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/log/filebeat          <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate        <span class="token key atrule">name</span><span class="token punctuation">:</span> varlog      <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime          <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">""</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate</code></pre><p>交付k8s</p><pre class=" language-bash"><code class="language-bash">kubectl apply -f log-pilot_ds.yaml</code></pre><p>查看状态</p><pre class=" language-bash"><code class="language-bash">kubectl get po -n logs <span class="token operator">|</span> <span class="token function">grep</span> log-pilog-pilot-fs5nt                  1/1     Running   0          46mlog-pilot-nrkwn                  1/1     Running   0          46mlog-pilot-tpvmb                  1/1     Running   0          46m</code></pre><h1 id="三-服务内配置日志收集"><a href="#三-服务内配置日志收集" class="headerlink" title="三.服务内配置日志收集"></a>三.服务内配置日志收集</h1><h3 id="3-1收集容器stdout"><a href="#3-1收集容器stdout" class="headerlink" title="3.1收集容器stdout"></a>3.1收集容器stdout</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_note<span class="token punctuation">-</span>stdout          <span class="token key atrule">value</span><span class="token punctuation">:</span> stdout</code></pre><p>通过容器中添加env实现自动拉取日志</p><p>es直接添加索引即可<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/376998505.jpg"></p><h3 id="3-2-收集服务日志"><a href="#3-2-收集服务日志" class="headerlink" title="3.2 收集服务日志"></a>3.2 收集服务日志</h3><p>配置如下 需要添加日志路径 且挂载数据卷</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_note<span class="token punctuation">-</span>logs     <span class="token key atrule">value</span><span class="token punctuation">:</span> /wiz/logs/*.log  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /wiz/logs     <span class="token key atrule">name</span><span class="token punctuation">:</span> wiz<span class="token punctuation">-</span>log<span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>   <span class="token key atrule">name</span><span class="token punctuation">:</span> wiz<span class="token punctuation">-</span>log</code></pre><p>es中查看</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/1222845714.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> EFK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> EFK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis-insight配置</title>
      <link href="/c065ae07/"/>
      <url>/c065ae07/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h1><h3 id="1-1-介绍"><a href="#1-1-介绍" class="headerlink" title="1.1 介绍"></a>1.1 介绍</h3><p>RedisInsight旨在于简化Redis应用程序开发。</p><h3 id="1-2-功能介绍"><a href="#1-2-功能介绍" class="headerlink" title="1.2 功能介绍"></a>1.2 功能介绍</h3><ul><li>可视化并与Redis数据库交互<br>扫描现有密钥，添加新密钥，执行CRUD或批量操作。以漂亮的打印JSON对象格式显示对象，并支持友好的键盘导航。</li><li>对Redis模块的内置支持<br>查询、可视化和交互式操作图形、流和时间序列数据。使用多行查询编辑器生成查询、浏览结果、优化和快速迭代。支持RedisJSON、RediSearch、RedisGraph、Streams、RedisTimeSeries和RedisGears。</li><li>Redis的内存分析<br>离线分析内存使用情况，通过密钥模式、密钥过期和高级搜索来确定内存问题，而不影响Redis的性能。利用建议减少内存使用。</li><li>Trace Redis命令<br>识别顶键、键模式和命令。按群集所有节点上的客户端IP地址、密钥或命令进行筛选。有效地调试Lua脚本</li><li>直观的CLI<br>当一个GUI还不够时，我们的命令行界面利用redis cli提供语法高亮显示和自动完成，并使用集成的帮助来提供直观的即时帮助。</li></ul><h1 id="二-安装配置"><a href="#二-安装配置" class="headerlink" title="二.安装配置"></a>二.安装配置</h1><h3 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h3><ol><li>Deployment</li></ol><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># RedisInsight deployment with name 'redisinsight'</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redisinsight <span class="token comment" spellcheck="true">#deployment name</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redisinsight <span class="token comment" spellcheck="true">#deployment label</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment" spellcheck="true">#a single replica pod</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> redisinsight <span class="token comment" spellcheck="true">#which pods is the deployment managing, as defined by the pod template</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#pod template</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> redisinsight <span class="token comment" spellcheck="true">#label for pod/s</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> redisinsight<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>claim      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init          <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /bin/sh            <span class="token punctuation">-</span> <span class="token string">'-c'</span>            <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">              chown -R 1001 /db</span>          <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /db          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>  redisinsight <span class="token comment" spellcheck="true">#Container name (DNS_LABEL, unique)</span>          <span class="token key atrule">image</span><span class="token punctuation">:</span> redislabs/redisinsight<span class="token punctuation">:</span>latest <span class="token comment" spellcheck="true">#repo/image</span>          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment" spellcheck="true">#Always pull image</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db <span class="token comment" spellcheck="true">#Pod volumes to mount into the container's filesystem. Cannot be updated.</span>            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /db          <span class="token key atrule">ports</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8001 </span><span class="token comment" spellcheck="true">#exposed container port and protocol</span>            <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</code></pre><ol start="2"><li>pvc</li></ol><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redisinsight<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>claim  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redisinsight<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>storageclass</code></pre><ol start="3"><li>svc</li></ol><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redisinsight<span class="token punctuation">-</span>service<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8001</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redisinsight</code></pre><h3 id="2-2-交付k8s"><a href="#2-2-交付k8s" class="headerlink" title="2.2 交付k8s"></a>2.2 交付k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f .</code></pre><h3 id="web页面查看"><a href="#web页面查看" class="headerlink" title="web页面查看"></a>web页面查看</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/3852309014.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Yearning SQL审核工具下载</title>
      <link href="/b50f8db9/"/>
      <url>/b50f8db9/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h1><h3 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h3><p><strong>Yearning</strong> 面向中小型企业的轻量级MySQL SQL语句审核平台.提供查询审计，SQL审核等多种功能.</p><h1 id="二-安装"><a href="#二-安装" class="headerlink" title="二.安装"></a>二.安装</h1><h3 id="2-1-下载压缩包"><a href="#2-1-下载压缩包" class="headerlink" title="2.1 下载压缩包"></a>2.1 下载压缩包</h3><p><a href="https://github.com/cookieY/Yearning/releases/download/2.3.5/Yearning-2.3.5-linux-amd64.zip">点击下载</a></p><p>解压文件</p><pre class=" language-bash"><code class="language-bash">unzip Yearning-2.3.5-linux-amd64.zip</code></pre><p>查看帮助</p><pre class=" language-bash"><code class="language-bash">./Yearning --helpYearning Mysql数据审核平台 <span class="token punctuation">(</span>Version: 2.3.4 Neptune<span class="token punctuation">)</span>Usage:  ./Yearning <span class="token punctuation">[</span>Global Options<span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;command&amp;#125; [--option ...] [argument ...]</span>Global Options:  -h, --help              Display the <span class="token function">help</span> information      --no-color          Disable color when outputting message      --no-interactive    Disable interactive confirmation operations      --no-progress       Disable display progress message      --verbose           Set error reporting level<span class="token punctuation">(</span>quiet 0 - 4 debug<span class="token punctuation">)</span> <span class="token punctuation">(</span>default 1<span class="token punctuation">)</span>  -V, --version           Display app version informationAvailable Commands:  genac        Generate auto complete scripts <span class="token keyword">for</span> current application <span class="token punctuation">(</span>alias: gen-ac<span class="token punctuation">)</span>  <span class="token function">install</span>      Yearning安装及数据初始化  migrate      破坏性版本升级修复  reset_super  重置超级管理员密码  run          启动Yearning  <span class="token function">help</span>         Display <span class="token function">help</span> informationUse <span class="token string">"./Yearning &amp;#123;COMMAND&amp;#125; -h"</span> <span class="token keyword">for</span> <span class="token function">more</span> information about a <span class="token function">command</span></code></pre><h3 id="2-2-配置数据库"><a href="#2-2-配置数据库" class="headerlink" title="2.2 配置数据库"></a>2.2 配置数据库</h3><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>Mysql<span class="token punctuation">]</span>Db <span class="token operator">=</span> <span class="token string">"Yearning"</span>                <span class="token comment" spellcheck="true">#服务连接所需要连接的数据库</span>Host <span class="token operator">=</span> <span class="token string">"192.168.0.10"</span>        <span class="token comment" spellcheck="true">#mysql地址</span>Port <span class="token operator">=</span> <span class="token string">"3306"</span>                       <span class="token comment" spellcheck="true">#端口</span>Password <span class="token operator">=</span> <span class="token string">"123456"</span>          <span class="token comment" spellcheck="true">#密码</span>User <span class="token operator">=</span> <span class="token string">"root"</span>                       <span class="token comment" spellcheck="true">#用户</span><span class="token punctuation">[</span>General<span class="token punctuation">]</span>SecretKey <span class="token operator">=</span> <span class="token string">"FtUDyUgelhkDWtHi"</span>      <span class="token comment" spellcheck="true">#加密解密所需要的key</span>Hours <span class="token operator">=</span> 4</code></pre><h3 id="2-3-制作镜像"><a href="#2-3-制作镜像" class="headerlink" title="2.3 制作镜像"></a>2.3 制作镜像</h3><pre class=" language-yaml"><code class="language-yaml">FROM alpine<span class="token punctuation">:</span><span class="token number">3.12</span>LABEL maintainer="HenryYee<span class="token punctuation">-</span>2020/11/16"EXPOSE 8000COPY Yearning  /opt/YearningCOPY conf.toml /opt/conf.tomlRUN echo "http<span class="token punctuation">:</span>//mirrors.ustc.edu.cn/alpine/v3.12/main/" <span class="token punctuation">></span> /etc/apk/repositories &amp;&amp; \      apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache tzdata libc6<span class="token punctuation">-</span>compat &amp;&amp; \      ln <span class="token punctuation">-</span>sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; \      echo "Asia/Shanghai" <span class="token punctuation">></span><span class="token punctuation">></span> /etc/timezone &amp;&amp; \      echo 'hosts<span class="token punctuation">:</span> files mdns4_minimal <span class="token punctuation">[</span>NOTFOUND=return<span class="token punctuation">]</span> dns mdns4' <span class="token punctuation">></span><span class="token punctuation">></span> /etc/nsswitch.confWORKDIR /optCMD /opt/Yearning install &amp;&amp; /opt/Yearning run</code></pre><pre class=" language-bash"><code class="language-bash">docker build <span class="token keyword">.</span> -t yearning:1.0</code></pre><h3 id="2-4-交付k8s"><a href="#2-4-交付k8s" class="headerlink" title="2.4 交付k8s"></a>2.4 交付k8s</h3><p>Deployment</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment" spellcheck="true"># for versions before 1.8.0 use apps/v1beta1</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> yearning  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yearning<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> yearning  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> yearning    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yearning        <span class="token key atrule">image</span><span class="token punctuation">:</span> yearning<span class="token punctuation">:</span><span class="token number">1.0</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8000</span>        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></code></pre><p>svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> yearning <span class="token comment" spellcheck="true">#TODO: to specify your service name</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ops  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yearning<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yearning <span class="token comment" spellcheck="true">#TODO: change label selector to match your backend pod</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8000</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><pre class=" language-bash"><code class="language-bash">kubectl apply -f <span class="token keyword">.</span></code></pre><h1 id="三-访问测试"><a href="#三-访问测试" class="headerlink" title="三.访问测试"></a>三.访问测试</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/4270559722.jpg"><br>默认用户名密码<br>admin&#x2F;Yearning_admin<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/3863493400.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s配置Mongo集群</title>
      <link href="/660145b4/"/>
      <url>/660145b4/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一 前言"></a>一 前言</h1><p>随着发展 k8s对于有状态应用的适应已经越来越好 下面就针对mongo db的部署为大家分享下k8s sts控制器的使用</p><hr><h1 id="二-部署"><a href="#二-部署" class="headerlink" title="二 部署"></a>二 部署</h1><h3 id="2-1-环境准备"><a href="#2-1-环境准备" class="headerlink" title="2.1 环境准备"></a>2.1 环境准备</h3><p>数据库这种核心组件 首先需要准备持久化的数据卷 这里就使用sc动态存储来作为底层存储</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>mongo<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>mongo<span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain<span class="token key atrule">volumeBindingMode</span><span class="token punctuation">:</span> Immediate</code></pre><p>创建ns</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo</code></pre><p>配置cm</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>keyfile  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">key.txt</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>    nX24aaT7/WOQKOfchxP66kulNNdjSn5LpsE/RbDL7gwMIqZ424WQVCOJzRV5YMw9    fQ0pz591I+U+G2/iP8PEPF6po1/rLKi1LotoKV+ubh336N/TCMzi86OH3aibNVyC    ydhbw6hTrtYxaZatxyKHZ7C8K39su05T0cDh1iqCYDBEkxUh5zYUafwfxa5GC5Ar    +NGiDhrZJXj+fjGBhUOBA8yl0fG7V5lx56PIJ7u9M+EaFoJcoYembSZ40A/JRcmO    wV76/5sng1HQ0A016xh3WPFrUkSrie3RqmpjTP/gx7sej3fiheOxNmjjFYcR4Fof    Y3VH+MXs0qJm4HIcJUIEnYInunFlsbpyrSFu77sgfXuL/zYkozK3CPaK5+kZZCfY    FqsTxo9xWI9D8QVpXlSU7Pbj4g8DatHBjAxQWgDgEFxABhypILz56RsDybQ8aNtX    OWuEhJJUvjAMEYutTOSM80ATYSFh+XbB19n5SthDfcz9RvJ+XMdn6biBZwS46vqb    oKWaM2U7lpNC2ZvhEAfGYsHwPfs98ak4O1n1iYQVeohC+TkQdrJQk5sppMp2bu5b    hcG0qrYOWgjXS3EayMMAwYKBAcyb0sCugFIY4KeCl3RMzJpnSVL916LwXuOaHRTb    SkFrbgEapveUaGB+NCARJq/NUi2sA16gpGVoLVYctJCHnJVNhTQ1bH32I7PULiL8    6fae3gLs6yTbC8Isdn4CqkJP4yB7ae8z9VOYpTouP7YblJaGfcQ/pGD0xWVCj4BL    IXhsEygotZj+3RySpFFwedX/Ku5JDMlA7FDbwNguUBPUtO6a8osiw5jSb8wplFXZ    ei8LgkyGx6onVrIgzuQv0CDm9tUpdgNuf8d7CYYWLyZBpTuBFrbJdnWQ1ViigRq5    wlKzb2yL76KxiIch4JwL61XTC/6+k5K2opGimAP8Ebft9tfB0M38cFfrdD7PJCL5    x7c9cfDxO4O56DNzpPimyW6pJ6nw</code></pre><h3 id="2-2-配置sts"><a href="#2-2-配置sts" class="headerlink" title="2.2 配置sts"></a>2.2 配置sts</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">environment</span><span class="token punctuation">:</span> test      <span class="token key atrule">role</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">environment</span><span class="token punctuation">:</span> test        <span class="token key atrule">role</span><span class="token punctuation">:</span> mongo      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">kubesphere.io/restartedAt</span><span class="token punctuation">:</span> <span class="token string">'2022-03-05T07:52:33.099Z'</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>keyfile          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>keyfile            <span class="token key atrule">items</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> key.txt                <span class="token key atrule">path</span><span class="token punctuation">:</span> key.txt            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> fix<span class="token punctuation">-</span>permissions          <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/busybox          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> sh            <span class="token punctuation">-</span> <span class="token string">'-c'</span>            <span class="token punctuation">-</span> <span class="token punctuation">></span><span class="token punctuation">-</span>              cp /data/key.txt /data/db/key &amp;&amp; chown 999<span class="token punctuation">:</span>999 /data/db/key &amp;&amp;              chmod 400 /data/db/key  &amp;&amp; ls <span class="token punctuation">-</span>l /data/          <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/db            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>keyfile              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/key.txt              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> key.txt          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo          <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/mongo<span class="token punctuation">:</span>4.2.8          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> docker<span class="token punctuation">-</span>entrypoint.sh            <span class="token punctuation">-</span> <span class="token string">'--replSet'</span>            <span class="token punctuation">-</span> rs0            <span class="token punctuation">-</span> <span class="token string">'--bind_ip'</span>            <span class="token punctuation">-</span> 0.0.0.0            <span class="token punctuation">-</span> <span class="token string">'--auth'</span>            <span class="token punctuation">-</span> <span class="token string">'--clusterAuthMode'</span>            <span class="token punctuation">-</span> keyFile            <span class="token punctuation">-</span> <span class="token string">'--keyFile'</span>            <span class="token punctuation">-</span> /data/db/key          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_INITDB_ROOT_USERNAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> root            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_INITDB_ROOT_PASSWORD              <span class="token key atrule">value</span><span class="token punctuation">:</span> dSJN52PuSqn          <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/db            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>keyfile              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/key.txt              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> key.txt          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>sidecar          <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/k8s<span class="token punctuation">-</span>mongo<span class="token punctuation">-</span>sidecar          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KUBERNETES_POD_LABELS              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'role=mongo,environment=test'</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KUBERNETES_NAMESPACE              <span class="token key atrule">value</span><span class="token punctuation">:</span> mongo            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_USERNAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> root            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_PASSWORD              <span class="token key atrule">value</span><span class="token punctuation">:</span> dSJN52PuSqn            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_DATABASE              <span class="token key atrule">value</span><span class="token punctuation">:</span> admin            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KUBERNETES_SERVICE_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> mongo          <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim      <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1      <span class="token key atrule">metadata</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo        <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">spec</span><span class="token punctuation">:</span>        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> ReadWriteOnce        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 20Gi        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>mongo        <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem      <span class="token key atrule">status</span><span class="token punctuation">:</span>        <span class="token key atrule">phase</span><span class="token punctuation">:</span> Pending  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> OrderedReady  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span></code></pre><p>因为mongo-sidecar需要监控mongo状态所以需要创建ClusterRoleBinding</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span><span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>default<span class="token punctuation">-</span>view<span class="token key atrule">roleRef</span><span class="token punctuation">:</span><span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">name</span><span class="token punctuation">:</span> view<span class="token key atrule">subjects</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount  <span class="token key atrule">name</span><span class="token punctuation">:</span> default  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default</code></pre><h3 id="2-3-配置svc"><a href="#2-3-配置svc" class="headerlink" title="2.3 配置svc"></a>2.3 配置svc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">role</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None</code></pre><h3 id="2-4-交付k8s"><a href="#2-4-交付k8s" class="headerlink" title="2.4 交付k8s"></a>2.4 交付k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f .</code></pre><hr><h1 id="三-验证"><a href="#三-验证" class="headerlink" title="三 验证"></a>三 验证</h1><h3 id="3-1-连接测试"><a href="#3-1-连接测试" class="headerlink" title="3.1 连接测试"></a>3.1 连接测试</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># mongo -uroot -p dSJN52PuSqn</span>MongoDB shell version v4.2.8connecting to: mongodb://127.0.0.1:27017/?compressors<span class="token operator">=</span>disabled<span class="token operator">&amp;</span>gssapiServiceName<span class="token operator">=</span>mongodbImplicit session: session <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123; "id" : UUID("8f142a74-c99c-48df-8c37-5107f846e4a5") &amp;#125;</span>MongoDB server version: 4.2.8Server has startup warnings:2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="token string">'always'</span><span class="token keyword">.</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> **        We suggest setting it to <span class="token string">'never'</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="token string">'always'</span><span class="token keyword">.</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> **        We suggest setting it to <span class="token string">'never'</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span>---Enable MongoDB's <span class="token function">free</span> cloud-based monitoring service, <span class="token function">which</span> will <span class="token keyword">then</span> receive and displaymetrics about your deployment <span class="token punctuation">(</span>disk utilization, CPU, operation statistics, etc<span class="token punctuation">)</span>.The monitoring data will be available on a MongoDB website with a unique URL accessible to youand anyone you share the URL with. MongoDB may use this information to <span class="token function">make</span> productimprovements and to suggest MongoDB products and deployment options to you.To <span class="token function">enable</span> <span class="token function">free</span> monitoring, run the following command: db.enableFreeMonitoring<span class="token punctuation">(</span><span class="token punctuation">)</span>To permanently disable this reminder, run the following command: db.disableFreeMonitoring<span class="token punctuation">(</span><span class="token punctuation">)</span>---rs0:PRIMARY<span class="token operator">></span> rs.statusfunction<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>    <span class="token keyword">return</span> db._adminCommand<span class="token punctuation">(</span><span class="token string">"replSetGetStatus"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span>rs0:PRIMARY<span class="token operator">></span> rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>        <span class="token string">"set"</span> <span class="token keyword">:</span> <span class="token string">"rs0"</span>,        <span class="token string">"date"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:10.117Z"</span><span class="token punctuation">)</span>,        <span class="token string">"myState"</span> <span class="token keyword">:</span> 1,        <span class="token string">"term"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>,        <span class="token string">"syncingTo"</span> <span class="token keyword">:</span> <span class="token string">""</span>,        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">""</span>,        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> -1,        <span class="token string">"heartbeatIntervalMillis"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>2000<span class="token punctuation">)</span>,        <span class="token string">"majorityVoteCount"</span> <span class="token keyword">:</span> 2,        <span class="token string">"writeMajorityCount"</span> <span class="token keyword">:</span> 2,        <span class="token string">"optimes"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                <span class="token string">"lastCommittedOpTime"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                <span class="token string">"lastCommittedWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07.713Z"</span><span class="token punctuation">)</span>,                <span class="token string">"readConcernMajorityOpTime"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                <span class="token string">"readConcernMajorityWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07.713Z"</span><span class="token punctuation">)</span>,                <span class="token string">"appliedOpTime"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                <span class="token string">"durableOpTime"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                <span class="token string">"lastAppliedWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07.713Z"</span><span class="token punctuation">)</span>,                <span class="token string">"lastDurableWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07.713Z"</span><span class="token punctuation">)</span>        <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>        <span class="token string">"lastStableRecoveryTimestamp"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469057, 1<span class="token punctuation">)</span>,        <span class="token string">"lastStableCheckpointTimestamp"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469057, 1<span class="token punctuation">)</span>,        <span class="token string">"electionCandidateMetrics"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                <span class="token string">"lastElectionReason"</span> <span class="token keyword">:</span> <span class="token string">"electionTimeout"</span>,                <span class="token string">"lastElectionDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T07:53:17.358Z"</span><span class="token punctuation">)</span>,                <span class="token string">"electionTerm"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>,                <span class="token string">"lastCommittedOpTimeAtElection"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646466756, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>2<span class="token punctuation">)</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                <span class="token string">"lastSeenOpTimeAtElection"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646466769, 2<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>4<span class="token punctuation">)</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                <span class="token string">"numVotesNeeded"</span> <span class="token keyword">:</span> 2,                <span class="token string">"priorityAtElection"</span> <span class="token keyword">:</span> 1,                <span class="token string">"electionTimeoutMillis"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>10000<span class="token punctuation">)</span>,                <span class="token string">"numCatchUpOps"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,                <span class="token string">"newTermStartDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T07:53:17.393Z"</span><span class="token punctuation">)</span>,                <span class="token string">"wMajorityWriteAvailabilityDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T07:53:17.729Z"</span><span class="token punctuation">)</span>        <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>        <span class="token string">"members"</span> <span class="token keyword">:</span> <span class="token punctuation">[</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        <span class="token string">"_id"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"mongo-0.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"health"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"state"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"stateStr"</span> <span class="token keyword">:</span> <span class="token string">"PRIMARY"</span>,                        <span class="token string">"uptime"</span> <span class="token keyword">:</span> 2287,                        <span class="token string">"optime"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                        <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                        <span class="token string">"optimeDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"syncingTo"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> -1,                        <span class="token string">"infoMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"electionTime"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646466797, 1<span class="token punctuation">)</span>,                        <span class="token string">"electionDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T07:53:17Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"configVersion"</span> <span class="token keyword">:</span> 6,                        <span class="token string">"self"</span> <span class="token keyword">:</span> true,                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        <span class="token string">"_id"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"mongo-2.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"health"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"state"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"stateStr"</span> <span class="token keyword">:</span> <span class="token string">"SECONDARY"</span>,                        <span class="token string">"uptime"</span> <span class="token keyword">:</span> 2284,                        <span class="token string">"optime"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                        <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                        <span class="token string">"optimeDurable"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                        <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                        <span class="token string">"optimeDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"optimeDurableDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeat"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:09.817Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatRecv"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:09.807Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"pingMs"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncingTo"</span> <span class="token keyword">:</span> <span class="token string">"mongo-0.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">"mongo-0.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"infoMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"configVersion"</span> <span class="token keyword">:</span> 6                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        <span class="token string">"_id"</span> <span class="token keyword">:</span> 3,                        <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"mongo-1.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"health"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"state"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"stateStr"</span> <span class="token keyword">:</span> <span class="token string">"SECONDARY"</span>,                        <span class="token string">"uptime"</span> <span class="token keyword">:</span> 2260,                        <span class="token string">"optime"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                        <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                        <span class="token string">"optimeDurable"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                        <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>                        <span class="token string">"optimeDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"optimeDurableDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeat"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:09.222Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatRecv"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:09.430Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"pingMs"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncingTo"</span> <span class="token keyword">:</span> <span class="token string">"mongo-2.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">"mongo-2.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"infoMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"configVersion"</span> <span class="token keyword">:</span> 6                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span>        <span class="token punctuation">]</span>,        <span class="token string">"ok"</span> <span class="token keyword">:</span> 1,        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                <span class="token string">"clusterTime"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                <span class="token string">"signature"</span> <span class="token keyword">:</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        <span class="token string">"hash"</span> <span class="token keyword">:</span> BinData<span class="token punctuation">(</span>0,<span class="token string">"LxAPsQBDq0Bx33yC0PzRJWFMbbM="</span><span class="token punctuation">)</span>,                        <span class="token string">"keyId"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"7071495762592399364"</span><span class="token punctuation">)</span>                <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span>        <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,</span>        <span class="token string">"operationTime"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span></code></pre><p>创建数据库测试</p><pre class=" language-bash"><code class="language-bash">rs0:PRIMARY<span class="token operator">></span> use <span class="token function">test</span>switched to db <span class="token function">test</span>rs0:PRIMARY<span class="token operator">></span> db.users.insertMany<span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span><span class="token punctuation">..</span>.      name: <span class="token string">"bob"</span>, age: 42, status: <span class="token string">"A"</span>, <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,&amp;#123;</span><span class="token punctuation">..</span>.      name: <span class="token string">"ahn"</span>, age: 22, status: <span class="token string">"A"</span>, <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;,&amp;#123;</span><span class="token punctuation">..</span>.      name: <span class="token string">"xi"</span>, age: 34, status: <span class="token string">"D"</span>, <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;])</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>        <span class="token string">"acknowledged"</span> <span class="token keyword">:</span> true,        <span class="token string">"insertedIds"</span> <span class="token keyword">:</span> <span class="token punctuation">[</span>                ObjectId<span class="token punctuation">(</span><span class="token string">"62232018adef03bcf644f4d6"</span><span class="token punctuation">)</span>,                ObjectId<span class="token punctuation">(</span><span class="token string">"62232018adef03bcf644f4d7"</span><span class="token punctuation">)</span>,                ObjectId<span class="token punctuation">(</span><span class="token string">"62232018adef03bcf644f4d8"</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span>rs0:PRIMARY<span class="token operator">></span> show collections<span class="token function">users</span>rs0:PRIMARY<span class="token operator">></span> db.user.find<span class="token punctuation">(</span><span class="token punctuation">)</span>rs0:PRIMARY<span class="token operator">></span> db.users.find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123; "_id" : ObjectId("62232018adef03bcf644f4d6"), "name" : "bob", "age" : 42, "status" : "A" &amp;#125;</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123; "_id" : ObjectId("62232018adef03bcf644f4d7"), "name" : "ahn", "age" : 22, "status" : "A" &amp;#125;</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123; "_id" : ObjectId("62232018adef03bcf644f4d8"), "name" : "xi", "age" : 34, "status" : "D" &amp;#125;</span></code></pre><p>为数据库创建用户</p><pre class=" language-yaml"><code class="language-yaml">rs0<span class="token punctuation">:</span>PRIMARY<span class="token punctuation">></span> use testswitched to db testrs0<span class="token punctuation">:</span>PRIMARY<span class="token punctuation">></span> db.createUser(&amp;<span class="token comment" spellcheck="true">#123;user: "jim", pwd: "123456", roles: [&amp;#123; role: "dbOwner", db: "test" &amp;#125;]&amp;#125;)</span>Successfully added user<span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;</span>        <span class="token key atrule">"user"</span> <span class="token punctuation">:</span> <span class="token string">"jim"</span><span class="token punctuation">,</span>        <span class="token key atrule">"roles"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>                &amp;<span class="token comment" spellcheck="true">#123;</span>                        <span class="token key atrule">"role"</span> <span class="token punctuation">:</span> <span class="token string">"dbOwner"</span><span class="token punctuation">,</span>                        <span class="token key atrule">"db"</span> <span class="token punctuation">:</span> <span class="token string">"test"</span>                &amp;<span class="token comment" spellcheck="true">#125;</span>        <span class="token punctuation">]</span>&amp;<span class="token comment" spellcheck="true">#125;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Databases </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Databases </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nexus本地mavan仓库搭建</title>
      <link href="/f797207e/"/>
      <url>/f797207e/</url>
      
        <content type="html"><![CDATA[<h1 id="一-简介"><a href="#一-简介" class="headerlink" title="一 简介"></a>一 简介</h1><p><a href="https://link.zhihu.com/?target=http://nexus.sonatype.org/">Nexus</a> 是Maven仓库管理器，如果你使用Maven，你可以从<a href="https://link.zhihu.com/?target=http://repo1.maven.org/maven2/">Maven中央仓库</a> 下载所需要的构件（artifact），但这通常不是一个好的做法，你应该在本地架设一个Maven仓库服务器，在代理远程仓库的同时维护本地仓库，以节省带宽和时间，Nexus就可以满足这样的需要。此外，他还提供了强大的仓库管理功能，构件搜索功能，它基于REST，友好的UI是一个extjs的REST客户端，它占用较少的内存，基于简单文件系统而非数据库。这些优点使其日趋成为最流行的Maven仓库管理器</p><hr><h1 id="二-安装配置"><a href="#二-安装配置" class="headerlink" title="二 安装配置"></a>二 安装配置</h1><h3 id="2-1-环境准备"><a href="#2-1-环境准备" class="headerlink" title="2.1 环境准备"></a>2.1 环境准备</h3><p>需要有默认存储 我这边使用的是sc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin    <span class="token key atrule">pv.kubernetes.io/bind-completed</span><span class="token punctuation">:</span> <span class="token string">'yes'</span>    <span class="token key atrule">pv.kubernetes.io/bound-by-controller</span><span class="token punctuation">:</span> <span class="token string">'yes'</span>    <span class="token key atrule">volume.beta.kubernetes.io/storage-provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>k8s  <span class="token key atrule">finalizers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> kubernetes.io/pvc<span class="token punctuation">-</span>protection<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">volumeName</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>8ac315a8<span class="token punctuation">-</span>fdac<span class="token punctuation">-</span>460d<span class="token punctuation">-</span>9c95<span class="token punctuation">-</span>41d0a7bc7e7e  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>k8s  <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem</code></pre><h3 id="2-2-配置deploy"><a href="#2-2-配置deploy" class="headerlink" title="2.2 配置deploy"></a>2.2 配置deploy</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">deployment.kubernetes.io/revision</span><span class="token punctuation">:</span> <span class="token string">'5'</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nexus      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> nexus      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus<span class="token punctuation">-</span>data          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> nexus<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> adddirperm          <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/busybox          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /bin/sh            <span class="token punctuation">-</span> <span class="token string">'-c'</span>            <span class="token punctuation">-</span> 'chown <span class="token punctuation">-</span>R $&amp;<span class="token comment" spellcheck="true">#123;USER_ID&amp;#125;:$&amp;#123;USER_ID&amp;#125; $&amp;#123;DATA_DIR&amp;#125;'</span>          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATA_DIR              <span class="token key atrule">value</span><span class="token punctuation">:</span> /nexus<span class="token punctuation">-</span>data            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> USER_ID              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'200'</span>          <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus<span class="token punctuation">-</span>data              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /nexus<span class="token punctuation">-</span>data          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus          <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/nexus3<span class="token punctuation">:</span>3.20.1          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8081</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">resources</span><span class="token punctuation">:</span>            <span class="token key atrule">requests</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus<span class="token punctuation">-</span>data              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /nexus<span class="token punctuation">-</span>data          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span></code></pre><h3 id="2-3-配置svc"><a href="#2-3-配置svc" class="headerlink" title="2.3 配置svc"></a>2.3 配置svc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nexus<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>neuxs      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8081</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster</code></pre><hr><h1 id="三-访问测试"><a href="#三-访问测试" class="headerlink" title="三 访问测试"></a>三 访问测试</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/1062911246.png"></p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s搭建YApi管理平台</title>
      <link href="/3dba2979/"/>
      <url>/3dba2979/</url>
      
        <content type="html"><![CDATA[<h1 id="一-简介"><a href="#一-简介" class="headerlink" title="一 简介"></a>一 简介</h1><p>旨在为开发、产品、测试人员提供更优雅的接口管理服务。可以帮助开发者轻松创建、发布、维护 API</p><h3 id="1-1-平台介绍"><a href="#1-1-平台介绍" class="headerlink" title="1.1 平台介绍"></a>1.1 平台介绍</h3><p>YApi 是<strong>高效</strong> 、<strong>易用</strong> 、<strong>功能强大</strong> 的 api 管理平台，旨在为开发、产品、测试人员提供更优雅的接口管理服务。可以帮助开发者轻松创建、发布、维护 API，YApi 还为用户提供了优秀的交互体验，开发人员只需利用平台提供的接口数据写入工具以及简单的点击操作就可以实现接口的管理。</p><h3 id="1-2-平台特性"><a href="#1-2-平台特性" class="headerlink" title="1.2 平台特性"></a>1.2 平台特性</h3><ul><li>基于 Json5 和 Mockjs 定义接口返回数据的结构和文档，效率提升多倍</li><li>扁平化权限设计，即保证了大型企业级项目的管理，又保证了易用性</li><li>类似 postman 的接口调试</li><li>自动化测试, 支持对 Response 断言</li><li>MockServer 除支持普通的随机 mock 外，还增加了 Mock 期望功能，根据设置的请求过滤规则，返回期望数据</li><li>支持 postman, har, swagger 数据导入</li><li>免费开源，内网部署，信息再也不怕泄露了</li></ul><h1 id="二-部署"><a href="#二-部署" class="headerlink" title="二 部署"></a>二 部署</h1><h3 id="2-1-环境准备"><a href="#2-1-环境准备" class="headerlink" title="2.1 环境准备"></a>2.1 环境准备</h3><p>YApi服务依赖于mongodb 作为底层存储,所以搭建服务之前需要配置mongo环境,这里可以参考前面的文章<br><a href="https://www.huhuhahei.cn/index.php/archives/491/">Mongo集群搭建</a></p><h3 id="2-2-配置服务"><a href="#2-2-配置服务" class="headerlink" title="2.2 配置服务"></a>2.2 配置服务</h3><h4 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a>deploy</h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">deployment.kubernetes.io/revision</span><span class="token punctuation">:</span> <span class="token string">'7'</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> yapi      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">kubesphere.io/restartedAt</span><span class="token punctuation">:</span> <span class="token string">'2022-03-07T07:07:24.975Z'</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi<span class="token punctuation">-</span>config          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi<span class="token punctuation">-</span>config            <span class="token key atrule">items</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> config.json                <span class="token key atrule">path</span><span class="token punctuation">:</span> config.json            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'harbor.huhuhahei.cn/huhuhahei/yapi:1.9.1'</span>          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi<span class="token punctuation">-</span>config              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/yapi/config.json              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> config.json          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span></code></pre><h4 id="svc"><a href="#svc" class="headerlink" title="svc"></a>svc</h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3000</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31257</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.98.149.20  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster</code></pre><h4 id="configmap"><a href="#configmap" class="headerlink" title="configmap"></a>configmap</h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi<span class="token punctuation">-</span>config  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">config.json</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>    &amp;<span class="token comment" spellcheck="true">#123;</span>       <span class="token key atrule">"port"</span><span class="token punctuation">:</span> <span class="token string">"3000"</span><span class="token punctuation">,</span>       <span class="token key atrule">"adminAccount"</span><span class="token punctuation">:</span> <span class="token string">"admin@admin.com"</span><span class="token punctuation">,</span>       <span class="token key atrule">"db"</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;</span>          <span class="token key atrule">"connectString"</span><span class="token punctuation">:</span> <span class="token string">"mongodb://mongo-0.mongo.mongo:27017,mongo-1.mongo.mongo:27017,mongo-2.mongo.mongo:27017/yapi?replicaSet=rs0"</span><span class="token punctuation">,</span>          <span class="token key atrule">"user"</span><span class="token punctuation">:</span> <span class="token string">"yapi"</span><span class="token punctuation">,</span>          <span class="token key atrule">"pass"</span><span class="token punctuation">:</span> <span class="token string">"yapi"</span>       &amp;<span class="token comment" spellcheck="true">#125;</span>    &amp;<span class="token comment" spellcheck="true">#125;</span></code></pre><h3 id="2-3-交付k8s"><a href="#2-3-交付k8s" class="headerlink" title="2.3 交付k8s"></a>2.3 交付k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f .</code></pre><h3 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h3><p>这里需要进入容器进行初始化用户否则admin用户无法登录</p><pre class=" language-yaml"><code class="language-yaml">rm <span class="token punctuation">-</span>f /opt/yapi/init.locknode /opt/yapi/vendors/server/install.js<span class="token comment" spellcheck="true"># 初始化后admin 用户:admin@admin.com 密码:ymfe.org</span></code></pre><h1 id="三-登录"><a href="#三-登录" class="headerlink" title="三 登录"></a>三 登录</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/155352285.png"></p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s搭建rook-operator ceph管理平台</title>
      <link href="/75ed946c/"/>
      <url>/75ed946c/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一 前言"></a>一 前言</h1><p>Rook 是一个开源的<strong>云原生存储编排器</strong> ，为各种存储解决方案提供平台、框架和支持，以与云原生环境进行原生集成。</p><p>Rook 将存储软件转变为自我管理、自我扩展和自我修复的存储服务。它通过自动化部署、引导、配置、供应、扩展、升级、迁移、灾难恢复、监控和资源管理来实现这一点。Rook 使用底层云原生容器管理、调度和编排平台提供的设施来履行其职责。</p><p>Rook 利用扩展点深度集成到云原生环境中，并为调度、生命周期管理、资源管理、安全性、监控和用户体验提供无缝体验。</p><h1 id="二-搭建"><a href="#二-搭建" class="headerlink" title="二 搭建"></a>二 搭建</h1><h3 id="2-1-环境准备"><a href="#2-1-环境准备" class="headerlink" title="2.1 环境准备"></a>2.1 环境准备</h3><p>需要确保节点中有未初始化的磁盘</p><p>代码下载</p><p><code>git clone --single-branch --branch master https://github.com/rook/rook.git</code></p><h3 id="2-2-创建rook-operater"><a href="#2-2-创建rook-operater" class="headerlink" title="2.2 创建rook-operater"></a>2.2 创建rook-operater</h3><pre class=" language-yaml"><code class="language-yaml">kubectl create <span class="token punctuation">-</span>f crds.yaml <span class="token punctuation">-</span>f common.yaml <span class="token punctuation">-</span>f operator.yaml</code></pre><p>确认operator启动成功既可继续部署</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master rbd<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n rook-ceph | grep oper</span>rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>757546f8c7<span class="token punctuation">-</span>l9bmc             1/1     Running     0          158m</code></pre><h3 id="2-3-创建ceph-cluster"><a href="#2-3-创建ceph-cluster" class="headerlink" title="2.3 创建ceph-cluster"></a>2.3 创建ceph-cluster</h3><p>配置可以参考cluster的yaml文件自定义修改</p><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f cluster<span class="token punctuation">-</span>test.yaml</code></pre><p>待下面服务全部启动完成 大部分配置就完成了::(滑稽)</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master rbd<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n rook-ceph </span>NAME                                            READY   STATUS      RESTARTS   AGEcsi<span class="token punctuation">-</span>cephfsplugin<span class="token punctuation">-</span>4psdt                          3/3     Running     0          124mcsi<span class="token punctuation">-</span>cephfsplugin<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>5dc75bb888<span class="token punctuation">-</span>5rt4z   6/6     Running     0          131mcsi<span class="token punctuation">-</span>cephfsplugin<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>5dc75bb888<span class="token punctuation">-</span>k4jf7   6/6     Running     0          131mcsi<span class="token punctuation">-</span>cephfsplugin<span class="token punctuation">-</span>zqc8r                          3/3     Running     0          124mcsi<span class="token punctuation">-</span>rbdplugin<span class="token punctuation">-</span>7vtwg                             3/3     Running     0          126mcsi<span class="token punctuation">-</span>rbdplugin<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>65cb5fd9c6<span class="token punctuation">-</span>m2l2x      6/6     Running     0          127mcsi<span class="token punctuation">-</span>rbdplugin<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>65cb5fd9c6<span class="token punctuation">-</span>wh8bx      6/6     Running     0          127mcsi<span class="token punctuation">-</span>rbdplugin<span class="token punctuation">-</span>qr9sw                             3/3     Running     0          126mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>mgr<span class="token punctuation">-</span>a<span class="token punctuation">-</span>6c7886c46d<span class="token punctuation">-</span>d57ps                1/1     Running     0          150mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>mon<span class="token punctuation">-</span>a<span class="token punctuation">-</span>5576f996f8<span class="token punctuation">-</span>2vhq8                1/1     Running     0          154mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>mon<span class="token punctuation">-</span>b<span class="token punctuation">-</span>556b78cd67<span class="token punctuation">-</span>tlblh                1/1     Running     0          152mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>757546f8c7<span class="token punctuation">-</span>l9bmc             1/1     Running     0          160mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>osd<span class="token punctuation">-</span>0<span class="token punctuation">-</span>8495c46d54<span class="token punctuation">-</span>96rd2                1/1     Running     0          148mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>osd<span class="token punctuation">-</span>1<span class="token punctuation">-</span>5d55f9f5cf<span class="token punctuation">-</span>z9cxk                1/1     Running     0          148mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>osd<span class="token punctuation">-</span>prepare<span class="token punctuation">-</span>master<span class="token punctuation">-</span>pfpgk              0/1     Completed   0          149mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>osd<span class="token punctuation">-</span>prepare<span class="token punctuation">-</span>node01<span class="token punctuation">-</span>shktt              0/1     Completed   0          149m</code></pre><p>这是可以登录节点查看磁盘是否已经格式化为ceph的格式</p><pre class=" language-bash"><code class="language-bash">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINTvda    253:0    0  60G  0 disk └─vda1 253:1    0  60G  0 part /vdb    253:16   0  50G  0 disk /datavdc    253:32   0  50G  0 disk └─ceph--b422438d--be03--4318--bd73--a2d54607831d-osd--block--8b14a4eb--0d37--40c3--a78a--6deadd4ded77       252:0    0  50G  0 lvm</code></pre><h3 id="2-4-部署ceph工具"><a href="#2-4-部署ceph工具" class="headerlink" title="2.4 部署ceph工具"></a>2.4 部署ceph工具</h3><pre class=" language-yaml"><code class="language-yaml">kubectl create <span class="token punctuation">-</span>f toolbox.yaml</code></pre><p>启动成功就可以利用这个工具执行ceph的命令</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master rbd<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- ceph -s</span>  cluster:    id:     7a065ad6-efcf-4b94-9df8-ac6e30375a83    health: HEALTH_OK   services:    mon: 2 daemons, quorum a,b <span class="token punctuation">(</span>age 2h<span class="token punctuation">)</span>    mgr: a<span class="token punctuation">(</span>active, since 2h<span class="token punctuation">)</span>    osd: 2 osds: 2 up <span class="token punctuation">(</span>since 2h<span class="token punctuation">)</span>, 2 <span class="token keyword">in</span> <span class="token punctuation">(</span>since 2h<span class="token punctuation">)</span>   data:    pools:   2 pools, 64 pgs    objects: 17 objects, 21 MiB    usage:   32 MiB used, 100 GiB / 100 GiB avail    pgs:     64 active+clean</code></pre><h3 id="2-5-部署ceph-dashboard"><a href="#2-5-部署ceph-dashboard" class="headerlink" title="2.5 部署ceph dashboard"></a>2.5 部署ceph dashboard</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f  dashboard<span class="token punctuation">-</span>external<span class="token punctuation">-</span>http.yaml</code></pre><p>部署完成查看svc端口既可web访问</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#查看密码</span>kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath<span class="token operator">=</span><span class="token string">"&amp;#123;['data']['password']&amp;#125;"</span> <span class="token operator">|</span> base64 --decode <span class="token operator">&amp;&amp;</span> <span class="token keyword">echo</span><span class="token comment" spellcheck="true">#密码： NHaYC4%)5F.Js*%7tO$y</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/2106452900.png"></p><h1 id="三-配置RDB-Storageclass存储"><a href="#三-配置RDB-Storageclass存储" class="headerlink" title="三 配置RDB Storageclass存储"></a>三 配置RDB Storageclass存储</h1><h3 id="3-1-创建Storageclass"><a href="#3-1-创建Storageclass" class="headerlink" title="3.1 创建Storageclass"></a>3.1 创建Storageclass</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f storageclass<span class="token punctuation">-</span>test.yaml</code></pre><p>查看</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master rbd<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get sc</span>rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block (default)   rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com   Delete          Immediate           true                   32m</code></pre><h3 id="3-2-使用pod挂载测试"><a href="#3-2-使用pod挂载测试" class="headerlink" title="3.2 使用pod挂载测试"></a>3.2 使用pod挂载测试</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>ceph<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>pvc<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block</code></pre><p>登录pod查看是否正常挂载</p><pre class=" language-yaml"><code class="language-yaml">/ <span class="token comment" spellcheck="true"># df -h</span>Filesystem                Size      Used Available Use% Mounted onoverlay                  60.0G     39.2G     20.8G  65% /tmpfs                    64.0M         0     64.0M   0% /devtmpfs                     3.8G         0      3.8G   0% /sys/fs/cgroup/dev/vda1                60.0G     39.2G     20.8G  65% /dev/termination<span class="token punctuation">-</span>log/dev/vda1                60.0G     39.2G     20.8G  65% /etc/resolv.conf/dev/vda1                60.0G     39.2G     20.8G  65% /etc/hostname/dev/vda1                60.0G     39.2G     20.8G  65% /etc/hostsshm                      64.0M         0     64.0M   0% /dev/shm/dev/rbd0               975.9M      2.5M    957.4M   0% /usr/share/nginx/html</code></pre><p>目录正常挂载</p><h1 id="四-配置Cephfs-Storageclass存储"><a href="#四-配置Cephfs-Storageclass存储" class="headerlink" title="四 配置Cephfs Storageclass存储"></a>四 配置Cephfs Storageclass存储</h1><h3 id="4-1-配置mds服务"><a href="#4-1-配置mds服务" class="headerlink" title="4.1 配置mds服务"></a>4.1 配置mds服务</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f filesystem.yaml</code></pre><p>确认服务启动</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master examples<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n rook-ceph | grep mds</span>rook-ceph-mds-myfs-a-6b85579bfb-zm999           1/1     Running     0          22mrook-ceph-mds-myfs-b-b98899f44-q88ps            1/1     Running     0          22m</code></pre><h3 id="4-2-创建Storageclass"><a href="#4-2-创建Storageclass" class="headerlink" title="4.2 创建Storageclass"></a>4.2 创建Storageclass</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f storageclass.yaml</code></pre><p>查看确认</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get sc</span>rook-ceph-block   rook-ceph.rbd.csi.ceph.com      Delete          Immediate           <span class="token boolean">true</span>                   88mrook-cephfs       rook-ceph.cephfs.csi.ceph.com   Delete          Immediate           <span class="token boolean">true</span>                   48m</code></pre><h3 id="4-3-测试文件共享"><a href="#4-3-测试文件共享" class="headerlink" title="4.3 测试文件共享"></a>4.3 测试文件共享</h3><p>创建两个pod</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span><span class="token number">2</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>demo<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span><span class="token number">1</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>demo<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>demo<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>cephfs</code></pre><p>一个容器创建文件 登录其他容器确认是否可以看到</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it pod-vol-ceph-1 /bin/sh</span>kubectl exec <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed in a future version. Use kubectl exec <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead./ <span class="token comment" spellcheck="true"># touch /usr/share/nginx/html/test</span></code></pre><p>登录另一个容器测试</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it pod-vol-ceph-2 /bin/sh</span>kubectl exec <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed in a future version. Use kubectl exec <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead./ <span class="token comment" spellcheck="true"># ls /usr/share/nginx/html/</span>index.html  test</code></pre>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s部署postgresql</title>
      <link href="/3bb5eb95/"/>
      <url>/3bb5eb95/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一 前言"></a>一 前言</h1><p>我这里是使用deployment 部署的一般用于测试和开发环境服务需求,生产环境建议还是使用公有云</p><h1 id="二-部署"><a href="#二-部署" class="headerlink" title="二 部署"></a>二 部署</h1><h3 id="2-1-配置持久卷"><a href="#2-1-配置持久卷" class="headerlink" title="2.1 配置持久卷"></a>2.1 配置持久卷</h3><p>我这里sc使用的rbd的storageclass</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>postgresql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>cephfs</code></pre><h3 id="2-2-配置deploy"><a href="#2-2-配置deploy" class="headerlink" title="2.2 配置deploy"></a>2.2 配置deploy</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab      <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab        <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>12.6<span class="token punctuation">-</span>alpine          <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_USER              <span class="token key atrule">value</span><span class="token punctuation">:</span> gitlab            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_DB              <span class="token key atrule">value</span><span class="token punctuation">:</span> gitlabhq_production            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_PASSWORD              <span class="token key atrule">value</span><span class="token punctuation">:</span> bogeusepg            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5432</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> exec pg_isready <span class="token punctuation">-</span>U gitlab <span class="token punctuation">-</span>h 127.0.0.1 <span class="token punctuation">-</span>p 5432 <span class="token punctuation">-</span>d gitlabhq_production            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">110</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> exec pg_isready <span class="token punctuation">-</span>U gitlab <span class="token punctuation">-</span>h 127.0.0.1 <span class="token punctuation">-</span>p 5432 <span class="token punctuation">-</span>d gitlabhq_production            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">20</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">resources</span><span class="token punctuation">:</span>            <span class="token key atrule">requests</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi            <span class="token key atrule">limits</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/postgresql/data      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>postgresql</code></pre><h3 id="2-3-创建svc"><a href="#2-3-创建svc" class="headerlink" title="2.3 创建svc"></a>2.3 创建svc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5432</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL</code></pre>]]></content>
      
      
      <categories>
          
          <category> Datebases </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Databases </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s部署 Skywalking监控应用性能</title>
      <link href="/8d9023df/"/>
      <url>/8d9023df/</url>
      
        <content type="html"><![CDATA[<h1 id="一-简介"><a href="#一-简介" class="headerlink" title="一 简介"></a>一 简介</h1><p><strong>SkyWalking</strong> 是一个<strong>APM</strong> （应用程序性能监视器）系统，专门为<strong>微服务，云原生和基于容器</strong> （Docker，Kubernetes，Mesos）的体系结构而设计。<br><strong>SkyWalking</strong> 的功能包括对<strong>Cloud Native</strong> 体系结构中的分布式系统的监视，跟踪，诊断功能。核心功能如下:</p><ul><li>服务、服务实例、端点指标分析</li><li>根本原因分析，在运行时分析代码</li><li>服务拓扑图分析</li><li>服务、服务实例和端点依赖关系分析</li><li>检测慢速服务和端点</li><li>性能优化</li><li>分布式跟踪和上下文传播</li><li>数据库访问指标，检测慢速数据库访问语句（包括SQL语句）</li><li>报警</li><li>浏览器性能监控</li></ul><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>skywalking_ns.yaml</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking</code></pre><hr><p>oap-serviceaccount.yaml</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">release</span><span class="token punctuation">:</span> 8.3.0  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">release</span><span class="token punctuation">:</span> 8.3.0<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">,</span><span class="token string">"configmaps"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">release</span><span class="token punctuation">:</span> 8.3.0<span class="token key atrule">rules</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">,</span> <span class="token string">"endpoints"</span><span class="token punctuation">,</span> <span class="token string">"services"</span><span class="token punctuation">]</span>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"extensions"</span><span class="token punctuation">]</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"deployments"</span><span class="token punctuation">,</span> <span class="token string">"replicasets"</span><span class="token punctuation">]</span>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">release</span><span class="token punctuation">:</span> 8.3.0<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">release</span><span class="token punctuation">:</span> 8.3.0<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server<span class="token key atrule">subjects</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking</code></pre><hr><p>sky-deployment.yaml</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE          <span class="token key atrule">value</span><span class="token punctuation">:</span> elasticsearch7        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_NAMESPACE          <span class="token key atrule">value</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>cluster        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_CLUSTER_NODES          <span class="token key atrule">value</span><span class="token punctuation">:</span> elasticsearch.logs<span class="token punctuation">:</span><span class="token number">9200</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"6"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_BULK_ACTIONS          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"4000"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_FLUSH_INTERVAL          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"30"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_QUERY_MAX_SIZE          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"10000"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_QUERY_SEGMENT_SIZE          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"500"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"500"</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor33.huhuhahei.com/library/apache/skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server<span class="token punctuation">:</span>8.5.0<span class="token punctuation">-</span>es7        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server        <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.111.92.41  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30258</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">12800</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">12800</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30320</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">11800</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">11800</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><hr><p>sky-uideploy.yaml</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skyui  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> skyui  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> skyui    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_OAP_ADDRESS          <span class="token key atrule">value</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">:</span><span class="token number">12800</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_TIMEOUT          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"20000"</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/library/apache/skywalking<span class="token punctuation">-</span>ui<span class="token punctuation">:</span>8.5.0        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">name</span><span class="token punctuation">:</span> skyui        <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skyui  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.96.154.174  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>admin    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30185</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skyui  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><h1 id="三-访问查看"><a href="#三-访问查看" class="headerlink" title="三 访问查看"></a>三 访问查看</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/3481571111.png"><br>服务端已经配置好了 后面可以接入agent端</p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx 1.78编译安装</title>
      <link href="/6abca5b8/"/>
      <url>/6abca5b8/</url>
      
        <content type="html"><![CDATA[<h2 id="一-安装"><a href="#一-安装" class="headerlink" title="一 安装"></a><strong>一 安装</strong></h2><h3 id="1-1-安装所以要依赖"><a href="#1-1-安装所以要依赖" class="headerlink" title="1.1 安装所以要依赖"></a><strong>1.1 安装所以要依赖</strong></h3><pre class=" language-bash"><code class="language-bash">yum -y <span class="token function">install</span> gcc gcc-c++ lrzsz pcre-devel zlib-devel openssl openssl-devel</code></pre><h3 id="1-2-解压文件"><a href="#1-2-解压文件" class="headerlink" title="1.2 解压文件"></a><strong>1.2 解压文件</strong></h3><pre class=" language-bash"><code class="language-bash"><span class="token function">tar</span> xf nginx-1.17.8.tar.gz</code></pre><h3 id="1-3-编译"><a href="#1-3-编译" class="headerlink" title="1.3 编译"></a><strong>1.3 编译</strong></h3><pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> nginx-1.17.8/./configure --prefix<span class="token operator">=</span>/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_sub_module --with-stream --with-stream_ssl_preread_module</code></pre><h3 id="1-4-安装"><a href="#1-4-安装" class="headerlink" title="1.4 安装"></a><strong>1.4 安装</strong></h3><pre class=" language-bash"><code class="language-bash"><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><h2 id="二-优化"><a href="#二-优化" class="headerlink" title="二 优化"></a><strong>二 优化</strong></h2><h3 id="2-1-创建软连接"><a href="#2-1-创建软连接" class="headerlink" title="2.1 创建软连接"></a><strong>2.1 创建软连接</strong></h3><pre class=" language-bash"><code class="language-bash"><span class="token function">ln</span> -s /usr/local/nginx/sbin/* /usr/local/sbin/</code></pre><h3 id="2-2-创建server控制"><a href="#2-2-创建server控制" class="headerlink" title="2.2 创建server控制"></a><strong>2.2 创建server控制</strong></h3><pre class=" language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment" spellcheck="true">#chkconfig: - 99 20</span><span class="token comment" spellcheck="true">#description:Nginx Service l Control Script</span>PROG<span class="token operator">=</span><span class="token string">"/usr/local/nginx/sbin/nginx"</span>PIDF<span class="token operator">=</span><span class="token string">"/usr/local/nginx/logs/nginx.pid"</span><span class="token keyword">case</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token keyword">in</span>        start<span class="token punctuation">)</span>        <span class="token variable">$PROG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>        stop<span class="token punctuation">)</span>        <span class="token function">kill</span> -s QUIT <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $PIDF<span class="token variable">)</span></span><span class="token punctuation">;</span><span class="token punctuation">;</span>        restart<span class="token punctuation">)</span>        <span class="token variable">$0</span> stop        <span class="token variable">$0</span> start<span class="token punctuation">;</span><span class="token punctuation">;</span>        reload<span class="token punctuation">)</span>        <span class="token function">kill</span> -s HUP <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $PIDF<span class="token variable">)</span></span><span class="token punctuation">;</span><span class="token punctuation">;</span>        *<span class="token punctuation">)</span>        <span class="token keyword">echo</span> <span class="token string">"Usage: <span class="token variable">$0</span> &amp;#123;start|stop|restart|reload&amp;#125;"</span>        <span class="token keyword">exit</span> 1esac<span class="token keyword">exit</span> 0</code></pre><p><strong>添加权限</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">chmod</span> +x /etc/init.d/nginx</code></pre><p><strong>添加chkconfig</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">chkconfig</span> --add nginx</code></pre><p><strong>启动服务</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> nginx start</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ansible部署squid代理</title>
      <link href="/5624b5ae/"/>
      <url>/5624b5ae/</url>
      
        <content type="html"><![CDATA[<h3 id="Ansible部署squid代理"><a href="#Ansible部署squid代理" class="headerlink" title="Ansible部署squid代理"></a><strong>Ansible部署squid代理</strong></h3><p><strong>squid ansible部署文档</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> vps.1  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install squid      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=squid    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy passwd      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/opt/ansible/passwd dest=/etc/squid/passwd    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy config      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/opt/ansible/squid.conf dest=/etc/squid/squid.conf    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> stop firewlld      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=firewalld state=stopped enabled=no    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start squid      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=squid state=started enabled=yes</code></pre><p><strong>Squid 配置文件</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Recommended minimum configuration:</span><span class="token comment" spellcheck="true">#</span>auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/passwdauth_param basic realm proxyacl authenticated proxy_auth REQUIREDhttp_access allow authenticated<span class="token comment" spellcheck="true"># Example rule allowing access from your local networks.</span><span class="token comment" spellcheck="true"># Adapt to list your (internal) IP networks from where browsing</span><span class="token comment" spellcheck="true"># should be allowed</span>acl localnet src 10.0.0.0/8 <span class="token comment" spellcheck="true"># RFC1918 possible internal network</span>acl localnet src 172.16.0.0/12  <span class="token comment" spellcheck="true"># RFC1918 possible internal network</span>acl localnet src 192.168.0.0/16 <span class="token comment" spellcheck="true"># RFC1918 possible internal network</span>acl localnet src fc00<span class="token punctuation">:</span><span class="token punctuation">:</span>/7       <span class="token comment" spellcheck="true"># RFC 4193 local private network range</span>acl localnet src fe80<span class="token punctuation">:</span><span class="token punctuation">:</span>/10      <span class="token comment" spellcheck="true"># RFC 4291 link-local (directly plugged) machines</span>acl SSL_ports port 443acl Safe_ports port 80    <span class="token comment" spellcheck="true"># http</span>acl Safe_ports port 21    <span class="token comment" spellcheck="true"># ftp</span>acl Safe_ports port 443   <span class="token comment" spellcheck="true"># https</span>acl Safe_ports port 70    <span class="token comment" spellcheck="true"># gopher</span>acl Safe_ports port 210   <span class="token comment" spellcheck="true"># wais</span>acl Safe_ports port 1025<span class="token punctuation">-</span><span class="token number">65535  </span><span class="token comment" spellcheck="true"># unregistered ports</span>acl Safe_ports port 280   <span class="token comment" spellcheck="true"># http-mgmt</span>acl Safe_ports port 488   <span class="token comment" spellcheck="true"># gss-http</span>acl Safe_ports port 591   <span class="token comment" spellcheck="true"># filemaker</span>acl Safe_ports port 777   <span class="token comment" spellcheck="true"># multiling http</span>acl CONNECT method CONNECT<span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Recommended minimum Access Permission configuration:</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Deny requests to certain unsafe ports</span>http_access deny <span class="token tag">!Safe_ports</span><span class="token comment" spellcheck="true"># Deny CONNECT to other than secure SSL ports</span>http_access allow CONNECT <span class="token tag">!SSL_ports</span><span class="token comment" spellcheck="true"># Only allow cachemgr access from localhost</span>http_access allow localhost managerhttp_access deny manager<span class="token comment" spellcheck="true"># We strongly recommend the following be uncommented to protect innocent</span><span class="token comment" spellcheck="true"># web applications running on the proxy server who think the only</span><span class="token comment" spellcheck="true"># one who can access services on "localhost" is a local user</span><span class="token comment" spellcheck="true">#http_access deny to_localhost</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Example rule allowing access from your local networks.</span><span class="token comment" spellcheck="true"># Adapt localnet in the ACL section to list your (internal) IP networks</span><span class="token comment" spellcheck="true"># from where browsing should be allowed</span>http_access allow localnethttp_access allow localhost<span class="token comment" spellcheck="true"># And finally deny all other access to this proxy</span>http_access deny all<span class="token comment" spellcheck="true"># Squid normally listens to port 3128</span>http_port 8080<span class="token comment" spellcheck="true"># Uncomment and adjust the following to add a disk cache directory.</span><span class="token comment" spellcheck="true">#cache_dir ufs /var/spool/squid 100 16 256</span><span class="token comment" spellcheck="true"># Leave coredumps in the first cache dir</span>coredump_dir /var/spool/squid<span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Add any of your own refresh_pattern entries above these.</span><span class="token comment" spellcheck="true">#</span>refresh_pattern ^ftp<span class="token punctuation">:</span>   1440  20% 10080refresh_pattern ^gopher<span class="token punctuation">:</span>  1440  0%  1440refresh_pattern <span class="token punctuation">-</span>i (/cgi<span class="token punctuation">-</span>bin/<span class="token punctuation">|</span>\<span class="token punctuation">?</span>) 0 0%  0refresh_pattern .   0 20% 4320</code></pre><p><strong>创建密码文件</strong></p><pre class=" language-yaml"><code class="language-yaml">htpasswd <span class="token punctuation">-</span>c /opt/ansible/passwd test<span class="token comment" spellcheck="true"># 默认密码123456</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DevOps </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx代理添加缓存</title>
      <link href="/2eab2259/"/>
      <url>/2eab2259/</url>
      
        <content type="html"><![CDATA[<h3 id="添加配置"><a href="#添加配置" class="headerlink" title="添加配置"></a><strong>添加配置</strong></h3><p><strong>nginx.conf添加缓存配置</strong></p><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">proxy_cache_path</span> <span class="token operator">/</span>data<span class="token operator">/</span>cache levels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span> keys_zone<span class="token operator">=</span>cache_one<span class="token punctuation">:</span>200m inactive<span class="token operator">=</span>1d max_size<span class="token operator">=</span>30g<span class="token punctuation">;</span></code></pre><p><strong>nginx 子配置文件中引用配置</strong></p><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>htm<span class="token operator">|</span>html<span class="token operator">|</span>css<span class="token operator">|</span>js<span class="token operator">|</span><span class="token keyword">flv</span><span class="token operator">|</span>ico<span class="token operator">|</span>swf<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                <span class="token keyword">proxy_pass</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>huhuhahei<span class="token punctuation">.</span>cn<span class="token punctuation">;</span>                <span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>                <span class="token keyword">proxy_cache</span> cache_one<span class="token punctuation">;</span>                <span class="token keyword">proxy_cache_valid</span> <span class="token number">200</span> <span class="token number">302</span> 1h<span class="token punctuation">;</span>                <span class="token keyword">proxy_cache_valid</span> <span class="token number">301</span> 1d<span class="token punctuation">;</span>                <span class="token keyword">proxy_cache_valid</span> any 1m<span class="token punctuation">;</span>                <span class="token keyword">include</span> conf<span class="token punctuation">.</span>d<span class="token operator">/</span>steam_sub_filter<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>                <span class="token keyword">expires</span> 30d<span class="token punctuation">;</span>        <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span></code></pre><p><strong>配置完成重启nginx</strong></p><pre class=" language-bash"><code class="language-bash">nginx -s reload</code></pre><p><strong>查看缓存目录是否有生成文件</strong></p><pre class=" language-bash"><code class="language-bash">ll cache/total 100drwx------  18 nobody root     150 Mar 26 16:00 ./drwxr-xr-x   5 root   root      48 Apr 11 11:27 <span class="token punctuation">..</span>/drwx------ 167 nobody nogroup 4096 Apr 20 14:21 0/drwx------ 171 nobody nogroup 4096 Apr 20 14:20 1/drwx------ 157 nobody nogroup 4096 Apr 20 10:55 2/drwx------ 165 nobody nogroup 4096 Apr 20 10:55 3/drwx------ 177 nobody nogroup 4096 Apr 20 11:33 4/drwx------ 170 nobody nogroup 4096 Apr 20 14:21 5/drwx------ 176 nobody nogroup 4096 Apr 20 14:21 6/drwx------ 163 nobody nogroup 4096 Apr 20 07:14 7/drwx------ 169 nobody nogroup 4096 Apr 20 04:22 8/drwx------ 162 nobody nogroup 4096 Apr 20 14:21 9/drwx------ 164 nobody nogroup 4096 Apr 20 14:20 a/drwx------ 174 nobody nogroup 4096 Apr 20 11:33 b/drwx------ 180 nobody nogroup 4096 Apr 20 10:55 c/drwx------ 179 nobody nogroup 4096 Apr 20 14:20 d/drwx------ 160 nobody nogroup 4096 Apr 20 10:15 e/drwx------ 169 nobody nogroup 4096 Apr 20 10:58 f</code></pre><p><strong>文件正常生成 证明缓存配置已经生效</strong></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Goproxy 代理部署</title>
      <link href="/7b9f226b/"/>
      <url>/7b9f226b/</url>
      
        <content type="html"><![CDATA[<p><strong>goproxy安装配置(这次下载的是商业版本的)</strong></p><pre class=" language-yaml"><code class="language-yaml">curl <span class="token punctuation">-</span>L https<span class="token punctuation">:</span>//mirrors.host900.com/https<span class="token punctuation">:</span>//github.com/snail007/goproxy/blob/master/install_auto_commercial.sh <span class="token punctuation">|</span> bash</code></pre><p><strong>安装完成，配置目录是&#x2F;etc&#x2F;proxy</strong></p><p><strong>商业版本激活</strong></p><pre class=" language-bash"><code class="language-bash">proxy http</code></pre><p><strong>执行完上面的命令不需要操作会自动停止然后再目录下回出现一个.txt结尾的问题件,里面的内容就是机器码</strong></p><p><strong>激活方法参考</strong></p><p><a href="https://snail007.host900.com/goproxy/page/free_vs_commercial/">https://snail007.host900.com/goproxy/page/free_vs_commercial&#x2F;</a></p><p><strong>服务启动</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">nohup</span> proxy http -a test:123456:0:0 -t tcp -p <span class="token string">"0.0.0.0:8081"</span> -T tcp -P <span class="token string">"0.0.0.0:8080"</span> <span class="token operator">&amp;</span></code></pre><pre class=" language-bash"><code class="language-bash">参数介绍http 使用http协议进行代理-a 制定用户认证 用户名:密码:最大连接数:速度限制-t 指定协议-p 监听端口-T 后端服务协议-P 后端服务地址和端口</code></pre><p>官方文档<a href="https://snail007.host900.com/goproxy/manual/zh/#/?id=_2tcp%e4%bb%a3%e7%90%86">goproxy</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录一个nacos部署报错处理过程</title>
      <link href="/5d7d0bc/"/>
      <url>/5d7d0bc/</url>
      
        <content type="html"><![CDATA[<p>K8s默认只有ready的pod才能被作为svc的后端,但有时希望即使pod没有准备就绪，服务发现机制也能够发现所有匹配服务标签选择器的pod<br>针对这个需求可以配置一个注释</p><pre class=" language-bash"><code class="language-bash">service.alpha.kubernetes.io/tolerate-unready-endpoints：true</code></pre><p>表示允许将未就绪的pod作为后端服务<br>Nacos的svc就需要这个配置</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">service.alpha.kubernetes.io/tolerate-unready-endpoints</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> server      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7848</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None</code></pre><p>但是今日部署新的集群发现会出现这个报错</p><pre class=" language-bash"><code class="language-bash">2022/05/10 19:04:03 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:04 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:05 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:06 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:07 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:08 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:09 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:10 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:11 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:12 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:13 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:14 lookup nacos-headless on 192.168.0.10:53: no such host</code></pre><p>看报错是无法解析svc的域名 但是这个域名又不太对 svc的域名不应该是这个呀::(怒)这个报错上网搜索也没有记录 一顿操作后看到新的集群是1.20版本的 忽然想到是不是有地方和新版本不适配呢</p><p>上网一搜还真找到 这个注释可能会在新版本被去掉<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/05/2014853700.png"></p><p>于是添加新的字段<code> publishNotReadyAddresses: true</code><br>再次启动果然启动成功了</p><pre class=" language-bash"><code class="language-bash">NAME      READY   STATUS    RESTARTS   AGEnacos-0   1/1     Running   0          5m31snacos-1   1/1     Running   0          4m9snacos-2   1/1     Running   0          2m10s</code></pre><p>不禁感叹 真的是一个小配置 能让人忙活一下午:@(内伤)<br>记录下 看看是否有人会碰到这个问题</p>]]></content>
      
      
      <categories>
          
          <category> 开源项目 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fortio压测工具配置</title>
      <link href="/2d5d1649/"/>
      <url>/2d5d1649/</url>
      
        <content type="html"><![CDATA[<h1 id="一-Fortio简介"><a href="#一-Fortio简介" class="headerlink" title="一.Fortio简介"></a>一.Fortio简介</h1><p>Fortio这个名字来自希腊语φορτίο，意思是负载&#x2F;负担。最初是Istio的负载测试工具，现在为独立的项目。</p><p>Fortio是一个快速，小型（3Mb docker映像，具有最小的依赖性），可重用，可嵌入的go库以及命令行工具和服务器进程，该服务器包括简单的Web UI和结果的图形表示（均为单个延迟图）以及多重结果比较最小，最大，平均，qps和百分位图。</p><h1 id="二-Fortio部署"><a href="#二-Fortio部署" class="headerlink" title="二.Fortio部署"></a>二.Fortio部署</h1><p>yaml文件</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> fortio  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio    <span class="token key atrule">service</span><span class="token punctuation">:</span> fortio<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> http  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> fortio<span class="token punctuation">-</span>deploy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># This annotation causes Envoy to serve cluster.outbound statistics via 15000/stats</span>        <span class="token comment" spellcheck="true"># in addition to the stats normally served by Istio. The Circuit Breaking example task</span>        <span class="token comment" spellcheck="true"># gives an example of inspecting Envoy stats via proxy config.</span>        <span class="token key atrule">proxy.istio.io/config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>          <span class="token key atrule">proxyStatsMatcher</span><span class="token punctuation">:</span>            <span class="token key atrule">inclusionPrefixes</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">"cluster.outbound"</span>            <span class="token punctuation">-</span> <span class="token string">"cluster_manager"</span>            <span class="token punctuation">-</span> <span class="token string">"listener_manager"</span>            <span class="token punctuation">-</span> <span class="token string">"server"</span>            <span class="token punctuation">-</span> <span class="token string">"cluster.xds-grpc"</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> fortio        <span class="token key atrule">image</span><span class="token punctuation">:</span> fortio/fortio<span class="token punctuation">:</span>latest_release        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>fortio        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8079</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span>ping</code></pre><h1 id="三-压力测试"><a href="#三-压力测试" class="headerlink" title="三.压力测试"></a>三.压力测试</h1><h3 id="1-简单访问"><a href="#1-简单访问" class="headerlink" title="1.简单访问"></a>1.简单访问</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">export</span> FORTIO_POD<span class="token operator">=</span><span class="token punctuation">$(</span>kubectl get pods -l app<span class="token operator">=</span>fortio -o <span class="token string">'jsonpath=&amp;#123;.items[0].metadata.name&amp;#125;'</span><span class="token punctuation">)</span>kubectl <span class="token function">exec</span> <span class="token string">"<span class="token variable">$FORTIO_POD</span>"</span> -c fortio -- /usr/bin/fortio curl -quiet http://www.huhuhahei.cn</code></pre><h3 id="2-发送并发数为-2-的连接（-c-2），请求-20-次（-n-20）"><a href="#2-发送并发数为-2-的连接（-c-2），请求-20-次（-n-20）" class="headerlink" title="2.发送并发数为 2 的连接（-c 2），请求 20 次（-n 20）"></a>2.发送并发数为 2 的连接（<code>-c 2</code>），请求 20 次（<code>-n 20</code>）</h3><pre class=" language-bash"><code class="language-bash">kubectl <span class="token function">exec</span> <span class="token string">"<span class="token variable">$FORTIO_POD</span>"</span> -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 -loglevel Warning https://www.huhuhahei.cn</code></pre><blockquote><p>命令解释如下：</p><p>-c 表示并发数</p><p>-n 一共多少请求</p><p>-qps 每秒查询数，0 表示不限制</p><p>-loglevel 指定日志级别</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录一个Ceph集群数据卷挂载的问题</title>
      <link href="/7eaaabae/"/>
      <url>/7eaaabae/</url>
      
        <content type="html"><![CDATA[<p>当我们用ceph做k8s的动态存储时,特别是使用rdb存储,在pod重启是总会遇到无法挂载pvc的问题</p><p>关键报错</p><pre class=" language-bash"><code class="language-bash">MountVolume.WaitForAttach failed <span class="token keyword">for</span> volume <span class="token string">"pvc-9bb7c438-2328-47ed-bfbd-c261d111644e"</span> <span class="token keyword">:</span> rbd image k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47 is still being used</code></pre><p>这里显示pvc已经被其他的pod使用了,根本原因是之前的pod删除但是挂载的rbd文件并没有删除</p><p>解决方法是需要在ceph集群查看这个rbd文件挂载的位置</p><pre class=" language-bash"><code class="language-bash">rbd info k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47<span class="token comment" spellcheck="true">#通过这个命令可以查看到这个rbd文件的信息</span>rbd image <span class="token string">'kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47'</span><span class="token keyword">:</span>    size 10 GiB <span class="token keyword">in</span> 2560 objects    order 22 <span class="token punctuation">(</span>4 MiB objects<span class="token punctuation">)</span>    snapshot_count: 0    id: 3bfff12997ae2    block_name_prefix: rbd_data.3bfff12997ae2    format: 2    features:    op_features:    flags:    create_timestamp: Sat Dec 25 11:55:16 2021    access_timestamp: Sat Dec 25 11:55:16 2021    modify_timestamp: Sat Dec 25 11:55:16 2021</code></pre><pre class=" language-bash"><code class="language-bash">rados listwatchers -p k8s-pool rbd_header.3bfff12997ae2watcher<span class="token operator">=</span>192.168.0.135:0/1321540337 client.685758 cookie<span class="token operator">=</span>18446462598732840974<span class="token comment" spellcheck="true">#上面的命令可以查看到这个rbd文件挂载的节点</span></code></pre><p>查看到具体的节点到节点上查看rbd文件</p><pre class=" language-bash"><code class="language-bash"><span class="token function">ls</span> /dev/rbd/k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47 -llrwxrwxrwx 1 root root 10 May 27 15:46 /dev/rbd/k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47 -<span class="token operator">></span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/rbd7</code></pre><p>可以查看具体的rbd文件,然后卸载掉</p><pre class=" language-bash"><code class="language-bash">rbd unmap -o force /dev/rbd7</code></pre><p>在观察pod就可以正常挂载了</p>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Promethues通过node_export监控linux服务器</title>
      <link href="/93493f88/"/>
      <url>/93493f88/</url>
      
        <content type="html"><![CDATA[<p><strong>1.node_export下载</strong><br>这里直接使用wget下载，也可以通过官网下载<a href="https://prometheus.io/download/#node_exporter">https://prometheus.io/download/#node_exporter</a></p><pre class=" language-yaml"><code class="language-yaml">wget https<span class="token punctuation">:</span>//github.com/prometheus/node_exporter/releases/download/v1.2.2/node_exporter<span class="token punctuation">-</span>1.2.2.linux<span class="token punctuation">-</span>amd64.tar.gz</code></pre><hr><p><strong>2.安装</strong></p><pre class=" language-yaml"><code class="language-yaml">tar xf node_exporter<span class="token punctuation">-</span>1.2.2.linux<span class="token punctuation">-</span>amd64.tar.gzmv node_exporter<span class="token punctuation">-</span>1.2.2.linux<span class="token punctuation">-</span>amd64 /usr/local/node_exporterr</code></pre><hr><p><strong>3.启动服务</strong></p><pre class=" language-yaml"><code class="language-yaml">cd /usr/local/node_exporternohup ./node_exporter <span class="token punctuation">></span> node_export.log &amp;</code></pre><hr><p><strong>4.promethues添加job</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'Linux'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">'106.75.x.x:9100'</span></code></pre><hr><p><strong>5.grafana 添加模板并展示</strong><br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/1224276126.jpg"><br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2525040169.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus通过Pushgateway监控网络链路</title>
      <link href="/d4b67256/"/>
      <url>/d4b67256/</url>
      
        <content type="html"><![CDATA[<p><strong>1.docker启动pushgateway</strong></p><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>itd <span class="token punctuation">-</span><span class="token punctuation">-</span>name PushGateway <span class="token punctuation">-</span>p 9091<span class="token punctuation">:</span>9091 prom/pushgateway</code></pre><hr><p><strong>2.服务器内编写脚本监控网络并将格式转化为prometheus支持的</strong></p><p>&#96;&#96;&#96;yaml<br>#!&#x2F;bin&#x2F;bash<br>#<br>#####################################<br>#@brief 功能：监控网路丢包率和延迟 -s 是一个ping包的大小 -W 是延迟timeout -c 是发生多少数据包<br>#@author xiajing<br>#@version 1.0<br>#@date 2021&#x2F;01&#x2F;13<br>#@log no<br>#####################################<br>#shell Env<br>#ping发包数<br>c_times&#x3D;200<br>#IP列表数组<br>ip_arr&#x3D;( 118.193.x.x)<br>for (( i &#x3D; 0; i &lt; $</p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Pushgateway </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheus配置nginx监控</title>
      <link href="/bd372af0/"/>
      <url>/bd372af0/</url>
      
        <content type="html"><![CDATA[<p>本篇主要介绍通过nginx-vts来获取nginx监控情况 <strong>1.nginx编译安装需要添加vts模块</strong></p><pre class=" language-bash"><code class="language-bash">./configure --prefix<span class="token operator">=</span>/usr/local/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_stub_status_module --add-module<span class="token operator">=</span><span class="token punctuation">..</span>/nginx-module-vts/ --with-http_ssl_module<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><p>nginx -V查看模块是否添加成功 <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/644249520.png"></p><p><strong>2.nginx配置文件添加配置</strong></p><pre class=" language-bash"><code class="language-bash">http下配置这两个参数vhost_traffic_status_zone<span class="token punctuation">;</span>vhost_traffic_status_filter_by_host on<span class="token punctuation">;</span>server段server <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>        listen 8089<span class="token punctuation">;</span>        server_name localhost<span class="token punctuation">;</span>        root html<span class="token punctuation">;</span>        index index.html index.php<span class="token punctuation">;</span>    location /status <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>                        vhost_traffic_status_display<span class="token punctuation">;</span>                        vhost_traffic_status_display_format html<span class="token punctuation">;</span>      <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;</span></code></pre><p><strong>3.配置完成重启服务 通过ip+prot&#x2F;status访问</strong></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/462020058.png"></p><p><strong>4.nginx-vts-exporter下载并配置</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> -c https://github.com/hnlq715/nginx-vts-exporter/releases/download/v0.9.1/nginx-vts-exporter-0.9.1.linux-amd64.tar.gz<span class="token function">mkdir</span> /usr/local/nginx-vts-exporter<span class="token function">tar</span> xf nginx-vts-exporter-0.9.1.linux-amd64.tar.gz -C /usr/local/nginx-vts-exporter<span class="token function">nohup</span> ./nginx-vts-exporter -nginx.scrape_timeout 10 -nginx.scrape_uri http://172.19.0.3:8082/status/format/json <span class="token operator">&amp;</span></code></pre><p><strong>5.promethues添加配置</strong></p><pre class=" language-bash"><code class="language-bash">- job_name: <span class="token string">'Nginx'</span>    static_configs:    - targets:      - <span class="token string">'106.75.x.x:9913'</span></code></pre><p><strong>6.grafana导入模板并查看</strong></p><blockquote><p>导入nginx模板</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/501805390.png"></p><blockquote><p>结果展示</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/3857789207.png"></p><p>[[[<strong>1</strong>]   ]   ]    <a href="https://www.huhuhahei.cn/usr/uploads/2021/08/644249520.png">https://www.huhuhahei.cn/usr/uploads/2021/08/644249520.png</a> </p><p>[[[<strong>2</strong>]   ]   ]    <a href="http://www.huhuhahei.cn/usr/uploads/2021/08/462020058.png">http://www.huhuhahei.cn/usr/uploads/2021/08/462020058.png</a> </p><p>[[[<strong>3</strong>]   ]   ]    <a href="https://www.huhuhahei.cn/usr/uploads/2021/08/501805390.png">https://www.huhuhahei.cn/usr/uploads/2021/08/501805390.png</a> </p><p>[[[<strong>4</strong>]   ]   ]    <a href="https://www.huhuhahei.cn/usr/uploads/2021/08/3857789207.png">https://www.huhuhahei.cn/usr/uploads/2021/08/3857789207.png</a> </p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheus监控Mysql</title>
      <link href="/db43c3bf/"/>
      <url>/db43c3bf/</url>
      
        <content type="html"><![CDATA[<p><strong>1.安装mysql_exporter</strong></p><pre class=" language-yaml"><code class="language-yaml">wget  https<span class="token punctuation">:</span>//github.com/prometheus/mysqld_exporter/releases/download/v0.12.1/mysqld_exporter<span class="token punctuation">-</span>0.12.1.linux<span class="token punctuation">-</span>amd64.tar.gz</code></pre><p>解压</p><pre class=" language-yaml"><code class="language-yaml">tar zxvf mysqld_exporter<span class="token punctuation">-</span>0.12.1.linux<span class="token punctuation">-</span>amd64.tar.gzmv mysqld_exporter<span class="token punctuation">-</span>0.12.1.linux<span class="token punctuation">-</span>amd64 /usr/local/mysql_exportercd /usr/local/mysql_exporter</code></pre><hr><p><strong>2.在mysql中创建exporter用户并赋予权限</strong></p><pre class=" language-yaml"><code class="language-yaml">CREATE USER 'exporter'@'localhost' IDENTIFIED BY '123456';  GRANT PROCESS<span class="token punctuation">,</span> REPLICATION CLIENT<span class="token punctuation">,</span> SELECT ON *.* TO 'exporter'@'localhost';flush privileges;</code></pre><hr><p><strong>3.创建配置文件</strong></p><pre class=" language-yaml"><code class="language-yaml">vim /usr/local/mysql_exporter/.my.cnf<span class="token punctuation">[</span>client<span class="token punctuation">]</span>user=exporterpassword=000000</code></pre><hr><p><strong>4.启动</strong></p><pre class=" language-yaml"><code class="language-yaml">nohup ./mysqld_exporter <span class="token punctuation">-</span><span class="token punctuation">-</span>config.my<span class="token punctuation">-</span>cnf=.my.cnf &amp;</code></pre><hr><p><strong>5.测试访问ip：9104</strong><br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2077839008.png"></p><hr><p><strong>6.Prometheus添加节点</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'Mysql'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">'10.7.110.221:9104'</span></code></pre><hr><p><strong>7.Grafana添加模板7362后查看监控</strong></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2547906164.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Operator监控Ingress-nginx</title>
      <link href="/717770d1/"/>
      <url>/717770d1/</url>
      
        <content type="html"><![CDATA[<h1 id="一、创建ServiceMonitor"><a href="#一、创建ServiceMonitor" class="headerlink" title="一、创建ServiceMonitor"></a>一、创建ServiceMonitor</h1><p>yaml文件如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>scraping  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s    <span class="token key atrule">path</span><span class="token punctuation">:</span> /metrics    <span class="token key atrule">port</span><span class="token punctuation">:</span> metrics  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> app  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx</code></pre><p>创建并查看</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master servicemonitor<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f servicemonitor.yaml</span><span class="token punctuation">[</span>root@master servicemonitor<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get servicemonitor -n ingress-nginx</span>NAME                     AGEnginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>scraping   4h18m</code></pre><h1 id="二、查看Prometheus日志"><a href="#二、查看Prometheus日志" class="headerlink" title="二、查看Prometheus日志"></a>二、查看Prometheus日志</h1><pre class=" language-yaml"><code class="language-yaml">level=error ts=2020<span class="token punctuation">-</span>12<span class="token punctuation">-</span>13T09<span class="token punctuation">:</span>52<span class="token punctuation">:</span>35.565Z caller=klog.go<span class="token punctuation">:</span>96 component=k8s_client_runtime func=ErrorDepth msg="/app/discovery/kubernetes/kubernetes.go<span class="token punctuation">:</span><span class="token key atrule">426</span><span class="token punctuation">:</span> Failed to watch <span class="token important">*v1</span>.Endpoints<span class="token punctuation">:</span> failed to list <span class="token important">*v1</span>.Endpoints<span class="token punctuation">:</span> endpoints is forbidden<span class="token punctuation">:</span> User \"system<span class="token punctuation">:</span>serviceaccount<span class="token punctuation">:</span>monitoring<span class="token punctuation">:</span>prometheus<span class="token punctuation">-</span>k8s\" cannot list resource \"endpoints\" in API group \"\" in the namespace \"ingress<span class="token punctuation">-</span>nginx\""</code></pre><p>可以看到是prometheus权限不足 需要修改下prometheus的clusterrole</p><pre class=" language-yaml"><code class="language-yaml">kubectl edit clusterrole prometheus<span class="token punctuation">-</span>k8s</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#rules的内容修改为以下参数</span><span class="token key atrule">rules</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">""</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> nodes  <span class="token punctuation">-</span> services  <span class="token punctuation">-</span> endpoints  <span class="token punctuation">-</span> pods  <span class="token punctuation">-</span> nodes/proxy  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> get  <span class="token punctuation">-</span> list  <span class="token punctuation">-</span> watch<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">""</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> configmaps  <span class="token punctuation">-</span> nodes/metrics  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> get<span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> /metrics  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> get</code></pre><p>再次查看prometheus上已经正常了</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>serviceMonitor/ingress-nginx/nginx-ingress-scraping/0 <span class="token punctuation">(</span>2/2 up<span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre><h1 id="三、Grafana添加模板"><a href="#三、Grafana添加模板" class="headerlink" title="三、Grafana添加模板"></a>三、Grafana添加模板</h1><p>ingress-nginx模板id <code>9614</code></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1026964335.png"></p><p>查看监控<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/2909168757.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Operator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Operator监控ETCD</title>
      <link href="/a00be237/"/>
      <url>/a00be237/</url>
      
        <content type="html"><![CDATA[<h1 id="一、配置etcd证书到prometheus"><a href="#一、配置etcd证书到prometheus" class="headerlink" title="一、配置etcd证书到prometheus"></a>一、配置etcd证书到prometheus</h1><p>对于 etcd 集群一般情况下，为了安全都会开启 https 证书认证的方式，所以要想让 Prometheus 访问到 etcd 集群的监控数据，就需要提供相应的证书校验。这里配置的是kubeadm</p><p>查看证书文件位置</p><pre><code>[root@master servicemonitor]# kubectl get pod etcd-master -n kube-system -o yaml......volumeMounts:    - mountPath: /var/lib/etcd      name: etcd-data    - mountPath: /etc/kubernetes/pki/etcd      name: etcd-certs</code></pre><p>可以看到etcd-certs挂载路径是&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd</p><p>获取证书文件后生成secret 挂载到pormetheus</p><pre><code>kubectl -n monitoring create secret generic etcd-certs --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.crt --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.key --from-file=/etc/kubernetes/pki/etcd/ca.crt</code></pre><h1 id="二、配置prometheus"><a href="#二、配置prometheus" class="headerlink" title="二、配置prometheus"></a>二、配置prometheus</h1><pre><code>[root@master servicemonitor]# kubectl -n monitoring edit prometheus k8s#spec添加下面字段spec......  secrets:  - etcd-certs#保存退出 进入prometheus确认证书是否配置成功[root@master servicemonitor]# kubectl -n monitoring exec -it prometheus-k8s-0 -c prometheus  -- sh/prometheus $ ls /etc/prometheus/secrets/etcd-certs/ca.crt                  healthcheck-client.crt  healthcheck-client.key#证书已经配置成功</code></pre><h1 id="三、创建ServiceMonitor"><a href="#三、创建ServiceMonitor" class="headerlink" title="三、创建ServiceMonitor"></a>三、创建ServiceMonitor</h1><p>ServiceMonitor</p><pre><code>apiVersion: monitoring.coreos.com/v1kind: ServiceMonitormetadata:  name: etcd-k8s  namespace: monitoring  labels:    k8s-app: etcd-k8sspec:  jobLabel: k8s-app  endpoints:  - port: port    interval: 30s    scheme: https    tlsConfig:      caFile: /etc/prometheus/secrets/etcd-certs/ca.crt      certFile: /etc/prometheus/secrets/etcd-certs/healthcheck-client.crt      keyFile: /etc/prometheus/secrets/etcd-certs/healthcheck-client.key      insecureSkipVerify: true  selector:    matchLabels:      k8s-app: etcd  namespaceSelector:    matchNames:    - kube-system</code></pre><p>server</p><pre><code>apiVersion: v1kind: Servicemetadata:  name: etcd-k8s  namespace: kube-system  labels:    k8s-app: etcdspec:  type: ClusterIP  clusterIP: None  ports:  - name: port    port: 2379    protocol: TCP---apiVersion: v1kind: Endpointsmetadata:  name: etcd-k8s  namespace: kube-system  labels:    k8s-app: etcdsubsets:- addresses:  - ip: 10.46.8.18    nodeName: etcd-master  ports:  - name: port    port: 2379    protocol: TCP</code></pre><p>apply</p><pre><code>[root@master servicemonitor]# kubectl apply -f etcd_servicemonitor.yaml[root@master servicemonitor]# kubectl apply -f etcdService.yaml</code></pre><p>可以查看prometheus中监控已经有了 <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1569924190.png"></p><p>grafana添加监控 模板3070 效果如下 <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1217887458.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Operator </tag>
            
            <tag> ETCD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux部署process_exporter监控进程情况</title>
      <link href="/7f800f4/"/>
      <url>/7f800f4/</url>
      
        <content type="html"><![CDATA[<p><strong>1.简介</strong> process-exporter主要用来做进程监控，比如某个服务的进程数、消耗了多少CPU、内存、IO资源等</p><p><strong>2.安装配置</strong></p><pre><code>wget http://github.com/ncabatoff/process-exporter/releases/download/v0.7.2/process-exporter-0.7.2.linux-amd64.tar.gztar -xvf process-exporter-0.7.2.linux-amd64.tar.gz  -C /usr/local/cd /usr/local/ln -s process-exporter-0.7.2.linux-amd64 process_exportercd process_exporter/ln -s process-exporter process_exportermkdir logs</code></pre><p><strong>3.添加需要监控的进程配置（需要自己创建）</strong> 配置文件路径<code>/usr/local/process_exporter/config.yaml</code></p><pre><code>process_names:  - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot;    cmdline:    - &#39;elasticsearch&#39;  - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot;    cmdline:    - &#39;logstash&#39;  - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot;    cmdline:    - &#39;kibana&#39;</code></pre><p><strong>4.启动</strong></p><pre><code>nohup ./process-exporter  -config.path=&quot;config.yaml&quot;  -web.listen-address=&quot;:9256&quot;&gt;&gt; logs/process-exporter.log 2&gt;&amp;1 &amp;#-config.path 指定进程配置文件#-web.listen-address 指定监听端口</code></pre><p><strong>5.prometheus添加对应配置</strong></p><pre><code>- job_name: &#39;process&#39;    static_configs:      - targets: [&#39;106.75.x.x:9256&#39;]</code></pre><p><strong>6.grafana添加对应模板</strong> <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/3998995538.png"> 最终展示 <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2866754558.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux部署Alertmanager对prometheus监控进行告警</title>
      <link href="/e5fe49d2/"/>
      <url>/e5fe49d2/</url>
      
        <content type="html"><![CDATA[<p><strong>1.简介</strong><br>Prometheus发出告警时分为两部分。首先，Prometheus按告警规则(rule_files配置块)向Alertmanager发送告警（即告警规则是在Prometheus上定义的）。然后，由Alertmanager来管理这些告警，包括去重(Deduplicating)、分组(Grouping)、静音(silencing)、抑制(inhibition)、聚合(aggregation )，最终将面要发出的告警通过电子邮件、webhook等方式将告警通知路由(route)给对应的联系人</p><hr><p><strong>2.安装Alertmanager</strong></p><pre class=" language-yaml"><code class="language-yaml">wget http<span class="token punctuation">:</span>//github.com/prometheus/alertmanager/releases/download/v0.20.0/alertmanager<span class="token punctuation">-</span>0.20.0.linux<span class="token punctuation">-</span>amd64.tar.gztar <span class="token punctuation">-</span>xvf alertmanager<span class="token punctuation">-</span>0.20.0.linux<span class="token punctuation">-</span>amd64.tar.gz mv alertmanager<span class="token punctuation">-</span>0.20.0.linux<span class="token punctuation">-</span>amd64 /usr/local/alertmanager</code></pre><hr><p><strong>3.编辑配置文件</strong><br>配置文件路径<code>/usr/local/alertmanager/alertmanager.yml</code></p><p>配置如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">global</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true">#全局配置</span>  <span class="token key atrule">resolve_timeout</span><span class="token punctuation">:</span> 5m    <span class="token key atrule">smtp_smarthost</span><span class="token punctuation">:</span> <span class="token string">'smtp.163.com:465'</span>  <span class="token comment" spellcheck="true">#smtp服务器的地址 我这里使用的是163的</span>  <span class="token key atrule">smtp_from</span><span class="token punctuation">:</span> <span class="token string">'liyonghui_1997@163.com'</span>  <span class="token comment" spellcheck="true">#发送邮件使用的邮箱</span>  <span class="token key atrule">smtp_auth_username</span><span class="token punctuation">:</span> <span class="token string">'liyonghui_1997@163.com'</span> <span class="token comment" spellcheck="true">#用于发送邮件时登录邮箱服务器的邮箱地址</span>  <span class="token key atrule">smtp_auth_password</span><span class="token punctuation">:</span> <span class="token string">'DRHMxxxxxxxxx'</span> <span class="token comment" spellcheck="true">#邮箱授权码 可以在163的邮箱设置中获取</span>  <span class="token key atrule">smtp_require_tls</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">templates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">'/usr/local/alertmanager/template/default.tmpl'</span> <span class="token comment" spellcheck="true">#发送邮件的模板 不需要的话可以不配置的 但是Alertmanager默认模板告警项不直观 且时间是UTC时间查看不方便</span><span class="token key atrule">route</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#默认路由规则</span>  <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">]</span>  <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 30s  <span class="token comment" spellcheck="true">#组等待同组告警默认等待30s</span>  <span class="token key atrule">group_interval</span><span class="token punctuation">:</span> 1m  <span class="token comment" spellcheck="true">#当一个新的告警组被创建时，需要等待'group_wait'后才发送初始通知。这样可以确保在发送等待前能聚合更多具有相同标签的告警，最后合并为一个通知发送</span>  <span class="token key atrule">repeat_interval</span><span class="token punctuation">:</span> 5m <span class="token comment" spellcheck="true">#告警发送间隔时间</span>  <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'mail'</span><span class="token key atrule">receivers</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'mail'</span> <span class="token comment" spellcheck="true">#发送方式</span>  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#接受方的邮箱</span>  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'www.2668416023@foxmail.com'</span>    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true  </span><span class="token comment" spellcheck="true">#是否发送恢复告警</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> '&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; template "default.html" . &amp;#125;&amp;#125;'  #模板的配置规则 如果不想配置的这里可以忽略</span>    <span class="token key atrule">headers</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123; Subject: "&amp;#123;&amp;#123; .GroupLabels.SortedPairs.Values &amp;#125;&amp;#125; [&amp;#123;&amp;#123; .Status | toUpper &amp;#125;&amp;#125;:&amp;#123;&amp;#123; .Alerts.Firing | len &amp;#125;&amp;#125;]" &amp;#125;</span>  <span class="token key atrule">inhibit_rules</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#告警抑制规则</span>  <span class="token punctuation">-</span> <span class="token key atrule">source_match</span><span class="token punctuation">:</span>      <span class="token key atrule">severity</span><span class="token punctuation">:</span> <span class="token string">'critical'</span>    <span class="token key atrule">target_match</span><span class="token punctuation">:</span>      <span class="token key atrule">severity</span><span class="token punctuation">:</span> <span class="token string">'warning'</span>    <span class="token key atrule">equal</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">,</span> <span class="token string">'dev'</span><span class="token punctuation">,</span> <span class="token string">'instance'</span><span class="token punctuation">]</span></code></pre><p>模板配置<br>路径<code>/usr/local/alertmanager/template/default.tmpl</code></p><pre class=" language-yaml"><code class="language-yaml">&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; define "default.html" &amp;#125;&amp;#125;</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123;- if gt (len .Alerts.Firing) 0 -&amp;#125;&amp;#125;</span><span class="token punctuation">[</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; .Status | toUpper &amp;#125;&amp;#125;:&amp;#123;&amp;#123; .Alerts.Firing | len &amp;#125;&amp;#125;]</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; range $i, $alert := .Alerts &amp;#125;&amp;#125;</span>&lt;pre<span class="token punctuation">></span>告警节点：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Labels "instance" &amp;#125;&amp;#125;</span>告警服务：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Labels "alertname" &amp;#125;&amp;#125;</span>报警详情：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Annotations "summary" &amp;#125;&amp;#125;</span>开始时间：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $alert.StartsAt.Local &amp;#125;&amp;#125;</span>&lt;/pre<span class="token punctuation">></span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; end &amp;#125;&amp;#125;</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; end &amp;#125;&amp;#125;</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123;- if gt (len .Alerts.Resolved) 0 -&amp;#125;&amp;#125;</span><span class="token punctuation">[</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; .Status | toUpper &amp;#125;&amp;#125;:&amp;#123;&amp;#123; .Alerts.Resolved | len &amp;#125;&amp;#125;]</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; range $i, $alert := .Alerts &amp;#125;&amp;#125;</span>&lt;pre<span class="token punctuation">></span>恢复节点：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Labels "instance" &amp;#125;&amp;#125;</span>恢复服务：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Labels "alertname" &amp;#125;&amp;#125;</span>状 <span class="token punctuation">?</span> <span class="token punctuation">?</span>态：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; index $alert.Status &amp;#125;&amp;#125;</span>开始时间：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $alert.StartsAt.Local &amp;#125;&amp;#125;</span>恢复时间：&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $alert.EndsAt.Local &amp;#125;&amp;#125;</span>&lt;/pre<span class="token punctuation">></span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; end &amp;#125;&amp;#125;</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123; end &amp;#125;&amp;#125;</span>&amp;<span class="token comment" spellcheck="true">#123;&amp;#123;- end &amp;#125;&amp;#125;</span></code></pre><p>配置完成后可以使用自带的工具检查下格式</p><pre class=" language-yaml"><code class="language-yaml">./amtool check<span class="token punctuation">-</span>config alertmanager.ymlChecking 'alertmanager.yml'  SUCCESS<span class="token key atrule">Found</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> global config <span class="token punctuation">-</span> route <span class="token punctuation">-</span> 1 inhibit rules <span class="token punctuation">-</span> 1 receivers <span class="token punctuation">-</span> 1 templates  SUCCESS</code></pre><hr><p><strong>4.启动</strong><br>我是使用的nohup启动的 也可以使用systemctl来启动</p><pre class=" language-yaml"><code class="language-yaml">nohup /usr/local/alertmanager/alertmanager <span class="token punctuation">-</span><span class="token punctuation">-</span>config.file=/usr/local/alertmanager/alertmanager.yml <span class="token punctuation">-</span><span class="token punctuation">-</span>storage.path=/usr/local/alertmanager/data <span class="token punctuation">-</span><span class="token punctuation">-</span>web.listen<span class="token punctuation">-</span>address=0.0.0.0<span class="token punctuation">:</span>9093 <span class="token punctuation">-</span><span class="token punctuation">-</span>data.retention=120h<span class="token punctuation">></span><span class="token punctuation">></span> /usr/local/alertmanager/logs/alertmanager.log 2<span class="token punctuation">></span><span class="token important">&amp;1</span> &amp;</code></pre><p>查看进程是否正常运行</p><pre class=" language-yaml"><code class="language-yaml">ps <span class="token punctuation">-</span>ef <span class="token punctuation">|</span> grep alerroot     16687 30885  0 15<span class="token punctuation">:</span>08 pts/1    00<span class="token punctuation">:</span>00<span class="token punctuation">:</span>00 grep <span class="token punctuation">-</span><span class="token punctuation">-</span>color=auto alerroot     30680     1  0 13<span class="token punctuation">:</span>16 <span class="token punctuation">?</span>        00<span class="token punctuation">:</span>00<span class="token punctuation">:</span>05 /usr/local/alertmanager/alertmanager <span class="token punctuation">-</span><span class="token punctuation">-</span>config.file=/usr/local/alertmanager/alertmanager.yml <span class="token punctuation">-</span><span class="token punctuation">-</span>storage.path=/usr/local/alertmanager/data <span class="token punctuation">-</span><span class="token punctuation">-</span>web.listen<span class="token punctuation">-</span>address=0.0.0.0<span class="token punctuation">:</span>9093 <span class="token punctuation">-</span><span class="token punctuation">-</span>data.retention=120h</code></pre><hr><p><strong>5.prometheus添加配置</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">alerting</span><span class="token punctuation">:</span>  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token string">'118.193.x.x:9093'</span> <span class="token comment" spellcheck="true">#Alertmanager节点</span><span class="token comment" spellcheck="true"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span><span class="token key atrule">rule_files</span><span class="token punctuation">:</span>   <span class="token punctuation">-</span> <span class="token string">"rules/*_rules.yml"</span>   <span class="token comment" spellcheck="true">#告警规则配置文件</span>   <span class="token punctuation">-</span> <span class="token string">"rules/*_alerts.yml"</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'alertmanager'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'118.193.37.64:9093'</span><span class="token punctuation">]</span></code></pre><p>重载配置</p><pre class=" language-yaml"><code class="language-yaml">kill <span class="token punctuation">-</span>HUP 18892</code></pre><p>配置没问题的话 就可以在prometheus界面看到Alertmanager<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/939254483.jpg"></p><hr><p><strong>6.配置告警规则</strong><br>分为两个文件：<br><code>node_alerts.yml</code>这个主要配置告警的阈值和发送的文本<br><code>node_rules.yml</code>主要配置告警的规则</p><p>配置如下<br><code>node_rules.yml</code></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> node_rules    <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_cpu_usage      <span class="token key atrule">expr</span><span class="token punctuation">:</span> 100 <span class="token punctuation">-</span> avg(irate(node_cpu_seconds_total&amp;<span class="token comment" spellcheck="true">#123;mode="idle"&amp;#125;[1m])) by (instance) * 100</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_type</span><span class="token punctuation">:</span> CPU_monitor    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_1m_load      <span class="token key atrule">expr</span><span class="token punctuation">:</span> node_load1      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_yepe</span><span class="token punctuation">:</span> load1m_monitor    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_mem_usage      <span class="token key atrule">expr</span><span class="token punctuation">:</span> 100 <span class="token punctuation">-</span> (node_memory_MemAvailable_bytes)/(node_memory_MemTotal_bytes) * 100      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_type</span><span class="token punctuation">:</span> Memory_monitor    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_root_partition_predit      <span class="token key atrule">expr</span><span class="token punctuation">:</span> node_filesystem_free_bytes&amp;<span class="token comment" spellcheck="true">#123;device="/dev/vda1", mountpoint="/"&amp;#125;/(1024*1024*1024)</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_type</span><span class="token punctuation">:</span> root_partition_monitor</code></pre><p><code>node_alerts.yml</code></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> node_alerts    <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> CPU使用率      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_cpu_usage <span class="token punctuation">></span> 80      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> 主机 &amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 CPU使用率持续1分钟超出阈值,当前为 &amp;#123;&amp;#123;humanize $value&amp;#125;&amp;#125; %</span>        <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> 系统一分钟负载      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_1m_load <span class="token punctuation">></span> 20      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> 主机 &amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 1分负载超出阈值,当前为 &amp;#123;&amp;#123;humanize $value&amp;#125;&amp;#125;</span>        <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> 内存使用率      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_mem_usage <span class="token punctuation">></span> 80      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> 主机 &amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 内存 使用率持续1分钟超出阈值,当前为 &amp;#123;&amp;#123;humanize $value&amp;#125;&amp;#125; %</span>        <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> 系统盘磁盘使用      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_root_partition_predit &lt; 10      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> 主机 &amp;<span class="token comment" spellcheck="true">#123;&amp;#123; $labels.instance &amp;#125;&amp;#125; 的 根分区 剩余可用空间只有 &amp;#123;&amp;#123;humanize $value&amp;#125;&amp;#125;GB,，请及时扩容和清理空间!!!!!</span></code></pre><p>配置完成重载<code>kill -HUP 18892</code></p><p>访问prometheus界面即可查看配置的规则<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/1841199424.jpg"><br>告警的状态<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/3354612842.jpg"></p><hr><p><strong>7.测试</strong><br>压测cpu看下是否可以正常收到告警</p><p><code>stress -c 2 -t 100000</code></p><p>prometheus查看告警规则已经变为pending状态 证明已经检测到这个告警<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/1183408278.jpg"><br>根据配置一分钟会如果没有恢复会变为firing状态<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2775594136.jpg"><br>稍等三十秒即可收到告警<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2705797334.jpg"><br>取消压测稍后会收到恢复告警<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2428281774.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Prometheus </tag>
            
            <tag> Alertmanager </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s Operater部署prometheus</title>
      <link href="/1fd45d82/"/>
      <url>/1fd45d82/</url>
      
        <content type="html"><![CDATA[<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><h3 id="1-1-Prometheus-Operator工作原理"><a href="#1-1-Prometheus-Operator工作原理" class="headerlink" title="1.1 Prometheus Operator工作原理"></a>1.1 Prometheus Operator工作原理</h3><p>从概念上来讲Operator就是针对管理特定应用程序的，在Kubernetes基本的Resource和Controller的概念上，以扩展Kubernetes api的形式。帮助用户创建，配置和管理复杂的有状态应用程序。从而实现特定应用程序的常见操作以及运维自动化。</p><p>在Kubernetes中我们使用Deployment、DamenSet，StatefulSet来管理应用Workload，使用Service，Ingress来管理应用的访问方式，使用ConfigMap和Secret来管理应用配置。我们在集群中对这些资源的创建，更新，删除的动作都会被转换为事件(Event)，Kubernetes的Controller Manager负责监听这些事件并触发相应的任务来满足用户的期望。这种方式我们成为声明式，用户只需要关心应用程序的最终状态，其它的都通过Kubernetes来帮助我们完成，通过这种方式可以大大简化应用的配置管理复杂度。</p><p>而除了这些原生的Resource资源以外，Kubernetes还允许用户添加自己的自定义资源(Custom Resource)。并且通过实现自定义Controller来实现对Kubernetes的扩展。</p><p>如下所示，是Prometheus Operator的架构示意图：<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/814160233.png"><br>Prometheus的本质就是一组用户自定义的CRD资源以及Controller的实现，Prometheus Operator负责监听这些自定义资源的变化，并且根据这些资源的定义自动化地完成如Prometheus Server自身以及配置的自动化管理工作。</p><h3 id="1-2-Prometheus-Operator作用"><a href="#1-2-Prometheus-Operator作用" class="headerlink" title="1.2 Prometheus Operator作用"></a>1.2 Prometheus Operator作用</h3><p>要了解Prometheus Operator能做什么，其实就是要了解Prometheus Operator为我们提供了哪些自定义的Kubernetes资源，列出了Prometheus Operator目前提供的️4类资源：</p><ul><li>Prometheus：声明式创建和管理Prometheus Server实例；</li><li>ServiceMonitor：负责声明式的管理监控配置；</li><li>PrometheusRule：负责声明式的管理告警配置；</li><li>Alertmanager：声明式的创建和管理Alertmanager实例。</li></ul><p>简言之，Prometheus Operator能够帮助用户自动化的创建以及管理Prometheus Server以及其相应的配置。</p><h1 id="二、实战配置"><a href="#二、实战配置" class="headerlink" title="二、实战配置"></a>二、实战配置</h1><h3 id="2-1部署Prometheus-Operator"><a href="#2-1部署Prometheus-Operator" class="headerlink" title="2.1部署Prometheus Operator"></a>2.1部署Prometheus Operator</h3><pre class=" language-docker"><code class="language-docker"><span class="token comment" spellcheck="true">#github项目地址，直接使用git拉下来即可</span>https<span class="token punctuation">:</span>//github.com/prometheus<span class="token punctuation">-</span>operator/kube<span class="token punctuation">-</span>prometheus<span class="token punctuation">[</span>root@k8smaster ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#git clone https://github.com/prometheus-operator/kube-prometheus</span><span class="token comment" spellcheck="true">#主要使用项目目录为`manifests`</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># pwd</span>/root/kube<span class="token punctuation">-</span>prometheus/manifests<span class="token comment" spellcheck="true">#开始创建所有服务</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span>kubectl create <span class="token punctuation">-</span>f ./setup<span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span>kubectl create <span class="token punctuation">-</span>f .<span class="token comment" spellcheck="true">#部署完成确认</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring get all</span>NAME                                       READY   STATUS    RESTARTS   AGEpod/alertmanager<span class="token punctuation">-</span>main<span class="token punctuation">-</span>0                    2/2     Running   0          13dpod/alertmanager<span class="token punctuation">-</span>main<span class="token punctuation">-</span>1                    2/2     Running   0          13dpod/alertmanager<span class="token punctuation">-</span>main<span class="token punctuation">-</span>2                    2/2     Running   0          13dpod/blackbox<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>6798fb5bb4<span class="token punctuation">-</span>64knd     3/3     Running   0          13dpod/grafana<span class="token punctuation">-</span>77f997786c<span class="token punctuation">-</span>4gbrh               1/1     Running   0          3h58mpod/kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>bdb774b4d<span class="token punctuation">-</span>mkrvk     3/3     Running   0          13dpod/node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>hn54g                    2/2     Running   0          13dpod/node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>jjxmr                    2/2     Running   0          13dpod/node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>qnppx                    2/2     Running   0          13dpod/prometheus<span class="token punctuation">-</span>adapter<span class="token punctuation">-</span>5b8db7955f<span class="token punctuation">-</span>6s97n    1/1     Running   0          13dpod/prometheus<span class="token punctuation">-</span>adapter<span class="token punctuation">-</span>5b8db7955f<span class="token punctuation">-</span>bp9bb    1/1     Running   0          13dpod/prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0                       2/2     Running   0          5h20mpod/prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>1                       2/2     Running   0          5h20mpod/prometheus<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>5685494db7<span class="token punctuation">-</span>tphkp   2/2     Running   0          13d<span class="token punctuation">...</span><span class="token punctuation">...</span>.</code></pre><h3 id="2-2-web界面查看"><a href="#2-2-web界面查看" class="headerlink" title="2.2 web界面查看"></a>2.2 web界面查看</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#通过查看server端口访问web界面</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get svc -n monitoring</span>NAME                    TYPE        CLUSTER<span class="token punctuation">-</span>IP       EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)prometheus<span class="token punctuation">-</span>k8s          NodePort    10.107.194.41    &lt;none<span class="token punctuation">></span>        9090<span class="token punctuation">:</span>32523/TC</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/586635708.png"></p><blockquote><p>所有监控都正常即可打开grafana查看服务自带的监控面板</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/1635828218.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker部署cadvisor监控容器</title>
      <link href="/985781f7/"/>
      <url>/985781f7/</url>
      
        <content type="html"><![CDATA[<p><strong>1.服务器直接docker启动cadvisor容器</strong></p><pre><code>docker run -d --volume=/:/rootfs:ro --volume=/var/run:/var/run:ro --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --volume=/dev/disk:/dev/disk:ro --publish=8080:8080 --detach=true --name=bj_agent_docker google/cadvisor:latest</code></pre><blockquote><p>主要方式就是通过映射本地文件来监控容器中cpu，内存，网络的使用情况</p></blockquote><p><strong>2.容器启动完成可以访问ip:8080打开cadvisor页面</strong> <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3454901946.jpg"></p><p><strong>3.prometheus添加监控项</strong></p><pre><code>- job_name: &#39;docker&#39;    static_configs:    - targets:      - &#39;106.75.x.x:8080&#39;</code></pre><p><strong>4.重载配置</strong></p><pre><code>kill -HUP 14083</code></pre><p><strong>5.grafana查看监控</strong> <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4223136120.jpg"></p><p>[[<strong>1</strong>]   ]   <a href="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3454901946.jpg">https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3454901946.jpg</a> </p><p>[[<strong>2</strong>]   ]    <a href="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4223136120.jpg">https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4223136120.jpg</a> </p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Docker部署Prometheus+Grafana监控云主机</title>
      <link href="/db991cc/"/>
      <url>/db991cc/</url>
      
        <content type="html"><![CDATA[<p><strong>1.需要先添加prometheus的默认配置文件</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># my global config</span><span class="token key atrule">global</span><span class="token punctuation">:</span>  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span>     15s <span class="token comment" spellcheck="true"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span>  <span class="token key atrule">evaluation_interval</span><span class="token punctuation">:</span> 15s <span class="token comment" spellcheck="true"># Evaluate rules every 15 seconds. The default is every 1 minute.</span>  <span class="token comment" spellcheck="true"># scrape_timeout is set to the global default (10s).</span> <span class="token comment" spellcheck="true"># Alertmanager configuration</span><span class="token key atrule">alerting</span><span class="token punctuation">:</span>  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> alertmanager<span class="token punctuation">:</span><span class="token number">9093</span> <span class="token comment" spellcheck="true"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span><span class="token key atrule">rule_files</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># - "first_rules.yml"</span>  <span class="token comment" spellcheck="true"># - "second_rules.yml"</span> <span class="token comment" spellcheck="true"># A scrape configuration containing exactly one endpoint to scrape:</span><span class="token comment" spellcheck="true"># Here it's Prometheus itself.</span><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># The job name is added as a label `job=&lt;job_name>` to any timeseries scraped from this config.</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'prometheus'</span>     <span class="token comment" spellcheck="true"># metrics_path defaults to '/metrics'</span>    <span class="token comment" spellcheck="true"># scheme defaults to 'http'.</span>    <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 5s    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9090'</span><span class="token punctuation">]</span></code></pre><hr><p><strong>2.直接直接使用官方镜像启动</strong></p><blockquote><p>我这边文件是在&#x2F;tmp下的</p></blockquote><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name=promethues <span class="token punctuation">-</span>p 9090<span class="token punctuation">:</span>9090 <span class="token punctuation">-</span>v /tmp/prometheus.yml<span class="token punctuation">:</span>/etc/prometheus/prometheus.yml prom/prometheus</code></pre><blockquote><p>默认端口是9090 可以直接ip：prot访问</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4279283483.jpg"></p><blockquote><p>页面可以正常打开 证明prometheus已经安装完成</p></blockquote><hr><p><strong>3.安装监控节点node_exporter</strong></p><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span>p 9100<span class="token punctuation">:</span>9100 <span class="token punctuation">-</span>v "/proc<span class="token punctuation">:</span>/host/proc<span class="token punctuation">:</span>ro" <span class="token punctuation">-</span>v "/sys<span class="token punctuation">:</span>/host/sys<span class="token punctuation">:</span>ro" <span class="token punctuation">-</span>v "/<span class="token punctuation">:</span>/rootfs<span class="token punctuation">:</span>ro"  prom/node<span class="token punctuation">-</span>exporter</code></pre><blockquote><p>默认端口是9100 可以直接ip：prot访问确认是否已经收集到数据</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2013638144.jpg"></p><blockquote><p>也可以在prometheus中查看是否有数据</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1268918424.jpg"></p><hr><p><strong>4.安装grafana做页面展示</strong></p><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name=grafana <span class="token punctuation">-</span>p 3000<span class="token punctuation">:</span>3000 grafana/grafana</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3958860042.jpg"></p><blockquote><p>默认账号密码均为admin</p><p>添加数据源选择prometheus，url选择promethues访问链接，并保存</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2130166801.jpg"></p><blockquote><p>导入模板选择9276（可以自己选择喜欢的）并保存</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1685660091.jpg"></p><blockquote><p>查看监控</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3583263766.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Prometheus </tag>
            
            <tag> Grafana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker部署smokeping监控网络质量</title>
      <link href="/ce36882f/"/>
      <url>/ce36882f/</url>
      
        <content type="html"><![CDATA[<p><strong>1.简介</strong></p><p>smokeping是一款监控网络稳定的开源软件，通过它可以监控到本地到各地的网络状况，如延时，丢包，并通过rrdtool制图方式，图形化地展示网络的延时。</p><hr><p><strong>2.配置</strong></p><blockquote><p>创建一个目录做数据持久化<br>mkdir -p &#x2F;data&#x2F;smokeping</p></blockquote><blockquote><p>防火墙放行11111端口并使用docker创建</p></blockquote><pre class=" language-yaml"><code class="language-yaml">docker create <span class="token punctuation">-</span><span class="token punctuation">-</span>name=smokeping <span class="token punctuation">-</span>e TZ=Asia/Chongqing <span class="token punctuation">-</span>p 11111<span class="token punctuation">:</span>80 <span class="token punctuation">-</span><span class="token punctuation">-</span>restart unless<span class="token punctuation">-</span>stopped <span class="token punctuation">-</span>v /data/smokeping/data<span class="token punctuation">:</span>/data <span class="token punctuation">-</span>v /data/smokeping/config<span class="token punctuation">:</span>/config linuxserver/smokeping</code></pre><blockquote><p>访问 <a href="http://ip:11111/">http://ip:11111</a></p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/205928601.png"></p><hr><p><strong>3.配置文件（主要有三个）</strong></p><blockquote><p>Database</p></blockquote><pre class=" language-yaml"><code class="language-yaml">*** Database ***step     = 60pings    = 60<span class="token comment" spellcheck="true"># consfn mrhb steps total</span>AVERAGE  0.5   1  1008AVERAGE  0.5  12  4320    MIN  0.5  12  4320    MAX  0.5  12  4320AVERAGE  0.5 144   720    MAX  0.5 144   720    MIN  0.5 144   720</code></pre><blockquote><p>Presentation 主要是 smokeping 的图表和第一栏的设置</p></blockquote><pre class=" language-yaml"><code class="language-yaml">*** Presentation ***template = /etc/smokeping/basepage.htmlcharset  = utf<span class="token punctuation">-</span><span class="token number">8</span>+ chartsmenu = 排行榜title = 排行榜++ stddevsorter = StdDev(entries=<span class="token punctuation">></span>4)title = 综合指标排名menu = 综合指标format = 综合指数 %f++ maxsorter = Max(entries=<span class="token punctuation">></span>5)title = 最大延迟menu = 最大延迟format = 最大延迟时间 %f 秒++ losssorter = Loss(entries=<span class="token punctuation">></span>5)title = 丢包率menu = 丢包率format = 丢包 %f++ mediansorter = Median(entries=<span class="token punctuation">></span>5)title = 中间数据包延迟menu = 中间数据包延迟format = 中间数据包延迟 RTT %f 秒+ overviewwidth = 600height = 50range = 10h+ detailwidth = 600height = 200unison_tolerance = 2"Last 1 Hours"    1h"Last 24 Hours"   24h"Last 7 Days"     7d"Last 30 Days"   30d<span class="token comment" spellcheck="true">#+ hierarchies</span><span class="token comment" spellcheck="true">#++ owner</span><span class="token comment" spellcheck="true">#title = Host Owner</span><span class="token comment" spellcheck="true">#++ location</span><span class="token comment" spellcheck="true">#title = Location</span></code></pre><blockquote><p>Targets 内则是监控的主体</p></blockquote><pre class=" language-yaml"><code class="language-yaml">Targets   probe = FPing        menu = Top title = Network Latency Grapher remark = Welcome to the SmokePing website of WORKS Company. \             Here you will learn all about the latency of our network.        + InternetSites        + baidu menu = 百度 title = 百度        ++ baidu menu = 百度 title = 百度 host = www.baidu.com        +Europe</code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> 开源项目 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql修改非事务引擎</title>
      <link href="/1aa41b34/"/>
      <url>/1aa41b34/</url>
      
        <content type="html"><![CDATA[<p>1.Mysql获取非事务引擎的命令</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> table_schema database_name<span class="token punctuation">,</span>table_name<span class="token punctuation">,</span><span class="token keyword">engine</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">,</span><span class="token string">'information_schema'</span><span class="token punctuation">,</span><span class="token string">'performance_schema'</span><span class="token punctuation">,</span><span class="token string">'sys'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token keyword">engine</span> <span class="token operator">&lt;></span> <span class="token string">'InnoDB'</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/248870415.png"></p><hr><p>2.获取修改存储引擎的脚本（执行表中的语句即可修改非事务引擎）</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> CONCAT<span class="token punctuation">(</span><span class="token string">'ALTER TABLE'</span><span class="token punctuation">,</span>table_schema<span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span>table_name<span class="token punctuation">,</span><span class="token string">'ENGINE=InnoDB;'</span><span class="token punctuation">)</span> sql_text <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">TABLES</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">,</span><span class="token string">'information_schema'</span><span class="token punctuation">,</span><span class="token string">'performance_schema'</span><span class="token punctuation">,</span><span class="token string">'sys'</span><span class="token punctuation">)</span><span class="token operator">AND</span> <span class="token keyword">engine</span> <span class="token operator">&lt;></span> <span class="token string">'InnoDB'</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/473742447.png"></p><hr><p>3.执行语句修改<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2944975847.png"></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql清理binlog日志</title>
      <link href="/ba01084/"/>
      <url>/ba01084/</url>
      
        <content type="html"><![CDATA[<p>Mysql 清理binlog日志</p><p>1.MySQL Binlog介绍</p><p>MySQL Binlog是以事件形式记录所有DDL(Data Definition Language 数据定义语言：Create、Drop和Alter)和DML(Data Manipulation Language 数据操控语言：Insert、Delete和Update)操作的二进制日志。</p><p>Binlog日志的两个重要的使用场景：</p><p>（1）MySQL主从复制</p><p>（2）数据库回档[数据恢复]</p><hr><p>2.MySQL Binlog过期时间</p><p>MySQL默认Binlog过期时间是7天，这里需要注意：Binlog日志过期时间是按照最新一个Binlog时间t1减7，而不是当前时间减7。比如：今天是14号，而最新Binlog最后的修改时间是9号，那么几号之前的Binlog会被清理呢？答案可能有点出乎意料，没错是9-7&#x3D;2，即2号之前的Binlog会被自动清理。</p><hr><p>3.MySQL Binlog日志清理</p><p>查看binlog文件列表</p><blockquote><p>show binary logs;</p></blockquote><p>查看当前写的binglog</p><blockquote><p>show master status\G</p></blockquote><p>方式一：清理除mysql-bin.000003日志以外的所有binlog日志</p><blockquote><p>purge binary logs to “mysql-bin.000003”;</p></blockquote><p>方式二：清理begin_time时间点前的日志</p><blockquote><p>purge binary logs before “$begin_time”;<br>日期格式：’2018-02-01 12:00:00’;</p></blockquote><hr><p>4.MySQL Binlog日志定时清理脚本</p><p>详情参考：<a href="https://blogs.starcto.com/purge-binary-logs/">https://blogs.starcto.com/purge-binary-logs/</a></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql修改密码</title>
      <link href="/f3a1699d/"/>
      <url>/f3a1699d/</url>
      
        <content type="html"><![CDATA[<p>Mysql修改密码的方法</p><p>1.使用set password 方式修改</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">set</span> password <span class="token keyword">for</span> root<span class="token variable">@localhost</span> <span class="token operator">=</span> password<span class="token punctuation">(</span><span class="token string">'123456'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3836760803.png"></p><hr><p>2.使用mysqladmin修改</p><pre class=" language-sql"><code class="language-sql">mysqladmin <span class="token operator">-</span>u root <span class="token operator">-</span>p123456 password <span class="token number">12345678</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3822327575.png"></p><hr><p>3.使用update user表的方式来修改</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">UPDATE</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">SET</span> authentication_string<span class="token operator">=</span>PASSWORD<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">;</span>flush <span class="token keyword">privileges</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4000690710.png"></p><p>注：mysql5.7以下 应该需要把authentication_string替换为password</p><hr><p>4.忘记密码可以选择这个方法</p><p>修改mysl配置文件添加skip-grant-tables（启动MySQL服务的时候跳过权限表认证）<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2702070504.png"></p><p>重启mysqld 并使用mysql -uroot -p 直接回车登陆<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/297340355.png"></p><p>使用第三种方法来修改密码</p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql数据表损坏恢复</title>
      <link href="/55893a1f/"/>
      <url>/55893a1f/</url>
      
        <content type="html"><![CDATA[<h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><p>某日登陆发现mysql表损坏，无法启动 ，可以借用如下方法恢复。</p><h1 id="二、恢复"><a href="#二、恢复" class="headerlink" title="二、恢复"></a>二、恢复</h1><h2 id="启动一个新库"><a href="#启动一个新库" class="headerlink" title="启动一个新库"></a>启动一个新库</h2><pre class=" language-sql"><code class="language-sql"><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqld_safe --defaults-file=/data/3308/my.conf &amp;</span><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ps -ef | grep 3308</span>root     <span class="token number">25776</span> <span class="token number">17533</span>  <span class="token number">0</span> <span class="token number">10</span>:<span class="token number">11</span> pts<span class="token operator">/</span><span class="token number">1</span>    <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">/</span>bin<span class="token operator">/</span>sh <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysqld_safe <span class="token comment" spellcheck="true">--defaults-file=/data/3308/my.conf</span>mysql    <span class="token number">25927</span> <span class="token number">25776</span>  <span class="token number">0</span> <span class="token number">10</span>:<span class="token number">11</span> pts<span class="token operator">/</span><span class="token number">1</span>    <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysqld <span class="token comment" spellcheck="true">--defaults-file=/data/3308/my.conf --basedir=/application/mysql/ --datadir=/data/3308/data --plugin-dir=/application/mysql//lib/plugin --user=mysql --log-error=db.err --pid-file=db.pid --socket=/data/3308/data/mysql.sock --port=3308</span>root     <span class="token number">25950</span> <span class="token number">17533</span>  <span class="token number">0</span> <span class="token number">10</span>:<span class="token number">12</span> pts<span class="token operator">/</span><span class="token number">1</span>    <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> grep <span class="token comment" spellcheck="true">--color=auto 3308</span></code></pre><h2 id="登陆3308恢复数据"><a href="#登陆3308恢复数据" class="headerlink" title="登陆3308恢复数据"></a>登陆3308恢复数据</h2><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#创建world库</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> world<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#使用之前的建表语句创建数据表</span>mysql<span class="token operator">></span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>city<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>ID<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>Name<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>CountryCode<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>District<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>Population<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>ID<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token keyword">KEY</span> <span class="token punctuation">`</span>CountryCode<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>CountryCode<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_district<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>District<span class="token punctuation">`</span><span class="token punctuation">)</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">4080</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>latin1<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#目前是没有数据的</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city<span class="token punctuation">;</span>Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#删除表空间</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> world<span class="token punctuation">.</span>city <span class="token keyword">discard</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#拷贝损坏表的表空间</span><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cp -a /application/mysql/data/world/city.ibd /data/3307/data/world/</span><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll /data/3307/data/world/</span>total <span class="token number">736</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql   8710 Nov  4 14:41 city.frm</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql 737280 Nov  2 16:26 city.ibd</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql     61 Nov  4 14:39 db.opt</span><span class="token comment" spellcheck="true">#导入表空间</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> world<span class="token punctuation">.</span>city <span class="token keyword">import</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#数据恢复</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">limit</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+----------------+-------------+---------------+------------+</span><span class="token operator">|</span> ID <span class="token operator">|</span> Name           <span class="token operator">|</span> CountryCode <span class="token operator">|</span> District      <span class="token operator">|</span> Population <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+----------------+-------------+---------------+------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> Kabul          <span class="token operator">|</span> AFG         <span class="token operator">|</span> Kabol         <span class="token operator">|</span>    <span class="token number">1780000</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> Qandahar       <span class="token operator">|</span> AFG         <span class="token operator">|</span> Qandahar      <span class="token operator">|</span>     <span class="token number">237500</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> Herat          <span class="token operator">|</span> AFG         <span class="token operator">|</span> Herat         <span class="token operator">|</span>     <span class="token number">186800</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> Mazar<span class="token number">-e</span><span class="token operator">-</span>Sharif <span class="token operator">|</span> AFG         <span class="token operator">|</span> Balkh         <span class="token operator">|</span>     <span class="token number">127800</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> Amsterdam      <span class="token operator">|</span> NLD         <span class="token operator">|</span> Noord<span class="token operator">-</span>Holland <span class="token operator">|</span>     <span class="token number">731200</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+----------------+-------------+---------------+------------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql CSR自动恢复</title>
      <link href="/fa85a72c/"/>
      <url>/fa85a72c/</url>
      
        <content type="html"><![CDATA[<h1 id="一、数据修改后没有commit-也没有记录redo-log"><a href="#一、数据修改后没有commit-也没有记录redo-log" class="headerlink" title="一、数据修改后没有commit 也没有记录redo.log"></a>一、数据修改后没有commit 也没有记录redo.log</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1584144069.jpg"><br><strong>数据更新后，尚未commit设备断电。服务启动后自动加载数据进入内存，因为redo.log无数据，所以数据根据undo.log拍摄的快照回滚并重新落盘</strong></p><h1 id="二、数据没有commit-但是写入了redo-log"><a href="#二、数据没有commit-但是写入了redo-log" class="headerlink" title="二、数据没有commit,但是写入了redo.log"></a>二、数据没有commit,但是写入了redo.log</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/447963019.png"><br><strong>redo buffer根据参数定时写入redo.log，但实际事务并未真正提交。此时设备断电，服务启动后加载数据到内存。</strong></p><ul><li>首先根据redo.log记录变更信息修改data buffer数据 将id 1修改为2</li><li>在根据undo buffer信息 发现没有commit 再次将数据进行回滚 将id 2修改为1</li><li>最后将id&#x3D;1 lsn&#x3D;100 txid&#x3D;100 写入磁盘</li></ul><h1 id="三、事务成功commit"><a href="#三、事务成功commit" class="headerlink" title="三、事务成功commit"></a>三、事务成功commit</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/39761923.png"><br>事务成功提交，变更写入redo.log 并且undo.log记录commit</p><ul><li>首先根据redo.log记录变更信息修改data buffer数据 将id 1修改为2</li><li>undo.log有记录commit因此数据不会发生回滚</li><li>将id&#x3D;2 lsn&#x3D;101 txid&#x3D;101写入磁盘</li></ul>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql根据binlog恢复数据</title>
      <link href="/a6515af6/"/>
      <url>/a6515af6/</url>
      
        <content type="html"><![CDATA[<h1 id="一、准备数据"><a href="#一、准备数据" class="headerlink" title="一、准备数据"></a>一、准备数据</h1><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#创建db</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token number">db1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token number">db2</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token comment" spellcheck="true">#db1创建表并插入测试数据</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> <span class="token number">db1</span><span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> ti<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> ti <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">5</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">5</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ti<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#db2创建表并插入数据</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> <span class="token number">db2</span><span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> t2<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> t2 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t2<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="二、模拟删除数据"><a href="#二、模拟删除数据" class="headerlink" title="二、模拟删除数据"></a>二、模拟删除数据</h1><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">drop</span> <span class="token keyword">table</span> ti<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="三、使用binlog恢复"><a href="#三、使用binlog恢复" class="headerlink" title="三、使用binlog恢复"></a>三、使用binlog恢复</h1><p>使用mysqlbinlog工具查看日志的起始点</p><pre class=" language-sql"><code class="language-sql">mysqlbinlog <span class="token comment" spellcheck="true">--base64-output=decode-rows -vvv /application/mysql/data/mysql-bin.000008</span><span class="token comment" spellcheck="true">#起点</span><span class="token comment" spellcheck="true"># at 2787</span><span class="token comment" spellcheck="true">#211108 13:26:12 server id 1  end_log_pos 2878 CRC32 0x0357015f Querythread_id=exec_time=0error_code=0</span><span class="token keyword">SET</span> <span class="token keyword">TIMESTAMP</span><span class="token operator">=</span><span class="token number">1636349172</span><span class="token comment" spellcheck="true">/*!*/</span><span class="token punctuation">;</span><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token number">db1</span><span class="token comment" spellcheck="true">#结束</span><span class="token comment" spellcheck="true"># at 3722</span><span class="token comment" spellcheck="true">#211108 13:29:20 server id 1  end_log_pos 3753 CRC32 0x958a7d9c Xid = 230</span><span class="token keyword">COMMIT</span><span class="token comment" spellcheck="true">/*!*/</span><span class="token punctuation">;</span></code></pre><p>截取这一段日志，但是我们会发现这一段日志不只有db1的操作还有db2的操作 我们需要截取db1库的 所以需要添加参数-d</p><pre class=" language-sql"><code class="language-sql">mysqlbinlog <span class="token operator">-</span><span class="token number">d</span> <span class="token number">db1</span> <span class="token comment" spellcheck="true">--start-position=2787 --stop-position=3722 /application/mysql/data/mysql-bin.000008 >/tmp/back2.sql</span></code></pre><p>登陆db导入数据</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#先关闭binlog记录</span>mysql<span class="token operator">></span> <span class="token keyword">set</span> sql_log_bin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#导入截取的binlog</span>mysql<span class="token operator">></span> source <span class="token operator">/</span>tmp<span class="token operator">/</span>back2<span class="token punctuation">.</span>sql<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#查看数据已经恢复</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> <span class="token number">db1</span><span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+</span><span class="token operator">|</span> Tables_in_db1 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+</span><span class="token operator">|</span> ti            <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ti<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>当然这个方法其实局限性比较大只能恢复近期的数据 如果是很早之前创建的库的话 代价就比较大了</p><ul><li>1）可以用备份恢复+短时间内二进制日志，恢复到故障之前</li><li>2）非官方方法，binlog2sql，binlog取反，类似于Oracle的flushback</li><li>3）延时从库</li></ul><hr><h1 id="四、binlog日志的日常操作"><a href="#四、binlog日志的日常操作" class="headerlink" title="四、binlog日志的日常操作"></a>四、binlog日志的日常操作</h1><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#物理查看</span><span class="token punctuation">[</span>root<span class="token variable">@db01</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll /application/mysql/data/</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql      285 Mar  6  2017 mysql-bin.000001</span><span class="token comment" spellcheck="true">#命令行查看</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">binary</span> logs<span class="token punctuation">;</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#查看binlog事件</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> binlog events <span class="token operator">in</span> <span class="token string">'mysql-bin.000007'</span><span class="token punctuation">;</span></code></pre><p>设置binlog保留时间</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#临时生效</span><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> expire_logs_days <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#永久生效</span><span class="token punctuation">[</span>root<span class="token variable">@db01</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># vim /etc/my.cnf</span><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>expire_logs_days <span class="token operator">=</span> <span class="token number">7</span></code></pre><p>清除binlog</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#根据时间删除</span><span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS BEFORE <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> INTERVAL <span class="token number">3</span> day<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#根据文件名删除</span><span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS <span class="token keyword">TO</span> <span class="token string">'mysql-bin.000010'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#重置binlog</span>mysql<span class="token operator">></span> reset master<span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql开启慢日志</title>
      <link href="/414a2e2c/"/>
      <url>/414a2e2c/</url>
      
        <content type="html"><![CDATA[<h1 id="一、开启慢日志参数"><a href="#一、开启慢日志参数" class="headerlink" title="一、开启慢日志参数"></a>一、开启慢日志参数</h1><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#指定是否开启慢查询日志</span>slow_query_log <span class="token operator">=</span> <span class="token number">1</span><span class="token comment" spellcheck="true">#指定慢日志文件存放位置（默认在data）</span>slow_query_log_file<span class="token operator">=</span><span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>slow<span class="token punctuation">.</span>log<span class="token comment" spellcheck="true">#设定慢查询的阀值(默认10s)</span>long_query_time<span class="token operator">=</span><span class="token number">0.05</span><span class="token comment" spellcheck="true">#不使用索引的慢查询日志是否记录到日志</span>log_queries_not_using_indexes</code></pre><hr><h1 id="二、Mysqldumpslow"><a href="#二、Mysqldumpslow" class="headerlink" title="二、Mysqldumpslow"></a>二、Mysqldumpslow</h1><pre class=" language-bash"><code class="language-bash">参数说明:-s:是表示按照何种方式排序，c、t、l、r分别是按照记录次数、时间、查询时间、返回的记录数来排序，ac、at、al、ar，表示相应的倒叙；-t:是top n的意思，即为返回前面多少条的数据；-g:后边可以写一个正则匹配模式，大小写不敏感的；</code></pre><pre class=" language-sql"><code class="language-sql"><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqldumpslow -s c -t 10 /application/mysql/data/slow.log</span>Reading mysql slow query log <span class="token keyword">from</span> <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>slow<span class="token punctuation">.</span>logCount: <span class="token number">8</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>69s <span class="token punctuation">(</span>5s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">insert</span> <span class="token keyword">into</span> city_new <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city_newCount: <span class="token number">2</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>24s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">275000.0</span> <span class="token punctuation">(</span><span class="token number">550000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city_new <span class="token keyword">limit</span> NCount: <span class="token number">1</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>04s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>01s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">create</span> <span class="token keyword">table</span> city_new <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cityCount: <span class="token number">1</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>66s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">1.0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> city_newDied at <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysqldumpslow line <span class="token number">161</span><span class="token punctuation">,</span> <span class="token operator">&lt;></span> chunk <span class="token number">10</span><span class="token punctuation">.</span></code></pre><hr><h1 id="三、pt-query-digest日志分析工具"><a href="#三、pt-query-digest日志分析工具" class="headerlink" title="三、pt-query-digest日志分析工具"></a>三、pt-query-digest日志分析工具</h1><p>下载</p><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> https://downloads.percona.com/downloads/percona-toolkit/3.3.1/binary/redhat/7/x86_64/percona-toolkit-3.3.1-1.el7.x86_64.rpm</code></pre><p>yum安装</p><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> -y percona-toolkit-3.3.1-1.el7.x86_64.rpm</code></pre><p>分析日志</p><pre class=" language-bash"><code class="language-bash">pt-query-digest /application/mysql/data/slow.log</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql物理备份之Xtrabackup</title>
      <link href="/247e674/"/>
      <url>/247e674/</url>
      
        <content type="html"><![CDATA[<h1 id="一、Xtrabackup介绍"><a href="#一、Xtrabackup介绍" class="headerlink" title="一、Xtrabackup介绍"></a>一、Xtrabackup介绍</h1><p>MySQL冷备、<code>mysqldump</code>、MySQL热拷贝都无法实现对数据库进行增量备份。在实际生产环境中增量备份是非常实用的，如果数据大于50G或100G，存储空间足够的情况下，可以每天进行完整备份，如果每天产生的数据量较大，需要定制数据备份策略。例如每周实用完整备份，周一到周六实用增量备份。而<code>Percona-Xtrabackup</code>就是为了实现增量备份而出现的一款主流备份工具，<code>xtrabakackup</code>有2个工具，分别是<code>xtrabakup</code>、<code>innobakupe</code>。</p><p><code>Percona-xtrabackup</code>是 <code>Percona</code>公司开发的一个用于MySQL数据库物理热备的备份工具，支持MySQL、Percona server和MariaDB，开源免费，是目前较为受欢迎的主流备份工具。xtrabackup只能备份innoDB和xtraDB两种数据引擎的表，而不能备份MyISAM数据表。</p><hr><h1 id="二、Xtrabackup配置"><a href="#二、Xtrabackup配置" class="headerlink" title="二、Xtrabackup配置"></a>二、Xtrabackup配置</h1><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#安装依赖</span>yum -y <span class="token function">install</span> perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL<span class="token comment" spellcheck="true">#下载Xtrabackup</span><span class="token function">wget</span> <span class="token string">"https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/6/x86_64/percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm"</span><span class="token comment" spellcheck="true">#安装</span>yum localinstall percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm</code></pre><hr><h1 id="三、测试全量备份恢复"><a href="#三、测试全量备份恢复" class="headerlink" title="三、测试全量备份恢复"></a>三、测试全量备份恢复</h1><p>全量备份</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp /backup/full</code></pre><p>备份完成目录</p><pre class=" language-bash"><code class="language-bash">drwxr-x--- 2 root root      122 Nov  9 17:50 backup-rw-r----- 1 root root      430 Nov  9 17:50 backup-my.cnfdrwxr-x--- 2 root root       56 Nov  9 17:50 binlogdrwxr-x--- 2 root root       50 Nov  9 17:50 blogdrwxr-x--- 2 root root       62 Nov  9 17:50 ceshidrwxr-x--- 2 root root       54 Nov  9 17:50 chayidrwxr-x--- 2 root root       56 Nov  9 17:50 chayi2drwxr-x--- 2 root root       48 Nov  9 17:50 db1drwxr-x--- 2 root root       48 Nov  9 17:50 db2drwxr-x--- 2 root root       20 Nov  9 17:50 hhhhdrwxr-x--- 2 root root       92 Nov  9 17:50 huhuhaheidrwxr-x--- 2 root root       20 Nov  9 17:50 huhuhahei1-rw-r----- 1 root root 79691776 Nov  9 17:50 ibdata1-rw-r----- 1 root root 52428800 Nov  9 17:50 ibdata2drwxr-x--- 2 root root       60 Nov  9 17:50 inc1drwxr-x--- 2 root root       60 Nov  9 17:50 inc2drwxr-x--- 2 root root     4096 Nov  9 17:50 mysqldrwxr-x--- 2 root root       76 Nov  9 17:50 oldboydrwxr-x--- 2 root root     4096 Nov  9 17:50 performance_schemadrwxr-x--- 2 root root      160 Nov  9 17:50 slow_query_logdrwxr-x--- 2 root root      284 Nov  9 17:50 <span class="token function">test</span>drwxr-x--- 2 root root       66 Nov  9 17:50 test_binlogdrwxr-x--- 2 root root       76 Nov  9 17:50 wordpressdrwxr-x--- 2 root root      184 Nov  9 17:50 world-rw-r----- 1 root root       21 Nov  9 17:50 xtrabackup_binlog_info    <span class="token comment" spellcheck="true">#记录binlog文件名和binlog的位置点</span>-rw-r----- 1 root root      117 Nov  9 17:50 xtrabackup_checkpoints    <span class="token comment" spellcheck="true">#备份的类型、状态和LSN状态信息文件  </span>-rw-r----- 1 root root      458 Nov  9 17:50 xtrabackup_info    <span class="token comment" spellcheck="true">#备份汇总信息</span>-rw-r----- 1 root root     2560 Nov  9 17:50 xtrabackup_logfile    <span class="token comment" spellcheck="true">#备份的redo文件</span></code></pre><p>模拟mysql数据丢失</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#关闭数据库</span>/etc/init.d/mysqld stopShutting down MySQL<span class="token punctuation">..</span> SUCCESS<span class="token comment" spellcheck="true">#删除数据目录</span><span class="token function">rm</span> -rf /application/mysql/data/</code></pre><p>准备备份<br>将redo进行重做，已提交的写到数据文件，未提交的使用undo回滚，模拟CSR的过程</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log /backup/full</code></pre><p>拷贝数据</p><pre class=" language-bash"><code class="language-bash">innobackupex --copy-back /backup/full</code></pre><blockquote><p>这里需要注意恢复数据时没有指定数据目录 默认会从&#x2F;etc&#x2F;my.cnf中寻找 所以配置文件中需要指定数据库目录</p></blockquote><p>给拷贝的data目录权限</p><pre class=" language-bash"><code class="language-bash"><span class="token function">chown</span> -R mysql:mysql /application/mysql/data/</code></pre><p>启动数据库</p><pre class=" language-bash"><code class="language-bash">/etc/init.d/mysqld startStarting MySQL.Logging to <span class="token string">'/application/mysql/data/db.err'</span><span class="token keyword">.</span>SUCCESS<span class="token operator">!</span></code></pre><p>确认数据恢复</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> <span class="token keyword">backup</span>             <span class="token operator">|</span><span class="token operator">|</span> binlog             <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> ceshi              <span class="token operator">|</span><span class="token operator">|</span> chayi              <span class="token operator">|</span><span class="token operator">|</span> chayi2             <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">db1</span>                <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">db2</span>                <span class="token operator">|</span><span class="token operator">|</span> hhhh               <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> huhuhahei1         <span class="token operator">|</span><span class="token operator">|</span> inc1               <span class="token operator">|</span><span class="token operator">|</span> inc2               <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> oldboy             <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> slow_query_log     <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> test_binlog        <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">|</span> world              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">22</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec</code></pre><hr><h1 id="四、测试增量备份"><a href="#四、测试增量备份" class="headerlink" title="四、测试增量备份"></a>四、测试增量备份</h1><p>先进行全量备份</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp /backup/full</code></pre><p>模拟增加数据</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test1<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> test1<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> test1<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> test1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>进行增量备份</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp --incremental --incremental-basedir<span class="token operator">=</span>/backup/full /backup/test1--incremental：开启增量备份功能--incremental-basedir：上一次备份的路径</code></pre><p>确认备份是否完整</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#全备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-backupedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160492594last_lsn <span class="token operator">=</span> 160492594compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#增备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test1/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160492594to_lsn <span class="token operator">=</span> 160498235last_lsn <span class="token operator">=</span> 160498235compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>可以看到增备的from_lsn是全备的last_lsn 证明数据是完整的</p><p>再次模拟增加数据</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test2<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> test2<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> test2<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> test2 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test2<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>进行第二次增量备份</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp --incremental --incremental-basedir<span class="token operator">=</span>/backup/test1 /backup/test2</code></pre><p>再次确认备份完整性</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#全备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-backupedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160492594last_lsn <span class="token operator">=</span> 160492594compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#增备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test1/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160492594to_lsn <span class="token operator">=</span> 160498235last_lsn <span class="token operator">=</span> 160498235compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#二次增备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test2/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160498235to_lsn <span class="token operator">=</span> 160503761last_lsn <span class="token operator">=</span> 160503761compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>可以发现数据是完整的</p><p>模拟数据丢失</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#关闭数据库</span>/etc/init.d/mysqld stopShutting down MySQL<span class="token punctuation">..</span> SUCCESS<span class="token comment" spellcheck="true">#删除数据目录</span><span class="token function">rm</span> -rf /application/mysql/data/</code></pre><p>准备备份<br>1）full+inc1+inc2<br>2）需要将inc1和inc2按顺序合并到full中<br>3）分步骤进行–apply-log</p><p>第一步：在全备中apply-log时，只应用redo，不应用undo</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --redo-only /backup/full</code></pre><p>第二步：合并inc1合并到full中，并且apply-log，只应用redo，不应用undo</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --redo-only --incremental-dir<span class="token operator">=</span>/backup/test1 /backup/full</code></pre><p>第三步：合并inc2合并到full中，redo和undo都应用</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --incremental-dir<span class="token operator">=</span>/backup/test2 /backup/full</code></pre><p>第四步：整体full执行apply-log，redo和undo都应用</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log /backup/full</code></pre><p>确认数据完整</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-preparedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160503761last_lsn <span class="token operator">=</span> 160503761compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>恢复数据</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#拷贝数据</span>innobackupex --copy-back /backup/full<span class="token comment" spellcheck="true">#权限</span><span class="token function">chown</span> -R mysql:mysql /application/mysql/data<span class="token comment" spellcheck="true">#启动</span>/etc/init.d/mysqld start</code></pre><p>确认数据是否恢复</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test1<span class="token punctuation">.</span>test1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> secmysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test2<span class="token punctuation">.</span>test2<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><h1 id="五、测试差异备份"><a href="#五、测试差异备份" class="headerlink" title="五、测试差异备份"></a>五、测试差异备份</h1><p>首先还是进行增量备份</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp /backup/full</code></pre><p>模拟数据变更</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> chayi1<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> chayi1<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ERROR <span class="token number">1046</span> <span class="token punctuation">(</span>3D000<span class="token punctuation">)</span>: <span class="token keyword">No</span> <span class="token keyword">database</span> selectedmysql<span class="token operator">></span> <span class="token keyword">use</span> chayi1<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> chayi1<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> chayi1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">2</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>模拟第二次数据变化</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> chayi2<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> chayi2<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> chayi22<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec）mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> chayi22 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">2</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi22<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>确认数据完整性</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#全备</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-backupedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160504901last_lsn <span class="token operator">=</span> 160504901compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#第一次差异备份</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat chayi1/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160504901to_lsn <span class="token operator">=</span> 160510578last_lsn <span class="token operator">=</span> 160510578compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#第二次差异备份</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat chayi2/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160504901to_lsn <span class="token operator">=</span> 160517449last_lsn <span class="token operator">=</span> 160517449compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>可以发现差异备份第一次和第二次的起点都是901</p><p>模拟数据丢失</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#关闭数据库</span>/etc/init.d/mysqld stopShutting down MySQL<span class="token punctuation">..</span> SUCCESS<span class="token comment" spellcheck="true">#删除数据目录</span><span class="token function">rm</span> -rf /application/mysql/data/</code></pre><p>准备数据</p><p>第一步：在全备中apply-log时，只应用redo，不应用undo</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --redo-only /backup/full</code></pre><p>第二步：合并最后一次差异备份，redo undo都做</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --incremental-dir<span class="token operator">=</span>/backup/chayi2 /backup/full</code></pre><p>第三步：整体full执行apply-log，redo和undo都应用</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log /backup/full</code></pre><p>恢复数据</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#拷贝数据</span>innobackupex --copy-back /backup/full<span class="token comment" spellcheck="true">#权限</span><span class="token function">chown</span> -R mysql:mysql /application/mysql/data<span class="token comment" spellcheck="true">#启动</span>/etc/init.d/mysqld start</code></pre><p>测试数据是否恢复</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi1<span class="token punctuation">.</span>chayi1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi2<span class="token punctuation">.</span>chayi22<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql逻辑备份之Mysqldump</title>
      <link href="/23a9b713/"/>
      <url>/23a9b713/</url>
      
        <content type="html"><![CDATA[<h1 id="一、mysqldump简介"><a href="#一、mysqldump简介" class="headerlink" title="一、mysqldump简介"></a>一、mysqldump简介</h1><p><code>mysqldump</code>是<code>mysql</code>自带的逻辑备份工具，它的备份原理是通过协议连接到 <code>MySQL</code> 数据库，将需要备份的数据查询出来，将查询出的数据转换成对应的<code>insert</code> 语句，当我们需要还原这些数据时，只要执行这些 <code>insert</code> 语句，即可将对应的数据还原。</p><hr><h1 id="二、备份命令"><a href="#二、备份命令" class="headerlink" title="二、备份命令"></a>二、备份命令</h1><p><strong>2.1命令格式</strong></p><pre class=" language-mysql"><code class="language-mysql">mysqldump [选项] 数据库名 [表名] > 脚本名</code></pre><p><strong>2.2 选项说明</strong></p><table><thead><tr><th>参数名</th><th>缩写</th><th>含义</th></tr></thead><tbody><tr><td>–host</td><td>-h</td><td>服务器IP地址</td></tr><tr><td>–port</td><td>-P</td><td>服务器端口号</td></tr><tr><td>–user</td><td>-u</td><td>MySQL 用户名</td></tr><tr><td>–pasword</td><td>-p</td><td>MySQL 密码</td></tr><tr><td>–databases</td><td></td><td>指定要备份的数据库</td></tr><tr><td>–all-databases</td><td></td><td>备份mysql服务器上的所有数据库</td></tr><tr><td>–compact</td><td></td><td>压缩模式，产生更少的输出</td></tr><tr><td>–comments</td><td></td><td>添加注释信息</td></tr><tr><td>–complete-insert</td><td></td><td>输出完成的插入语句</td></tr><tr><td>–lock-tables</td><td></td><td>备份前，锁定所有数据库表</td></tr><tr><td>–no-create-db&#x2F;–no-create-info</td><td></td><td>禁止生成创建数据库语句</td></tr><tr><td>–force</td><td></td><td>当出现错误时仍然继续备份操作</td></tr><tr><td>–default-character-set</td><td></td><td>指定默认字符集</td></tr><tr><td>–add-locks</td><td></td><td>备份数据库表时锁定数据库表</td></tr></tbody></table><p><strong>2.3演示</strong><br>备份指定数据库</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -uroot -p -h 172.19.0.3 typecho > typecho.sql</code></pre><p>备份所有数据库</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -uroot -p --all-databases > all.db</code></pre><p>备份指定数据库指定表</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -u root -p -h 172.19.0.3 typecho.typecho_access_log > typecho.db2</code></pre><p>备份指定排除某些表</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -uroot -p test --ignore-table=test.t1 --ignore-table=test.t2 > /backup/mysqldump/test2.db</code></pre><p>-B：指定库备份</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>B <span class="token number">db1</span> <span class="token operator">></span><span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span><span class="token number">db2</span><span class="token punctuation">.</span>sql</code></pre><p>-d：仅表结构</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span><span class="token number">d</span> <span class="token comment" spellcheck="true">--master-data=1 >/backup/full4.sql</span></code></pre><p>-t：仅数据</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span>t <span class="token comment" spellcheck="true">--master-data=1 >/backup/full4.sql</span></code></pre><p>–single-transaction：快照备份（热备）</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span>R <span class="token comment" spellcheck="true">--triggers --single-transaction --master-data=2 >/backup/full6.sql</span></code></pre><p>gzip:压缩备份（热备常用）</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span>R <span class="token comment" spellcheck="true">--triggers --single-transaction --master-data=2 | gzip >/backup/full_$(date +%F).sql.gz</span><span class="token comment" spellcheck="true">#zcat直接导出压缩</span>zcat <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span>full1<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>gz <span class="token operator">></span> <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span>full2<span class="token punctuation">.</span>sql</code></pre><hr><h1 id="三、数据导入"><a href="#三、数据导入" class="headerlink" title="三、数据导入"></a>三、数据导入</h1><p>3.1db命令导入（需要确认这个库或者表存在）</p><pre class=" language-mysql"><code class="language-mysql">mysql -u root -p -h 10.102.175.143 typecho < ./typecho.sql</code></pre><p>3.2 soure导入</p><pre class=" language-mysql"><code class="language-mysql">mysql > use db_namemysql > source /backup/mysqldump/db_name.db</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql延迟复制、半同步复制、过滤复制、GTID复制</title>
      <link href="/b0f44f6e/"/>
      <url>/b0f44f6e/</url>
      
        <content type="html"><![CDATA[<h1 id="一、延迟复制"><a href="#一、延迟复制" class="headerlink" title="一、延迟复制"></a>一、延迟复制</h1><h2 id="主库操作"><a href="#主库操作" class="headerlink" title="主库操作"></a>主库操作</h2><p>修改配置文件</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#开启binlog</span>log-bin<span class="token operator">=</span>mysql-binbinlog_format<span class="token operator">=</span>row<span class="token comment" spellcheck="true">#设置server_id</span>server_id<span class="token operator">=</span>1</code></pre><p>重启db</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># /etc/init.d/mysqld restart</span>Shutting down MySQL<span class="token punctuation">..</span><span class="token punctuation">..</span> SUCCESS<span class="token operator">!</span>Starting MySQL. SUCCESS<span class="token operator">!</span></code></pre><p>数据库中创建复制用户</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">grant</span> <span class="token keyword">replication</span> slave <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> rep@'<span class="token operator">%</span><span class="token string">' indetified by '</span><span class="token number">123456</span>'<span class="token punctuation">;</span></code></pre><hr><h2 id="从库操作"><a href="#从库操作" class="headerlink" title="从库操作"></a>从库操作</h2><p>修改配置文件</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#设置server_id 需要不等于1</span>server_id<span class="token operator">=</span>7</code></pre><p>查看主库binlog</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+----------+--------------+------------------+-------------------+</span><span class="token operator">|</span> <span class="token keyword">File</span>             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+----------+--------------+------------------+-------------------+</span><span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token number">.000006</span> <span class="token operator">|</span>      <span class="token number">120</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+----------+--------------+------------------+-------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>从库change master</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> change master <span class="token keyword">to</span> master_host<span class="token operator">=</span><span class="token string">'192.168.0.49'</span><span class="token punctuation">,</span>master_user<span class="token operator">=</span><span class="token string">'rep'</span><span class="token punctuation">,</span>master_password<span class="token operator">=</span><span class="token string">'123456'</span><span class="token punctuation">,</span>master_log_file<span class="token operator">=</span><span class="token string">'mysql-bin.000006'</span><span class="token punctuation">,</span>master_log_pos<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">,</span>master_delay<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">start</span> slave<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event                  Master_Host: <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.49</span>                  Master_User: rep                  Master_Port: <span class="token number">3306</span>                Connect_Retry: <span class="token number">60</span>              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000006</span>   <span class="token comment" spellcheck="true">#主库目前的binlog日志</span>          Read_Master_Log_Pos: <span class="token number">120</span>              <span class="token comment" spellcheck="true">#主库目前的binlog日志pos点</span>               Relay_Log_File: <span class="token number">db</span><span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token number">.000002</span>                                                Relay_Log_Pos: <span class="token number">283</span>        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000006</span>             Slave_IO_Running: Yes            Slave_SQL_Running: Yes              Replicate_Do_DB:          Replicate_Ignore_DB:           Replicate_Do_Table:       Replicate_Ignore_Table:      Replicate_Wild_Do_Table:  Replicate_Wild_Ignore_Table:                   Last_Errno: <span class="token number">0</span>                   Last_Error:                 Skip_Counter: <span class="token number">0</span>          Exec_Master_Log_Pos: <span class="token number">120</span>              Relay_Log_Space: <span class="token number">453</span>              Until_Condition: None               Until_Log_File:                Until_Log_Pos: <span class="token number">0</span>           Master_SSL_Allowed: <span class="token keyword">No</span>           Master_SSL_CA_File:           Master_SSL_CA_Path:              Master_SSL_Cert:            Master_SSL_Cipher:               Master_SSL_Key:        Seconds_Behind_Master: <span class="token number">0</span>Master_SSL_Verify_Server_Cert: <span class="token keyword">No</span>                Last_IO_Errno: <span class="token number">0</span>                Last_IO_Error:               Last_SQL_Errno: <span class="token number">0</span>               Last_SQL_Error:  Replicate_Ignore_Server_Ids:             Master_Server_Id: <span class="token number">1</span>                  Master_UUID: <span class="token number">32ab32d8</span><span class="token operator">-</span><span class="token number">414f</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">9cba</span><span class="token operator">-</span><span class="token number">5254003a3847</span>             Master_Info_File: <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span><span class="token number">3307</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>master<span class="token punctuation">.</span>info                    SQL_Delay: <span class="token number">3600</span>                  <span class="token comment" spellcheck="true">#从库延迟3600s执行sql</span>          SQL_Remaining_Delay: <span class="token boolean">NULL</span>        <span class="token comment" spellcheck="true">#距离下次执行sql的时间</span>      Slave_SQL_Running_State: Slave has <span class="token keyword">read</span> <span class="token keyword">all</span> relay log<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> the slave I<span class="token operator">/</span>O thread <span class="token keyword">to</span> <span class="token keyword">update</span> it           Master_Retry_Count: <span class="token number">86400</span>                  Master_Bind:      Last_IO_Error_Timestamp:     Last_SQL_Error_Timestamp:               Master_SSL_Crl:           Master_SSL_Crlpath:           Retrieved_Gtid_Set:            Executed_Gtid_Set:                Auto_Position: <span class="token number">0</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="二、半同步复制"><a href="#二、半同步复制" class="headerlink" title="二、半同步复制"></a>二、半同步复制</h1><h2 id="主库操作-1"><a href="#主库操作-1" class="headerlink" title="主库操作"></a>主库操作</h2><p>开启半同步配置</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#查看是否支持动态开启</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">'have_dynamic_loading'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token operator">|</span> Variable_name        <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token operator">|</span> have_dynamic_loading <span class="token operator">|</span> YES   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#安装插件</span>mysql<span class="token operator">></span> INSTALL PLUGIN rpl_semi_sync_master <span class="token keyword">SONAME</span><span class="token string">'semisync_master.so'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#开启插件</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#设置默认的超时时间</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_master_timeout <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#查看</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span><span class="token string">'rpl%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------------------------+----------+</span><span class="token operator">|</span> Variable_name                      <span class="token operator">|</span> <span class="token keyword">Value</span>    <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------------------------+----------+</span><span class="token operator">|</span> rpl_semi_sync_master_enabled       <span class="token operator">|</span> <span class="token keyword">ON</span>       <span class="token operator">|</span><span class="token operator">|</span> rpl_semi_sync_master_timeout       <span class="token operator">|</span> <span class="token number">1000</span>     <span class="token operator">|</span><span class="token operator">|</span> rpl_semi_sync_master_trace_level   <span class="token operator">|</span> <span class="token number">32</span>       <span class="token operator">|</span><span class="token operator">|</span> rpl_semi_sync_master_wait_no_slave <span class="token operator">|</span> <span class="token keyword">ON</span>       <span class="token operator">|</span><span class="token operator">|</span> rpl_stop_slave_timeout             <span class="token operator">|</span> <span class="token number">31536000</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------------------------+----------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>永久开启</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>rpl_semi_sync_master_enabled<span class="token operator">=</span>1rpl_semi_sync_master_timeout<span class="token operator">=</span>1000</code></pre><hr><h2 id="从库操作-1"><a href="#从库操作-1" class="headerlink" title="从库操作"></a>从库操作</h2><p>开启配置</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> INSTALL PLUGIN rpl_semi_sync_slave <span class="token keyword">SONAME</span><span class="token string">'semisync_slave.so'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_slave_enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#重启io线程（如果之前没有配置主从的话 还需要change master）</span>mysql<span class="token operator">></span> stop slave io_thread<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">start</span> slave io_thread<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>查看并验证</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#主库添加数据测试同步情况</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test3<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test4<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">295</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">590</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">416</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">833</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token comment" spellcheck="true">#这里是2 证明刚才两条sql走了半同步复制</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#关闭半同步在测试</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test5<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test6<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">295</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">590</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token comment" spellcheck="true">#OFF表示半同步关闭</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">OFF</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">416</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">833</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token comment" spellcheck="true">#还是2证明刚才两条sql 没有走半同步</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="三、过滤复制"><a href="#三、过滤复制" class="headerlink" title="三、过滤复制"></a>三、过滤复制</h1><h2 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h2><p>可以选择在主库配置 也可以在从库</p><p>主库：</p><p>白名单:只记录白名单中列出的库的二进制日志</p><pre class=" language-bash"><code class="language-bash">binlog-do-db</code></pre><p>黑名单：不记录黑名单列出的库的二进制日志</p><pre class=" language-bash"><code class="language-bash">binlog-ignore-db</code></pre><p>从库：</p><p>白名单：只执行白名单中列出的库或者表的中继日志</p><pre class=" language-bash"><code class="language-bash">--replicate-do-db<span class="token operator">=</span>test--replicate-do-table<span class="token operator">=</span>test.t1--replicate-wild-do-table<span class="token operator">=</span>test.t2</code></pre><p>黑名单：不执行黑名单中列出的库或者表的中继日志</p><pre class=" language-bash"><code class="language-bash">--replicate-ignore-db--replicate-ignore-table--replicate-wild-ignore-table</code></pre><p>这里测试从库配置</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#配置文件添加</span>replicate<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span><span class="token number">db</span><span class="token operator">=</span>wangzherongyao<span class="token comment" spellcheck="true">#重启从库生效</span>mysqladmin <span class="token operator">-</span>uroot <span class="token operator">-</span>p3308 <span class="token operator">-</span>S <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span><span class="token number">3308</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token punctuation">.</span>sock <span class="token keyword">shutdown</span>mysqld_safe <span class="token comment" spellcheck="true">--defaults-file=/data/3308/my.conf &amp;</span></code></pre><p>查看复制状态（一样需要之前配置主从）</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event                  Master_Host: <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.49</span>                  Master_User: rep                  Master_Port: <span class="token number">3306</span>                Connect_Retry: <span class="token number">60</span>              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000009</span>          Read_Master_Log_Pos: <span class="token number">335</span>               Relay_Log_File: <span class="token number">db</span><span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token number">.000010</span>                Relay_Log_Pos: <span class="token number">498</span>        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000009</span>             Slave_IO_Running: Yes            Slave_SQL_Running: Yes              Replicate_Do_DB: wangzherongyao  <span class="token comment" spellcheck="true">#这里显示的就是复制白名单</span></code></pre><p>测试</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#主库创建数据</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> wangzherongyao<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> lol<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> <span class="token keyword">backup</span>             <span class="token operator">|</span><span class="token operator">|</span> binlog             <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> ceshi              <span class="token operator">|</span><span class="token operator">|</span> chayi1             <span class="token operator">|</span><span class="token operator">|</span> chayi2             <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> huhuhahei1         <span class="token operator">|</span><span class="token operator">|</span> lol                <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> oldboy             <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> slow_query_log     <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> test1              <span class="token operator">|</span><span class="token operator">|</span> test2              <span class="token operator">|</span><span class="token operator">|</span> test3              <span class="token operator">|</span><span class="token operator">|</span> test4              <span class="token operator">|</span><span class="token operator">|</span> test5              <span class="token operator">|</span><span class="token operator">|</span> test6              <span class="token operator">|</span><span class="token operator">|</span> test_binlog        <span class="token operator">|</span><span class="token operator">|</span> wangzherongyao     <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">|</span> world              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">25</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#从库查看</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> <span class="token keyword">backup</span>             <span class="token operator">|</span><span class="token operator">|</span> binlog             <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> ceshi              <span class="token operator">|</span><span class="token operator">|</span> chayi1             <span class="token operator">|</span><span class="token operator">|</span> chayi2             <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> huhuhahei1         <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> oldboy             <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> slow_query_log     <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> test1              <span class="token operator">|</span><span class="token operator">|</span> test2              <span class="token operator">|</span><span class="token operator">|</span> test3              <span class="token operator">|</span><span class="token operator">|</span> test4              <span class="token operator">|</span><span class="token operator">|</span> test5              <span class="token operator">|</span><span class="token operator">|</span> test6              <span class="token operator">|</span><span class="token operator">|</span> test_binlog        <span class="token operator">|</span><span class="token operator">|</span> wangzherongyao     <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">|</span> world              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">24</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#可以发现从库是没有新创建的lol库的 只复制了wangzherongyao</span></code></pre><h1 id="四、GTID复制"><a href="#四、GTID复制" class="headerlink" title="四、GTID复制"></a>四、GTID复制</h1><h2 id="配置文件需要添加参数"><a href="#配置文件需要添加参数" class="headerlink" title="配置文件需要添加参数"></a>配置文件需要添加参数</h2><h2 id="主库"><a href="#主库" class="headerlink" title="主库"></a>主库</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#mysqld下添加 </span><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>gtid_mode<span class="token operator">=</span>ONenforce_gtid_consistencylog-slave-updatesbinlog_format<span class="token operator">=</span>rowlog-bin<span class="token operator">=</span>mysql-binserver_id<span class="token operator">=</span>1</code></pre><h2 id="从库"><a href="#从库" class="headerlink" title="从库"></a>从库</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>gtid_mode<span class="token operator">=</span>ONenforce_gtid_consistencylog-slave-updatesserver_id<span class="token operator">=</span>5log-bin<span class="token operator">=</span>mysql-binbinlog_format<span class="token operator">=</span>row</code></pre><p>修改后都需要重启</p><pre class=" language-bash"><code class="language-bash">/etc/init.d/mysqld restart</code></pre><p>创建复制用户</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">grant</span> <span class="token keyword">replication</span> slave <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> rep@'<span class="token operator">%</span><span class="token string">' identified by '</span><span class="token number">123</span>'<span class="token punctuation">;</span></code></pre><p>从库change master</p><pre class=" language-sql"><code class="language-sql">change master <span class="token keyword">to</span> master_host<span class="token operator">=</span><span class="token string">'10.60.222.142'</span><span class="token punctuation">,</span> master_user<span class="token operator">=</span><span class="token string">'rep'</span><span class="token punctuation">,</span>master_password<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">,</span>master_auto_position<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></code></pre><p>查看</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event                  Master_Host: <span class="token number">10.60</span><span class="token punctuation">.</span><span class="token number">222.142</span>                  Master_User: rep                  Master_Port: <span class="token number">3306</span>                Connect_Retry: <span class="token number">60</span>              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000001</span>          Read_Master_Log_Pos: <span class="token number">2009</span>               Relay_Log_File: <span class="token number">10</span><span class="token operator">-</span><span class="token number">60</span><span class="token operator">-</span><span class="token number">92</span><span class="token operator">-</span><span class="token number">80</span><span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token number">.000002</span>                Relay_Log_Pos: <span class="token number">2219</span>        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000001</span>             Slave_IO_Running: Yes            Slave_SQL_Running: Yes              Replicate_Do_DB:          Replicate_Ignore_DB:           Replicate_Do_Table:       Replicate_Ignore_Table:      Replicate_Wild_Do_Table:  Replicate_Wild_Ignore_Table:                   Last_Errno: <span class="token number">0</span>                   Last_Error:                 Skip_Counter: <span class="token number">0</span>          Exec_Master_Log_Pos: <span class="token number">2009</span>              Relay_Log_Space: <span class="token number">2429</span>              Until_Condition: None               Until_Log_File:                Until_Log_Pos: <span class="token number">0</span>           Master_SSL_Allowed: <span class="token keyword">No</span>           Master_SSL_CA_File:           Master_SSL_CA_Path:              Master_SSL_Cert:            Master_SSL_Cipher:               Master_SSL_Key:        Seconds_Behind_Master: <span class="token number">0</span>Master_SSL_Verify_Server_Cert: <span class="token keyword">No</span>                Last_IO_Errno: <span class="token number">0</span>                Last_IO_Error:               Last_SQL_Errno: <span class="token number">0</span>               Last_SQL_Error:  Replicate_Ignore_Server_Ids:             Master_Server_Id: <span class="token number">1</span>                  Master_UUID: <span class="token number">4c8ebc2b</span><span class="token operator">-</span><span class="token number">42d5</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">a6aa</span><span class="token operator">-</span><span class="token number">52540094f3a0</span>             Master_Info_File: <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token number">-5.6</span><span class="token punctuation">.</span><span class="token number">40</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>master<span class="token punctuation">.</span>info                    SQL_Delay: <span class="token number">0</span>          SQL_Remaining_Delay: <span class="token boolean">NULL</span>      Slave_SQL_Running_State: Slave has <span class="token keyword">read</span> <span class="token keyword">all</span> relay log<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> the slave I<span class="token operator">/</span>O thread <span class="token keyword">to</span> <span class="token keyword">update</span> it           Master_Retry_Count: <span class="token number">86400</span>                  Master_Bind:      Last_IO_Error_Timestamp:     Last_SQL_Error_Timestamp:               Master_SSL_Crl:           Master_SSL_Crlpath:           Retrieved_Gtid_Set: <span class="token number">4c8ebc2b</span><span class="token operator">-</span><span class="token number">42d5</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">a6aa</span><span class="token operator">-</span><span class="token number">52540094f3a0</span>:<span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span>     <span class="token comment" spellcheck="true">#io线程收到的GTID</span>            Executed_Gtid_Set: <span class="token number">4c8ebc2b</span><span class="token operator">-</span><span class="token number">42d5</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">a6aa</span><span class="token operator">-</span><span class="token number">52540094f3a0</span>:<span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span>     <span class="token comment" spellcheck="true">#sql线程执行的GTID</span>                Auto_Position: <span class="token number">1</span>              <span class="token comment" spellcheck="true">#是否开启GTID</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>主库查看</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>processlist <span class="token keyword">where</span> Command <span class="token operator">like</span> <span class="token string">'%Binlog%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+---------------------+------+------------------+------+------------------------------------------------------------------+------+</span><span class="token operator">|</span> ID <span class="token operator">|</span> <span class="token keyword">USER</span> <span class="token operator">|</span> HOST                <span class="token operator">|</span> DB   <span class="token operator">|</span> COMMAND          <span class="token operator">|</span> TIME <span class="token operator">|</span> STATE                                                            <span class="token operator">|</span> INFO <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+---------------------+------+------------------+------+------------------------------------------------------------------+------+</span><span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> rep  <span class="token operator">|</span> <span class="token number">10.60</span><span class="token punctuation">.</span><span class="token number">157.113</span>:<span class="token number">24552</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Binlog <span class="token keyword">Dump</span> GTID <span class="token operator">|</span> <span class="token number">1284</span> <span class="token operator">|</span> Master has sent <span class="token keyword">all</span> binlog <span class="token keyword">to</span> slave<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> binlog <span class="token keyword">to</span> <span class="token number">be</span> up <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> rep  <span class="token operator">|</span> <span class="token number">10.60</span><span class="token punctuation">.</span><span class="token number">92.80</span>:<span class="token number">40700</span>   <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Binlog <span class="token keyword">Dump</span> GTID <span class="token operator">|</span> <span class="token number">1262</span> <span class="token operator">|</span> Master has sent <span class="token keyword">all</span> binlog <span class="token keyword">to</span> slave<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> binlog <span class="token keyword">to</span> <span class="token number">be</span> up <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+---------------------+------+------------------+------+------------------------------------------------------------------+------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql 索引管理</title>
      <link href="/ad2c14ec/"/>
      <url>/ad2c14ec/</url>
      
        <content type="html"><![CDATA[<h1 id="一、索引算法简介"><a href="#一、索引算法简介" class="headerlink" title="一、索引算法简介"></a>一、索引算法简介</h1><h3 id="1-1-B-Tree"><a href="#1-1-B-Tree" class="headerlink" title="1.1 B+Tree"></a>1.1 B+Tree</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/460933094.png"></p><hr><h3 id="1-2-B-Tree"><a href="#1-2-B-Tree" class="headerlink" title="1.2 B*Tree"></a>1.2 B*Tree</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/3363888615.png"></p><hr><h1 id="二、索引管理"><a href="#二、索引管理" class="headerlink" title="二、索引管理"></a>二、索引管理</h1><h3 id="2-1-基础概念"><a href="#2-1-基础概念" class="headerlink" title="2.1 基础概念"></a>2.1 基础概念</h3><pre class=" language-sql"><code class="language-sql">索引建立在表的列上<span class="token punctuation">(</span>字段<span class="token punctuation">)</span>的。在<span class="token keyword">where</span>后面的列建立索引才会加快查询速度。pages<span class="token operator">&lt;</span><span class="token comment" spellcheck="true">---索引（属性）&lt;----查数据。</span></code></pre><hr><h3 id="2-2-索引分类"><a href="#2-2-索引分类" class="headerlink" title="2.2 索引分类"></a>2.2 索引分类</h3><pre class=" language-sql"><code class="language-sql">主键索引普通索引<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>唯一索引</code></pre><hr><h3 id="2-3-索引创建"><a href="#2-3-索引创建" class="headerlink" title="2.3 索引创建"></a>2.3 索引创建</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#创建普通索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_id<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#创建主键索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> pri_name<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#创建唯一索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">unique</span> <span class="token keyword">key</span> uni_age<span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#查看索引</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> student1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> <span class="token keyword">Table</span>    <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> Index_type <span class="token operator">|</span><span class="token keyword">Comment</span> <span class="token operator">|</span> Index_comment <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>  <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> name        <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> uni_age  <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> age         <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_id   <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id          <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#删除索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">drop</span> <span class="token keyword">key</span> idx_id<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#添加前缀索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_name<span class="token punctuation">(</span>name<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#创建联合索引</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_all<span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>sex<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> student1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> <span class="token keyword">Table</span>    <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> Index_type <span class="token operator">|</span><span class="token keyword">Comment</span> <span class="token operator">|</span> Index_comment <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id          <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">2</span> <span class="token operator">|</span> name        <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">3</span> <span class="token operator">|</span> age         <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">4</span> <span class="token operator">|</span> sex         <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#注 联合索引主要针对多条件查询，因此需要把最常用的条件放到最前面 规则遵循前缀生效特性</span></code></pre><hr><h3 id="2-4-索引创建规则"><a href="#2-4-索引创建规则" class="headerlink" title="2.4 索引创建规则"></a>2.4 索引创建规则</h3><ol><li>创建唯一索引</li><li>如果该列重复值较多，采用联合索引</li><li>经常需要排序、分组和联合操作的字段建立索引</li><li>常作为查询条件的字段建立索引</li><li>索引字段的值很长，尽量使用前缀索引</li><li>限制索引数目</li><li>删除不再使用或者很少使用的素引</li></ol><hr><h3 id="2-5-索引优化规则"><a href="#2-5-索引优化规则" class="headerlink" title="2.5 索引优化规则"></a>2.5 索引优化规则</h3><ol><li><p>没有查询条件，或者查询条件没有索引。</p><ul><li>a）添加查询条件。</li><li>b）为查询条件创建素引</li></ul></li><li><p>查询结果集是原表中的大部分数据，应该是25%以上不走索引a）使用limit去查询数据</p></li><li><p>索引本身损坏（失效），不走索引</p><ul><li>a）监控索引</li><li>b）删除索引，重新建立素引</li></ul></li><li><p>使用函数在索引列上或者对索引列进行运算，不走索引</p></li><li><p>隐式转换导致索引失效</p></li><li><p>&lt;&gt;，not in 不走索引</p></li><li><p>like%”百分号在最前面不走索引</p></li><li><p>单独引用联合索引里非第一位置的索引列.</p></li></ol><hr><h1 id="三、Explain使用"><a href="#三、Explain使用" class="headerlink" title="三、Explain使用"></a>三、Explain使用</h1><h3 id="3-1-Explain详解"><a href="#3-1-Explain详解" class="headerlink" title="3.1 Explain详解"></a>3.1 Explain详解</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#命令常见使用方法</span>mysql<span class="token operator">></span>  <span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>countrycode <span class="token keyword">from</span> city <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><blockquote><p>各字段含义</p></blockquote><ul><li><strong>id</strong>: select查询的序列号,包含一组数字，表示查询中执行select子句或操作表的顺序</li><li><strong>select_type</strong>: 查询的类型，主要是用于区别,普通查询、联合查询、子查询等的复杂查询（SIMPLE，PRIMARY，DERIVED，SUBQUERY，DEPENDENT SUBQUERY，UNCACHEABLE SUBQUREY等）</li><li><strong>table</strong>：显示这一行的数据是关于哪张表的</li><li><strong>type</strong>：type显示的是访问类型，是较为重要的一个指标，结果值从最好到最坏依次是： system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range(尽量保证) &gt; index &gt; ALL。一般来说，得保证查询至少达到range级别，最好能达到ref。</li><li><strong>possible_keys</strong>：显示可能应用在这张表中的索引，一个或多个。查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询实际使用</li><li><strong>key</strong>：实际使用的索引。如果为NULL，则没有使用索引</li><li><strong>key_len</strong>：表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。</li><li><strong>ref</strong>：显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值</li><li><strong>rows</strong>：rows列显示MySQL认为它执行查询时必须检查的行数。（越少越好）</li><li><strong>Extra</strong>：包含不适合在其他列中显示但十分重要的额外信息<ul><li><strong>Using filesort</strong><br>说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。</li><li><strong>Using temporary</strong><br>使了用临时表保存中间结果,MySQL在对查询结果排序时使用临时表。常见于排序 order by 和分组查询 group by。</li><li><strong>USING index</strong><br>表示相应的select操作中使用了覆盖索引(Covering Index)，避免访问了表的数据行，效率不错！</li><li><strong>Using where</strong><br>表明使用了where过滤</li><li><strong>using join buffer</strong><br>使用了连接缓存：</li><li><strong>impossible where</strong><br>where子句的值总是false，不能用来获取任何元组</li><li><strong>select tables optimized away</strong><br>在没有GROUPBY子句的情况下，基于索引优化MIN&#x2F;MAX操作或者</li></ul></li></ul><hr><h3 id="3-2-Type字段分析"><a href="#3-2-Type字段分析" class="headerlink" title="3.2 Type字段分析"></a>3.2 Type字段分析</h3><ul><li>ALL：全表扫描</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">4188</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>index：Full Index Scan，index与ALL区别为index类型只遍历索引树。</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> countrycode <span class="token keyword">from</span> city <span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> CountryCode <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">4188</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>range：索引范围扫描，对索引的扫描开始于某一点，返回匹配值域的行。显而易见的索引范围扫描是带有between或者where子句里带有&lt;,&gt;查询</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'CHN'</span><span class="token punctuation">,</span><span class="token string">'USA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-----------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra                 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-----------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> range <span class="token operator">|</span> CountryCode   <span class="token operator">|</span> CountryCode <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>  <span class="token number">637</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-----------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>ref：使用非唯一索引扫描或者唯一索引的前缀扫描，返回匹配某个单独值的记录行。</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+-------------+---------+-------+------+-----------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra                 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+-------------+---------+-------+------+-----------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> ref  <span class="token operator">|</span> CountryCode   <span class="token operator">|</span> CountryCode <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> const <span class="token operator">|</span>  <span class="token number">363</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+-------------+---------+-------+------+-----------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>eq_ref：类似ref，区别就在使用的索引是唯一索引，对于每个索引键值，表中只有一条记录匹配，简单来说，就是多表连接中使用primary key或者 unique key作为关联条件A</li><li>const、system：当MySQL对查询某部分进行优化，并转换为一个常量时，使用这些类型访问。</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>NULL：MySQL在优化过程中分解语句，执行时甚至不用访问表或索引，例如从一个索引列里选取最小值可以通过单独索引查找完成。</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">10000000000000000000000000</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-----------------------------------------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-----------------------------------------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Impossible <span class="token keyword">WHERE</span> noticed <span class="token keyword">after</span> reading const <span class="token keyword">tables</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-----------------------------------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>转载：<a href="https://blog.driverzeng.com/zenglaoshi/668.html">drz</a></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql 5.6配置多实例</title>
      <link href="/2d4ca71e/"/>
      <url>/2d4ca71e/</url>
      
        <content type="html"><![CDATA[<h1 id="一、准备环境"><a href="#一、准备环境" class="headerlink" title="一、准备环境"></a>一、准备环境</h1><h3 id="1-1-创建数据目录准备配置文件"><a href="#1-1-创建数据目录准备配置文件" class="headerlink" title="1.1 创建数据目录准备配置文件"></a>1.1 创建数据目录准备配置文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /data/&amp;#123;3307,3308&amp;#125;</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat 3307/my.conf</span><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>basedir=/application/mysql/datadir=/data/3307/datasocket=/data/3307/data/mysql.sockport=3307log_err=/data/3307/mysql.errlog<span class="token punctuation">-</span>bin=/data/3307/mysql<span class="token punctuation">-</span>binserver_id=7<span class="token comment" spellcheck="true">#复制配置文件到3308</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cp 3307/my.conf 3308/</span><span class="token comment" spellcheck="true">#给数据目录属主属组</span>chown <span class="token punctuation">-</span>R mysql<span class="token punctuation">:</span>mysql /data</code></pre><h1 id="二、配置启动"><a href="#二、配置启动" class="headerlink" title="二、配置启动"></a>二、配置启动</h1><h3 id="2-1-初始化"><a href="#2-1-初始化" class="headerlink" title="2.1 初始化"></a>2.1 初始化</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#需要到mysql安装目录下的script中执行</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cd /application/mysql/scripts/</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./mysql_install_db --defaults-file=/data/3307/my.conf --basedir=/application/mysql --datadir=/data/3307/data</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./mysql_install_db --defaults-file=/data/3308/my.conf --basedir=/application/mysql --datadir=/data/3308/data</span><span class="token comment" spellcheck="true">#查看目录结果</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tree -L 2 /data</span>/data├── 3307│   ├── data│   ├── my.conf│   ├── mysql<span class="token punctuation">-</span>bin.000001│   ├── mysql<span class="token punctuation">-</span>bin.000002│   ├── mysql<span class="token punctuation">-</span>bin.000003│   ├── mysql<span class="token punctuation">-</span>bin.index│   └── mysql.err└── 3308    ├── data    ├── my.conf    ├── mysql<span class="token punctuation">-</span>bin.000001    ├── mysql<span class="token punctuation">-</span>bin.000002    ├── mysql<span class="token punctuation">-</span>bin.000003    ├── mysql<span class="token punctuation">-</span>bin.index    └── mysql.err</code></pre><h3 id="2-2-启动"><a href="#2-2-启动" class="headerlink" title="2.2 启动"></a>2.2 启动</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqld_safe --defaults-file=/data/3307/my.conf &amp;</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqld_safe --defaults-file=/data/3308/my.conf &amp;</span><span class="token comment" spellcheck="true">#查看端口确认是否启动</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># netstat -anpt</span>Active Internet connections (servers and established)Proto Recv<span class="token punctuation">-</span>Q Send<span class="token punctuation">-</span>Q Local Address           Foreign Address         State       PID/Program nametcp        0      0 0.0.0.0<span class="token punctuation">:</span>22              0.0.0.0<span class="token punctuation">:</span>*               LISTEN      1530/sshdtcp        0      0 127.0.0.1<span class="token punctuation">:</span>25            0.0.0.0<span class="token punctuation">:</span>*               LISTEN      1182/mastertcp        0     52 192.168.0.49<span class="token punctuation">:</span>22         106.75.220.2<span class="token punctuation">:</span>54310      ESTABLISHED 17531/sshd<span class="token punctuation">:</span> root@pttcp        0      0 192.168.0.49<span class="token punctuation">:</span>22         106.75.220.2<span class="token punctuation">:</span>58731      ESTABLISHED 8275/sshd<span class="token punctuation">:</span> root@ptstcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>22                   <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      1530/sshdtcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span>1<span class="token punctuation">:</span>25                  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      1182/mastertcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>3306                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      17293/mysqldtcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>3307                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      16924/mysqldtcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>3308                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      17104/mysqld</code></pre><h3 id="2-3-修改密码"><a href="#2-3-修改密码" class="headerlink" title="2.3 修改密码"></a>2.3 修改密码</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqladmin -uroot -p -S /data/3307/data/mysql.sock password '3307'</span>Enter password<span class="token punctuation">:</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqladmin -uroot -p -S /data/3308/data/mysql.sock password '3308'</span>Enter password<span class="token punctuation">:</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.</code></pre><h3 id="2-4-登陆确认"><a href="#2-4-登陆确认" class="headerlink" title="2.4 登陆确认"></a>2.4 登陆确认</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql -uroot -p3307 -S /data/3307/data/mysql.sock -e "show variables like 'server_id';"</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 7     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql -uroot -p3308 -S /data/3308/data/mysql.sock -e "show variables like 'server_id';"</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 8     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+</code></pre><h1 id="三、调优"><a href="#三、调优" class="headerlink" title="三、调优"></a>三、调优</h1><h3 id="3-1-配置启动脚本"><a href="#3-1-配置启动脚本" class="headerlink" title="3.1 配置启动脚本"></a>3.1 配置启动脚本</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /usr/local/bin/mysql3307</span>mysql <span class="token punctuation">-</span>uroot <span class="token punctuation">-</span>p3307 <span class="token punctuation">-</span>S /data/3307/data/mysql.sock<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># chmod 700 /usr/local/bin/mysql3307</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /usr/local/bin/mysql3308</span>mysql <span class="token punctuation">-</span>uroot <span class="token punctuation">-</span>p3308 <span class="token punctuation">-</span>S /data/3308/data/mysql.sock<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># chmod 700 /usr/local/bin/mysql3308</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#测试连接</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql3307</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.Welcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 11Server version<span class="token punctuation">:</span> 5.6.40<span class="token punctuation">-</span>log Source distributionCopyright (c) 2000<span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql<span class="token punctuation">></span> show variables like 'server_id';+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 7     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+1 row in set (0.00 sec)<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql3308</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.Welcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 4Server version<span class="token punctuation">:</span> 5.6.40<span class="token punctuation">-</span>log Source distributionCopyright (c) 2000<span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql<span class="token punctuation">></span> show variables like 'server_id';+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 8     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+1 row in set (0.00 sec)</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Msql 5.6.40编译安装</title>
      <link href="/61745c5a/"/>
      <url>/61745c5a/</url>
      
        <content type="html"><![CDATA[<h1 id="一、准备环境"><a href="#一、准备环境" class="headerlink" title="一、准备环境"></a><strong>一、准备环境</strong></h1><h3 id="1-1-安装包"><a href="#1-1-安装包" class="headerlink" title="1.1 安装包"></a>1.1 安装包</h3><p>可以直接在这个页面下载，也可以到官网下载mysql.com</p><p><a href="https://video-emlog.cn-sh2.ufileos.com/mysql-5.6.40.tar.gz">mysql-5.6.40.tar.gz</a></p><h3 id="1-2-安装需要的依赖"><a href="#1-2-安装需要的依赖" class="headerlink" title="1.2 安装需要的依赖"></a>1.2 安装需要的依赖</h3><pre class=" language-bash"><code class="language-bash">curl -O http://kode.huhuhahei.cn/index.php?user/publicLink\<span class="token operator">&amp;</span>fid<span class="token operator">=</span>2493D9TIfgnJtc4FvMKOj1EJ5_skR0B695C3of0ZsbNu2mp0WCIPHYOfdZXyzQ6aBAUQbYWtb6pVAhQBB1jzdpFW5M2TxJZtyLLchhvJUUSFGXLuXI5xaocqSsBdj0LsGhA\<span class="token operator">&amp;</span>file_name<span class="token operator">=</span>/mysql-5.6.40.tar.gz</code></pre><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> -y ncurses-devel libaio-devel cmake gcc-c++ autoconf lrzsz</code></pre><h3 id="1-3-解压tar包"><a href="#1-3-解压tar包" class="headerlink" title="1.3 解压tar包"></a>1.3 解压tar包</h3><pre class=" language-yaml"><code class="language-yaml">tar xf mysql<span class="token punctuation">-</span>5.6.40.tar.gzcd mysql<span class="token punctuation">-</span>5.6.40</code></pre><h1 id="二、编译配置"><a href="#二、编译配置" class="headerlink" title="二、编译配置"></a><strong>二、编译配置</strong></h1><h3 id="2-1-编译"><a href="#2-1-编译" class="headerlink" title="2.1 编译"></a>2.1 编译</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建安装目录</span>mkdir /application</code></pre><pre class=" language-yaml"><code class="language-yaml">cmake . <span class="token punctuation">-</span>DCMAKE_INSTALL_PREFIX=/application/mysql<span class="token punctuation">-</span>5.6.40 <span class="token punctuation">-</span>DMYSQL_DATADIR=/application/mysql<span class="token punctuation">-</span>5.6.40/data <span class="token punctuation">-</span>DMYSQL_UNIX_ADDR=/application/mysql<span class="token punctuation">-</span>5.6.40/tmp/mysql.sock <span class="token punctuation">-</span>DDEFAULT_CHARSET=utf8 <span class="token punctuation">-</span>DDEFAULT_COLLATION=utf8_general_ci <span class="token punctuation">-</span>DWITH_EXTRA_CHARSETS=all <span class="token punctuation">-</span>DWITH_INNOBASE_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITH_FEDERATED_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITH_BLACKHOLE_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITH_ZLIB=bundled<span class="token punctuation">-</span>DWITH_SSL=bundled <span class="token punctuation">-</span>DENABLED_LOCAL_INFILE=1 <span class="token punctuation">-</span>DWITH_EMBEDDED_SERVER=1 <span class="token punctuation">-</span>DENABLE_DOWNLOADS=1 <span class="token punctuation">-</span>DWITH_DEBUG=0</code></pre><pre class=" language-yaml"><code class="language-yaml">make &amp;&amp; make install</code></pre><h1 id="三、配置优化"><a href="#三、配置优化" class="headerlink" title="三、配置优化"></a><strong>三、配置优化</strong></h1><h3 id="3-1-文件路径调优"><a href="#3-1-文件路径调优" class="headerlink" title="3.1 文件路径调优"></a>3.1 文件路径调优</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建用户</span>useradd mysql <span class="token punctuation">-</span>s /sbin/nologin <span class="token punctuation">-</span>M<span class="token comment" spellcheck="true">#创建socket文件目录</span>mkdir <span class="token punctuation">-</span>p /application/mysql<span class="token punctuation">-</span>5.6.40/tmp<span class="token comment" spellcheck="true">#配置软连接</span>ln <span class="token punctuation">-</span>s /application/mysql<span class="token punctuation">-</span>5.6.40/ /application/mysql<span class="token comment" spellcheck="true">#复制配置文件</span>cp support<span class="token punctuation">-</span>files/my<span class="token punctuation">-</span>default.cnf /etc/my.cnf<span class="token comment" spellcheck="true">#配置启动命令</span>cp support<span class="token punctuation">-</span>files/mysql.server /etc/init.d/mysqld<span class="token comment" spellcheck="true">#修改属主属组</span>chown <span class="token punctuation">-</span>R mysql<span class="token punctuation">:</span>mysql /application/mysqlchown <span class="token punctuation">-</span>R mysql<span class="token punctuation">:</span>mysql /application/mysql<span class="token punctuation">-</span>5.6.40/</code></pre><h3 id="3-2-初始化数据库"><a href="#3-2-初始化数据库" class="headerlink" title="3.2 初始化数据库"></a>3.2 初始化数据库</h3><pre class=" language-yaml"><code class="language-yaml">cd scripts/./mysql_install_db <span class="token punctuation">-</span><span class="token punctuation">-</span>user=mysql <span class="token punctuation">-</span><span class="token punctuation">-</span>basedir=/application/mysql/ <span class="token punctuation">-</span><span class="token punctuation">-</span>datadir=/application/mysql/data</code></pre><h3 id="3-3-配置环境变量"><a href="#3-3-配置环境变量" class="headerlink" title="3.3 配置环境变量"></a>3.3 配置环境变量</h3><pre class=" language-yaml"><code class="language-yaml">cat /etc/profile.d/mysql.shexport PATH="/application/mysql/bin<span class="token punctuation">:</span>$PATH"source /etc/profile.d/mysql.sh</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#启动mysql</span>/etc/init.d/mysqld start<span class="token comment" spellcheck="true">#可以登陆了</span>mysqlWelcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 1Server version<span class="token punctuation">:</span> 5.6.40 Source distributionCopyright (c) 2000<span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql<span class="token punctuation">></span></code></pre><h3 id="3-4-配置systemctl控制"><a href="#3-4-配置systemctl控制" class="headerlink" title="3.4 配置systemctl控制"></a>3.4 配置systemctl控制</h3><pre class=" language-yaml"><code class="language-yaml">cat /usr/lib/systemd/system/mysqld.service<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>Description=MySQL ServerDocumentation=man<span class="token punctuation">:</span>mysqld(8)Documentation=https<span class="token punctuation">:</span>//dev.mysql.com/doc/refman/en/using<span class="token punctuation">-</span>systemd.htmlAfter=network.targetAfter=syslog.target<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>WantedBy=multi<span class="token punctuation">-</span>user.target<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>User=mysqlGroup=mysqlExecStart=/application/mysql/bin/mysqld <span class="token punctuation">-</span><span class="token punctuation">-</span>defaults<span class="token punctuation">-</span>file=/etc/my.cnfLimitNOFILE = 5000</code></pre><pre class=" language-yaml"><code class="language-yaml">systemctl start mysqldsystemctl status mysqld● mysqld.service <span class="token punctuation">-</span> MySQL Server   <span class="token key atrule">Loaded</span><span class="token punctuation">:</span> loaded (/usr/lib/systemd/system/mysqld.service; disabled; vendor preset<span class="token punctuation">:</span> disabled)   <span class="token key atrule">Active</span><span class="token punctuation">:</span> active (running) since Thu 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 CST; 8s ago     <span class="token key atrule">Docs</span><span class="token punctuation">:</span> man<span class="token punctuation">:</span>mysqld(8)           https<span class="token punctuation">:</span>//dev.mysql.com/doc/refman/en/using<span class="token punctuation">-</span>systemd.html Main PID<span class="token punctuation">:</span> 12236 (mysqld)    <span class="token key atrule">Tasks</span><span class="token punctuation">:</span> <span class="token number">21</span>   <span class="token key atrule">CGroup</span><span class="token punctuation">:</span> /system.slice/mysqld.service           └─12236 /application/mysql/bin/mysqld <span class="token punctuation">-</span><span class="token punctuation">-</span>defaults<span class="token punctuation">-</span>file=/etc/my.cnfOct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>tOct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>7Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> S<span class="token punctuation">...</span>6Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span>  <span class="token punctuation">...</span>;Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> S<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> E<span class="token punctuation">...</span>sOct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> /<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Version</span><span class="token punctuation">:</span> '5.6.40'  socket<span class="token punctuation">:</span> '/appli<span class="token punctuation">...</span>n<span class="token key atrule">Hint</span><span class="token punctuation">:</span> Some lines were ellipsized<span class="token punctuation">,</span> use <span class="token punctuation">-</span>l to show in full.</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Operator 部署服务数据持久化</title>
      <link href="/f26ab3f9/"/>
      <url>/f26ab3f9/</url>
      
        <content type="html"><![CDATA[<h1 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h1><h3 id="1-1"><a href="#1-1" class="headerlink" title="1.1"></a>1.1</h3><p>默认使用<code>Operator</code>部署的<code>prometheus</code>和<code>grafana</code>存储数据都是使用的<code>emptyDir</code>格式的，所以服务重启后数据就会清空，生产环境肯定是不行的所以需要将数据持久化到磁盘</p><h1 id="二、配置"><a href="#二、配置" class="headerlink" title="二、配置"></a>二、配置</h1><h3 id="2-1-Prometheus持久化"><a href="#2-1-Prometheus持久化" class="headerlink" title="2.1 Prometheus持久化"></a>2.1 Prometheus持久化</h3><p>prometheus使用的是sts控制器，这边直接使用StorageClass</p><p>首先需要创建StorageClass存储（需要配置nfs 这里就不多赘述了）</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat nfs-sc.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01  </span><span class="token comment" spellcheck="true"># 此处供应者名字供storageclass调用</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/lnmp/prometheus_data  <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/lnmp/prometheus_data   <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span><span class="token comment" spellcheck="true"># Supported policies: Delete、 Retain ， default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#启动</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nfs-sc.yaml</span><span class="token comment" spellcheck="true">#查看</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n kube-system</span>NAME                                       READY   STATUS    RESTARTS   AGnfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>01<span class="token punctuation">-</span>7f7ccdb7bb<span class="token punctuation">-</span>nfsxb        1/1     Running   0          5h10m<span class="token comment" spellcheck="true">#修改prometheus存储配置</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring edit prometheus k8s</span>spec<span class="token punctuation">...</span><span class="token punctuation">...</span>  <span class="token key atrule">storage</span><span class="token punctuation">:</span>    <span class="token key atrule">volumeClaimTemplate</span><span class="token punctuation">:</span>      <span class="token key atrule">spec</span><span class="token punctuation">:</span>        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> ReadWriteMany        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge<span class="token comment" spellcheck="true">#稍后可以看到StorageClass会自动创建PVC和PV</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc -n monitoring</span>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEprometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0   Bound    pvc<span class="token punctuation">-</span>263e60ad<span class="token punctuation">-</span>44c1<span class="token punctuation">-</span>41a8<span class="token punctuation">-</span>9f2a<span class="token punctuation">-</span>77a35f507ad0   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       6h7mprometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>1   Bound    pvc<span class="token punctuation">-</span>73ee2d7f<span class="token punctuation">-</span>180c<span class="token punctuation">-</span>40b9<span class="token punctuation">-</span>925a<span class="token punctuation">-</span>0bddc58c4604   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       6h7m<span class="token comment" spellcheck="true">#登陆pod查看挂载</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it -n monitoring prometheus-k8s-0 -- /bin/sh</span>/prometheus $ df <span class="token punctuation">-</span>hFilesystem                Size      Used Available Use% Mounted onoverlay                  40.0G     13.1G     26.8G  33% /tmpfs                    64.0M         0     64.0M   0% /devtmpfs                     1.9G         0      1.9G   0% /sys/fs/cgroup10.7.48.223<span class="token punctuation">:</span>/data/lnmp/prometheus_data/monitoring<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>263e60ad<span class="token punctuation">-</span>44c1<span class="token punctuation">-</span>41a8<span class="token punctuation">-</span>9f2a<span class="token punctuation">-</span>77a35f507ad0/prometheus<span class="token punctuation">-</span>db</code></pre><h3 id="2-2Grafana持久化"><a href="#2-2Grafana持久化" class="headerlink" title="2.2Grafana持久化"></a>2.2Grafana持久化</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建Grafana的pvc</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat grafana-pvc.yaml</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token comment" spellcheck="true">#部署</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f grafana-pvc.yaml</span><span class="token comment" spellcheck="true">#查看pvc是否创建</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc -n monitoring</span>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEgrafana                              Bound    pvc<span class="token punctuation">-</span>c16d1015<span class="token punctuation">-</span>f1ed<span class="token punctuation">-</span>40be<span class="token punctuation">-</span>bfb2<span class="token punctuation">-</span>d980377692ea   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       5h23m<span class="token comment" spellcheck="true">#编辑grafana的deployment资源配置</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring edit deployments.apps grafan</span><span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span><span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>storage<span class="token comment" spellcheck="true">#更改为</span><span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>storage      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> grafana<span class="token comment" spellcheck="true">#同时建议添加环境变量配置默认密码</span><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_SECURITY_ADMIN_USER<span class="token key atrule">value</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_SECURITY_ADMIN_PASSWORD<span class="token key atrule">value</span><span class="token punctuation">:</span> admin321<span class="token comment" spellcheck="true">#保存退出</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Operator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubeadm卸载</title>
      <link href="/b7046e9b/"/>
      <url>/b7046e9b/</url>
      
        <content type="html"><![CDATA[<h1 id="删除kubeadm构建的Kubernetes集群"><a href="#删除kubeadm构建的Kubernetes集群" class="headerlink" title="删除kubeadm构建的Kubernetes集群"></a>删除kubeadm构建的Kubernetes集群</h1><p>所有通过 <a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/deployment/bootstrap_kubernetes_single/kubeadm.html#kubeadm">kubeadm</a> 工具构建的Kubernetes集群以及节点，都可以通过 <code>kubeadm</code> 工具反向卸载(删除)，这是一个非常方便的操作。我的实践是因为在开发测试环境， <a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/administer/kubeadm_administer/upgrade_kubeadm_cluster.html#upgrade-kubeadm-cluster">升级kubeadm集群</a> 失败，为了快速开始下一阶段测试工作，所以准备重建Kubernetes集群。</p><p><code>kubeadm reset</code> 命令执行会提示:</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> WARNING: Changes made to this host by <span class="token string">'kubeadm init'</span> or <span class="token string">'kubeadm join'</span> will be reverted.<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Are you sure you want to proceed? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>:</code></pre><p>也就是说，不管是加入集群的工作节点，还是初始化的管控节点，都可以用这个工具反向操作</p><p>检查集群:</p><pre class=" language-bash"><code class="language-bash">kubectl get nodes</code></pre><p>当前节点:</p><pre class=" language-bash"><code class="language-bash">NAME         STATUS   ROLES    AGE    VERSIONpi-master1   Ready    master   241d   v1.20.9pi-worker1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.20.9pi-worker2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.21.3zcloud       Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   127d   v1.21.3</code></pre><p>首先在 <code>zcloud</code> 上执行节点清理:</p><pre class=" language-bash"><code class="language-bash">kubeadm reset<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> WARNING: Changes made to this host by <span class="token string">'kubeadm init'</span> or <span class="token string">'kubeadm join'</span> will be reverted.<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Are you sure you want to proceed? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: y</code></pre><p>提示信息:</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checksW0728 23:50:09.914348 3734557 removeetcdmember.go:79<span class="token punctuation">]</span> <span class="token punctuation">[</span>reset<span class="token punctuation">]</span> No kubeadm config, using etcd pod spec to get data directory<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> No etcd config found. Assuming external etcd<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Please, manually reset etcd to prevent further issues<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Stopping the kubelet <span class="token function">service</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Unmounting mounted directories <span class="token keyword">in</span> <span class="token string">"/var/lib/kubelet"</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of config directories: <span class="token punctuation">[</span>/etc/kubernetes/manifests /etc/kubernetes/pki<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting files: <span class="token punctuation">[</span>/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of stateful directories: <span class="token punctuation">[</span>/var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni<span class="token punctuation">]</span>The reset process does not clean CNI configuration. To <span class="token keyword">do</span> so, you must remove /etc/cni/net.dThe reset process does not reset or clean up iptables rules or IPVS tables.If you wish to reset iptables, you must <span class="token keyword">do</span> so manually by using the <span class="token string">"iptables"</span> command.If your cluster was setup to utilize IPVS, run ipvsadm --clear <span class="token punctuation">(</span>or similar<span class="token punctuation">)</span>to reset your system's IPVS tables.The reset process does not clean your kubeconfig files and you must remove them manually.Please, check the contents of the <span class="token variable">$HOME</span>/.kube/config file.</code></pre><p>可以看到 <code>reset</code> 过程不会清理CNI配置，也不会清理iptables规则，两者需要手工处理</p><p>完成以后，在管控服务器上检查，可以看到该工作节点已经 <code>NotReady</code></p><pre class=" language-bash"><code class="language-bash">kubectl get nodes</code></pre><p>显示:</p><pre class=" language-bash"><code class="language-bash">NAME         STATUS     ROLES    AGE    VERSIONpi-master1   Ready      master   241d   v1.20.9pi-worker1   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.20.9pi-worker2   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.21.3zcloud       NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>   127d   v1.21.3</code></pre><p>删除节点:</p><pre class=" language-bash"><code class="language-bash">kubectl delete node zcloud</code></pre><p>在工作节点上再执行一次清理 <code>iptables</code> 和 <code>cni</code></p><pre class=" language-bash"><code class="language-bash"><span class="token function">rm</span> -rf /etc/cni/net.diptables -F</code></pre><p>所有工作节点清理以后，最后执行管控节点卸载:</p><pre class=" language-bash"><code class="language-bash">kubeadm reset</code></pre><p>输出信息:</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Removing info <span class="token keyword">for</span> node <span class="token string">"pi-master1"</span> from the ConfigMap <span class="token string">"kubeadm-config"</span> <span class="token keyword">in</span> the <span class="token string">"kube-system"</span> NamespaceW0729 00:23:55.555252 3406560 removeetcdmember.go:61<span class="token punctuation">]</span> <span class="token punctuation">[</span>reset<span class="token punctuation">]</span> failed to remove etcd member: error syncing endpoints with etcd: context deadline exceeded, please manually remove this etcd member using etcdctl<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Stopping the kubelet <span class="token function">service</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Unmounting mounted directories <span class="token keyword">in</span> <span class="token string">"/var/lib/kubelet"</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of config directories: <span class="token punctuation">[</span>/etc/kubernetes/manifests /etc/kubernetes/pki<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting files: <span class="token punctuation">[</span>/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of stateful directories: <span class="token punctuation">[</span>/var/lib/etcd /var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni<span class="token punctuation">]</span>The reset process does not clean CNI configuration. To <span class="token keyword">do</span> so, you must remove /etc/cni/net.dThe reset process does not reset or clean up iptables rules or IPVS tables.If you wish to reset iptables, you must <span class="token keyword">do</span> so manually by using the <span class="token string">"iptables"</span> command.If your cluster was setup to utilize IPVS, run ipvsadm --clear <span class="token punctuation">(</span>or similar<span class="token punctuation">)</span>to reset your system's IPVS tables.The reset process does not clean your kubeconfig files and you must remove them manually.Please, check the contents of the <span class="token variable">$HOME</span>/.kube/config file.</code></pre><p>清理完好干净:</p><pre class=" language-bash"><code class="language-bash">root@pi-master1:~<span class="token comment" spellcheck="true"># docker ps</span>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMESroot@pi-master1:~<span class="token comment" spellcheck="true"># docker ps --all</span>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> kubeadm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s中配置lnmp环境</title>
      <link href="/eb76ee24/"/>
      <url>/eb76ee24/</url>
      
        <content type="html"><![CDATA[<h1 id="一、配置用于存储的NFS服务"><a href="#一、配置用于存储的NFS服务" class="headerlink" title="一、配置用于存储的NFS服务"></a>一、配置用于存储的NFS服务</h1><h3 id="1-1服务端配置-nfs"><a href="#1-1服务端配置-nfs" class="headerlink" title="1.1服务端配置 nfs"></a>1.1服务端配置 nfs</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#yum安装</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install nfs-utils</span><span class="token comment" spellcheck="true">#编辑 配置文件 （确保目录存在）</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># vim /etc/exports</span>/data/lnmp 10.7.0.0/16(rw<span class="token punctuation">,</span>no_root_squash)<span class="token comment" spellcheck="true">#启动服务</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl start nfs</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl status  nfs</span>● nfs<span class="token punctuation">-</span>server.service <span class="token punctuation">-</span> NFS server and services   <span class="token key atrule">Loaded</span><span class="token punctuation">:</span> loaded (/usr/lib/systemd/system/nfs<span class="token punctuation">-</span>server.service; disabled; vendor preset<span class="token punctuation">:</span> disabled)  <span class="token key atrule">Drop-In</span><span class="token punctuation">:</span> /run/systemd/generator/nfs<span class="token punctuation">-</span>server.service.d           └─order<span class="token punctuation">-</span>with<span class="token punctuation">-</span>mounts.conf   <span class="token key atrule">Active</span><span class="token punctuation">:</span> active (exited) since Sat 2021<span class="token punctuation">-</span>09<span class="token punctuation">-</span>11 17<span class="token punctuation">:</span>32<span class="token punctuation">:</span>16 HKT; 1 weeks 0 days ago Main PID<span class="token punctuation">:</span> 21698 (code=exited<span class="token punctuation">,</span> status=0/SUCCESS)    <span class="token key atrule">Tasks</span><span class="token punctuation">:</span> <span class="token number">0</span>   <span class="token key atrule">Memory</span><span class="token punctuation">:</span> 0B   <span class="token key atrule">CGroup</span><span class="token punctuation">:</span> /system.slice/nfs<span class="token punctuation">-</span>server.service<span class="token comment" spellcheck="true">#showmount确认</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># showmount -e</span>Export list for k8smaster<span class="token punctuation">:</span>/data/lnmp 10.7.0.0/16</code></pre><h3 id="1-2客户端挂载服务"><a href="#1-2客户端挂载服务" class="headerlink" title="1.2客户端挂载服务"></a>1.2客户端挂载服务</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#安装nfs客户端 </span><span class="token punctuation">[</span>root@k8snode ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install nfs-utils.x86_64</span><span class="token comment" spellcheck="true">#showmount -e查看</span><span class="token punctuation">[</span>root@k8snode ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># showmount -e 10.7.48.223</span>Export list for 10.7.48.223<span class="token punctuation">:</span>/data/lnmp 10.7.0.0/16<span class="token comment" spellcheck="true">#创建挂载点挂载</span><span class="token punctuation">[</span>root@k8snode data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /data</span><span class="token punctuation">[</span>root@k8snode data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mount -t nfs 10.7.48.223/data/lnmp /data</span></code></pre><h1 id="二-、配置LNMP环境"><a href="#二-、配置LNMP环境" class="headerlink" title="二 、配置LNMP环境"></a>二 、配置LNMP环境</h1><h3 id="2-1mysql配置清单"><a href="#2-1mysql配置清单" class="headerlink" title="2.1mysql配置清单"></a>2.1mysql配置清单</h3><p>配置前先创建需要的命名空间</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create ns  lnmp</span></code></pre><p>mysql清单配置如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pass              <span class="token key atrule">key</span><span class="token punctuation">:</span> password        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lnmp<span class="token punctuation">-</span>mysql          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lnmp<span class="token punctuation">-</span>mysql        <span class="token key atrule">nfs</span><span class="token punctuation">:</span>         <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token comment" spellcheck="true">#nfs server服务器IP</span>         <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/data/lnmp/mysql"</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql</code></pre><p>这里面mysql 密码是通过环境 变量的方式导入的密码配置参考下面方法</p><pre class=" language-yaml"><code class="language-yaml">kubectl create secret generic mysql<span class="token punctuation">-</span>pass <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>literal=password=123456 <span class="token punctuation">-</span>n lnmp</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#启动</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f mysql.yaml -n lnmp</span>deployment.apps/mysql createdservice/mysql unchanged<span class="token comment" spellcheck="true">#查看pod状态</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po  -n lnmp</span>NAME                        READY   STATUS    RESTARTS   AGEmysql<span class="token punctuation">-</span>6cc8488986<span class="token punctuation">-</span>2wf62      1/1     Running   0          13m<span class="token comment" spellcheck="true">#查看svc地址并确认端口连通性</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get svc  -n lnmp</span>NAME        TYPE        CLUSTER<span class="token punctuation">-</span>IP      EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)        AGEmysql       ClusterIP   10.97.108.119   &lt;none<span class="token punctuation">></span>        3306/TCP       2d20h<span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># telnet  10.97.108.119  3306</span>Trying 10.97.108.119<span class="token punctuation">...</span>Connected to 10.97.108.119.Escape character is '^<span class="token punctuation">]</span>'<span class="token comment" spellcheck="true">#端口可以正常访问mysql的配置就是正常的</span></code></pre><h3 id="2-2-nginx-php配置清单"><a href="#2-2-nginx-php配置清单" class="headerlink" title="2.2 nginx+php配置清单"></a>2.2 nginx+php配置清单</h3><p>清单文件如下</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com/user<span class="token punctuation">-</span>sum/php        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/www/html/       <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com/user<span class="token punctuation">-</span>sum/alpine<span class="token punctuation">:</span>nginx1.18.0        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/conf.d/       <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data        <span class="token key atrule">nfs</span><span class="token punctuation">:</span>         <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token comment" spellcheck="true">#nfs server服务器IP</span>         <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/data/lnmp/app"</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf         <span class="token key atrule">items</span><span class="token punctuation">:</span>         <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> default.conf           <span class="token key atrule">path</span><span class="token punctuation">:</span> add.conf <span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30010</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php</code></pre><p>nginx服务配置文件</p><pre class=" language-yaml"><code class="language-yaml">server &amp;<span class="token comment" spellcheck="true">#123;</span>    listen       80;    server_name  localhost;    location / &amp;<span class="token comment" spellcheck="true">#123;</span>        root   /usr/share/nginx/html;        index  index.html index.htm;    &amp;<span class="token comment" spellcheck="true">#125;</span>    error_page   500 502 503 504  /50x.html;    location = /50x.html &amp;<span class="token comment" spellcheck="true">#123;</span>        root   /usr/share/nginx/html;    &amp;<span class="token comment" spellcheck="true">#125;</span>    location ~ \.php$ &amp;<span class="token comment" spellcheck="true">#123;</span>        fastcgi_pass   127.0.0.1<span class="token punctuation">:</span>9000;        fastcgi_index  index.php;        fastcgi_param  SCRIPT_FILENAME  /var/www/html/$fastcgi_script_name;        include        fastcgi_params;    &amp;<span class="token comment" spellcheck="true">#125;</span>&amp;<span class="token comment" spellcheck="true">#125;</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建configmap</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create cm ngin-conf --from-file=default.conf -n lnmp</span><span class="token comment" spellcheck="true">#启动</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nginx-php.yaml -n lnmp</span></code></pre><h3 id="2-3测试"><a href="#2-3测试" class="headerlink" title="2.3测试"></a>2.3测试</h3><p>测试 php连通性</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#创建测试文件测试</span><span class="token punctuation">[</span>root@k8snode app<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test.php </span>&lt;<span class="token punctuation">?</span>php phpinfo(); <span class="token punctuation">?</span><span class="token punctuation">></span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/3394303815.png"></p><p>测试 mysql连通性</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8snode app<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat mysql.php </span>&lt;h1<span class="token punctuation">></span>Test php<span class="token punctuation">-</span>mysql &lt;/h1<span class="token punctuation">></span>&lt;<span class="token punctuation">?</span>phpmysqli_connect('10.97.108.119'<span class="token punctuation">,</span><span class="token string">'root'</span><span class="token punctuation">,</span>'123456') or die('failed');echo 'success';phpinfo();<span class="token punctuation">?</span><span class="token punctuation">></span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/3128067845.png"><br>至此配置完成后面就可以吧自己的项目放到nginx工作目录愉快的玩耍了(๑•̀ㅁ•́ฅ)</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> lnmp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s数据持久化StorageClass</title>
      <link href="/c062e948/"/>
      <url>/c062e948/</url>
      
        <content type="html"><![CDATA[<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a><strong>一、简介</strong></h1><h3 id="1-1什么是StorageClass"><a href="#1-1什么是StorageClass" class="headerlink" title="1.1什么是StorageClass"></a><strong>1.1什么是StorageClass</strong></h3><p>Kubernetes提供了一套可以自动创建PV的机制，即：Dynamic Provisioning。而这个机制的核心在于StorageClass这个API对象。</p><p>StorageClass对象会定义下面两部分内容:</p><ul><li>PV的属性。比如，存储类型，Volume的大小等。</li><li>创建这种PV需要用到的存储插件，即存储制备器。<br>有了这两个信息之后，Kubernetes就能够根据用户提交的PVC，找到一个对应的StorageClass，之后Kubernetes就会调用该StorageClass声明的存储插件，进而创建出需要的PV。</li></ul><p>但是其实使用起来是一件很简单的事情，你只需要根据自己的需求，编写YAML文件即可，然后使用kubectl create命令执行即可。</p><hr><h3 id="1-2StorageClass架构"><a href="#1-2StorageClass架构" class="headerlink" title="1.2StorageClass架构"></a><strong>1.2StorageClass架构</strong></h3><p>在动态资源供应模式下，通过StorageClass和PVC完成资源动态绑定（系统自动生成PV），并供Pod使用的存储管理机制。<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/10/3784991912.png"></p><hr><h1 id="二、创建"><a href="#二、创建" class="headerlink" title="二、创建"></a><strong>二、创建</strong></h1><h3 id="2-1创建StorageClass存储服务"><a href="#2-1创建StorageClass存储服务" class="headerlink" title="2.1创建StorageClass存储服务"></a><strong>2.1创建StorageClass存储服务</strong></h3><p>利用nfs-client-provisioner来生成一个基于nfs的StorageClass，部署配置yaml配置如下，保持为nfs-sc.yaml：</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01  </span><span class="token comment" spellcheck="true"># 此处供应者名字供storageclass调用</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/lnmp/test  <span class="token comment" spellcheck="true"># 填入NFS挂载的目录</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/lnmp/test   <span class="token comment" spellcheck="true"># 填入NFS挂载的目录</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>test<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span><span class="token comment" spellcheck="true"># Supported policies: Delete、 Retain ， default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#部署服务</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nfs-sc.yaml</span><span class="token comment" spellcheck="true">#因为是偏向系统层面的服务所以放到了kube-system命名空间</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n kube-system get pod</span><span class="token comment" spellcheck="true">#查看sc状态</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get sc</span>NAME       PROVISIONER          RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGEnfs<span class="token punctuation">-</span>test   nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>01   Retain          Immediate           false             2m43s</code></pre><hr><h3 id="2-2-基于SC创建PVC测试"><a href="#2-2-基于SC创建PVC测试" class="headerlink" title="2.2 基于SC创建PVC测试"></a><strong>2.2 基于SC创建PVC测试</strong></h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>sc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>test  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Mi</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f pvc-sc.yaml</span>persistentvolumeclaim/pvc<span class="token punctuation">-</span>sc created<span class="token comment" spellcheck="true">#查看pv和pvc</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pv</span>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                                           STORAGECLASS   REASON   AGEpvc<span class="token punctuation">-</span>bc40c73b<span class="token punctuation">-</span>cf4a<span class="token punctuation">-</span>4c2d<span class="token punctuation">-</span>a551<span class="token punctuation">-</span>c2fdbd7e245a   1Mi        RWX            Retain        Bound      default/pvc<span class="token punctuation">-</span>sc                                  nfs<span class="token punctuation">-</span>test             52s<span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc</span>NAME     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEpvc<span class="token punctuation">-</span>sc   Bound    pvc<span class="token punctuation">-</span>bc40c73b<span class="token punctuation">-</span>cf4a<span class="token punctuation">-</span>4c2d<span class="token punctuation">-</span>a551<span class="token punctuation">-</span>c2fdbd7e245a   1Mi        RWX         nfs<span class="token punctuation">-</span>test       2m31s</code></pre><p>使用nginx测试</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 我们这里将nginx容器默认的页面目录挂载</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>files            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"/usr/share/nginx/html"</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>files          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>sc</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nginx.yaml</span>deployment.apps/nginx created<span class="token comment" spellcheck="true">#查看pod是否运行</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po</span>NAME                     READY   STATUS    RESTARTS   AGEnginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m   1/1     Running   0          46s<span class="token comment" spellcheck="true">#进入pod测试是否设置成功</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it nginx-76f5df5fcf-f8x9m -- bash</span>root@nginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m<span class="token punctuation">:</span>/<span class="token comment" spellcheck="true"># echo 'test' > /usr/share/nginx/html/index.html</span>root@nginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m<span class="token punctuation">:</span>/<span class="token comment" spellcheck="true"># exit</span>exit<span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /data/lnmp/test/default-pvc-sc-pvc-bc40c73b-cf4a-4c2d-a551-c2fdbd7e245a/index.html</span>test</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s强制删除Terminating的命名空间</title>
      <link href="/fafe3e8d/"/>
      <url>/fafe3e8d/</url>
      
        <content type="html"><![CDATA[<p>我们在日常的k8s维护中，经常遇到k8s删除命名空间一直处于Terminating的状态 让人抓狂::(怒) 下面总结下强制删除的方法</p><h3 id="1-1-将ns资源保存为json文件"><a href="#1-1-将ns资源保存为json文件" class="headerlink" title="1.1 将ns资源保存为json文件"></a>1.1 将ns资源保存为json文件</h3><pre class=" language-bash"><code class="language-bash">kubectl get ns istio-system -o json <span class="token operator">></span>istis.json</code></pre><h3 id="2-1-删除json文件finalizers字段"><a href="#2-1-删除json文件finalizers字段" class="headerlink" title="2.1 删除json文件finalizers字段"></a>2.1 删除json文件finalizers字段</h3><pre class=" language-json"><code class="language-json"><span class="token property">"spec"</span><span class="token operator">:</span> &amp;#<span class="token number">123</span><span class="token punctuation">;</span>        <span class="token property">"finalizers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token string">"kubernetes"</span>        <span class="token punctuation">]</span>    &amp;#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">,</span></code></pre><h3 id="3-1启动一个kube-proxy"><a href="#3-1启动一个kube-proxy" class="headerlink" title="3.1启动一个kube proxy"></a>3.1启动一个kube proxy</h3><pre class=" language-bash"><code class="language-bash">kubectl proxy --port<span class="token operator">=</span>8081</code></pre><p>在启动一个终端并执行下面命令</p><pre class=" language-bash"><code class="language-bash">curl -k -H <span class="token string">"Content-Type: application/json"</span> -X PUT --data-binary @istis.json http://127.0.0.1:8081/api/v1/namespaces/istio-system/finalize</code></pre><p>再次查看就发现已经正常删除这个ns了::(滑稽)</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s配置ingress-nginx暴露服务</title>
      <link href="/3033822e/"/>
      <url>/3033822e/</url>
      
        <content type="html"><![CDATA[<h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><h4 id="1-1-介绍"><a href="#1-1-介绍" class="headerlink" title="1.1 介绍"></a><strong>1.1 介绍</strong></h4><p>在kubernetes中，POD，SVC的IP地址只能集群内部使用，集群外部是无法访问的。</p><p>为了能让外部的应用访问进来，kubernetes提供了如下几种方案：</p><ul><li>NodePort</li><li>LoadBalancer</li><li>Ingress</li></ul><h4 id="1-2-工作原理"><a href="#1-2-工作原理" class="headerlink" title="1.2 工作原理"></a><strong>1.2 工作原理</strong></h4><ul><li>本质：7层http&#x2F;https代理</li><li>ingress controller通过和kubernetes apiserver交互，动态的获取集群中的ingress规则</li><li>解析ingress规则，生成proxy服务的配置，比如nginx配置</li><li>再写到ingress proxy的pod中，如果pod运行的是nginx服务，就生成nginx配置，并放到&#x2F;etc&#x2F;nginx&#x2F;nginx.conf中</li><li>然后reload服务</li></ul><h1 id="二、配置"><a href="#二、配置" class="headerlink" title="二、配置"></a><strong>二、配置</strong></h1><h4 id="2-1-ingress-controller配置"><a href="#2-1-ingress-controller配置" class="headerlink" title="2.1 ingress-controller配置"></a><strong>2.1 ingress-controller配置</strong></h4><blockquote><p>配置如下</p></blockquote><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps      <span class="token punctuation">-</span> endpoints      <span class="token punctuation">-</span> nodes      <span class="token punctuation">-</span> pods      <span class="token punctuation">-</span> secrets      <span class="token punctuation">-</span> namespaces      <span class="token punctuation">-</span> services    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"extensions"</span>      <span class="token punctuation">-</span> <span class="token string">"networking.k8s.io"</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> events    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create      <span class="token punctuation">-</span> patch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"extensions"</span>      <span class="token punctuation">-</span> <span class="token string">"networking.k8s.io"</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses/status    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> update  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"ingress-controller-leader-nginx"</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> update<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>lb  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10254</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>configuration  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">keep-alive</span><span class="token punctuation">:</span> <span class="token string">"75"</span>  <span class="token key atrule">keep-alive-requests</span><span class="token punctuation">:</span> <span class="token string">"100"</span>  <span class="token key atrule">upstream-keepalive-connections</span><span class="token punctuation">:</span> <span class="token string">"10000"</span>  <span class="token key atrule">upstream-keepalive-requests</span><span class="token punctuation">:</span> <span class="token string">"100"</span>  <span class="token key atrule">upstream-keepalive-timeout</span><span class="token punctuation">:</span> <span class="token string">"60"</span>  <span class="token key atrule">allow-backend-server-header</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">enable-underscores-in-headers</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">generate-request-id</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">http-redirect-code</span><span class="token punctuation">:</span> <span class="token string">"301"</span>  <span class="token key atrule">ignore-invalid-headers</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">log-format-upstream</span><span class="token punctuation">:</span> '&amp;<span class="token comment" spellcheck="true">#123;"@timestamp": "$time_iso8601","remote_addr": "$remote_addr","x-forward-for": "$proxy_add_x_forwarded_for","request_id": "$req_id","remote_user": "$remote_user","bytes_sent": $bytes_sent,"request_time": $request_time,"status": $status,"vhost": "$host","request_proto": "$server_protocol","path": "$uri","request_query": "$args","request_length": $request_length,"duration": $request_time,"method": "$request_method","http_referrer": "$http_referer","http_user_agent":  "$http_user_agent","upstream-sever":"$proxy_upstream_name","proxy_alternative_upstream_name":"$proxy_alternative_upstream_name","upstream_addr":"$upstream_addr","upstream_response_length":$upstream_response_length,"upstream_response_time":$upstream_response_time,"upstream_status":$upstream_status&amp;#125;'</span>  <span class="token key atrule">max-worker-connections</span><span class="token punctuation">:</span> <span class="token string">"65536"</span>  <span class="token key atrule">worker-processes</span><span class="token punctuation">:</span> <span class="token string">"2"</span>  <span class="token key atrule">proxy-body-size</span><span class="token punctuation">:</span> 20m  <span class="token key atrule">proxy-connect-timeout</span><span class="token punctuation">:</span> <span class="token string">"10"</span>  <span class="token key atrule">proxy_next_upstream</span><span class="token punctuation">:</span> error timeout http_502  <span class="token key atrule">reuse-port</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">server-tokens</span><span class="token punctuation">:</span> <span class="token string">"false"</span>  <span class="token key atrule">ssl-ciphers</span><span class="token punctuation">:</span> ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>kEDH+AESGCM<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES<span class="token punctuation">:</span>CAMELLIA<span class="token punctuation">:</span>DES<span class="token punctuation">-</span>CBC3<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span><span class="token tag">!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA</span>  <span class="token key atrule">ssl-protocols</span><span class="token punctuation">:</span> TLSv1 TLSv1.1 TLSv1.2  <span class="token key atrule">ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"false"</span>  <span class="token key atrule">worker-cpu-affinity</span><span class="token punctuation">:</span> auto<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>services  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> udp<span class="token punctuation">-</span>services  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">component.version</span><span class="token punctuation">:</span> <span class="token string">"v0.30.0"</span>    <span class="token key atrule">component.revision</span><span class="token punctuation">:</span> <span class="token string">"v1"</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> <span class="token string">"10254"</span>        <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span>        <span class="token key atrule">scheduler.alpha.kubernetes.io/critical-pod</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>node<span class="token punctuation">-</span>critical      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                  <span class="token key atrule">values</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> ingress<span class="token punctuation">-</span>nginx              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname            <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> type                <span class="token key atrule">operator</span><span class="token punctuation">:</span> NotIn                <span class="token key atrule">values</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> virtual<span class="token punctuation">-</span>kubelet      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/acs/aliyun<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">:</span>v0.30.0.2<span class="token punctuation">-</span>9597b3685<span class="token punctuation">-</span>aliyun          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/nginx<span class="token punctuation">-</span>configuration            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tcp<span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/tcp<span class="token punctuation">-</span>services            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>udp<span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/udp<span class="token punctuation">-</span>services            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>publish<span class="token punctuation">-</span>service=$(POD_NAMESPACE)/nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>lb            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>annotations<span class="token punctuation">-</span>prefix=nginx.ingress.kubernetes.io            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enable<span class="token punctuation">-</span>dynamic<span class="token punctuation">-</span>certificates=true            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>v=2          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>            <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>            <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>              <span class="token key atrule">drop</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> ALL              <span class="token key atrule">add</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> NET_BIND_SERVICE            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">101</span>          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime            <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime            <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime          <span class="token key atrule">type</span><span class="token punctuation">:</span> File      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> /bin/sh        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          mount -o remount rw /proc/sys          sysctl -w net.core.somaxconn=65535          sysctl -w net.ipv4.ip_local_port_range="1024 65535"          sysctl -w fs.file-max=1048576          sysctl -w fs.inotify.max_user_instances=16384          sysctl -w fs.inotify.max_user_watches=524288          sysctl -w fs.inotify.max_queued_events=16384</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/acs/busybox<span class="token punctuation">:</span>v1.29.2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>sysctl        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">procMount</span><span class="token punctuation">:</span> Default</code></pre><h4 id="2-2配置用于测试的nginx-pod"><a href="#2-2配置用于测试的nginx-pod" class="headerlink" title="2.2配置用于测试的nginx pod"></a><strong>2.2配置用于测试的nginx pod</strong></h4><blockquote><p>yaml清单如下</p></blockquote><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</code></pre><h4 id="2-3配置ingress"><a href="#2-3配置ingress" class="headerlink" title="2.3配置ingress"></a><strong>2.3配置ingress</strong></h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.boge.com      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">paths</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /          <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix          <span class="token key atrule">backend</span><span class="token punctuation">:</span>            <span class="token key atrule">service</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx              <span class="token key atrule">port</span><span class="token punctuation">:</span>                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><h4 id="2-4-部署"><a href="#2-4-部署" class="headerlink" title="2.4 部署"></a><strong>2.4 部署</strong></h4><blockquote><p>yaml清单中有指定nodeselector 所以需要确认node都有这个标签，pod才会被正常调度</p></blockquote><pre class=" language-yaml"><code class="language-yaml">kubectl label node 10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>48<span class="token punctuation">-</span>223 boge/ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>ready=truekubectl label node 10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>110<span class="token punctuation">-</span>221 boge/ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>ready=true<span class="token comment" spellcheck="true">#标签配置完成即可启动ingress-controller</span>kubectl apply <span class="token punctuation">-</span>f ingress.yaml<span class="token comment" spellcheck="true"># 查看pod是否都正常运行</span>kubectl <span class="token punctuation">-</span>n ingress<span class="token punctuation">-</span>nginx get pod <span class="token punctuation">-</span>o wideNAME                             READY   STATUS    RESTARTS   AGE   IP             NODE           NOMINATED NODE   READINESS GATESnginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>6pgmj   1/1     Running   0          70m   10.7.110.221   10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>110<span class="token punctuation">-</span>221   &lt;none<span class="token punctuation">></span>           &lt;none<span class="token punctuation">></span>nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>gfksc   1/1     Running   0          70m   10.7.48.223    10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>48<span class="token punctuation">-</span>223    &lt;none<span class="token punctuation">></span>           &lt;none<span class="token punctuation">></span><span class="token comment" spellcheck="true">#启动nginx deploy</span>kubectl apply <span class="token punctuation">-</span>f nginx.yaml<span class="token comment" spellcheck="true">#启动ingress</span>kubectl apply <span class="token punctuation">-</span>f nginx<span class="token punctuation">-</span>ingress.yaml<span class="token comment" spellcheck="true">#查看ingress资源</span>kubectl get ingressNAME            CLASS    HOSTS            ADDRESS          PORTS   AGEnginx<span class="token punctuation">-</span>ingress   &lt;none<span class="token punctuation">></span>   nginx.boge.com   10.102.200.157   80      70m</code></pre><h1 id="三、测试"><a href="#三、测试" class="headerlink" title="三、测试"></a><strong>三、测试</strong></h1><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#可以在其他的节点，绑定hosts测试</span>curl nginx.boge.com&lt;<span class="token tag">!DOCTYPE</span> html<span class="token punctuation">></span>&lt;html<span class="token punctuation">></span>&lt;head<span class="token punctuation">></span>&lt;title<span class="token punctuation">></span>Welcome to nginx<span class="token tag">!&lt;/title></span>&lt;style<span class="token punctuation">></span>html &amp;<span class="token comment" spellcheck="true">#123; color-scheme: light dark; &amp;#125;</span>body &amp;<span class="token comment" spellcheck="true">#123; width: 35em; margin: 0 auto;</span><span class="token key atrule">font-family</span><span class="token punctuation">:</span> Tahoma<span class="token punctuation">,</span> Verdana<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans<span class="token punctuation">-</span>serif; &amp;<span class="token comment" spellcheck="true">#125;</span>&lt;/style<span class="token punctuation">></span>&lt;/head<span class="token punctuation">></span>&lt;body<span class="token punctuation">></span>&lt;h1<span class="token punctuation">></span>Welcome to nginx<span class="token tag">!&lt;/h1></span>&lt;p<span class="token punctuation">></span>If you see this page<span class="token punctuation">,</span> the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p<span class="token punctuation">></span>&lt;p<span class="token punctuation">></span>For online documentation and support please refer to&lt;a href="http<span class="token punctuation">:</span>//nginx.org/"<span class="token punctuation">></span>nginx.org&lt;/a<span class="token punctuation">></span>.&lt;br/<span class="token punctuation">></span>Commercial support is available at&lt;a href="http<span class="token punctuation">:</span>//nginx.com/"<span class="token punctuation">></span>nginx.com&lt;/a<span class="token punctuation">></span>.&lt;/p<span class="token punctuation">></span>&lt;p<span class="token punctuation">></span>&lt;em<span class="token punctuation">></span>Thank you for using nginx.&lt;/em<span class="token punctuation">></span>&lt;/p<span class="token punctuation">></span>&lt;/body<span class="token punctuation">></span>&lt;/html<span class="token punctuation">></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s配置4层转发nginx</title>
      <link href="/54433e83/"/>
      <url>/54433e83/</url>
      
        <content type="html"><![CDATA[<h1 id="一-四层转发和七层转发"><a href="#一-四层转发和七层转发" class="headerlink" title="一 四层转发和七层转发"></a>一 四层转发和七层转发</h1><h3 id="1-1四层负载均衡"><a href="#1-1四层负载均衡" class="headerlink" title="1.1四层负载均衡"></a>1.1四层负载均衡</h3><p>四层负载均衡工作在OSI模型的传输层，由于在传输层，只有TCP&#x2F;UDP协议，这两种协议中除了包含源IP、目标IP以外，还包含源端口号及目的端口号。四层负载均衡服务器在接受到客户端请求后，以后通过修改数据包的地址信息（IP+端口号）将流量转发到应用服务器。</p><h3 id="1-2七层负载均衡"><a href="#1-2七层负载均衡" class="headerlink" title="1.2七层负载均衡"></a>1.2七层负载均衡</h3><p>七层负载均衡工作在OSI模型的应用层，应用层协议较多，常用http、radius、dns等。七层负载就可以基于这些协议来负载。这些应用层协议中会包含很多有意义的内容。比如同一个Web服务器的负载均衡，除了根据IP加端口进行负载外，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/1508471474.jpeg"></p><h1 id="二-Nginx4层转发的配置"><a href="#二-Nginx4层转发的配置" class="headerlink" title="二 Nginx4层转发的配置"></a>二 Nginx4层转发的配置</h1><p>生产业务中很多端口只能使用tcp连接 比如mysql ssh 这些端口是无法使用普通的7层代理进行转发的 因此需要我们配置nginx的四层转发</p><h3 id="2-1-Nginx-Dockerfile配置"><a href="#2-1-Nginx-Dockerfile配置" class="headerlink" title="2.1 Nginx Dockerfile配置"></a>2.1 Nginx Dockerfile配置</h3><p>创建Nginx Dockerfile nginx编译需要–with-stream 模块 否则无法配置</p><pre class=" language-bash"><code class="language-bash">FROM centos:7.8.2003MAINTAINER huhuhaheiADD nginx-1.12.0.tar.gz /optRUN yum -y <span class="token function">install</span> gcc gcc-c++ lrzsz pcre-devel zlib-devel openssl openssl-devel <span class="token operator">&amp;&amp;</span> <span class="token function">useradd</span> -M -s /sbin/nologin nginx <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> /opt/nginx-1.12.0/ <span class="token operator">&amp;&amp;</span> ./configure --prefix<span class="token operator">=</span>/usr/local/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_stub_status_module --with-http_ssl_module --with-stream <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><h3 id="2-2-创建转发的配置文件"><a href="#2-2-创建转发的配置文件" class="headerlink" title="2.2 创建转发的配置文件"></a>2.2 创建转发的配置文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    user  root;    worker_processes  auto;    error_log  logs/error.log  info;    pid        logs/nginx.pid;</span>    events &amp;<span class="token comment" spellcheck="true">#123;</span>        use epoll;    &amp;<span class="token comment" spellcheck="true">#125;</span>    stream &amp;<span class="token comment" spellcheck="true">#123;</span>      upstream backend &amp;<span class="token comment" spellcheck="true">#123;</span>          server *****<span class="token punctuation">:</span>8080 max_fails=3 fail_timeout=30s;      &amp;<span class="token comment" spellcheck="true">#125;</span>      server &amp;<span class="token comment" spellcheck="true">#123;</span>          listen 8080;          proxy_connect_timeout 1s;          proxy_timeout 3s;          proxy_pass backend;      &amp;<span class="token comment" spellcheck="true">#125;</span>      log_format proxy '$remote_addr <span class="token punctuation">[</span>$time_local<span class="token punctuation">]</span>'                '$protocol $status $bytes_sent $bytes_received'                '$session_time "$upstream_addr" '                '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';            access_log /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>access.log proxy ;      error_log  /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>error.log warn ;          &amp;<span class="token comment" spellcheck="true">#125;</span>    http &amp;<span class="token comment" spellcheck="true">#123;</span>        include       /usr/local/nginx/conf/mime.types;        default_type  application/octet<span class="token punctuation">-</span>stream;      &amp;<span class="token comment" spellcheck="true">#125;</span></code></pre><h3 id="2-3-创建Nginx-deploy文件"><a href="#2-3-创建Nginx-deploy文件" class="headerlink" title="2.3 创建Nginx deploy文件"></a>2.3 创建Nginx deploy文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf            <span class="token key atrule">items</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx.conf                <span class="token key atrule">path</span><span class="token punctuation">:</span> nginx.conf            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs          <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'harbor.huhuhahei.cn/test/nginx_proxy:v2'</span>          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> ./usr/local/nginx/sbin/nginx          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">'-g daemon off;'</span>            <span class="token punctuation">-</span> <span class="token string">'-c'</span>            <span class="token punctuation">-</span> /opt/nginx.conf          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_proxy<span class="token punctuation">-</span>access<span class="token punctuation">-</span>log              <span class="token key atrule">value</span><span class="token punctuation">:</span> /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>access.log            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_proxy<span class="token punctuation">-</span>error<span class="token punctuation">-</span>log              <span class="token key atrule">value</span><span class="token punctuation">:</span> /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>error.log            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai          <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/logs/          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> proxy      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s集群内配置coredns解析</title>
      <link href="/69f5e54a/"/>
      <url>/69f5e54a/</url>
      
        <content type="html"><![CDATA[<p>编辑coredns的confmap</p><pre class=" language-bash"><code class="language-bash">kubectl -n kube-system edit configmaps coredns</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">Corefile</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    .:53 &amp;#123;        errors        health        ready</span><span class="token comment" spellcheck="true"># 添加下面</span>        log        rewrite stop &amp;<span class="token comment" spellcheck="true">#123;</span>          name regex git.boge.com gitlab.gitlab<span class="token punctuation">-</span>ver130806.svc.cluster.local<span class="token comment" spellcheck="true"># 将域名解析到默认的svc域名</span>          answer name gitlab.gitlab<span class="token punctuation">-</span>ver130806.svc.cluster.local git.boge.com<span class="token comment" spellcheck="true"># 反向解析</span>        &amp;<span class="token comment" spellcheck="true">#125;</span><span class="token comment" spellcheck="true"># </span>        kubernetes cluster.local in<span class="token punctuation">-</span>addr.arpa ip6.arpa &amp;<span class="token comment" spellcheck="true">#123;</span>          pods verified          fallthrough in<span class="token punctuation">-</span>addr.arpa ip6.arpa        &amp;<span class="token comment" spellcheck="true">#125;</span>        autopath @kubernetes        prometheus <span class="token punctuation">:</span><span class="token number">9153</span>        forward . /etc/resolv.conf        cache 30        loop        reload        loadbalance    &amp;<span class="token comment" spellcheck="true">#125;</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system  </code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s基础yaml文件</title>
      <link href="/b19e20d5/"/>
      <url>/b19e20d5/</url>
      
        <content type="html"><![CDATA[<h1 id="一、基础Pod配置"><a href="#一、基础Pod配置" class="headerlink" title="一、基础Pod配置"></a>一、基础Pod配置</h1><p><strong>nginx：</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>    <span class="token punctuation">-</span> <span class="token string">"-c"</span>    <span class="token punctuation">-</span> <span class="token string">"sleep 3600"</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd</code></pre><hr><p><strong>存活性探针配置：</strong><br>exec</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>pod  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"touch /tmp/healthy sleep 60; rm -f /tmp/healthy; sleep 3600"</span><span class="token punctuation">]</span>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">exec</span><span class="token punctuation">:</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"-e"</span><span class="token punctuation">,</span><span class="token string">"/tmp/healthy"</span><span class="token punctuation">]</span>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></code></pre><p>HttpGet</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>httpget  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> http        <span class="token key atrule">path</span><span class="token punctuation">:</span> /index.html      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></code></pre><hr><p><strong>就绪性探针：</strong><br>HttpGet</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness<span class="token punctuation">-</span>httpget  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> http        <span class="token key atrule">path</span><span class="token punctuation">:</span> /index.html      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></code></pre><hr><h1 id="二、调度器基础配置"><a href="#二、调度器基础配置" class="headerlink" title="二、调度器基础配置"></a>二、调度器基础配置</h1><p><strong>ReplicaSet</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp      <span class="token key atrule">release</span><span class="token punctuation">:</span> canary  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp        <span class="token key atrule">release</span><span class="token punctuation">:</span> canary        <span class="token key atrule">environment</span><span class="token punctuation">:</span> qa    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>container        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><hr><p><strong>Deployment</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/lnmp_php<span class="token punctuation">:</span>v1        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/html      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/lnmp_nginx<span class="token punctuation">:</span>v2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/html        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/conf/conf.d/        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>logs          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> blog<span class="token punctuation">-</span>nginx      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>logs        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> blog<span class="token punctuation">-</span>logs      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf         <span class="token key atrule">items</span><span class="token punctuation">:</span>         <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx.conf           <span class="token key atrule">path</span><span class="token punctuation">:</span> add.conf</code></pre><p><strong>DaemonSet</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> redis      <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> redis        <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis        <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>4.0<span class="token punctuation">-</span>alpine        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>ds  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat      <span class="token key atrule">release</span><span class="token punctuation">:</span> stable  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat        <span class="token key atrule">release</span><span class="token punctuation">:</span> stable    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/filebeat<span class="token punctuation">:</span>5.6.5<span class="token punctuation">-</span>alpine        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_HOST          <span class="token key atrule">value</span><span class="token punctuation">:</span> redis.default.svc.cluster.local        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_LOG_LEVEL          <span class="token key atrule">value</span><span class="token punctuation">:</span> info</code></pre><p><strong>statefulset</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>statefulset  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> web        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myappdata          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> myappdata    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"ReadWriteOnce"</span> <span class="token punctuation">]</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi</code></pre><h1 id="三、Service配置"><a href="#三、Service配置" class="headerlink" title="三、Service配置"></a>三、Service配置</h1><p><strong>NodePort</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">release</span><span class="token punctuation">:</span> canary  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.99.99.99  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30080</span></code></pre><p><strong>ClusterIP</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redis    <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.97.97.97  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span></code></pre><h1 id="四、持久卷配置"><a href="#四、持久卷配置" class="headerlink" title="四、持久卷配置"></a>四、持久卷配置</h1><p><strong>emptyDir</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/    <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>    <span class="token punctuation">-</span> <span class="token string">"-c"</span>    <span class="token punctuation">-</span> <span class="token string">"while true; do echo $(date) >> /data/index.html; sleep 2;done"</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span></code></pre><p><strong>hostpath</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>hostpath  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/pod/volume1      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate</code></pre><p><strong>nfs</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>nfs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">nfs</span><span class="token punctuation">:</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/test      <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223</code></pre><p><strong>PV</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv001  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0001<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v1    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv002  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0002<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v2    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv003  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0003<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v3    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv004  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0004<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v4    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv005  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0005<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v5    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span></code></pre><p><strong>pvc</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypvc  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">]</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 6Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>nfs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> mypvc</code></pre><h1 id="五、配置中心（configmap）"><a href="#五、配置中心（configmap）" class="headerlink" title="五、配置中心（configmap）"></a>五、配置中心（configmap）</h1><p><strong>通过环境变量注入配置</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>cm<span class="token punctuation">-</span><span class="token number">1</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NGINX_SERVER_PORT      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config          <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx_port    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NGINX_SERVER_NAME      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config          <span class="token key atrule">key</span><span class="token punctuation">:</span> server_name</code></pre><p><strong>通过配置文件注入</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>cm<span class="token punctuation">-</span><span class="token number">2</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginxconf      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/config.d/      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginxconf    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ingress高级配置</title>
      <link href="/893a2674/"/>
      <url>/893a2674/</url>
      
        <content type="html"><![CDATA[<h1 id="一-配置ingress路径重写"><a href="#一-配置ingress路径重写" class="headerlink" title="一.配置ingress路径重写"></a>一.配置ingress路径重写</h1><p>若后端路径是&#x2F;app 默认访问是不带路径的会导致出现404的情况 因此需要配置下路径重写</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/app-root</span><span class="token punctuation">:</span> /nacos  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>discovery<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> port<span class="token punctuation">-</span>forward<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nacos.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nacos          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /nacos</code></pre><hr><h1 id="二-配置ingress白名单访问"><a href="#二-配置ingress白名单访问" class="headerlink" title="二.配置ingress白名单访问"></a>二.配置ingress白名单访问</h1><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/whitelist-source-range</span><span class="token punctuation">:</span> 117.50.34.153  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> prometheus.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">9090</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix</code></pre><p>其他ip访问测试</p><pre class=" language-yaml"><code class="language-yaml">curl <span class="token punctuation">-</span>I prometheus.huhuhahei.cnHTTP/1.1 403 Forbidden<span class="token key atrule">Date</span><span class="token punctuation">:</span> Fri<span class="token punctuation">,</span> 04 Mar 2022 03<span class="token punctuation">:</span>08<span class="token punctuation">:</span>38 GMT<span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> text/html<span class="token key atrule">Content-Length</span><span class="token punctuation">:</span> <span class="token number">146</span><span class="token key atrule">Connection</span><span class="token punctuation">:</span> keep<span class="token punctuation">-</span>alive</code></pre><p>白名单访问测试</p><pre class=" language-bash"><code class="language-bash">curl -I prometheus.huhuhahei.cnHTTP/1.1 405 Method Not AllowedDate: Fri, 04 Mar 2022 03:10:19 GMTContent-Type: text/plain<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf-8Content-Length: 19Connection: keep-aliveAllow: GET, OPTIONSX-Content-Type-Options: nosniff</code></pre><hr><h1 id="三-配置登录验证"><a href="#三-配置登录验证" class="headerlink" title="三. 配置登录验证"></a>三. 配置登录验证</h1><p>首先需要创建密码文件</p><pre class=" language-bash"><code class="language-bash">htpasswd -c auth adminNew password: Re-type new password: Adding password <span class="token keyword">for</span> user admin</code></pre><p>创建secret</p><pre class=" language-bash"><code class="language-bash">kubectl create secret generic  kibana-auth --from-file<span class="token operator">=</span>auth -n logssecret/kibana-auth created</code></pre><p>配置ingress</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-realm</span><span class="token punctuation">:</span> Need to longin    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-secret</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>auth    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-type</span><span class="token punctuation">:</span> basic  <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> kibana.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kibana          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">5601</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /</code></pre><p>登录测试</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/1537476990.png"></p><hr><h1 id="四-配置域名重定向"><a href="#四-配置域名重定向" class="headerlink" title="四.配置域名重定向"></a>四.配置域名重定向</h1><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/permanent-redirect</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.huhuhahei.cn  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> web.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kibana          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">5601</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /</code></pre><p>测试</p><pre class=" language-bash"><code class="language-bash">curl -I web.huhuhahei.cnHTTP/1.1 301 Moved PermanentlyDate: Fri, 04 Mar 2022 03:30:07 GMTContent-Type: text/htmlContent-Length: 162Connection: keep-aliveLocation: https://www.huhuhahei.cn</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ingress-nginx配置 https访问</title>
      <link href="/f619b970/"/>
      <url>/f619b970/</url>
      
        <content type="html"><![CDATA[<h1 id="一、配置证书"><a href="#一、配置证书" class="headerlink" title="一、配置证书"></a>一、配置证书</h1><h3 id="1-1-创建证书secret"><a href="#1-1-创建证书secret" class="headerlink" title="1.1 创建证书secret"></a>1.1 创建证书secret</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster TSL<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create secret  tls huhuhahei  --key=private.key --cert=public.pem  -n  lnmp</span>secret/huhuhahei created</code></pre><h1 id="二-、配置Ingress"><a href="#二-、配置Ingress" class="headerlink" title="二 、配置Ingress"></a>二 、配置Ingress</h1><h3 id="2-1-创建ingress"><a href="#2-1-创建ingress" class="headerlink" title="2.1  创建ingress"></a>2.1  创建ingress</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">tls</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> web.huhuhahei.cn    <span class="token punctuation">-</span> <span class="token key atrule">secretName</span><span class="token punctuation">:</span> huhuhahei  <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> web.huhuhahei.cn      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">paths</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /          <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix          <span class="token key atrule">backend</span><span class="token punctuation">:</span>            <span class="token key atrule">service</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php              <span class="token key atrule">port</span><span class="token punctuation">:</span>                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><h1 id="三-、测试"><a href="#三-、测试" class="headerlink" title="三 、测试"></a>三 、测试</h1><h3 id="3-1浏览器查看证书"><a href="#3-1浏览器查看证书" class="headerlink" title="3.1浏览器查看证书"></a>3.1浏览器查看证书</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/207112106.png"></p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker清理无用镜像及卷组占用的空间</title>
      <link href="/2d895da1/"/>
      <url>/2d895da1/</url>
      
        <content type="html"><![CDATA[<p>生产过程中，总是会遇到服务器磁盘被docker占满的情况<br>比如这样<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/479329848.jpg"><br>也就跑了几个容器，莫名其妙磁盘就没了::(泪)<br>于是上网找方案</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system df </span>TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLEImages          46        46        14.44GB   435MB <span class="token punctuation">(</span>3%<span class="token punctuation">)</span>Containers      121       108       1.359GB   3.478kB <span class="token punctuation">(</span>0%<span class="token punctuation">)</span>Local Volumes   32        2         5.273GB   5.273GB <span class="token punctuation">(</span>100%<span class="token punctuation">)</span></code></pre><p>这个命令可以查看目前我们可以清理的docker缓存，分别为镜像，容器，数据卷</p><p>可以执行下面的命令清理</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system prune -a</span>WARNING<span class="token operator">!</span> This will remove:  - all stopped containers  - all networks not used by at least one container  - all dangling images  - all dangling build cacheAre you sure you want to continue? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span> y</code></pre><p>-a 参数清理的更加彻底 可以将没有容器使用Docker镜像都删掉。注意，这两个命令会把你暂时关闭的容器，以及暂时没有用到的Docker镜像都删掉了……所以使用之前一定要想清楚吶。</p><p>清理后发现空间并没有减少 仔细查看发现是32磁盘 但是只有2个再用 在执行这个命令看看</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker volume ls -qf dangling=true</span>0d322472e941707dc9cdf72ae21647ace2e866d061781c1b3102f026454ff1bb0fd37de5d1b7e9a7b047ef7564dc2f7cff9a430e091afaf8b3bce80d967160795cf16842c76f2b5ac32a37bb4cff4b1b691a1323b59db01adcf0569966746d919cb673514123500c7f6f0c0c777d99813c6489832638c261bfaffb9cea01c30f23e3eb4e2c4ce36b484278c882a4ff77b8b73a0afcb42f9d4fb4bbd9da04b30551a3a18fe7339d97627c894d636a07503244f15f05a945f8ba0e326e53bac4fd61bc3ad6461da6f126e6191509e7964a34c8b9514a2c488462e9b2a465ddd54189c4921a2c858db86534e0924f5f64786dfcb193b95d98bb468eb2b4e401443c146ee0f6e0a42cdfa112a69780637f6a28120fdd56d129e3f697c68a01e6791b176b4fa0c65897c355aafff690bf7a97b419ecf9877b1d518b8574cf86b88971517bd77537b86937ec43778a171b027ed3200f9ba4405740343dc748a366103b540c32012f161afee2abab0ea62f9621612c99392d51bbb266c4e8953f8e3302976d1335e32ea78551c0b8ebf96cd626d5cdae78379a4e3b685672ff30911628····</code></pre><p>可以看到有很多没有挂载的磁盘</p><p>可以使用这个命令清理</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker volume rm $(docker volume ls -qf dangling=true)</span>0d322472e941707dc9cdf72ae21647ace2e866d061781c1b3102f026454ff1bb0fd37de5d1b7e9a7b047ef7564dc2f7cff9a430e091afaf8b3bce80d967160795cf16842c76f2b5ac32a37bb4cff4b1b691a1323b59db01adcf0569966746d919cb673514123500c7f6f0c0c777d99813c6489832638c261bfaffb9cea01c30f23e3eb4e2c4ce36b484278c882a4ff77b8b73a0afcb42f9d4fb4bbd9da04b30551a3a18fe7339d97627c894d636a07503244f15f05a945f8ba0e326e53bac4fd61bc3ad6461da6f126e6191509e7964a34c8b9514a2c488462e9b2a465ddd541</code></pre><p>清理完成再次查看</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system df </span>TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLEImages          46        46        14.44GB   435MB <span class="token punctuation">(</span>3%<span class="token punctuation">)</span>Containers      121       108       1.359GB   3.478kB <span class="token punctuation">(</span>0%<span class="token punctuation">)</span>Local Volumes   2         2         0B        0BBuild Cache     0         0         0B        0B</code></pre><p>当然也可以手动清理无tag的镜像</p><pre class=" language-bash"><code class="language-bash">docker rmi <span class="token punctuation">$(</span>docker images <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"^&lt;none>"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">"&amp;#123;print <span class="token variable">$3</span>&amp;#125;"</span><span class="token punctuation">)</span></code></pre><p>手动清理关闭的容器</p><pre class=" language-bash"><code class="language-bash">docker <span class="token function">ps</span> -a <span class="token operator">|</span> <span class="token function">grep</span> Exit <span class="token operator">|</span> <span class="token function">cut</span> -d <span class="token string">' '</span> -f 1 <span class="token operator">|</span> <span class="token function">xargs</span> docker <span class="token function">rm</span></code></pre><p>空间已经下来了 ::(酷)</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>卡死导致K8sNode节点NotReady</title>
      <link href="/undefined/"/>
      <url>/undefined/</url>
      
        <content type="html"><![CDATA[<p>某天发现测试环境节点忽然变为NotRead 导致服务异常:@(内伤)<br>现象是这样的<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/4059467715.png"><br>describe查看是这样的<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/3548693712.png"><br>初步感觉是节点有问题了 一般出现节点NotReady无非是 节点CPU 内存 磁盘 和网络出问题了<br>结果这样一排查 发现都没问题:@(喷血)<br>下面只能看下kubelet和docker的状态和日志<br>kubelet</p><pre class=" language-bash"><code class="language-bash">systemctl status kubelet● kubelet.service - Kubernetes KubeletLoaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/kubelet.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2022-02-14 11:04:52 CST<span class="token punctuation">;</span> 3min 28s agoDocs: https://github.com/GoogleCloudPlatform/kubernetesProcess: 24722 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/systemd/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24719 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/pids/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24716 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/memory/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24713 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/hugetlb/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24710 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/cpuset/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24707 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/cpuacct/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span></code></pre><p>docker</p><pre class=" language-bash"><code class="language-bash">systemctl status docker● docker.service - Docker Application Container EngineLoaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/docker.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2022-02-14 11:04:42 CST<span class="token punctuation">;</span> 6s agoDocs: http://docs.docker.ioProcess: 24482 ExecStartPost<span class="token operator">=</span>/sbin/iptables -I FORWARD -s 0.0.0.0/0 -j ACCEPT <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Main PID: 24480 <span class="token punctuation">(</span>dockerd<span class="token punctuation">)</span>Tasks: 123Memory: 946.6MCGroup: /system.slice/docker.service</code></pre><p>两个状态都是running状态 只能看下日志信息了<br>查看kubelet日志信息<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/1507988096.png"></p><p>可以看到kubelet连接docker有问题 一直在重启</p><p>只能在看下docker日志信息了</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/3767755695.png"><br>看这个报错在网上搜索没什么发现 于是我好奇docker ps了下 发现一直卡死没有输出<br>这就很奇怪 docker服务正常 不应该没有输出呀 于是又是一番百度找到一个类似的<br><a href="https://www.bianchengquan.com/article/155669.html">https://www.bianchengquan.com/article/155669.html</a><br>发现应该是docker版本过低触发的版本不兼容 临时先kill掉runc进程后重启kubelet和docker就恢复了 后面还是要时常关注服务的版本</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NACOS部署</title>
      <link href="/c2586a0/"/>
      <url>/c2586a0/</url>
      
        <content type="html"><![CDATA[<h1 id="一-前言"><a href="#一-前言" class="headerlink" title="一.前言"></a>一.前言</h1><h3 id="1-1简介"><a href="#1-1简介" class="headerlink" title="1.1简介"></a>1.1简介</h3><p><a href="https://so.csdn.net/so/search?q=Nacos">Nacos</a>是阿里巴巴开源的一款支持服务注册与发现，配置管理以及微服务管理的组件。用来取代以前常用的注册中心（zookeeper , eureka等等），以及配置中心（spring cloud config等等）。Nacos是集成了注册中心和配置中心的功能，做到了二合一。</p><h1 id="二-Nacos部署"><a href="#二-Nacos部署" class="headerlink" title="二.Nacos部署"></a>二.Nacos部署</h1><h3 id="2-1-创建数据库用户并初始化配置"><a href="#2-1-创建数据库用户并初始化配置" class="headerlink" title="2.1 创建数据库用户并初始化配置"></a>2.1 创建数据库用户并初始化配置</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> nacos <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span><span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> nacos<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> nacos@'<span class="token operator">%</span><span class="token string">' identified by '</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>' <span class="token keyword">with</span> <span class="token keyword">grant</span> <span class="token keyword">option</span><span class="token punctuation">;</span>flush privilages<span class="token punctuation">;</span></code></pre><p>导入nacos初始化sql</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* * Copyright 1999-2018 Alibaba Group Holding Ltd. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * *      http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_use<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>effect<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_schema<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfo_datagrouptenant<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info_aggr   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_aggr<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'datum_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'内容'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfoaggr_datagrouptenantdatum<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'增加租户字段'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info_beta   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_beta<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>beta_ips<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'betaIps'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfobeta_datagrouptenant<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_beta'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_info_tag   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_tag<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfotag_datagrouptenanttag<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_tag'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = config_tags_relation   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_tags_relation<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_type'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>nid<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>nid<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configtagrelation_configidtag<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_tag_relation'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = group_capacity   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>group_capacity<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Group ID，空字符表示整个集群'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>quota<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'配额，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">usage</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'聚合子配置最大个数，，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大变更历史数量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_group_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'集群、各Group容量信息表'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = his_config_info   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>his_config_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>nid<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>op_type<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'租户字段'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>nid<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_gmt_create<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_gmt_modified<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_did<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'多租户改造'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   数据库全名 = nacos_config   */</span><span class="token comment" spellcheck="true">/*   表名称 = tenant_capacity   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tenant_capacity<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'主键ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Tenant ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>quota<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'配额，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">usage</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'使用量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'聚合子配置最大个数'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'最大变更历史数量'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'租户容量信息表'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tenant_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>kp<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'kp'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_desc'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>create_source<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'create_source'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_tenant_info_kptenantid<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>kp<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'tenant_info'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>enabled<span class="token punctuation">`</span> <span class="token keyword">boolean</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>roles<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>idx_user_role<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">ASC</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>permissions<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>resource<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>uk_role_permission<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>role<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>resource<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu'</span><span class="token punctuation">,</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> roles <span class="token punctuation">(</span>username<span class="token punctuation">,</span> role<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'ROLE_ADMIN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="2-2-创建存储"><a href="#2-2-创建存储" class="headerlink" title="2.2 创建存储"></a>2.2 创建存储</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token comment" spellcheck="true"># 此处供应者名字供storageclass调用</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.46.8.18   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/nacos_data  <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18   <span class="token comment" spellcheck="true"># 填入NFS的地址</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/nacos_data   <span class="token comment" spellcheck="true"># 填入NFS服务器挂载的目录</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>nacos<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos<span class="token comment" spellcheck="true"># Supported policies: Delete、 Retain ， default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><h3 id="2-3-创建mysql配置文件"><a href="#2-3-创建mysql配置文件" class="headerlink" title="2.3 创建mysql配置文件"></a>2.3 创建mysql配置文件</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">mysql.db.name</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">mysql.host</span><span class="token punctuation">:</span> mysql.blog.svc.cluster.local  <span class="token key atrule">mysql.password</span><span class="token punctuation">:</span> *******  <span class="token key atrule">mysql.port</span><span class="token punctuation">:</span> <span class="token string">"3306"</span>  <span class="token key atrule">mysql.user</span><span class="token punctuation">:</span> nacos<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm</code></pre><h3 id="2-4-创建sts控制器"><a href="#2-4-创建sts控制器" class="headerlink" title="2.4 创建sts控制器"></a>2.4 创建sts控制器</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> OrderedReady  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                <span class="token key atrule">values</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> nacos            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_REPLICAS          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"3"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SERVICE_NAME          <span class="token key atrule">value</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOMAIN_NAME          <span class="token key atrule">value</span><span class="token punctuation">:</span> cluster.local        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>              <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_DB_NAME          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.db.name              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_HOST          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.host              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PORT          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.port              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_USER          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.user              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PASSWORD          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.password              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_SERVER_PORT          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"8848"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_APPLICATION_PORT          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"8848"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PREFER_HOST_MODE          <span class="token key atrule">value</span><span class="token punctuation">:</span> hostname        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMS          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMX          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMN          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>server<span class="token punctuation">:</span>2.0.1        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>port          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512m        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/plugins/peer<span class="token punctuation">-</span>finder          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/data          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> data        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/logs          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logs      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>finder<span class="token punctuation">-</span>plugin<span class="token punctuation">:</span><span class="token number">1.1</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">name</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder<span class="token punctuation">-</span>plugin<span class="token punctuation">-</span>install        <span class="token key atrule">resources</span><span class="token punctuation">:</span> &amp;<span class="token comment" spellcheck="true">#123;&amp;#125;</span>        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/plugins/peer<span class="token punctuation">-</span>finder          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1    <span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> data    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ReadWriteOnce      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 50Gi      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>storageclass      <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem</code></pre><h3 id="2-5-创建svc"><a href="#2-5-创建svc" class="headerlink" title="2.5 创建svc"></a>2.5 创建svc</h3><p>nacos_headless.svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">service.alpha.kubernetes.io/tolerate-unready-endpoints</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> server    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</code></pre><p>nacos_svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>service<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span><span class="token number">8</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span><span class="token number">9</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><p>部署完成即可web访问</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/2162338859.png"></p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源项目 </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
