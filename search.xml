<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title></title>
      <link href="/0/"/>
      <url>/0/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ç”±äºé¡¹ç›®åœ¨æ³¨å†Œã€ç™»å½•ã€æ‰¾å›å¯†ç  æ—¶éœ€è¦å‘é€çŸ­ä¿¡éªŒè¯çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬ä½¿ç”¨è…¾è®¯äº‘çŸ­ä¿¡åšã€‚</p><p>æ‰€ä»¥éœ€è¦å‡†å¤‡è…¾è®¯äº‘è´¦å·å’Œsmséœ€è¦çš„ç­¾åå·²ç»æ¨¡æ¿,è¿™ä¹ˆå°±ä¸åœ¨äº¤ä»£,å¯ä»¥è‡ªå·±å»ç”³è¯·</p><h3 id="é…ç½®è…¾è®¯äº‘sdk"><a href="#é…ç½®è…¾è®¯äº‘sdk" class="headerlink" title="é…ç½®è…¾è®¯äº‘sdk"></a>é…ç½®è…¾è®¯äº‘sdk</h3><h5 id="å®‰è£…sdk"><a href="#å®‰è£…sdk" class="headerlink" title="å®‰è£…sdk"></a>å®‰è£…sdk</h5><pre class=" language-bash"><code class="language-bash">pip3 <span class="token function">install</span> qcloudsms_py</code></pre><h5 id="åˆ›å»ºå‘é€çŸ­ä¿¡æ–‡ä»¶"><a href="#åˆ›å»ºå‘é€çŸ­ä¿¡æ–‡ä»¶" class="headerlink" title="åˆ›å»ºå‘é€çŸ­ä¿¡æ–‡ä»¶"></a>åˆ›å»ºå‘é€çŸ­ä¿¡æ–‡ä»¶</h5><p>åˆ›å»ºutils&#x2F;tencentæ–‡ä»¶å¤¹ åœ¨ä¸‹é¢åˆ›å»ºsms.qc</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span><span class="token keyword">import</span> ssl<span class="token comment" spellcheck="true"># ssl._create_default_https_context = ssl._create_unverified_context</span><span class="token keyword">from</span> qcloudsms_py <span class="token keyword">import</span> SmsMultiSender<span class="token punctuation">,</span> SmsSingleSender<span class="token keyword">from</span> qcloudsms_py<span class="token punctuation">.</span>httpclient <span class="token keyword">import</span> HTTPError<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings<span class="token keyword">def</span> <span class="token function">send_sms_single</span><span class="token punctuation">(</span>phone_num<span class="token punctuation">,</span> template_id<span class="token punctuation">,</span> template_param_list<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    å•æ¡å‘é€çŸ­ä¿¡    :param phone_num: æ‰‹æœºå·    :param template_id: è…¾è®¯äº‘çŸ­ä¿¡æ¨¡æ¿ID    :param template_param_list: çŸ­ä¿¡æ¨¡æ¿æ‰€éœ€å‚æ•°åˆ—è¡¨ï¼Œä¾‹å¦‚:ã€éªŒè¯ç ï¼š{1}ï¼Œæè¿°ï¼š{2}ã€‘ï¼Œåˆ™ä¼ é€’å‚æ•° [888,666]æŒ‰é¡ºåºå»æ ¼å¼åŒ–æ¨¡æ¿    :return:    """</span>    appid <span class="token operator">=</span> settings<span class="token punctuation">.</span>SMS_APPID    appkey <span class="token operator">=</span> settings<span class="token punctuation">.</span>SMS_APPKEY    sms_sign <span class="token operator">=</span> settings<span class="token punctuation">.</span>SMS_SIGN  <span class="token comment" spellcheck="true"># è‡ªå·±è…¾è®¯äº‘åˆ›å»ºç­¾åæ—¶å¡«å†™çš„ç­¾åå†…å®¹ï¼ˆä½¿ç”¨å…¬ä¼—å·çš„è¯è¿™ä¸ªå€¼ä¸€èˆ¬æ˜¯å…¬ä¼—å·å…¨ç§°æˆ–ç®€ç§°ï¼‰</span>    sender <span class="token operator">=</span> SmsSingleSender<span class="token punctuation">(</span>appid<span class="token punctuation">,</span> appkey<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        response <span class="token operator">=</span> sender<span class="token punctuation">.</span>send_with_param<span class="token punctuation">(</span><span class="token number">86</span><span class="token punctuation">,</span> phone_num<span class="token punctuation">,</span> template_id<span class="token punctuation">,</span> template_param_list<span class="token punctuation">,</span> sign<span class="token operator">=</span>sms_sign<span class="token punctuation">)</span>    <span class="token keyword">except</span> HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span>        response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">'errmsg'</span><span class="token punctuation">:</span> <span class="token string">"ç½‘ç»œå¼‚å¸¸å‘é€å¤±è´¥"</span><span class="token punctuation">}</span>    <span class="token keyword">return</span> response<span class="token keyword">def</span> <span class="token function">send_sms_multi</span><span class="token punctuation">(</span>phone_num_list<span class="token punctuation">,</span> template_id<span class="token punctuation">,</span> param_list<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    æ‰¹é‡å‘é€çŸ­ä¿¡    :param phone_num_list:æ‰‹æœºå·åˆ—è¡¨    :param template_id:è…¾è®¯äº‘çŸ­ä¿¡æ¨¡æ¿ID    :param param_list:çŸ­ä¿¡æ¨¡æ¿æ‰€éœ€å‚æ•°åˆ—è¡¨ï¼Œä¾‹å¦‚:ã€éªŒè¯ç ï¼š{1}ï¼Œæè¿°ï¼š{2}ã€‘ï¼Œåˆ™ä¼ é€’å‚æ•° [888,666]æŒ‰é¡ºåºå»æ ¼å¼åŒ–æ¨¡æ¿    :return:    """</span>    appid <span class="token operator">=</span> settings<span class="token punctuation">.</span>SMS_APPID    appkey <span class="token operator">=</span> settings<span class="token punctuation">.</span>SMS_APPKEY    sms_sign <span class="token operator">=</span> settings<span class="token punctuation">.</span>SMS_SIGN  <span class="token comment" spellcheck="true"># è‡ªå·±è…¾è®¯äº‘åˆ›å»ºç­¾åæ—¶å¡«å†™çš„ç­¾åå†…å®¹ï¼ˆä½¿ç”¨å…¬ä¼—å·çš„è¯è¿™ä¸ªå€¼ä¸€èˆ¬æ˜¯å…¬ä¼—å·å…¨ç§°æˆ–ç®€ç§°ï¼‰</span>    sender <span class="token operator">=</span> SmsMultiSender<span class="token punctuation">(</span>appid<span class="token punctuation">,</span> appkey<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        response <span class="token operator">=</span> sender<span class="token punctuation">.</span>send_with_param<span class="token punctuation">(</span><span class="token number">86</span><span class="token punctuation">,</span> phone_num_list<span class="token punctuation">,</span> template_id<span class="token punctuation">,</span> param_list<span class="token punctuation">,</span> sign<span class="token operator">=</span>sms_sign<span class="token punctuation">)</span>    <span class="token keyword">except</span> HTTPError <span class="token keyword">as</span> e<span class="token punctuation">:</span>        response <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'result'</span><span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">'errmsg'</span><span class="token punctuation">:</span> <span class="token string">"ç½‘ç»œå¼‚å¸¸å‘é€å¤±è´¥"</span><span class="token punctuation">}</span>    <span class="token keyword">return</span> response</code></pre><blockquote><p>è¿™é‡Œéœ€è¦ä¸‰ä¸ªå‚æ•°æˆ‘è¿™é‡Œæ˜¯é€šè¿‡åœ¨settingä¸­é…ç½®ç„¶åå¼•ç”¨çš„</p></blockquote><p>settingé…ç½®å¦‚ä¸‹</p><pre class=" language-python"><code class="language-python">SMS_APPID <span class="token operator">=</span> <span class="token string">'6666'</span>SMS_APPKEY <span class="token operator">=</span> <span class="token string">'66666666666'</span>SMS_SIGN <span class="token operator">=</span> <span class="token string">'66666666'</span></code></pre><h5 id="åˆ›å»ºå‘é€çŸ­ä¿¡å‡½æ•°"><a href="#åˆ›å»ºå‘é€çŸ­ä¿¡å‡½æ•°" class="headerlink" title="åˆ›å»ºå‘é€çŸ­ä¿¡å‡½æ•°"></a>åˆ›å»ºå‘é€çŸ­ä¿¡å‡½æ•°</h5><p>viewsæ–‡ä»¶ä¿®æ”¹</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token keyword">import</span> random<span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span>  HttpResponse<span class="token keyword">from</span> utils<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>SMS <span class="token keyword">import</span> send_sms_single<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>validators <span class="token keyword">import</span> RegexValidator<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> ValidationError<span class="token comment" spellcheck="true"># Create your views here.</span><span class="token keyword">def</span> <span class="token function">send_sms</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    code <span class="token operator">=</span> random<span class="token punctuation">.</span>randrange<span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">999999</span><span class="token punctuation">)</span>    res <span class="token operator">=</span> send_sms_single<span class="token punctuation">(</span><span class="token string">'1231231231'</span><span class="token punctuation">,</span> <span class="token number">1667932</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>code<span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">'æˆåŠŸ'</span><span class="token punctuation">)</span>  </code></pre><p>urlsæ·»åŠ è·¯ç”±</p><pre class=" language-python"><code class="language-python">path<span class="token punctuation">(</span><span class="token string">'app01/send/sms/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>send_sms<span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre><p>è®¿é—®å‘é€æˆåŠŸ<br><img src="http://kode.huhuhahei.cn/index.php?explorer/share/file&hash=79e33GWXPFg5mR9fOgKPwU1jCS0uVbEheTAFz6tbrI0kDCvTCjTpDhuKELmejFaM1iWV&name=/20230114-165541-b8.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Django è¯¦è§£</title>
      <link href="/792dad1e/"/>
      <url>/792dad1e/</url>
      
        <content type="html"><![CDATA[<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><blockquote><p>Django æœ€åˆè¢«è®¾è®¡ç”¨äºå…·æœ‰å¿«é€Ÿå¼€å‘éœ€æ±‚çš„æ–°é—»ç±»ç«™ç‚¹ï¼Œç›®çš„æ˜¯è¦å®ç°ç®€å•å¿«æ·çš„ç½‘ç«™å¼€å‘ã€‚</p></blockquote><h3 id="è®¾è®¡æ¨¡å‹"><a href="#è®¾è®¡æ¨¡å‹" class="headerlink" title="è®¾è®¡æ¨¡å‹"></a>è®¾è®¡æ¨¡å‹</h3><p>Django æ— éœ€æ•°æ®åº“å°±å¯ä»¥ä½¿ç”¨ï¼Œå®ƒæä¾›äº† å¯¹è±¡å…³ç³»æ˜ å°„å™¨ é€šè¿‡æ­¤æŠ€æœ¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ Python ä»£ç æ¥æè¿°æ•°æ®åº“ç»“æ„ã€‚</p><p>ä½ å¯ä»¥ä½¿ç”¨å¼ºå¤§çš„ æ•°æ®-æ¨¡å‹è¯­å¥ æ¥æè¿°ä½ çš„æ•°æ®æ¨¡å‹ï¼Œè¿™è§£å†³äº†æ•°å¹´ä»¥æ¥åœ¨æ•°æ®åº“æ¨¡å¼ä¸­çš„éš¾é¢˜ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€æ˜çš„ä¾‹å­ï¼š</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models<span class="token keyword">class</span> <span class="token class-name">Reporter</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    full_name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">70</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>full_name<span class="token keyword">class</span> <span class="token class-name">Article</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    pub_date <span class="token operator">=</span> models<span class="token punctuation">.</span>DateField<span class="token punctuation">(</span><span class="token punctuation">)</span>    headline <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">)</span>    content <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span><span class="token punctuation">)</span>    reporter <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>Reporter<span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>headline</code></pre><h3 id="Djangoå®‰è£…"><a href="#Djangoå®‰è£…" class="headerlink" title="Djangoå®‰è£…"></a>Djangoå®‰è£…</h3><p>ä½¿ç”¨pipå®‰è£…</p><pre class=" language-python"><code class="language-python">pip3 install django<span class="token operator">==</span><span class="token number">3.2</span></code></pre><h3 id="DjangoåŸºæœ¬ä½¿ç”¨"><a href="#DjangoåŸºæœ¬ä½¿ç”¨" class="headerlink" title="DjangoåŸºæœ¬ä½¿ç”¨"></a>DjangoåŸºæœ¬ä½¿ç”¨</h3><h5 id="åˆ›å»ºä¸€ä¸ªDjangoé¡¹ç›®"><a href="#åˆ›å»ºä¸€ä¸ªDjangoé¡¹ç›®" class="headerlink" title="åˆ›å»ºä¸€ä¸ªDjangoé¡¹ç›®"></a>åˆ›å»ºä¸€ä¸ªDjangoé¡¹ç›®</h5><pre class=" language-python"><code class="language-python">django<span class="token operator">-</span>admin startproject huhuhahei</code></pre><h5 id="å¯åŠ¨é¡¹ç›®"><a href="#å¯åŠ¨é¡¹ç›®" class="headerlink" title="å¯åŠ¨é¡¹ç›®"></a>å¯åŠ¨é¡¹ç›®</h5><pre class=" language-python"><code class="language-python">python3 manage<span class="token punctuation">.</span>py runserver You have <span class="token number">18</span> unapplied migration<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span> Your project may <span class="token operator">not</span> work properly until you apply the migrations <span class="token keyword">for</span> app<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span> admin<span class="token punctuation">,</span> auth<span class="token punctuation">,</span> contenttypes<span class="token punctuation">,</span> sessions<span class="token punctuation">.</span>Run <span class="token string">'python manage.py migrate'</span> to apply them<span class="token punctuation">.</span>January <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">2023</span> <span class="token operator">-</span> <span class="token number">05</span><span class="token punctuation">:</span><span class="token number">52</span><span class="token punctuation">:</span><span class="token number">11</span>Django version <span class="token number">3.2</span><span class="token punctuation">.</span><span class="token number">16</span><span class="token punctuation">,</span> using settings <span class="token string">'huhuhahei.settings'</span>Starting development server at http<span class="token punctuation">:</span><span class="token operator">//</span><span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>Quit the server <span class="token keyword">with</span> CONTROL<span class="token operator">-</span>C</code></pre><blockquote><p>å¦‚æœéœ€è¦ç›‘å¬0.0.0.0 å¯ä»¥åœ¨å¯åŠ¨çš„æ—¶å€™æŒ‡å®šç›‘å¬åœ°å€ 0.0.0.0:8080</p></blockquote><p><img src="http://kode.huhuhahei.cn/index.php?explorer/share/file&hash=d3d2JKzCVL8Mq5WGURcmdADONp-I8ZVYsFMefFrnh5pScLdTgrSM-HRaHpmXO_VeWxxy&name=/Xnip2023-01-14_13-57-55.jpg"></p><p>ç½‘é¡µè®¿é—®æ‰“å¼€è¿™æ ·å°±è¯æ˜å¯åŠ¨æˆåŠŸäº†</p><h5 id="é…ç½®åå°é¡µé¢"><a href="#é…ç½®åå°é¡µé¢" class="headerlink" title="é…ç½®åå°é¡µé¢"></a>é…ç½®åå°é¡µé¢</h5><p>è®¿é—®åå°é¡µé¢</p><p><img src="http://kode.huhuhahei.cn/index.php?explorer/share/file&hash=494btNX1AWstTqOt7rWvY_o38UO46XVxum39dwP2_cGoRPS5aQZA3TedExZmSQqfaevy&name=/20230114-140306-O8.png"><br>è®¿é—®æŠ¥é”™æ‰¾ä¸åˆ°è¡¨ è¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆåˆå§‹åŒ–ä¸‹æ•°æ®åº“</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#åˆå§‹åŒ–æ•°æ®åº“</span>python3 manage.py makemigrations No changes detected<span class="token comment" spellcheck="true">#åˆ›å»ºåº“è¡¨</span>python3 manage.py migrate Operations to perform:  Apply all migrations: admin, auth, contenttypes, sessionsRunning migrations:  Applying contenttypes.0001_initial<span class="token punctuation">..</span>. OK  Applying auth.0001_initial<span class="token punctuation">..</span>. OK  Applying admin.0001_initial<span class="token punctuation">..</span>. OK  Applying admin.0002_logentry_remove_auto_add<span class="token punctuation">..</span>. OK  Applying admin.0003_logentry_add_action_flag_choices<span class="token punctuation">..</span>. OK  Applying contenttypes.0002_remove_content_type_name<span class="token punctuation">..</span>. OK  Applying auth.0002_alter_permission_name_max_length<span class="token punctuation">..</span>. OK  Applying auth.0003_alter_user_email_max_length<span class="token punctuation">..</span>. OK  Applying auth.0004_alter_user_username_opts<span class="token punctuation">..</span>. OK  Applying auth.0005_alter_user_last_login_null<span class="token punctuation">..</span>. OK  Applying auth.0006_require_contenttypes_0002<span class="token punctuation">..</span>. OK  Applying auth.0007_alter_validators_add_error_messages<span class="token punctuation">..</span>. OK  Applying auth.0008_alter_user_username_max_length<span class="token punctuation">..</span>. OK  Applying auth.0009_alter_user_last_name_max_length<span class="token punctuation">..</span>. OK  Applying auth.0010_alter_group_name_max_length<span class="token punctuation">..</span>. OK  Applying auth.0011_update_proxy_permissions<span class="token punctuation">..</span>. OK  Applying auth.0012_alter_user_first_name_max_length<span class="token punctuation">..</span>. OK  Applying sessions.0001_initial<span class="token punctuation">..</span>. OK  <span class="token comment" spellcheck="true">#åˆ›å»ºadminç”¨æˆ·</span>python3 manage.py createsuperuserUsername <span class="token punctuation">(</span>leave blank to use <span class="token string">'root'</span><span class="token punctuation">)</span>: adminEmail address: adminError: Enter a valid email address.Email address: admin@^COperation cancelled.<span class="token punctuation">[</span>root@blog huhuhahei<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># python3 manage.py createsuperuser</span>Username <span class="token punctuation">(</span>leave blank to use <span class="token string">'root'</span><span class="token punctuation">)</span>: adminEmail address: admin@qq.comPassword: Password <span class="token punctuation">(</span>again<span class="token punctuation">)</span>: The password is too similar to the username.This password is too short. It must contain at least 8 characters.This password is too common.Bypass password validation and create user anyway? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: y</code></pre><p>å†æ¬¡è®¿é—®<br><img src="http://kode.huhuhahei.cn/index.php?explorer/share/file&hash=81bc3TekeDcIu9wTWsQt7LoOlchCnweJ--5MP5VDFFYF0eZ731TdoCYi2egBMZQESbyS&name=/20230114-140702-If.png"></p><h5 id="åˆ›å»ºä¸€ä¸ªåº”ç”¨"><a href="#åˆ›å»ºä¸€ä¸ªåº”ç”¨" class="headerlink" title="åˆ›å»ºä¸€ä¸ªåº”ç”¨"></a>åˆ›å»ºä¸€ä¸ªåº”ç”¨</h5><pre class=" language-python"><code class="language-python">python3 manage<span class="token punctuation">.</span>py startapp app01</code></pre><p>æŸ¥çœ‹æ–‡ä»¶ç»“æ„</p><pre class=" language-bash"><code class="language-bash">tree<span class="token keyword">.</span>â”œâ”€â”€ app01â”‚   â”œâ”€â”€ admin.pyâ”‚   â”œâ”€â”€ apps.pyâ”‚   â”œâ”€â”€ __init__.pyâ”‚   â”œâ”€â”€ migrationsâ”‚   â”‚   â””â”€â”€ __init__.pyâ”‚   â”œâ”€â”€ models.pyâ”‚   â”œâ”€â”€ tests.pyâ”‚   â””â”€â”€ views.pyâ”œâ”€â”€ db.sqlite3â”œâ”€â”€ huhuhaheiâ”‚   â”œâ”€â”€ asgi.pyâ”‚   â”œâ”€â”€ __init__.pyâ”‚   â”œâ”€â”€ __pycache__â”‚   â”‚   â”œâ”€â”€ __init__.cpython-36.pycâ”‚   â”‚   â”œâ”€â”€ settings.cpython-36.pycâ”‚   â”‚   â”œâ”€â”€ urls.cpython-36.pycâ”‚   â”‚   â””â”€â”€ wsgi.cpython-36.pycâ”‚   â”œâ”€â”€ settings.pyâ”‚   â”œâ”€â”€ urls.pyâ”‚   â””â”€â”€ wsgi.pyâ””â”€â”€ manage.py</code></pre><p>settingæ–‡ä»¶æ³¨å†Œåº”ç”¨</p><pre class=" language-python"><code class="language-python">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token string">'app01'</span><span class="token punctuation">,</span><span class="token punctuation">]</span></code></pre><p>åˆ›å»ºä¸€ä¸ªè§†å›¾çš„å‡½æ•°</p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>shortcuts <span class="token keyword">import</span> render<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> HttpResponse<span class="token comment" spellcheck="true"># Create your views here.</span><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"hello world"</span><span class="token punctuation">)</span></code></pre><p>é…ç½®urlè·¯ç”±ä¿®æ”¹urlsæ–‡ä»¶</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#æ·»åŠ </span><span class="token keyword">from</span> app01 <span class="token keyword">import</span> viewsurlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>    path<span class="token punctuation">(</span><span class="token string">'admin/'</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span>    path<span class="token punctuation">(</span><span class="token string">'app01/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span></code></pre><p>è®¿é—® <a href="http://106.14.172.136:8080/app01/">http://106.14.172.136:8080/app01/</a><br><img src="http://kode.huhuhahei.cn/index.php?explorer/share/file&hash=857cPmQeCnlsueRLY5Pq3BnX13rxuQkFswjsOauMVLxtQAI5FddS7aO__JAOLsP8-pfn&name=/20230114-142157-4U.png"></p><h5 id="é…ç½®æ¨¡å—"><a href="#é…ç½®æ¨¡å—" class="headerlink" title="é…ç½®æ¨¡å—"></a>é…ç½®æ¨¡å—</h5><p>modelsæ–‡ä»¶æ·»åŠ </p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models<span class="token comment" spellcheck="true"># Create your models here.</span><span class="token keyword">from</span> django<span class="token punctuation">.</span>db  <span class="token keyword">import</span> modelsPROJECT_TYPE <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"web"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">"å…¶ä»–"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">class</span> <span class="token class-name">Project</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>    project_name <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>verbose_name<span class="token operator">=</span><span class="token string">"é¡¹ç›®åç§°"</span><span class="token punctuation">)</span>    project_type <span class="token operator">=</span> models<span class="token punctuation">.</span>SmallIntegerField<span class="token punctuation">(</span>blank<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>choices<span class="token operator">=</span>PROJECT_TYPE<span class="token punctuation">,</span>verbose_name<span class="token operator">=</span><span class="token string">"é¡¹ç›®ç±»å‹"</span><span class="token punctuation">)</span>    project_version <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>verbose_name<span class="token operator">=</span><span class="token string">"é¡¹ç›®ç‰ˆæœ¬"</span><span class="token punctuation">)</span></code></pre><p>adminæ¨¡å—æ·»åŠ </p><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin<span class="token comment" spellcheck="true"># Register your models here.</span><span class="token keyword">from</span> app01<span class="token punctuation">.</span>models <span class="token keyword">import</span> Projectadmin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Project<span class="token punctuation">)</span></code></pre><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#åˆå§‹åŒ–æ•°æ®åº“</span>python3 manage<span class="token punctuation">.</span>py makemigrations <span class="token comment" spellcheck="true">#åˆ›å»ºåº“è¡¨</span>python3 manage<span class="token punctuation">.</span>py migrate </code></pre><p>è®¿é—®åå°é¡µé¢<br><a href="http://106.14.172.136:8080/admin/">http://106.14.172.136:8080/admin/</a></p><p><img src="http://kode.huhuhahei.cn/index.php?explorer/share/file&hash=f162izr6MytNw1jHWzkJdxOPgWmV94T-8iiIUpuEv4d_gknKANuITvspfAr0TmqNTWAZ&name=/20230114-143201-Cz.png"></p><p>ç‚¹å‡»å»å¯ä»¥æ­£å¸¸æ·»åŠ æˆ‘ä»¬éœ€è¦çš„æ–‡æœ¬<br><img src="http://kode.huhuhahei.cn/index.php?explorer/share/file&hash=264dKH00GrGHh-sMyJTELX8z9ZC5sQ3HKnqULmpI_5J8Od7tTxjIT8YpNbYGb13pWN9y&name=/20230114-143253-EC.png"></p><h5 id="Djangoä¼˜åŒ–"><a href="#Djangoä¼˜åŒ–" class="headerlink" title="Djangoä¼˜åŒ–"></a>Djangoä¼˜åŒ–</h5><h6 id="å…¨å±€ä¼˜åŒ–"><a href="#å…¨å±€ä¼˜åŒ–" class="headerlink" title="å…¨å±€ä¼˜åŒ–"></a>å…¨å±€ä¼˜åŒ–</h6><p>admin æ–‡ä»¶æ·»åŠ </p><pre class=" language-python"><code class="language-python">admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>site_header <span class="token operator">=</span> <span class="token string">"å¹³å°ç®¡ç†"</span>admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>site_title <span class="token operator">=</span> <span class="token string">"ç®¡ç†åå°"</span></code></pre><p><img src="http://kode.huhuhahei.cn/index.php?explorer/share/file&hash=3e3fLfehkNWbJLBCgTQQYRbwiCWH6yoS1kjS6NbQKZLnf2-Xqb8iDON9_nzqn9jjaTmM&name=/20230114-143518-MY.png"></p><h6 id="åˆ—è¡¨ä¼˜åŒ–"><a href="#åˆ—è¡¨ä¼˜åŒ–" class="headerlink" title="åˆ—è¡¨ä¼˜åŒ–"></a>åˆ—è¡¨ä¼˜åŒ–</h6><pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">ProjectAdmin</span><span class="token punctuation">(</span>admin<span class="token punctuation">.</span>ModelAdmin<span class="token punctuation">)</span><span class="token punctuation">:</span>    list_display <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">"project_name"</span><span class="token punctuation">,</span><span class="token string">"project_type"</span><span class="token punctuation">,</span><span class="token string">"project_version"</span><span class="token punctuation">)</span>admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>register<span class="token punctuation">(</span>Project<span class="token punctuation">,</span> ProjectAdmin<span class="token punctuation">)</span></code></pre><p><img src="http://kode.huhuhahei.cn/index.php?explorer/share/file&hash=dd64rxBvmVdPi8feZVdlGi93k9uodG56NStRhsSZN80i2g85kw_ZoJnWrmPPH3FuBbNV&name=/20230114-144004-fu.png"></p><h6 id="å¯¼èˆªæ ä¼˜åŒ–"><a href="#å¯¼èˆªæ ä¼˜åŒ–" class="headerlink" title="å¯¼èˆªæ ä¼˜åŒ–"></a>å¯¼èˆªæ ä¼˜åŒ–</h6><pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">HuhuhaheiConfig</span><span class="token punctuation">(</span>AppConfig<span class="token punctuation">)</span><span class="token punctuation">:</span>    default_auto_field <span class="token operator">=</span> <span class="token string">'django.db.models.BigAutoField'</span>    name <span class="token operator">=</span> <span class="token string">'app01'</span>    verbose_name <span class="token operator">=</span> <span class="token string">"æµ‹è¯•å¹³å°"</span></code></pre><p><img src="http://kode.huhuhahei.cn/index.php?explorer/share/file&hash=5f74hDB9uAcdT5d_dgS4CCcQNIBwJGHLUiuniPI5Z1FsAke0QFDMyzVzJi6LKLiWPhI4&name=/20230114-144235-2V.png"></p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> è‡ªåŠ¨åŒ–è¿ç»´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubeleté‡å¯å¤±è´¥åˆ†æ</title>
      <link href="/8dfa00de/"/>
      <url>/8dfa00de/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æŸå¤©ä¸Šåˆçœ‹åˆ°å‘Šè­¦å‘ç°æµ‹è¯•ç¯å¢ƒæœ‰ä¸ªèŠ‚ç‚¹<code>NotReady</code> é¦–å…ˆæ’æŸ¥æœåŠ¡å™¨çŠ¶æ€,cpu å†…å­˜ ç£ç›˜ ç½‘ç»œä¸€åˆ‡æ­£å¸¸.é‚£å°±æŠŠç›®å…‰æ”¾åˆ°<code>kubelet</code>å’Œ<code>docker</code>ä¸Šé¢</p><h3 id="æŸ¥çœ‹kubeletæ—¥å¿—"><a href="#æŸ¥çœ‹kubeletæ—¥å¿—" class="headerlink" title="æŸ¥çœ‹kubeletæ—¥å¿—"></a>æŸ¥çœ‹kubeletæ—¥å¿—</h3><p>å…ˆæŸ¥çœ‹kubeletçŠ¶æ€,å‘ç°æœåŠ¡å·²ç»æŒ‚äº†,é‚£ä¸»è¦ç›®æ ‡å°±æ˜¯ä»–äº†</p><pre class=" language-bash"><code class="language-bash"> systemctl status kubeletâ— kubelet.service - kubelet: The Kubernetes Node Agent   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/kubelet.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>  Drop-In: /usr/lib/systemd/system/kubelet.service.d           â””â”€10-kubeadm.conf   Active: activating <span class="token punctuation">(</span>auto-restart<span class="token punctuation">)</span> <span class="token punctuation">(</span>Result: exit-code<span class="token punctuation">)</span> since äº” 2023-01-06 10:32:34 CST<span class="token punctuation">;</span> 956ms ago     Docs: https://kubernetes.io/docs/  Process: 18204 ExecStart<span class="token operator">=</span>/usr/bin/kubelet <span class="token variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="token variable">$KUBELET_CONFIG_ARGS</span> <span class="token variable">$KUBELET_KUBEADM_ARGS</span> <span class="token variable">$KUBELET_EXTRA_ARGS</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>255<span class="token punctuation">)</span> Main PID: 18204 <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>255<span class="token punctuation">)</span></code></pre><p>å¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯åŠ¨å¤±è´¥çš„åŸå› </p><pre class=" language-bash"><code class="language-bash">journalctl -u kubelet -f <span class="token operator">|</span> <span class="token function">grep</span> E0106<span class="token comment" spellcheck="true">#å…¶ä¸­çœ‹åˆ°ä¸€æ¡è¿™æ ·çš„æ—¥å¿—</span>failed to run Kubelet: misconfiguration: kubelet cgroup driver: <span class="token string">"systemd"</span> is different from docker cgroup driver: <span class="token string">"cgroupfs"</span></code></pre><p>åˆ†æåå‘ç°ï¼Œæ˜¯å› ä¸º<code>kebernetes</code>é»˜è®¤è®¾ç½®<code>cgroup</code>é©±åŠ¨ä¸º<code>systemd</code>ï¼Œè€Œ<code>docker</code>æœåŠ¡çš„<code>cgroup</code>é©±åŠ¨ä¸º<code>cgroupfs</code>ï¼Œæœ‰ä¸¤ç§å†³è§£å†³æ–¹å¼ï¼Œæ–¹å¼ä¸€ï¼Œå°†<code>docker</code>çš„æœåŠ¡é…ç½®æ–‡ä»¶ä¿®æ”¹ä¸ºä½•<code>kubernetes</code>çš„ç›¸åŒï¼Œæ–¹å¼äºŒæ˜¯ä¿®æ”¹<code>kebernetes</code>çš„é…ç½®æ–‡ä»¶ä¸º<code>cgroupfs</code></p><p>è¿™æ¬¡é‡‡ç”¨ç¬¬ä¸€ç§,ä¿®æ”¹<code>docker</code>çš„<code>cgroup</code></p><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> /etc/docker/daemon.json <span class="token punctuation">{</span><span class="token string">"exec-opts"</span><span class="token keyword">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#é‡å¯æœåŠ¡</span>systemctl restart docker</code></pre><p>å†æ¬¡æŸ¥çœ‹æ—¥å¿—,å‘ç°æ²¡æœ‰ä¸Šé¢çš„æŠ¥é”™äº† ä½†æ˜¯æœ‰æ–°çš„æŠ¥é”™ ğŸ˜­</p><pre class=" language-bash"><code class="language-bash"> E0106 11:14:25.601363   21120 watcher.go:146<span class="token punctuation">]</span> Failed to <span class="token function">watch</span> directory <span class="token string">"/sys/fs/cgroup/pids/system.slice/containerd.service/kubepods-burstable-pod452d78e1_b236_4c8e_8874_a465705a42c3.slice"</span><span class="token keyword">:</span> inotify_add_watch /sys/fs/cgroup/pids/system.slice/containerd.service/kubepods-burstable-pod452d78e1_b236_4c8e_8874_a465705a42c3.slice: no space left on device</code></pre><p>ä¸Šç½‘æŸ¥è¯¢å‘ç°,åº”è¯¥æ˜¯cgroupå æ»¡äº† å¯ä»¥é€šè¿‡ä¿®æ”¹å†…æ ¸å‚æ•°ç”Ÿæ•ˆ</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æŸ¥çœ‹ç›®å‰é…ç½®</span><span class="token function">cat</span> /proc/sys/fs/inotify/max_user_watches 8192<span class="token comment" spellcheck="true">#å°†æœ€å¤§é™åˆ¶è°ƒæ•´ä¸º1048576</span><span class="token function">sudo</span> sysctl fs.inotify.max_user_watches<span class="token operator">=</span>1048576</code></pre><p>å†æ¬¡é‡å¯<code>kubelet</code>å‘ç°ç»ˆäºå˜æˆå¥½äº†ğŸ˜Š</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql max_execution_timeå‚æ•°è¯¦è§£</title>
      <link href="/cb90a2db/"/>
      <url>/cb90a2db/</url>
      
        <content type="html"><![CDATA[<h3 id="ä¸€-å‚æ•°è§£é‡Š"><a href="#ä¸€-å‚æ•°è§£é‡Š" class="headerlink" title="ä¸€ å‚æ•°è§£é‡Š"></a>ä¸€ å‚æ•°è§£é‡Š</h3><p>å‚æ•°<code>max_execution_time</code> ç”¨æ¥æ§åˆ¶selectè¯­å¥çš„æœ€å¤§æ‰§è¡Œæ—¶é—´,å•ä½æ˜¯æ¯«ç§’(ms),å¯ä»¥åŠ¨æ€ä¿®æ”¹,é»˜è®¤å‚æ•°ä¸º0,è¡¨ç¤ºä¸è®¾ç½®é™åˆ¶</p><h3 id="äºŒ-ä½¿ç”¨ç¤ºä¾‹"><a href="#äºŒ-ä½¿ç”¨ç¤ºä¾‹" class="headerlink" title="äºŒ ä½¿ç”¨ç¤ºä¾‹"></a>äºŒ ä½¿ç”¨ç¤ºä¾‹</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#æœªé…ç½®å‚æ•°çš„æ—¶å€™ç›´æ¥è®¿é—®å¯ä»¥æ­£å¸¸æŸ¥è¯¢ç»“æœ</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>student<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">|</span>  <span class="token number">9996</span> <span class="token operator">|</span> å¾å¯¼   <span class="token operator">|</span>   <span class="token number">20</span> <span class="token operator">|</span> ç”·   <span class="token operator">|</span> <span class="token number">2023</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">14</span>:<span class="token number">34</span>:<span class="token number">42</span> <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">9997</span> <span class="token operator">|</span> å¾å¯¼   <span class="token operator">|</span>   <span class="token number">20</span> <span class="token operator">|</span> ç”·   <span class="token operator">|</span> <span class="token number">2023</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">14</span>:<span class="token number">34</span>:<span class="token number">42</span> <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">9998</span> <span class="token operator">|</span> å¾å¯¼   <span class="token operator">|</span>   <span class="token number">20</span> <span class="token operator">|</span> ç”·   <span class="token operator">|</span> <span class="token number">2023</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">14</span>:<span class="token number">34</span>:<span class="token number">42</span> <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">9999</span> <span class="token operator">|</span> å¾å¯¼   <span class="token operator">|</span>   <span class="token number">20</span> <span class="token operator">|</span> ç”·   <span class="token operator">|</span> <span class="token number">2023</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">14</span>:<span class="token number">34</span>:<span class="token number">42</span> <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">10000</span> <span class="token operator">|</span> å¾å¯¼   <span class="token operator">|</span>   <span class="token number">20</span> <span class="token operator">|</span> ç”·   <span class="token operator">|</span> <span class="token number">2023</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">14</span>:<span class="token number">34</span>:<span class="token number">42</span> <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+--------+------+------+---------------------+-------+</span><span class="token number">10000</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#é…ç½®å‚æ•°å€¼ä¸º2ms</span><span class="token keyword">set</span> max_execution_time<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#å†æ¬¡æŸ¥è¯¢</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>student<span class="token punctuation">;</span>ERROR <span class="token number">3024</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: Query execution was interrupted<span class="token punctuation">,</span> maximum statement execution time exceeded</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxå®‰è£…Dotnet SDk</title>
      <link href="/d2ea5cad/"/>
      <url>/d2ea5cad/</url>
      
        <content type="html"><![CDATA[<h3 id="Linuxå®‰è£…Dotnet-SDk"><a href="#Linuxå®‰è£…Dotnet-SDk" class="headerlink" title="Linuxå®‰è£…Dotnet SDk"></a>Linuxå®‰è£…Dotnet SDk</h3><p>ä»¥dotnet5.0ä¸ºä¾‹<br>1.ä¸‹è½½linuxå†…æ ¸å¯¹åº”çš„dotnet5.0 sdkæ–‡ä»¶<br>è¿›å…¥<a href="https://dotnet.microsoft.com/en-us/download/dotnet/5.0">https://dotnet.microsoft.com/en-us/download/dotnet/5.0</a></p><p>ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„tagåŒ…</p><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> -O <span class="token string">'dotnet-sdk-5.0.408-linux-x64.tar.gz'</span> <span class="token string">'http://kode.huhuhahei.cn/index.php?explorer/share/file&amp;hash=ec5enTgpEc6Hn2ajB82SGuL7Uv6NQVCwM4eHYUvqXjIwY98QrKmEEI8V4jIz6p7Jk7Z5'</span></code></pre><p>è§£å‹</p><pre class=" language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p <span class="token variable">$HOME</span>/dotnet <span class="token operator">&amp;&amp;</span> <span class="token function">tar</span> zxf dotnet-sdk-5.0.408-linux-x64.tar.gz -C <span class="token variable">$HOME</span>/dotnet</code></pre><p>é…ç½®ä¼˜åŒ–</p><pre class=" language-bash"><code class="language-bash"><span class="token function">ln</span> -s /root/dotnet/dotnet /usr/sbin<span class="token function">cat</span> <span class="token operator">>></span> /etc/profile <span class="token operator">&lt;&lt;</span><span class="token string">EOFexport DOTNET_ROOT=<span class="token variable">$HOME</span>/dotnetPATH=<span class="token variable">$PATH</span>:<span class="token variable">$HOME</span>/dotnetEOF</span><span class="token function">source</span> /etc/profile</code></pre><h3 id="é…ç½®nugeté»˜è®¤æ‹‰å–è½¯ä»¶æº"><a href="#é…ç½®nugeté»˜è®¤æ‹‰å–è½¯ä»¶æº" class="headerlink" title="é…ç½®nugeté»˜è®¤æ‹‰å–è½¯ä»¶æº"></a>é…ç½®nugeté»˜è®¤æ‹‰å–è½¯ä»¶æº</h3><p>æŸ¥çœ‹é»˜è®¤çš„æº</p><pre class=" language-bash"><code class="language-bash">dotnet nuget list <span class="token function">source</span>Registered Sources:  1.  nuget.org <span class="token punctuation">[</span>Disabled<span class="token punctuation">]</span>      https://api.nuget.org/v3/index.json</code></pre><p>é»˜è®¤çš„æºæ˜¯å›½å¤–çš„æ‹‰å–é€Ÿåº¦æ¯”è¾ƒæ…¢</p><p>å»ºè®®ä¿®æ”¹ä¸ºå›½å†…</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å…³é—­å›½å¤–çš„æº</span>dotnet nuget disable <span class="token function">source</span> nuget.org<span class="token comment" spellcheck="true">#æ·»åŠ åä¸ºæº</span>dotnet nuget add <span class="token function">source</span> --name <span class="token string">"test"</span> https://mirrors.huaweicloud.com/repository/nuget/v3/index.json <span class="token comment" spellcheck="true">#å†æ¬¡æŸ¥çœ‹</span>dotnet nuget list <span class="token function">source</span>Registered Sources:  1.  nuget.org <span class="token punctuation">[</span>Disabled<span class="token punctuation">]</span>      https://api.nuget.org/v3/index.json  2.  <span class="token function">test</span> <span class="token punctuation">[</span>Enabled<span class="token punctuation">]</span>      https://mirrors.huaweicloud.com/repository/nuget/v3/index.json</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DevOps </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenKruiseè¯¦è§£</title>
      <link href="/235ecd58/"/>
      <url>/235ecd58/</url>
      
        <content type="html"><![CDATA[<h3 id="SidecarSet"><a href="#SidecarSet" class="headerlink" title="SidecarSet"></a>SidecarSet</h3><blockquote><p>è¿™ä¸ªæ§åˆ¶å™¨æ”¯æŒé€šè¿‡ admission webhook æ¥è‡ªåŠ¨ä¸ºé›†ç¾¤ä¸­åˆ›å»ºçš„ç¬¦åˆæ¡ä»¶çš„ Pod æ³¨å…¥ sidecar å®¹å™¨ã€‚ è¿™ä¸ªæ³¨å…¥è¿‡ç¨‹å’Œ istio çš„è‡ªåŠ¨æ³¨å…¥æ–¹å¼å¾ˆç±»ä¼¼ã€‚ é™¤äº†åœ¨ Pod åˆ›å»ºæ—¶å€™æ³¨å…¥å¤–ï¼ŒSidecarSet è¿˜æä¾›äº†ä¸ºè¿è¡Œæ—¶ Pod åŸåœ°å‡çº§å…¶ä¸­å·²ç»æ³¨å…¥çš„ sidecar å®¹å™¨é•œåƒçš„èƒ½åŠ›ã€‚<br>ç®€å•æ¥è¯´ï¼ŒSidecarSet å°† sidecar å®¹å™¨çš„å®šä¹‰å’Œç”Ÿå‘½å‘¨æœŸä¸ä¸šåŠ¡å®¹å™¨è§£è€¦ã€‚ å®ƒä¸»è¦ç”¨äºç®¡ç†æ— çŠ¶æ€çš„ sidecar å®¹å™¨ï¼Œæ¯”å¦‚ç›‘æ§ã€æ—¥å¿—ç­‰ agentã€‚</p></blockquote><p>èŒƒä¾‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps.kruise.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> SidecarSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>sidecarset<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> sleep    <span class="token punctuation">-</span> 999d    <span class="token key atrule">image</span><span class="token punctuation">:</span> centos<span class="token punctuation">:</span><span class="token number">6.7</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always    <span class="token key atrule">name</span><span class="token punctuation">:</span> tools    <span class="token key atrule">podInjectPolicy</span><span class="token punctuation">:</span> BeforeAppContainer    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token key atrule">limits</span><span class="token punctuation">:</span>        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 50m        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi      <span class="token key atrule">requests</span><span class="token punctuation">:</span>        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 50m        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi    <span class="token key atrule">shareVolumePolicy</span><span class="token punctuation">:</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> enabled    <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log    <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File    <span class="token key atrule">upgradeStrategy</span><span class="token punctuation">:</span>      <span class="token key atrule">upgradeType</span><span class="token punctuation">:</span> ColdUpgrade  <span class="token key atrule">injectionStrategy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app      <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">partition</span><span class="token punctuation">:</span> 0%    <span class="token key atrule">paused</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate</code></pre><ul><li>spec.selector é€šè¿‡labelçš„æ–¹å¼é€‰æ‹©éœ€è¦æ³¨å…¥ã€æ›´æ–°çš„podï¼Œæ”¯æŒmatchLabelsã€MatchExpressionsä¸¤ç§æ–¹å¼ï¼Œè¯¦æƒ…è¯·å‚è€ƒï¼š<a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/</a></li><li>spec.containers å®šä¹‰éœ€è¦æ³¨å…¥ã€æ›´æ–°çš„pod.spec.containerså®¹å™¨ï¼Œæ”¯æŒå®Œæ•´çš„k8s containerå­—æ®µï¼Œè¯¦æƒ…è¯·å‚è€ƒï¼š<a href="https://kubernetes.io/docs/concepts/containers/">https://kubernetes.io/docs/concepts/containers/</a></li><li>spec.initContainers å®šä¹‰éœ€è¦æ³¨å…¥çš„pod.spec.initContainerså®¹å™¨ï¼Œæ”¯æŒå®Œæ•´çš„k8s initContainerå­—æ®µï¼Œè¯¦æƒ…è¯·å‚è€ƒï¼š<a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/">https://kubernetes.io/docs/concepts/workloads/pods/init-containers/</a><ul><li>æ³¨å…¥initContainerså®¹å™¨é»˜è®¤åŸºäºcontainer nameå‡çº§æ’åº</li><li>initContainersåªæ”¯æŒæ³¨å…¥ï¼Œä¸æ”¯æŒpodåŸåœ°å‡çº§</li></ul></li><li>spec.updateStrategy sidecarSetæ›´æ–°ç­–ç•¥ï¼Œtypeè¡¨æ˜å‡çº§æ–¹å¼ï¼š<ul><li>NotUpdate ä¸æ›´æ–°ï¼Œæ­¤æ¨¡å¼ä¸‹åªä¼šåŒ…å«æ³¨å…¥èƒ½åŠ›</li><li>RollingUpdate æ³¨å…¥+æ»šåŠ¨æ›´æ–°ï¼ŒåŒ…å«äº†ä¸°å¯Œçš„æ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»</li></ul></li><li>spec.namespace sidecarseté»˜è®¤åœ¨k8sæ•´ä¸ªé›†ç¾¤èŒƒå›´å†…ç”Ÿæ•ˆï¼Œå³å¯¹æ‰€æœ‰çš„å‘½åç©ºé—´ç”Ÿæ•ˆï¼ˆé™¤äº†kube-system, kube-publicï¼‰ï¼Œå½“è®¾ç½®è¯¥å­—æ®µæ—¶ï¼Œåªå¯¹è¯¥namespaceçš„podç”Ÿæ•ˆ</li><li>podInjectPolicy å®šä¹‰containeræ³¨å…¥åˆ°pod.spec.containersä¸­çš„ä½ç½®<ul><li>BeforeAppContainer(é»˜è®¤) æ³¨å…¥åˆ°podåŸcontainersçš„å‰é¢</li><li>AfterAppContainer æ³¨å…¥åˆ°podåŸcontainersçš„åé¢</li></ul></li><li>æ•°æ®å·å…±äº«<ul><li>å…±äº«æŒ‡å®šå·ï¼šé€šè¿‡ spec.volumes æ¥å®šä¹‰ sidecar è‡ªèº«éœ€è¦çš„ volumeï¼Œè¯¦æƒ…è¯·å‚è€ƒï¼š<a href="https://kubernetes.io/docs/concepts/storage/volumes/">https://kubernetes.io/docs/concepts/storage/volumes/</a></li><li>å…±äº«æ‰€æœ‰å·ï¼šé€šè¿‡ spec.containers[i].shareVolumePolicy.type &#x3D; enabled | disabled æ¥æ§åˆ¶æ˜¯å¦æŒ‚è½½podåº”ç”¨å®¹å™¨çš„å·ï¼Œå¸¸ç”¨äºæ—¥å¿—æ”¶é›†ç­‰ sidecarï¼Œé…ç½®ä¸º enabled åä¼šæŠŠåº”ç”¨å®¹å™¨ä¸­æ‰€æœ‰æŒ‚è½½ç‚¹æ³¨å…¥ sidecar åŒä¸€è·¯ç»ä¸‹(sidecarä¸­æœ¬èº«å°±æœ‰å£°æ˜çš„æ•°æ®å·å’ŒæŒ‚è½½ç‚¹é™¤å¤–ï¼‰</li></ul></li><li>ç¯å¢ƒå˜é‡å…±äº«<br>å¯ä»¥é€šè¿‡ spec.containers[i].transferEnv æ¥ä»åˆ«çš„å®¹å™¨è·å–ç¯å¢ƒå˜é‡ï¼Œä¼šæŠŠåä¸º sourceContainerName å®¹å™¨ä¸­åä¸º envName çš„ç¯å¢ƒå˜é‡æ‹·è´åˆ°æœ¬å®¹å™¨</li></ul><p>åˆ›å»ºpodæµ‹è¯•æ³¨å…¥æ˜¯å¦ç”Ÿæ•ˆ</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx <span class="token comment" spellcheck="true"># matches the SidecarSet's selector</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.15.1</code></pre><p>ç¡®è®¤æ˜¯å¦æ³¨å…¥</p><pre class=" language-yaml"><code class="language-yaml">kubectl get po <span class="token punctuation">|</span> grep test<span class="token punctuation">-</span>podtest<span class="token punctuation">-</span>pod                  2/2     Running   0          82s</code></pre><h3 id="CloneSet"><a href="#CloneSet" class="headerlink" title="CloneSet"></a>CloneSet</h3><blockquote><p>CloneSet æ§åˆ¶å™¨æä¾›äº†é«˜æ•ˆç®¡ç†æ— çŠ¶æ€åº”ç”¨çš„èƒ½åŠ›ï¼Œå®ƒå¯ä»¥å¯¹æ ‡åŸç”Ÿçš„ Deploymentï¼Œä½† CloneSet æä¾›äº†å¾ˆå¤šå¢å¼ºåŠŸèƒ½ã€‚<br>æŒ‰ç…§ Kruise çš„å‘½åè§„èŒƒï¼ŒCloneSet æ˜¯ä¸€ä¸ªç›´æ¥ç®¡ç† Pod çš„ Set ç±»å‹ workloadã€‚</p></blockquote><p>ä¾‹å¦‚</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps.kruise.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> CloneSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> sample  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> sample<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">5</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> sample  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> sample    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine</code></pre><h4 id="æ‰©ç¼©å®¹åŠŸèƒ½"><a href="#æ‰©ç¼©å®¹åŠŸèƒ½" class="headerlink" title="æ‰©ç¼©å®¹åŠŸèƒ½"></a>æ‰©ç¼©å®¹åŠŸèƒ½</h4><h5 id="æ”¯æŒpvcæ¨¡æ¿"><a href="#æ”¯æŒpvcæ¨¡æ¿" class="headerlink" title="æ”¯æŒpvcæ¨¡æ¿"></a>æ”¯æŒpvcæ¨¡æ¿</h5><p><code>CloneSet</code> å…è®¸ç”¨æˆ·é…ç½® <code>PVC</code> æ¨¡æ¿ <code>volumeClaimTemplates</code>ï¼Œç”¨æ¥ç»™æ¯ä¸ª <code>Pod</code> ç”Ÿæˆç‹¬äº«çš„ <code>PVC</code>ï¼Œè¿™æ˜¯ <code>Deployment</code> æ‰€ä¸æ”¯æŒçš„ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šè¿™ä¸ªæ¨¡æ¿ï¼Œ<code>CloneSet</code> ä¼šåˆ›å»ºä¸å¸¦ <code>PVC</code> çš„ <code>Pod</code>ã€‚</p><p>æ³¨æ„ï¼š</p><blockquote><p>æ¯ä¸ªè¢«è‡ªåŠ¨åˆ›å»ºçš„ PVC ä¼šæœ‰ä¸€ä¸ª ownerReference æŒ‡å‘ CloneSetï¼Œå› æ­¤ CloneSet è¢«åˆ é™¤æ—¶ï¼Œå®ƒåˆ›å»ºçš„æ‰€æœ‰ Pod å’Œ PVC éƒ½ä¼šè¢«åˆ é™¤<br>æ¯ä¸ªè¢« CloneSet åˆ›å»ºçš„ Pod å’Œ PVCï¼Œéƒ½ä¼šå¸¦ä¸€ä¸ª apps.kruise.io&#x2F;cloneset-instance-id: xxx çš„ labelã€‚å…³è”çš„ Pod å’Œ PVC ä¼šæœ‰ç›¸åŒçš„ instance-idï¼Œä¸”å®ƒä»¬çš„åå­—åç¼€éƒ½æ˜¯è¿™ä¸ª instance-id<br>å¦‚æœä¸€ä¸ª Pod è¢« CloneSet Controller ç¼©å®¹åˆ é™¤æ—¶ï¼Œè¿™ä¸ª Pod å…³è”çš„ PVC éƒ½ä¼šè¢«ä¸€èµ·åˆ æ‰<br>å¦‚æœä¸€ä¸ª Pod è¢«å¤–éƒ¨ç›´æ¥è°ƒç”¨åˆ é™¤æˆ–é©±é€æ—¶ï¼Œè¿™ä¸ª Pod å…³è”çš„ PVC è¿˜éƒ½å­˜åœ¨ï¼›å¹¶ä¸” CloneSet Controller å‘ç°æ•°é‡ä¸è¶³é‡æ–°æ‰©å®¹æ—¶ï¼Œæ–°æ‰©å‡ºæ¥çš„ Pod ä¼šå¤ç”¨åŸ Pod çš„ instance-id å¹¶å…³è”åŸæ¥çš„ PVC<br>å½“ Pod è¢« é‡å»ºå‡çº§ æ—¶ï¼Œå…³è”çš„ PVC ä¼šè·Ÿéš Pod ä¸€èµ·è¢«åˆ é™¤ã€æ–°å»º<br>å½“ Pod è¢« åŸåœ°å‡çº§ æ—¶ï¼Œå…³è”çš„ PVC ä¼šæŒç»­ä½¿ç”¨</p></blockquote><p>ä¾‹å¦‚ï¼š</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps.kruise.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> CloneSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> sample<span class="token punctuation">-</span>data  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ops  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> sample<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">5</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> sample  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> sample    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>demo          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>demo      <span class="token key atrule">spec</span><span class="token punctuation">:</span>        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"ReadWriteOnce"</span> <span class="token punctuation">]</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>storageclass</code></pre><p>åˆ›å»ºåå¯ä»¥çœ‹åˆ°æ¯ä¸ªpodéƒ½æœ‰è‡ªå·±çš„pvc</p><pre class=" language-bash"><code class="language-bash">kubectl get pvc -n ops NAME                                STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS        AGEcephfs-pvc-demo-sample-data-4v6wb   Bound    pvc-ba67e462-deed-4153-803d-ad52b9e6d89f   1Gi        RWO            ceph-storageclass   4m3scephfs-pvc-demo-sample-data-6wz8m   Bound    pvc-be4c9711-3f18-4153-be65-2b0a495893b1   1Gi        RWO            ceph-storageclass   4m2scephfs-pvc-demo-sample-data-f7cxs   Bound    pvc-4c4fc404-88e6-4320-945e-914882375749   1Gi        RWO            ceph-storageclass   4m2scephfs-pvc-demo-sample-data-k2rd6   Bound    pvc-ceb78d1f-99e5-4011-b87f-dd18ebebbc28   1Gi        RWO            ceph-storageclass   4m2scephfs-pvc-demo-sample-data-ql7bn   Bound    pvc-cedf91b0-eac9-437e-a193-7b53c9dd437c   1Gi        RWO            ceph-storageclass   4m2s</code></pre><h5 id="æŒ‡å®špodç¼©å®¹"><a href="#æŒ‡å®špodç¼©å®¹" class="headerlink" title="æŒ‡å®špodç¼©å®¹"></a>æŒ‡å®špodç¼©å®¹</h5><p>å½“ä¸€ä¸ª <code>CloneSet</code> è¢«ç¼©å®¹æ—¶ï¼Œæœ‰æ—¶å€™ç”¨æˆ·éœ€è¦æŒ‡å®šä¸€äº› <code>Pod</code> æ¥åˆ é™¤ã€‚è¿™å¯¹äº <code>StatefulSet</code> æˆ–è€… <code>Deployment</code> æ¥è¯´æ˜¯æ— æ³•å®ç°çš„ï¼Œå› ä¸º <code>StatefulSet</code> è¦æ ¹æ®åºå·æ¥åˆ é™¤ <code>Pod</code>ï¼Œè€Œ <code>Deployment/ReplicaSet</code> ç›®å‰åªèƒ½æ ¹æ®æ§åˆ¶å™¨é‡Œå®šä¹‰çš„æ’åºæ¥åˆ é™¤ã€‚</p><p><code>CloneSet</code> å…è®¸ç”¨æˆ·åœ¨ç¼©å° <code>replicas</code> æ•°é‡çš„åŒæ—¶ï¼ŒæŒ‡å®šæƒ³è¦åˆ é™¤çš„ <code>Pod</code> åå­—ã€‚å‚è€ƒä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š</p><pre class=" language-bash"><code class="language-bash">apiVersion: apps.kruise.io/v1alpha1kind: CloneSetspec:  <span class="token comment" spellcheck="true">#...</span>  replicas: 3  revisionHistoryLimit: 10  scaleStrategy:     podsToDelete:    - sample-data-6wz8m</code></pre><p>å½“æ§åˆ¶å™¨æ”¶åˆ°ä¸Šé¢è¿™ä¸ª <code>CloneSet</code> æ›´æ–°ä¹‹åï¼Œä¼šç¡®ä¿ <code>replicas</code> æ•°é‡ä¸º 4ã€‚å¦‚æœ <code>podsToDelete</code> åˆ—è¡¨é‡Œå†™äº†ä¸€äº› <code>Pod</code> åå­—ï¼Œæ§åˆ¶å™¨ä¼šä¼˜å…ˆåˆ é™¤è¿™äº› <code>Pod</code>ã€‚å¯¹äºå·²ç»è¢«åˆ é™¤çš„ <code>Pod</code>ï¼Œæ§åˆ¶å™¨ä¼šè‡ªåŠ¨ä» <code>podsToDelete</code> åˆ—è¡¨ä¸­æ¸…ç†æ‰ã€‚</p><blockquote><p>æ³¨æ„ï¼šå¦‚æœä½ åªæŠŠ Pod åå­—åŠ åˆ° podsToDeleteï¼Œä½†æ²¡æœ‰ä¿®æ”¹ replicas æ•°é‡ï¼Œé‚£ä¹ˆæ§åˆ¶å™¨ä¼šå…ˆæŠŠæŒ‡å®šçš„ Pod åˆ æ‰ï¼Œç„¶åå†æ‰©ä¸€ä¸ªæ–°çš„ Podã€‚<br>å¦‚æœä¸æŒ‡å®š podsToDeleteï¼Œæ§åˆ¶å™¨ä¼šæŒ‰ç…§é»˜è®¤é¡ºåºæ¥é€‰æ‹© Pod åˆ é™¤ï¼šnot-ready &lt; ready, unscheduled &lt; scheduled, pending &lt; runningã€‚</p></blockquote><h4 id="å‡çº§åŠŸèƒ½"><a href="#å‡çº§åŠŸèƒ½" class="headerlink" title="å‡çº§åŠŸèƒ½"></a>å‡çº§åŠŸèƒ½</h4><h5 id="åŸåœ°å‡çº§"><a href="#åŸåœ°å‡çº§" class="headerlink" title="åŸåœ°å‡çº§"></a>åŸåœ°å‡çº§</h5><p><code>CloneSet</code> æä¾›äº†å’Œ <code>Advanced StatefulSet</code> ç›¸åŒçš„ 3 ä¸ªå‡çº§æ–¹å¼ï¼Œé»˜è®¤ä¸º <code>ReCreate</code>ï¼š</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">ReCreate</span><span class="token punctuation">:</span> æ§åˆ¶å™¨ä¼šåˆ é™¤æ—§ Pod å’Œå®ƒçš„ PVCï¼Œç„¶åç”¨æ–°ç‰ˆæœ¬é‡æ–°åˆ›å»ºå‡ºæ¥<span class="token key atrule">InPlaceIfPossible</span><span class="token punctuation">:</span> æ§åˆ¶å™¨ä¼šä¼˜å…ˆå°è¯•åŸåœ°å‡çº§ Podï¼Œå¦‚æœä¸è¡Œå†é‡‡ç”¨é‡å»ºå‡çº§ã€‚ç›®å‰ï¼Œåªæœ‰ä¿®æ”¹ spec.template.metadata.* å’Œ spec.template.spec.containers<span class="token punctuation">[</span>x<span class="token punctuation">]</span>.image è¿™äº›å­—æ®µæ‰å¯ä»¥èµ°åŸåœ°å‡çº§<span class="token key atrule">InPlaceOnly</span><span class="token punctuation">:</span> æ§åˆ¶å™¨åªå…è®¸é‡‡ç”¨åŸåœ°å‡çº§ã€‚å› æ­¤ï¼Œç”¨æˆ·åªèƒ½ä¿®æ”¹ä¸Šä¸€æ¡ä¸­çš„é™åˆ¶å­—æ®µï¼Œå¦‚æœå°è¯•ä¿®æ”¹å…¶ä»–å­—æ®µä¼šè¢« Kruise æ‹’ç»</code></pre><blockquote><p>å½“ä¸€ä¸ª Pod è¢«åŸåœ°å‡çº§æ—¶ï¼Œæ§åˆ¶å™¨ä¼šå…ˆåˆ©ç”¨ readinessGates æŠŠ Pod status ä¸­ä¿®æ”¹ä¸º not-ready çŠ¶æ€ï¼Œç„¶åå†æ›´æ–° Pod spec ä¸­çš„ image å­—æ®µæ¥è§¦å‘ Kubelet é‡å»ºå¯¹åº”çš„å®¹å™¨ã€‚ä¸è¿‡è¿™æ ·å¯èƒ½å­˜åœ¨çš„ä¸€ä¸ªé£é™©ï¼šæœ‰æ—¶å€™ Kubelet é‡å»ºå®¹å™¨å¤ªå¿«ï¼Œè¿˜æ²¡ç­‰åˆ°å…¶ä»–æ§åˆ¶å™¨å¦‚ endpoints-controller æ„ŸçŸ¥åˆ° Pod not-readyï¼Œå¯èƒ½ä¼šå¯¼è‡´æµé‡å—æŸã€‚<br>å› æ­¤åˆåœ¨åŸåœ°å‡çº§ä¸­æä¾›äº† graceful period é€‰é¡¹ï¼Œä½œä¸ºä¼˜é›…åŸåœ°å‡çº§çš„ç­–ç•¥ã€‚ç”¨æˆ·å¦‚æœé…ç½®äº† gracePeriodSeconds è¿™ä¸ªå­—æ®µï¼Œæ§åˆ¶å™¨åœ¨åŸåœ°å‡çº§çš„è¿‡ç¨‹ä¸­ä¼šå…ˆæŠŠ Pod status æ”¹ä¸º not-readyï¼Œç„¶åç­‰ä¸€æ®µæ—¶é—´ï¼ˆgracePeriodSecondsï¼‰ï¼Œæœ€åå†å»ä¿®æ”¹ Pod spec ä¸­çš„é•œåƒç‰ˆæœ¬ã€‚è¿™æ ·ï¼Œå°±ä¸º endpoints-controller è¿™äº›æ§åˆ¶å™¨ç•™å‡ºäº†å……è¶³çš„æ—¶é—´æ¥å°† Pod ä» endpoints ç«¯ç‚¹åˆ—è¡¨ä¸­å»é™¤ã€‚</p></blockquote><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps.kruise.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> CloneSet<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># ...</span>  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">inPlaceUpdateStrategy</span><span class="token punctuation">:</span>      <span class="token key atrule">gracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>    <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 20%    <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> InPlaceIfPossible</code></pre><p>é…ç½®å®Œæˆåä¿®æ”¹é•œåƒæµ‹è¯•</p><pre class=" language-bash"><code class="language-bash">Normal   Killing                 2m35s                kubelet, dev-k8s     Container nginx definition changed, will be restarted  Normal   Pulling                 2m35s                kubelet, dev-k8s     Pulling image <span class="token string">"nginx:1.17"</span>  Normal   Created                 2m17s <span class="token punctuation">(</span>x2 over 49m<span class="token punctuation">)</span>  kubelet, dev-k8s     Created container nginx  Normal   Started                 2m17s <span class="token punctuation">(</span>x2 over 49m<span class="token punctuation">)</span>  kubelet, dev-k8s     Started container nginx  Normal   Pulled                  2m17s                kubelet, dev-k8s     Successfully pulled image <span class="token string">"nginx:1.17"</span> <span class="token keyword">in</span> 18.297840376s</code></pre><p>æŸ¥çœ‹podå‘ç°é•œåƒæ›´æ–° ä½†æ˜¯podæ²¡æœ‰é‡æ–°åˆ›å»ºè€Œæ˜¯é‡å¯äº†</p><pre class=" language-bash"><code class="language-bash">kubectl get po -n opssample-data-f7cxs   1/1     Running            1          50msample-data-k2rd6   1/1     Running            1          50m</code></pre><h5 id="Partition-åˆ†æ‰¹ç°åº¦"><a href="#Partition-åˆ†æ‰¹ç°åº¦" class="headerlink" title="Partition åˆ†æ‰¹ç°åº¦"></a>Partition åˆ†æ‰¹ç°åº¦</h5><p><code>Partition</code> çš„è¯­ä¹‰æ˜¯ ä¿ç•™æ—§ç‰ˆæœ¬ <code>Pod</code> çš„æ•°é‡æˆ–ç™¾åˆ†æ¯”ï¼Œé»˜è®¤ä¸º 0ã€‚è¿™é‡Œçš„ <code>partition</code> ä¸è¡¨ç¤ºä»»ä½• <code>order</code> åºå·ã€‚</p><p>å¦‚æœåœ¨å‘å¸ƒè¿‡ç¨‹ä¸­è®¾ç½®äº† <code>partition</code>:</p><pre class=" language-bash"><code class="language-bash">å¦‚æœæ˜¯æ•°å­—ï¼Œæ§åˆ¶å™¨ä¼šå°† <span class="token punctuation">(</span>replicas - partition<span class="token punctuation">)</span> æ•°é‡çš„ Pod æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼›å¦‚æœæ˜¯ç™¾åˆ†æ¯”ï¼Œæ§åˆ¶å™¨ä¼šå°† <span class="token punctuation">(</span>replicas * <span class="token punctuation">(</span>100% - partition<span class="token punctuation">))</span> æ•°é‡çš„ Pod æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚</code></pre><p>æ¯”å¦‚ï¼Œå°† <code>CloneSet</code> ä¾‹å­çš„ <code>image</code> æ›´æ–°ä¸º <code>nginx:mainline</code> å¹¶ä¸”è®¾ç½® <code>partition=3</code>ã€‚è¿‡äº†ä¸€ä¼šï¼ŒæŸ¥åˆ°çš„ <code>CloneSet</code> å¦‚ä¸‹ï¼š</p><pre class=" language-bash"><code class="language-bash">apiVersion: apps.kruise.io/v1alpha1kind: CloneSetmetadata:  <span class="token comment" spellcheck="true"># ...</span>  generation: 2spec:  replicas: 5  template:    metadata:      labels:        app: sample    spec:      containers:      - image: nginx:mainline        imagePullPolicy: Always        name: nginx  updateStrategy:    maxSurge: 0    maxUnavailable: 20%    partition: 2    type: ReCreate</code></pre><p>å› ä¸º<code>partition: 2</code>æ‰€ä»¥ä¼šæ›´æ–°ä¸‰ä¸ªpod</p><pre class=" language-bash"><code class="language-bash">sample-data-8p6gx   1/1     Running   1          106m    sample-data-7656fc4998sample-data-8rzcr   1/1     Running   0          3m1s    sample-data-78479f6458sample-data-9qq4j   1/1     Running   0          103m    sample-data-7656fc4998sample-data-dc7qz   1/1     Running   0          2m25s   sample-data-78479f6458sample-data-ql7bn   1/1     Running   1          104m    sample-data-7656fc4998</code></pre>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Openkruise </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Openkruiseå®‰è£…</title>
      <link href="/f4a1d35f/"/>
      <url>/f4a1d35f/</url>
      
        <content type="html"><![CDATA[<h3 id="Openkruiseç®€ä»‹"><a href="#Openkruiseç®€ä»‹" class="headerlink" title="Openkruiseç®€ä»‹"></a>Openkruiseç®€ä»‹</h3><blockquote><p>OpenKruise æ˜¯ä¸€ä¸ªåŸºäº Kubernetes çš„æ‰©å±•å¥—ä»¶ï¼Œä¸»è¦èšç„¦äºäº‘åŸç”Ÿåº”ç”¨çš„è‡ªåŠ¨åŒ–ï¼Œæ¯”å¦‚éƒ¨ç½²ã€å‘å¸ƒã€è¿ç»´ä»¥åŠå¯ç”¨æ€§é˜²æŠ¤ã€‚<br>OpenKruise æä¾›çš„ç»å¤§éƒ¨åˆ†èƒ½åŠ›éƒ½æ˜¯åŸºäº CRD æ‰©å±•æ¥å®šä¹‰ï¼Œå®ƒä»¬ä¸å­˜åœ¨äºä»»ä½•å¤–éƒ¨ä¾èµ–ï¼Œå¯ä»¥è¿è¡Œåœ¨ä»»æ„çº¯å‡€çš„ Kubernetes é›†ç¾¤ä¸­ã€‚</p></blockquote><h4 id="æ ¸å¿ƒèƒ½åŠ›"><a href="#æ ¸å¿ƒèƒ½åŠ›" class="headerlink" title="æ ¸å¿ƒèƒ½åŠ›"></a>æ ¸å¿ƒèƒ½åŠ›</h4><ul><li><p>å¢å¼ºç‰ˆæœ¬çš„ Workloads<br> OpenKruise åŒ…å«äº†ä¸€ç³»åˆ—å¢å¼ºç‰ˆæœ¬çš„ Workloadsï¼ˆå·¥ä½œè´Ÿè½½ï¼‰ï¼Œæ¯”å¦‚ CloneSetã€Advanced StatefulSetã€Advanced DaemonSetã€BroadcastJob ç­‰ã€‚<br>  å®ƒä»¬ä¸ä»…æ”¯æŒç±»ä¼¼äº Kubernetes åŸç”Ÿ Workloads çš„åŸºç¡€åŠŸèƒ½ï¼Œè¿˜æä¾›äº†å¦‚åŸåœ°å‡çº§ã€å¯é…ç½®çš„æ‰©ç¼©å®¹&#x2F;å‘å¸ƒç­–ç•¥ã€å¹¶å‘æ“ä½œç­‰ã€‚<br>  å…¶ä¸­ï¼ŒåŸåœ°å‡çº§æ˜¯ä¸€ç§å‡çº§åº”ç”¨å®¹å™¨é•œåƒç”šè‡³ç¯å¢ƒå˜é‡çš„å…¨æ–°æ–¹å¼ã€‚å®ƒåªä¼šç”¨æ–°çš„é•œåƒé‡å»º Pod ä¸­çš„ç‰¹å®šå®¹å™¨ï¼Œæ•´ä¸ª Pod ä»¥åŠå…¶ä¸­çš„å…¶ä»–å®¹å™¨éƒ½ä¸ä¼šè¢«å½±å“ã€‚å› æ­¤å®ƒå¸¦æ¥äº†æ›´å¿«çš„å‘å¸ƒé€Ÿåº¦ï¼Œä»¥åŠé¿å…äº†å¯¹å…¶ä»– Schedulerã€CNIã€CSI ç­‰ç»„ä»¶çš„è´Ÿé¢å½±å“ã€‚</p></li><li><p>åº”ç”¨çš„æ—è·¯ç®¡ç†<br>OpenKruise æä¾›äº†å¤šç§é€šè¿‡æ—è·¯ç®¡ç†åº”ç”¨ sidecar å®¹å™¨ã€å¤šåŒºåŸŸéƒ¨ç½²çš„æ–¹å¼ï¼Œâ€œæ—è·¯â€ æ„å‘³ç€ä½ å¯ä»¥ä¸éœ€è¦ä¿®æ”¹åº”ç”¨çš„ Workloads æ¥å®ç°å®ƒä»¬ã€‚<br>æ¯”å¦‚ï¼ŒSidecarSet èƒ½å¸®åŠ©ä½ åœ¨æ‰€æœ‰åŒ¹é…çš„ Pod åˆ›å»ºçš„æ—¶å€™éƒ½æ³¨å…¥ç‰¹å®šçš„ sidecar å®¹å™¨ï¼Œç”šè‡³å¯ä»¥åŸåœ°å‡çº§å·²ç»æ³¨å…¥çš„ sidecar å®¹å™¨é•œåƒã€å¹¶ä¸”å¯¹ Pod ä¸­å…¶ä»–å®¹å™¨ä¸é€ æˆå½±å“ã€‚<br>è€Œ WorkloadSpread å¯ä»¥çº¦æŸæ— çŠ¶æ€ Workload æ‰©å®¹å‡ºæ¥ Pod çš„åŒºåŸŸåˆ†å¸ƒï¼Œèµ‹äºˆå•ä¸€ workload çš„å¤šåŒºåŸŸå’Œå¼¹æ€§éƒ¨ç½²çš„èƒ½åŠ›ã€‚</p></li><li><p>é«˜å¯ç”¨æ€§é˜²æŠ¤<br>OpenKruise åœ¨ä¸ºåº”ç”¨çš„é«˜å¯ç”¨æ€§é˜²æŠ¤æ–¹é¢ä¹Ÿåšå‡ºäº†å¾ˆå¤šåŠªåŠ›ã€‚<br>ç›®å‰å®ƒå¯ä»¥ä¿æŠ¤ä½ çš„ Kubernetes èµ„æºä¸å—çº§è”åˆ é™¤æœºåˆ¶çš„å¹²æ‰°ï¼ŒåŒ…æ‹¬ CRDã€Namespaceã€ä»¥åŠå‡ ä¹å…¨éƒ¨çš„ Workloads ç±»å‹èµ„æºã€‚<br>ç›¸æ¯”äº Kubernetes åŸç”Ÿçš„ PDB åªæä¾›é’ˆå¯¹ Pod Eviction çš„é˜²æŠ¤ï¼ŒPodUnavailableBudget èƒ½å¤Ÿé˜²æŠ¤ Pod Deletionã€Evictionã€Update ç­‰è®¸å¤šç§ voluntary disruption åœºæ™¯ã€‚</p></li><li><p>é«˜çº§çš„åº”ç”¨è¿ç»´èƒ½åŠ›<br>OpenKruise ä¹Ÿæä¾›äº†å¾ˆå¤šé«˜çº§çš„è¿ç»´èƒ½åŠ›æ¥å¸®åŠ©ä½ æ›´å¥½åœ°ç®¡ç†åº”ç”¨ã€‚<br>ä½ å¯ä»¥é€šè¿‡ ImagePullJob æ¥åœ¨ä»»æ„èŒƒå›´çš„èŠ‚ç‚¹ä¸Šé¢„å…ˆæ‹‰å–æŸäº›é•œåƒï¼Œæˆ–è€…æŒ‡å®šæŸä¸ª Pod ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨è¢«åŸåœ°é‡å¯ã€‚</p></li></ul><h3 id="Helmå®‰è£…OpenKruise"><a href="#Helmå®‰è£…OpenKruise" class="headerlink" title="Helmå®‰è£…OpenKruise"></a>Helmå®‰è£…OpenKruise</h3><p>æŸ¥çœ‹helmç‰ˆæœ¬</p><pre class=" language-bash"><code class="language-bash">helm versionversion.BuildInfo<span class="token punctuation">{</span>Version:<span class="token string">"v3.7.2"</span>, GitCommit:<span class="token string">"663a896f4a815053445eec4153677ddc24a0a361"</span>, GitTreeState:<span class="token string">"clean"</span>, GoVersion:<span class="token string">"go1.16.10"</span><span class="token punctuation">}</span></code></pre><p>helmä»“åº“æ·»åŠ charts</p><pre class=" language-bash"><code class="language-bash">helm repo add openkruise https://openkruise.github.io/charts/</code></pre><p>æ›´æ–°helmä»“åº“</p><pre class=" language-bash"><code class="language-bash">helm repo update</code></pre><p>helmå®‰è£…</p><pre class=" language-bash"><code class="language-bash">helm <span class="token function">install</span> kruise openkruise/kruise --version 1.3.0NAME: kruiseLAST DEPLOYED: Mon Nov 28 10:39:22 2022NAMESPACE: defaultSTATUS: deployedREVISION: 1TEST SUITE: None</code></pre><p>æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ </p><pre class=" language-bash"><code class="language-bash">NAME                                         READY   STATUS    RESTARTS   AGEkruise-controller-manager-7f76fbf596-d86z7   1/1     Running   0          117skruise-controller-manager-7f76fbf596-kgczl   1/1     Running   0          117skruise-daemon-4c7zk                          1/1     Running   0          117skruise-daemon-6f55g                          1/1     Running   0          117skruise-daemon-6nt54                          1/1     Running   0          117skruise-daemon-78tnr                          1/1     Running   0          117skruise-daemon-nvj9z                          1/1     Running   0          117skruise-daemon-swj9t                          1/1     Running   0          117s</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æˆ‘å’Œå¥¹çš„æ•…äº‹</title>
      <link href="/1ece2163/"/>
      <url>/1ece2163/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="4fa0776933caee5541d9fa3c5c48ae5f7c6dce04b6b4b59da51a29b2cfec662b">0eacf5465d362a115120fa3a3bf3bf57ab7f2bac42c9206d9bbd3c5f7c63bce8b8cde25c06b4310885094df1a7705cf377ebb6bc71bd3429a0b5240f9cd72f3606aa7b1ba1b411498ae8d73044a3a356f3142409b78d4498c042de073a8f293f405b83bdc1ccb94dd651d9f98f0a74a2c3fe7cd41f4e20d023dc4dd99eb6be03424920ed06b1f65083f93430bdaf8da63bddd84d954bc2a3b54fc866deefa41f02833f25d03dedffdd0cdf565c9bfb8bb5e6e3eaed0938bcff9c9a665b78ef372f5b14e3556e0a2ba049861cf2698b1f880925647305db381d64fa5a37a4a094c84bd163742cb069c14d4f50eadd0623b406dc3288af122076059612e325249bf0414cad4328f7db05e055d071586125ecf88eb55527a8067b43ccf503eccf6bbcdb8b6a9dbaa330c7917597e98b5c53986a0d13463f3bff754a174f71bfcd81e047f56afdfb7e021ec549e6facf0a75d24add70eac0f6eb3f014fa1e7be7a2eb023693276580d368240bd8e2f6ae8ec390180d1ea6fe35c6e446b1a039c61f704f1a1dd9252cdeb2e4802e4455aadf77263058b3ed51664326d07aca525e69e4df5caf5a9a7a7e7cb2d5d83eea80d45e852ca5b509e8de7e212057b4c8ed6ac095e55f7db4546e0a032f06c405f4ef83b79390a7807514b6ffb8ff18d17a19fe473fe05590d088898598c39af4408f6b415789413a58e39e481988133a78d17387cc8b114c212a3cd4702bba464effe986cd1f1217b68103e5d7bd8a16e5eb544c70c81afe8db5c1952665933e1aed4cbb6c9c3d58cd1ccd12c61580f5649c438ed0cb6cb845249c01ea5ec6d4d3b815d169bb4714a6f3a433af98975206afccb5758540601d894733f7998db8f9e9a92f73c56a6d9bc9dbfcfce4d2e83cd61f25b3ac5325ec0cde93a3c091df463371d87894ded6faf6c19054672191fa3e51c3b099364966ed8447dae3cb64307a5c60d9af7bb7f828db46ba155e8efe514809e5f4c85e634b7ba68af11786170e78d4b91c48d0bf5b0b0e67ba23a5e97662212b8c6d6248edc1371b45236c56985dbd710b256ca0821c86f8507a5daf3522c7cd9babc0366eaeeca30ecd6bf13714fd6114213b84b33a9409170cf5cb24d7e14488873d12b60fb4056379ed0710f9d2b97ba42f7d38513e8836060556e80135b17aa19fd14b59d8b1701070a33d07e4ef96d39be807b871c75461a116db62bacca16de3d02966e85ff461839427c5b02a362bfb5791b8943c31656c281ec1198f3b7c282b1e7715fe71ae1e101a32eac55ce87387455c9c819b0720aee2378f69f9a7969f592d6182686270a60cd6dcc3c5f59ae2c8100a7a433cbd6b79bc6f466f3a89b55f93c4e513892637f8c44349894632451a92d1544636ddaed726426e3376089045489c673f38154aa8f335f87445117b64412de4a09e78b2611d13b152dcd1daf6057e33306de49f624bb38859e98ba58a3afb13225beb05296563221f3c79b2c2a3557b639e66d5701730b7fda5fb7d87583f61c3b128edc81da90fbb45f3751a91d1e1f7cb77d284871a5e4e4f1f0f780aacb89a4dfa462eb3435a50f8384e3b2a61288c7649851acee3a4a2fee399fe4631173fcedbcb16f6eba067cbec9f1e3f156e00832023615fcbb13976f594f3139a14e40ff554d46968e320dc33ee94c2c046f52fc86c84a2f9c6e64a178c46984af195928214acbbf507b8b6de889ee7ca064baba062a0080b33aa30f79634b0b370567c70213142aa8cc828bb814eec94721264934e129acb213868c10548e01b882a273e4efc83367317335027949c97abd43de2bb0d0627f442a016a7f09554afce1f5365cbca2a5c05f5d13d0152d2c19a9b731269cad2284d59e893967c8ddf03b1cb5c16a3cd19976d7f0f15d0027c00897278e6580625b1b0e9d88b9f43256041580cfb14f993b3b237be157021dce44458c835688545229cb7435d04cdaec19a1ec89ca50af07991548ab2a6e48d5301f0a5613b62b1a7e1353e6f4474d83d550548e77073000ac8cd075b8db43450d044a3a88cb1cbd2b8bbe3912efdbd5b87b2bbd3bdf3376804606cb290581c4502bfff3379d7ef9ab71c9f8953e0dcffecd355d82b13d6466b3f45fc43eaf84b92b4cbfaf8efc3959aa7177751ba9ec6a325b99967f71548df581ad8165035315050aa0421c6995094ffbf46b015835d411c71b752b885a8df2a3987c4ab6d3b68caf91e3f5c7d4548eecddca5815aeb2ff58d9df2420b73b704ed975460b12f89ebd1aad9751c390a4dd4e3a6cfd5b2bfa0770241b724ff6738dfe493c572b1a3786ef37eeb7a63d88ee46af4c241276d239d19b2b927e0186b6101bbdc611269cefa42f551afb3427fb09f27c22722563f07543d857b9030734b92a250933e10116c7fc7811546de013c525ef2ab398952fb485b1ca20a4b3aec3b2bcca4863b1d32d04d0f7aaf1cfca352f74862b6c2191cb0c2dad5b8e5dff5c40cd332ce617824853aff87329fedc2bde2bb478509011f9e8db3584a7f702dc7b8e06b3e5c75daf98326cb8a29a48183e18806fcd221a8fa9e15403a5e0144c55ac42eced9f0e889788a999bc33baee0ee42fe91d2a216a3369ab1a1bf58eb1a7cfd07616ae286de304c6b11c1171da960ae4153744779527d9f5bcd59e567f4ef474a9deb573163798fe6ac27af0607392994003f0acb8e4711c0e3451e6d538b08714133926c529c824d253a66216fb03d7f706d6bc67d26b07b592f303c1ee140fb92dfbfce9bdbe5b51f11f2cd897b59dcb5d49fa79f7c00cbcbd777caa6de3127da9d005209253f0065cf696160cf11d5a0833edce8e959abdf31ff3cbefbea20e808b54fe21c690ec74fdb7c27832155f4665d4a0189bf6541ac14430614a8199d7efffd1b9ff6048bf50c81c24add8c8eb3cfa30adeab5e2bf525588b1ae052edd2407b543930bed30ecd65e5305c97a8133596c178ba9c1b77d0aad0aee300814d1eb3ff70d9f1512359c71868981c257dd60e8d6aa1b76a0c5b5207dee9213e28cac8b9d32904944ad1675476d5664b2c491160c89061cb175918c796bc216678df83f98e885f6550192d90b9042a67676eb2e7b46629fc17120293a61e9d604eded70731e335f3365797891fc21b25483eb3f1b6073a30d5734a031374219f7c863bd9218af55476816f92e0729662057f34399066e4e1e25b0c5823ba413ba5848f4fdb8d2e06693c28e3ebe3746f634a6d4b94111fdf6c40abccda64a93be62ac449691f2ec67e0e1ccea54d86c327a03cd8f6179c98d3ca16c3c97b031df3667ae7075ff4272ba141b2502dea0de764b941175b5551c307bb3af48e454c06cb8507aad9504160d17452a979ef5b1f464d4ac8e920bbfcd118c0c8b88cabbf58762dcdbf0aa802e322c3fb4c63397d2547a2bb69f27bd33ae2a5c75782e15f31144d6eb063cf3b48bb9f512d1c0dea572b4edc789a0fcf066817bc99d87d6333169e185dfa39e4c9c8c03969fad54789ee48562e3b20eb90f0b082427efdae36d9bdb1b687a11cefcc70e7db00113d9baff4ade9a7d76bd9cf7cc41ba91be8aa93ab03b6aa688f2f51d8f191eb65ab44863b4c332c9ba22c3c16b82492155348636bdfe3c47635b4e031ae0a854e8313eca2bc4e14f95d9d167c803325ff197453674e10cdb70835e102ab3b7b897b00a6ac7d991045eaa772bff461f110c7cd0f1a1f9f27a68b9e3150ea9549ec5c866a31e2425e5f617a99dc0b9b4746be1d5738c8904ab9afd35ebd1877675511232dbc8f5e4fc74543769a17961d626f225a97512466da4b7d39209de7b4dadf40403784661b363c26ac99954f4b087e74fb4e2a992aea3f507a704502e92583717904f05418fddfb97255f115556bc39cc5ded1c892b74b24d19578c9b17234527a8ff6deb9f83cf955b1445446ad2d7d63081b66891bb87ac371bbcd0b51042f31b4159314c4417718659352e41230bae084bc439ce6ccbeac360be127a190f3f104e0002e8fb914f5fd853426cf026eb854e7b6a30b56b9460ab649ccb47938e769364489e6d1e12ec0f32c5157f87b7d7bc0d65c94d61870c1eeea48bf7c80358e6094ab0f0d4b07feffa541b3406de3869104a529777c9bf0f5f9deba578b640331ec55148b3b034271e941fad5101a93c9e24fa4130a504ef872a0c290911f238b5151617c056615fb985636ebb91481ac464dba57d25536e54296d72ef637b479331ce8ef9c4a7a7b40ad1287dbbf0b17cd1a3c2305cd9988225fe360762310a002f406ca9519e3a39dad75161bcba655f2c1fe0342b290c8a1aae864da2b0cd5d7d51cf25a43ff06b2e6857b0f6d7314a13c574ccd7c89ebcca591699d4c510231a47a44d227b170a69d85e1f2a71b6e135f79c4ca376884298922014696dc0cea1844dd0c5660398c27849e655a7cd4f395c30af7c92d79197c2217212a341e4838e6cd20aea70f00e6ec49fe455be4e186c2476d6a69e245aa91013c4e3e0cd9d0a1ae10ed67e912407891da9e4d794d5f830c426df82b3580eaba5c3f74ee09b56f6d4cc477552116a51c4bc7d76ef6dc7ca2d055736a63037286cb50f21fdc6b79e61b738f57483f9457112c6f19d7f09778ebf0bb4abd1d91c7a0088b48a84f7519aa65265ea5ee0188480f164dcbe01c9e89a291a8a6da3173d05c2a7955748cb2e05248c3014ec5d32d82828a1f2be4a7367bdcce72d354abe8edcbd9797001c639359a04da742a39ea260935258e540036fd06147511087b74d27f346eb7e75ab5cd873dd7ce2a5657ef73f363b009c6fbc77469d16da63fef64956b1cabbe3576fd3065b05d7708238916aa84e1d2dd3d2a5ff594f7489ccba6952cc8fd8be55a699537d7bac331bdee7d90f53a5ba6a56b389b7cc0445c6ae1bfc7e3787c436c6b31115d2defec1651814d7edcfd4130ecf767a25cb6db7f58b3c</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">çœ‹ä¸åˆ°å§ï¼Œhhhhï¼Œä¸å‘Šè¯‰ä½ å¯†ç æ˜¯123456</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> ä¸ªäººåˆ†äº« </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ä¸ªäººåšå®¢ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginxæ—¥å¸¸è°ƒä¼˜</title>
      <link href="/dfc58db0/"/>
      <url>/dfc58db0/</url>
      
        <content type="html"><![CDATA[<h3 id="æ—¥å¿—æ”¶é›†"><a href="#æ—¥å¿—æ”¶é›†" class="headerlink" title="æ—¥å¿—æ”¶é›†"></a>æ—¥å¿—æ”¶é›†</h3><p>é…ç½®nginxæ—¥å¿—æ ¼å¼</p><pre class=" language-bash"><code class="language-bash">log_format main     <span class="token string">'<span class="token variable">$remote_addr</span> - <span class="token variable">$remote_user</span> [<span class="token variable">$time_local</span>] "<span class="token variable">$request</span>" <span class="token variable">$http_host</span> '</span><span class="token string">'<span class="token variable">$status</span> <span class="token variable">$body_bytes_sent</span> "<span class="token variable">$http_referer</span>" '</span><span class="token string">'"<span class="token variable">$http_user_agent</span>" "<span class="token variable">$http_x_forwarded_for</span>" "<span class="token variable">$request_body</span>" '</span><span class="token string">'<span class="token variable">$upstream_addr</span>'</span> <span class="token string">'"<span class="token variable">$upstream_status</span>" "<span class="token variable">$upstream_cache_status</span>" '</span> <span class="token string">'"<span class="token variable">$upstream_http_content_type</span>" <span class="token variable">$upstream_response_time</span> > <span class="token variable">$request_time</span>'</span><span class="token punctuation">;</span></code></pre><p>é…ç½®æ—¥å¿—å­˜æ”¾ç›®å½•</p><pre class=" language-bash"><code class="language-bash">access_log  /data/nginx/logs/access.log main<span class="token punctuation">;</span></code></pre><h3 id="åä»£å‚æ•°ä¼˜åŒ–"><a href="#åä»£å‚æ•°ä¼˜åŒ–" class="headerlink" title="åä»£å‚æ•°ä¼˜åŒ–"></a>åä»£å‚æ•°ä¼˜åŒ–</h3><pre class=" language-bash"><code class="language-bash">    proxy_headers_hash_bucket_size 1024<span class="token punctuation">;</span>    proxy_headers_hash_max_size 512<span class="token punctuation">;</span>    proxy_connect_timeout 5<span class="token punctuation">;</span>    proxy_read_timeout 60<span class="token punctuation">;</span>    proxy_send_timeout 5<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">#è®¾ç½®ä»£ç†æœåŠ¡å™¨ï¼ˆnginxï¼‰ä¿å­˜ç”¨æˆ·å¤´ä¿¡æ¯çš„ç¼“å†²åŒºå¤§å°</span>    proxy_buffer_size 16k<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">#proxy_buffersç¼“å†²åŒºï¼Œç½‘é¡µå¹³å‡åœ¨32kä»¥ä¸‹çš„è®¾ç½®</span>    proxy_buffers 4 64k<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">#é«˜è´Ÿè·ä¸‹ç¼“å†²å¤§å°ï¼ˆproxy_buffers*2ï¼‰</span>    proxy_busy_buffers_size 128k<span class="token punctuation">;</span>    proxy_temp_file_write_size 128k<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">#é…ç½®åä»£ç¼“å­˜ä¸´æ—¶ç›®å½•</span>    proxy_temp_path /data/temp_dir<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">#é…ç½®åä»£ç¼“å­˜ç›®å½•</span>    proxy_cache_path /data/cache levels<span class="token operator">=</span>1:2 keys_zone<span class="token operator">=</span>cache_one:200m inactive<span class="token operator">=</span>1d max_size<span class="token operator">=</span>30g<span class="token punctuation">;</span></code></pre><h3 id="å‹ç¼©é…ç½®"><a href="#å‹ç¼©é…ç½®" class="headerlink" title="å‹ç¼©é…ç½®"></a>å‹ç¼©é…ç½®</h3><pre class=" language-bash"><code class="language-bash">    <span class="token function">gzip</span> on<span class="token punctuation">;</span>    gzip_min_length  1k<span class="token punctuation">;</span>    gzip_buffers     4 16k<span class="token punctuation">;</span>    gzip_http_version 1.0<span class="token punctuation">;</span>    gzip_comp_level 9<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#æŒ‡å®šå‹ç¼©ç±»å‹</span>    gzip_types    text/plain application/x-javascript text/css application/xml<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#åŠ varyå¤´</span>    gzip_vary on<span class="token punctuation">;</span></code></pre><h3 id="æŒ‡å®šreferer"><a href="#æŒ‡å®šreferer" class="headerlink" title="æŒ‡å®šreferer"></a>æŒ‡å®šreferer</h3><pre class=" language-bash"><code class="language-bash">map <span class="token variable">$http_referer</span> <span class="token variable">$ref</span> <span class="token punctuation">{</span>                default <span class="token variable">$http_referer</span><span class="token punctuation">;</span>                ~<span class="token punctuation">(</span>https:\/\/aaa.com<span class="token punctuation">)</span><span class="token punctuation">(</span>.*<span class="token punctuation">)</span>  https://bbb.com<span class="token variable">$2</span><span class="token punctuation">;</span>                ~https://aaa.com  https://bbb.com<span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>é€šè¿‡mapæ˜ å°„å®ç°ä¿®æ”¹refererçš„ç›®çš„</p><h3 id="æ—¥å¿—åˆ†å‰²"><a href="#æ—¥å¿—åˆ†å‰²" class="headerlink" title="æ—¥å¿—åˆ†å‰²"></a>æ—¥å¿—åˆ†å‰²</h3><pre class=" language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>base_path<span class="token operator">=</span><span class="token string">'/data/nginx/logs'</span>               <span class="token comment" spellcheck="true"># ä¿å­˜æ—¥å¿—çš„ç›®å½•</span>log_path<span class="token operator">=</span><span class="token punctuation">$(</span>date -d yesterday +<span class="token string">"%Y%m"</span><span class="token punctuation">)</span>           day<span class="token operator">=</span><span class="token punctuation">$(</span>date -d yesterday +<span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span>                  <span class="token comment" spellcheck="true"># æ—¥æœŸä½œä¸ºæ—¥å¿—çš„æ ‡è¯†</span><span class="token function">mkdir</span> -p <span class="token variable">$base_path</span>/<span class="token variable">$log_path</span>                   <span class="token comment" spellcheck="true"># æ ¹æ®å¹´æœˆç®¡ç†æ—¥å¿—</span><span class="token function">mv</span> <span class="token variable">$base_path</span>/access.log <span class="token variable">$base_path</span>/<span class="token variable">$log_path</span>/access_<span class="token variable">$day</span>.log<span class="token function">mv</span> <span class="token variable">$base_path</span>/error.log <span class="token variable">$base_path</span>/<span class="token variable">$log_path</span>/error_<span class="token variable">$day</span>.log<span class="token keyword">echo</span> <span class="token variable">$base_path</span>/<span class="token variable">$log_path</span>/access_<span class="token variable">$day</span>.log<span class="token function">kill</span> -USR1 <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> /usr/local/nginx/logs/nginx.pid<span class="token variable">`</span></span>   <span class="token comment" spellcheck="true"># ä¿¡å·é€šçŸ¥nginxé‡æ–°å¼€å§‹è®°å½•æ—¥å¿—</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntuå®‰è£…netstatç½‘ç»œå·¥å…·</title>
      <link href="/4702ce8d/"/>
      <url>/4702ce8d/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><blockquote><p>ç”Ÿäº§è¿‡ç¨‹ä¸­ä¸šåŠ¡å¤§éƒ¨åˆ†éƒ½æ˜¯åœ¨jreé•œåƒä¸­è¿è¡Œï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦åˆ°æœåŠ¡é‡Œé¢æ’æŸ¥é—®é¢˜ä½†æ˜¯è‹¦äºæ²¡æœ‰å¾ˆå¤šå‘½ä»¤ã€‚æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ç”¨aptå®‰è£…ä¸‹</p></blockquote><h3 id="é…ç½®aptæº"><a href="#é…ç½®aptæº" class="headerlink" title="é…ç½®aptæº"></a>é…ç½®aptæº</h3><p>é»˜è®¤æƒ…å†µä¸‹jreé•œåƒçš„aptæºä¸ºå›½å¤–å½“æˆ‘ä»¬æ‰§è¡Œapt installä¼šåˆ°å›½å¤–å»è¯·æ±‚ï¼Œæ˜¯æ— æ³•æ­£å¸¸ä¸‹è½½çš„ï¼Œä¹Ÿä¼šæ¯”è¾ƒæ…¢</p><pre class=" language-bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> net-toolsReading package lists<span class="token punctuation">..</span>. DoneBuilding dependency treeReading state information<span class="token punctuation">..</span>. DoneThe following NEW packages will be installed:net-tools0 upgraded, 1 newly installed, 0 to remove and 42 not upgraded.Need to get 248 kB of archives.After this operation, 1002 kB of additional disk space will be used.Get:1 http://deb.debian.org/debian buster/main amd64 net-tools amd64 1.60+git20180626.aebd88e-1 <span class="token punctuation">[</span>248 kB<span class="token punctuation">]</span>61% <span class="token punctuation">[</span>1 net-tools 190 kB/248 kB 77%<span class="token punctuation">]</span> 3723 B/s 15s</code></pre><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†aptæºä¿®æ”¹ä¸ºå›½å†…çš„<br>å¤‡ä»½æºæ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash"><span class="token function">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak</code></pre><p>ä¿®æ”¹aptæºæ–‡ä»¶ï¼ˆè¿™é‡Œä½¿ç”¨çš„é˜¿é‡Œäº‘æºï¼‰</p><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span>/etc/apt/sources.list <span class="token operator">&lt;&lt;</span><span class="token string">EOFdeb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiversdeb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverseEOF</span></code></pre><p>æ›´æ–°æº</p><pre class=" language-bash"><code class="language-bash"><span class="token function">apt-get</span> updateÂ·Â·Â·e public key is not available: NO_PUBKEY 3B4FE6ACC0B21F32E: The repository <span class="token string">'http://mirrors.aliyun.com/ubuntu bionic-backports InRelease'</span> is not signed.N: Updating from such a repository can<span class="token string">'t be done securely, and is therefore disabled by default.N: See apt-secure(8) manpage for repository creation and user configuration details.W: GPG error: http://mirrors.aliyun.com/ubuntu bionic-proposed InRelease: The following signatures couldn'</span>t be verified because the public key is not available: NO_PUBKEY 3B4FE6ACC0B21F32E: The repository <span class="token string">'http://mirrors.aliyun.com/ubuntu bionic-proposed InRelease'</span> is not signed.N: Updating from such a repository can't be <span class="token keyword">done</span> securely, and is therefore disabled by default.N: See apt-secure<span class="token punctuation">(</span>8<span class="token punctuation">)</span> manpage <span class="token keyword">for</span> repository creation and user configuration details.</code></pre><p>è¿™é‡Œå¯èƒ½ä¼šåŒ…è¿™ä¸ªé”™è¯¯åŸå› æ˜¯ç¼ºå°‘å…¬é’¥</p><p>è§£å†³æ–¹æ¡ˆ</p><pre class=" language-bash"><code class="language-bash">apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 40976EAF437D05B5Executing: /tmp/apt-key-gpghome.3CPxCTYb74/gpg.1.sh --keyserver keyserver.ubuntu.com --recv-keys 40976EAF437D05B5gpg: key 40976EAF437D05B5: public key <span class="token string">"Ubuntu Archive Automatic Signing Key &lt;ftpmaster@ubuntu.com>"</span> importedgpg: Total number processed: 1gpg: imported: 1apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 3B4FE6ACC0B21F32Executing: /tmp/apt-key-gpghome.D6x3xpJKO1/gpg.1.sh --keyserver keyserver.ubuntu.com --recv-keys 3B4FE6ACC0B21F32gpg: key 3B4FE6ACC0B21F32: public key <span class="token string">"Ubuntu Archive Automatic Signing Key (2012) &lt;ftpmaster@ubuntu.com>"</span> importedgpg: Total number processed: 1gpg: imported: 1</code></pre><p>å†æ¬¡æ‰§è¡Œupdate</p><pre class=" language-bash"><code class="language-bash"><span class="token function">apt-get</span> updateGet:1 http://mirrors.aliyun.com/ubuntu bionic InRelease <span class="token punctuation">[</span>242 kB<span class="token punctuation">]</span>Get:2 http://mirrors.aliyun.com/ubuntu bionic-security InRelease <span class="token punctuation">[</span>88.7 kB<span class="token punctuation">]</span>Get:3 http://mirrors.aliyun.com/ubuntu bionic-updates InRelease <span class="token punctuation">[</span>88.7 kB<span class="token punctuation">]</span>Get:4 http://mirrors.aliyun.com/ubuntu bionic-backports InRelease <span class="token punctuation">[</span>83.3 kB<span class="token punctuation">]</span>Get:5 http://mirrors.aliyun.com/ubuntu bionic-proposed InRelease <span class="token punctuation">[</span>242 kB<span class="token punctuation">]</span>Get:6 http://mirrors.aliyun.com/ubuntu bionic/multiverse Sources <span class="token punctuation">[</span>181 kB<span class="token punctuation">]</span>Get:7 http://mirrors.aliyun.com/ubuntu bionic/restricted Sources <span class="token punctuation">[</span>5324 B<span class="token punctuation">]</span>Get:8 http://mirrors.aliyun.com/ubuntu bionic/main Sources <span class="token punctuation">[</span>829 kB<span class="token punctuation">]</span>Get:9 http://mirrors.aliyun.com/ubuntu bionic/universe Sources <span class="token punctuation">[</span>9051 kB<span class="token punctuation">]</span>Get:10 http://mirrors.aliyun.com/ubuntu bionic/main amd64 Packages <span class="token punctuation">[</span>1019 kB<span class="token punctuation">]</span>Get:11 http://mirrors.aliyun.com/ubuntu bionic/universe amd64 Packages <span class="token punctuation">[</span>8570 kB<span class="token punctuation">]</span>Get:12 http://mirrors.aliyun.com/ubuntu bionic/restricted amd64 Packages <span class="token punctuation">[</span>9184 B<span class="token punctuation">]</span>Get:13 http://mirrors.aliyun.com/ubuntu bionic/multiverse amd64 Packages <span class="token punctuation">[</span>151 kB<span class="token punctuation">]</span>Get:14 http://mirrors.aliyun.com/ubuntu bionic-security/multiverse Sources <span class="token punctuation">[</span>10.6 kB<span class="token punctuation">]</span></code></pre><p>å†æ¬¡æ‰§è¡Œå®‰è£…å°±å¾ˆå¿«äº†</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx æ¨¡å—headers-more-nginx-moduleè¯¦è§£</title>
      <link href="/89d16fdf/"/>
      <url>/89d16fdf/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>å†ç”¨nginxåšåå‘ä»£ç†çš„æ—¶å€™,æˆ‘ä»¬ç»å¸¸ä¼šæœ‰éœ€æ±‚éœ€è¦ä¿®æ”¹Nginxé»˜è®¤çš„Header.è¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦<code>headers-more-nginx-module</code>æ¥å®ç°ä¸€äº›é¢å¤–çš„éœ€æ±‚</p><h3 id="ä¿®æ”¹æ™®é€šè¯·æ±‚çš„Header"><a href="#ä¿®æ”¹æ™®é€šè¯·æ±‚çš„Header" class="headerlink" title="ä¿®æ”¹æ™®é€šè¯·æ±‚çš„Header"></a>ä¿®æ”¹æ™®é€šè¯·æ±‚çš„Header</h3><p>nginxå†…ç½®çš„æ¨¡å—å°±æŒ‡å‡ºä¿®æ”¹å“åº”å¤´,ä½¿ç”¨æ–¹æ³•ä¸º<code>add_header</code>.è¿™æ˜¯å› ä¸ºnginxé»˜è®¤å®‰è£…å°±é™„å¸¦äº†<code>ngx_http_headers_module</code>,ç”¨äºè®¾ç½®response header</p><h5 id="ä½¿ç”¨æ–¹æ³•"><a href="#ä½¿ç”¨æ–¹æ³•" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h5><pre class=" language-bash"><code class="language-bash">add_header Cache-Control no-store<span class="token punctuation">;</span>add_header Content-Encoding <span class="token function">gzip</span><span class="token punctuation">;</span></code></pre><h3 id="ä¿®æ”¹åå‘ä»£ç†è¯·æ±‚çš„Header"><a href="#ä¿®æ”¹åå‘ä»£ç†è¯·æ±‚çš„Header" class="headerlink" title="ä¿®æ”¹åå‘ä»£ç†è¯·æ±‚çš„Header"></a>ä¿®æ”¹åå‘ä»£ç†è¯·æ±‚çš„Header</h3><p>è¿™é‡Œä¼šä½¿ç”¨åˆ°<code>proxy_set_header</code>æ¥è‡ªå†…ç½®æ¨¡å—<code>ngx_http_proxy_module</code>ç”¨æ¥é‡å®šä¹‰å‘å¾€ä»£ç†æœåŠ¡å™¨æœåŠ¡å™¨çš„è¯·æ±‚å¤´</p><h5 id="ä½¿ç”¨æ–¹æ³•-1"><a href="#ä½¿ç”¨æ–¹æ³•-1" class="headerlink" title="ä½¿ç”¨æ–¹æ³•"></a>ä½¿ç”¨æ–¹æ³•</h5><pre class=" language-bash"><code class="language-bash">    proxy_set_header host <span class="token variable">$http_host</span><span class="token punctuation">;</span>    proxy_set_header x-real-ip <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>    proxy_set_header x-forwarded-for <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span></code></pre><h3 id="headers-more-nginx-module-æ¨¡å—"><a href="#headers-more-nginx-module-æ¨¡å—" class="headerlink" title="headers-more-nginx-module æ¨¡å—"></a>headers-more-nginx-module æ¨¡å—</h3><p>headers-more-nginx-module æ¨¡å—ç”¨äºæ·»åŠ ã€ä¿®æ”¹æˆ–æ¸…é™¤ è¯·æ±‚&#x2F;å“åº”å¤´ï¼Œè¯¥æ¨¡å—ä¸æ˜¯nginxè‡ªå¸¦çš„ï¼Œé»˜è®¤ä¸åŒ…å«è¯¥æ¨¡å—ï¼Œéœ€è¦å¦å¤–å®‰è£…ã€‚</p><p>ä¸‹è½½å’Œå®‰è£…æ–¹æ³•å¯ä»¥å‚è€ƒè¿™ä¸ªæ–‡ç« </p><p><a href="https://www.huhuhahei.cn/6abca5b8/">Nginx 1.78ç¼–è¯‘å®‰è£…</a></p><p>è¯¥æ¨¡å—ä¸»è¦æœ‰4ä¸ªæŒ‡ä»¤ï¼š</p><ul><li>more_set_headers ç”¨äºæ·»åŠ ã€ä¿®æ”¹ã€æ¸…é™¤å“åº”å¤´</li><li>more_clear_headers ç”¨äºæ¸…é™¤å“åº”å¤´</li><li>more_set_input_headers ç”¨äºæ·»åŠ ã€ä¿®æ”¹ã€æ¸…é™¤è¯·æ±‚å¤´</li><li>more_clear_input_headers ç”¨äºæ¸…é™¤è¯·æ±‚å¤´</li></ul><h5 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h5><pre class=" language-bash"><code class="language-bash"> <span class="token comment" spellcheck="true"># set the Server output header</span> more_set_headers <span class="token string">'Server: my-server'</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># set and clear output headers</span> location /bar <span class="token punctuation">{</span>     more_set_headers <span class="token string">'X-MyHeader: blah'</span> <span class="token string">'X-MyHeader2: foo'</span><span class="token punctuation">;</span>     more_set_headers -t <span class="token string">'text/plain text/css'</span> <span class="token string">'Content-Type: text/foo'</span><span class="token punctuation">;</span>     more_set_headers -s <span class="token string">'400 404 500 503'</span> -s 413 <span class="token string">'Foo: Bar'</span><span class="token punctuation">;</span>     more_clear_headers <span class="token string">'Content-Type'</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"># your proxy_pass/memcached_pass/or any other config goes here...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true"># set output headers</span> location /type <span class="token punctuation">{</span>     more_set_headers <span class="token string">'Content-Type: text/plain'</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"># ...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true"># set input headers</span> location /foo <span class="token punctuation">{</span>     <span class="token keyword">set</span> <span class="token variable">$my_host</span> <span class="token string">'my dog'</span><span class="token punctuation">;</span>     more_set_input_headers <span class="token string">'Host: <span class="token variable">$my_host</span>'</span><span class="token punctuation">;</span>     more_set_input_headers -t <span class="token string">'text/plain'</span> <span class="token string">'X-Foo: bah'</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true"># now $host and $http_host have their new values...</span>     <span class="token comment" spellcheck="true"># ...</span> <span class="token punctuation">}</span> <span class="token comment" spellcheck="true"># replace input header X-Foo *only* if it already exists</span> more_set_input_headers -r <span class="token string">'X-Foo: howdy'</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx ingressé…ç½®é™æµ</title>
      <link href="/644a18a6/"/>
      <url>/644a18a6/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p><code>ingress</code>ä½œä¸ºç›®å‰å¸¸ç”¨çš„ç½‘å…³æœåŠ¡,åœ¨ç”Ÿäº§ä¸šåŠ¡ä¸­éš¾å…ä¼šé‡åˆ°å¾ˆå¤šçˆ¬è™«çš„ä¾µæ‰°,è¿™æ—¶å€™é…ç½®ä¸€äº›é™æµç­–ç•¥å°±æˆä¸ºä¸€ä¸ªå¿…è¦çš„äº‹æƒ….ä¹Ÿèƒ½ä¿è¯ç”Ÿäº§ç¨³å®šæ€§,é¿å…æœåŠ¡å™¨èµ„æºè¿‡å¤šæŸè€—.</p><h3 id="é™æµé…ç½®"><a href="#é™æµé…ç½®" class="headerlink" title="é™æµé…ç½®"></a>é™æµé…ç½®</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">annotations</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx.ingress.kubernetes.io/limit-connection</span><span class="token punctuation">:</span> <span class="token number">10 </span><span class="token comment" spellcheck="true">#å•ä¸ªIPçš„å¹¶å‘è¯·æ±‚æ•°</span>  <span class="token key atrule">nginx.ingress.kubernetes.io/limit-rps</span><span class="token punctuation">:</span> <span class="token number">5 </span><span class="token comment" spellcheck="true">#æ¯ç§’é™åˆ¶å•ä¸ªIPè®¿é—®æ¬¡æ•°,çªå‘é™åˆ¶ä¸ºæ­¤ä¹˜ä»¥çªå‘ä¹˜æ•°,é»˜è®¤5</span>  <span class="token key atrule">nginx.ingress.kubernetes.io/limit-burst-multiplier</span><span class="token punctuation">:</span> <span class="token number">3 </span><span class="token comment" spellcheck="true">#çªå‘é™åˆ¶é€Ÿç‡çš„å€æ•°</span>  <span class="token key atrule">nginx.ingress.kubernetes.io/limit-whitelist</span><span class="token punctuation">:</span> x.x.x.x <span class="token comment" spellcheck="true">#é™æµç™½åå•</span></code></pre><blockquote><p>å½“æˆ‘ä»¬é…ç½®é™æµå,ç”¨æˆ·è®¿é—®å½“è¶…è¿‡æ¯ç§’15qpså,<code>ingress</code>å°±ä¼šè¿”å›503.ä½†æ˜¯503ä½œä¸ºä¸€ä¸ªæœåŠ¡å¼‚å¸¸çš„çŠ¶æ€å—,å®¹æ˜“å½±å“æˆ‘ä»¬çš„æ—¥å¿—åˆ†æç»“æœ,æ‰€ä»¥è¿™é‡Œå»ºè®®å°†<code>ingress</code>è¿”å›çš„çŠ¶æ€å—ä¿®æ”¹ä¸º429</p></blockquote><p>é…ç½®å¦‚ä¸‹</p><p>åœ¨<code>ingress</code>çš„<code>nginx-configuration</code>æ–‡ä»¶ä¸­æ·»åŠ </p><pre class=" language-yaml"><code class="language-yaml">  <span class="token key atrule">limit-req-status-code</span><span class="token punctuation">:</span> <span class="token string">'429'</span></code></pre><p>è¿™æ ·é™æµåè¿”å›çš„å°±æ˜¯429,ä¸ä¼šå½±å“æ—¥å¿—åˆ†æç»“æœ</p><h3 id="é…ç½®é’ˆå¯¹çˆ¬è™«çš„user-agent"><a href="#é…ç½®é’ˆå¯¹çˆ¬è™«çš„user-agent" class="headerlink" title="é…ç½®é’ˆå¯¹çˆ¬è™«çš„user-agent"></a>é…ç½®é’ˆå¯¹çˆ¬è™«çš„<code>user-agent</code></h3><p>é»˜è®¤çˆ¬è™«çš„<code>user-agent</code>ä¸º<code>python-requests/2.27.1</code></p><p>æˆ‘ä»¬å¯ä»¥åœ¨ingressä¸­é’ˆå¯¹è¿™ä¸ª<code>user-agent</code>åšé™åˆ¶,è¿”å›404</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">nginx.ingress.kubernetes.io/server-snippet</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>      set $agentflag 0;              if ($http_user_agent ~* "python<span class="token punctuation">-</span>requests/2.27.1" )<span class="token punctuation">{</span>                set $agentflag 1;              <span class="token punctuation">}</span>              if ( $agentflag = 1 ) <span class="token punctuation">{</span>                return 404;              <span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>chaos å‹æµ‹å¹³å°</title>
      <link href="/61e9a7b2/"/>
      <url>/61e9a7b2/</url>
      
        <content type="html"><![CDATA[<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p><code>Chaos Mesh</code> æ˜¯ä¸€ä¸ªå¼€æºçš„äº‘åŸç”Ÿæ··æ²Œå·¥ç¨‹å¹³å°ï¼Œæä¾›ä¸°å¯Œçš„æ•…éšœæ¨¡æ‹Ÿç±»å‹ï¼Œå…·æœ‰å¼ºå¤§çš„æ•…éšœåœºæ™¯ç¼–æ’èƒ½åŠ›ï¼Œæ–¹ä¾¿ç”¨æˆ·åœ¨å¼€å‘æµ‹è¯•ä¸­ä»¥åŠç”Ÿäº§ç¯å¢ƒä¸­æ¨¡æ‹Ÿç°å®ä¸–ç•Œä¸­å¯èƒ½å‡ºç°çš„å„ç±»å¼‚å¸¸ï¼Œå¸®åŠ©ç”¨æˆ·å‘ç°ç³»ç»Ÿæ½œåœ¨çš„é—®é¢˜ã€‚<code>Chaos Mesh</code> æä¾›å®Œå–„çš„å¯è§†åŒ–æ“ä½œï¼Œæ—¨åœ¨é™ä½ç”¨æˆ·è¿›è¡Œæ··æ²Œå·¥ç¨‹çš„é—¨æ§›ã€‚ç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°åœ¨<code>Web UI</code>ç•Œé¢ä¸Šè®¾è®¡è‡ªå·±çš„æ··æ²Œåœºæ™¯ï¼Œä»¥åŠç›‘æ§æ··æ²Œå®éªŒçš„è¿è¡ŒçŠ¶æ€ã€‚</p><h3 id="æ ¸å¿ƒä¼˜åŠ¿"><a href="#æ ¸å¿ƒä¼˜åŠ¿" class="headerlink" title="æ ¸å¿ƒä¼˜åŠ¿"></a>æ ¸å¿ƒä¼˜åŠ¿</h3><p>Chaos Mesh ä½œä¸ºä¸šå†…é¢†å…ˆçš„æ··æ²Œæµ‹è¯•å¹³å°ï¼Œå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒä¼˜åŠ¿ï¼š</p><ul><li>æ ¸å¿ƒèƒ½åŠ›ç¨³å›ºï¼š<code>Chaos Mesh</code> èµ·æºäº <code>TiDB</code> çš„æ ¸å¿ƒæµ‹è¯•å¹³å°ï¼Œå‘å¸ƒåˆæœŸå³ç»§æ‰¿äº†å¤§é‡ <code>TiDB</code> å·²æœ‰çš„æµ‹è¯•ç»éªŒã€‚</li><li>è¢«å……åˆ†éªŒè¯ï¼š<code>Chaos Mesh</code> è¢«ä¼—å¤šå…¬å¸ä»¥åŠç»„ç»‡æ‰€ä½¿ç”¨ï¼Œä¾‹å¦‚è…¾è®¯å’Œç¾å›¢ç­‰ï¼›åŒæ—¶è¢«ç”¨äºä¼—å¤šçŸ¥ååˆ†å¸ƒå¼ç³»ç»Ÿçš„æµ‹è¯•ä½“ç³»ä¸­ï¼Œä¾‹å¦‚ <code>Apache APISIX </code>å’Œ <code>RabbitMQ</code> ç­‰ã€‚</li><li>ç³»ç»Ÿæ˜“ç”¨æ€§å¼ºï¼šå›¾å½¢åŒ–æ“ä½œå’ŒåŸºäº <code>Kubernetes</code> çš„ä½¿ç”¨æ–¹å¼ï¼Œå……åˆ†åˆ©ç”¨äº†è‡ªåŠ¨åŒ–èƒ½åŠ›ã€‚</li><li>äº‘åŸç”Ÿï¼š<code>Chaos Mesh</code> åŸç”Ÿæ”¯æŒ <code>Kubernetes</code> ç¯å¢ƒï¼Œæä¾›äº†å¼ºæ‚çš„è‡ªåŠ¨åŒ–èƒ½åŠ›ã€‚</li><li>ä¸°å¯Œçš„æ•…éšœæ¨¡æ‹Ÿåœºæ™¯ï¼šChaos Mesh å‡ ä¹æ¶µç›–äº†åˆ†å¸ƒå¼æµ‹è¯•ä½“ç³»ä¸­åŸºç¡€æ•…éšœæ¨¡æ‹Ÿçš„ç»å¤§å¤šæ•°åœºæ™¯ã€‚</li><li>çµæ´»çš„å®éªŒç¼–æ’èƒ½åŠ›ï¼šç”¨æˆ·å¯ä»¥é€šè¿‡å¹³å°è®¾è®¡è‡ªå·±çš„æ··æ²Œå®éªŒåœºæ™¯ï¼Œåœºæ™¯å¯åŒ…å«å¤šä¸ªæ··æ²Œå®éªŒç¼–æ’ï¼Œä»¥åŠåº”ç”¨çŠ¶æ€æ£€æŸ¥ç­‰ã€‚</li><li>å®‰å…¨æ€§é«˜ï¼š<code>Chaos Mesh</code> å…·æœ‰å¤šå±‚æ¬¡å®‰å…¨æ§åˆ¶è®¾è®¡ï¼Œæä¾›é«˜å®‰å…¨æ€§ã€‚</li><li>æ´»è·ƒçš„ç¤¾åŒºï¼š<code>Chaos Mesh</code> ä¸ºå…¨çƒçŸ¥åå¼€æºæ··æ²Œæµ‹è¯•å¹³å°ï¼Œ<code>CNCF</code> å¼€æºåŸºé‡‘ä¼šå­µåŒ–é¡¹ç›®ã€‚</li><li>å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›ï¼š<code>Chaos Mesh</code> ä¸ºæ•…éšœæµ‹è¯•ç±»å‹æ‰©å±•å’ŒåŠŸèƒ½æ‰©å±•æä¾›äº†å……åˆ†çš„æ‰©å±•èƒ½åŠ›ã€‚</li></ul><h3 id="æ¶æ„æ¦‚è§ˆ"><a href="#æ¶æ„æ¦‚è§ˆ" class="headerlink" title="æ¶æ„æ¦‚è§ˆ"></a>æ¶æ„æ¦‚è§ˆ</h3><p><code>Chaos Mesh</code> åŸºäº <code>Kubernetes CRD (Custom Resource Definition) </code>æ„å»ºï¼Œæ ¹æ®ä¸åŒçš„æ•…éšœç±»å‹å®šä¹‰å¤šä¸ª CRD ç±»å‹ï¼Œå¹¶ä¸ºä¸åŒçš„ CRD å¯¹è±¡å®ç°å•ç‹¬çš„ <code>Controller</code> ä»¥ç®¡ç†ä¸åŒçš„æ··æ²Œå®éªŒã€‚<code>Chaos Mesh</code> ä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªç»„ä»¶:</p><ul><li><code>Chaos Dashboard</code>ï¼šChaos Mesh çš„å¯è§†åŒ–ç»„ä»¶ï¼Œæä¾›äº†ä¸€å¥—ç”¨æˆ·å‹å¥½çš„ Web ç•Œé¢ï¼Œç”¨æˆ·å¯é€šè¿‡è¯¥ç•Œé¢å¯¹æ··æ²Œå®éªŒè¿›è¡Œæ“ä½œå’Œè§‚æµ‹ã€‚åŒæ—¶ï¼ŒChaos Dashboard è¿˜æä¾›äº† RBAC æƒé™ç®¡ç†æœºåˆ¶ã€‚</li><li><code>Chaos Controller Manager</code>ï¼šChaos Mesh çš„æ ¸å¿ƒé€»è¾‘ç»„ä»¶ï¼Œä¸»è¦è´Ÿè´£æ··æ²Œå®éªŒçš„è°ƒåº¦ä¸ç®¡ç†ã€‚è¯¥ç»„ä»¶åŒ…å«å¤šä¸ª CRD Controllerï¼Œä¾‹å¦‚ Workflow Controllerã€Scheduler Controller ä»¥åŠå„ç±»æ•…éšœç±»å‹çš„ Controllerã€‚</li><li><code>Chaos Daemon</code>ï¼šChaos Mesh çš„ä¸»è¦æ‰§è¡Œç»„ä»¶ã€‚Chaos Daemon ä»¥ DaemonSet çš„æ–¹å¼è¿è¡Œï¼Œé»˜è®¤æ‹¥æœ‰ Privileged æƒé™ï¼ˆå¯ä»¥å…³é—­ï¼‰ã€‚è¯¥ç»„ä»¶ä¸»è¦é€šè¿‡ä¾µå…¥ç›®æ ‡ Pod Namespace çš„æ–¹å¼å¹²æ‰°å…·ä½“çš„ç½‘ç»œè®¾å¤‡ã€æ–‡ä»¶ç³»ç»Ÿã€å†…æ ¸ç­‰ã€‚</li></ul><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/09/architecture-76301820de324f79d79db310b11b9246.png"></p><p><code>Chaos Mesh</code> çš„æ•´ä½“æ¶æ„å¦‚ä¸Šå›¾æ‰€å±•ç¤ºï¼Œå¯ä»¥è‡ªä¸Šè€Œä¸‹åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>ç”¨æˆ·è¾“å…¥å’Œè§‚æµ‹çš„éƒ¨åˆ†ã€‚ç”¨æˆ·è¾“å…¥ä»¥ç”¨æˆ·æ“ä½œ (User) ä¸ºèµ·ç‚¹åˆ°è¾¾ Kubernetes API Serverã€‚ç”¨æˆ·ä¸ç›´æ¥å’Œ Chaos Mesh çš„ Controller äº¤äº’ï¼Œä¸€åˆ‡ç”¨æˆ·æ“ä½œæœ€ç»ˆéƒ½å°†åæ˜ ä¸ºæŸä¸ª Chaos èµ„æºçš„å˜æ›´ï¼ˆæ¯”å¦‚ NetworkChaos èµ„æºçš„å˜æ›´ï¼‰ã€‚</li><li>ç›‘å¬èµ„æºå˜åŒ–ã€è°ƒåº¦ Workflow å’Œå¼€å±•æ··æ²Œå®éªŒçš„éƒ¨åˆ†ã€‚Chaos Mesh çš„ Controller åªæ¥å—æ¥è‡ª Kubernetes API Server çš„äº‹ä»¶ï¼Œè¿™ç§äº‹ä»¶æè¿°æŸä¸ª Chaos èµ„æºçš„å˜æ›´ï¼Œä¾‹å¦‚æ–°çš„ Workflow å¯¹è±¡æˆ–è€… Chaos å¯¹è±¡è¢«åˆ›å»ºã€‚</li><li>å…·ä½“èŠ‚ç‚¹æ•…éšœçš„æ³¨å…¥éƒ¨åˆ†ã€‚è¯¥éƒ¨åˆ†ä¸»è¦ç”± Chaos Daemon ç»„ä»¶è´Ÿè´£ï¼Œæ¥å—æ¥è‡ª Chaos Controller Manager ç»„ä»¶çš„æŒ‡ä»¤ï¼Œä¾µå…¥åˆ°ç›®æ ‡ Pod çš„ Namespace ä¸‹ï¼Œæ‰§è¡Œå…·ä½“çš„æ•…éšœæ³¨å…¥ã€‚ä¾‹å¦‚è®¾ç½® TC ç½‘ç»œè§„åˆ™ï¼Œå¯åŠ¨ stress-ng è¿›ç¨‹æŠ¢å  CPU æˆ–å†…å­˜èµ„æºç­‰ã€‚</li></ul><h3 id="éƒ¨ç½²å®‰è£…"><a href="#éƒ¨ç½²å®‰è£…" class="headerlink" title="éƒ¨ç½²å®‰è£…"></a>éƒ¨ç½²å®‰è£…</h3><p>åœ¨ Helm ä»“åº“ä¸­æ·»åŠ  Chaos Mesh ä»“åº“ï¼š</p><pre class=" language-bash"><code class="language-bash">helm repo add chaos-mesh https://charts.chaos-mesh.org</code></pre><p>æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æ˜¾ç¤ºå¯ä»¥å®‰è£…çš„ chartsï¼š</p><pre class=" language-bash"><code class="language-bash">helm search repo chaos-mesh</code></pre><p>åˆ›å»ºchaos meshç©ºé—´</p><pre class=" language-bash"><code class="language-bash">kubectl create ns chaos-testing</code></pre><p>å®‰è£…</p><pre class=" language-bash"><code class="language-bash">helm <span class="token function">install</span> chaos-mesh chaos-mesh/chaos-mesh -n<span class="token operator">=</span>chaos-testing</code></pre><p>æŸ¥çœ‹å®‰è£…ç»“æœ</p><pre class=" language-bash"><code class="language-bash">kubectl get po -n chaos-testing NAME                                        READY   STATUS    RESTARTS   AGEchaos-controller-manager-59f8fbff8c-676dk   1/1     Running   0          3dchaos-controller-manager-59f8fbff8c-fh5rg   1/1     Running   0          3dchaos-controller-manager-59f8fbff8c-szxcm   1/1     Running   0          3dchaos-daemon-6sq9d                          1/1     Running   0          3dchaos-daemon-6sw9f                          1/1     Running   0          3dchaos-daemon-9kf28                          1/1     Running   0          3dchaos-daemon-9wfr2                          1/1     Running   0          3dchaos-daemon-d28cr                          1/1     Running   0          3dchaos-daemon-dvfrf                          1/1     Running   0          3dchaos-daemon-fnqb7                          1/1     Running   0          3dchaos-daemon-qmhhb                          1/1     Running   0          3dchaos-daemon-qq694                          1/1     Running   0          3dchaos-daemon-vcljq                          1/1     Running   0          3dchaos-daemon-xls68                          1/1     Running   0          3dchaos-dashboard-576f555c86-7cqjv            1/1     Running   0          3d</code></pre><p>ç™»é™†uiç•Œé¢ dashboardçš„2333å¯¹åº”çš„ç«¯å£</p><pre class=" language-bash"><code class="language-bash">kubectl get svc -n chaos-testing NAME                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                 AGEchaos-daemon                    ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">></span>        31767/TCP,31766/TCP                     3d3hchaos-dashboard                 NodePort    192.168.21.201   <span class="token operator">&lt;</span>none<span class="token operator">></span>        2333:30615/TCP,2334:30433/TCP           3d3hchaos-mesh-controller-manager   ClusterIP   192.168.22.228   <span class="token operator">&lt;</span>none<span class="token operator">></span>        443/TCP,10081/TCP,10082/TCP,10080/TCP   3d3h</code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DevOps </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu å®‰è£…Openresty</title>
      <link href="/978c032f/"/>
      <url>/978c032f/</url>
      
        <content type="html"><![CDATA[<h3 id="ç³»ç»Ÿç‰ˆæœ¬"><a href="#ç³»ç»Ÿç‰ˆæœ¬" class="headerlink" title="ç³»ç»Ÿç‰ˆæœ¬"></a>ç³»ç»Ÿç‰ˆæœ¬</h3><pre class=" language-bash"><code class="language-bash">lsb_release -a LSB Version:    core-11.1.0ubuntu2-noarch:security-11.1.0ubuntu2-noarchDistributor ID: UbuntuDescription:    Ubuntu 20.04.4 LTSRelease:        20.04Codename:       focal</code></pre><h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">apt-get</span> update -y<span class="token function">apt-get</span> <span class="token function">install</span> -y libpcre3-dev libssl-dev perl <span class="token function">make</span> build-essential curl zlib1g-dev</code></pre><h3 id="é…ç½®OpenResty"><a href="#é…ç½®OpenResty" class="headerlink" title="é…ç½®OpenResty"></a>é…ç½®OpenResty</h3><h5 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h5><pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> /optcurl -LO https://openresty.org/download/openresty-1.19.3.2.tar.gz<span class="token function">tar</span> zxf openresty-1.19.3.2.tar.gz</code></pre><h5 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h5><pre class=" language-bash"><code class="language-bash">./configure --with-http_gzip_static_module --with-http_v2_module --with-http_stub_status_module<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><h3 id="é…ç½®systemæ§åˆ¶"><a href="#é…ç½®systemæ§åˆ¶" class="headerlink" title="é…ç½®systemæ§åˆ¶"></a>é…ç½®systemæ§åˆ¶</h3><h5 id="åˆ›å»ºserviceæ–‡ä»¶"><a href="#åˆ›å»ºserviceæ–‡ä»¶" class="headerlink" title="åˆ›å»ºserviceæ–‡ä»¶"></a>åˆ›å»ºserviceæ–‡ä»¶</h5><p>åœ¨ <code>/usr/lib/systemd/system</code> ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª <code>openresty.service</code> æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># Stop dance for OpenResty</span><span class="token comment" spellcheck="true"># =========================</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># ExecStop sends SIGSTOP (graceful stop) to OpenResty's nginx process.</span><span class="token comment" spellcheck="true"># If, after 5s (--retry QUIT/5) nginx is still running, systemd takes control</span><span class="token comment" spellcheck="true"># and sends SIGTERM (fast shutdown) to the main process.</span><span class="token comment" spellcheck="true"># After another 5s (TimeoutStopSec=5), and if nginx is alive, systemd sends</span><span class="token comment" spellcheck="true"># SIGKILL to all the remaining processes in the process group (KillMode=mixed).</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># nginx signals reference doc:</span><span class="token comment" spellcheck="true"># http://nginx.org/en/docs/control.html</span><span class="token comment" spellcheck="true">#</span><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>Description<span class="token operator">=</span>The OpenResty Application PlatformAfter<span class="token operator">=</span>syslog.target network-online.target remote-fs.target nss-lookup.targetWants<span class="token operator">=</span>network-online.target<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>Type<span class="token operator">=</span>forkingPIDFile<span class="token operator">=</span>/usr/local/openresty/nginx/logs/nginx.pidExecStartPre<span class="token operator">=</span>/usr/local/openresty/nginx/sbin/nginx -t -q -g <span class="token string">'daemon on; master_process on;'</span>ExecStart<span class="token operator">=</span>/usr/local/openresty/nginx/sbin/nginx -g <span class="token string">'daemon on; master_process on;'</span>ExecReload<span class="token operator">=</span>/usr/local/openresty/nginx/sbin/nginx -g <span class="token string">'daemon on; master_process on;'</span> -s reloadExecStop<span class="token operator">=</span>-/sbin/start-stop-daemon --quiet --stop --retry QUIT/5 --pidfile /usr/local/openresty/nginx/logs/nginx.pidTimeoutStopSec<span class="token operator">=</span>5KillMode<span class="token operator">=</span>mixed<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>WantedBy<span class="token operator">=</span>multi-user.target</code></pre><h5 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h5><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># è®¾ç½®è‡ªå¯åŠ¨</span>systemctl <span class="token function">enable</span> openresty<span class="token comment" spellcheck="true"># å¯åŠ¨ OpenResty</span>systemctl start openresty<span class="token comment" spellcheck="true"># æŸ¥çœ‹çŠ¶æ€</span>systemctl status openrestyâ— openresty.service - The OpenResty Application Platform     Loaded: loaded <span class="token punctuation">(</span>/lib/systemd/system/openresty.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>     Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Fri 2022-08-26 15:42:53 CST<span class="token punctuation">;</span> 16min ago    Process: 20277 ExecStartPre<span class="token operator">=</span>/usr/local/openresty/nginx/sbin/nginx -t -q -g daemon on<span class="token punctuation">;</span> master_process on<span class="token punctuation">;</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>    Process: 20288 ExecStart<span class="token operator">=</span>/usr/local/openresty/nginx/sbin/nginx -g daemon on<span class="token punctuation">;</span> master_process on<span class="token punctuation">;</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>   Main PID: 20289 <span class="token punctuation">(</span>nginx<span class="token punctuation">)</span>      Tasks: 6 <span class="token punctuation">(</span>limit: 9156<span class="token punctuation">)</span>     Memory: 113.5M     CGroup: /system.slice/openresty.service             â”œâ”€20289 nginx: master process /usr/local/openresty/nginx/sbin/nginx -g daemon on<span class="token punctuation">;</span> master_process on<span class="token punctuation">;</span>             â”œâ”€20290 nginx: worker process             â”œâ”€20291 nginx: worker process             â”œâ”€20292 nginx: worker process             â”œâ”€20293 nginx: worker process             ï¿½ï¿½â”€20294 nginx: cache manager processAug 26 15:42:53 steamproxy-openresty systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting The OpenResty Application Platform<span class="token punctuation">..</span>.Aug 26 15:42:53 steamproxy-openresty systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Started The OpenResty Application Platform.</code></pre>]]></content>
      
      
      <categories>
          
          <category> Nginx </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®°å½•ä¸€ä¸ªç”Ÿäº§Nacosæ³¨å†Œä¸­å¿ƒè¿æ¥å¤±è´¥çš„é—®é¢˜</title>
      <link href="/7b74f61c/"/>
      <url>/7b74f61c/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æ˜¨æ—¥å¼€å‘åŒäº‹éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æœåŠ¡,æœåŠ¡åˆ›å»ºå®Œæˆå‘ç°å¯åŠ¨çš„æ—¶å€™æœ‰é—®é¢˜,æ— æ³•æ­£å¸¸è¿æ¥nacosçš„æ³¨å†Œä¸­å¿ƒ.å’Œå¼€å‘æ²Ÿé€šäº†ä¸‹çŸ¥é“è¿™ä¸ªæœåŠ¡çš„<code>nacos-client</code>ç‰ˆæœ¬æ˜¯2.xçš„ çœ‹äº†ä¸‹devç¯å¢ƒçš„ä¹Ÿæ˜¯2.xçš„</p><h3 id="é—®é¢˜åˆ†æ"><a href="#é—®é¢˜åˆ†æ" class="headerlink" title="é—®é¢˜åˆ†æ"></a>é—®é¢˜åˆ†æ</h3><p>æ ¹æ®ä¸€ä¸‹æŠ¥é”™æœç´¢,å¤§éƒ¨åˆ†ç»“è®ºéƒ½æ˜¯2.xçš„å®¢æˆ·ç«¯è¯·æ±‚äº† 1.xçš„æœåŠ¡ç«¯å¯¼è‡´çš„ å¾ˆæ˜æ˜¾ä¸ç¬¦åˆè¿™æ¬¡çš„æƒ…å†µ</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/08/731EDA8F-F1E8-40DB-8735-ABF32CC4927C.png"></p><p>å†æ¬¡æŸ¥çœ‹æŠ¥é”™å‘ç°æœ‰ä¸ªå…³é”®ä¿¡æ¯</p><pre class=" language-bash"><code class="language-bash">Nacos cluster is running with 1.X mode, can't accept gRPC request temporarily. Please check the server status or close Double <span class="token function">write</span> to force <span class="token function">open</span> 2.0 mode. Detail https://nacos.io/en-us/docs/2.0.0-upgrading.html.</code></pre><p>æ˜æ˜æˆ‘ä»¬çš„é›†ç¾¤æ˜¯2.xçš„ ä½†æ˜¯æ—¥å¿—æŠ¥é”™æ˜¾ç¤ºæ˜¯1.xçš„ </p><p>å†æ¬¡googleå‘ç°å¯èƒ½æ˜¯å‚æ•°é—®é¢˜å¯¼è‡´è™½ç„¶æ˜¯2.0.0ç‰ˆæœ¬ï¼Œä½†æ˜¯é›†ç¾¤çŠ¶æ€å¹¶æ²¡æœ‰å‡çº§åˆ°2.0 ä½¿ç”¨çš„ä»ç„¶æ˜¯1.Xä½“ç³»ã€‚</p><p>éœ€è¦ç”¨ä¸‹é¢çš„å‘½ä»¤ä¿®æ”¹ä¸‹</p><pre class=" language-bash"><code class="language-bash">curl -X PUT <span class="token string">'localhost:8848/nacos/v1/ns/operator/switches?entry=doubleWriteEnabled&amp;value=false'</span></code></pre><p>æ‰§è¡Œå®Œæˆé‡å¯æœåŠ¡åå‘ç°çœŸçš„å°±å¯ä»¥äº† </p>]]></content>
      
      
      <categories>
          
          <category> Nacos </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Nacos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å‡ºç°å¤§é‡time_waitè§£å†³æ–¹æ³•</title>
      <link href="/10144a6b/"/>
      <url>/10144a6b/</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨ç”Ÿäº§ä¸šåŠ¡ä¸­,æˆ‘ä»¬å¶å°”ä¼šç¢°åˆ°éƒ¨åˆ†æœåŠ¡å™¨ç›¸åº”æ¯”è¾ƒæ…¢,æŸ¥çœ‹socketsä¼šå‘ç°æœ‰å¤§é‡çš„time_wait.ä»Šå¤©æˆ‘ä»¬å°±åˆ†æä¸‹è¿™ä¸ªè¯·æ±‚çš„åŸå› </p></blockquote><h3 id="1-é—®é¢˜ç°è±¡"><a href="#1-é—®é¢˜ç°è±¡" class="headerlink" title="1.é—®é¢˜ç°è±¡"></a>1.é—®é¢˜ç°è±¡</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">netstat</span> -na <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/^tcp/ {++S[<span class="token variable">$NF</span>]} END {for(a in S) print a, S[a]}'</span>LISTEN 13ESTABLISHED 9FIN_WAIT1 1TIME_WAIT 3207<span class="token comment" spellcheck="true">#è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ‰3207ä¸ªtime_waitçš„é“¾æ¥</span></code></pre><h3 id="2-åŸç†åˆ†æ"><a href="#2-åŸç†åˆ†æ" class="headerlink" title="2.åŸç†åˆ†æ"></a>2.åŸç†åˆ†æ</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“<code>socket</code>çŠ¶æ€ä¸º<code>TIME_WAIT</code>çš„åŸå› æ˜¯ä»€ä¹ˆ,è¿™é‡Œæˆ‘ä»¬éœ€è¦å›é¡¾ä¸‹TCPçš„å››æ¬¡æŒ¥æ‰‹</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/08/EF953F6E-616E-4A39-AB0A-B87925049F98.png" alt="img"></p><p>æ˜ç¡®ä¸‹å›¾ä¸­ç¬¦å·çš„å«ä¹‰</p><ul><li><code>FIN</code>: è¿æ¥ç»ˆæ­¢ä½</li><li><code>seq</code>: å‘é€çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºå·</li><li><code>ACK</code>: ç¡®è®¤æŠ¥æ–‡æ®µ</li><li><code>ack</code>: ç¡®è®¤å·,å¸Œæœ›æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªæ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºå·</li></ul><p>åˆšå¼€å§‹åŒæ–¹éƒ½å¤„äºESTABLISHED çŠ¶æ€ï¼Œå‡è®¾æ˜¯å®¢æˆ·ç«¯å…ˆå‘èµ·å…³é—­è¯·æ±‚(è¿™é‡Œçš„å®¢æˆ·ç«¯æ˜¯ç›¸å¯¹çš„)ã€‚å››æ¬¡æŒ¥æ‰‹çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li><p><strong>ç¬¬ä¸€æ¬¡æŒ¥æ‰‹:</strong> å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª<code>FIN</code>æŠ¥æ–‡(è¯·æ±‚è¿æ¥ç»ˆæ­¢ä¿¡å·:FIN&#x3D;1),æŠ¥æ–‡ä¸­ä¼šæŒ‡å®šä¸€ä¸ªåºåˆ—å·<code>seq = u</code>.å¹¶åœæ­¢åœ¨å‘é€ä¿¡æ¯,ä¸»åŠ¨å…³é—­<code>TCP</code>è¿æ¥.æ­¤æ—¶å®¢æˆ·ç«¯å¤„äº<code>FIN_WAIT-1</code>çŠ¶æ€,ç­‰å¾…æœåŠ¡ç«¯çš„ç¡®è®¤</p><blockquote><p>FIN-WAIT-1 - ç­‰å¾…è¿œç¨‹TCPçš„è¿æ¥ä¸­æ–­è¯·æ±‚ï¼Œæˆ–å…ˆå‰çš„è¿æ¥ä¸­æ–­è¯·æ±‚çš„ç¡®è®¤ï¼›</p></blockquote></li><li><p><strong>ç¬¬äºŒæ¬¡æŒ¥æ‰‹:</strong> æœåŠ¡ç«¯æ”¶åˆ°<code>FIN</code>æŠ¥æ–‡å,æ˜ç¡®å®¢æˆ·ç«¯æƒ³è¦æ–­å¼€è¿æ¥.ä¼šå‘é€<code>ACK</code>æŠ¥æ–‡,å¹¶ä¸”æŠŠå®¢æˆ·ç«¯çš„<code>seq</code>+1ä½œä¸º<code>ACK</code>æŠ¥æ–‡çš„åºåˆ—å·å€¼,æ­¤æ—¶æœåŠ¡ç«¯å¤„äº<code>CLOSE_WAITz</code>çŠ¶æ€</p><blockquote><p>CLOSE-WAIT - ç­‰å¾…ä»æœ¬åœ°ç”¨æˆ·å‘æ¥çš„è¿æ¥ä¸­æ–­è¯·æ±‚ï¼›</p></blockquote><blockquote><p>æ­¤æ—¶çš„ TCP å¤„äºåŠå…³é—­çŠ¶æ€ï¼Œå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„è¿æ¥é‡Šæ”¾ã€‚å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„ç¡®è®¤åï¼Œè¿›å…¥FIN_WAIT2ï¼ˆç»ˆæ­¢ç­‰å¾… 2ï¼‰çŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡ç«¯å‘å‡ºçš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µã€‚</p></blockquote><blockquote><p>FIN-WAIT-2 - ä»è¿œç¨‹TCPç­‰å¾…è¿æ¥ä¸­æ–­è¯·æ±‚ï¼›</p></blockquote></li><li><p><strong>ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹:</strong> å¦‚æœæœåŠ¡ç«¯ä¹Ÿè¦æ–­å¼€è¿æ¥,æ²¡æœ‰æ•°æ®éœ€è¦ä¼ è¾“äº†.ä¼šå’Œå®¢æˆ·ç«¯çš„ç¬¬ä¸€æ¬¡æŒ¥æ‰‹ä¸€æ ·,å‘é€<code>FIN</code>æŠ¥æ–‡,ä¸”éšæœºæŒ‡å®šä¸€ä¸ªåºåˆ—å·.ç„¶åæœåŠ¡ç«¯å¤„äº<code>LAST_ACK</code>çŠ¶æ€,ç­‰å¾…å®¢æˆ·ç«¯çš„ç¡®è®¤</p><blockquote><p>LAST-ACK - ç­‰å¾…åŸæ¥å‘å‘è¿œç¨‹TCPçš„è¿æ¥ä¸­æ–­è¯·æ±‚çš„ç¡®è®¤ï¼›</p></blockquote></li><li><p><strong>ç¬¬å››æ¬¡æŒ¥æ‰‹:</strong> å®¢æˆ·ç«¯æ”¶åˆ°<code>FIN</code>ä¹‹å,ä¸€æ ·å‘é€ä¸€ä¸ªACKåº”ç­”æŠ¥æ–‡(ack &#x3D; w +1),ä¸”å§æœåŠ¡ç«¯çš„åºåˆ—å·+1ä½œä¸º<code>seq</code></p><p>,æ­¤æ—¶å®¢æˆ·ç«¯å¤„äº<code>TIME_WAIT</code>çŠ¶æ€</p><blockquote><p>TIME-WAIT - ç­‰å¾…è¶³å¤Ÿçš„æ—¶é—´ä»¥ç¡®ä¿è¿œç¨‹TCPæ¥æ”¶åˆ°è¿æ¥ä¸­æ–­è¯·æ±‚çš„ç¡®è®¤ï¼›</p></blockquote><blockquote><p>è¿™ä¸ªæ—¶å€™ç”±æœåŠ¡ç«¯åˆ°å®¢æˆ·ç«¯çš„ TCP è¿æ¥å¹¶æœªé‡Šæ”¾æ‰ï¼Œéœ€è¦ç»è¿‡æ—¶é—´ç­‰å¾…è®¡æ—¶å™¨è®¾ç½®çš„æ—¶é—´ 2MSLï¼ˆä¸€ä¸ªæŠ¥æ–‡çš„æ¥å›æ—¶é—´ï¼‰ åæ‰ä¼šè¿›å…¥ CLOSED çŠ¶æ€ï¼ˆè¿™æ ·åšçš„ç›®çš„æ˜¯ç¡®ä¿æœåŠ¡ç«¯æ”¶åˆ°è‡ªå·±çš„ ACK æŠ¥æ–‡ã€‚å¦‚æœæœåŠ¡ç«¯åœ¨è§„å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„ ACK æŠ¥æ–‡çš„è¯ï¼ŒæœåŠ¡ç«¯ä¼šé‡æ–°å‘é€ FIN æŠ¥æ–‡ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å†æ¬¡æ”¶åˆ° FIN æŠ¥æ–‡ä¹‹åï¼Œå°±çŸ¥é“ä¹‹å‰çš„ ACK æŠ¥æ–‡ä¸¢å¤±äº†ï¼Œç„¶åå†æ¬¡å‘é€ ACK æŠ¥æ–‡ç»™æœåŠ¡ç«¯ï¼‰ã€‚æœåŠ¡ç«¯æ”¶åˆ° ACK æŠ¥æ–‡ä¹‹åï¼Œå°±å…³é—­è¿æ¥äº†ï¼Œå¤„äº CLOSED çŠ¶æ€ã€‚</p></blockquote></li></ol><p>é€šè¿‡è¿™ä¸ªæµç¨‹æˆ‘ä»¬å¯ä»¥å‘ç°æœ‰å¤§é‡çš„<code>TIME_WAIT</code>çŠ¶æ€çš„<code>socket</code>ä¸»è¦æ˜¯å®¢æˆ·ç«¯éœ€è¦ç­‰å¾…è¶³å¤Ÿçš„æ—¶é—´ç¡®ä¿æœåŠ¡ç«¯æ¥å—åˆ°è¯·æ±‚</p><h3 id="3-å‚æ•°è°ƒä¼˜"><a href="#3-å‚æ•°è°ƒä¼˜" class="headerlink" title="3.å‚æ•°è°ƒä¼˜"></a>3.å‚æ•°è°ƒä¼˜</h3><p>æ ¹æ®ä¸Šé¢åˆ†æ<code>TIME_WAIT</code>ä¸»è¦æ˜¯å®¢æˆ·ç«¯ä¿è¯æœåŠ¡ç«¯èƒ½æ­£å¸¸æ¥å—è¯·æ±‚åœ¨ç­‰å¾…çš„çŠ¶æ€,é»˜è®¤è¿™ä¸ªæ˜¯<code>2ML</code>ä¹Ÿå°±æ˜¯4åˆ†é’Ÿ,ä½†æ˜¯ç”Ÿäº§ä¸­è¿™ä¸ªé…ç½®å»ºè®®å¯ä»¥æ›´ç¬¬ä¸€ç‚¹30ç§’ã€1åˆ†é’Ÿã€2åˆ†é’Ÿéƒ½æ˜¯å¯ä»¥çš„</p><p><code>/etc/sysctl.conf</code>æ·»åŠ é…ç½®</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ä¼˜åŒ–TIME_WAIT</span>net.ipv4.tcp_tw_reuse <span class="token operator">=</span> 1<span class="token comment" spellcheck="true">#è¡¨ç¤ºå¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­</span>net.ipv4.tcp_tw_recycle <span class="token operator">=</span> 1<span class="token comment" spellcheck="true">#è¡¨ç¤ºå¼€å¯TCPè¿æ¥ä¸­TIME-WAIT socketsçš„å¿«é€Ÿå›æ”¶ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ã€‚</span>net.ipv4.tcp_fin_timeout <span class="token operator">=</span> 30<span class="token comment" spellcheck="true">#ä¿®æ”¹ç³»çµ±é»˜è®¤çš„TIMEOUTæ—¶é—´</span></code></pre><p><code>sysctl -p</code>ç”Ÿæ•ˆ</p><p>ç¨ç­‰ä¸¤åˆ†é’Ÿå†æ¬¡æŸ¥çœ‹</p><pre class=" language-bash"><code class="language-bash"><span class="token function">netstat</span> -na <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'/^tcp/ {++S[<span class="token variable">$NF</span>]} END {for(a in S) print a, S[a]}'</span>LISTEN 13ESTABLISHED 9TIME_WAIT 18</code></pre><p>å·²ç»å¤§å¹…åº¦å‡å°‘äº† é™åˆ°äº†åä½æ•°</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mongo å‰¯æœ¬é›†é…ç½®</title>
      <link href="/f7fabe39/"/>
      <url>/f7fabe39/</url>
      
        <content type="html"><![CDATA[<h3 id="1-mongodbå‰¯æœ¬ç®€ä»‹"><a href="#1-mongodbå‰¯æœ¬ç®€ä»‹" class="headerlink" title="1.mongodbå‰¯æœ¬ç®€ä»‹"></a>1.mongodbå‰¯æœ¬ç®€ä»‹</h3><p>MongoDB å‰¯æœ¬é›†ï¼ˆReplica Setï¼‰åŒ…æ‹¬ä¸»èŠ‚ç‚¹ï¼ˆprimaryï¼‰è·Ÿå‰¯æœ¬èŠ‚ç‚¹ï¼ˆSecondariesï¼‰ã€‚ä¸»èŠ‚ç‚¹åªèƒ½æœ‰ä¸€ä¸ªï¼Œæ‰€æœ‰çš„å†™æ“ä½œè¯·æ±‚éƒ½åœ¨ä¸»èŠ‚ç‚¹ä¸Šé¢å¤„ç†ã€‚å‰¯æœ¬èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªï¼Œé€šè¿‡åŒæ­¥ä¸»èŠ‚ç‚¹çš„æ“ä½œæ—¥å¿—ï¼ˆoplogï¼‰æ¥å¤‡ä»½ä¸»èŠ‚ç‚¹æ•°æ®ã€‚</p><p>åœ¨ä¸»èŠ‚ç‚¹æŒ‚æ‰åï¼Œæœ‰é€‰ä¸¾æƒé™çš„å‰¯æœ¬èŠ‚ç‚¹ä¼šè‡ªåŠ¨å‘èµ·é€‰ä¸¾ï¼Œå¹¶ä»ä¸­é€‰ä¸¾å‡ºæ–°çš„ä¸»èŠ‚ç‚¹ã€‚å‰¯æœ¬èŠ‚ç‚¹å¯ä»¥é€šè¿‡é…ç½®ï¼ŒæŒ‡å®šå…¶å…·ä½“çš„å±æ€§ï¼Œæ¯”å¦‚é€‰ä¸¾ã€éšè—ã€å»¶è¿ŸåŒæ­¥ç­‰ï¼Œæœ€å¤šå¯ä»¥æœ‰50ä¸ªå‰¯æœ¬èŠ‚ç‚¹ï¼Œä½†åªèƒ½æœ‰7ä¸ªå‰¯æœ¬èŠ‚ç‚¹èƒ½å‚ä¸é€‰ä¸¾ã€‚è™½ç„¶å‰¯æœ¬èŠ‚ç‚¹ä¸èƒ½å¤„ç†å†™æ“ä½œï¼Œä½†å¯ä»¥å¤„ç†è¯»è¯·æ±‚ã€‚</p><p>æ­å»ºä¸€ä¸ªå‰¯æœ¬é›†é›†ç¾¤æœ€å°‘éœ€è¦ä¸‰ä¸ªèŠ‚ç‚¹ï¼šä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸¤ä¸ªå¤‡ä»½èŠ‚ç‚¹ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/08/67709252-1907-48B9-8FDB-2B709CD89F16.png"></p><h3 id="2-æœåŠ¡æ¶æ„"><a href="#2-æœåŠ¡æ¶æ„" class="headerlink" title="2.æœåŠ¡æ¶æ„"></a>2.æœåŠ¡æ¶æ„</h3><p>æ­å»ºä¸€å¥—3èŠ‚ç‚¹å‰¯æœ¬é›†ï¼ˆ1ä¸ª Primary èŠ‚ç‚¹ï¼Œ2ä¸ª Secondary èŠ‚ç‚¹ï¼‰ï¼ŒèŠ‚ç‚¹è§„åˆ’å¦‚ä¸‹ï¼š</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>è§’è‰²</th></tr></thead><tbody><tr><td>ppgroup-mongo-redis01</td><td>172.17.0.78</td><td>primary</td></tr><tr><td>Ppgroup-mongo-redis02</td><td>172.17.0.77</td><td>secondary</td></tr><tr><td>Ppgroup-mongo-redis03</td><td>172.17.0.76</td><td>secondary</td></tr></tbody></table><h3 id="3-éƒ¨ç½²æœåŠ¡"><a href="#3-éƒ¨ç½²æœåŠ¡" class="headerlink" title="3.éƒ¨ç½²æœåŠ¡"></a>3.éƒ¨ç½²æœåŠ¡</h3><h5 id="é…ç½®hostsè§£æ"><a href="#é…ç½®hostsè§£æ" class="headerlink" title="é…ç½®hostsè§£æ"></a>é…ç½®hostsè§£æ</h5><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">>></span> /etc/hosts <span class="token operator">&lt;&lt;</span><span class="token string">EOF172.17.0.78 ppgroup-mongo-redis01172.17.0.77 ppgroup-mongo-redis02172.17.0.76 ppgroup-mongo-redis03EOF</span></code></pre><h5 id="å…³é—­é˜²ç«å¢™å’Œselinux"><a href="#å…³é—­é˜²ç«å¢™å’Œselinux" class="headerlink" title="å…³é—­é˜²ç«å¢™å’Œselinux"></a>å…³é—­é˜²ç«å¢™å’Œselinux</h5><pre class=" language-bash"><code class="language-bash">systemctl disable firewalld<span class="token function">sed</span> -i <span class="token string">'s/^SELINUX=enforcing$/SELINUX=disabled/'</span> /etc/selinux/config <span class="token operator">&amp;&amp;</span> setenforce 0</code></pre><h5 id="é…ç½®å›½å†…yumæº"><a href="#é…ç½®å›½å†…yumæº" class="headerlink" title="é…ç½®å›½å†…yumæº"></a>é…ç½®å›½å†…yumæº</h5><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span> /etc/yum.repos.d/mongodb.repo <span class="token operator">&lt;&lt;</span><span class="token string">'EOF'[mongodb-org]name=MongoDB Repositorybaseurl=https://mirrors.tuna.tsinghua.edu.cn/mongodb/yum/el<span class="token variable">$releasever</span>/gpgcheck=0enabled=1EOF</span></code></pre><h5 id="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…mongo"><a href="#æ‰€æœ‰èŠ‚ç‚¹å®‰è£…mongo" class="headerlink" title="æ‰€æœ‰èŠ‚ç‚¹å®‰è£…mongo"></a>æ‰€æœ‰èŠ‚ç‚¹å®‰è£…mongo</h5><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> -y mongodb-org</code></pre><h5 id="ä¿®æ”¹mongoé…ç½®æ–‡ä»¶ä¸€ä¸‹å†…å®¹"><a href="#ä¿®æ”¹mongoé…ç½®æ–‡ä»¶ä¸€ä¸‹å†…å®¹" class="headerlink" title="ä¿®æ”¹mongoé…ç½®æ–‡ä»¶ä¸€ä¸‹å†…å®¹"></a>ä¿®æ”¹mongoé…ç½®æ–‡ä»¶ä¸€ä¸‹å†…å®¹</h5><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># mongod.conf</span><span class="token comment" spellcheck="true"># for documentation of all options, see:</span><span class="token comment" spellcheck="true">#   http://docs.mongodb.org/manual/reference/configuration-options/</span><span class="token comment" spellcheck="true"># where to write logging data.</span>systemLog:  destination: <span class="token function">file</span>  logAppend: <span class="token boolean">true</span>  path: /var/log/mongodb/mongod.log  <span class="token comment" spellcheck="true">#æ—¥å¿—ç›®å½•</span><span class="token comment" spellcheck="true"># Where and how to store data.</span>storage:  dbPath: /data/mongo  <span class="token comment" spellcheck="true">#æ•°æ®åº“å­˜æ”¾ç›®å½•</span>  journal:    enabled: <span class="token boolean">true</span><span class="token comment" spellcheck="true">#  engine:</span><span class="token comment" spellcheck="true">#  wiredTiger:</span><span class="token comment" spellcheck="true"># how the process runs</span>processManagement:  fork: <span class="token boolean">true</span>  <span class="token comment" spellcheck="true"># fork and run in background</span>  pidFilePath: /var/run/mongodb/mongod.pid  <span class="token comment" spellcheck="true"># location of pidfile</span>  timeZoneInfo: /usr/share/zoneinfo<span class="token comment" spellcheck="true"># network interfaces</span>net:  port: 27017  bindIp: 0.0.0.0  <span class="token comment" spellcheck="true"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span><span class="token comment" spellcheck="true">#security:</span><span class="token comment" spellcheck="true">#operationProfiling:</span>replication:  replSetName: <span class="token string">"rs0"</span>  <span class="token comment" spellcheck="true">#å¼€å¯å‰¯æœ¬é›†é…ç½®</span><span class="token comment" spellcheck="true">#sharding:</span><span class="token comment" spellcheck="true">## Enterprise-Only Options</span><span class="token comment" spellcheck="true">#auditLog:</span><span class="token comment" spellcheck="true">#snmp:</span></code></pre><h5 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h5><pre class=" language-bash"><code class="language-bash">systemctl <span class="token function">enable</span> mongodsystemctl start mongod</code></pre><h3 id="4-é…ç½®å¤åˆ¶é›†ç¾¤"><a href="#4-é…ç½®å¤åˆ¶é›†ç¾¤" class="headerlink" title="4.é…ç½®å¤åˆ¶é›†ç¾¤"></a>4.é…ç½®å¤åˆ¶é›†ç¾¤</h3><h5 id="masterèŠ‚ç‚¹æ“ä½œåˆå§‹åŒ–é›†ç¾¤"><a href="#masterèŠ‚ç‚¹æ“ä½œåˆå§‹åŒ–é›†ç¾¤" class="headerlink" title="masterèŠ‚ç‚¹æ“ä½œåˆå§‹åŒ–é›†ç¾¤"></a>masterèŠ‚ç‚¹æ“ä½œåˆå§‹åŒ–é›†ç¾¤</h5><pre class=" language-bash"><code class="language-bash">mongors.initiate<span class="token punctuation">(</span> <span class="token punctuation">{</span>   _id <span class="token keyword">:</span> <span class="token string">"rs0"</span>,   members: <span class="token punctuation">[</span>      <span class="token punctuation">{</span> _id: 0, host: <span class="token string">"ppgroup-mongo-redis01:27017"</span> <span class="token punctuation">}</span>,      <span class="token punctuation">{</span> _id: 1, host: <span class="token string">"ppgroup-mongo-redis02:27017"</span> <span class="token punctuation">}</span>,      <span class="token punctuation">{</span> _id: 2, host: <span class="token string">"ppgroup-mongo-redis03:27017"</span> <span class="token punctuation">}</span>   <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><h5 id="æŸ¥çœ‹é›†ç¾¤çŠ¶æ€"><a href="#æŸ¥çœ‹é›†ç¾¤çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤çŠ¶æ€"></a>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</h5><pre class=" language-bash"><code class="language-bash">rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token string">"set"</span> <span class="token keyword">:</span> <span class="token string">"rs0"</span>,        <span class="token string">"date"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:30.930Z"</span><span class="token punctuation">)</span>,        <span class="token string">"myState"</span> <span class="token keyword">:</span> 1,        <span class="token string">"term"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>,        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">""</span>,        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> -1,        <span class="token string">"heartbeatIntervalMillis"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>2000<span class="token punctuation">)</span>,        <span class="token string">"majorityVoteCount"</span> <span class="token keyword">:</span> 2,        <span class="token string">"writeMajorityCount"</span> <span class="token keyword">:</span> 2,        <span class="token string">"votingMembersCount"</span> <span class="token keyword">:</span> 3,        <span class="token string">"writableVotingMembersCount"</span> <span class="token keyword">:</span> 3,        <span class="token string">"optimes"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                <span class="token string">"lastCommittedOpTime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"lastCommittedWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29.715Z"</span><span class="token punctuation">)</span>,                <span class="token string">"readConcernMajorityOpTime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"appliedOpTime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"durableOpTime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"lastAppliedWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29.715Z"</span><span class="token punctuation">)</span>,                <span class="token string">"lastDurableWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29.715Z"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>,        <span class="token string">"lastStableRecoveryTimestamp"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950059, 1<span class="token punctuation">)</span>,        <span class="token string">"electionCandidateMetrics"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                <span class="token string">"lastElectionReason"</span> <span class="token keyword">:</span> <span class="token string">"electionTimeout"</span>,                <span class="token string">"lastElectionDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T07:17:39.588Z"</span><span class="token punctuation">)</span>,                <span class="token string">"electionTerm"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>,                <span class="token string">"lastCommittedOpTimeAtElection"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659943048, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"lastSeenOpTimeAtElection"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659943048, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"numVotesNeeded"</span> <span class="token keyword">:</span> 2,                <span class="token string">"priorityAtElection"</span> <span class="token keyword">:</span> 1,                <span class="token string">"electionTimeoutMillis"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>10000<span class="token punctuation">)</span>,                <span class="token string">"numCatchUpOps"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,                <span class="token string">"newTermStartDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T07:17:39.601Z"</span><span class="token punctuation">)</span>,                <span class="token string">"wMajorityWriteAvailabilityDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T07:17:41.049Z"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>,        <span class="token string">"members"</span> <span class="token keyword">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                        <span class="token string">"_id"</span> <span class="token keyword">:</span> 0,                        <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"ppgroup-mongo-redis01:27017"</span>,                        <span class="token string">"health"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"state"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"stateStr"</span> <span class="token keyword">:</span> <span class="token string">"PRIMARY"</span>,                        <span class="token string">"uptime"</span> <span class="token keyword">:</span> 7109,                        <span class="token string">"optime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>,                        <span class="token string">"optimeDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastAppliedWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29.715Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastDurableWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29.715Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> -1,                        <span class="token string">"infoMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"electionTime"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659943059, 1<span class="token punctuation">)</span>,                        <span class="token string">"electionDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T07:17:39Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"configVersion"</span> <span class="token keyword">:</span> 8,                        <span class="token string">"configTerm"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"self"</span> <span class="token keyword">:</span> true,                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>                <span class="token punctuation">}</span>,                <span class="token punctuation">{</span>                        <span class="token string">"_id"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"ppgroup-mongo-redis03:27017"</span>,                        <span class="token string">"health"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"state"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"stateStr"</span> <span class="token keyword">:</span> <span class="token string">"SECONDARY"</span>,                        <span class="token string">"uptime"</span> <span class="token keyword">:</span> 7022,                        <span class="token string">"optime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>,                        <span class="token string">"optimeDurable"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>,                        <span class="token string">"optimeDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"optimeDurableDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastAppliedWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29.715Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastDurableWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29.715Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeat"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:30.872Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatRecv"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:30.882Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"pingMs"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">"ppgroup-mongo-redis01:27017"</span>,                        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> 0,                        <span class="token string">"infoMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"configVersion"</span> <span class="token keyword">:</span> 8,                        <span class="token string">"configTerm"</span> <span class="token keyword">:</span> 1                <span class="token punctuation">}</span>,                <span class="token punctuation">{</span>                        <span class="token string">"_id"</span> <span class="token keyword">:</span> 3,                        <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"ppgroup-mongo-redis02:27017"</span>,                        <span class="token string">"health"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"state"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"stateStr"</span> <span class="token keyword">:</span> <span class="token string">"SECONDARY"</span>,                        <span class="token string">"uptime"</span> <span class="token keyword">:</span> 4214,                        <span class="token string">"optime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>,                        <span class="token string">"optimeDurable"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>1<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>,                        <span class="token string">"optimeDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"optimeDurableDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastAppliedWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29.715Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastDurableWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29.715Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeat"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:30.872Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatRecv"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-08-08T09:14:29.876Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"pingMs"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">"ppgroup-mongo-redis03:27017"</span>,                        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"infoMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"configVersion"</span> <span class="token keyword">:</span> 8,                        <span class="token string">"configTerm"</span> <span class="token keyword">:</span> 1                <span class="token punctuation">}</span>        <span class="token punctuation">]</span>,        <span class="token string">"ok"</span> <span class="token keyword">:</span> 1,        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                <span class="token string">"clusterTime"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span>,                <span class="token string">"signature"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"hash"</span> <span class="token keyword">:</span> BinData<span class="token punctuation">(</span>0,<span class="token string">"AAAAAAAAAAAAAAAAAAAAAAAAAAA="</span><span class="token punctuation">)</span>,                        <span class="token string">"keyId"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>                <span class="token punctuation">}</span>        <span class="token punctuation">}</span>,        <span class="token string">"operationTime"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1659950069, 1<span class="token punctuation">)</span></code></pre><h3 id="5-æµ‹è¯•æ•°æ®åŒæ­¥"><a href="#5-æµ‹è¯•æ•°æ®åŒæ­¥" class="headerlink" title="5.æµ‹è¯•æ•°æ®åŒæ­¥"></a>5.æµ‹è¯•æ•°æ®åŒæ­¥</h3><h5 id="ä¸»åº“åˆ›å»ºæ•°æ®"><a href="#ä¸»åº“åˆ›å»ºæ•°æ®" class="headerlink" title="ä¸»åº“åˆ›å»ºæ•°æ®"></a>ä¸»åº“åˆ›å»ºæ•°æ®</h5><pre class=" language-bash"><code class="language-bash">use testdbdb.test1231.insert<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"name"</span><span class="token keyword">:</span><span class="token string">"test repl"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h5 id="ä»åº“æŸ¥çœ‹æ•°æ®"><a href="#ä»åº“æŸ¥çœ‹æ•°æ®" class="headerlink" title="ä»åº“æŸ¥çœ‹æ•°æ®"></a>ä»åº“æŸ¥çœ‹æ•°æ®</h5><pre class=" language-bash"><code class="language-bash">rs.secondaryOk<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>db.test1231.find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token keyword">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"62f0cc490a72461ed9866f18"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"test repl"</span> <span class="token punctuation">}</span></code></pre><p>ä»åº“å¯ä»¥æ­£å¸¸åŒæ­¥æ•°æ® </p><h5 id=""><a href="#" class="headerlink" title=""></a></h5>]]></content>
      
      
      <categories>
          
          <category> Mongo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mongo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis æ­å»ºSentinelé›†ç¾¤</title>
      <link href="/f2fbd0c8/"/>
      <url>/f2fbd0c8/</url>
      
        <content type="html"><![CDATA[<h3 id="1-æœåŠ¡è§„åˆ’"><a href="#1-æœåŠ¡è§„åˆ’" class="headerlink" title="1.æœåŠ¡è§„åˆ’"></a>1.æœåŠ¡è§„åˆ’</h3><table><thead><tr><th>ä¸»æœºå</th><th>ip</th><th>redis port</th><th>è§’è‰²</th><th>sentinel port</th></tr></thead><tbody><tr><td>redis-01</td><td>172.17.0.78</td><td>6379</td><td>master</td><td>26379</td></tr><tr><td>Redis-02</td><td>172.17.0.77</td><td>6379</td><td>slave</td><td>26379</td></tr><tr><td>Redis-03</td><td>172.17.0.76</td><td>6379</td><td>slave</td><td>26379</td></tr></tbody></table><p>æœ¬æ–‡ä¸»è¦ä»‹ç»sentinel å’Œä¸»ä»é…ç½® <a href="https://www.huhuhahei.cn/1ce736fe/">redis ä¸€ä¸»ä¸¤ä»é›†ç¾¤æ­å»º</a></p><h3 id="2-redisé…ç½®ä¸»ä»"><a href="#2-redisé…ç½®ä¸»ä»" class="headerlink" title="2.redisé…ç½®ä¸»ä»"></a>2.redisé…ç½®ä¸»ä»</h3><p>åªéœ€è¦åœ¨ä¸¤ä¸ªä»èŠ‚ç‚¹æ‰§è¡Œä¸€ä¸‹å‘½ä»¤</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> slaveof 172.17.0.78 6379OK127.0.0.1:6379<span class="token operator">></span> </code></pre><p>ä¸¤ä¸ªå‡æ‰§è¡Œå®Œæˆåå¯ä»¥æŸ¥çœ‹ä¸»ä»å¤åˆ¶çŠ¶æ€</p><pre class=" language-bash"><code class="language-bash">info replication<span class="token comment" spellcheck="true"># Replication</span>role:masterconnected_slaves:2slave0:ip<span class="token operator">=</span>172.17.0.77,port<span class="token operator">=</span>6379,state<span class="token operator">=</span>online,offset<span class="token operator">=</span>701751,lag<span class="token operator">=</span>1slave1:ip<span class="token operator">=</span>172.17.0.76,port<span class="token operator">=</span>6379,state<span class="token operator">=</span>online,offset<span class="token operator">=</span>701765,lag<span class="token operator">=</span>0master_failover_state:no-failovermaster_replid:cc2aa24cae22cd9148aa2baaa1439f1c62dac128master_replid2:0000000000000000000000000000000000000000master_repl_offset:701765second_repl_offset:-1repl_backlog_active:1repl_backlog_size:1048576repl_backlog_first_byte_offset:1repl_backlog_histlen:701765</code></pre><h3 id="3-sentinelé…ç½®"><a href="#3-sentinelé…ç½®" class="headerlink" title="3.sentinelé…ç½®"></a>3.sentinelé…ç½®</h3><p>é»˜è®¤redisçš„æºç ç›®å½•æ˜¯æœ‰sentinelçš„é…ç½®çš„ æˆ‘ä»¬åªéœ€è¦å°†é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°ç›¸åº”ç›®å½•å¯åŠ¨å³å¯</p><pre class=" language-bash"><code class="language-bash"><span class="token function">cp</span>  /opt/redis-6.2.6/sentinel.conf /usr/local/redis/conf/sentinel_26379.conf</code></pre><p>é…ç½®æ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash">port 26379daemonize <span class="token function">yes</span><span class="token comment" spellcheck="true">#éœ€è¦æ”¹ä¸ºyes å¦åˆ™ä¸æ˜¯åå°è¿è¡Œ</span>pidfile <span class="token string">"/var/run/redis-sentinel_26379.pid"</span>logfile <span class="token string">"/usr/local/redis/log/sentinel_26379.log"</span><span class="token function">dir</span> <span class="token string">"/tmp"</span>sentinel monitor mymaster 172.17.0.78 6379 2sentinel auth-pass mymaster XbNaw1d2kFUwsentinel config-epoch mymaster 3sentinel leader-epoch mymaster 4acllog-max-len 128sentinel deny-scripts-reconfig <span class="token function">yes</span>sentinel resolve-hostnames nosentinel announce-hostnames no<span class="token comment" spellcheck="true"># Generated by CONFIG REWRITE</span>protected-mode nouser default on nopass ~* <span class="token operator">&amp;</span>* +@allsentinel myid 173915edb665a620743e0bcd83265e78e74f5838sentinel current-epoch 3sentinel known-replica mymaster 172.17.0.77 6379sentinel known-replica mymaster 172.17.0.76 6379sentinel known-sentinel mymaster 172.17.0.76 26379 46ee2470e473a0ade94efdac51da190e8019fc9bsentinel known-sentinel mymaster 172.17.0.77 26379 868edf41daea6b9518660398f8905d2bf1d6d7bc</code></pre><p>å¯ä»¥è¿æ¥sentinelæŸ¥çœ‹çŠ¶æ€</p><pre class=" language-bash"><code class="language-bash">info sentinel<span class="token comment" spellcheck="true"># Sentinel</span>sentinel_masters:1sentinel_tilt:0sentinel_running_scripts:0sentinel_scripts_queue_length:0sentinel_simulate_failure_flags:0master0:name<span class="token operator">=</span>youpin898master,status<span class="token operator">=</span>ok,address<span class="token operator">=</span>172.17.0.78:6379,slaves<span class="token operator">=</span>2,sentinels<span class="token operator">=</span>3</code></pre><p>è‡³æ­¤é›†ç¾¤å·²ç»æ­å»ºå®Œæˆ</p>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis ä¸€ä¸»ä¸¤ä»é›†ç¾¤æ­å»º</title>
      <link href="/1ce736fe/"/>
      <url>/1ce736fe/</url>
      
        <content type="html"><![CDATA[<h3 id="1-ç³»ç»Ÿç¯å¢ƒ"><a href="#1-ç³»ç»Ÿç¯å¢ƒ" class="headerlink" title="1.ç³»ç»Ÿç¯å¢ƒ"></a>1.ç³»ç»Ÿç¯å¢ƒ</h3><pre class=" language-bash"><code class="language-bash">lsb_release -aLSB Version:    :core-4.1-amd64:core-4.1-noarchDistributor ID: CentOSDescription:    CentOS Linux release 7.9.2009 <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>Release:        7.9.2009Codename:       Core</code></pre><p>ä¸‹è½½redis<a href="kode.huhuhahei.cn/kodexplorer/tar%E5%8C%85/redis%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98/redis-6.2.6.tar.gz">redis-6.2.6.tar.gz</a></p><h3 id="2-ç¯å¢ƒå‡†å¤‡"><a href="#2-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.ç¯å¢ƒå‡†å¤‡"></a>2.ç¯å¢ƒå‡†å¤‡</h3><p>redis6ç‰ˆæœ¬ä¾èµ–äºgcc9çš„ç¼–è¯‘ç¯å¢ƒæ‰€ä»¥éœ€è¦å‡çº§gccç‰ˆæœ¬</p><p>å®‰è£…</p><pre class=" language-bash"><code class="language-bash">yum -y <span class="token function">install</span> gcc gcc-c++</code></pre><p>æ£€æŸ¥å½“å‰ç‰ˆæœ¬</p><pre class=" language-bash"><code class="language-bash">gcc -vUsing built-in specs.COLLECT_GCC<span class="token operator">=</span>gccCOLLECT_LTO_WRAPPER<span class="token operator">=</span>/usr/libexec/gcc/x86_64-redhat-linux/4.8.5/lto-wrapperTarget: x86_64-redhat-linuxConfigured with: <span class="token punctuation">..</span>/configure --prefix<span class="token operator">=</span>/usr --mandir<span class="token operator">=</span>/usr/share/man --infodir<span class="token operator">=</span>/usr/share/info --with-bugurl<span class="token operator">=</span>http://bugzilla.redhat.com/bugzilla --enable-bootstrap --enable-shared --enable-threads<span class="token operator">=</span>posix --enable-checking<span class="token operator">=</span>release --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-linker-hash-style<span class="token operator">=</span>gnu --enable-languages<span class="token operator">=</span>c,c++,objc,obj-c++,java,fortran,ada,go,lto --enable-plugin --enable-initfini-array --disable-libgcj --with-isl<span class="token operator">=</span>/builddir/build/BUILD/gcc-4.8.5-20150702/obj-x86_64-redhat-linux/isl-install --with-cloog<span class="token operator">=</span>/builddir/build/BUILD/gcc-4.8.5-20150702/obj-x86_64-redhat-linux/cloog-install --enable-gnu-indirect-function --with-tune<span class="token operator">=</span>generic --with-arch_32<span class="token operator">=</span>x86-64 --build<span class="token operator">=</span>x86_64-redhat-linuxThread model: posixgcc version 4.8.5 20150623 <span class="token punctuation">(</span>Red Hat 4.8.5-44<span class="token punctuation">)</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span> </code></pre><p>ç‰ˆæœ¬å‡çº§</p><pre class=" language-bash"><code class="language-bash">yum -y <span class="token function">install</span> centos-release-sclyum -y <span class="token function">install</span> devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutilsscl <span class="token function">enable</span> devtoolset-9 <span class="token function">bash</span></code></pre><p>é…ç½®ç¯å¢ƒå˜é‡</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#åœ¨/etc/profileæœ€åæ·»åŠ </span><span class="token function">source</span> /opt/rh/devtoolset-9/enable</code></pre><p>ç”Ÿæ•ˆé…ç½®</p><pre class=" language-bash"><code class="language-bash"><span class="token function">source</span> /etc/profile</code></pre><p>å†æ¬¡æŸ¥çœ‹gccç‰ˆæœ¬ å·²ç»æ˜¯9ç‰ˆæœ¬äº†</p><pre class=" language-bash"><code class="language-bash">gcc -vUsing built-in specs.COLLECT_GCC<span class="token operator">=</span>gccCOLLECT_LTO_WRAPPER<span class="token operator">=</span>/opt/rh/devtoolset-9/root/usr/libexec/gcc/x86_64-redhat-linux/9/lto-wrapperTarget: x86_64-redhat-linuxConfigured with: <span class="token punctuation">..</span>/configure --enable-bootstrap --enable-languages<span class="token operator">=</span>c,c++,fortran,lto --prefix<span class="token operator">=</span>/opt/rh/devtoolset-9/root/usr --mandir<span class="token operator">=</span>/opt/rh/devtoolset-9/root/usr/share/man --infodir<span class="token operator">=</span>/opt/rh/devtoolset-9/root/usr/share/info --with-bugurl<span class="token operator">=</span>http://bugzilla.redhat.com/bugzilla --enable-shared --enable-threads<span class="token operator">=</span>posix --enable-checking<span class="token operator">=</span>release --enable-multilib --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-gcc-major-version-only --with-linker-hash-style<span class="token operator">=</span>gnu --with-default-libstdcxx-abi<span class="token operator">=</span>gcc4-compatible --enable-plugin --enable-initfini-array --with-isl<span class="token operator">=</span>/builddir/build/BUILD/gcc-9.3.1-20200408/obj-x86_64-redhat-linux/isl-install --disable-libmpx --enable-gnu-indirect-function --with-tune<span class="token operator">=</span>generic --with-arch_32<span class="token operator">=</span>x86-64 --build<span class="token operator">=</span>x86_64-redhat-linuxThread model: posixgcc version 9.3.1 20200408 <span class="token punctuation">(</span>Red Hat 9.3.1-2<span class="token punctuation">)</span> <span class="token punctuation">(</span>GCC<span class="token punctuation">)</span></code></pre><h3 id="3-ç¼–è¯‘å®‰è£…redis"><a href="#3-ç¼–è¯‘å®‰è£…redis" class="headerlink" title="3.ç¼–è¯‘å®‰è£…redis"></a>3.ç¼–è¯‘å®‰è£…redis</h3><p>è§£å‹æ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash"><span class="token function">tar</span> -zxvf /opt/redis-6.2.6.tar.gz</code></pre><p>ç¼–è¯‘å®‰è£…</p><pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> /opt/redis-6.2.6<span class="token function">make</span><span class="token function">make</span> <span class="token function">install</span> PREFIX<span class="token operator">=</span>/usr/local/redis</code></pre><p>æ·»åŠ env</p><pre class=" language-bash"><code class="language-bash"><span class="token function">export</span> REDIS_HOME<span class="token operator">=</span>/usr/local/redis<span class="token function">export</span> PATH<span class="token operator">=</span><span class="token variable">$PATH</span><span class="token keyword">:</span><span class="token variable">$REDIS_HOME</span>/bin</code></pre><p>ç”Ÿæ•ˆç¯å¢ƒå˜é‡</p><pre class=" language-bash"><code class="language-bash"><span class="token function">source</span> /etc/profile</code></pre><p>æŸ¥çœ‹redisæ˜¯å¦é…ç½®æˆåŠŸ</p><pre class=" language-bash"><code class="language-bash">redis-server --versionRedis server v<span class="token operator">=</span>6.2.6 sha<span class="token operator">=</span>00000000:0 malloc<span class="token operator">=</span>jemalloc-5.1.0 bits<span class="token operator">=</span>64 build<span class="token operator">=</span>92355b6e8316bc7a</code></pre><h3 id="4-é…ç½®redis"><a href="#4-é…ç½®redis" class="headerlink" title="4.é…ç½®redis"></a>4.é…ç½®redis</h3><p>ä½¿ç”¨install_server.shé…ç½®redis</p><p>éœ€è¦ç”¨vimå°†install_server.shä¸­çš„å¦‚ä¸‹ä»£ç æ³¨é‡Šæ‰</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#if [ "${_pid_1_exe##*/}" = systemd ]</span><span class="token comment" spellcheck="true">#then</span><span class="token comment" spellcheck="true">#       echo "This systems seems to use systemd."</span><span class="token comment" spellcheck="true">#       echo "Please take a look at the provided example service unit files in this directory, and adapt and install them. Sorry!"</span><span class="token comment" spellcheck="true">#       exit 1</span><span class="token comment" spellcheck="true">#fi</span></code></pre><p>æ‰§è¡Œè„šæœ¬</p><pre class=" language-bash"><code class="language-bash">./install_server.shPlease <span class="token keyword">select</span> the redis port <span class="token keyword">for</span> this instance: <span class="token punctuation">[</span>6379<span class="token punctuation">]</span> Selecting default: 6379Please <span class="token keyword">select</span> the redis config <span class="token function">file</span> name <span class="token punctuation">[</span>/6379.conf<span class="token punctuation">]</span> Selected default - /etc/redis/6379.confPlease <span class="token keyword">select</span> the redis log <span class="token function">file</span> name <span class="token punctuation">[</span>/var/log/redis_6379.log<span class="token punctuation">]</span> /opt/redis/logs/redis_6379.logPlease <span class="token keyword">select</span> the data directory <span class="token keyword">for</span> this instance <span class="token punctuation">[</span>/var/lib/redis/6379<span class="token punctuation">]</span> /opt/redis/data/6379Please <span class="token keyword">select</span> the redis executable path <span class="token punctuation">[</span>/usr/local/redis/bin/redis-server<span class="token punctuation">]</span> /usr/local/redis/bin/redis-serverSelected config:Port           <span class="token keyword">:</span> 6379Config <span class="token function">file</span>    <span class="token keyword">:</span> /etc/redis/6379.confLog <span class="token function">file</span>       <span class="token keyword">:</span> /opt/redis/logs/redis_6379.logData <span class="token function">dir</span>       <span class="token keyword">:</span> /opt/redis/data/6379Executable     <span class="token keyword">:</span> /usr/local/redis/bin/redis-serverCli Executable <span class="token keyword">:</span> //usr/local/redis/bin/redis-cliIs this ok? Then press ENTER to go on or Ctrl-C to abort.Copied /tmp/6379.conf <span class="token operator">=</span><span class="token operator">></span> /etc/init.d/redis_6379Installing service<span class="token punctuation">..</span>.Successfully added to chkconfig<span class="token operator">!</span>Successfully added to runlevels 345<span class="token operator">!</span>Starting Redis server<span class="token punctuation">..</span>.Installation successful<span class="token operator">!</span></code></pre><p>æœåŠ¡å¯åœ</p><pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> redis_6379 start<span class="token function">service</span> redis_6379 stop<span class="token function">service</span> redis_6379 status<span class="token function">service</span> redis_6379 restart</code></pre><h3 id="5-è°ƒæ•´é…ç½®æ–‡ä»¶"><a href="#5-è°ƒæ•´é…ç½®æ–‡ä»¶" class="headerlink" title="5.è°ƒæ•´é…ç½®æ–‡ä»¶"></a>5.è°ƒæ•´é…ç½®æ–‡ä»¶</h3><p>ä¿®æ”¹æœ¬åœ°ç›‘å¬</p><pre class=" language-bash"><code class="language-bash">bind 0.0.0.0 -::1</code></pre><p>æ·»åŠ å¯†ç éªŒè¯</p><pre class=" language-bash"><code class="language-bash">masterauth <span class="token string">"123"</span>requirepass <span class="token string">"123"</span></code></pre><p>é…ç½®æœ€å¤§è¿æ¥æ•°</p><pre class=" language-bash"><code class="language-bash">maxclients 4064</code></pre>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkins k8sæ­å»º</title>
      <link href="/bf262451/"/>
      <url>/bf262451/</url>
      
        <content type="html"><![CDATA[<h3 id="1-1-å‰è¨€"><a href="#1-1-å‰è¨€" class="headerlink" title="1.1 å‰è¨€"></a>1.1 å‰è¨€</h3><blockquote><p>æœ¬æ–‡ä¸»è¦ä»‹ç»åœ¨k8séƒ¨ç½²æµ‹è¯•ä½¿ç”¨çš„jenkins ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨å¤šèŠ‚ç‚¹ æˆ–è€…å…¶ä»–æ–¹å¼éƒ¨ç½²</p></blockquote><h3 id="2-1-éƒ¨ç½²æ­å»º"><a href="#2-1-éƒ¨ç½²æ­å»º" class="headerlink" title="2.1 éƒ¨ç½²æ­å»º"></a>2.1 éƒ¨ç½²æ­å»º</h3><h4 id="å‡†å¤‡æŒä¹…åŒ–æ•°æ®å·"><a href="#å‡†å¤‡æŒä¹…åŒ–æ•°æ®å·" class="headerlink" title="å‡†å¤‡æŒä¹…åŒ–æ•°æ®å·"></a>å‡†å¤‡æŒä¹…åŒ–æ•°æ®å·</h4><p>æˆ‘è¿™é‡Œä½¿ç”¨çš„storageclassä½œä¸ºåº•å±‚å­˜å‚¨ å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨nfs</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> jenkins<span class="token punctuation">-</span>data  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> jenkins<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>storageclass  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi</code></pre><h4 id="é…ç½®RBACæƒé™"><a href="#é…ç½®RBACæƒé™" class="headerlink" title="é…ç½®RBACæƒé™"></a>é…ç½®RBACæƒé™</h4><p>è¿™ä¸ªå®˜ç½‘æœ‰æä¾›å¯ä»¥å»å®˜ç½‘ä¸‹è½½</p><p><a href="https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-sa.yaml">jenkins-sa.yaml</a></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> jenkins  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> jenkins<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">rbac.authorization.kubernetes.io/autoupdate</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/bootstrapping</span><span class="token punctuation">:</span> rbac<span class="token punctuation">-</span>defaults  <span class="token key atrule">name</span><span class="token punctuation">:</span> jenkins<span class="token key atrule">rules</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">'*'</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> statefulsets  <span class="token punctuation">-</span> services  <span class="token punctuation">-</span> replicationcontrollers  <span class="token punctuation">-</span> replicasets  <span class="token punctuation">-</span> podtemplates  <span class="token punctuation">-</span> podsecuritypolicies  <span class="token punctuation">-</span> pods  <span class="token punctuation">-</span> pods/log  <span class="token punctuation">-</span> pods/exec  <span class="token punctuation">-</span> podpreset  <span class="token punctuation">-</span> poddisruptionbudget  <span class="token punctuation">-</span> persistentvolumes  <span class="token punctuation">-</span> persistentvolumeclaims  <span class="token punctuation">-</span> jobs  <span class="token punctuation">-</span> endpoints  <span class="token punctuation">-</span> deployments  <span class="token punctuation">-</span> deployments/scale  <span class="token punctuation">-</span> daemonsets  <span class="token punctuation">-</span> cronjobs  <span class="token punctuation">-</span> configmaps  <span class="token punctuation">-</span> namespaces  <span class="token punctuation">-</span> events  <span class="token punctuation">-</span> secrets  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> create  <span class="token punctuation">-</span> get  <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> delete  <span class="token punctuation">-</span> list  <span class="token punctuation">-</span> patch  <span class="token punctuation">-</span> update<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">""</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> nodes  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> get  <span class="token punctuation">-</span> list  <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> update<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">rbac.authorization.kubernetes.io/autoupdate</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/bootstrapping</span><span class="token punctuation">:</span> rbac<span class="token punctuation">-</span>defaults  <span class="token key atrule">name</span><span class="token punctuation">:</span> jenkins<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> jenkins<span class="token key atrule">subjects</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>serviceaccounts<span class="token punctuation">:</span>jenkins</code></pre><h3 id="DeployMenté…ç½®"><a href="#DeployMenté…ç½®" class="headerlink" title="DeployMenté…ç½®"></a>DeployMenté…ç½®</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> jenkins  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> jenkins  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> jenkins<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> jenkins  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> jenkins    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> jenkins      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jenkins        <span class="token key atrule">image</span><span class="token punctuation">:</span> jenkins/jenkins<span class="token punctuation">:</span>2.346.2        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>                               <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">0                      </span><span class="token comment" spellcheck="true">#è®¾ç½®ä»¥ROOTç”¨æˆ·è¿è¡Œå®¹å™¨</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true                  </span><span class="token comment" spellcheck="true">#æ‹¥æœ‰ç‰¹æƒ</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">50000</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2Gi            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"2000m"</span>        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LIMITS_MEMORY          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">resourceFieldRef</span><span class="token punctuation">:</span>              <span class="token key atrule">resource</span><span class="token punctuation">:</span> limits.memory              <span class="token key atrule">divisor</span><span class="token punctuation">:</span> 1Mi        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"JAVA_OPTS"</span>                 <span class="token comment" spellcheck="true">#è®¾ç½®å˜é‡ï¼ŒæŒ‡å®šæ—¶åŒºå’Œ jenkins slave æ‰§è¡Œè€…è®¾ç½®</span>          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"                    -Xmx$(LIMITS_MEMORY)m                    -XshowSettings:vm                    -Dhudson.slaves.NodeProvisioner.initialDelay=0                   -Dhudson.slaves.NodeProvisioner.MARGIN=50                   -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85                   -Duser.timezone=Asia/Shanghai                 "</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"JENKINS_OPTS"</span>          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"--prefix=/jenkins"</span>         <span class="token comment" spellcheck="true">#è®¾ç½®è·¯å¾„å‰ç¼€åŠ ä¸Š Jenkins</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>                        <span class="token comment" spellcheck="true">#è®¾ç½®è¦æŒ‚åœ¨çš„ç›®å½•</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/jenkins_home      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> jenkins<span class="token punctuation">-</span>data                 <span class="token comment" spellcheck="true">#è®¾ç½®PVC</span></code></pre><h4 id="é…ç½®svc"><a href="#é…ç½®svc" class="headerlink" title="é…ç½®svc"></a>é…ç½®svc</h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> jenkins  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> jenkins  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> jenkins<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080                      </span><span class="token comment" spellcheck="true">#æœåŠ¡ç«¯å£</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">32001                 </span><span class="token comment" spellcheck="true">#NodePortæ–¹å¼æš´éœ² Jenkins ç«¯å£</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">50000                     </span><span class="token comment" spellcheck="true">#ä»£ç†ç«¯å£</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">50000</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">32002</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> jenkins</code></pre><h3 id="3-1-äº¤ä»˜K8s"><a href="#3-1-äº¤ä»˜K8s" class="headerlink" title="3.1 äº¤ä»˜K8s"></a>3.1 äº¤ä»˜K8s</h3><pre class=" language-bash"><code class="language-bash"> kubectl apply -f <span class="token keyword">.</span></code></pre><p>å¾…podå¯åŠ¨å®Œæˆå³å¯</p><h3 id="4-1-å±•ç¤º"><a href="#4-1-å±•ç¤º" class="headerlink" title="4.1 å±•ç¤º"></a>4.1 å±•ç¤º</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/08/Xnip2022-08-04_11-25-44.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DevOps </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>javaå¦‚ä½•æœåŠ¡ä¼˜é›…ä»nacosä¸­å…³é—­</title>
      <link href="/666e2e4a/"/>
      <url>/666e2e4a/</url>
      
        <content type="html"><![CDATA[<h3 id="1-1-å‰è¨€"><a href="#1-1-å‰è¨€" class="headerlink" title="1.1 å‰è¨€"></a>1.1 å‰è¨€</h3><blockquote><p>åœ¨å¾®æœåŠ¡æ—¶ä»£,æˆ‘ä»¬ç›´æ¥å…³é—­ä¸€ä¸ªpod,é‚£è¿™éƒ¨åˆ†æµé‡å°±æ— æ³•å¾—åˆ°æ­£ç¡®å¤„ç†ï¼Œä¼šå½±å“éƒ¨åˆ†ç”¨æˆ·.é€šå¸¸æ¥è¯´ç½‘å…³æˆ–è€…æ³¨å†Œä¸­å¿ƒä¼šå°†æˆ‘ä»¬çš„æœåŠ¡ä¿æŒä¸€ä¸ªå¿ƒè·³ï¼Œè¿‡äº†å¿ƒè·³è¶…æ—¶ä¹‹åä¼šè‡ªåŠ¨æ‘˜é™¤æˆ‘ä»¬çš„æœåŠ¡ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¶…æ—¶æ—¶é—´å¯èƒ½æ˜¯30ç§’ä¹Ÿå¯èƒ½æ˜¯60ç§’ï¼Œè™½ç„¶ä¸ä¼šå½±å“æˆ‘ä»¬çš„ç³»ç»Ÿï¼Œä½†æ˜¯ä¼šäº§ç”Ÿç”¨æˆ·è½»å¾®æŠ–åŠ¨ã€‚</p></blockquote><blockquote><p>å¦‚æœæˆ‘ä»¬åœ¨åœæ­¢å‰æ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Œé€šçŸ¥ç½‘å…³æˆ–è€…æ³¨å†Œä¸­å¿ƒè¿™å°ä¸»æœºè¿›è¡Œä¸‹çº¿ï¼Œé‚£ä¹ˆæ³¨å†Œä¸­å¿ƒå°±ä¼šæ ‡è®°è¿™å°ä¸»æœºå·²ç»ä¸‹çº¿ï¼Œä¸è¿›è¡Œæµé‡è½¬å‘ï¼Œç”¨æˆ·å°±ä¸ä¼šæœ‰ä»»ä½•å½±å“ï¼Œè¿™å°±æ˜¯ä¼˜é›…åœæ­¢ï¼Œå°†æ»šåŠ¨æ›´æ–°å½±å“æœ€å°åŒ–</p></blockquote><h3 id="1-2-PreStop"><a href="#1-2-PreStop" class="headerlink" title="1.2 PreStop"></a>1.2 PreStop</h3><p>è¿™é‡Œä»¥<code>Nacos</code>ä¸ºä¾‹</p><p><code>Nacos</code> ç›®å‰æ”¯æŒä¸´æ—¶å®ä¾‹ä½¿ç”¨å¿ƒè·³ä¸ŠæŠ¥æ–¹å¼ç»´æŒæ´»æ€§ï¼Œå‘é€å¿ƒè·³çš„å‘¨æœŸé»˜è®¤æ˜¯ 5 ç§’ï¼Œ<code>Nacos </code>æœåŠ¡ç«¯ä¼šåœ¨ 15 ç§’æ²¡æ”¶åˆ°å¿ƒè·³åå°†å®ä¾‹è®¾ç½®ä¸ºä¸å¥åº·ï¼Œ</p><p>åœ¨ 30 ç§’æ²¡æ”¶åˆ°å¿ƒè·³æ—¶å°†è¿™ä¸ªä¸´æ—¶å®ä¾‹æ‘˜é™¤ã€‚è¿™é‡Œè¦æ³¨æ„30ç§’è¿™ä¸ªæ—¶é—´</p><p>nacos æœåŠ¡æ‰‹åŠ¨ä¸‹çº¿æ–¹æ³•</p><pre class=" language-bash"><code class="language-bash">curl -X PUT <span class="token string">"http://192.168.0.10:8848/nacos/v1/ns/instance?serviceName=java-test&amp;clusterName=DEFAULT&amp;groupName=test&amp;ip=10.10.90.20&amp;port=8888&amp;enabled=false"</span></code></pre><p>è¯´æ˜ï¼š</p><ul><li>192.168.0.10:8848 nacosæ³¨å†Œåœ°å€</li><li>java-test æ³¨å†Œçš„åº”ç”¨åç§°</li><li>10.10.90.20 æ³¨å†Œçš„åº”ç”¨åç§°æ‰€åœ¨ä¸»æœºåœ°å€</li><li>8888 æ³¨å†Œçš„åº”ç”¨åç§°ä½¿ç”¨çš„ç«¯å£å·</li><li>enabled&#x3D;false ä¸‹çº¿ï¼Œenabled&#x3D;true ä¸Šçº¿</li><li>namespaceId å‘½ä»¤ç©ºé—´ï¼Œé»˜è®¤ä½¿ç”¨publicå‘½åç©ºé—´åˆ™ä¸å†™è¿™ä¸ª</li></ul><p>è¿™é‡Œæ˜¯é€šè¿‡è„šæœ¬å…ˆæ³¨å…¥åˆ°é•œåƒå†… ç„¶åé…ç½®prestopæ¥è°ƒç”¨è¿™ä¸ªè„šæœ¬</p><pre class=" language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>NACOS_DISCOVERY_ADDR<span class="token operator">=</span>`printenv <span class="token operator">|</span> <span class="token function">grep</span> NACOS_DISCOVERY_ADDR <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">','</span> <span class="token string">'{print <span class="token variable">$1</span>}'</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">'='</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span><span class="token variable"><span class="token variable">`</span>SERVER_NAME<span class="token operator">=</span>$<span class="token punctuation">{</span>MY_POD_NAME<span class="token punctuation">}</span>PODIP<span class="token operator">=</span>$<span class="token punctuation">{</span>POD_OWN_IP_ADDRESS<span class="token punctuation">}</span>PORT<span class="token operator">=</span><span class="token variable">`</span></span>ss -tnl <span class="token operator">|</span> <span class="token function">grep</span> 0.0.0.0 <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$4</span>}'</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">':'</span> <span class="token string">'{print <span class="token variable">$2</span>}'</span>`<span class="token keyword">echo</span> <span class="token string">"è¾“å‡ºå¿…è¦çš„ç¯å¢ƒå˜é‡: <span class="token variable">${NACOS_DISCOVERY_ADDR}</span> <span class="token variable">${SERVER_NAME}</span> <span class="token variable">${RUN_ENV}</span> <span class="token variable">${PODIP}</span> <span class="token variable">${PORT}</span>"</span>result<span class="token operator">=</span><span class="token punctuation">$(</span>curl -X PUT <span class="token string">"http://<span class="token variable">${NACOS_DISCOVERY_ADDR}</span>/nacos/v1/ns/instance?serviceName=<span class="token variable">${SERVER_NAME}</span>&amp;clusterName=DEFAULT&amp;groupName=<span class="token variable">${RUN_ENV}</span>&amp;ip=<span class="token variable">${PODIP}</span>&amp;port=<span class="token variable">${PORT}</span>&amp;enabled=false"</span><span class="token punctuation">)</span><span class="token keyword">echo</span> <span class="token string">"è¾“å‡ºcurlæ‰§è¡Œç»“æœresult:<span class="token variable">${result}</span>"</span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">${result}</span> <span class="token operator">=</span> <span class="token string">"ok"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>  <span class="token keyword">echo</span> <span class="token string">"æ‰§è¡ŒæˆåŠŸ"</span>  <span class="token function">sleep</span> 45  <span class="token keyword">exit</span> 0<span class="token keyword">else</span>  <span class="token keyword">echo</span> <span class="token string">"æ‰§è¡Œå¤±è´¥"</span>  <span class="token keyword">exit</span> 1<span class="token keyword">fi</span></code></pre><p>å°†è„šæœ¬æ·»åŠ åˆ°åŸºç¡€é•œåƒä¸­</p><pre class=" language-bash"><code class="language-bash">ADD preStop.sh /tmp/pre_stop.shRUN <span class="token function">chmod</span> 777 /tmp/pre_stop.sh</code></pre><h3 id="1-3-yamlæ·»åŠ é…ç½®"><a href="#1-3-yamlæ·»åŠ é…ç½®" class="headerlink" title="1.3 yamlæ·»åŠ é…ç½®"></a>1.3 yamlæ·»åŠ é…ç½®</h3><pre class=" language-yaml"><code class="language-yaml">          <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>            <span class="token key atrule">preStop</span><span class="token punctuation">:</span>              <span class="token key atrule">exec</span><span class="token punctuation">:</span>                <span class="token key atrule">command</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> /bin/sh                  <span class="token punctuation">-</span> <span class="token string">'-c'</span>                  <span class="token punctuation">-</span> /tmp/pre_stop.sh</code></pre><p>å†æ¬¡é‡å¯æœåŠ¡å°†ä¼šå‘ç°è€æœåŠ¡ä¼šå…ˆå¤„äºä¸‹çº¿çŠ¶æ€ æŒç»­45såæ‰ä¼šæ­£å¸¸å…³é—­</p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubeadm å®‰è£…k8sé›†ç¾¤</title>
      <link href="/b07003b2/"/>
      <url>/b07003b2/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å®‰è£…"><a href="#ä¸€-å®‰è£…" class="headerlink" title="ä¸€ å®‰è£…"></a>ä¸€ å®‰è£…</h2><h3 id="1-1-ç®€ä»‹"><a href="#1-1-ç®€ä»‹" class="headerlink" title="1.1 ç®€ä»‹"></a>1.1 ç®€ä»‹</h3><p><code>kubeadm</code>æ˜¯å®˜æ–¹ç¤¾åŒºæ¨å‡ºçš„ä¸€ä¸ªç”¨äºå¿«é€Ÿéƒ¨ç½² <code>kubernetes</code> é›†ç¾¤çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·èƒ½é€šè¿‡ä¸¤æ¡æŒ‡ä»¤å®Œæˆä¸€ä¸ª<code>kubernetes</code>é›†ç¾¤çš„éƒ¨ç½²ï¼›</p><ul><li>åˆ›å»ºä¸€ä¸ªMasterèŠ‚ç‚¹ï¼š</li></ul><pre class=" language-bash"><code class="language-bash">kubeadm init</code></pre><ul><li>å°†NodeèŠ‚ç‚¹åŠ å…¥åˆ°Masteré›†ç¾¤ä¸­ï¼š</li></ul><pre class=" language-bash"><code class="language-bash">kubeadm <span class="token function">join</span> <span class="token operator">&lt;</span>MasterèŠ‚ç‚¹çš„IPå’Œç«¯å£<span class="token operator">></span></code></pre><h3 id="1-2-ç¯å¢ƒå‡†å¤‡"><a href="#1-2-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1.2 ç¯å¢ƒå‡†å¤‡"></a>1.2 ç¯å¢ƒå‡†å¤‡</h3><h5 id="å…³é—­é˜²ç«å¢™"><a href="#å…³é—­é˜²ç«å¢™" class="headerlink" title="å…³é—­é˜²ç«å¢™"></a>å…³é—­é˜²ç«å¢™</h5><pre class=" language-bash"><code class="language-bash">systemctl stop firewalldsystemctl disable firewalld</code></pre><h5 id="å…³é—­selinux"><a href="#å…³é—­selinux" class="headerlink" title="å…³é—­selinux"></a>å…³é—­selinux</h5><pre class=" language-bash"><code class="language-bash"><span class="token function">sed</span> -i <span class="token string">'s/enforcing/disabled/'</span> /etc/selinux/config <span class="token comment" spellcheck="true">#æ°¸ä¹…</span>setenforce 0 <span class="token comment" spellcheck="true">#ä¸´æ—¶</span></code></pre><h5 id="å…³é—­swap"><a href="#å…³é—­swap" class="headerlink" title="å…³é—­swap"></a>å…³é—­swap</h5><pre class=" language-bash"><code class="language-bash"><span class="token function">sed</span> -ri <span class="token string">'s/.*swap.*/#&amp;/'</span> /etc/fstab #æ°¸ä¹…swapoff -a <span class="token comment" spellcheck="true">#ä¸´æ—¶</span></code></pre><h5 id="æ·»åŠ hosts"><a href="#æ·»åŠ hosts" class="headerlink" title="æ·»åŠ hosts"></a>æ·»åŠ hosts</h5><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">>></span> /etc/hosts <span class="token operator">&lt;&lt;</span> <span class="token string">EOF192.168.0.10 k8smaster192.168.0.11 k8snodeEOF</span></code></pre><h5 id="è®¾ç½®ç½‘æ¡¥å‚æ•°"><a href="#è®¾ç½®ç½‘æ¡¥å‚æ•°" class="headerlink" title="è®¾ç½®ç½‘æ¡¥å‚æ•°"></a>è®¾ç½®ç½‘æ¡¥å‚æ•°</h5><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span> /etc/sysctl.d/k8s.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOFnet.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1EOF</span>sysctl --system <span class="token comment" spellcheck="true">#ç”Ÿæ•ˆ</span></code></pre><h5 id="æ—¶é—´åŒæ­¥"><a href="#æ—¶é—´åŒæ­¥" class="headerlink" title="æ—¶é—´åŒæ­¥"></a>æ—¶é—´åŒæ­¥</h5><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> ntpdate -yntpdate time.windows.com</code></pre><h3 id="1-3-å®‰è£…docker"><a href="#1-3-å®‰è£…docker" class="headerlink" title="1.3 å®‰è£…docker"></a>1.3 å®‰è£…docker</h3><h5 id="ä¸‹è½½docker-yumæº"><a href="#ä¸‹è½½docker-yumæº" class="headerlink" title="ä¸‹è½½docker yumæº"></a>ä¸‹è½½docker yumæº</h5><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</code></pre><h5 id="å®‰è£…æŒ‡å®šç‰ˆæœ¬docker"><a href="#å®‰è£…æŒ‡å®šç‰ˆæœ¬docker" class="headerlink" title="å®‰è£…æŒ‡å®šç‰ˆæœ¬docker"></a>å®‰è£…æŒ‡å®šç‰ˆæœ¬docker</h5><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> docker-ce-19.03.13 -y</code></pre><h5 id="é…ç½®åŠ é€Ÿå™¨åŠ é€Ÿä¸‹è½½"><a href="#é…ç½®åŠ é€Ÿå™¨åŠ é€Ÿä¸‹è½½" class="headerlink" title="é…ç½®åŠ é€Ÿå™¨åŠ é€Ÿä¸‹è½½"></a>é…ç½®åŠ é€Ÿå™¨åŠ é€Ÿä¸‹è½½</h5><pre class=" language-bash"><code class="language-bash">/etc/docker/daemon.json<span class="token punctuation">{</span><span class="token string">"registry-mirrors"</span><span class="token keyword">:</span> <span class="token punctuation">[</span><span class="token string">"https://registry.docker-cn.com"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h5 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h5><pre class=" language-bash"><code class="language-bash">systemctl <span class="token function">enable</span> docker.service</code></pre><h3 id="1-4-å®‰è£…k8s"><a href="#1-4-å®‰è£…k8s" class="headerlink" title="1.4 å®‰è£…k8s"></a>1.4 å®‰è£…k8s</h3><h5 id="æ·»åŠ k8sçš„é˜¿é‡Œäº‘YUMæº"><a href="#æ·»åŠ k8sçš„é˜¿é‡Œäº‘YUMæº" class="headerlink" title="æ·»åŠ k8sçš„é˜¿é‡Œäº‘YUMæº"></a>æ·»åŠ k8sçš„é˜¿é‡Œäº‘YUMæº</h5><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">></span> /etc/yum.repos.d/kubernetes.repo <span class="token operator">&lt;&lt;</span> <span class="token string">EOF[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64enabled=1gpgcheck=0repo_gpgcheck=0gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOF</span></code></pre><h5 id="å®‰è£…-kubeadmï¼Œkubelet-å’Œ-kubectl"><a href="#å®‰è£…-kubeadmï¼Œkubelet-å’Œ-kubectl" class="headerlink" title="å®‰è£… kubeadmï¼Œkubelet å’Œ kubectl"></a>å®‰è£… kubeadmï¼Œkubelet å’Œ kubectl</h5><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> kubelet-1.19.4 kubeadm-1.19.4 kubectl-1.19.4 -ysystemctl <span class="token function">enable</span> kubelet.service</code></pre><h2 id="äºŒ-åˆ›å»ºé›†ç¾¤"><a href="#äºŒ-åˆ›å»ºé›†ç¾¤" class="headerlink" title="äºŒ åˆ›å»ºé›†ç¾¤"></a>äºŒ åˆ›å»ºé›†ç¾¤</h2><h3 id="2-1-masterèŠ‚ç‚¹æ“ä½œ"><a href="#2-1-masterèŠ‚ç‚¹æ“ä½œ" class="headerlink" title="2.1 masterèŠ‚ç‚¹æ“ä½œ"></a>2.1 masterèŠ‚ç‚¹æ“ä½œ</h3><pre class=" language-bash"><code class="language-bash">kubeadm init --apiserver-advertise-address<span class="token operator">=</span>192.168.172.134 --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.19.4 --service-cidr<span class="token operator">=</span>10.96.0.0/12 --pod-network-cidr<span class="token operator">=</span>10.244.0.0/16</code></pre><p>æ‹·è´æ–‡ä»¶åˆ°nodeèŠ‚ç‚¹</p><pre class=" language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p <span class="token variable">$HOME</span>/.kube<span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token variable">$HOME</span>/.kube/config<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token keyword">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token variable">$HOME</span>/.kube/config</code></pre><h3 id="2-2-nodeèŠ‚ç‚¹æ“ä½œ"><a href="#2-2-nodeèŠ‚ç‚¹æ“ä½œ" class="headerlink" title="2.2 nodeèŠ‚ç‚¹æ“ä½œ"></a>2.2 nodeèŠ‚ç‚¹æ“ä½œ</h3><pre class=" language-bash"><code class="language-bash">kubeadm <span class="token function">join</span> 192.168.172.132:6443 --token wa5bif.zfuvbesevdfvf4of \--discovery-token-ca-cert-hash sha256:87cf5828d54dd80da13c4b57c57360370ea0267a7cc3991989ca3006cf3e44d8</code></pre><h3 id="2-3-æ·»åŠ ç½‘ç»œæ’ä»¶"><a href="#2-3-æ·»åŠ ç½‘ç»œæ’ä»¶" class="headerlink" title="2.3 æ·»åŠ ç½‘ç»œæ’ä»¶"></a>2.3 æ·»åŠ ç½‘ç»œæ’ä»¶</h3><h5 id="ä¸‹è½½kube-flannel-ymlæ–‡ä»¶"><a href="#ä¸‹è½½kube-flannel-ymlæ–‡ä»¶" class="headerlink" title="ä¸‹è½½kube-flannel.ymlæ–‡ä»¶"></a>ä¸‹è½½kube-flannel.ymlæ–‡ä»¶</h5><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</code></pre><h5 id="äº¤ä»˜k8s"><a href="#äº¤ä»˜k8s" class="headerlink" title="äº¤ä»˜k8s"></a>äº¤ä»˜k8s</h5><pre class=" language-bash"><code class="language-bash">kubectl apply -f kube-flannel.yml</code></pre><p>kubectl get nodesæŸ¥çœ‹é›†ç¾¤çŠ¶æ€ å°±ä¼šå˜ä¸ºready</p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java æ—¥å¸¸æ•…éšœæ’æŸ¥</title>
      <link href="/7665ec21/"/>
      <url>/7665ec21/</url>
      
        <content type="html"><![CDATA[<h3 id="1-1-Java-å¸¸ç”¨å·¥å…·ä»‹ç»"><a href="#1-1-Java-å¸¸ç”¨å·¥å…·ä»‹ç»" class="headerlink" title="1.1 Java å¸¸ç”¨å·¥å…·ä»‹ç»"></a>1.1 Java å¸¸ç”¨å·¥å…·ä»‹ç»</h3><p>è¿™äº›å‘½ä»¤åœ¨ JDK å®‰è£…ç›®å½•ä¸‹çš„ bin ç›®å½•ä¸‹ï¼š</p><ul><li><code>jps</code> (JVM Process Statusï¼‰: ç±»ä¼¼ UNIX çš„ ps å‘½ä»¤ã€‚ç”¨æˆ·æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹çš„å¯åŠ¨ç±»ã€ä¼ å…¥å‚æ•°å’Œ Java è™šæ‹Ÿæœºå‚æ•°ç­‰ä¿¡æ¯ï¼›</li><li><code>jstat</code>ï¼ˆ JVM Statistics Monitoring Toolï¼‰:  ç”¨äºæ”¶é›† HotSpot è™šæ‹Ÿæœºå„æ–¹é¢çš„è¿è¡Œæ•°æ®;</li><li><code>jinfo</code> (Configuration Info for Java) : Configuration Info forJava,æ˜¾ç¤ºè™šæ‹Ÿæœºé…ç½®ä¿¡æ¯;</li><li><code>jmap</code> (Memory Map for Java) :ç”Ÿæˆå †è½¬å‚¨å¿«ç…§;</li><li><code>jhat</code> (JVM Heap Dump Browser ) : ç”¨äºåˆ†æ heapdump æ–‡ä»¶ï¼Œå®ƒä¼šå»ºç«‹ä¸€ä¸ª HTTP&#x2F;HTML æœåŠ¡å™¨ï¼Œè®©ç”¨æˆ·å¯ä»¥åœ¨æµè§ˆå™¨ä¸ŠæŸ¥çœ‹åˆ†æç»“æœ;</li><li><code>jstack</code> (Stack Trace for Java):ç”Ÿæˆè™šæ‹Ÿæœºå½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§ï¼Œçº¿ç¨‹å¿«ç…§å°±æ˜¯å½“å‰è™šæ‹Ÿæœºå†…æ¯ä¸€æ¡çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•å †æ ˆçš„é›†åˆã€‚</li></ul><h4 id="Jps-æŸ¥çœ‹æ‰€æœ‰-Java-è¿›ç¨‹"><a href="#Jps-æŸ¥çœ‹æ‰€æœ‰-Java-è¿›ç¨‹" class="headerlink" title="Jps æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹"></a>Jps æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹</h4><p><code>jps</code>ç±»ä¼¼Linuxä¸­çš„<code>ps</code> å¯ä»¥æ˜¾ç¤ºå½“å‰è¿è¡Œçš„javaæœåŠ¡çš„<code>pid</code></p><pre class=" language-bash"><code class="language-bash">jps1 test.jar10837 Jps</code></pre><p><code>jps -l</code>è¾“å‡ºä¸»ç±»çš„å…¨åï¼Œå¦‚æœè¿›ç¨‹æ‰§è¡Œçš„æ˜¯ Jar åŒ…ï¼Œè¾“å‡º Jar è·¯å¾„</p><pre class=" language-bash"><code class="language-bash">jps -l1 test.jar8693 jdk.jcmd/sun.tools.jps.Jps</code></pre><p><code>jps -v</code>è¾“å‡ºè™šæ‹Ÿæœºè¿›ç¨‹å¯åŠ¨æ—¶ JVM å‚æ•°ã€‚</p><pre class=" language-bash"><code class="language-bash">jps -v1 test.jar -javaagent:/usr/local/skywalking/agent/skywalking-agent.jar8715 Jps -Denv.class.path<span class="token operator">=</span>.:/usr/local/openjdk-11/lib:/lib -Dapplication.home<span class="token operator">=</span>/usr/lib/jvm/java-11-openjdk-amd64 -Xms8m -Djdk.module.main<span class="token operator">=</span>jdk.jcmd</code></pre><h4 id="jstat-ç›‘è§†è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯"><a href="#jstat-ç›‘è§†è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯" class="headerlink" title="jstat ç›‘è§†è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯"></a>jstat ç›‘è§†è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯</h4><p><code>jstat</code>ï¼ˆJVM Statistics Monitoring Toolï¼‰ ä½¿ç”¨äºç›‘è§†è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯çš„å‘½ä»¤è¡Œå·¥å…·ã€‚ å®ƒå¯ä»¥æ˜¾ç¤ºæœ¬åœ°æˆ–è€…è¿œç¨‹ï¼ˆéœ€è¦è¿œç¨‹ä¸»æœºæä¾› RMI æ”¯æŒï¼‰è™šæ‹Ÿæœºè¿›ç¨‹ä¸­çš„ç±»ä¿¡æ¯ã€å†…å­˜ã€åƒåœ¾æ”¶é›†ã€JIT ç¼–è¯‘ç­‰è¿è¡Œæ•°æ®ï¼Œåœ¨æ²¡æœ‰ GUIï¼Œåªæä¾›äº†çº¯æ–‡æœ¬æ§åˆ¶å°ç¯å¢ƒçš„æœåŠ¡å™¨ä¸Šï¼Œå®ƒå°†æ˜¯è¿è¡ŒæœŸé—´å®šä½è™šæ‹Ÿæœºæ€§èƒ½é—®é¢˜çš„é¦–é€‰å·¥å…·ã€‚</p><p><code>jstat</code> å‘½ä»¤ä½¿ç”¨æ ¼å¼ï¼š</p><pre class=" language-bash"><code class="language-bash">jstat -<span class="token operator">&lt;</span>option<span class="token operator">></span> <span class="token punctuation">[</span>-t<span class="token punctuation">]</span> <span class="token punctuation">[</span>-h<span class="token operator">&lt;</span>lines<span class="token operator">></span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>vmid<span class="token operator">></span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>interval<span class="token operator">></span> <span class="token punctuation">[</span><span class="token operator">&lt;</span>count<span class="token operator">></span><span class="token punctuation">]</span><span class="token punctuation">]</span></code></pre><p>æ¯”å¦‚ <code>jstat -gc -h3 31736 1000 10</code>è¡¨ç¤ºåˆ†æè¿›ç¨‹ id ä¸º 31736 çš„ gc æƒ…å†µï¼Œæ¯éš” 1000ms æ‰“å°ä¸€æ¬¡è®°å½•ï¼Œæ‰“å° 10 æ¬¡åœæ­¢ï¼Œæ¯ 3 è¡Œåæ‰“å°æŒ‡æ ‡å¤´éƒ¨ã€‚</p><pre class=" language-bash"><code class="language-bash">jstat -gc -h3 1 1000 10 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   25088.0 25088.0  0.0   8996.0 201024.0 91785.3   501624.0   393269.6  195240.0 185525.6 26240.0 22619.2    491   15.240   6      2.737   -          -   17.97725088.0 25088.0  0.0   8996.0 201024.0 91801.5   501624.0   393269.6  195240.0 185525.6 26240.0 22619.2    491   15.240   6      2.737   -          -   17.97725088.0 25088.0  0.0   8996.0 201024.0 92093.9   501624.0   393269.6  195240.0 185525.6 26240.0 22619.2    491   15.240   6      2.737   -          -   17.977 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT   25088.0 25088.0  0.0   8996.0 201024.0 92321.7   501624.0   393269.6  195240.0 185525.6 26240.0 22619.2    491   15.240   6      2.737   -          -   17.97725088.0 25088.0  0.0   8996.0 201024.0 92339.7   501624.0   393269.6  195240.0 185525.6 26240.0 22619.2    491   15.240   6      2.737   -          -   17.97725088.0 25088.0  0.0   8996.0 201024.0 92343.5   501624.0   393269.6  195240.0 185525.6 26240.0 22619.2    491   15.240   6      2.737   -          -   17.977</code></pre><h4 id="jinfo-å®æ—¶åœ°æŸ¥çœ‹å’Œè°ƒæ•´è™šæ‹Ÿæœºå„é¡¹å‚æ•°"><a href="#jinfo-å®æ—¶åœ°æŸ¥çœ‹å’Œè°ƒæ•´è™šæ‹Ÿæœºå„é¡¹å‚æ•°" class="headerlink" title="jinfo å®æ—¶åœ°æŸ¥çœ‹å’Œè°ƒæ•´è™šæ‹Ÿæœºå„é¡¹å‚æ•°"></a>jinfo å®æ—¶åœ°æŸ¥çœ‹å’Œè°ƒæ•´è™šæ‹Ÿæœºå„é¡¹å‚æ•°</h4><p><code>jinfo vmid</code> :è¾“å‡ºå½“å‰ jvm è¿›ç¨‹çš„å…¨éƒ¨å‚æ•°å’Œç³»ç»Ÿå±æ€§ (ç¬¬ä¸€éƒ¨åˆ†æ˜¯ç³»ç»Ÿçš„å±æ€§ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯ JVM çš„å‚æ•°)ã€‚</p><p><code>jinfo -flag name vmid</code> :è¾“å‡ºå¯¹åº”åç§°çš„å‚æ•°çš„å…·ä½“å€¼ã€‚æ¯”å¦‚è¾“å‡º MaxHeapSizeã€æŸ¥çœ‹å½“å‰ jvm è¿›ç¨‹æ˜¯å¦å¼€å¯æ‰“å° GC æ—¥å¿— ( -XX:PrintGCDetails :è¯¦ç»† GC æ—¥å¿—æ¨¡å¼ï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯é»˜è®¤å…³é—­çš„)ã€‚</p><pre class=" language-bash"><code class="language-bash">jinfo  -flag MaxHeapSize 1-XX:MaxHeapSize<span class="token operator">=</span>8329887744jinfo  -flag PrintGC 1-XX:-PrintGC</code></pre><p>å¯ä»¥åœ¨ä¸é‡å¯çš„æƒ…å†µä¸‹åŠ¨æ€æ·»åŠ å‚æ•°</p><pre class=" language-bash"><code class="language-bash">jinfo  -flag  PrintGC 1-XX:-PrintGCjinfo  -flag  +PrintGC 1jinfo  -flag  PrintGC 1-XX:+PrintGC</code></pre><h4 id="jstack-ç”Ÿæˆè™šæ‹Ÿæœºå½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§-å †æ ˆä¿¡æ¯"><a href="#jstack-ç”Ÿæˆè™šæ‹Ÿæœºå½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§-å †æ ˆä¿¡æ¯" class="headerlink" title="jstack :ç”Ÿæˆè™šæ‹Ÿæœºå½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§ å †æ ˆä¿¡æ¯"></a>jstack :ç”Ÿæˆè™šæ‹Ÿæœºå½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§ å †æ ˆä¿¡æ¯</h4><p><code>jstack</code>ï¼ˆStack Trace for Javaï¼‰å‘½ä»¤ç”¨äºç”Ÿæˆè™šæ‹Ÿæœºå½“å‰æ—¶åˆ»çš„çº¿ç¨‹å¿«ç…§ã€‚çº¿ç¨‹å¿«ç…§å°±æ˜¯å½“å‰è™šæ‹Ÿæœºå†…æ¯ä¸€æ¡çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•å †æ ˆçš„é›†åˆ.</p><p>é€šè¿‡<code>jps</code>è·å–javaè¿›ç¨‹ç„¶åjstack åˆ†æå¯¹åº”çš„<code>pid</code></p><pre class=" language-bash"><code class="language-bash">jstack 1 <span class="token operator">></span> java.txt<span class="token comment" spellcheck="true">#å°†ç»“æœè¾“å‡ºåˆ°æ–‡ä»¶ä¸­</span></code></pre><h3 id="2-1-Arthasä½¿ç”¨"><a href="#2-1-Arthasä½¿ç”¨" class="headerlink" title="2.1 Arthasä½¿ç”¨"></a>2.1 Arthasä½¿ç”¨</h3><p><code>Arthas</code> æ˜¯Alibabaå¼€æºçš„Javaè¯Šæ–­å·¥å…·ï¼Œæ·±å—å¼€å‘è€…å–œçˆ±ã€‚</p><p>å½“ä½ é‡åˆ°ä»¥ä¸‹ç±»ä¼¼é—®é¢˜è€ŒæŸæ‰‹æ— ç­–æ—¶ï¼ŒArthaså¯ä»¥å¸®åŠ©ä½ è§£å†³ï¼š</p><ol><li>è¿™ä¸ªç±»ä»å“ªä¸ª jar åŒ…åŠ è½½çš„ï¼Ÿä¸ºä»€ä¹ˆä¼šæŠ¥å„ç§ç±»ç›¸å…³çš„ Exceptionï¼Ÿ</li><li>æˆ‘æ”¹çš„ä»£ç ä¸ºä»€ä¹ˆæ²¡æœ‰æ‰§è¡Œåˆ°ï¼Ÿéš¾é“æ˜¯æˆ‘æ²¡ commitï¼Ÿåˆ†æ”¯æé”™äº†ï¼Ÿ</li><li>é‡åˆ°é—®é¢˜æ— æ³•åœ¨çº¿ä¸Š debugï¼Œéš¾é“åªèƒ½é€šè¿‡åŠ æ—¥å¿—å†é‡æ–°å‘å¸ƒå—ï¼Ÿ</li><li>çº¿ä¸Šé‡åˆ°æŸä¸ªç”¨æˆ·çš„æ•°æ®å¤„ç†æœ‰é—®é¢˜ï¼Œä½†çº¿ä¸ŠåŒæ ·æ— æ³• debugï¼Œçº¿ä¸‹æ— æ³•é‡ç°ï¼</li><li>æ˜¯å¦æœ‰ä¸€ä¸ªå…¨å±€è§†è§’æ¥æŸ¥çœ‹ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µï¼Ÿ</li><li>æœ‰ä»€ä¹ˆåŠæ³•å¯ä»¥ç›‘æ§åˆ°JVMçš„å®æ—¶è¿è¡ŒçŠ¶æ€ï¼Ÿ</li><li>æ€ä¹ˆå¿«é€Ÿå®šä½åº”ç”¨çš„çƒ­ç‚¹ï¼Œç”Ÿæˆç«ç„°å›¾ï¼Ÿ</li><li>æ€æ ·ç›´æ¥ä»JVMå†…æŸ¥æ‰¾æŸä¸ªç±»çš„å®ä¾‹ï¼Ÿ</li></ol><h4 id="å®‰è£…æ–¹æ³•"><a href="#å®‰è£…æ–¹æ³•" class="headerlink" title="å®‰è£…æ–¹æ³•"></a>å®‰è£…æ–¹æ³•</h4><p>åœ¨<code>dockerfile</code>ä¸­ä¸‹è½½<code>arthas</code> <code>jar</code>åŒ…</p><pre class=" language-bash"><code class="language-bash">RUN <span class="token function">wget</span> https://arthas.aliyun.com/arthas-boot.jar</code></pre><p>å®‰è£…ååœ¨æœåŠ¡å†…<code>java -jar arthas-boot.jar</code>å¯åŠ¨å³å¯</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> arthas-boot version: 3.6.2<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Found existing java process, please choose one and input the serial number of the process, eg <span class="token keyword">:</span> 1. Then hit ENTER.* <span class="token punctuation">[</span>1<span class="token punctuation">]</span>: 1 test.jar  <span class="token punctuation">[</span>2<span class="token punctuation">]</span>: 11985 arthas-boot.jar1<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> arthas home: /root/.arthas/lib/3.6.2/arthas<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Try to attach process 1<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> Attach process 1 success.<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> arthas-client connect 127.0.0.1 3658  ,---.  ,------. ,--------.,--.  ,--.  ,---.   ,---. /  O  \ <span class="token operator">|</span>  .--. <span class="token string">''</span>--.  .--<span class="token string">'|  '</span>--<span class="token string">'  | /  O  \ '</span>   .-<span class="token string">'|  .-.  ||  '</span>--<span class="token string">'.'</span>   <span class="token operator">|</span>  <span class="token operator">|</span>   <span class="token operator">|</span>  .--.  <span class="token operator">||</span>  .-.  <span class="token operator">|</span><span class="token variable"><span class="token variable">`</span><span class="token keyword">.</span>  <span class="token variable">`</span></span>-.<span class="token operator">|</span>  <span class="token operator">|</span> <span class="token operator">|</span>  <span class="token operator">||</span>  <span class="token operator">|</span>\  \    <span class="token operator">|</span>  <span class="token operator">|</span>   <span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">|</span>  <span class="token operator">||</span>  <span class="token operator">|</span> <span class="token operator">|</span>  <span class="token operator">|</span>.-<span class="token string">'    |`--'</span> `--<span class="token string">'`--'</span> <span class="token string">'--'</span>   `--<span class="token string">'   `--'</span>  `--<span class="token string">'`--'</span> `--<span class="token string">'`-----'</span>wiki       https://arthas.aliyun.com/doctutorials  https://arthas.aliyun.com/doc/arthas-tutorials.htmlversion    3.6.2main_classpid        1<span class="token function">time</span>       2022-07-03 11:46:40</code></pre><h4 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h4><h5 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h5><pre class=" language-bash"><code class="language-bash">å®æ—¶æŸ¥çœ‹åº”ç”¨ç›‘æ§æ•°æ®</code></pre><h5 id="thread"><a href="#thread" class="headerlink" title="thread"></a>thread</h5><p>#æŸ¥çœ‹åº”ç”¨ç¨‹åºä¸­æ‰€æœ‰çº¿ç¨‹æƒ…å†µ</p><pre class=" language-bash"><code class="language-bash">thread Id <span class="token comment" spellcheck="true">#å‘½ä»¤æŸ¥çœ‹æŒ‡å®šçº¿ç¨‹çŠ¶æ€ä¿¡æ¯</span>thread -n <span class="token punctuation">{</span>n<span class="token punctuation">}</span> <span class="token comment" spellcheck="true">#æ‰“å°æœ€å¿™çš„nä¸ªçº¿ç¨‹çš„ä¿¡æ¯</span></code></pre><h5 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h5><pre class=" language-bash"><code class="language-bash">trace ç±» æ–¹æ³•æŸ¥çœ‹æ¯ä¸ªæ­¥éª¤è€—æ—¶</code></pre><h5 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h5><pre class=" language-bash"><code class="language-bash">stack ç±» æ–¹æ³•è¾“å‡ºå½“å‰æ–¹æ³•è¢«è°ƒç”¨çš„è°ƒç”¨è·¯å¾„</code></pre><h5 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h5><pre class=" language-bash"><code class="language-bash">æ–¹ä¾¿çš„è§‚å¯Ÿåˆ°æŒ‡å®šæ–¹æ³•çš„è°ƒç”¨æƒ…å†µã€‚èƒ½è§‚å¯Ÿåˆ°çš„èŒƒå›´ä¸ºï¼šè¿”å›å€¼ã€æŠ›å‡ºå¼‚å¸¸ã€å…¥å‚ï¼Œé€šè¿‡ç¼–å†™ OGNL è¡¨è¾¾å¼è¿›è¡Œ</code></pre><h3 id="MemoryAnalyzer-å†…å­˜åˆ†æ"><a href="#MemoryAnalyzer-å†…å­˜åˆ†æ" class="headerlink" title="MemoryAnalyzer å†…å­˜åˆ†æ"></a>MemoryAnalyzer å†…å­˜åˆ†æ</h3><p>ä¸‹è½½</p><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> http://kode.huhuhahei.cn/kodexplorer/taråŒ…/javaå†…å­˜åˆ†æ/MemoryAnalyzer-1.13.0.20220615-linux.gtk.x86_64.zipunzip MemoryAnalyzer-1.13.0.20220615-linux.gtk.x86_64.zip</code></pre><p>è§£å‹åä¼šå¾—åˆ°ä¸€ä¸ª<code>mat</code>çš„æ–‡ä»¶å¤¹</p><pre class=" language-bash"><code class="language-bash">jmap -dump:format<span class="token operator">=</span>b,file<span class="token operator">=</span>memory.dump <span class="token variable"><span class="token variable">`</span>pid<span class="token variable">`</span></span><span class="token comment" spellcheck="true">#æ‰§è¡Œåä¼šå¾—åˆ° memory.dump æ–‡ä»¶</span></code></pre><p>ä½¿ç”¨è§£å‹å<code>mat</code>æ–‡ä»¶å¤¹ä¸­<code>ParseHeapDump.sh</code>è„šæœ¬åˆ†æ<code>memory.dump</code></p><pre class=" language-bash"><code class="language-bash">./ParseHeapDump.sh memory.dump  org.eclipse.mat.api:suspects org.eclipse.mat.api:overview org.eclipse.mat.api:top_components</code></pre><p>æœ€ç»ˆä¼šç”Ÿæˆä¸‰ä¸ªzipæ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash">memory_Leak_Suspects.zipmemory_System_Overview.zipmemory_Top_Components.zip</code></pre><p>å°†<code>Leak_Suspects.zip</code>å¯¼å‡ºåˆ°æœ¬åœ°ç”µè„‘ï¼Œè§£å‹å‡ºæ¥ä¼šç”Ÿæˆé™æ€<code>html</code>ï¼Œè®¿é—®<code>index.html</code>å³å¯çœ‹åˆ°åˆ†æå†…å®¹</p><p>æ–‡ç« å‚è€ƒ:</p><p><a href="https://blog.csdn.net/u012371450/article/details/107507321">åˆ†æJavaç¨‹åºå†…å­˜æº¢å‡ºã€å†…å­˜ä¸æ–­å¢é•¿çš„åŸå› </a></p><p><a href="https://cloud.tencent.com/developer/article/1831207">Java çº¿ç¨‹è°ƒä¼˜</a></p>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istis-Bookinfo</title>
      <link href="/b0b4c461/"/>
      <url>/b0b4c461/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-bookinfoæ¶æ„ç®€ä»‹"><a href="#ä¸€-bookinfoæ¶æ„ç®€ä»‹" class="headerlink" title="ä¸€.bookinfoæ¶æ„ç®€ä»‹"></a>ä¸€.bookinfoæ¶æ„ç®€ä»‹</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/image-20220515121146209.png" alt="image-20220515121146209"></p><h1 id="äºŒ-éƒ¨ç½²bookinfo"><a href="#äºŒ-éƒ¨ç½²bookinfo" class="headerlink" title="äºŒ.éƒ¨ç½²bookinfo"></a>äºŒ.éƒ¨ç½²bookinfo</h1><h3 id="1-é…ç½®ç¯å¢ƒ"><a href="#1-é…ç½®ç¯å¢ƒ" class="headerlink" title="1.é…ç½®ç¯å¢ƒ"></a>1.é…ç½®ç¯å¢ƒ</h3><p>istioå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼æ³¨å…¥</p><p>é€šè¿‡åç§°ç©ºé—´è®¾ç½®lableçš„æ–¹å¼è‡ªåŠ¨æ³¨å…¥</p><pre class=" language-bash"><code class="language-bash"> kubectl  label namespace bookinfo istio-injection<span class="token operator">=</span>enable</code></pre><p>æ‰“ä¸Šæ ‡ç­¾åå¯ä»¥é€šè¿‡labelç¡®è®¤æ˜¯å¦æˆåŠŸ</p><pre class=" language-bash"><code class="language-bash">kubectl get ns/bookinfo --show-labelsNAME       STATUS   AGE    LABELSbookinfo   Active   9m9s   istio-injection<span class="token operator">=</span>enable,kubesphere.io/namespace<span class="token operator">=</span>bookinfo</code></pre><p>æ‰‹åŠ¨æ³¨å…¥</p><pre class=" language-bash"><code class="language-bash">kubectl apply -f <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml<span class="token punctuation">)</span></code></pre><h3 id="2-éƒ¨ç½²bookinfo"><a href="#2-éƒ¨ç½²bookinfo" class="headerlink" title="2.éƒ¨ç½²bookinfo"></a>2.éƒ¨ç½²bookinfo</h3><pre class=" language-bash"><code class="language-bash">kubectl apply -f  /usr/local/istio/samples/bookinfo/platform/kube/bookinfo.yaml -n bookinfoservice/details createdserviceaccount/bookinfo-details createddeployment.apps/details-v1 createdservice/ratings createdserviceaccount/bookinfo-ratings createddeployment.apps/ratings-v1 createdservice/reviews createdserviceaccount/bookinfo-reviews createddeployment.apps/reviews-v1 createddeployment.apps/reviews-v2 createddeployment.apps/reviews-v3 createdservice/productpage createdserviceaccount/bookinfo-productpage createddeployment.apps/productpage-v1 createdYou have mail <span class="token keyword">in</span> /var/spool/mail/root</code></pre><p>æŸ¥çœ‹podå¯ä»¥å‘ç°æ¯ä¸ªpodéƒ½æ˜¯ä¸¤ä¸ªå®¹å™¨äº†</p><pre class=" language-bash"><code class="language-bash">details-v1-78d78fbddf-t9jxr                    2/2     Running            0          2m10sproductpage-v1-596598f447-245bm                2/2     Running            0          2m10sratings-v1-6c9dbf6b45-tdjlh                    2/2     Running            0          2m10sreviews-v1-7bb8ffd9b6-zs8b5                    2/2     Running            0          2m10sreviews-v2-d7d75fff8-vtw8b                     2/2     Running            0          2m10sreviews-v3-68964bc4c8-fkljg                    2/2     Running            0          2m10s</code></pre><p>describeå¯ä»¥æŸ¥çœ‹åˆ°å®¹å™¨ä¹Ÿæ˜¯æ³¨å…¥æˆåŠŸçš„</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">..</span>. istio-proxy:    Container ID:  docker://8cd4c3bb24ef01f470b531f37c505fc5cd8984678229392577020e83ca047473    Image:         docker.io/istio/proxyv2:1.4.0    Image ID:      docker-pullable://istio/proxyv2@sha256:9ba9de87d660767a2147f786040a8fe29ebb3b335742d3c95257ab82a33b8415    Port:          15090/TCP    Host Port:     0/TCP    Args:<span class="token punctuation">..</span>.</code></pre><p>è‡³æ­¤bookinfoå·²ç»éƒ¨ç½²å®ŒæˆğŸ˜€</p><h1 id="ä¸‰-æ¥å…¥Istio"><a href="#ä¸‰-æ¥å…¥Istio" class="headerlink" title="ä¸‰.æ¥å…¥Istio"></a>ä¸‰.æ¥å…¥Istio</h1><h3 id="1-éƒ¨ç½²bookinfo-Gateway"><a href="#1-éƒ¨ç½²bookinfo-Gateway" class="headerlink" title="1.éƒ¨ç½²bookinfo Gateway"></a>1.éƒ¨ç½²bookinfo Gateway</h3><pre class=" language-bash"><code class="language-bash">kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml</code></pre><p>yamlæ–‡ä»¶å¦‚ä¸‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token punctuation">-</span>gateway<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment" spellcheck="true"># use istio default controller</span>  <span class="token key atrule">servers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> istio.default.bookinfo.com<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> istio.default.bookinfo.com  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> bookinfo<span class="token punctuation">-</span>gateway  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /productpage    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /static    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /login    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /logout    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /api/v1/products    <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage        <span class="token key atrule">port</span><span class="token punctuation">:</span>          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9080</span></code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æŸ¥çœ‹gateway</span>kubectl get gateways.networking.istio.ioNAME               AGEbookinfo-gateway   19m<span class="token comment" spellcheck="true">#æŸ¥çœ‹rv</span>kubectl get virtualservices.networking.istio.ioNAME       GATEWAYS             HOSTS   AGEbookinfo   <span class="token punctuation">[</span>bookinfo-gateway<span class="token punctuation">]</span>   <span class="token punctuation">[</span>*<span class="token punctuation">]</span>     20m</code></pre><p>éƒ¨ç½²å®Œæˆé€šè¿‡Istis-ingressgatewayè®¿é—®</p><pre class=" language-bash"><code class="language-bash">get svc -n istio-system <span class="token operator">|</span> <span class="token function">grep</span> gatewayistio-egressgateway      ClusterIP      10.68.20.211    <span class="token operator">&lt;</span>none<span class="token operator">></span>        80/TCP,443/TCP,15443/TCP                                                                                                     22histio-ingressgateway     LoadBalancer   10.68.159.17    <span class="token operator">&lt;</span>pending<span class="token operator">></span>     15020:38813/TCP,80:37266/TCP,443:27530/TCP,15029:28752/TCP,15030:21822/TCP,15031:34373/TCP,15032:27310/TCP,15443:36864/TCP   22h</code></pre><p>æµè§ˆå™¨è®¿é—®èŠ‚ç‚¹åœ°å€+NodePortç«¯å£</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/image-20220515135511693.png" alt="image-20220515135511693"></p><p>å¯ä»¥æ­£å¸¸è®¿é—® å¹¶ä¸”åˆ·æ–°reviewsæ˜¯ä¼šè½®è®­å˜åŒ–çš„ è¯æ˜æµé‡æ˜¯è½®è®­è½¬å‘åˆ°reviewsæœåŠ¡çš„ä¸åŒç‰ˆæœ¬ä¸­çš„</p><h3 id="2-éƒ¨ç½²é»˜è®¤åº”ç”¨è·¯ç”±"><a href="#2-éƒ¨ç½²é»˜è®¤åº”ç”¨è·¯ç”±" class="headerlink" title="2.éƒ¨ç½²é»˜è®¤åº”ç”¨è·¯ç”±"></a>2.éƒ¨ç½²é»˜è®¤åº”ç”¨è·¯ç”±</h3><pre class=" language-bash"><code class="language-bash">kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml</code></pre><p>yamlæ–‡ä»¶å¦‚ä¸‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> productpage<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v3    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v3<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2<span class="token punctuation">-</span>mysql    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2<span class="token punctuation">-</span>mysql  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>vm    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2<span class="token punctuation">-</span>mysql<span class="token punctuation">-</span>vm<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> details<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> details  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2<span class="token punctuation">---</span></code></pre><p>å¯ä»¥ç”¨è¿‡ä¸‹é¢å‘½ä»¤æŸ¥çœ‹</p><pre class=" language-bash"><code class="language-bash">kubectl get drNAME          HOST          AGEdetails       details       10mproductpage   productpage   10mratings       ratings       10mreviews       reviews       10m</code></pre><h1 id="ä¸‰-Kialiç®€ä»‹"><a href="#ä¸‰-Kialiç®€ä»‹" class="headerlink" title="ä¸‰.Kialiç®€ä»‹"></a>ä¸‰.Kialiç®€ä»‹</h1><h3 id="1-é…ç½®kialiåœ¨gatewayçš„è½¬å‘"><a href="#1-é…ç½®kialiåœ¨gatewayçš„è½¬å‘" class="headerlink" title="1.é…ç½®kialiåœ¨gatewayçš„è½¬å‘"></a>1.é…ç½®kialiåœ¨gatewayçš„è½¬å‘</h3><p>éœ€è¦å…ˆåˆ›å»ºsecret</p><pre class=" language-bash"><code class="language-bash">KIALI_USERNAME<span class="token operator">=</span><span class="token punctuation">$(</span>read -p <span class="token string">'Kiali Username: '</span> uval <span class="token operator">&amp;&amp;</span> <span class="token keyword">echo</span> -n <span class="token variable">$uval</span> <span class="token operator">|</span> base64<span class="token punctuation">)</span></code></pre><pre class=" language-bash"><code class="language-bash">KIALI_PASSPHRASE<span class="token operator">=</span><span class="token punctuation">$(</span>read -sp <span class="token string">'Kiali Passphrase: '</span> pval <span class="token operator">&amp;&amp;</span> <span class="token keyword">echo</span> -n <span class="token variable">$pval</span> <span class="token operator">|</span> base64<span class="token punctuation">)</span></code></pre><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> kubectl apply -f -apiVersion: v1kind: Secretmetadata:  name: kiali  namespace: istio-system  labels:    app: kialitype: Opaquedata:  username: <span class="token variable">$KIALI_USERNAME</span>  passphrase: <span class="token variable">$KIALI_PASSPHRASE</span>EOF</code></pre><p>å°†kialié…ç½®åˆ°gatewayä¸Š</p><pre class=" language-yaml"><code class="language-yaml">cat &lt;&lt;EOF <span class="token punctuation">|</span> kubectl apply <span class="token punctuation">-</span>f <span class="token punctuation">-</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kiali<span class="token punctuation">-</span>gateway  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway  <span class="token key atrule">servers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">15029</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>kiali      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"*"</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kiali<span class="token punctuation">-</span>vs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">"*"</span>  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> kiali<span class="token punctuation">-</span>gateway  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">15029</span>    <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> kiali        <span class="token key atrule">port</span><span class="token punctuation">:</span>          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">20001</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kiali  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> kiali  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>    <span class="token key atrule">tls</span><span class="token punctuation">:</span>      <span class="token key atrule">mode</span><span class="token punctuation">:</span> DISABLE<span class="token punctuation">---</span>EOF</code></pre><p>è®¿é—®èŠ‚ç‚¹ip+gateway15029NodePortç«¯å£</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/image-20220515143257500.png" alt="image-20220515143257500"></p><p>graphä¸­å°±å¯ä»¥çœ‹åˆ°bookinfoçš„è°ƒç”¨é“¾è·¯</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/image-20220515143433032.png" alt="image-20220515143433032"></p>]]></content>
      
      
      <categories>
          
          <category> Istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istio-ServiceEntryåº”ç”¨</title>
      <link href="/33557e2f/"/>
      <url>/33557e2f/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ServiceEntryè¯¦è§£"><a href="#ä¸€-ServiceEntryè¯¦è§£" class="headerlink" title="ä¸€.ServiceEntryè¯¦è§£"></a>ä¸€.ServiceEntryè¯¦è§£</h1><p><code>ServiceEntry</code>å…è®¸å°†å…¶ä»–æ¡ç›®æ·»åŠ åˆ° Istio çš„å†…éƒ¨æœåŠ¡æ³¨å†Œè¡¨ä¸­ï¼Œä»¥ä¾¿ç½‘æ ¼ä¸­è‡ªåŠ¨å‘ç°çš„æœåŠ¡å¯ä»¥è®¿é—®&#x2F;è·¯ç”±åˆ°è¿™äº›æ‰‹åŠ¨æŒ‡å®šçš„æœåŠ¡ã€‚æœåŠ¡æ¡ç›®æè¿°äº†æœåŠ¡çš„å±æ€§ï¼ˆDNS åç§°ã€VIPã€ç«¯å£ã€åè®®ã€ç«¯ç‚¹ï¼‰</p><h3 id="1-é…ç½®ä¸€ä¸ªå†…éƒ¨æœåŠ¡è®¿é—®å¤–éƒ¨apiçš„å…¥å£"><a href="#1-é…ç½®ä¸€ä¸ªå†…éƒ¨æœåŠ¡è®¿é—®å¤–éƒ¨apiçš„å…¥å£" class="headerlink" title="1.é…ç½®ä¸€ä¸ªå†…éƒ¨æœåŠ¡è®¿é—®å¤–éƒ¨apiçš„å…¥å£"></a>1.é…ç½®ä¸€ä¸ªå†…éƒ¨æœåŠ¡è®¿é—®å¤–éƒ¨apiçš„å…¥å£</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>svc<span class="token punctuation">-</span>https<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> api.dropboxapi.com  <span class="token punctuation">-</span> www.googleapis.com  <span class="token punctuation">-</span> api.facebook.com  <span class="token key atrule">location</span><span class="token punctuation">:</span> MESH_EXTERNAL  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> https    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TLS  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS</code></pre><h3 id="2-é…ç½®ä¸€ä¸ªé›†ç¾¤å¤–çš„MongoDBæ·»åŠ åˆ°Istioé›†ç¾¤ä¸­"><a href="#2-é…ç½®ä¸€ä¸ªé›†ç¾¤å¤–çš„MongoDBæ·»åŠ åˆ°Istioé›†ç¾¤ä¸­" class="headerlink" title="2.é…ç½®ä¸€ä¸ªé›†ç¾¤å¤–çš„MongoDBæ·»åŠ åˆ°Istioé›†ç¾¤ä¸­"></a>2.é…ç½®ä¸€ä¸ªé›†ç¾¤å¤–çš„MongoDBæ·»åŠ åˆ°Istioé›†ç¾¤ä¸­</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>svc<span class="token punctuation">-</span>mongocluster<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mymongodb.somedomain <span class="token comment" spellcheck="true"># not used</span>  <span class="token key atrule">addresses</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> 192.192.192.192/24 <span class="token comment" spellcheck="true"># VIPs</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">27018</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> mongodb    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> MONGO  <span class="token key atrule">location</span><span class="token punctuation">:</span> MESH_INTERNAL  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> STATIC  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> 2.2.2.2  <span class="token punctuation">-</span> <span class="token key atrule">address</span><span class="token punctuation">:</span> 3.3.3.3</code></pre><p>å’Œç›¸å…³çš„ DestinationRule</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mtls<span class="token punctuation">-</span>mongocluster<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> mymongodb.somedomain  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>    <span class="token key atrule">tls</span><span class="token punctuation">:</span>      <span class="token key atrule">mode</span><span class="token punctuation">:</span> MUTUAL      <span class="token key atrule">clientCertificate</span><span class="token punctuation">:</span> /etc/certs/myclientcert.pem      <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /etc/certs/client_private_key.pem      <span class="token key atrule">caCertificates</span><span class="token punctuation">:</span> /etc/certs/rootcacerts.pem</code></pre><h3 id="3-é…ç½®å‡ºå£Egress"><a href="#3-é…ç½®å‡ºå£Egress" class="headerlink" title="3.é…ç½®å‡ºå£Egress"></a>3.é…ç½®å‡ºå£Egress</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>svc<span class="token punctuation">-</span>httpbin  <span class="token key atrule">namespace</span> <span class="token punctuation">:</span> egress<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> httpbin.com  <span class="token key atrule">exportTo</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">"."</span>  <span class="token key atrule">location</span><span class="token punctuation">:</span> MESH_EXTERNAL  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP  <span class="token key atrule">resolution</span><span class="token punctuation">:</span> DNS</code></pre><p>å®šä¹‰ä¸€ä¸ªGatewayæ¥å¤„ç†å‡ºå£æµé‡</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>egressgateway <span class="token key atrule">namespace</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token key atrule">selector</span><span class="token punctuation">:</span>   <span class="token key atrule">istio</span><span class="token punctuation">:</span> egressgateway <span class="token key atrule">servers</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>     <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>     <span class="token key atrule">name</span><span class="token punctuation">:</span> http     <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>   <span class="token punctuation">-</span> <span class="token string">"*"</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istio-æµé‡æ§åˆ¶</title>
      <link href="/523b798e/"/>
      <url>/523b798e/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-é…ç½®æŒ‡å®šè·¯ç”±"><a href="#ä¸€-é…ç½®æŒ‡å®šè·¯ç”±" class="headerlink" title="ä¸€.é…ç½®æŒ‡å®šè·¯ç”±"></a>ä¸€.é…ç½®æŒ‡å®šè·¯ç”±</h1><h3 id="1-æœåŠ¡æ·»åŠ labels"><a href="#1-æœåŠ¡æ·»åŠ labels" class="headerlink" title="1.æœåŠ¡æ·»åŠ labels"></a>1.æœåŠ¡æ·»åŠ labels</h3><p>é…ç½®ä¾èµ–äºæœåŠ¡lableså«æœ‰versionæ‰å¯ä»¥æ ¹æ®ä¸é€šçš„ç‰ˆæœ¬æ¥åˆ†å‰²æµé‡</p><p>ä¾‹å¦‚</p><pre class=" language-yaml"><code class="language-yaml">  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1   <span class="token comment" spellcheck="true">#åŒ¹é…ä¹Ÿå¤ªæ·»åŠ version</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">prometheus.io/path</span><span class="token punctuation">:</span> /stats/prometheus        <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> <span class="token string">"15020"</span>        <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span>        <span class="token key atrule">sidecar.istio.io/status</span><span class="token punctuation">:</span> '<span class="token punctuation">{</span>"initContainers"<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"istio-init"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>"containers"<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"istio-proxy"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>"volumes"<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"istio-envoy"</span><span class="token punctuation">,</span><span class="token string">"istio-data"</span><span class="token punctuation">,</span><span class="token string">"istio-podinfo"</span><span class="token punctuation">,</span><span class="token string">"istiod-ca-cert"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>"imagePullSecrets"<span class="token punctuation">:</span><span class="token null important">null</span><span class="token punctuation">,</span>"revision"<span class="token punctuation">:</span><span class="token string">"default"</span><span class="token punctuation">}</span>'      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php        <span class="token key atrule">security.istio.io/tlsMode</span><span class="token punctuation">:</span> istio        <span class="token key atrule">service.istio.io/canonical-name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php        <span class="token key atrule">service.istio.io/canonical-revision</span><span class="token punctuation">:</span> v1        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1  <span class="token comment" spellcheck="true"># æŒ‡å®šversion</span></code></pre><p>æŸ¥çœ‹podæ˜¯å¦æœ‰è¿™ä¸ªlabels</p><pre class=" language-bash"><code class="language-bash">kubectl get po --show-labelsnginx-v1-74fb95984c-n4q7n         3/3     Running   0          147m    app<span class="token operator">=</span>nginx-php,pod-template-hash<span class="token operator">=</span>74fb95984c,security.istio.io/tlsMode<span class="token operator">=</span>istio,service.istio.io/canonical-name<span class="token operator">=</span>nginx-php,service.istio.io/canonical-revision<span class="token operator">=</span>v1,version<span class="token operator">=</span>v1nginx-v2-b6c55c89-dzq4z           3/3     Running   0          150m    app<span class="token operator">=</span>nginx-php,pod-template-hash<span class="token operator">=</span>b6c55c89,security.istio.io/tlsMode<span class="token operator">=</span>istio,service.istio.io/canonical-name<span class="token operator">=</span>nginx-php,service.istio.io/canonical-revision<span class="token operator">=</span>v2,version<span class="token operator">=</span>v2</code></pre><h3 id="2-é…ç½®Destination-Rule"><a href="#2-é…ç½®Destination-Rule" class="headerlink" title="2.é…ç½®Destination Rule"></a>2.é…ç½®Destination Rule</h3><p>è®¾ç½®Destination Ruleçš„ä¸åŒç‰ˆæœ¬,å°†æµé‡è½¬å‘ç»™ä¸åŒç‰ˆæœ¬çš„æœåŠ¡</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">provider</span><span class="token punctuation">:</span> asm<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">version</span><span class="token punctuation">:</span> v2    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1</code></pre><h3 id="3-é…ç½®VirtualService"><a href="#3-é…ç½®VirtualService" class="headerlink" title="3.é…ç½®VirtualService"></a>3.é…ç½®VirtualService</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>vs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> www.huhuhahei.cn  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>gateway  <span class="token key atrule">http</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx      <span class="token key atrule">route</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>            <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1          <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>            <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2          <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span></code></pre><p>kialiæŸ¥çœ‹å¯ä»¥å‘ç°æµé‡æ˜¯è½¬å‘åˆ°ä¸åŒç‰ˆæœ¬çš„åç«¯çš„</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/image-20220524135233931.png" alt="image-20220524135233931"></p><h1 id="äºŒ-æ¨¡æ‹Ÿæ³¨å…¥æ•…éšœ"><a href="#äºŒ-æ¨¡æ‹Ÿæ³¨å…¥æ•…éšœ" class="headerlink" title="äºŒ.æ¨¡æ‹Ÿæ³¨å…¥æ•…éšœ"></a>äºŒ.æ¨¡æ‹Ÿæ³¨å…¥æ•…éšœ</h1><h3 id="1-æ³¨å…¥-HTTP-å»¶è¿Ÿæ•…éšœ"><a href="#1-æ³¨å…¥-HTTP-å»¶è¿Ÿæ•…éšœ" class="headerlink" title="1.æ³¨å…¥ HTTP å»¶è¿Ÿæ•…éšœ"></a>1.æ³¨å…¥ HTTP å»¶è¿Ÿæ•…éšœ</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>vs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> www.huhuhahei.cn  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>gateway  <span class="token key atrule">http</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx      <span class="token key atrule">route</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>            <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1          <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>            <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2          <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>      <span class="token key atrule">fault</span><span class="token punctuation">:</span>        <span class="token key atrule">delay</span><span class="token punctuation">:</span>          <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 7s   <span class="token comment" spellcheck="true">#æ³¨å…¥å»¶è¿Ÿ7s</span>          <span class="token key atrule">percentage</span><span class="token punctuation">:</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100       </span><span class="token comment" spellcheck="true">#æ³¨å…¥çš„ç™¾åˆ†æ¯”</span></code></pre><p>kialiå¯ä»¥æŸ¥çœ‹åˆ°è®¿é—®çš„å¹³å‡å»¶è¿Ÿå‡é«˜åˆ°9.75s</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/image-20220524135615542.png" alt="image-20220524135615542"></p><h3 id="2-æ³¨å…¥http-abort-æ•…éšœ"><a href="#2-æ³¨å…¥http-abort-æ•…éšœ" class="headerlink" title="2.æ³¨å…¥http abort æ•…éšœ"></a>2.æ³¨å…¥http abort æ•…éšœ</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>vs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> www.huhuhahei.cn  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>gateway  <span class="token key atrule">http</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx      <span class="token key atrule">route</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>            <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1          <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>            <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php            <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2          <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>      <span class="token key atrule">fault</span><span class="token punctuation">:</span>        <span class="token key atrule">abort</span><span class="token punctuation">:</span>          <span class="token key atrule">httpStatus</span><span class="token punctuation">:</span> <span class="token number">500   </span><span class="token comment" spellcheck="true">#æ³¨å…¥500çŠ¶æ€ç </span>          <span class="token key atrule">percentage</span><span class="token punctuation">:</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">100       </span><span class="token comment" spellcheck="true">#æ³¨å…¥çš„ç™¾åˆ†æ¯”</span></code></pre><p>kialiæŸ¥çœ‹å¯ä»¥å‘ç°è®¿é—®å…¨æ˜¯5xx</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/image-20220524140439472.png" alt="image-20220524140439472"></p><h1 id="ä¸‰-åŸºäºç”¨æˆ·è®¤è¯"><a href="#ä¸‰-åŸºäºç”¨æˆ·è®¤è¯" class="headerlink" title="ä¸‰.åŸºäºç”¨æˆ·è®¤è¯"></a>ä¸‰.åŸºäºç”¨æˆ·è®¤è¯</h1><pre class=" language-bash"><code class="language-bash">kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml</code></pre><p>yamlæ–‡ä»¶å¦‚ä¸‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews  <span class="token punctuation">...</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> reviews  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason    <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1</code></pre><p>å†æ¬¡è®¿é—®booinfoå‘ç°åªèƒ½è®¿é—®åˆ°reviews v1æœåŠ¡</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/image-20220515143700189.png" alt="image-20220515143700189"></p><p>ç™»é™†jsonç”¨æˆ· å†æ¬¡è®¿é—® å‘ç°åªèƒ½è®¿é—®åˆ°reviews v2æœåŠ¡</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/image-20220515143910759.png" alt="image-20220515143910759">æ¸…ç†</p><pre class=" language-bash"><code class="language-bash">kubectl delete -f samples/bookinfo/networking/virtual-service-all-v1.yaml</code></pre><h1 id="å››-ç†”æ–­å™¨é…ç½®"><a href="#å››-ç†”æ–­å™¨é…ç½®" class="headerlink" title="å››.ç†”æ–­å™¨é…ç½®"></a>å››.ç†”æ–­å™¨é…ç½®</h1><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>    <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>      <span class="token key atrule">tcp</span><span class="token punctuation">:</span>        <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">http1MaxPendingRequests</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>      <span class="token key atrule">consecutive5xxErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 180s      <span class="token key atrule">maxEjectionPercent</span><span class="token punctuation">:</span> <span class="token number">100</span>  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">version</span><span class="token punctuation">:</span> v2    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1</code></pre><p>ä½¿ç”¨å·¥å…·è¯·æ±‚è§¦å‘ç†”æ–­</p><pre class=" language-bash"><code class="language-bash"><span class="token function">export</span> FORTIO_POD<span class="token operator">=</span><span class="token punctuation">$(</span>kubectl get pods -l app<span class="token operator">=</span>fortio -o <span class="token string">'jsonpath={.items[0].metadata.name}'</span><span class="token punctuation">)</span>kubectl <span class="token function">exec</span> <span class="token string">"<span class="token variable">$FORTIO_POD</span>"</span> -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 -loglevel Warning https://www.huhuhahei.cn07:38:03 I logger.go:128<span class="token operator">></span> Log level is now 3 Warning <span class="token punctuation">(</span>was 2 Info<span class="token punctuation">)</span>Fortio 1.32.0 running at 0 queries per second, 2-<span class="token operator">></span>2 procs, <span class="token keyword">for</span> 20 calls: https://www.huhuhahei.cnStarting at max qps with 2 thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax 2<span class="token punctuation">]</span> <span class="token keyword">for</span> exactly 20 calls <span class="token punctuation">(</span>10 per thread + 0<span class="token punctuation">)</span>07:38:08 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>1<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:08 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>1<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:08 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>1<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:09 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>0<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:09 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>0<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:09 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>0<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:09 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>1<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:09 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>0<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:09 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>1<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:09 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>0<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:09 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>0<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>07:38:09 W http_client.go:825<span class="token operator">></span> <span class="token punctuation">[</span>0<span class="token punctuation">]</span> Non ok http code 503 <span class="token punctuation">(</span>HTTP/1.1 503<span class="token punctuation">)</span>Ended after 5.132047777s <span class="token keyword">:</span> 20 calls. qps<span class="token operator">=</span>3.8971Aggregated Function Time <span class="token keyword">:</span> count 20 avg 0.51177983 +/- 0.727 min 0.000999321 max 2.04054618 <span class="token function">sum</span> 10.2355966<span class="token comment" spellcheck="true"># range, mid point, percentile, count</span><span class="token operator">>=</span> 0.000999321 <span class="token operator">&lt;=</span> 0.001 , 0.000999661 , 5.00, 1<span class="token operator">></span> 0.003 <span class="token operator">&lt;=</span> 0.004 , 0.0035 , 10.00, 1<span class="token operator">></span> 0.004 <span class="token operator">&lt;=</span> 0.005 , 0.0045 , 20.00, 2<span class="token operator">></span> 0.005 <span class="token operator">&lt;=</span> 0.006 , 0.0055 , 25.00, 1<span class="token operator">></span> 0.007 <span class="token operator">&lt;=</span> 0.008 , 0.0075 , 35.00, 2<span class="token operator">></span> 0.008 <span class="token operator">&lt;=</span> 0.009 , 0.0085 , 40.00, 1<span class="token operator">></span> 0.014 <span class="token operator">&lt;=</span> 0.016 , 0.015 , 45.00, 1<span class="token operator">></span> 0.016 <span class="token operator">&lt;=</span> 0.018 , 0.017 , 50.00, 1<span class="token operator">></span> 0.025 <span class="token operator">&lt;=</span> 0.03 , 0.0275 , 55.00, 1<span class="token operator">></span> 0.1 <span class="token operator">&lt;=</span> 0.12 , 0.11 , 60.00, 1<span class="token operator">></span> 0.14 <span class="token operator">&lt;=</span> 0.16 , 0.15 , 65.00, 1<span class="token operator">></span> 0.8 <span class="token operator">&lt;=</span> 0.9 , 0.85 , 70.00, 1<span class="token operator">></span> 0.9 <span class="token operator">&lt;=</span> 1 , 0.95 , 75.00, 1<span class="token operator">></span> 1 <span class="token operator">&lt;=</span> 2 , 1.5 , 95.00, 4<span class="token operator">></span> 2 <span class="token operator">&lt;=</span> 2.04055 , 2.02027 , 100.00, 1<span class="token comment" spellcheck="true"># target 50% 0.018</span><span class="token comment" spellcheck="true"># target 75% 1</span><span class="token comment" spellcheck="true"># target 90% 1.75</span><span class="token comment" spellcheck="true"># target 99% 2.03244</span><span class="token comment" spellcheck="true"># target 99.9% 2.03974</span>Error cases <span class="token keyword">:</span> count 12 avg 0.020801126 +/- 0.03857 min 0.000999321 max 0.146605165 <span class="token function">sum</span> 0.24961351<span class="token comment" spellcheck="true"># range, mid point, percentile, count</span><span class="token operator">>=</span> 0.000999321 <span class="token operator">&lt;=</span> 0.001 , 0.000999661 , 8.33, 1<span class="token operator">></span> 0.003 <span class="token operator">&lt;=</span> 0.004 , 0.0035 , 16.67, 1<span class="token operator">></span> 0.004 <span class="token operator">&lt;=</span> 0.005 , 0.0045 , 33.33, 2<span class="token operator">></span> 0.005 <span class="token operator">&lt;=</span> 0.006 , 0.0055 , 41.67, 1<span class="token operator">></span> 0.007 <span class="token operator">&lt;=</span> 0.008 , 0.0075 , 58.33, 2<span class="token operator">></span> 0.008 <span class="token operator">&lt;=</span> 0.009 , 0.0085 , 66.67, 1<span class="token operator">></span> 0.014 <span class="token operator">&lt;=</span> 0.016 , 0.015 , 75.00, 1<span class="token operator">></span> 0.016 <span class="token operator">&lt;=</span> 0.018 , 0.017 , 83.33, 1<span class="token operator">></span> 0.025 <span class="token operator">&lt;=</span> 0.03 , 0.0275 , 91.67, 1<span class="token operator">></span> 0.14 <span class="token operator">&lt;=</span> 0.146605 , 0.143303 , 100.00, 1<span class="token comment" spellcheck="true"># target 50% 0.0075</span><span class="token comment" spellcheck="true"># target 75% 0.016</span><span class="token comment" spellcheck="true"># target 90% 0.029</span><span class="token comment" spellcheck="true"># target 99% 0.145813</span><span class="token comment" spellcheck="true"># target 99.9% 0.146526</span>Sockets used: 12 <span class="token punctuation">(</span>for perfect keepalive, would be 2<span class="token punctuation">)</span>Uniform: false, Jitter: <span class="token boolean">false</span>IP addresses distribution:47.253.221.71:443: 2Code 200 <span class="token keyword">:</span> 8 <span class="token punctuation">(</span>40.0 %<span class="token punctuation">)</span>Code 503 <span class="token keyword">:</span> 12 <span class="token punctuation">(</span>60.0 %<span class="token punctuation">)</span>Response Header Sizes <span class="token keyword">:</span> count 20 avg 92.25 +/- 113 min 0 max 231 <span class="token function">sum</span> 1845Response Body/Total Sizes <span class="token keyword">:</span> count 20 avg 11177.25 +/- 1.349e+04 min 159 max 27709 <span class="token function">sum</span> 223545All <span class="token keyword">done</span> 20 calls <span class="token punctuation">(</span>plus 0 warmup<span class="token punctuation">)</span> 511.780 ms avg, 3.9 qps</code></pre><p>å¯ä»¥çœ‹åˆ°æ—¥å¿—è¾“å‡ºæœ‰40%æ˜¯æ­£å¸¸çš„200 60%çš„503</p><pre class=" language-bash"><code class="language-bash">Code 200 <span class="token keyword">:</span> 8 <span class="token punctuation">(</span>40.0 %<span class="token punctuation">)</span>Code 503 <span class="token keyword">:</span> 12 <span class="token punctuation">(</span>60.0 %<span class="token punctuation">)</span></code></pre><p>å…³é—­ç†”æ–­å™¨é‡æ–°æµ‹è¯•,ä¸šåŠ¡æ­£å¸¸</p><pre class=" language-yaml"><code class="language-yaml">kubectl exec "$FORTIO_POD" <span class="token punctuation">-</span>c fortio <span class="token punctuation">-</span><span class="token punctuation">-</span> /usr/bin/fortio load <span class="token punctuation">-</span>c 2 <span class="token punctuation">-</span>qps 0 <span class="token punctuation">-</span>n 20 <span class="token punctuation">-</span>loglevel Warning https<span class="token punctuation">:</span>//www.huhuhahei.cn07<span class="token punctuation">:</span>43<span class="token punctuation">:</span>52 I logger.go<span class="token punctuation">:</span>128<span class="token punctuation">></span> Log level is now 3 Warning (was 2 Info)Fortio 1.32.0 running at 0 queries per second<span class="token punctuation">,</span> 2<span class="token punctuation">-</span><span class="token punctuation">></span>2 procs<span class="token punctuation">,</span> for 20 calls<span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.huhuhahei.cnStarting at max qps with 2 thread(s) <span class="token punctuation">[</span>gomax 2<span class="token punctuation">]</span> for exactly 20 calls (10 per thread + 0)Ended after 13.996234101s <span class="token punctuation">:</span> 20 calls. qps=1.429Aggregated Function Time <span class="token punctuation">:</span> count 20 avg 1.3542445 +/<span class="token punctuation">-</span> 0.783 min 0.100419758 max 2.847801559 sum 27.0848909<span class="token comment" spellcheck="true"># range, mid point, percentile, count</span><span class="token punctuation">></span>= 0.10042 &lt;= 0.12 <span class="token punctuation">,</span> <span class="token number">0.11021 </span><span class="token punctuation">,</span> <span class="token number">5.00</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">></span> 0.12 &lt;= 0.14 <span class="token punctuation">,</span> <span class="token number">0.13 </span><span class="token punctuation">,</span> <span class="token number">15.00</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">></span> 0.9 &lt;= 1 <span class="token punctuation">,</span> <span class="token number">0.95 </span><span class="token punctuation">,</span> <span class="token number">30.00</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">></span> 1 &lt;= 2 <span class="token punctuation">,</span> <span class="token number">1.5 </span><span class="token punctuation">,</span> <span class="token number">75.00</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">></span> 2 &lt;= 2.8478 <span class="token punctuation">,</span> <span class="token number">2.4239 </span><span class="token punctuation">,</span> <span class="token number">100.00</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token comment" spellcheck="true"># target 50% 1.44444</span><span class="token comment" spellcheck="true"># target 75% 2</span><span class="token comment" spellcheck="true"># target 90% 2.50868</span><span class="token comment" spellcheck="true"># target 99% 2.81389</span><span class="token comment" spellcheck="true"># target 99.9% 2.84441</span>Error cases <span class="token punctuation">:</span> no dataSockets used<span class="token punctuation">:</span> 2 (for perfect keepalive<span class="token punctuation">,</span> would be 2)<span class="token key atrule">Uniform</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">Jitter</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>IP addresses distribution<span class="token punctuation">:</span><span class="token key atrule">47.253.221.71:443</span><span class="token punctuation">:</span> <span class="token number">2</span>Code 200 <span class="token punctuation">:</span> 20 (100.0 %)Response Header Sizes <span class="token punctuation">:</span> count 20 avg 230.55 +/<span class="token punctuation">-</span> 0.5895 min 229 max 231 sum 4611Response Body/Total Sizes <span class="token punctuation">:</span> count 20 avg 27704.95 +/<span class="token punctuation">-</span> 4.018 min 27700 max 27709 sum 554099All done 20 calls (plus 0 warmup) 1354.245 ms avg<span class="token punctuation">,</span> 1.4 qps</code></pre>]]></content>
      
      
      <categories>
          
          <category> Istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istio-Gatewayåº”ç”¨</title>
      <link href="/411d992e/"/>
      <url>/411d992e/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ç®€ä»‹"><a href="#ä¸€-ç®€ä»‹" class="headerlink" title="ä¸€.ç®€ä»‹"></a>ä¸€.ç®€ä»‹</h1><p>åœ¨å®é™…ä½¿ç”¨ä¸­æ›´å¤šçš„æ˜¯é…ç½® HTTPS ç­‰å®‰å…¨çš„å¤–éƒ¨è®¿é—®ã€‚ä¾‹å¦‚ï¼Œåœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œå°†ç½‘æ ¼å†…çš„ HTTPS æœåŠ¡é€šè¿‡ HTTPS åè®®å‘å¸ƒã€‚è¿™æ ·åœ¨æµè§ˆå™¨ç«¯ä¸­è¾“å…¥â€œ<a href="https://weather.com/">https://weather.com</a>â€å°±å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªæœåŠ¡</p><p><img src="https://static001.geekbang.org/wechat/images/78/78d61c7538d43755b0643769a8eca24d.png" alt="img"></p><h1 id="äºŒ-é…ç½®"><a href="#äºŒ-é…ç½®" class="headerlink" title="äºŒ.é…ç½®"></a>äºŒ.é…ç½®</h1><h3 id="1-ä½“ç³»ç»“æ„"><a href="#1-ä½“ç³»ç»“æ„" class="headerlink" title="1.ä½“ç³»ç»“æ„"></a>1.ä½“ç³»ç»“æ„</h3><p>å¯¹æ¯”k8s ingress-nginx</p><pre class=" language-bash"><code class="language-bash">gateway-controller    <span class="token operator">&lt;</span>-<span class="token operator">></span>   ingress-controller <span class="token punctuation">(</span>å®é™…çš„pod<span class="token punctuation">)</span>istio-ingressgateway  <span class="token operator">&lt;</span>-<span class="token operator">></span>   nginx-ingress-controller  <span class="token punctuation">(</span>ä¸€ç§å®ç°<span class="token punctuation">)</span>gateway               <span class="token operator">&lt;</span>-<span class="token operator">></span>   ingress <span class="token punctuation">(</span>é…ç½®<span class="token punctuation">)</span></code></pre><h3 id="2-é…ç½®Gateway"><a href="#2-é…ç½®Gateway" class="headerlink" title="2.é…ç½®Gateway"></a>2.é…ç½®Gateway</h3><p>å¦‚æœéœ€è¦<code>istio-ingressgateway</code>ä½œä¸ºå¤–ç½‘çš„è®¿é—®å…¥å£,å°±éœ€è¦å°†<code>Gateway</code>çš„ç½‘ç»œè®¾ç½®ä¸º<code>hostNetwork</code></p><p>éœ€è¦æ·»åŠ ä¸€ä¸‹ä¸¤ä¸ªé…ç½®</p><pre class=" language-bash"><code class="language-bash">dnsPolicy: ClusterFirstWithHostNethostNetwork: <span class="token boolean">true</span></code></pre><p>è®¾ç½®å®Œæˆåæœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦å¤„ç†,é»˜è®¤æƒ…å†µä¸‹<code>Gateway</code>ç›‘å¬çš„ç«¯å£æ˜¯8080å’Œ8443,å¦‚æœå¯¹å¤–æä¾›æœåŠ¡çš„è¯éœ€è¦ä½¿ç”¨iptableså°†å…¥å£çš„80å’Œ443æµé‡è½¬å‘åˆ°8080å’Œ8443</p><pre class=" language-bash"><code class="language-bash">iptables -t nat -A PREROUTING -p tcp --dport 443  -j REDIRECT --to-port 8443iptables -t nat -A PREROUTING -p tcp --dport 80  -j REDIRECT --to-port 8080</code></pre><p>è¿™æ ·é…ç½®è¿˜æœ‰ä¸ªç¼ºç‚¹,å°±æ˜¯æ§åˆ¶å™¨æ˜¯deploy,å¦‚æœé‡å¯è¿ç§»åˆ°å…¶ä»–çš„èŠ‚ç‚¹çš„è¯,å¦‚æœæ²¡æœ‰<code>iptables</code>è§„åˆ™,å°±æ— æ³•è®¿é—®äº†</p><p>æ‰€ä»¥å»ºè®®ä½¿ç”¨<code>nodeName: k8s-nacos-001</code> é™åˆ¶è°ƒåº¦åˆ°æŒ‡å®šèŠ‚ç‚¹,æˆ–è€…å°†deployä¿®æ”¹ä¸ºds</p><p>é…ç½®å®Œæˆåå¯ä»¥æŸ¥çœ‹æœ¬åœ°ç›‘å¬æ˜¯å¦æ­£å¸¸</p><pre class=" language-bash"><code class="language-bash"><span class="token function">netstat</span> -anpt <span class="token operator">|</span> <span class="token function">grep</span> -w 8443tcp        0      0 0.0.0.0:8443            0.0.0.0:*               LISTEN      11965/envoy         tcp        0      0 172.24.3.99:8443        123.52.19.50:51796      ESTABLISHED 11965/envoy         tcp        0      0 172.24.3.99:8443        123.52.19.50:52967      ESTABLISHED 11965/envoy <span class="token function">netstat</span> -anpt <span class="token operator">|</span> <span class="token function">grep</span> -w 8080tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      11965/envoy         tcp        0      0 172.24.3.99:8080        1.193.82.222:6698       ESTABLISHED 11965/envoy         tcp        0      0 172.24.3.99:8080        1.193.82.222:6750       ESTABLISHED 11965/envoy</code></pre><h3 id="3-é…ç½®æœåŠ¡é€šè¿‡Gateway"><a href="#3-é…ç½®æœåŠ¡é€šè¿‡Gateway" class="headerlink" title="3.é…ç½®æœåŠ¡é€šè¿‡Gateway"></a>3.é…ç½®æœåŠ¡é€šè¿‡Gateway</h3><p>ä»¥<code>nginx</code>ä¸ºä¾‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># Gatewayé…ç½®</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>http<span class="token punctuation">-</span>gateway<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway  <span class="token key atrule">servers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> www.huhuhahei.cn      <span class="token key atrule">port</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP<span class="token punctuation">---</span><span class="token comment" spellcheck="true">#VirtualServiceé…ç½®</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>http<span class="token punctuation">-</span>vs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>http<span class="token punctuation">-</span>gateway  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> www.huhuhahei.cn  <span class="token key atrule">http</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx      <span class="token key atrule">route</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>            <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php.default.svc.cluster.local            <span class="token key atrule">port</span><span class="token punctuation">:</span>              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>          <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">---</span><span class="token comment" spellcheck="true">#DestinationRuleé…ç½®</span><span class="token comment" spellcheck="true">#DestinationRuleé…ç½®</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kode <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> kode.default.svc.cluster.local  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>    <span class="token key atrule">portLevelSettings</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">tls</span><span class="token punctuation">:</span>        <span class="token key atrule">mode</span><span class="token punctuation">:</span> DISABLE</code></pre><h3 id="4-é…ç½®httpsè®¿é—®"><a href="#4-é…ç½®httpsè®¿é—®" class="headerlink" title="4.é…ç½®httpsè®¿é—®"></a>4.é…ç½®httpsè®¿é—®</h3><p>æ·»åŠ è¯ä¹¦åˆ°Gateway</p><pre class=" language-bash"><code class="language-bash">kubectl create -n istio-system secret tls istio-ingressgateway-certs --key private.key  --cert public.pem</code></pre><p>åœ¨IngressGatewayä¸­æŸ¥çœ‹è¯ä¹¦æ˜¯å¦æ·»åŠ æˆåŠŸ</p><pre class=" language-bash"><code class="language-bash">kubectl <span class="token function">exec</span> -it -n istio-system <span class="token punctuation">$(</span>kubectl -n istio-system get pods -l istio<span class="token operator">=</span>ingressgateway -o jsonpath<span class="token operator">=</span><span class="token string">'{.items[0].metadata.name}'</span><span class="token punctuation">)</span> -- <span class="token function">ls</span> -al /etc/istio/ingressgateway-certsdrwxrwsrwt 3 root istio-proxy  120 May 21 10:53 <span class="token keyword">.</span>drwxr-xr-x 1 root root        4096 May 21 10:53 <span class="token punctuation">..</span>drwxr-sr-x 2 root istio-proxy   80 May 21 10:53 <span class="token punctuation">..</span>2022_05_21_10_53_29.239795056lrwxrwxrwx 1 root root          31 May 21 10:53 <span class="token punctuation">..</span>data -<span class="token operator">></span> <span class="token punctuation">..</span>2022_05_21_10_53_29.239795056lrwxrwxrwx 1 root root          14 May 21 10:53 tls.crt -<span class="token operator">></span> <span class="token punctuation">..</span>data/tls.crtlrwxrwxrwx 1 root root          14 May 21 10:53 tls.key -<span class="token operator">></span> <span class="token punctuation">..</span>data/tls.key</code></pre><p>Gatewayä¸­é…ç½®è¯ä¹¦</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#Gateway</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>gateway  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway  <span class="token key atrule">servers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> www.huhuhahei.cn    <span class="token key atrule">port</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS    <span class="token key atrule">tls</span><span class="token punctuation">:</span>      <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE      <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /etc/istio/ingressgateway<span class="token punctuation">-</span>certs/tls.key      <span class="token key atrule">serverCertificate</span><span class="token punctuation">:</span> /etc/istio/ingressgateway<span class="token punctuation">-</span>certs/tls.crt<span class="token punctuation">---</span><span class="token comment" spellcheck="true">#VS</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>vs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>gateway  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> www.huhuhahei.cn  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php.default.svc.cluster.local        <span class="token key atrule">port</span><span class="token punctuation">:</span>          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span></code></pre><p>è¿™æ ·åŸŸåhttpå’Œhttpséƒ½å¯ä»¥è®¿é—®</p><h1 id="äºŒ-Gatewayé…ç½®è¯¦è§£"><a href="#äºŒ-Gatewayé…ç½®è¯¦è§£" class="headerlink" title="äºŒ.Gatewayé…ç½®è¯¦è§£"></a>äºŒ.Gatewayé…ç½®è¯¦è§£</h1><h3 id="1-é…ç½®httpå¼ºåˆ¶è°ƒæ•´https"><a href="#1-é…ç½®httpå¼ºåˆ¶è°ƒæ•´https" class="headerlink" title="1.é…ç½®httpå¼ºåˆ¶è°ƒæ•´https"></a>1.é…ç½®httpå¼ºåˆ¶è°ƒæ•´https</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>gateway  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">servers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>https      <span class="token key atrule">hosts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> www.huhuhahei.cn      <span class="token key atrule">tls</span><span class="token punctuation">:</span>        <span class="token key atrule">mode</span><span class="token punctuation">:</span> SIMPLE        <span class="token key atrule">serverCertificate</span><span class="token punctuation">:</span> /etc/istio/ingressgateway<span class="token punctuation">-</span>certs/tls.crt        <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /etc/istio/ingressgateway<span class="token punctuation">-</span>certs/tls.key    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>http      <span class="token key atrule">hosts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> www.huhuhahei.cn      <span class="token key atrule">tls</span><span class="token punctuation">:</span>        <span class="token key atrule">httpsRedirect</span><span class="token punctuation">:</span> <span class="token boolean important">true    </span><span class="token comment" spellcheck="true"># 301httpè·³è½¬https</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway</code></pre>]]></content>
      
      
      <categories>
          
          <category> Istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istio-DestnationRuleåº”ç”¨</title>
      <link href="/80e3be02/"/>
      <url>/80e3be02/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-DestnationRuleè¯¦è§£"><a href="#ä¸€-DestnationRuleè¯¦è§£" class="headerlink" title="ä¸€.DestnationRuleè¯¦è§£"></a>ä¸€.DestnationRuleè¯¦è§£</h1><h3 id="1-é…ç½®å¥åº·æ£€æŸ¥è½®è¯¢è½¬å‘"><a href="#1-é…ç½®å¥åº·æ£€æŸ¥è½®è¯¢è½¬å‘" class="headerlink" title="1.é…ç½®å¥åº·æ£€æŸ¥è½®è¯¢è½¬å‘"></a>1.é…ç½®å¥åº·æ£€æŸ¥è½®è¯¢è½¬å‘</h3><p>æœ€å°è¿æ¥æ•°</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token punctuation">-</span>ratings<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings.prod.svc.cluster.local  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>      <span class="token key atrule">simple</span><span class="token punctuation">:</span> LEAST_CONN</code></pre><p>æŒ‡å®šä¸åŒç‰ˆæœ¬è®¾ç½®ä¸åŒç®—æ³•</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token punctuation">-</span>ratings<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings.prod.svc.cluster.local  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>      <span class="token key atrule">simple</span><span class="token punctuation">:</span> LEAST_CONN  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> testversion    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v3    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>        <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN</code></pre><p>æ ¹æ®ä¸ç”¨ç«¯å£è®¾ç½®ä¸åŒè½¬å‘ç®—æ³•</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token punctuation">-</span>ratings<span class="token punctuation">-</span>port<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings.prod.svc.cluster.local  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># Apply to all ports</span>    <span class="token key atrule">portLevelSettings</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>        <span class="token key atrule">simple</span><span class="token punctuation">:</span> LEAST_CONN    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9080</span>      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>        <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN</code></pre><p>è®¾ç½®User cookieè¿›è¡Œå“ˆå¸Œç®—æ³•</p><pre class=" language-yaml"><code class="language-yaml"> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3 <span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule <span class="token key atrule">metadata</span><span class="token punctuation">:</span>   <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token punctuation">-</span>ratings <span class="token key atrule">spec</span><span class="token punctuation">:</span>   <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings.prod.svc.cluster.local   <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>     <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>       <span class="token key atrule">consistentHash</span><span class="token punctuation">:</span>         <span class="token key atrule">httpCookie</span><span class="token punctuation">:</span>           <span class="token key atrule">name</span><span class="token punctuation">:</span> user           <span class="token key atrule">ttl</span><span class="token punctuation">:</span> 0s</code></pre><p>æ ‡å‡†è´Ÿè½½å¹³è¡¡ç®—æ³•ã€‚</p><table><thead><tr><th>å§“å</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>ROUND_ROBIN</code></td><td>å¾ªç¯ç­–ç•¥ã€‚é»˜è®¤</td></tr><tr><td><code>LEAST_CONN</code></td><td>æœ€å°è¯·æ±‚è´Ÿè½½å‡è¡¡å™¨ä½¿ç”¨ O(1) ç®—æ³•ï¼Œè¯¥ç®—æ³•é€‰æ‹©ä¸¤ä¸ªéšæœºå¥åº·ä¸»æœºå¹¶é€‰æ‹©å…·æœ‰è¾ƒå°‘æ´»åŠ¨è¯·æ±‚çš„ä¸»æœºã€‚</td></tr><tr><td><code>RANDOM</code></td><td>éšæœºè´Ÿè½½å‡è¡¡å™¨é€‰æ‹©ä¸€ä¸ªéšæœºçš„å¥åº·ä¸»æœºã€‚å¦‚æœæ²¡æœ‰é…ç½®å¥åº·æ£€æŸ¥ç­–ç•¥ï¼Œéšæœºè´Ÿè½½å‡è¡¡å™¨çš„æ€§èƒ½é€šå¸¸æ¯”è½®è¯¢æ›´å¥½ã€‚</td></tr><tr><td><code>PASSTHROUGH</code></td><td>æ­¤é€‰é¡¹ä¼šå°†è¿æ¥è½¬å‘åˆ°è°ƒç”¨è€…è¯·æ±‚çš„åŸå§‹ IP åœ°å€ï¼Œè€Œä¸è¿›è¡Œä»»ä½•å½¢å¼çš„è´Ÿè½½å¹³è¡¡ã€‚å¿…é¡»å°å¿ƒä½¿ç”¨æ­¤é€‰é¡¹ã€‚å®ƒé€‚ç”¨äºé«˜çº§ç”¨ä¾‹ã€‚æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… Envoy ä¸­çš„åŸå§‹ç›®æ ‡è´Ÿè½½å‡è¡¡å™¨ã€‚</td></tr></tbody></table><h3 id="2-è®¾ç½®è¿æ¥æ± "><a href="#2-è®¾ç½®è¿æ¥æ± " class="headerlink" title="2.è®¾ç½®è¿æ¥æ± "></a>2.è®¾ç½®è¿æ¥æ± </h3><p>è§„åˆ™è®¾ç½®äº† 100 ä¸ªè¿æ¥åˆ°åä¸º myredissrv çš„ redis æœåŠ¡çš„é™åˆ¶ï¼Œè¿æ¥è¶…æ—¶ä¸º 30 æ¯«ç§’</p><pre><code>apiVersion: networking.istio.io/v1alpha3kind: DestinationRulemetadata:  name: bookinfo-redisspec:  host: myredissrv.prod.svc.cluster.local  trafficPolicy:    connectionPool:      tcp:        maxConnections: 100        connectTimeout: 30ms        tcpKeepalive:          time: 7200s          interval: 75s</code></pre><p>é€‚ç”¨äº HTTP1.1&#x2F;HTTP2&#x2F;GRPC è¿æ¥çš„è®¾ç½®ã€‚</p><table><thead><tr><th>åœºåœ°</th><th>ç±»å‹</th><th>æè¿°</th><th>å¿…éœ€çš„</th></tr></thead><tbody><tr><td><code>http1MaxPendingRequests</code></td><td><code>int32</code></td><td>å¯¹ç›®æ ‡çš„æœ€å¤§æŒ‚èµ· HTTP è¯·æ±‚æ•°ã€‚é»˜è®¤ 2^32-1ã€‚</td><td>ä¸</td></tr><tr><td><code>http2MaxRequests</code></td><td><code>int32</code></td><td>å¯¹åç«¯çš„æœ€å¤§è¯·æ±‚æ•°ã€‚é»˜è®¤ 2^32-1ã€‚</td><td>ä¸</td></tr><tr><td><code>maxRequestsPerConnection</code></td><td><code>int32</code></td><td>æ¯ä¸ªè¿æ¥åˆ°åç«¯çš„æœ€å¤§è¯·æ±‚æ•°ã€‚å°†æ­¤å‚æ•°è®¾ç½®ä¸º 1 å°†ç¦ç”¨ä¿æŒæ´»åŠ¨ã€‚é»˜è®¤ä¸º 0ï¼Œè¡¨ç¤ºâ€œæ— é™åˆ¶â€ï¼Œæœ€å¤§ä¸º 2^29ã€‚</td><td>ä¸</td></tr><tr><td><code>maxRetries</code></td><td><code>int32</code></td><td>åœ¨ç»™å®šæ—¶é—´å¯ä»¥å¯¹é›†ç¾¤ä¸­çš„æ‰€æœ‰ä¸»æœºè¿›è¡Œçš„æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚é»˜è®¤ä¸º 2^32-1ã€‚</td><td>ä¸</td></tr><tr><td><code>idleTimeout</code></td><td><code>Duration</code></td><td>ä¸Šæ¸¸è¿æ¥æ± è¿æ¥çš„ç©ºé—²è¶…æ—¶ã€‚ç©ºé—²è¶…æ—¶å®šä¹‰ä¸ºæ²¡æœ‰æ´»åŠ¨è¯·æ±‚çš„æ—¶é—´æ®µã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™é»˜è®¤ä¸º 1 å°æ—¶ã€‚å½“è¾¾åˆ°ç©ºé—²è¶…æ—¶æ—¶ï¼Œè¿æ¥å°†è¢«å…³é—­ã€‚è¯·æ³¨æ„ï¼ŒåŸºäºè¯·æ±‚çš„è¶…æ—¶æ„å‘³ç€ HTTP&#x2F;2 PING ä¸ä¼šä½¿è¿æ¥ä¿æŒæ´»åŠ¨çŠ¶æ€ã€‚é€‚ç”¨äº HTTP1.1 å’Œ HTTP2 è¿æ¥ã€‚</td><td>ä¸</td></tr><tr><td><code>h2UpgradePolicy</code></td><td><code>H2UpgradePolicy</code></td><td>æŒ‡å®šæ˜¯å¦åº”å°†å…³è”ç›®æ ‡çš„ http1.1 è¿æ¥å‡çº§åˆ° http2ã€‚</td><td>ä¸</td></tr></tbody></table><p>HTTP å’Œ TCP ä¸Šæ¸¸è¿æ¥é€šç”¨çš„è®¾ç½®ã€‚</p><table><thead><tr><th>åœºåœ°</th><th>ç±»å‹</th><th>æè¿°</th><th>å¿…éœ€çš„</th></tr></thead><tbody><tr><td><code>maxConnections</code></td><td><code>int32</code></td><td>åˆ°ç›®æ ‡ä¸»æœºçš„æœ€å¤§ HTTP1 &#x2F;TCP è¿æ¥æ•°ã€‚é»˜è®¤ 2^32-1ã€‚</td><td>ä¸</td></tr><tr><td><code>connectTimeout</code></td><td><code>Duration</code></td><td>TCP è¿æ¥è¶…æ—¶ã€‚</td><td>ä¸</td></tr><tr><td><code>tcpKeepalive</code></td><td><code>TcpKeepalive</code></td><td>å¦‚æœè®¾ç½®ï¼Œåˆ™åœ¨å¥—æ¥å­—ä¸Šè®¾ç½® SO_KEEPALIVE ä»¥å¯ç”¨ TCP Keepaliveã€‚</td><td>ä¸</td></tr></tbody></table><p>TCP ä¿æ´»ã€‚</p><table><thead><tr><th>åœºåœ°</th><th>ç±»å‹</th><th>æè¿°</th><th>å¿…éœ€çš„</th></tr></thead><tbody><tr><td><code>probes</code></td><td><code>uint32</code></td><td>åœ¨ç¡®å®šè¿æ¥å·²æ­»ä¹‹å‰ï¼Œè¦å‘é€ä¸”æ— å“åº”çš„æœ€å¤§ä¿æ´»æ¢æµ‹æ•°ã€‚é»˜è®¤æ˜¯ä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„é…ç½®ï¼ˆé™¤éè¢«è¦†ç›–ï¼ŒLinux é»˜è®¤ä¸º 9ã€‚ï¼‰</td><td>ä¸</td></tr><tr><td><code>time</code></td><td><code>Duration</code></td><td>åœ¨å¼€å§‹å‘é€ keep-alive æ¢æµ‹ä¹‹å‰ï¼Œè¿æ¥éœ€è¦ç©ºé—²çš„æŒç»­æ—¶é—´ã€‚é»˜è®¤æ˜¯ä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„é…ç½®ï¼ˆé™¤éè¢«è¦†ç›–ï¼ŒLinux é»˜è®¤ä¸º 7200sï¼ˆå³ 2 å°æ—¶ã€‚ï¼‰</td><td>ä¸</td></tr><tr><td><code>interval</code></td><td><code>Duration</code></td><td>ä¿æŒæ´»åŠ¨æ¢æµ‹ä¹‹é—´çš„æŒç»­æ—¶é—´ã€‚é»˜è®¤æ˜¯ä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„é…ç½®ï¼ˆé™¤éè¢«è¦†ç›–ï¼ŒLinux é»˜è®¤ä¸º 75sã€‚ï¼‰</td><td>ä¸</td></tr></tbody></table><h3 id="3-åç«¯æœåŠ¡å¥åº·æ£€æŸ¥"><a href="#3-åç«¯æœåŠ¡å¥åº·æ£€æŸ¥" class="headerlink" title="3.åç«¯æœåŠ¡å¥åº·æ£€æŸ¥"></a>3.åç«¯æœåŠ¡å¥åº·æ£€æŸ¥</h3><p>ä»¥ä¸‹è§„åˆ™å°†è¿æ¥æ± å¤§å°è®¾ç½®ä¸º 100 ä¸ª HTTP1 è¿æ¥ï¼Œå…¶ä¸­ä¸â€œreviewsâ€æœåŠ¡çš„è¯·æ±‚&#x2F;è¿æ¥ä¸è¶…è¿‡ 10 ä¸ªã€‚æ­¤å¤–ï¼Œå®ƒè®¾ç½®äº† 1000 ä¸ªå¹¶å‘ HTTP2 è¯·æ±‚çš„é™åˆ¶ï¼Œå¹¶å°†ä¸Šæ¸¸ä¸»æœºé…ç½®ä¸ºæ¯ 5 åˆ†é’Ÿæ‰«æä¸€æ¬¡ï¼Œä»¥ä¾¿ä»»ä½•è¿ç»­ 7 æ¬¡å¤±è´¥å¹¶å‡ºç° 502ã€503 æˆ– 504 é”™è¯¯ä»£ç çš„ä¸»æœºå°†è¢«å¼¹å‡º 15 åˆ†é’Ÿã€‚</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews<span class="token punctuation">-</span>cb<span class="token punctuation">-</span>policy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews.prod.svc.cluster.local  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>    <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>      <span class="token key atrule">tcp</span><span class="token punctuation">:</span>        <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">100</span>      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">http2MaxRequests</span><span class="token punctuation">:</span> <span class="token number">1000</span>        <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">10</span>    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>      <span class="token key atrule">consecutiveErrors</span><span class="token punctuation">:</span> <span class="token number">7    </span><span class="token comment" spellcheck="true">#æœ€å¤§å¤±è´¥æ¬¡æ•°</span>      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 5m            <span class="token comment" spellcheck="true">#æ‰«æé—´éš”æ—¶é—´</span>      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 15m   <span class="token comment" spellcheck="true">#è¸¢å‡ºé›†ç¾¤çš„æ—¶é—´</span></code></pre><table><thead><tr><th>åœºåœ°</th><th>ç±»å‹</th><th>æè¿°</th><th>å¿…éœ€çš„</th></tr></thead><tbody><tr><td><code>consecutiveErrors</code></td><td><code>int32</code></td><td>ä¸»æœºä»è¿æ¥æ± ä¸­å¼¹å‡ºä¹‹å‰çš„é”™è¯¯æ•°ã€‚é»˜è®¤ä¸º 5ã€‚å½“é€šè¿‡ HTTP è®¿é—®ä¸Šæ¸¸ä¸»æœºæ—¶ï¼Œ502ã€503 æˆ– 504 è¿”å›ç è¢«è§†ä¸ºé”™è¯¯ã€‚å½“é€šè¿‡ä¸é€æ˜çš„ TCP è¿æ¥è®¿é—®ä¸Šæ¸¸ä¸»æœºæ—¶ï¼Œè¿æ¥è¶…æ—¶å’Œè¿æ¥é”™è¯¯&#x2F;å¤±è´¥äº‹ä»¶è¢«è§†ä¸ºé”™è¯¯ã€‚</td><td>ä¸</td></tr><tr><td><code>interval</code></td><td><code>Duration</code></td><td>å–·å°„æ‰«æåˆ†æä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚æ ¼å¼ï¼š1h&#x2F;1m&#x2F;1s&#x2F;1msã€‚å¿…é¡» &gt;&#x3D;1 æ¯«ç§’ã€‚é»˜è®¤ä¸º 10 ç§’ã€‚</td><td>ä¸</td></tr><tr><td><code>baseEjectionTime</code></td><td><code>Duration</code></td><td>æœ€çŸ­å¼¹å°„æ—¶é—´ã€‚ä¸»æœºå°†ä¿æŒè¢«å¼¹å‡ºçš„æ—¶é—´ç­‰äºæœ€å°å¼¹å‡ºæŒç»­æ—¶é—´ä¸ä¸»æœºè¢«å¼¹å‡ºæ¬¡æ•°çš„ä¹˜ç§¯ã€‚è¿™ç§æŠ€æœ¯å…è®¸ç³»ç»Ÿè‡ªåŠ¨å¢åŠ ä¸å¥åº·çš„ä¸Šæ¸¸æœåŠ¡å™¨çš„å¼¹å‡ºå‘¨æœŸã€‚æ ¼å¼ï¼š1h&#x2F;1m&#x2F;1s&#x2F;1msã€‚å¿…é¡» &gt;&#x3D;1 æ¯«ç§’ã€‚é»˜è®¤ä¸º 30 ç§’ã€‚</td><td>ä¸</td></tr><tr><td><code>maxEjectionPercent</code></td><td><code>int32</code></td><td>ä¸Šæ¸¸æœåŠ¡çš„è´Ÿè½½å¹³è¡¡æ± ä¸­å¯ä»¥å¼¹å‡ºçš„ä¸»æœºçš„æœ€å¤§ç™¾åˆ†æ¯”ã€‚é»˜è®¤ä¸º 10%ã€‚</td><td>ä¸</td></tr><tr><td><code>minHealthPercent</code></td><td><code>int32</code></td><td>åªè¦å…³è”çš„è´Ÿè½½å¹³è¡¡æ± åœ¨å¥åº·æ¨¡å¼ä¸‹è‡³å°‘å…·æœ‰æœ€å°<em>å¥åº·</em>ç™¾åˆ†æ¯”çš„ä¸»æœºï¼Œå°±ä¼šå¯ç”¨å¼‚å¸¸å€¼æ£€æµ‹ã€‚å½“è´Ÿè½½å¹³è¡¡æ± ä¸­å¥åº·ä¸»æœºçš„ç™¾åˆ†æ¯”ä½äºæ­¤é˜ˆå€¼æ—¶ï¼Œå°†ç¦ç”¨å¼‚å¸¸å€¼æ£€æµ‹ï¼Œå¹¶ä¸”ä»£ç†å°†åœ¨æ± ä¸­çš„æ‰€æœ‰ä¸»æœºï¼ˆå¥åº·å’Œä¸å¥åº·ï¼‰ä¹‹é—´è¿›è¡Œè´Ÿè½½å¹³è¡¡ã€‚å¯ä»¥é€šè¿‡å°†é˜ˆå€¼è®¾ç½®ä¸º 0% æ¥ç¦ç”¨è¯¥é˜ˆå€¼ã€‚é»˜è®¤å€¼ä¸º 0%ï¼Œå› ä¸ºå®ƒé€šå¸¸ä¸é€‚ç”¨äºæ¯ä¸ªæœåŠ¡çš„ pod å¾ˆå°‘çš„ k8s ç¯å¢ƒã€‚</td><td>ä¸</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istioå¸è½½</title>
      <link href="/509abbe3/"/>
      <url>/509abbe3/</url>
      
        <content type="html"><![CDATA[<p>å¸è½½ä¼šåˆ é™¤RBACæƒé™ï¼Œistio-systemå‘½åç©ºé—´åŠå…¶ä¸‹çš„æ‰€æœ‰èµ„æºã€‚å¯ä»¥å¿½ç•¥ä¸å­˜åœ¨çš„èµ„æºçš„é”™è¯¯ï¼ˆå› ä¸ºå®ƒä»¬å¯èƒ½å·²è¢«åˆ†å±‚åˆ é™¤ï¼‰ã€‚</p><pre class=" language-bash"><code class="language-bash">$ kubectl delete -f samples/addons$ istioctl manifest generate --set profile<span class="token operator">=</span>demo <span class="token operator">|</span> kubectl delete --ignore-not-found<span class="token operator">=</span>true -f -</code></pre><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸åˆ é™¤istio-systemåç§°ç©ºé—´ã€‚ å¦‚æœä¸å†éœ€è¦ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†å…¶åˆ é™¤ï¼š</p><pre class=" language-bash"><code class="language-bash">$ kubectl delete namespace istio-system</code></pre><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒIstioè‡ªåŠ¨æ³¨å…¥Envoy sidecarä»£ç†çš„æ ‡ç­¾ä¸ä¼šè¢«åˆ é™¤ã€‚å¦‚æœä¸å†éœ€è¦ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†å…¶åˆ é™¤ã€‚</p><pre class=" language-bash"><code class="language-bash">$ kubectl label namespace default istio-injection-</code></pre>]]></content>
      
      
      <categories>
          
          <category> Istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s é€šè¿‡Comfigmapå¯¼å…¥ENV</title>
      <link href="/9a96ca61/"/>
      <url>/9a96ca61/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¸€èˆ¬æƒ…å†µä¸‹æœåŠ¡envæ˜¯ç›´æ¥é€šè¿‡yamlæ–‡ä»¶å¯¼å…¥çš„ç±»ä¼¼ å½“æ—¶å½“æˆ‘ä»¬å¤šä¸ªæœåŠ¡åŒæ—¶éœ€è¦è¿™ä¸ªé…ç½®çš„æ—¶å€™ å¦‚æœå•ä¸€é…ç½® åé¢ä¿®æ”¹çš„è¯å°±æ¯”è¾ƒéº»çƒ¦ </p></blockquote><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">env</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LOG_DIR    <span class="token key atrule">value</span><span class="token punctuation">:</span> /var/log/nginx</code></pre><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>configmap</code>çš„æ–¹æ³•å…ˆå£°æ˜é…ç½® ç„¶åé€šè¿‡envä¼ å…¥<code>pod</code>ä¸­</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">mysql.db.name</span><span class="token punctuation">:</span> test  <span class="token key atrule">mysql.host</span><span class="token punctuation">:</span> 192.168.0.10  <span class="token key atrule">mysql.password</span><span class="token punctuation">:</span> test  <span class="token key atrule">mysql.port</span><span class="token punctuation">:</span> <span class="token string">'3306'</span>  <span class="token key atrule">mysql.user</span><span class="token punctuation">:</span> test</code></pre><p>ç„¶åæˆ‘ä»¬åœ¨<code>yaml</code>æ–‡ä»¶ä¸­æŒ‡å®š</p><pre class=" language-yaml"><code class="language-yaml">            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_DB_NAME              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">name</span><span class="token punctuation">:</span> test                  <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.db.name            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_HOST              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">name</span><span class="token punctuation">:</span> test                  <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.host            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PORT              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">name</span><span class="token punctuation">:</span> test                  <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.port            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_USER              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">name</span><span class="token punctuation">:</span> test                  <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.user            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PASSWORD              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">name</span><span class="token punctuation">:</span> test                  <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.password</code></pre><p>è¿™æ ·åé¢å°±ç®—ä¿®æ”¹æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹<code>configmap</code>å°±å¯ä»¥ æœåŠ¡ä¼šè‡ªå·±è¯»é…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹</p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istio ç®€ä»‹</title>
      <link href="/82740f3b/"/>
      <url>/82740f3b/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-Istio-ç®€ä»‹"><a href="#ä¸€-Istio-ç®€ä»‹" class="headerlink" title="ä¸€.IstioÂ ç®€ä»‹"></a>ä¸€.IstioÂ ç®€ä»‹</h1><h2 id="1-Istioæ˜¯ä»€ä¹ˆ"><a href="#1-Istioæ˜¯ä»€ä¹ˆ" class="headerlink" title="1.Istioæ˜¯ä»€ä¹ˆ"></a>1.Istioæ˜¯ä»€ä¹ˆ</h2><blockquote><p>Istio æ˜¯ä¸€ä¸ª<code>ä¸Kubernetesç´§å¯†ç»“åˆ</code>çš„<code>é€‚ç”¨äºäº‘åŸç”Ÿåœºæ™¯</code>çš„<code>Service Meshå½¢æ€çš„</code>ç”¨äº<code>æœåŠ¡æ²»ç†</code>çš„å¼€æ”¾å¹³å°ã€‚</p></blockquote><p>æ ¹æ®Istioå®˜æ–¹çš„ä»‹ç»ï¼ŒæœåŠ¡æ²»ç†æ¶‰åŠè¿æ¥ï¼ˆConnectï¼‰ã€å®‰å…¨ï¼ˆSecureï¼‰ã€ç­–ç•¥æ‰§è¡Œï¼ˆControlï¼‰å’Œå¯è§‚å¯Ÿæ€§ï¼ˆObserveï¼‰ã€‚</p><ul><li><code>è¿æ¥</code>ï¼šIstioé€šè¿‡é›†ä¸­é…ç½®çš„æµé‡è§„åˆ™æ§åˆ¶æœåŠ¡é—´çš„æµé‡å’Œè°ƒç”¨ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€ç†”æ–­ã€æ•…éšœæ³¨å…¥ã€é‡è¯•ã€é‡å®šå‘ç­‰æœåŠ¡æ²»ç†åŠŸèƒ½ã€‚</li><li><code>å®‰å…¨</code>ï¼šIstioæä¾›é€æ˜çš„è®¤è¯æœºåˆ¶ã€é€šé“åŠ å¯†ã€æœåŠ¡è®¿é—®æˆæƒç­‰å®‰å…¨èƒ½åŠ›ï¼Œå¯å¢å¼ºæœåŠ¡è®¿é—®çš„å®‰å…¨æ€§ã€‚</li><li><code>ç­–ç•¥æ‰§è¡Œ</code>ï¼šIstioé€šè¿‡å¯åŠ¨æ€æ’æ‹”ã€å¯æ‰©å±•çš„ç­–ç•¥å®ç°è®¿é—®æ§åˆ¶ã€é€Ÿç‡é™åˆ¶ã€é…é¢ç®¡ç†ã€æœåŠ¡è®¡è´¹ç­‰èƒ½åŠ›ã€‚</li><li><code>å¯è§‚å¯Ÿæ€§</code>ï¼šåŠ¨æ€è·å–æœåŠ¡è¿è¡Œæ•°æ®å’Œè¾“å‡ºï¼Œæä¾›å¼ºå¤§çš„è°ƒç”¨é“¾ã€ç›‘æ§å’Œè°ƒç”¨æ—¥å¿—æ”¶é›†è¾“å‡ºçš„èƒ½åŠ›ã€‚é…åˆå¯è§†åŒ–å·¥å…·ï¼Œå¯æ–¹ä¾¿è¿ç»´äººå‘˜äº†è§£æœåŠ¡çš„è¿è¡ŒçŠ¶æ€ï¼Œå‘ç°å¹¶è§£å†³é—®é¢˜ã€‚</li></ul><h1 id="2-Istioçš„é‡è¦èƒ½åŠ›"><a href="#2-Istioçš„é‡è¦èƒ½åŠ›" class="headerlink" title="2. Istioçš„é‡è¦èƒ½åŠ›"></a>2. Istioçš„é‡è¦èƒ½åŠ›</h1><ul><li><code>æœåŠ¡è¿è¡Œå¯è§‚å¯Ÿæ€§</code>ï¼šç›‘æ§åº”ç”¨åŠç½‘ç»œç›¸å…³æ•°æ®ï¼Œå°†ç›¸å…³æŒ‡æ ‡ä¸æ—¥å¿—è®°å½•å‘é€è‡³ä»»æ„æ”¶é›†ã€èšåˆä¸æŸ¥è¯¢ç³»ç»Ÿä¸­ä»¥å®ç°åŠŸèƒ½æ‰©å±•ï¼Œè¿½è¸ªåˆ†ææ€§èƒ½çƒ­ç‚¹å¹¶å¯¹åˆ†å¸ƒå¼æ•…éšœæ¨¡å¼è¿›è¡Œè¯Šæ–­ã€‚</li><li><code>å¼¹æ€§ä¸æ•ˆç‡</code>ï¼šæä¾›äº†ç»Ÿä¸€çš„æ–¹æ³•é…ç½®é‡è¯•ã€è´Ÿè½½å‡è¡¡ã€æµé‡æ§åˆ¶å’Œæ–­è·¯å™¨ç­‰æ¥è§£å†³ç½‘ç»œå¯é æ€§ä½æ‰€é€ æˆçš„å„ç±»å¸¸è§æ•…éšœï¼Œæ›´è½»æ¾åœ°è¿ç»´é«˜å¼¹æ€§æœåŠ¡ç½‘æ ¼ã€‚</li><li><code>ç ”å‘äººå‘˜ç”Ÿäº§åŠ›</code>ï¼šç¡®ä¿ç ”å‘äººå‘˜ä¸“æ³¨äºåŸºäºå·²é€‰æ‹©çš„ç¼–ç¨‹è¯­è¨€æ„å»ºä¸šåŠ¡åŠŸèƒ½ï¼Œä¸ç”¨åœ¨ä»£ç ä¸­å¤„ç†åˆ†å¸ƒå¼ç³»ç»Ÿçš„é—®é¢˜ï¼Œä»è€Œæå¤§åœ°æå‡ç”Ÿäº§èƒ½åŠ›ã€‚</li><li><code>ç­–ç•¥é©±åŠ¨å‹è¿è¥</code>ï¼šè§£è€¦å¼€å‘ä¸è¿ç»´å›¢é˜Ÿçš„å·¥ä½œï¼Œåœ¨æ— é¡»æ›´æ”¹ä»£ç çš„å‰æä¸‹æå‡å®‰å…¨æ€§ã€ç›‘æ§èƒ½åŠ›ã€æ‰©å±•æ€§ä¸æœåŠ¡æ‹“æ‰‘æ°´å¹³ã€‚è¿è¥äººå‘˜èƒ½å¤Ÿä¸ä¾èµ–å¼€å‘æä¾›çš„èƒ½åŠ›ç²¾ç¡®æ§åˆ¶ç”Ÿæˆæµé‡ã€‚</li><li><code>é»˜è®¤å®‰å…¨</code>ï¼šå…è®¸è¿è¥äººå‘˜é…ç½®TLSåŒå‘è®¤è¯å¹¶ä¿æŠ¤å„æœåŠ¡ä¹‹é—´çš„æ‰€æœ‰é€šä¿¡ï¼Œå¹¶ä¸”å¼€å‘äººå‘˜å’Œè¿ç»´äººå‘˜ä¸ç”¨ç»´æŠ¤è¯ä¹¦ï¼Œä»¥åº”å¯¹åˆ†å¸ƒå¼è®¡ç®—ä¸­ç»å¸¸å­˜åœ¨çš„å¤§é‡ç½‘ç»œå®‰å…¨é—®é¢˜ã€‚</li><li><code>å¢é‡é€‚ç”¨</code>ï¼šè€ƒè™‘åˆ°ç½‘ç»œä¸­è¿è¡Œçš„å„æœåŠ¡çš„é€æ˜æ€§ï¼Œå…è®¸å›¢é˜ŸæŒ‰ç…§è‡ªå·±çš„èŠ‚å¥å’Œéœ€æ±‚é€æ­¥é€‚ç”¨å„é¡¹åŠŸèƒ½ï¼Œä¾‹å¦‚å…ˆè§‚å¯ŸæœåŠ¡è¿è¡Œæƒ…å†µå†è¿›è¡ŒæœåŠ¡æ²»ç†ç­‰ã€‚</li></ul><h1 id="3-Istioä¸æœåŠ¡æ²»ç†"><a href="#3-Istioä¸æœåŠ¡æ²»ç†" class="headerlink" title="3. Istioä¸æœåŠ¡æ²»ç†"></a>3. Istioä¸æœåŠ¡æ²»ç†</h1><p>Istioæ˜¯ä¸€ä¸ªæœåŠ¡æ²»ç†å¹³å°ï¼Œæ²»ç†çš„æ˜¯æœåŠ¡é—´çš„è®¿é—®ï¼Œåªè¦æœ‰è®¿é—®å°±å¯ä»¥æ²»ç†ï¼Œä¸åœ¨ä¹è¿™ä¸ªæœåŠ¡æ˜¯ä¸æ˜¯æ‰€è°“çš„å¾®æœåŠ¡ï¼Œä¹Ÿä¸è¦æ±‚è·‘åœ¨å…¶ä¸Šçš„ä»£ç æ˜¯å¦æ˜¯å¾®æœåŠ¡åŒ–çš„ã€‚</p><h2 id="3-1-å…³äºå¾®æœåŠ¡"><a href="#3-1-å…³äºå¾®æœåŠ¡" class="headerlink" title="3.1 å…³äºå¾®æœåŠ¡"></a>3.1 å…³äºå¾®æœåŠ¡</h2><blockquote><p>å¾®æœåŠ¡æ˜¯ä»¥ä¸€ç»„å°å‹æœåŠ¡æ¥å¼€å‘å•ä¸ªåº”ç”¨ç¨‹åºçš„æ–¹æ³•ï¼Œæ¯ä¸ªæœåŠ¡éƒ½è¿è¡Œåœ¨è‡ªå·±çš„è¿›ç¨‹ä¸­ï¼ŒæœåŠ¡é—´é‡‡ç”¨è½»é‡çº§é€šä¿¡æœºåˆ¶ï¼ˆé€šå¸¸ç”¨HTTPèµ„æºAPIï¼‰ã€‚è¿™äº›æœåŠ¡å›´ç»•ä¸šåŠ¡èƒ½åŠ›æ„å»ºå¹¶å¯é€šè¿‡å…¨è‡ªåŠ¨éƒ¨ç½²æœºåˆ¶ç‹¬ç«‹éƒ¨ç½²ï¼Œè¿˜å…±ç”¨ä¸€ä¸ªæœ€å°å‹çš„é›†ä¸­å¼ç®¡ç†ï¼Œå¯ç”¨ä¸åŒçš„è¯­è¨€å¼€å‘ï¼Œå¹¶ä½¿ç”¨ä¸åŒçš„æ•°æ®å­˜å‚¨æŠ€æœ¯.<br>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”Martin Fowler</p></blockquote><p>å¾®æœåŠ¡æœ¬è´¨ä¸Šæ˜¯åˆ†è€Œæ²»ä¹‹ã€åŒ–ç¹ä¸ºç®€çš„å“²å­¦æ™ºæ…§åœ¨è®¡ç®—æœºé¢†åŸŸçš„ä½“ç°ã€‚</p><h3 id="3-1-1-å¾®æœåŠ¡å¸¦æ¥çš„å¥½å¤„ï¼š"><a href="#3-1-1-å¾®æœåŠ¡å¸¦æ¥çš„å¥½å¤„ï¼š" class="headerlink" title="3.1.1 å¾®æœåŠ¡å¸¦æ¥çš„å¥½å¤„ï¼š"></a>3.1.1 å¾®æœåŠ¡å¸¦æ¥çš„å¥½å¤„ï¼š</h3><ul><li><code>ä»å¼€å‘è§†è§’æ¥çœ‹</code>ï¼šæ¯ä¸ªæœåŠ¡çš„åŠŸèƒ½æ›´å†…èšï¼Œå¯ä»¥åœ¨å¾®æœåŠ¡å†…è®¾è®¡å’Œæ‰©å±•åŠŸèƒ½ï¼Œå¹¶ä¸”é‡‡ç”¨ä¸åŒçš„å¼€å‘è¯­è¨€åŠå¼€å‘å·¥å…·ï¼›</li><li><code>ä»è¿ç»´è§†è§’æ¥çœ‹</code>ï¼šåœ¨å¾®æœåŠ¡åŒ–åï¼Œæ¯ä¸ªæœåŠ¡éƒ½åœ¨ç‹¬ç«‹çš„è¿›ç¨‹é‡Œï¼Œå¯ä»¥è‡ªè¿ç»´ï¼›æ›´é‡è¦çš„æ˜¯ï¼Œå¾®æœåŠ¡åŒ–æ˜¯å•ä¸€å˜æ›´çš„åŸºç¡€ï¼Œè¿­ä»£é€Ÿåº¦æ›´å¿«ï¼Œä¸Šçº¿é£é™©æ›´å°ï¼›</li><li><code>ä»ç»„ç»‡ç®¡ç†è§†è§’æ¥çœ‹</code>ï¼šå°†å›¢é˜Ÿå®‰è£…å¾®æœåŠ¡åˆ‡åˆ†æˆå°ç»„å–ä»£æœåŠ¡å¤§ç»„ä¹Ÿæœ‰åˆ©äºæ•æ·å¼€å‘ã€‚</li></ul><h3 id="3-1-2-å¾®æœåŠ¡çš„ç¼ºç‚¹ï¼š"><a href="#3-1-2-å¾®æœåŠ¡çš„ç¼ºç‚¹ï¼š" class="headerlink" title="3.1.2 å¾®æœåŠ¡çš„ç¼ºç‚¹ï¼š"></a>3.1.2 å¾®æœåŠ¡çš„ç¼ºç‚¹ï¼š</h3><ul><li>æœåŠ¡æ•°é‡å˜å¤šï¼Œä¸šåŠ¡æœ¬èº«çš„è§„æ¨¡å’Œå¤æ‚åº¦å¹¶æ²¡æœ‰å˜å°‘ï¼Œåè€Œå˜å¤šã€‚</li><li>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç½‘ç»œå¯é æ€§ã€é€šä¿¡å®‰å…¨ã€ç½‘ç»œæ—¶å»¶ã€ç½‘ç»œæ‹“æ‰‘å˜åŒ–ç­‰éƒ½æˆç«‹æˆ‘ä»¬è¦å…³æ³¨çš„å†…å®¹ã€‚</li><li>å¾®æœåŠ¡æœºåˆ¶å¸¦æ¥äº†å¤§é‡çš„å·¥ä½œï¼Œæ¯”å¦‚æœåŠ¡å¦‚ä½•è¯·æ±‚ç›®æ ‡æœåŠ¡ï¼Œéœ€è¦å¼•å…¥æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ç­‰ï¼Œä»¥åŠå¯¹è·¨è¿›ç¨‹çš„åˆ†å¸ƒå¼è°ƒç”¨æ ˆè¿›è¡Œåˆ†å¸ƒå¼è°ƒç”¨é“¾è·¯è¿½è¸ªã€‚</li></ul><p>æ€»ä¹‹ï¼Œç®€å•çš„äº‹æƒ…çªç„¶å˜å¾—å¤æ‚äº†ã€‚</p><h2 id="3-2-æœåŠ¡æ²»ç†çš„ä¸‰ç§å½¢æ€"><a href="#3-2-æœåŠ¡æ²»ç†çš„ä¸‰ç§å½¢æ€" class="headerlink" title="3.2 æœåŠ¡æ²»ç†çš„ä¸‰ç§å½¢æ€"></a>3.2 æœåŠ¡æ²»ç†çš„ä¸‰ç§å½¢æ€</h2><p>æœåŠ¡æ²»ç†çš„æ¼”å˜è‡³å°‘ç»è¿‡äº†ä»¥ä¸‹ä¸‰ç§å½¢æ€ã€‚</p><h3 id="3-2-1-ç¬¬ä¸€ç§å½¢æ€ï¼šåœ¨åº”ç”¨ç¨‹åºä¸­åŒ…å«æ²»ç†é€»è¾‘"><a href="#3-2-1-ç¬¬ä¸€ç§å½¢æ€ï¼šåœ¨åº”ç”¨ç¨‹åºä¸­åŒ…å«æ²»ç†é€»è¾‘" class="headerlink" title="3.2.1 ç¬¬ä¸€ç§å½¢æ€ï¼šåœ¨åº”ç”¨ç¨‹åºä¸­åŒ…å«æ²»ç†é€»è¾‘"></a>3.2.1 ç¬¬ä¸€ç§å½¢æ€ï¼šåœ¨åº”ç”¨ç¨‹åºä¸­åŒ…å«æ²»ç†é€»è¾‘</h3><p>è‡ªå·±å†™ä»£ç å»å®ç°æœåŠ¡å‘ç°å’Œæ²»ç†çš„é€»è¾‘ã€‚<br> <code>ç¼ºç‚¹</code>ï¼š</p><ol><li>åŠŸèƒ½ç®€å•ï¼›</li><li>å®ç°æˆæœ¬é«˜ï¼Œå­˜åœ¨å¤§é‡é‡å¤ä»£ç ï¼›</li><li>ç»´æŠ¤å’Œå‡çº§å›°éš¾ï¼›</li></ol><h3 id="3-2-1-ç¬¬äºŒç§å½¢æ€ï¼šæ²»ç†é€»è¾‘ç‹¬ç«‹çš„ä»£ç "><a href="#3-2-1-ç¬¬äºŒç§å½¢æ€ï¼šæ²»ç†é€»è¾‘ç‹¬ç«‹çš„ä»£ç " class="headerlink" title="3.2.1 ç¬¬äºŒç§å½¢æ€ï¼šæ²»ç†é€»è¾‘ç‹¬ç«‹çš„ä»£ç "></a>3.2.1 ç¬¬äºŒç§å½¢æ€ï¼šæ²»ç†é€»è¾‘ç‹¬ç«‹çš„ä»£ç </h3><p>å…¸å‹ä»£è¡¨ï¼šSpring Cloud Eureka<br> <code>ä¼˜ç‚¹</code>ï¼š</p><ol><li>åœ¨ä»£ç ä¸Šè§£è€¦äº†ä¸šåŠ¡å’Œæ²»ç†é€»è¾‘</li></ol><p><code>ç¼ºç‚¹</code>ï¼š<br> ä¸šåŠ¡ä»£ç å’ŒSDKè¿˜æ˜¯è¦ä¸€èµ·ç¼–è¯‘ï¼Œä¸šåŠ¡ä»£ç å’Œæ²»ç†é€»è¾‘å­©å­åŒä¸€ä¸ªè¿›ç¨‹å†…ï¼Œè¿™å°±å¯¼è‡´å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>ä¸šåŠ¡ä»£ç å¿…é¡»å’ŒSDKåŸºäºåŒä¸€ç§è¯­è¨€ï¼Œå³è¯­è¨€ç»‘å®šï¼›</li><li>æ²»ç†é€»è¾‘å‡çº§æ—¶ï¼Œè¿˜éœ€è¦ç”¨æˆ·çš„æ•´ä¸ªæœåŠ¡å‡çº§ï¼›</li><li>SDKå¯¹å¼€å‘äººå‘˜æ¥è¯´æœ‰è¾ƒé«˜çš„å­¦ä¹ é—¨æ§›ã€‚</li></ol><h3 id="3-2-3-ç¬¬ä¸‰ç§å½¢æ€ï¼šæ²»ç†é€»è¾‘ç‹¬ç«‹çš„è¿›ç¨‹"><a href="#3-2-3-ç¬¬ä¸‰ç§å½¢æ€ï¼šæ²»ç†é€»è¾‘ç‹¬ç«‹çš„è¿›ç¨‹" class="headerlink" title="3.2.3 ç¬¬ä¸‰ç§å½¢æ€ï¼šæ²»ç†é€»è¾‘ç‹¬ç«‹çš„è¿›ç¨‹"></a>3.2.3 ç¬¬ä¸‰ç§å½¢æ€ï¼šæ²»ç†é€»è¾‘ç‹¬ç«‹çš„è¿›ç¨‹</h3><p>æŠŠæ²»ç†é€»è¾‘å½»åº•ä»ç”¨æˆ·çš„ä¸šåŠ¡ä»£ç ä¸­å‰¥ç¦»å‡ºæ¥ï¼Œå³Sidecaræ¨¡å¼ã€‚<br> <code>ä¼˜ç‚¹</code>ï¼š</p><ol><li>ç”¨æˆ·çš„ä»£ç å’Œæ²»ç†é€»è¾‘éƒ½ä»¥ç‹¬ç«‹çš„è¿›ç¨‹å­˜åœ¨ï¼Œä¸¤è€…çš„ä»£ç å’Œè¿è¡Œéƒ½æ— è€¦åˆï¼Œè¿™æ ·å¯ä»¥åšåˆ°ä¸å¼€å‘è¯­è¨€æ— å…³ï¼Œå‡çº§ä¹Ÿç›¸äº’ç‹¬ç«‹ï¼›</li><li>åœ¨å¯¹å·²å­˜åœ¨çš„ç³»ç»Ÿè¿›è¡Œå¾®æœåŠ¡æ²»ç†æ—¶ï¼Œåªéœ€æ­é…Sidecarå³å¯ï¼Œå¯¹åŸæœåŠ¡æ— éœ€åšä»»ä½•ä¿®æ”¹ï¼›</li><li>å¯ä»¥å¯¹è€ç³»ç»Ÿæ¸è¿›å¼å‡çº§æ”¹é€ ï¼Œå…ˆå¯¹éƒ¨åˆ†æœåŠ¡è¿›è¡Œå¾®æœåŠ¡åŒ–ã€‚</li></ol><h3 id="3-2-3-ä¸‰ç§æœåŠ¡æ²»ç†å½¢æ€çš„æ¯”è¾ƒ"><a href="#3-2-3-ä¸‰ç§æœåŠ¡æ²»ç†å½¢æ€çš„æ¯”è¾ƒ" class="headerlink" title="3.2.3 ä¸‰ç§æœåŠ¡æ²»ç†å½¢æ€çš„æ¯”è¾ƒ"></a>3.2.3 ä¸‰ç§æœåŠ¡æ²»ç†å½¢æ€çš„æ¯”è¾ƒ</h3><table><thead><tr><th>å½¢æ€</th><th>ä¸šåŠ¡é€»è¾‘ä¾µå…¥</th><th>ä¸šåŠ¡ä»£ç ä¾µå…¥</th><th>ä¸šåŠ¡è¿›ç¨‹ä¾µå…¥</th></tr></thead><tbody><tr><td>åœ¨åº”ç”¨ç¨‹åºä¸­åŒ…å«æ²»ç†é€»è¾‘</td><td>Y</td><td>Y</td><td>Y</td></tr><tr><td>æ²»ç†é€»è¾‘ç‹¬ç«‹çš„ä»£ç </td><td>N</td><td>N</td><td>Y</td></tr><tr><td>æ²»ç†é€»è¾‘ç‹¬ç«‹çš„è¿›ç¨‹</td><td>N</td><td>N</td><td>N</td></tr></tbody></table><h1 id="4-Istioä¸æœåŠ¡ç½‘æ ¼"><a href="#4-Istioä¸æœåŠ¡ç½‘æ ¼" class="headerlink" title="4. Istioä¸æœåŠ¡ç½‘æ ¼"></a>4. Istioä¸æœåŠ¡ç½‘æ ¼</h1><p>ä¸šç•Œæ¯”è¾ƒè®¤åŒçš„æ˜¯William Morganå…³äºæœåŠ¡ç½‘å…³ï¼ˆService Meshï¼‰çš„ä¸€æ®µå®šä¹‰ï¼Œè¿™é‡Œæå–å’Œè§£é‡Šè¯¥å®šä¹‰ä¸­çš„å‡ ä¸ªå…³é”®å­—æ¥è®²è§£æœåŠ¡ç½‘æ ¼çš„ç‰¹ç‚¹ï¼š</p><ul><li><code>åŸºç¡€è®¾æ–½</code>ï¼šæœåŠ¡ç½‘æ ¼æ˜¯ä¸€ç§å¤„ç†æœåŠ¡é—´é€šä¿¡çš„åŸºç¡€è®¾æ–½å±‚ã€‚</li><li><code>äº‘åŸç”Ÿ</code>ï¼šæœåŠ¡ç½‘æ ¼å°¤å…¶é€‚ç”¨äºåœ¨äº‘åŸç”Ÿåœºæ™¯ä¸‹å¸®åŠ©åº”ç”¨ç¨‹åºåœ¨å¤æ‚çš„æœåŠ¡æ‹“æ‰‘é—´å¯é åœ°ä¼ é€’è¯·æ±‚ã€‚</li><li><code>ç½‘ç»œä»£ç†</code>ï¼šåœ¨å®é™…ä½¿ç”¨ç”¨ï¼ŒæœåŠ¡ç½‘æ ¼ä¸€èˆ¬æ˜¯é€šè¿‡ä¸€ç»„è½»é‡çº§ç½‘ç»œä»£ç†æ¥æ‰§è¡Œæ²»ç†é€»è¾‘çš„ã€‚</li><li><code>å¯¹åº”ç”¨é€æ˜</code>ï¼šè½»é‡ç½‘ç»œä»£ç†ä¸åº”ç”¨ç¨‹åºéƒ¨ç½²åœ¨ä¸€èµ·ï¼Œä½†åº”ç”¨æ„ŸçŸ¥ä¸åˆ°ä»£ç†çš„å­˜åœ¨ï¼Œè¿˜æ˜¯ä½¿ç”¨åŸæ¥çš„æ–¹å¼å·¥ä½œã€‚</li></ul><p>ç»å…¸çš„æœåŠ¡ç½‘æ ¼ç¤ºæ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/13618762-1cd975df189fbf48.jpg"></p><p>ç»å…¸çš„æœåŠ¡ç½‘æ ¼ç¤ºæ„å›¾</p><h2 id="4-1-æ—¶ä»£é€‰æ‹©æœåŠ¡ç½‘æ ¼"><a href="#4-1-æ—¶ä»£é€‰æ‹©æœåŠ¡ç½‘æ ¼" class="headerlink" title="4.1 æ—¶ä»£é€‰æ‹©æœåŠ¡ç½‘æ ¼"></a>4.1 æ—¶ä»£é€‰æ‹©æœåŠ¡ç½‘æ ¼</h2><blockquote><p>åœ¨äº‘åŸç”Ÿæ—¶ä»£ï¼Œéšç€é‡‡ç”¨å„ç§è¯­è¨€å¼€å‘çš„æœåŠ¡å‰§å¢ï¼Œåº”ç”¨é—´çš„è®¿é—®æ‹“æ‰‘æ›´åŠ å¤æ‚ï¼Œæ²»ç†éœ€æ±‚ä¹Ÿè¶Šæ¥è¶Šå¤šã€‚åŸæ¥çš„é‚£ç§åµŒå…¥åœ¨åº”ç”¨ä¸­çš„æ²»ç†åŠŸèƒ½æ— è®ºæ˜¯ä»å½¢æ€ã€åŠ¨æ€æ€§è¿˜æ˜¯å¯æ‰©å±•æ€§æ¥è¯´éƒ½ä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œè¿«åˆ‡éœ€è¦ä¸€ç§å…·å¤‡äº‘åŸç”ŸåŠ¨æ€ã€å¼¹æ€§ç‰¹å®šçš„åº”ç”¨æ²»ç†åŸºç¡€è®¾æ–½ã€‚</p></blockquote><p>é¦–å…ˆï¼Œä»å•ä¸ªåº”ç”¨æ¥çœ‹ï¼ŒSidecarä¸åº”ç”¨ç¨‹åºçš„è§£è€¦å¸¦æ¥çš„<code>åº”ç”¨å®Œå…¨æ— ä¾µå…¥</code>ã€<code>å¼€å‘è¯­è¨€æ— å…³</code>ç­‰ç‰¹ç‚¹è§£é™¤äº†å¼€å‘è¯­è¨€çš„çº¦æŸï¼Œä»è€Œæå¤§é™ä½äº†åº”ç”¨å¼€å‘è€…çš„å¼€å‘æˆæœ¬ã€‚</p><p>ç„¶åï¼Œä»å…¨å±€æ¥çœ‹ï¼Œåœ¨å¤šä¸ªæœåŠ¡é—´æœ‰å¤æ‚çš„äº’ç›¸è®¿é—®æ—¶æ‰æœ‰æœåŠ¡æ²»ç†çš„éœ€æ±‚ã€‚å³æˆ‘ä»¬å…³æ³¨çš„è¿™äº›Sidecarç»„æˆçš„ç½‘æ ¼ï¼Œå¯¹ç½‘æ ¼å†…çš„æœåŠ¡é—´è®¿é—®è¿›è¡Œç®¡ç†ï¼Œå¼•ç”¨è¿˜æ˜¯æŒ‰ç…§æœ¬æ¥çš„æ–¹å¼è¿›è¡Œäº’ç›¸è®¿é—®ï¼Œ<code>æ¯ä¸ªåº”ç”¨ç¨‹åºçš„Inboundæµé‡å’ŒOutboundæµé‡éƒ½è¦ç»è¿‡Sidecarä»£ç†ï¼Œå¹¶åœ¨Sidecarä¸Šæ‰§è¡Œæ²»ç†åŠ¨ä½œ</code>ã€‚</p><p>æœ€åï¼ŒSidecaræ˜¯ç½‘æ ¼åŠ¨ä½œçš„æ‰§è¡Œä½“ï¼Œå…¨å±€çš„ç®¡ç†è§„åˆ™å’Œç½‘æ ¼å†…çš„å…ƒæ•°æ®ç»´æŠ¤é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„æ§åˆ¶é¢å®ç°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåªæœ‰æ•°æ®é¢çš„Sidecarå’Œæ§åˆ¶é¢æœ‰è”ç³»ï¼Œåº”ç”¨æ„ŸçŸ¥ä¸åˆ°Sidecarï¼Œæ›´ä¸ä¼šå’Œæ§åˆ¶é¢æœ‰ä»»ä½•è”ç³»ï¼Œç”¨æˆ·çš„ä¸šåŠ¡å’Œæ§åˆ¶é¢å½»åº•è§£è€¦ã€‚</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/13618762-85223d2341fb3406.jpg"></p><p>æœåŠ¡ç½‘æ ¼çš„ç»Ÿä¸€æ§åˆ¶é¢</p><h2 id="4-2-æœåŠ¡ç½‘æ ¼å¸¦æ¥çš„æ–°é—®é¢˜"><a href="#4-2-æœåŠ¡ç½‘æ ¼å¸¦æ¥çš„æ–°é—®é¢˜" class="headerlink" title="4.2 æœåŠ¡ç½‘æ ¼å¸¦æ¥çš„æ–°é—®é¢˜"></a>4.2 æœåŠ¡ç½‘æ ¼å¸¦æ¥çš„æ–°é—®é¢˜</h2><p>æœåŠ¡ç½‘æ ¼ç¡®å®æœ‰å¾ˆå¤šä¼˜åŠ¿ï¼Œæ­£æ‰€è°“æ²¡æœ‰å…è´¹çš„åˆé¤ï¼Œè¿™ç§å½¢æ€åœ¨æœåŠ¡çš„è®¿é—®é“¾è·¯ä¸Šå¤šå¼•å…¥çš„ä¸¤è·³ä¹Ÿæ˜¯ä¸å®¹å›é¿çš„é—®é¢˜ã€‚</p><ul><li>å¢åŠ äº†ä¸¤å¤„å»¶è¿Ÿå’Œå¯èƒ½çš„æ•…éšœç‚¹ï¼›</li><li>å¤šå‡ºæ¥çš„è¿™ä¸¤è·³å¯¹åº”è®¿é—®æ€§èƒ½ã€æ•´ä½“å¯é æ€§åŠæ•´ä¸ªç³»ç»Ÿçš„å¤æ‚åº¦éƒ½å¸¦æ¥äº†æ–°çš„æŒ‘æˆ˜ã€‚</li></ul><p>é’ˆå¯¹æ€§èƒ½å’Œèµ„æºæŸè€—ï¼Œç½‘æ ¼æä¾›å•†æä¾›çš„æ–¹æ¡ˆä¸€èˆ¬æ˜¯è¿™æ ·è§£å†³çš„ï¼š</p><ol><li><code>é€šè¿‡ä¿è¯è½¬å‘ä»£ç†çš„è½»é‡å’Œé«˜æ€§èƒ½é™ä½æ—¶å»¶å½±å“</code>ï¼Œå°¤å…¶æ˜¯è€ƒè™‘åˆ°åç«¯å®é™…ä½¿ç”¨çš„åº”ç”¨ç¨‹åºä¸€èˆ¬æ¯”ä»£ç†æ›´é‡ï¼Œå åŠ ä»£ç†å¹¶ä¸ä¼šæ˜æ˜¾å½±å“åº”ç”¨çš„è®¿é—®æ€§èƒ½ï¼›</li><li>å¦å¤–ï¼Œå¯¹äºè¿™äº›é«˜æ€§èƒ½çš„ä»£ç†ï¼Œåªæœ‰æ¶ˆè€—è¶³å¤Ÿçš„èµ„æºæ€»èƒ½è¾¾åˆ°æœŸæœ›çš„æ€§èƒ½ï¼Œç‰¹æ®Šæ˜¯äº‘åŸç”Ÿåœºæ™¯ä¸‹æœåŠ¡çš„å¼¹æ€§ç‰¹ç‚¹ä½¿å¾—æœåŠ¡å®ä¾‹çš„å¼¹æ€§æ‰©å±•å˜å¾—éå¸¸æ–¹ä¾¿ï¼Œé€šè¿‡<code>æ‰©å±•å®ä¾‹æ•°é‡</code>æ€»æ˜¯èƒ½å¾—åˆ°æœŸæœ›çš„è®¿é—®æ€§èƒ½ã€‚</li></ol><h2 id="4-3-æœåŠ¡ç½‘æ ¼é€‰æ‹©Istio"><a href="#4-3-æœåŠ¡ç½‘æ ¼é€‰æ‹©Istio" class="headerlink" title="4.3 æœåŠ¡ç½‘æ ¼é€‰æ‹©Istio"></a>4.3 æœåŠ¡ç½‘æ ¼é€‰æ‹©Istio</h2><ul><li>åœ¨æ§åˆ¶é¢ä¸Šï¼ŒIstioä½œä¸ºä¸€ç§å…¨æ–°çš„è®¾è®¡ï¼Œåœ¨åŠŸèƒ½ã€å½¢æ€ã€æ¶æ„å’Œæ‰©å±•æ€§ä¸Šæä¾›äº†è¿œè¶…æœåŠ¡ç½‘æ ¼çš„èƒ½åŠ›èŒƒå›´ï¼›</li><li>IstioåŸºäºxDSåè®®æä¾›äº†ä¸€å¥—æ ‡å‡†çš„æ§åˆ¶é¢è§„èŒƒï¼Œæƒ³æ•°æ®é¢ä¼ é€’æœåŠ¡ä¿¡æ¯å’Œæ²»ç†è§„èŒƒï¼›</li><li>Istioçš„æ—©æœŸç‰ˆæœ¬ä½¿ç”¨Envoy V1ç‰ˆæœ¬çš„APIï¼Œå³RESTfulæ–¹å¼ï¼Œå…¶æ–°ç‰ˆæœ¬ä½¿ç”¨Envoy V2ç‰ˆæœ¬çš„APIï¼Œå³gRPCåè®®ï¼›</li><li>Envoyæ˜¯ç”¨C++å¼€å‘çš„ï¼Œå…¶æ€§èƒ½å’Œèµ„æºå ç”¨æ¯”ç”¨Rustå¼€å‘çš„Linkerd Proxyæ›´å¥½ï¼Œæ›´èƒ½æ»¡è¶³æœåŠ¡ç½‘æ ¼ä¸­å¯¹é€æ˜ä»£ç†çš„è½»é‡é«˜æ€§èƒ½çš„è¦æ±‚ï¼›</li><li>Envoyæä¾›L3&#x2F;L4è¿‡æ»¤å™¨ã€HTTP L7è¿‡æ»¤å™¨ã€æ”¯æŒHTTP&#x2F;2ã€HTTP L7è·¯ç”±åŠgRPCã€MongoDBã€DynamoDBç­‰åè®®ï¼›</li><li>Envoyæœ‰æœåŠ¡å‘ç°ã€å¥åº·æ£€æŸ¥ã€é«˜çº§LBã€å‰ç«¯ä»£ç†ç­‰èƒ½åŠ›ï¼Œå…·æœ‰æå¥½çš„å¯è§‚å¯Ÿæ€§ã€åŠ¨æ€é…ç½®åŠŸèƒ½ï¼›</li><li>Envoyæ˜¯ä¸€ä¸ªå¯é«˜åº¦å®šåˆ¶åŒ–çš„ç¨‹åºï¼Œé€šè¿‡Filteræœºåˆ¶æä¾›äº†é«˜åº¦æ‰©å±•æ€§ï¼Œè¿˜æ”¯æŒçƒ­é‡å¯ï¼Œå…¶ä»£ç åŸºäºæ¨¡å—åŒ–ç¼–ç ï¼Œæ˜“äºæµ‹è¯•ï¼›</li><li>åœ¨å¤§å‚æ”¯æŒä¸Šï¼ŒIstioç”±è°·æ­Œå’ŒIBMå…±åŒæ¨å‡ºï¼Œä»åº”ç”¨åœºæ™¯çš„åˆ†æè§„åˆ’åˆ°æœ¬èº«çš„å®šä½ï¼Œä»è‡ªèº«æ¶æ„çš„è®¾è®¡åˆ°ä¸å‘¨è¾¹ç”Ÿæ€çš„ç»“åˆï¼Œéƒ½æœ‰ç€æ¯”è¾ƒä¸¥å¯†çš„è®ºè¯ï¼›</li><li>Istioä¸Kubernetesæ— ç¼ç»“åˆï¼ŒIstioç§°ä¸ºæ¶æ„çš„é»˜è®¤éƒ¨åˆ†ï¼Œå°±åƒå®¹å™¨å’ŒKuberneteså·²ç»æˆä¸ºäº‘åŸç”Ÿæ¶æ„çš„é»˜è®¤éƒ¨åˆ†ä¸€æ ·ã€‚</li></ul><h2 id="4-4-Istioä¸Kubernetes"><a href="#4-4-Istioä¸Kubernetes" class="headerlink" title="4.4 Istioä¸Kubernetes"></a>4.4 Istioä¸Kubernetes</h2><p>Kubernetesçš„ServiceåŸºäºæ¯ä¸ªèŠ‚ç‚¹çš„kube-proxyä»kube-apiserverä¸Šè·å–Serviceå’ŒEndpointçš„ä¿¡æ¯ï¼Œå¹¶å°†å¯¹Serviceçš„è¯·æ±‚ç»è¿‡è´Ÿè½½å‡è¡¡è½¬å‘åˆ°å¯¹åº”çš„Endpointä¸Šã€‚</p><p>ä½†Kubernetesåªæä¾›äº†4å±‚è´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼Œæ— æ³•åŸºäºåº”ç”¨å±‚çš„ä¿¡æ¯è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œæ›´ä¸èƒ½æä¾›åº”ç”¨å±‚çš„æµé‡ç®¡ç†ï¼Œåœ¨æœåŠ¡è¿è¡Œç®¡ç†ä¸Šä¹Ÿåªæä¾›äº†åŸºæœ¬çš„æ¢é’ˆæœºåˆ¶ï¼Œå¹¶ä¸èƒ½æä¾›æœåŠ¡è®¿é—®çš„æŒ‡æ ‡å’Œè°ƒç”¨é“¾è¿½è¸ªè¿™ç§åº”ç”¨çš„æœåŠ¡è¿è¡Œè¯Šæ–­èƒ½åŠ›ã€‚</p><p>Istioå¤ç”¨äº†Kubernetes Serviceçš„å®šä¹‰ï¼Œåœ¨å®ç°ä¸Šè¿›è¡Œäº†æ›´ç»†ç²’åº¦çš„æ§åˆ¶ã€‚</p><p>Istioçš„æœåŠ¡å‘ç°å°±æ˜¯ä»kube-apiserverä¸­è·å–Serviceå’ŒEndpointï¼Œç„¶åå°†å…¶è½¬æ¢æˆIstioæœåŠ¡æ¨¡å‹çš„Serviceå’ŒServiceInstanceï¼Œä½†æ˜¯å…¶æ•°æ®é¢ç»„ä»¶ä¸å†æ˜¯kube-proxyï¼Œè€Œæ˜¯åœ¨æ¯ä¸ªPodé‡Œéƒ¨ç½²çš„Sidecarï¼Œä¹Ÿå¯ä»¥å°†å…¶çœ‹ä½œæ¯ä¸ªæœåŠ¡å®ä¾‹çš„Proxyã€‚</p><p>é€šè¿‡æ‹¦æˆªPodçš„Inboundæµé‡å’ŒOutboundæµé‡ï¼Œå¹¶åœ¨Sidecarä¸Šè§£æå„ç§åº”ç”¨å±‚åè®®ï¼ŒIstioå¯ä»¥æä¾›çœŸæ­£çš„åº”ç”¨å±‚æ²»ç†ã€ç›‘æ§å’Œå®‰å…¨ç­‰èƒ½åŠ›ã€‚</p><p>æ€»ä¹‹ï¼ŒIstioå’ŒKubernetesä»è®¾è®¡ç†å¿µã€ä½¿ç”¨ä½“éªŒã€ç³»ç»Ÿæ¶æ„ç”šè‡³ä»£ç é£æ ¼ç­‰å°ç»†èŠ‚æ¥çœ‹ï¼Œå…³ç³»éƒ½éå¸¸ç´§å¯†ï¼Œç”šè‡³æœ‰äººè®¤ä¸ºIstioå°±æ˜¯Kuberneteså›¢é˜Ÿå¼€å‘çš„Kuberneteså¯æ’æ‹”çš„å¢å¼ºç‰¹æ€§ã€‚</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/13618762-16b88481a0ae8424.jpg"></p><h1 id="äºŒ-Istioéƒ¨ç½²"><a href="#äºŒ-Istioéƒ¨ç½²" class="headerlink" title="äºŒ.Istioéƒ¨ç½²"></a>äºŒ.Istioéƒ¨ç½²</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/07/image-20220515121116461.png"></p><h2 id="1-ä¸‹è½½Istioctl"><a href="#1-ä¸‹è½½Istioctl" class="headerlink" title="1.ä¸‹è½½Istioctl"></a>1.ä¸‹è½½Istioctl</h2><pre class=" language-bash"><code class="language-bash">curl -L https://istio.io/downloadIstio <span class="token operator">|</span> sh -<span class="token comment" spellcheck="true">#è¿™é‡Œå»ºè®®ç›´æ¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ä¸‹è½½</span><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/taråŒ…/Istio-1.4/istio-1.4.0-linux.tar.gz</code></pre><h2 id="2-æ–‡ä»¶ç®€ä»‹"><a href="#2-æ–‡ä»¶ç®€ä»‹" class="headerlink" title="2.æ–‡ä»¶ç®€ä»‹"></a>2.æ–‡ä»¶ç®€ä»‹</h2><pre class=" language-bash"><code class="language-bash">total 24drwxr-x---  2 root root    22 Nov 14  2019 bin            <span class="token comment" spellcheck="true">#istioctlå‘½ä»¤ç›®å½•</span>drwxr-xr-x  6 root root    79 Nov 14  2019 <span class="token function">install</span>        <span class="token comment" spellcheck="true">#å®‰è£…æ–‡ä»¶ç›®å½•è¿™é‡Œä½¿ç”¨çš„k8så®‰è£…</span>-rw-r--r--  1 root root 11348 Nov 14  2019 LICENSE-rw-r-----  1 root root   675 Nov 14  2019 manifest.yaml-rw-r--r--  1 root root  6080 Nov 14  2019 README.mddrwxr-xr-x 19 root root   307 Nov 14  2019 samplesdrwxr-x---  3 root root    99 Nov 14  2019 tools           <span class="token comment" spellcheck="true">#å¸¸ç”¨å·¥å…·ç›®å½•</span></code></pre><h2 id="3-å®‰è£…"><a href="#3-å®‰è£…" class="headerlink" title="3.å®‰è£…"></a>3.å®‰è£…</h2><pre class=" language-bash"><code class="language-bash">istioctl manifest apply --set profile<span class="token operator">=</span>demo<span class="token comment" spellcheck="true">#å®‰è£…æ˜¯æ¯”è¾ƒæ…¢çš„ éœ€è¦è€å¿ƒç­‰å¾…</span></code></pre><h2 id="4-æ£€æµ‹å®‰è£…çŠ¶æ€"><a href="#4-æ£€æµ‹å®‰è£…çŠ¶æ€" class="headerlink" title="4.æ£€æµ‹å®‰è£…çŠ¶æ€"></a>4.æ£€æµ‹å®‰è£…çŠ¶æ€</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å®‰è£…å®Œæˆå¯ä»¥è¾“å…¥yamlæ–‡ä»¶ç„¶åç›‘æµ‹å®‰è£…æ˜¯å¦æˆåŠŸ</span>istioctl manifest generate --set profile<span class="token operator">=</span>demo <span class="token operator">></span> /tmp/demo.yamlistioctl verify-install -f /tmp/demo.yaml<span class="token comment" spellcheck="true">#æ£€æµ‹æ˜¯å¦å®‰è£…æˆåŠŸ</span>Service: jaeger-query.istio-system checked successfullyService: jaeger-collector.istio-system checked successfullyService: jaeger-agent.istio-system checked successfullyService: zipkin.istio-system checked successfullyService: tracing.istio-system checked successfullyChecked 23 crdsChecked 9 Istio DeploymentsIstio is installed successfully</code></pre><p>ä¹Ÿå¯ä»¥æŸ¥çœ‹podæ˜¯å¦éƒ½æ˜¯è¿è¡Œæ­£å¸¸</p><pre class=" language-bash"><code class="language-bash">NAME                                      READY   STATUS    RESTARTS   AGEgrafana-6b65874977-5tfcn                  1/1     Running   0          78mistio-citadel-f74b87856-bgv6k             1/1     Running   0          78mistio-egressgateway-c56696f94-pj2k7       1/1     Running   0          78mistio-galley-566bcc7758-wwpvp             1/1     Running   0          78mistio-ingressgateway-6b9987bf94-9ktgj     1/1     Running   0          78mistio-pilot-677c9c688f-xm6sd              1/1     Running   0          78mistio-policy-58fb4d586c-gnpkw             1/1     Running   12         78mistio-sidecar-injector-85657c7bcb-8ps2p   1/1     Running   1          78mistio-telemetry-666b985499-5f6fx          1/1     Running   10         78mistio-tracing-c66d67cd9-p6dlj             1/1     Running   0          78mkiali-8559969566-9h2gp                    1/1     Running   1          78mprometheus-66c5887c86-hb42s               1/1     Running   0          78m</code></pre>]]></content>
      
      
      <categories>
          
          <category> Istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cephè¯¦è§£</title>
      <link href="/fdf20d39/"/>
      <url>/fdf20d39/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ä»‹ç»"><a href="#ä¸€-ä»‹ç»" class="headerlink" title="ä¸€.ä»‹ç»"></a>ä¸€.ä»‹ç»</h1><h3 id="1-1ç®€ä»‹"><a href="#1-1ç®€ä»‹" class="headerlink" title="1.1ç®€ä»‹"></a>1.1ç®€ä»‹</h3><p><strong>Cephæ˜¯ä¸€ç§ä¸ºä¼˜ç§€çš„æ€§èƒ½ã€å¯é æ€§å’Œå¯æ‰©å±•æ€§è€Œè®¾è®¡çš„ç»Ÿä¸€çš„ã€åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ</strong> ã€‚ceph çš„ç»Ÿä¸€ä½“ç°åœ¨å¯ä»¥<strong>æä¾›æ–‡ä»¶ç³»ç»Ÿã€å—å­˜å‚¨å’Œå¯¹è±¡å­˜å‚¨</strong> ï¼Œåˆ†å¸ƒå¼ä½“ç°åœ¨å¯ä»¥åŠ¨æ€æ‰©å±•ã€‚åœ¨å›½å†…ä¸€äº›å…¬å¸çš„äº‘ç¯å¢ƒä¸­ï¼Œé€šå¸¸ä¼š<strong>é‡‡ç”¨ ceph ä½œä¸ºopenstack çš„å”¯ä¸€åç«¯å­˜å‚¨æ¥æé«˜æ•°æ®è½¬å‘æ•ˆç‡</strong></p><h3 id="2-2ç‰¹ç‚¹"><a href="#2-2ç‰¹ç‚¹" class="headerlink" title="2.2ç‰¹ç‚¹"></a>2.2ç‰¹ç‚¹</h3><p><strong>é«˜æ€§èƒ½ï¼š</strong></p><ol><li>æ‘’å¼ƒäº†ä¼ ç»Ÿçš„é›†ä¸­å¼å­˜å‚¨å…ƒæ•°æ®å¯»å€çš„æ–¹æ¡ˆï¼Œ<strong>é‡‡ç”¨CRUSHç®—æ³•ï¼Œæ•°æ®åˆ†å¸ƒå‡è¡¡,å¹¶è¡Œåº¦é«˜ã€‚</strong></li><li>è€ƒè™‘äº†å®¹ç¾åŸŸçš„éš”ç¦»ï¼Œèƒ½å¤Ÿ<strong>å®ç°å„ç±»è´Ÿè½½çš„å‰¯æœ¬æ”¾ç½®è§„åˆ™</strong> ï¼Œä¾‹å¦‚è·¨æœºæˆ¿ã€æœºæ¶<br>æ„ŸçŸ¥ç­‰ã€‚</li><li>èƒ½å¤Ÿ<strong>æ”¯æŒä¸Šåƒä¸ªå­˜å‚¨èŠ‚ç‚¹çš„è§„æ¨¡</strong> ï¼Œæ”¯æŒTBåˆ°PBçº§çš„æ•°æ®ã€‚</li></ol><p><strong>é«˜å¯ç”¨æ€§ï¼š</strong></p><ol><li><strong>å‰¯æœ¬æ•°å¯ä»¥çµæ´»æ§åˆ¶ã€‚</strong></li><li><strong>æ”¯æŒæ•…éšœåŸŸåˆ†éš”</strong> ï¼Œæ•°<strong>æ®å¼ºä¸€è‡´æ€§ã€‚</strong></li><li>å¤šç§æ•…éšœåœºæ™¯è‡ªåŠ¨è¿›è¡Œ<strong>ä¿®å¤è‡ªæ„ˆ</strong> ã€‚</li><li><strong>æ²¡æœ‰å•ç‚¹æ•…éšœ</strong> ï¼Œè‡ªåŠ¨ç®¡ç†ã€‚</li></ol><p><strong>é«˜å¯æ‰©å±•æ€§ï¼š</strong></p><ol><li>å»ä¸­å¿ƒåŒ–ã€‚</li><li><strong>æ‰©å±•çµæ´»ã€‚</strong></li><li>éšç€èŠ‚ç‚¹å¢åŠ è€Œ<strong>çº¿æ€§å¢é•¿ã€‚</strong></li></ol><p><strong>ç‰¹æ€§ä¸°å¯Œï¼š</strong></p><ol><li><strong>æ”¯æŒä¸‰ç§å­˜å‚¨æ¥å£ï¼šå—å­˜å‚¨ã€æ–‡ä»¶å­˜å‚¨ã€å¯¹è±¡å­˜å‚¨ã€‚</strong></li><li><strong>æ”¯æŒè‡ªå®šä¹‰æ¥å£</strong> ï¼Œæ”¯æŒå¤šç§è¯­è¨€é©±åŠ¨ã€‚</li></ol><h3 id="1-3æ ¸å¿ƒç»„ä»¶"><a href="#1-3æ ¸å¿ƒç»„ä»¶" class="headerlink" title="1.3æ ¸å¿ƒç»„ä»¶"></a>1.3æ ¸å¿ƒç»„ä»¶</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/1527731413.png" alt="1618472-20190417191206980-58978930.png"></p><p>ï¼ˆ1ï¼‰<strong>Monitors</strong> ï¼š<strong>ç›‘è§†å™¨ï¼Œç»´æŠ¤é›†ç¾¤çŠ¶æ€çš„å¤šç§æ˜ å°„ï¼ŒåŒæ—¶æä¾›è®¤è¯å’Œæ—¥å¿—è®°å½•æœåŠ¡</strong> ï¼ŒåŒ…æ‹¬æœ‰å…³monitor èŠ‚ç‚¹ç«¯åˆ°ç«¯çš„ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬ Ceph é›†ç¾¤IDï¼Œç›‘æ§ä¸»æœºåå’ŒIPä»¥åŠç«¯å£ã€‚å¹¶ä¸”å­˜å‚¨å½“å‰ç‰ˆæœ¬ä¿¡æ¯ä»¥åŠæœ€æ–°æ›´æ”¹ä¿¡æ¯ï¼Œé€šè¿‡ â€œceph mon dumpâ€æŸ¥çœ‹ monitor mapã€‚</p><p>ï¼ˆ2ï¼‰<strong>MDSï¼ˆMetadata Serverï¼‰ï¼šCeph å…ƒæ•°æ®ï¼Œä¸»è¦ä¿å­˜çš„æ˜¯Cephæ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®</strong> ã€‚æ³¨æ„ï¼šcephçš„å—å­˜å‚¨å’Œcephå¯¹è±¡å­˜å‚¨éƒ½ä¸éœ€è¦MDSã€‚</p><p>ï¼ˆ3ï¼‰<strong>OSDï¼šå³å¯¹è±¡å­˜å‚¨å®ˆæŠ¤ç¨‹åºï¼Œä½†æ˜¯å®ƒå¹¶éé’ˆå¯¹å¯¹è±¡å­˜å‚¨ã€‚æ˜¯ç‰©ç†ç£ç›˜é©±åŠ¨å™¨ï¼Œå°†æ•°æ®ä»¥å¯¹è±¡çš„å½¢å¼å­˜å‚¨åˆ°é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹çš„ç‰©ç†ç£ç›˜ä¸Šã€‚OSDè´Ÿè´£å­˜å‚¨æ•°æ®ã€å¤„ç†æ•°æ®å¤åˆ¶ã€æ¢å¤ã€å›ï¼ˆBackfillingï¼‰</strong> ã€å†å¹³è¡¡ã€‚å®Œæˆå­˜å‚¨æ•°æ®çš„å·¥ä½œç»å¤§å¤šæ•°æ˜¯ç”± OSD daemon è¿›ç¨‹å®ç°ã€‚åœ¨æ„å»º Ceph OSDçš„æ—¶å€™ï¼Œå»ºè®®é‡‡ç”¨SSD ç£ç›˜ä»¥åŠxfsæ–‡ä»¶ç³»ç»Ÿæ¥æ ¼å¼åŒ–åˆ†åŒºã€‚æ­¤å¤–OSDè¿˜å¯¹å…¶å®ƒOSDè¿›è¡Œå¿ƒè·³æ£€æµ‹ï¼Œæ£€æµ‹ç»“æœæ±‡æŠ¥ç»™Monitor</p><p>ï¼ˆ4ï¼‰<strong>RADOS</strong> ï¼šReliable Autonomic Distributed Object Storeã€‚RADOSæ˜¯cephå­˜å‚¨é›†ç¾¤çš„åŸºç¡€ã€‚åœ¨cephä¸­ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä»¥å¯¹è±¡çš„å½¢å¼å­˜å‚¨ï¼Œå¹¶ä¸”æ— è®ºä»€ä¹ˆæ•°æ®ç±»å‹ï¼Œ<strong>RADOSå¯¹è±¡å­˜å‚¨éƒ½å°†è´Ÿè´£ä¿å­˜è¿™äº›å¯¹è±¡ã€‚RADOSå±‚å¯ä»¥ç¡®ä¿æ•°æ®å§‹ç»ˆä¿æŒä¸€è‡´ã€‚</strong></p><p>ï¼ˆ5ï¼‰<strong>librados</strong> ï¼šlibradosåº“ï¼Œ<strong>ä¸ºåº”ç”¨ç¨‹åº¦æä¾›è®¿é—®æ¥å£</strong> ã€‚åŒæ—¶ä¹Ÿä¸ºå—å­˜å‚¨ã€å¯¹è±¡å­˜å‚¨ã€æ–‡ä»¶ç³»ç»Ÿæä¾›åŸç”Ÿçš„æ¥å£ã€‚</p><p>ï¼ˆ6ï¼‰<strong>RADOSGW</strong> ï¼š<strong>ç½‘å…³æ¥å£ï¼Œæä¾›å¯¹è±¡å­˜å‚¨æœåŠ¡</strong> ã€‚å®ƒä½¿ç”¨librgwå’Œlibradosæ¥å®ç°å…è®¸åº”ç”¨ç¨‹åºä¸Cephå¯¹è±¡å­˜å‚¨å»ºç«‹è¿æ¥ã€‚å¹¶ä¸”æä¾›S3 å’Œ Swift å…¼å®¹çš„RESTful APIæ¥å£ã€‚</p><p>ï¼ˆ7ï¼‰<strong>RBDï¼šå—è®¾å¤‡</strong> ï¼Œå®ƒèƒ½å¤Ÿè‡ªåŠ¨ç²¾ç®€é…ç½®å¹¶å¯è°ƒæ•´å¤§å°ï¼Œè€Œä¸”<strong>å°†æ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ªOSDä¸Šã€‚</strong></p><p>ï¼ˆ8ï¼‰CephFSï¼šCephæ–‡ä»¶ç³»ç»Ÿï¼Œä¸POSIXå…¼å®¹çš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŸºäºlibradoså°è£…åŸç”Ÿæ¥å£ã€‚</p><h3 id="1-4-åº•å±‚é€»è¾‘"><a href="#1-4-åº•å±‚é€»è¾‘" class="headerlink" title="1.4 åº•å±‚é€»è¾‘"></a>1.4 åº•å±‚é€»è¾‘</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/1150893390.png" alt="1618472-20190417191326807-1875989385.png"></p><h3 id="1-5-æ–‡ä»¶å­˜å‚¨æµç¨‹"><a href="#1-5-æ–‡ä»¶å­˜å‚¨æµç¨‹" class="headerlink" title="1.5 æ–‡ä»¶å­˜å‚¨æµç¨‹"></a>1.5 æ–‡ä»¶å­˜å‚¨æµç¨‹</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/446346974.png" alt="1349539-20180803162209076-1452295982.png"></p><ol><li>æ–‡ä»¶ä¸Šä¼ åä¼šè¢«åˆ†å‰²ä¸ºç›¸åŒå¤§å°çš„å¯¹è±¡(Object)é»˜è®¤æ˜¯4M,å¹¶ä¼šåˆ†é…ä¸€ä¸ªoid(Object id)</li><li>é€šè¿‡å¯¹oidè¿›è¡Œå“ˆå¸Œè¿ç®—å’Œæ©ç è¿ç®—,å¯ä»¥è®¡ç®—å‡ºè¿è¡Œåœ¨å“ªä¸ªpgä¸­</li><li>é€šè¿‡crushç®—æ³•æœ€ç»ˆå¾—åˆ°æ•°æ®å­˜å‚¨åœ¨å“ªä¸ªosdä¸­</li></ol><h1 id="äºŒ-å®‰è£…é…ç½®"><a href="#äºŒ-å®‰è£…é…ç½®" class="headerlink" title="äºŒ.å®‰è£…é…ç½®"></a>äºŒ.å®‰è£…é…ç½®</h1><h3 id="2-1ç¯å¢ƒå‡†å¤‡"><a href="#2-1ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.1ç¯å¢ƒå‡†å¤‡"></a>2.1ç¯å¢ƒå‡†å¤‡</h3><table><thead><tr><th>è§’è‰²</th><th>ip</th><th>è¿è¡ŒæœåŠ¡</th></tr></thead><tbody><tr><td>ceph-admin</td><td>10.9.132.128</td><td>ceph-deploy</td></tr><tr><td>mon01</td><td>10.9.145.154</td><td>osd mon</td></tr><tr><td>mon02</td><td>10.9.158.133</td><td>osd mon</td></tr><tr><td>mon03</td><td>10.9.82.6</td><td>osd mon mgr</td></tr><tr><td>stor04</td><td>10.9.171.105</td><td>osd mgr</td></tr></tbody></table><p>é…ç½®ä¸»æœºåå’Œæœ¬åœ°hosts</p><pre class=" language-bash"><code class="language-bash">10.9.132.128 ceph-admin10.9.145.154 mon0110.9.158.133 mon0210.9.82.6 mon0310.9.171.105 stor04</code></pre><h4 id="ceph-adminæ“ä½œ"><a href="#ceph-adminæ“ä½œ" class="headerlink" title="ceph-adminæ“ä½œ"></a>ceph-adminæ“ä½œ</h4><p>ä¸‹è½½ceph-release-1-1.el7yumåŒ…</p><pre class=" language-bash"><code class="language-bash">rpm -ivh https://mirrors.aliyun.com/ceph/rpm-mimic/el7/noarch/ceph-release-1-1.el7.noarch.rpm</code></pre><p>å®‰è£…å®Œæˆå¯ä»¥åœ¨yumæ–‡ä»¶ä¸­çœ‹åˆ°cephçš„yumæº</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-admin yum.repos.d<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll /etc/yum.repos.d/ceph.repo </span>-rw-r--r-- 1 root root 535 May  5  2018 /etc/yum.repos.d/ceph.repobaseurl<span class="token operator">=</span>http://download.ceph.com/rpm-mimic/el7/<span class="token variable">$basearch</span>enabled<span class="token operator">=</span>1gpgcheck<span class="token operator">=</span>1type<span class="token operator">=</span>rpm-mdgpgkey<span class="token operator">=</span>https://download.ceph.com/keys/release.asc<span class="token punctuation">[</span>Ceph-noarch<span class="token punctuation">]</span>name<span class="token operator">=</span>Ceph noarch packagesbaseurl<span class="token operator">=</span>http://download.ceph.com/rpm-mimic/el7/noarchenabled<span class="token operator">=</span>1gpgcheck<span class="token operator">=</span>1type<span class="token operator">=</span>rpm-mdgpgkey<span class="token operator">=</span>https://download.ceph.com/keys/release.asc<span class="token punctuation">[</span>ceph-source<span class="token punctuation">]</span>name<span class="token operator">=</span>Ceph <span class="token function">source</span> packagesbaseurl<span class="token operator">=</span>http://download.ceph.com/rpm-mimic/el7/SRPMSenabled<span class="token operator">=</span>1gpgcheck<span class="token operator">=</span>1type<span class="token operator">=</span>rpm-mdgpgkey<span class="token operator">=</span>https://download.ceph.com/keys/release.asc</code></pre><p>å®‰è£…epelæº</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-admin yum.repos.d<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install epel-release</span></code></pre><p>åˆ›å»ºç”¨æˆ·å¹¶è®¾ç½®sudo rootæ— éœ€å¯†ç  å…¶ä»–èŠ‚ç‚¹ä¹Ÿéœ€è¦æ“ä½œ</p><pre class=" language-bash"><code class="language-bash"><span class="token function">useradd</span> cephadm <span class="token operator">&amp;&amp;</span> <span class="token keyword">echo</span> huhuhahei <span class="token operator">|</span> <span class="token function">passwd</span> --stdin cephadm<span class="token punctuation">[</span>root@ceph-admin ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /etc/sudoers.d/cephadm </span>cephadmALL<span class="token operator">=</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> NOPASSWD: ALL</code></pre><p>é…ç½®å…å¯†ç™»é™† æ‹·è´sudoæ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash">ssh-keygen -t rsa -P <span class="token string">""</span>ssh-copy-id -i .ssh/id_rsa.pub cephadm@mon01ssh-copy-id -i .ssh/id_rsa.pub cephadm@mon02ssh-copy-id -i .ssh/id_rsa.pub cephadm@mon03ssh-copy-id -i .ssh/id_rsa.pub cephadm@stor04</code></pre><h3 id="2-2-åˆå§‹åŒ–RADOSé›†ç¾¤"><a href="#2-2-åˆå§‹åŒ–RADOSé›†ç¾¤" class="headerlink" title="2.2 åˆå§‹åŒ–RADOSé›†ç¾¤"></a>2.2 åˆå§‹åŒ–RADOSé›†ç¾¤</h3><p>å®‰è£…ceph-deploy</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ yum -y <span class="token function">install</span> ceph-deploy python-setuptools python2-subprocess32</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph-deploy new --cluster-network 10.9.0.0/16 --public-network 10.9.0.0/16 mon01----<span class="token punctuation">[</span>ceph_deploy.new<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> Resolving host mon01<span class="token punctuation">[</span>ceph_deploy.new<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> Monitor mon01 at 10.9.145.154<span class="token punctuation">[</span>ceph_deploy.new<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> Monitor initial members are <span class="token punctuation">[</span><span class="token string">'mon01'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>ceph_deploy.new<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> Monitor addrs are <span class="token punctuation">[</span>u<span class="token string">'10.9.145.154'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>ceph_deploy.new<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> Creating a random mon key<span class="token punctuation">..</span>.<span class="token punctuation">[</span>ceph_deploy.new<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> Writing monitor keyring to ceph.mon.keyring<span class="token punctuation">..</span>.<span class="token punctuation">[</span>ceph_deploy.new<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> Writing initial config to ceph.conf<span class="token punctuation">..</span>.<span class="token comment" spellcheck="true">#æˆ‘è¿™é‡Œåªæœ‰ä¸€ä¸ªç½‘å¡æ‰€ä»¥ç½‘ç»œéƒ½æ˜¯ä¸€ä¸ªç½‘æ®µ</span></code></pre><p>åˆå§‹åŒ–å®Œæˆä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆé…ç½®æ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ lltotal 44-rw-rw-r-- 1 cephadm cephadm   254 Dec  4 16:56 ceph.conf-rw-rw-r-- 1 cephadm cephadm 33959 Dec  4 17:04 ceph-deploy-ceph.log-rw------- 1 cephadm cephadm    73 Dec  4 16:55 ceph.mon.keyring<span class="token punctuation">[</span>global<span class="token punctuation">]</span>fsid <span class="token operator">=</span> b5fa13e6-6b7f-4eeb-bac3-a7b6bc535109public_network <span class="token operator">=</span> 10.9.0.0/16cluster_network <span class="token operator">=</span> 10.9.0.0/16mon_initial_members <span class="token operator">=</span> mon01mon_host <span class="token operator">=</span> 10.9.145.154auth_cluster_required <span class="token operator">=</span> cephxauth_service_required <span class="token operator">=</span> cephxauth_client_required <span class="token operator">=</span> cephx</code></pre><p>å®‰è£…cephé›†ç¾¤</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph-deploy <span class="token function">install</span> mon01 mon02 mon03 stor04---<span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> <span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> Complete<span class="token operator">!</span><span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: <span class="token function">sudo</span> ceph --version<span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> ceph version 13.2.10 <span class="token punctuation">(</span>564bdc4ae87418a232fc901524470e1a0f76d641<span class="token punctuation">)</span> mimic <span class="token punctuation">(</span>stable<span class="token punctuation">)</span></code></pre><p>åˆå§‹åŒ–ç¬¬ä¸€ä¸ªmonèŠ‚ç‚¹</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph-deploy mon create-initial---<span class="token punctuation">[</span>ceph_deploy.gatherkeys<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Storing ceph.client.admin.keyring<span class="token punctuation">[</span>ceph_deploy.gatherkeys<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Storing ceph.bootstrap-mds.keyring<span class="token punctuation">[</span>ceph_deploy.gatherkeys<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Storing ceph.bootstrap-mgr.keyring<span class="token punctuation">[</span>ceph_deploy.gatherkeys<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> keyring <span class="token string">'ceph.mon.keyring'</span> already exists<span class="token punctuation">[</span>ceph_deploy.gatherkeys<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Storing ceph.bootstrap-osd.keyring<span class="token punctuation">[</span>ceph_deploy.gatherkeys<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Storing ceph.bootstrap-rgw.keyring<span class="token punctuation">[</span>ceph_deploy.gatherkeys<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Destroy temp directory /tmp/tmpXsDRpH<span class="token comment" spellcheck="true">#åœ¨mon01èŠ‚ç‚¹æŸ¥çœ‹è¿›ç¨‹å·²ç»è¿è¡Œ</span><span class="token punctuation">[</span>root@mon01 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ps -ef | grep ceph-mon</span>ceph        9013       1  0 17:09 ?        00:00:00 /usr/bin/ceph-mon -f --cluster ceph --id mon01 --setuser ceph --setgroup cephroot        9311    8412  0 17:11 pts/0    00:00:00 <span class="token function">grep</span> --color<span class="token operator">=</span>auto ceph-mon</code></pre><p>æ‹·è´cephé…ç½®æ–‡ä»¶åˆ°å…¶ä»–èŠ‚ç‚¹</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph-deploy admin ceph-admin mon01 mon02 mon03 stor04 ---<span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> connection detected need <span class="token keyword">for</span> <span class="token function">sudo</span><span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> connected to host: stor04 <span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> detect platform information from remote host<span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> detect machine <span class="token function">type</span><span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> <span class="token function">write</span> cluster configuration to /etc/ceph/<span class="token punctuation">{</span>cluster<span class="token punctuation">}</span>.conf<span class="token comment" spellcheck="true">#å…¶ä»–èŠ‚ç‚¹æŸ¥çœ‹ </span><span class="token punctuation">[</span>root@mon01 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll /etc/ceph/</span>total 12-rw------- 1 root root 151 Dec  4 17:14 ceph.client.admin.keyring-rw-r--r-- 1 root root 254 Dec  4 17:14 ceph.conf-rw-r--r-- 1 root root  92 Apr 24  2020 rbdmap-rw------- 1 root root   0 Dec  4 17:09 tmpVELNIz<span class="token comment" spellcheck="true">#ll å¯ä»¥çœ‹åˆ°admin.keyingæ–‡ä»¶æƒé™æ˜¯600 cephadmç”¨æˆ·æ˜¯æ— æ³•è®¿é—®çš„ æ‰€ä»¥éœ€è¦ç»™ä¸‹æƒé™</span><span class="token punctuation">[</span>root@mon01 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># setfacl -m u:cephadm:rw /etc/ceph/ceph.client.admin.keyring</span><span class="token punctuation">[</span>root@mon01 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll /etc/ceph/</span>total 12-rw-rw----+ 1 root root 151 Dec  4 17:14 ceph.client.admin.keyring</code></pre><p>é…ç½®mon03ä¸ºmgrè¿›ç¨‹</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph-deploy mgr create mon03---<span class="token punctuation">[</span>mon03<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: <span class="token function">sudo</span> systemctl <span class="token function">enable</span> ceph-mgr@mon03<span class="token punctuation">[</span>mon03<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> Created symlink from /etc/systemd/system/ceph-mgr.target.wants/ceph-mgr@mon03.service to /usr/lib/systemd/system/ceph-mgr@.service.<span class="token punctuation">[</span>mon03<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: <span class="token function">sudo</span> systemctl start ceph-mgr@mon03<span class="token punctuation">[</span>mon03<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: <span class="token function">sudo</span> systemctl <span class="token function">enable</span> ceph.target<span class="token comment" spellcheck="true">#è¿›å…¥èŠ‚ç‚¹æŸ¥çœ‹</span><span class="token punctuation">[</span>root@mon03 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ps -ef</span>ceph        8990       1  7 17:19 ?        00:00:00 /usr/bin/ceph-mgr -f --clustroot        9057    8454  0 17:19 pts/0    00:00:00 <span class="token function">ps</span> -ef</code></pre><p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph -s  cluster:    id:     b5fa13e6-6b7f-4eeb-bac3-a7b6bc535109    health: HEALTH_WARN            OSD count 0 <span class="token operator">&lt;</span> osd_pool_default_size 3   services:    mon: 1 daemons, quorum mon01    mgr: mon03<span class="token punctuation">(</span>active<span class="token punctuation">)</span>    osd: 0 osds: 0 up, 0 <span class="token keyword">in</span>   data:    pools:   0 pools, 0 pgs    objects: 0  objects, 0 B    usage:   0 B used, 0 B / 0 B avail    pgs:</code></pre><p>æ·»åŠ monèŠ‚ç‚¹</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph-deploy mon add mon02---<span class="token punctuation">[</span>mon03<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> ********************************************************************************<span class="token punctuation">[</span>mon03<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> monitor: mon.mon02 is running<span class="token comment" spellcheck="true">#æŸ¥çœ‹ceph monä¿¡æ¯</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph quorum_status --format json-pretty<span class="token punctuation">{</span>    <span class="token string">"election_epoch"</span><span class="token keyword">:</span> 16,    <span class="token string">"quorum"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>        0,        1,        2    <span class="token punctuation">]</span>,    <span class="token string">"quorum_names"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>        <span class="token string">"mon03"</span>,        <span class="token string">"mon01"</span>,        <span class="token string">"mon02"</span>    <span class="token punctuation">]</span>,    <span class="token string">"quorum_leader_name"</span><span class="token keyword">:</span> <span class="token string">"mon03"</span>,    <span class="token string">"monmap"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>        <span class="token string">"epoch"</span><span class="token keyword">:</span> 3,        <span class="token string">"fsid"</span><span class="token keyword">:</span> <span class="token string">"b5fa13e6-6b7f-4eeb-bac3-a7b6bc535109"</span>,        <span class="token string">"modified"</span><span class="token keyword">:</span> <span class="token string">"2021-12-04 18:06:16.162457"</span>,        <span class="token string">"created"</span><span class="token keyword">:</span> <span class="token string">"2021-12-04 17:09:58.218633"</span>,        <span class="token string">"features"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>            <span class="token string">"persistent"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>                <span class="token string">"kraken"</span>,                <span class="token string">"luminous"</span>,                <span class="token string">"mimic"</span>,                <span class="token string">"osdmap-prune"</span>            <span class="token punctuation">]</span>,            <span class="token string">"optional"</span><span class="token keyword">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span>,        <span class="token string">"mons"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                <span class="token string">"rank"</span><span class="token keyword">:</span> 0,   <span class="token comment" spellcheck="true">#ä¸»èŠ‚ç‚¹</span>                <span class="token string">"name"</span><span class="token keyword">:</span> <span class="token string">"mon03"</span>,                <span class="token string">"addr"</span><span class="token keyword">:</span> <span class="token string">"10.9.82.6:6789/0"</span>,                <span class="token string">"public_addr"</span><span class="token keyword">:</span> <span class="token string">"10.9.82.6:6789/0"</span>            <span class="token punctuation">}</span>,            <span class="token punctuation">{</span>                <span class="token string">"rank"</span><span class="token keyword">:</span> 1,                <span class="token string">"name"</span><span class="token keyword">:</span> <span class="token string">"mon01"</span>,                <span class="token string">"addr"</span><span class="token keyword">:</span> <span class="token string">"10.9.145.154:6789/0"</span>,                <span class="token string">"public_addr"</span><span class="token keyword">:</span> <span class="token string">"10.9.145.154:6789/0"</span>            <span class="token punctuation">}</span>,            <span class="token punctuation">{</span>                <span class="token string">"rank"</span><span class="token keyword">:</span> 2,                <span class="token string">"name"</span><span class="token keyword">:</span> <span class="token string">"mon02"</span>,                <span class="token string">"addr"</span><span class="token keyword">:</span> <span class="token string">"10.9.158.133:6789/0"</span>,                <span class="token string">"public_addr"</span><span class="token keyword">:</span> <span class="token string">"10.9.158.133:6789/0"</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>æ·»åŠ mgrèŠ‚ç‚¹</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph-deploy mgr create stor04---<span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: <span class="token function">sudo</span> systemctl <span class="token function">enable</span> ceph-mgr@stor04<span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: <span class="token function">sudo</span> systemctl start ceph-mgr@stor04<span class="token punctuation">[</span>stor04<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: <span class="token function">sudo</span> systemctl <span class="token function">enable</span> ceph.target<span class="token comment" spellcheck="true">#æŸ¥çœ‹</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph -scluster:id:     b5fa13e6-6b7f-4eeb-bac3-a7b6bc535109health: HEALTH_WARNtoo few PGs per OSD <span class="token punctuation">(</span>24 <span class="token operator">&lt;</span> min 30<span class="token punctuation">)</span>clock skew detected on mon.mon01, mon.mon02services:mon: 3 daemons, quorum mon03,mon01,mon02mgr: mon03<span class="token punctuation">(</span>active<span class="token punctuation">)</span>, standbys: stor04 <span class="token comment" spellcheck="true">#å¤‡èŠ‚ç‚¹</span>osd: 4 osds: 4 up, 4 <span class="token keyword">in</span>data:pools:   1 pools, 32 pgsobjects: 0  objects, 0 Busage:   4.0 GiB used, 76 GiB / 80 GiB availpgs:     32 active+clean</code></pre><h3 id="2-3RADOSåŠ å…¥OSD"><a href="#2-3RADOSåŠ å…¥OSD" class="headerlink" title="2.3RADOSåŠ å…¥OSD"></a>2.3RADOSåŠ å…¥OSD</h3><p>å¯ä»¥å…ˆæŸ¥çœ‹å¯ç”¨ç£ç›˜</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph-deploy disk list mon01---<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: <span class="token function">sudo</span> <span class="token function">fdisk</span> -l<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Disk /dev/vda: 21.5 GB, 21474836480 bytes, 41943040 sectors<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Disk /dev/vdb: 21.5 GB, 21474836480 bytes, 41943040 sectors</code></pre><p>æ“¦é™¤ç£ç›˜çš„æ•°æ®<br>æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦æ“ä½œ</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph-deploy disk zap mon01 /dev/vdb---<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> --<span class="token operator">></span> Zapping: /dev/vdb<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> --<span class="token operator">></span> --destroy was not specified, but zapping a whole device will<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> Running command: /bin/dd if<span class="token operator">=</span>/dev/zero of<span class="token operator">=</span>/dev/vdb bs<span class="token operator">=</span>1M count<span class="token operator">=</span>10<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> --<span class="token operator">></span> Zapping successful for: <span class="token operator">&lt;</span>Raw Device: /dev/vdb<span class="token operator">></span><span class="token comment" spellcheck="true">##è¿™é‡Œå¦‚æœæœ‰æŠ¥é”™ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤è‡ªå·±åœ¨èŠ‚ç‚¹æ“¦é™¤ å®Œæˆéœ€è¦é‡å¯èŠ‚ç‚¹ ç„¶åé‡æ–°æ“ä½œ</span><span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span>  stderr: wipefs: error: /dev/vdb: probing initialization failed: Device or resource busy<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> --<span class="token operator">></span> failed to wipefs device, will try again to workaround probable race condition<span class="token punctuation">[</span>root@mon01 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># dd if=/dev/zero of=/dev/vdb bs=512K count=1</span><span class="token punctuation">[</span>root@mon01 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># reboot</span></code></pre><p>æ·»åŠ osd</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph-deploy osd create --data /dev/vdb mon01---<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> checking OSD status<span class="token punctuation">..</span>.<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> <span class="token function">find</span> the location of an executable<span class="token punctuation">[</span>mon01<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: <span class="token function">sudo</span> /bin/ceph --cluster<span class="token operator">=</span>ceph osd <span class="token function">stat</span> --format<span class="token operator">=</span>json<span class="token punctuation">[</span>ceph_deploy.osd<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> Host mon01 is now ready <span class="token keyword">for</span> osd use.<span class="token comment" spellcheck="true">#æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ å¯ä»¥çœ‹åˆ°osdå·²ç»å…¨éƒ¨æ·»åŠ æˆåŠŸ</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph -s  cluster:    id:     b5fa13e6-6b7f-4eeb-bac3-a7b6bc535109    health: HEALTH_OK   services:    mon: 1 daemons, quorum mon01    mgr: mon03<span class="token punctuation">(</span>active<span class="token punctuation">)</span>    osd: 4 osds: 4 up, 4 <span class="token keyword">in</span>   data:    pools:   0 pools, 0 pgs    objects: 0  objects, 0 B    usage:   4.0 GiB used, 76 GiB / 80 GiB avail    pgs</code></pre><h3 id="2-4-æµ‹è¯•"><a href="#2-4-æµ‹è¯•" class="headerlink" title="2.4 æµ‹è¯•"></a>2.4 æµ‹è¯•</h3><p>åˆ›å»ºå­˜å‚¨æ± pool</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph osd pool create mypool 32 32pool <span class="token string">'mypool'</span> created<span class="token comment" spellcheck="true">#æŸ¥çœ‹</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph osd pool <span class="token function">ls</span>mypool<span class="token comment" spellcheck="true">#è°ƒæ•´poolé»˜è®¤çš„å¤‡ä»½æ•°é‡</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph osd pool get mypool sizesize: 3<span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph osd pool <span class="token keyword">set</span> mypool size 2<span class="token keyword">set</span> pool 1 size to 2<span class="token comment" spellcheck="true">#è°ƒæ•´poolä¸­pgçš„æ•°é‡</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph osd pool get mypool pg_num pg_num: 32<span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph osd pool <span class="token keyword">set</span> mypool pg_num 64<span class="token keyword">set</span> pool 1 pg_num to 64</code></pre><p>ä¸Šä¼ æ•°æ®</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rados put hosts /etc/hosts -p mypool<span class="token comment" spellcheck="true">#æŸ¥çœ‹</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rados <span class="token function">ls</span> -p mypoolhosts<span class="token comment" spellcheck="true">#æŸ¥çœ‹mapä¿¡æ¯</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ ceph osd map mypool hostsosdmap e20 pool <span class="token string">'mypool'</span> <span class="token punctuation">(</span>1<span class="token punctuation">)</span> object <span class="token string">'hosts'</span> -<span class="token operator">></span> pg 1.ea1b298e <span class="token punctuation">(</span>1.e<span class="token punctuation">)</span> -<span class="token operator">></span> up <span class="token punctuation">(</span><span class="token punctuation">[</span>1,0,2<span class="token punctuation">]</span>, p1<span class="token punctuation">)</span> acting <span class="token punctuation">(</span><span class="token punctuation">[</span>1,0,2<span class="token punctuation">]</span>, p1<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#åˆ é™¤æ•°æ®</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rados <span class="token function">rm</span> hosts -p mypool</code></pre><p>æŸ¥çœ‹osdçš„å»¶è¿Ÿæƒ…å†µ</p><pre class=" language-bash"><code class="language-bash"></code></pre><h3 id="2-5-osdæ¢ç›˜"><a href="#2-5-osdæ¢ç›˜" class="headerlink" title="2.5 osdæ¢ç›˜"></a>2.5 osdæ¢ç›˜</h3><p>ç§»é™¤osd</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#åœæ­¢è¿›ç¨‹</span><span class="token function">sudo</span> systemctl stop ceph-osd@<span class="token punctuation">{</span>osd-num<span class="token punctuation">}</span><span class="token comment" spellcheck="true">#åœç”¨è®¾å¤‡</span>ceph osd out <span class="token punctuation">{</span>osd-num<span class="token punctuation">}</span><span class="token comment" spellcheck="true">#ç§»é™¤è®¾å¤‡ä¿¡æ¯</span>ceph osd crush <span class="token function">rm</span> <span class="token punctuation">{</span>osd-num<span class="token punctuation">}</span>ceph osd <span class="token function">rm</span> <span class="token punctuation">{</span>osd-num<span class="token punctuation">}</span>ceph auth <span class="token function">rm</span> <span class="token punctuation">{</span>osd-num<span class="token punctuation">}</span></code></pre><p>å¦‚æœosdç£ç›˜æœ‰åé“çš„è¯å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤æŸ¥çœ‹osdçš„å»¶è¿Ÿæƒ…å†µ</p><pre class=" language-bash"><code class="language-bash"> ceph osd perf osd commit_latency<span class="token punctuation">(</span>ms<span class="token punctuation">)</span> apply_latency<span class="token punctuation">(</span>ms<span class="token punctuation">)</span>  4                  1                 1  0                  0                 0  2                  1                 1  3                  1                 1  1                  1                 1</code></pre><h3 id="2-6-ceph-æ–‡ä»¶ä¸€è‡´æ€§æ£€æŸ¥"><a href="#2-6-ceph-æ–‡ä»¶ä¸€è‡´æ€§æ£€æŸ¥" class="headerlink" title="2.6 ceph æ–‡ä»¶ä¸€è‡´æ€§æ£€æŸ¥"></a>2.6 ceph æ–‡ä»¶ä¸€è‡´æ€§æ£€æŸ¥</h3><p><code>ceph</code>é›†ç¾¤é»˜è®¤æ¯å¤©ä¼šè¿›è¡Œä¸€æ¬¡<code>scrub</code> æ¯å‘¨ä¼šè¿›è¡Œä¸€æ¬¡<code>deep-scrub</code>æ·±åº¦æ£€æŸ¥ æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡mlè¿›è¡Œæ‰‹åŠ¨æ£€æŸ¥</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#cephçš„ä¸€è‡´æ€§æ£€æŸ¥æ˜¯é’ˆå¯¹pgçš„æ‰€ä»¥éœ€è¦æ ¹æ®pg idè¿›è¡Œæ£€æŸ¥ å¯ä»¥è·å–éœ€è¦æ£€æŸ¥çš„pg id</span>ceph pg dumpceph pg scrub 1.19instructing pg 1.19 on osd.2 to scrub<span class="token comment" spellcheck="true">#æ·±åº¦æ£€æŸ¥</span>ceph pg deep-scrub 1.19instructing pg 1.19 on osd.2 to deep-scrub</code></pre>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cephæ¨ªå‘æ‰©å®¹</title>
      <link href="/167ead09/"/>
      <url>/167ead09/</url>
      
        <content type="html"><![CDATA[<p>éšç€ä¸šåŠ¡å¢é•¿<code>ceph</code>æœåŠ¡ä¹Ÿä¼šå‡ºç°,å­˜å‚¨ç©ºé—´ä¸è¶³çš„æƒ…å†µ,è¿™ä¸ªæ—¶å€™å°±éœ€è¦æ‰©å®¹é›†ç¾¤</p><p>æ‰©å®¹ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§:</p><ul><li>æ¨ªå‘æ‰©å®¹(å¢åŠ é›†ç¾¤èŠ‚ç‚¹)</li><li>çºµå‘æ‰©å®¹(å•èŠ‚ç‚¹å¢åŠ æ›´å¤šçš„ç£ç›˜)</li></ul><h3 id="1-1-æ£€æŸ¥èŠ‚ç‚¹ç£ç›˜"><a href="#1-1-æ£€æŸ¥èŠ‚ç‚¹ç£ç›˜" class="headerlink" title="1.1 æ£€æŸ¥èŠ‚ç‚¹ç£ç›˜"></a>1.1 æ£€æŸ¥èŠ‚ç‚¹ç£ç›˜</h3><pre class=" language-bash"><code class="language-bash">ceph-deploy disk list ceph-node2<span class="token punctuation">..</span>.<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> connected to host: ceph-node2<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> detect platform information from remote host<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> detect machine <span class="token function">type</span><span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> <span class="token function">find</span> the location of an executable<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: <span class="token function">fdisk</span> -l<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Disk /dev/sda: 107.4 GB, 107374182400 bytes, 209715200 sectors<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Disk /dev/sdb: 536.9 GB, 536870912000 bytes, 1048576000 sectors<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Disk /dev/mapper/ceph--5ec322fc--9910--4476--a9fc--c0360c0bd446-osd--block--ab000a3d--2ddb--4480--8ef7--f3a5ff572555: 536.9 GB, 536866717696 bytes, 1048567808 sectors<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Disk /dev/sdc: 107.4 GB, 107374182400 bytes, 209715200 sectors<span class="token comment" spellcheck="true"># sdcå°±æ˜¯æˆ‘ä»¬æ–°æ·»åŠ çš„ç£ç›˜</span></code></pre><p>å¦‚æœä½ çš„ç£ç›˜å·²ç»é…ç½®äº†åˆ†åŒº å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤åˆ é™¤ <strong>æ³¨æ„ åˆ é™¤åˆ†åŒºæ•°æ®ä¹Ÿä¼šåˆ é™¤</strong></p><pre class=" language-bash"><code class="language-bash">ceph-deploy disk zap ceph-node2 /dev/sdc<span class="token punctuation">..</span>.<span class="token punctuation">[</span>ceph_deploy.osd<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Distro info: CentOS Linux 7.8.2003 Core<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> zeroing last few blocks of device<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> <span class="token function">find</span> the location of an executable<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: /usr/sbin/ceph-volume lvm zap /dev/sdc<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> --<span class="token operator">></span> Zapping: /dev/sdc<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> --<span class="token operator">></span> --destroy was not specified, but zapping a whole device will remove the partition table<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> Running command: /bin/dd if<span class="token operator">=</span>/dev/zero of<span class="token operator">=</span>/dev/sdc bs<span class="token operator">=</span>1M count<span class="token operator">=</span>10 conv<span class="token operator">=</span>fsync<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span>  stderr: 10+0 records <span class="token keyword">in</span><span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> 10+0 records out<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span>  stderr: 10485760 bytes <span class="token punctuation">(</span>10 MB<span class="token punctuation">)</span> copied, 0.0930712 s, 113 MB/s<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> --<span class="token operator">></span> Zapping successful for: <span class="token operator">&lt;</span>Raw Device: /dev/sdc<span class="token operator">></span></code></pre><h3 id="2-1-æ·»åŠ osdç£ç›˜"><a href="#2-1-æ·»åŠ osdç£ç›˜" class="headerlink" title="2.1 æ·»åŠ osdç£ç›˜"></a>2.1 æ·»åŠ osdç£ç›˜</h3><pre class=" language-bash"><code class="language-bash">ceph-deploy osd create ceph-node2 --data /dev/sdc<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> Running command: /bin/systemctl <span class="token function">enable</span> --runtime ceph-osd@4<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span>  stderr: Created symlink from /run/systemd/system/ceph-osd.target.wants/ceph-osd@4.service to /usr/lib/systemd/system/ceph-osd@.service.<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> Running command: /bin/systemctl start ceph-osd@4<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> --<span class="token operator">></span> ceph-volume lvm activate successful <span class="token keyword">for</span> osd ID: 4<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> --<span class="token operator">></span> ceph-volume lvm create successful for: /dev/sdc<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> checking OSD status<span class="token punctuation">..</span>.<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> <span class="token function">find</span> the location of an executable<span class="token punctuation">[</span>ceph-node2<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: /bin/ceph --cluster<span class="token operator">=</span>ceph osd <span class="token function">stat</span> --format<span class="token operator">=</span>json<span class="token punctuation">[</span>ceph_deploy.osd<span class="token punctuation">]</span><span class="token punctuation">[</span>DEBUG <span class="token punctuation">]</span> Host ceph-node2 is now ready <span class="token keyword">for</span> osd use</code></pre><p>å†æ¬¡æŸ¥çœ‹osd</p><pre class=" language-bash"><code class="language-bash">ceph osd treeID  CLASS WEIGHT  TYPE NAME           STATUS REWEIGHT PRI-AFF -1       2.05426 root default -9       0.48999     host ceph-admin  3   hdd 0.48999         osd.3           up  1.00000 1.00000 -3       0.48830     host ceph-node1  0   hdd 0.48830         osd.0           up  1.00000 1.00000 -5       0.58768     host ceph-node2  1   hdd 0.48999         osd.1           up  1.00000 1.00000  4   hdd 0.09769         osd.4           up  1.00000 1.00000 -7       0.48830     host ceph-node3  2   hdd 0.48830         osd.2           up  1.00000 1.00000-16             0     host ceph-node5</code></pre><h3 id="3-1-ä¸´æ—¶å…³é—­é›†ç¾¤rebalance"><a href="#3-1-ä¸´æ—¶å…³é—­é›†ç¾¤rebalance" class="headerlink" title="3.1 ä¸´æ—¶å…³é—­é›†ç¾¤rebalance"></a>3.1 ä¸´æ—¶å…³é—­é›†ç¾¤rebalance</h3><p>å½“æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒæ‰©å®¹çš„æ—¶å€™,ç”±äº<code>ceph</code>æ·»åŠ <code>osd</code>åä¼šé»˜è®¤è¿›è¡Œpgçš„å‡è¡¡,æ‰€ä»¥å¯èƒ½ä¼šå½±å“åˆ°ç”Ÿäº§æœåŠ¡çš„ç¨³å®š,å¯ä»¥ä½¿ç”¨ä¸€ä¸‹å‚æ•°ä¸´æ—¶å…³é—­é›†ç¾¤çš„<code>rebalance</code></p><pre class=" language-bash"><code class="language-bash">ceph osd <span class="token keyword">set</span> norebalanceceph osd <span class="token keyword">set</span> nobackfill</code></pre><p>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-admin ceph<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph -s</span>  cluster:    id:     0e81966f-1e65-45b7-add4-dd6ad971f4cf    health: HEALTH_WARN            nobackfill,norebalance flag<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword">set</span></code></pre><p>å†æ¬¡å¼€å¯</p><pre class=" language-bash"><code class="language-bash">ceph osd unset norebalanceceph osd unset nobackfill</code></pre>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis åŸºç¡€å‘½ä»¤</title>
      <link href="/3db8ca3/"/>
      <url>/3db8ca3/</url>
      
        <content type="html"><![CDATA[<h3 id="1-redisåŸºç¡€å‘½ä»¤"><a href="#1-redisåŸºç¡€å‘½ä»¤" class="headerlink" title="1. redisåŸºç¡€å‘½ä»¤"></a>1. redisåŸºç¡€å‘½ä»¤</h3><p><code>Redis</code> å‘½ä»¤é€šè¿‡<code>Redis</code> å®¢æˆ·ç«¯å¯¹ <code>redis</code> æœåŠ¡ç«¯æ‰§è¡Œç›¸åº”æ“ä½œï¼Œ<code>Redis</code> å®¢æˆ·ç«¯åœ¨å®˜æ–¹ä¸‹è½½çš„ <code>redis</code> çš„ å®‰è£…åŒ…ä¸­â€“ <code>redisÂ­-cli</code>ã€‚</p><p>è¯­æ³•</p><pre class=" language-bash"><code class="language-bash">redis-cli -h host -p port -a password<span class="token punctuation">[</span>root@redis bin<span class="token punctuation">]</span> ./redis-cli <span class="token comment" spellcheck="true">#è¿æ¥æœ¬åœ°Redis</span>127.0.0.1:6379<span class="token operator">></span> <span class="token function">ping</span> <span class="token comment" spellcheck="true">#æ‰§è¡Œ PING å‘½ä»¤ï¼Œè¯¥å‘½ä»¤ç”¨äºæ£€æµ‹ redis æœåŠ¡æ˜¯å¦å¯åŠ¨</span>PONG<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span> redis-cli -h 172.24.8.78 -p 6379 <span class="token comment" spellcheck="true">#è¿æ¥è‡³è¿œç¨‹Redis</span>172.24.8.78:6379<span class="token operator">></span> <span class="token function">ping</span>PONG</code></pre><h3 id="2-redis-keyå‘½ä»¤"><a href="#2-redis-keyå‘½ä»¤" class="headerlink" title="2. redis keyå‘½ä»¤"></a>2. redis keyå‘½ä»¤</h3><h4 id="DEL"><a href="#DEL" class="headerlink" title="DEL"></a>DEL</h4><p>è¯­æ³•ï¼š<code>DEL key [key ...] </code></p><p>ä½œç”¨ï¼šåˆ é™¤ç»™å®šçš„ä¸€ä¸ªæˆ–å¤šä¸ª key ï¼Œä¸å­˜åœ¨çš„ key ä¼šè¢«å¿½ç•¥ã€‚ </p><p>ç¤ºä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> phone 123456789OK127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> address <span class="token string">"hunan china"</span>OK127.0.0.1:6379<span class="token operator">></span> del name <span class="token comment" spellcheck="true">#åˆ é™¤ä¸€ä¸ªkey</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> del age <span class="token comment" spellcheck="true">#åˆ é™¤ä¸€ä¸ªä¸å­˜åœ¨çš„key</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token operator">></span> del phone address <span class="token comment" spellcheck="true">#åˆ é™¤å¤šä¸ªkey</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2</code></pre><h4 id="DUMP"><a href="#DUMP" class="headerlink" title="DUMP"></a>DUMP</h4><p>è¯­æ³•ï¼š<code>DUMP key </code></p><p>ä½œç”¨ï¼šåºåˆ—åŒ–æŒ‡å®šçš„ key ï¼Œå¹¶è¿”å›è¢«åºåˆ—åŒ–çš„å€¼ï¼Œä½¿ç”¨ RESTORE å‘½ä»¤å¯ä»¥å°†è¿™ä¸ªå€¼ååºåˆ—åŒ–ä¸º Redis é”®ã€‚</p><p>ç¤ºä¾‹:</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> greeting <span class="token string">"hello,how are you!"</span>OK127.0.0.1:6379<span class="token operator">></span> dump greeting<span class="token string">"\x00\x12hello,how are you!\t\x00\xf3\xff\xe8\xf6\x98\xec\xbar"</span>127.0.0.1:6379<span class="token operator">></span> dump name<span class="token punctuation">(</span>nil<span class="token punctuation">)</span></code></pre><h4 id="EXISTS"><a href="#EXISTS" class="headerlink" title="EXISTS"></a>EXISTS</h4><p>è¯­æ³•ï¼š<code>EXISTS key </code></p><p>ä½œç”¨ï¼šæ£€æŸ¥æŒ‡å®š key æ˜¯å¦å­˜åœ¨ã€‚ </p><p>ç¤ºä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> name <span class="token string">"xhy"</span>OK127.0.0.1:6379<span class="token operator">></span> EXISTS name<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> EXISTS age<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token operator">></span> DEL name<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> EXISTS name<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0</code></pre><h4 id="EXPIRE"><a href="#EXPIRE" class="headerlink" title="EXPIRE"></a>EXPIRE</h4><p>è¯­æ³•ï¼š<code>EXPIRE key seconds</code></p><p>ä½œç”¨ï¼šä¸ºç»™å®š key è®¾ç½®ï¼ˆæ›´æ–°ï¼‰ç”Ÿå­˜æ—¶é—´ï¼Œå½“ key è¿‡æœŸæ—¶(ç”Ÿå­˜æ—¶é—´ä¸º 0 )ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚ </p><p>å»¶ä¼¸ï¼š åœ¨ Redis ä¸­ï¼Œå¸¦æœ‰ç”Ÿå­˜æ—¶é—´çš„ key è¢«ç§°ä¸ºã€æ˜“å¤±çš„ã€(volatile)ã€‚ </p><p>ç”Ÿå­˜æ—¶é—´å¯ä»¥é€šè¿‡ä½¿ç”¨ DEL å‘½ä»¤åˆ é™¤æ•´ä¸ª key æ¥ç§»é™¤ï¼Œæˆ–è€…è¢« SET å’Œ GETSET å‘½ä»¤è¦†å†™ (overwrite)ã€‚è‹¥ä¸€ä¸ªå‘½ä»¤åªæ˜¯ä¿®æ”¹(alter)ä¸€ä¸ªå¸¦ç”Ÿå­˜æ—¶é—´çš„ key çš„å€¼è€Œä¸æ˜¯ç”¨ä¸€ä¸ªæ–°çš„ key å€¼æ¥ ä»£æ›¿(replace)ï¼Œåˆ™ç”Ÿå­˜æ—¶é—´ä¸ä¼šè¢«æ”¹å˜ã€‚</p><p>æ¯”å¦‚ï¼Œå¯¹ä¸€ä¸ª key æ‰§è¡Œ INCR å‘½ä»¤ï¼Œå¯¹ä¸€ä¸ªåˆ—è¡¨è¿›è¡Œ LPUSH å‘½ä»¤ï¼Œæˆ–è€…å¯¹ä¸€ä¸ªå“ˆå¸Œè¡¨æ‰§è¡Œ HSET å‘½ ä»¤ç­‰æ“ä½œéƒ½ä¸ä¼šä¿®æ”¹ key æœ¬èº«çš„ç”Ÿå­˜æ—¶é—´ã€‚ </p><p>è‹¥ä½¿ç”¨ RENAME å¯¹ä¸€ä¸ª key è¿›è¡Œæ”¹åï¼Œé‚£ä¹ˆæ”¹ååçš„ key çš„ç”Ÿå­˜æ—¶é—´å’Œæ”¹åå‰ä¸€æ ·ã€‚</p><p>æ³¨æ„ï¼šè‹¥ä½¿ç”¨RENAME å‘½ä»¤å°†ä¸€ä¸ªå¸¦ç”Ÿå­˜æ—¶é—´çš„ A key æ”¹åæˆå¦ä¸€ä¸ªå¸¦ç”Ÿå­˜æ—¶é—´çš„ B key ï¼Œè¿™æ—¶B key (ä»¥åŠå®ƒçš„ç”Ÿå­˜æ—¶é—´)ä¼šè¢«åˆ é™¤ï¼Œç„¶åA key ä¼šæ”¹åä¸º B key ï¼Œå› æ­¤ï¼Œæ–°çš„ B key çš„ç”Ÿå­˜æ—¶é—´ä¹Ÿ å’ŒåŸæœ¬çš„ A key ä¸€æ ·ã€‚</p><p>ä½¿ç”¨ PERSIST å‘½ä»¤å¯ä»¥åœ¨ä¸åˆ é™¤ key çš„æƒ…å†µä¸‹ï¼Œç§»é™¤ key çš„ç”Ÿå­˜æ—¶é—´ï¼Œè®© key é‡æ–°æˆä¸ºä¸€ä¸ªã€æŒ ä¹…çš„ã€(persistent) key ã€‚ </p><p>å¯¹ä¸€ä¸ªå·²ç»å¸¦æœ‰ç”Ÿå­˜æ—¶é—´çš„ key æ‰§è¡Œ EXPIRE å‘½ä»¤ï¼Œæ–°æŒ‡å®šçš„ç”Ÿå­˜æ—¶é—´ä¼šå–ä»£æ—§çš„ç”Ÿå­˜æ—¶é—´ã€‚ ç¤ºä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> SET myweb <span class="token string">"www.linuxsb.com"</span>OK127.0.0.1:6379<span class="token operator">></span> EXPIRE myweb 30<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> TTL myweb<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 25127.0.0.1:6379<span class="token operator">></span> EXPIRE myweb 300<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> TTL myweb<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 298</code></pre><h4 id="KEYS"><a href="#KEYS" class="headerlink" title="KEYS"></a>KEYS</h4><p>è¯­æ³•ï¼š<code>KEYS pattern</code></p><p>ä½œç”¨ï¼šæŸ¥æ‰¾æ‰€æœ‰ç¬¦åˆç»™å®šæ¨¡å¼ pattern çš„ keyï¼Œå¸¸è§æŸ¥æ‰¾å¦‚ä¸‹ï¼š </p><ul><li>KEYS * åŒ¹é…æ•°æ®åº“ä¸­æ‰€æœ‰ key ã€‚ </li><li>KEYS h?llo åŒ¹é… hello ï¼Œ hallo å’Œ hxllo ç­‰ã€‚ </li><li>KEYS h*llo åŒ¹é… hllo å’Œ heeeeello ç­‰ã€‚ </li><li>KEYS h[ae]llo åŒ¹é… hello å’Œ hallo ï¼Œä½†ä¸åŒ¹é… hillo ã€‚</li></ul><p>ç¤ºä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> MSET one 1 two 2 three 3 four 4 <span class="token comment" spellcheck="true"># è®¾ç½® 4 ä¸ª key</span>OK127.0.0.1:6379<span class="token operator">></span> KEYS *o*1<span class="token punctuation">)</span> <span class="token string">"two"</span>2<span class="token punctuation">)</span> <span class="token string">"four"</span>3<span class="token punctuation">)</span> <span class="token string">"one"</span>127.0.0.1:6379<span class="token operator">></span> KEYS t??1<span class="token punctuation">)</span> <span class="token string">"two"</span>127.0.0.1:6379<span class="token operator">></span> KEYS t<span class="token punctuation">[</span>w<span class="token punctuation">]</span>*1<span class="token punctuation">)</span> <span class="token string">"two"</span>127.0.0.1:6379<span class="token operator">></span> KEYS *1<span class="token punctuation">)</span> <span class="token string">"three"</span>2<span class="token punctuation">)</span> <span class="token string">"two"</span>3<span class="token punctuation">)</span> <span class="token string">"four"</span>4<span class="token punctuation">)</span> <span class="token string">"one"</span></code></pre><h4 id="MIGATE"><a href="#MIGATE" class="headerlink" title="MIGATE"></a>MIGATE</h4><p>è¯­æ³•ï¼š<code>MIGRATE host port key destinationÂ­db timeout [COPY] [REPLACE]</code></p><p>ä½œç”¨ï¼šå°† key åŸå­æ€§åœ°ä»å½“å‰å®ä¾‹ä¼ é€ï¼ˆè¿ç§»ï¼‰åˆ°ç›®æ ‡å®ä¾‹çš„æŒ‡å®šæ•°æ®åº“ä¸Šï¼Œä¸€æ—¦ä¼ é€ï¼ˆè¿ç§»ï¼‰æˆåŠŸï¼Œ key ä¿è¯ä¼šå‡ºç°åœ¨ç›®æ ‡å®ä¾‹ä¸Šï¼Œè€Œå½“å‰å®ä¾‹ä¸Šçš„ key ä¼šè¢«åˆ é™¤ã€‚</p><p>é€‰é¡¹:</p><ul><li>COPY ï¼šä¸ç§»é™¤æºå®ä¾‹ä¸Šçš„ key </li><li>REPLACE ï¼šæ›¿æ¢ç›®æ ‡å®ä¾‹ä¸Šå·²å­˜åœ¨çš„ key</li></ul><p>å»¶ä¼¸ï¼šMIGRATEå‘½ä»¤æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå®ƒåœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šé˜»å¡è¿›è¡Œè¿ç§»çš„ä¸¤ä¸ªå®ä¾‹ï¼Œç›´åˆ°ä»¥ä¸‹ä»»æ„ç»“æœå‘ ç”Ÿï¼šè¿ç§»æˆåŠŸï¼Œè¿ç§»å¤±è´¥ï¼Œç­‰åˆ°è¶…æ—¶ã€‚</p><p>åŸç†:</p><ol><li>æ‰§è¡ŒMIGRATEå‘½ä»¤æ—¶åœ¨å½“å‰å®ä¾‹å¯¹ç»™å®š key æ‰§è¡Œ DUMP å‘½ä»¤ ï¼Œå°†å®ƒåºåˆ—åŒ–ï¼Œç„¶åä¼ é€åˆ°ç›® æ ‡å®ä¾‹ï¼›</li><li>ç›®æ ‡å®ä¾‹å†ä½¿ç”¨ RESTORE å¯¹æ•°æ®è¿›è¡Œååºåˆ—åŒ–ï¼Œå¹¶å°†ååºåˆ—åŒ–æ‰€å¾—çš„æ•°æ®æ·»åŠ åˆ°æ•°æ®åº“ä¸­ï¼›</li><li>å½“å‰å®ä¾‹ç›¸å½“äºç›®æ ‡å®ä¾‹çš„å®¢æˆ·ç«¯ï¼Œç›‘æµ‹åˆ° RESTORE å‘½ä»¤è¿”å› OK ï¼Œå½“å‰å®ä¾‹è°ƒç”¨ DEL åˆ  é™¤è‡ªå·±æ•°æ®åº“ä¸Š key</li></ol><p>ç¤ºä¾‹:</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@redis ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># redis-cli</span>127.0.0.1:6379<span class="token operator">></span> FLUSHDBOK127.0.0.1:6379<span class="token operator">></span> SET greeting <span class="token string">"Hello from 192.168.0.110 instance"</span> <span class="token comment" spellcheck="true">#åˆ›å»ºä¸€ä¸ªkey</span>OK127.0.0.1:6379<span class="token operator">></span> MIGRATE 192.168.0.111 6379 greeting 0 1000 <span class="token comment" spellcheck="true">#è¿ç§»keyè‡³ç›®æ ‡</span>rediså®ä¾‹OK127.0.0.1:6379<span class="token operator">></span> EXISTS greeting<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0<span class="token punctuation">[</span>root@redis ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># redis-cli -h 192.168.0.111 -p 6379 #å®¢æˆ·ç«¯è¿æ¥ç›®æ ‡</span>rediså®ä¾‹172.24.8.119:6379<span class="token operator">></span> GET greeting <span class="token comment" spellcheck="true">#æŸ¥çœ‹è¿ç§»åçš„key</span><span class="token string">"Hello from 192.168.0.110 instance"</span></code></pre><h4 id="MOVE"><a href="#MOVE" class="headerlink" title="MOVE"></a>MOVE</h4><p>è¯­æ³•ï¼š<code>MOVE key db</code></p><p>ä½œç”¨ï¼šå°†å½“å‰æ•°æ®åº“çš„ key ç§»åŠ¨æŒ‡æŒ‡å®šçš„æ•°æ®åº“ db å½“ä¸­ã€‚è‹¥å½“å‰æ•°æ®åº“(æºæ•°æ®åº“)å’ŒæŒ‡å®šæ•°æ®åº“(ç›® æ ‡æ•°æ®åº“)æœ‰ç›¸åŒåå­—çš„ç»™å®š key ï¼Œæˆ–è€… key ä¸å­˜åœ¨äºå½“å‰æ•°æ®åº“ï¼Œé‚£ä¹ˆ MOVE æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚</p><p>ç¤ºä¾‹:</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> SELECT 0 <span class="token comment" spellcheck="true"># redisé»˜è®¤ä½¿ç”¨æ•°æ®åº“ 0ã€‚</span>OK127.0.0.1:6379<span class="token operator">></span> SET address <span class="token string">"hunan china"</span> <span class="token comment" spellcheck="true">#åˆ›å»ºä¸€ä¸ªkey</span>OK127.0.0.1:6379<span class="token operator">></span> MOVE address 1 <span class="token comment" spellcheck="true">#ç§»åŠ¨è‡³æ•°æ®åº“1</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> SELECT 1 <span class="token comment" spellcheck="true">#é€‰æ‹©æ•°æ®åº“1</span>OK127.0.0.1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token operator">></span> GET address <span class="token comment" spellcheck="true">#æŸ¥çœ‹ç§»åŠ¨ç»“æœ</span><span class="token string">"hunan china"</span>127.0.0.1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token operator">></span> EXISTS age <span class="token comment" spellcheck="true">#æŸ¥çœ‹ä¸€ä¸ªæœªå­˜åœ¨çš„key</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token operator">></span> MOVE age 0 <span class="token comment" spellcheck="true">#å°è¯•ç§»åŠ¨ä¸€ä¸ªä¸å­˜åœ¨çš„key</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token operator">></span> SELECT 0 <span class="token comment" spellcheck="true">#é€‰æ‹©æ•°æ®åº“0</span>OK127.0.0.1:6379<span class="token operator">></span> EXISTS age <span class="token comment" spellcheck="true">#æ•°æ®åº“1ä¸å­˜åœ¨ï¼Œæ•°æ®åº“0ä¹Ÿä¸å­˜åœ¨ï¼Œè¯´æ˜ç§»åŠ¨å¤±è´¥</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token operator">></span> SET name hhh <span class="token comment" spellcheck="true">#è®¾ç½®æ•°æ®åº“0çš„ä¸€ä¸ªkey</span>OK127.0.0.1:6379<span class="token operator">></span> SELECT 1 <span class="token comment" spellcheck="true">#é€‰æ‹©æ•°æ®åº“1</span>OK127.0.0.1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">set</span> name zhangsan <span class="token comment" spellcheck="true">#è®¾ç½®æ•°æ®åº“1å’Œ0ç›¸åŒçš„key</span>OK127.0.0.1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token operator">></span> MOVE name 0 <span class="token comment" spellcheck="true">#å°è¯•ç§»åŠ¨æ­¤keyè‡³æ•°æ®åº“0</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token punctuation">[</span>1<span class="token punctuation">]</span><span class="token operator">></span> SELECT 0 <span class="token comment" spellcheck="true">#é€‰æ‹©æ•°æ®åº“0</span>OK127.0.0.1:6379<span class="token operator">></span> GET name <span class="token comment" spellcheck="true">#æŸ¥çœ‹æ•°æ®åº“0çš„keyï¼Œå¯çŸ¥ç›¸åŒkeyå­˜åœ¨åˆ™ç§»åŠ¨æ— æ•ˆæœ</span><span class="token string">"hhh"</span></code></pre><h4 id="RENAME"><a href="#RENAME" class="headerlink" title="RENAME"></a>RENAME</h4><p>è¯­æ³•ï¼š<code>RENAME key newkey</code></p><p>ä½œç”¨ï¼šå°† key æ”¹åä¸º newkey </p><p>ç¤ºä¾‹:</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> SET message <span class="token string">"hello world!"</span> <span class="token comment" spellcheck="true">#åˆ›å»ºä¸€ä¸ªA key</span>OK127.0.0.1:6379<span class="token operator">></span> RENAME message greeting <span class="token comment" spellcheck="true">#é‡å‘½åA keyä¸ºB key</span>OK127.0.0.1:6379<span class="token operator">></span> EXISTS message <span class="token comment" spellcheck="true">#æŸ¥çœ‹A keyæ˜¯å¦å­˜åœ¨</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token operator">></span> GET greeting <span class="token comment" spellcheck="true">#æŸ¥çœ‹B key</span><span class="token string">"hello world!"</span>127.0.0.1:6379<span class="token operator">></span> RENAME myname yourname <span class="token comment" spellcheck="true">#é‡å‘½åä¸€ä¸ªä¸å­˜åœ¨çš„key</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> ERR no such key127.0.0.1:6379<span class="token operator">></span> SET <span class="token function">logname</span> <span class="token string">"This is my logfile!"</span> <span class="token comment" spellcheck="true">#æ–°å»ºä¸€ä¸ªC key</span>OK127.0.0.1:6379<span class="token operator">></span> RENAME <span class="token function">logname</span> greeting <span class="token comment" spellcheck="true">#ä½¿ç”¨C keyè¦†ç›–B key</span>OK127.0.0.1:6379<span class="token operator">></span> GET greeting <span class="token comment" spellcheck="true">#æŸ¥çœ‹B keyå†…å®¹ï¼ŒåŸæ¥çš„B keyå†…å®¹è¢«è¦†ç›–</span><span class="token string">"This is my logfile!"</span></code></pre><h4 id="RENAMENX"><a href="#RENAMENX" class="headerlink" title="RENAMENX"></a>RENAMENX</h4><p>è¯­æ³•ï¼š<code>RENAMENX key newkey</code></p><p>ä½œç”¨ï¼šå½“ä¸”ä»…å½“ newkey ä¸å­˜åœ¨æ—¶ï¼Œå°† key æ”¹åä¸º newkey ã€‚å½“ key ä¸å­˜åœ¨æ—¶ï¼Œè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚å½“ newkey å·²ç»å­˜åœ¨ï¼Œè¿”å› 0ã€‚</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> SET myname xhy <span class="token comment" spellcheck="true">#åˆ›å»ºä¸€ä¸ªA key</span>OK127.0.0.1:6379<span class="token operator">></span> EXISTS yourname <span class="token comment" spellcheck="true">#æŸ¥çœ‹B keyæ˜¯å¦å­˜åœ¨</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token operator">></span> RENAMENX myname yourname <span class="token comment" spellcheck="true">#å°†A keyé‡å‘½åä¸ºB key</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> EXISTS myname <span class="token comment" spellcheck="true">#æŸ¥çœ‹A keyæ”¹åè¿‡æ˜¯å¦è¿˜å­˜åœ¨</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token operator">></span> GET yourname <span class="token comment" spellcheck="true">#æŸ¥çœ‹B key</span><span class="token string">"xhy"</span>127.0.0.1:6379<span class="token operator">></span> SET myage 18 <span class="token comment" spellcheck="true">#åˆ›å»ºä¸€ä¸ªA key</span>OK127.0.0.1:6379<span class="token operator">></span> SET yourage 20 <span class="token comment" spellcheck="true">#åˆ›å»ºä¸€ä¸ªB key</span>OK127.0.0.1:6379<span class="token operator">></span> RENAMENX myage yourage <span class="token comment" spellcheck="true">#å°†A keyé‡å‘½åä¸ºå·²å­˜åœ¨çš„B key</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token operator">></span> GET myage <span class="token comment" spellcheck="true">#æŸ¥çœ‹æ˜¯å¦é‡å‘½åæˆåŠŸ</span><span class="token string">"18"</span>127.0.0.1:6379<span class="token operator">></span> GET yourage<span class="token string">"20"</span></code></pre><h4 id="RESTORE"><a href="#RESTORE" class="headerlink" title="RESTORE"></a>RESTORE</h4><p>è¯­æ³•ï¼š<code>RESTORE key ttl serializedÂ­value</code></p><p>ä½œç”¨ï¼šååºåˆ—åŒ–ç»™å®šçš„åºåˆ—åŒ–å€¼ï¼Œå¹¶å°†å®ƒå’Œç»™å®šçš„ key å…³è”ã€‚å‚æ•° ttl ä»¥æ¯«ç§’ä¸ºå•ä½ä¸º key è®¾ç½®ç”Ÿå­˜ </p><p>æ—¶é—´ï¼›å¦‚æœ ttl ä¸º 0 ï¼Œé‚£ä¹ˆä¸è®¾ç½®ç”Ÿå­˜æ—¶é—´ã€‚</p><p>ç¤ºä¾‹:</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> SET address <span class="token string">"Hunam,china!"</span> <span class="token comment" spellcheck="true">#åˆ›å»ºä¸€ä¸ªkey</span>OK127.0.0.1:6379<span class="token operator">></span> DUMP address <span class="token comment" spellcheck="true">#æ‰§è¡Œåºåˆ—åŒ–</span><span class="token string">"\x00\x0cHunam,china!\t\x00\xdc\x0e\xa5!@X\x8a\x9c"</span>127.0.0.1:6379<span class="token operator">></span> RESTORE my_address 0 <span class="token string">"\x00\x0cHunam,china!\t\x00\xdc\x0e\xa5!@X\x8a\x9c"</span> <span class="token comment" spellcheck="true">#æ‰§è¡Œååºåˆ—åŒ–</span>OK127.0.0.1:6379<span class="token operator">></span> GET my_address <span class="token comment" spellcheck="true">#æŸ¥çœ‹ååºåˆ—åŒ–åçš„key</span><span class="token string">"Hunam,china!"</span>127.0.0.1:6379<span class="token operator">></span> RESTORE my_address 0 <span class="token string">"\x00c"</span> <span class="token comment" spellcheck="true">#ä½¿ç”¨é”™è¯¯çš„å€¼è¿›è¡Œååºåˆ—åŒ–éªŒè¯æ ¡éªŒæ“ä½œ</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> BUSYKEY Target key name already exists.</code></pre>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDBæ•°æ®å¤‡ä»½å’Œæ¢å¤</title>
      <link href="/d2d0931/"/>
      <url>/d2d0931/</url>
      
        <content type="html"><![CDATA[<h3 id="1-1-å¤‡ä»½æ¦‚è¿°"><a href="#1-1-å¤‡ä»½æ¦‚è¿°" class="headerlink" title="1.1 å¤‡ä»½æ¦‚è¿°"></a>1.1 å¤‡ä»½æ¦‚è¿°</h3><p><code>mongodb</code>æ•°æ®å¤‡ä»½å’Œè¿˜åŸä¸»è¦åˆ†ä¸ºäºŒç§ï¼Œä¸€ç§æ˜¯é’ˆå¯¹äºåº“çš„<code>mongodump</code>å’Œ<code>mongorestore</code>ï¼Œä¸€ç§æ˜¯é’ˆ å¯¹åº“ä¸­è¡¨çš„<code>mongoexport</code>å’Œ<code>mongoimport</code>ã€‚</p><p> <code>mongodump</code>å¤‡ä»½çš„åŸç†æ˜¯é€šè¿‡ä¸€æ¬¡æŸ¥è¯¢è·å–å½“å‰æœåŠ¡å™¨å¿«ç…§ï¼Œå¹¶å°†å¿«ç…§å†™å…¥ç£ç›˜ä¸­ï¼Œå› æ­¤è¿™ç§æ–¹å¼ä¿ å­˜çš„ä¹Ÿä¸æ˜¯å®æ—¶çš„ã€‚åœ¨è·å–å¿«ç…§åï¼ŒæœåŠ¡å™¨è¿˜ä¼šæœ‰æ•°æ®å†™å…¥ï¼Œä¸ºäº†ä¿è¯å¤‡ä»½çš„å®‰å…¨ï¼Œå¯ä»¥åˆ©ç”¨fsyncé”ä½¿ æœåŠ¡å™¨æ•°æ®æš‚æ—¶å†™å…¥ç¼“å­˜ä¸­ã€‚</p><p><code>mongodb</code>å¤‡ä»½æ¢å¤æ–¹å¼é€šå¸¸æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p><ol><li>æ–‡ä»¶å¿«ç…§æ–¹å¼</li><li>å¤åˆ¶æ•°æ®æ–‡ä»¶æ–¹å¼</li><li>ä½¿ç”¨<code>mongodump</code>å’Œ<code>mongorestore</code>æ–¹å¼</li></ol><h3 id="1-2-æ–‡ä»¶å¿«ç…§æ–¹å¼"><a href="#1-2-æ–‡ä»¶å¿«ç…§æ–¹å¼" class="headerlink" title="1.2 æ–‡ä»¶å¿«ç…§æ–¹å¼"></a>1.2 æ–‡ä»¶å¿«ç…§æ–¹å¼</h3><p>æ­¤æ–¹å¼ç›¸å¯¹ç®€å•ï¼Œéœ€è¦ç³»ç»Ÿæ–‡ä»¶æ”¯æŒå¿«ç…§å’Œ<code>mongod</code>å¿…é¡»å¯ç”¨<code>journal</code>ã€‚</p><p>å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»åˆ›å»ºå¿«ç…§ã€‚ æ¢å¤æ—¶ï¼Œç¡®ä¿æ²¡æœ‰è¿è¡Œ<code>mongod</code>ï¼Œæ‰§è¡Œå¿«ç…§æ¢å¤æ“ä½œå‘½ä»¤ï¼Œç„¶åå¯åŠ¨<code>mongod</code>è¿›ç¨‹ï¼Œ<code>mongod</code>é‡æ”¾ <code>journal</code>æ—¥å¿—ã€‚</p><h3 id="1-3-å¤åˆ¶æ–‡ä»¶æ–¹å¼"><a href="#1-3-å¤åˆ¶æ–‡ä»¶æ–¹å¼" class="headerlink" title="1.3 å¤åˆ¶æ–‡ä»¶æ–¹å¼"></a>1.3 å¤åˆ¶æ–‡ä»¶æ–¹å¼</h3><p>ç›´æ¥æ‹·è´æ•°æ®ç›®å½•ä¸‹çš„ä¸€åˆ‡æ–‡ä»¶ï¼Œä½†æ˜¯åœ¨æ‹·è´è¿‡ç¨‹ä¸­å¿…é¡»é˜»æ­¢æ•°æ®æ–‡ä»¶å‘ç”Ÿæ›´æ”¹ã€‚å› æ­¤éœ€è¦å¯¹æ•°æ®åº“ åŠ é”ï¼Œä»¥é˜²æ­¢æ•°æ®å†™å…¥ã€‚</p><pre class=" language-bash"><code class="language-bash">db.fsyncLock<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#é”å®šï¼Œå°†é˜»å¡å†™å…¥æ“ä½œï¼Œå¹¶å°†è„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼Œç¡®ä¿æ•°æ® ä¸€è‡´ã€‚</span><span class="token function">cp</span> -R /data/db/* /backup <span class="token comment" spellcheck="true">#æ‹·è´æ•°æ®æ–‡ä»¶åˆ°å¤‡ä»½ç›®å½•ä¸‹ </span>db.fsyncUnlock<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">#æ–‡ä»¶å¤åˆ¶å®Œæˆåï¼Œå¯¹æ•°æ®åº“è¿›è¡Œè§£é”ï¼Œå…è®¸å†™æ“ä½œ </span><span class="token comment" spellcheck="true">#æ³¨æ„ï¼š åœ¨æ‰§è¡Œdb.fsyncLock()å’Œdb.fsyncUnlock()æ—¶ï¼Œä¸èƒ½å…³é—­å½“å‰çš„shellçª—å£ï¼Œå¦åˆ™å¯èƒ½æ— æ³• è¿æ¥è€Œéœ€è¦é‡æ–°å¯åŠ¨mongodæœåŠ¡ã€‚ æ¢å¤æ—¶ï¼Œç¡®ä¿mongodæ²¡æœ‰è¿è¡Œï¼Œæ¸…ç©ºæ•°æ®ç›®å½•ï¼Œå°†å¤‡ä»½çš„æ•°æ®æ‹·è´åˆ°æ•°æ®ç›®å½•ä¸‹ï¼Œç„¶åå¯åŠ¨mongod </span><span class="token function">cp</span> -R /backup/* /data/db/ mongod -f mongod.conf</code></pre><h3 id="1-4-Mongodumpæ•°æ®å¤‡ä»½"><a href="#1-4-Mongodumpæ•°æ®å¤‡ä»½" class="headerlink" title="1.4  Mongodumpæ•°æ®å¤‡ä»½"></a>1.4  Mongodumpæ•°æ®å¤‡ä»½</h3><p>åœ¨<code>Mongodb</code>ä¸­æˆ‘ä»¬ä½¿ç”¨<code>mongodump</code>å‘½ä»¤æ¥å¤‡ä»½<code>MongoDB</code>æ•°æ®ã€‚</p><p>è¯¥å‘½ä»¤å¯ä»¥å¯¼å‡ºæ‰€æœ‰æ•°æ®åˆ°æŒ‡å®šç›®å½• ä¸­ã€‚ <code>mongodump</code>å‘½ä»¤å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šå¯¼å‡ºçš„æ•°æ®é‡çº§è½¬å­˜çš„æœåŠ¡å™¨ã€‚</p><p>å‘½ä»¤æ ¼å¼å¦‚ä¸‹</p><pre class=" language-bash"><code class="language-bash">mongodump -h IP --port ç«¯å£ -u ç”¨æˆ·å -p å¯†ç  -d æ•°æ®åº“ -o æ–‡ä»¶å­˜åœ¨è·¯å¾„</code></pre><h3 id="1-5-Mongorestoreæ•°æ®æ¢å¤"><a href="#1-5-Mongorestoreæ•°æ®æ¢å¤" class="headerlink" title="1.5 Mongorestoreæ•°æ®æ¢å¤"></a>1.5 Mongorestoreæ•°æ®æ¢å¤</h3><p>åœ¨<code>Mongodb</code>ä¸­æˆ‘ä»¬ä½¿ç”¨<code>mongorestore</code>å‘½ä»¤æ¥æ¢å¤<code>MongoDB</code>æ•°æ®ã€‚è¯¥å‘½ä»¤å¯ä»¥ä»æŒ‡å®šç›®å½•æ¢å¤ç›¸åº”æ•°æ®ã€‚</p><p>å‘½ä»¤æ ¼å¼å¦‚ä¸‹</p><pre class=" language-bash"><code class="language-bash">mongorestore -h IP --port ç«¯å£ -u ç”¨æˆ·å -p å¯†ç  -d æ•°æ®åº“ --drop æ–‡ä»¶å­˜å‚¨è·¯å¾„</code></pre><h3 id="1-6-å®šæ—¶å¤‡ä»½è„šæœ¬"><a href="#1-6-å®šæ—¶å¤‡ä»½è„šæœ¬" class="headerlink" title="1.6 å®šæ—¶å¤‡ä»½è„šæœ¬"></a>1.6 å®šæ—¶å¤‡ä»½è„šæœ¬</h3><p>å®šæ—¶ä»»åŠ¡è¿›è¡Œæ¯å¤©å¤‡ä»½</p><pre class=" language-shell"><code class="language-shell">#!/bin/shDUMP=mongodumpOUT_DIR=/data/backup/mongod/tmpTAR_DIR=/data/backup/mongodDATE=`date +%Y_%m_%d_%H_%M_%S`DB_USER=testDB_PASS=testDATABASE=testDAYS=14TAR_BAK="mongod_bak_$DATE.tar.gz"cd $OUT_DIRrm rf $OUT_DIR/mkdir p $OUT_DIR/$DAT$DUMP -h 192.168.0.135 --port 27017 -u $DB_USER -p $DB_PASS -d $DATABASE -o $OUT_DIR/$DATEtar zcvf $TAR_DIR/$TAR_BAK $OUT_DIR/$DATEfind $TAR_DIR/ -mtime +$DAYS -delete</code></pre><pre class=" language-bash"><code class="language-bash">30 02 * * * sh /root/mongod_bak.sh</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mongo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mongo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx ifå¤šæ¡ä»¶åˆ¤æ–­</title>
      <link href="/3ba6a52e/"/>
      <url>/3ba6a52e/</url>
      
        <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>Nginxé»˜è®¤æ˜¯ä¸æ”¯æŒç›´æ¥è¿›è¡Œå¤šé€»è¾‘åˆ¤æ–­çš„,ä¾‹å¦‚å¦‚ä¸‹ä»£ç </p><pre class=" language-nginx"><code class="language-nginx">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">!=</span> <span class="token string">"curl"</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$remote_addr</span> <span class="token operator">!=</span> <span class="token string">"172.16.182.204"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>è¿™æ ·é…ç½®<code>nginx -t</code>ä¼šæç¤ºé…ç½®æ–‡ä»¶æœ‰é”™è¯¯</p><pre class=" language-bash"><code class="language-bash">nginx: <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> invalid condition <span class="token string">"<span class="token variable">$http_user_agent</span>"</span> <span class="token keyword">in</span> /usr/local/nginx/conf/conf.d/proxy.conf:38nginx: configuration <span class="token function">file</span> /usr/local/nginx/conf/nginx.conf <span class="token function">test</span> failed</code></pre><p>æ‰€ä»¥éœ€è¦é‡‡å–å…¶ä»–çš„æ–¹æ¡ˆ</p><h3 id="ä½¿ç”¨å˜é‡å®ç°ä¸è¿ç®—"><a href="#ä½¿ç”¨å˜é‡å®ç°ä¸è¿ç®—" class="headerlink" title="ä½¿ç”¨å˜é‡å®ç°ä¸è¿ç®—"></a>ä½¿ç”¨å˜é‡å®ç°ä¸è¿ç®—</h3><pre class=" language-bash"><code class="language-bash">        <span class="token keyword">set</span> <span class="token variable">$fooo</span> <span class="token string">" "</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">!=</span> <span class="token string">"curl"</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">set</span> <span class="token variable">$fooo</span> <span class="token string">"<span class="token variable">${fooo}</span>1"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$remote_addr</span> <span class="token operator">!=</span> <span class="token string">"172.16.182.204"</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">set</span> <span class="token variable">$fooo</span> <span class="token string">"<span class="token variable">${fooo}</span>1"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$fooo</span> ~* <span class="token string">"11"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> 403<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">#å½“user_agentä¸ç­‰äºcurlä¸”å®¢æˆ·ç«¯åœ°å€ä¸æ˜¯172.16.182.204è¿”å›403</span></code></pre><p>è®¿é—®æµ‹è¯•</p><pre class=" language-bash"><code class="language-bash">curl -I -k -A <span class="token string">"curl"</span> https://172.30.151.219 <span class="token comment" spellcheck="true">#æ»¡è¶³å®¢æˆ·ç«¯åœ°å€ä¸æ˜¯172.16.182.204 ä½†æ˜¯user_agentæ˜¯curl æ‰€ä»¥æ­£å¸¸è¿”å›</span>HTTP/1.1 200 OKDate: Sun, 12 Jun 2022 06:27:05 GMTContent-Type: text/html<span class="token punctuation">;</span> charset<span class="token operator">=</span>UTF-8Connection: keep-aliveVary: Accept-EncodingExpires: Mon, 26 Jul 1997 05:00:00 GMT</code></pre><pre class=" language-bash"><code class="language-bash">curl -I -k  https://172.30.151.219  <span class="token comment" spellcheck="true">#user_agentä¸æ˜¯curl ä½†æ˜¯åœ°å€æ˜¯172.16.182.204  æ­£å¸¸è¿”å›</span>HTTP/1.1 200 OKDate: Sun, 12 Jun 2022 06:31:42 GMTContent-Type: text/html<span class="token punctuation">;</span> charset<span class="token operator">=</span>UTF-8Connection: keep-aliveVary: Accept-EncodingExpires: Mon, 26 Jul 1997 05:00:00 GMT</code></pre><pre class=" language-bash"><code class="language-bash">curl -I -k  https://172.30.151.219  <span class="token comment" spellcheck="true">#ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ è¿”å›403</span>HTTP/1.1 403 ForbiddenDate: Sun, 12 Jun 2022 06:31:10 GMTContent-Type: text/htmlConnection: keep-aliveVary: Accept-Encoding</code></pre><h3 id="ä½¿ç”¨å˜é‡å®ç°é€»è¾‘æˆ–è¿ç®—"><a href="#ä½¿ç”¨å˜é‡å®ç°é€»è¾‘æˆ–è¿ç®—" class="headerlink" title="ä½¿ç”¨å˜é‡å®ç°é€»è¾‘æˆ–è¿ç®—"></a>ä½¿ç”¨å˜é‡å®ç°é€»è¾‘æˆ–è¿ç®—</h3><pre class=" language-nginx"><code class="language-nginx">        <span class="token keyword">set</span> <span class="token variable">$fooo</span> <span class="token string">" "</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">!=</span> <span class="token string">"curl"</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">set</span> <span class="token variable">$fooo</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$remote_addr</span> <span class="token operator">!=</span> <span class="token string">"172.16.182.204"</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">set</span> <span class="token variable">$fooo</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$fooo</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token string">"1"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token number">403</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p>è®¿é—®æµ‹è¯•</p><pre class=" language-bash"><code class="language-bash">curl -I -k  https://172.30.151.219  <span class="token comment" spellcheck="true">#user_agentä¸æ­£ç¡® </span>HTTP/1.1 403 ForbiddenDate: Sun, 12 Jun 2022 06:35:00 GMTContent-Type: text/htmlConnection: keep-aliveVary: Accept-Encoding</code></pre><pre class=" language-bash"><code class="language-bash">curl -I -k -A <span class="token string">"curl"</span> https://172.30.151.219  <span class="token comment" spellcheck="true">#å®¢æˆ·ç«¯ipåœ°å€ä¸æ­£ç¡®</span>HTTP/1.1 403 ForbiddenDate: Sun, 12 Jun 2022 06:35:45 GMTContent-Type: text/htmlConnection: keep-aliveVary: Accept-Encoding</code></pre><pre class=" language-bash"><code class="language-bash">curl -I -k -A <span class="token string">"curl"</span> https://172.30.151.219   <span class="token comment" spellcheck="true">#ä¸¤ä¸ªéƒ½æ»¡è¶³è®¿é—®æ­£å¸¸</span>HTTP/1.1 200 OKDate: Sun, 12 Jun 2022 06:36:25 GMTContent-Type: text/html<span class="token punctuation">;</span> charset<span class="token operator">=</span>UTF-8Connection: keep-aliveVary: Accept-EncodingExpires: Mon, 26 Jul 1997 05:00:00 GMT</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker Yuméƒ¨ç½²</title>
      <link href="/77d7bcd/"/>
      <url>/77d7bcd/</url>
      
        <content type="html"><![CDATA[<h3 id="1-1-é…ç½®ç¬¬ä¸‰æ–¹yumæº"><a href="#1-1-é…ç½®ç¬¬ä¸‰æ–¹yumæº" class="headerlink" title="1.1 é…ç½®ç¬¬ä¸‰æ–¹yumæº"></a>1.1 é…ç½®ç¬¬ä¸‰æ–¹yumæº</h3><pre class=" language-bash"><code class="language-bash">yum -y <span class="token function">install</span> yum-utils<span class="token function">mv</span> /etc/yum.repos.d/dvd.repo<span class="token punctuation">{</span>,.bak<span class="token punctuation">}</span><span class="token function">wget</span> -O /etc/yum.repos.d/centos-base.repo http://mirrors.aliyun.com/repo/Centos-7.repoyum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></pre><h3 id="1-2-ç”Ÿæˆç¼“å­˜"><a href="#1-2-ç”Ÿæˆç¼“å­˜" class="headerlink" title="1.2 ç”Ÿæˆç¼“å­˜"></a>1.2 ç”Ÿæˆç¼“å­˜</h3><pre class=" language-bash"><code class="language-bash">yum makecache fastyum repolist</code></pre><h3 id="1-3-å®‰è£…Dockerä¾èµ–"><a href="#1-3-å®‰è£…Dockerä¾èµ–" class="headerlink" title="1.3 å®‰è£…Dockerä¾èµ–"></a>1.3 å®‰è£…Dockerä¾èµ–</h3><pre class=" language-bash"><code class="language-bash">yum -y <span class="token function">install</span> yum-utils device-mapperpersistent-data lvm2yum -y <span class="token function">install</span> docker-ce</code></pre><h3 id="1-4-é…ç½®Dockeré•œåƒåŠ é€Ÿ"><a href="#1-4-é…ç½®Dockeré•œåƒåŠ é€Ÿ" class="headerlink" title="1.4 é…ç½®Dockeré•œåƒåŠ é€Ÿ"></a>1.4 é…ç½®Dockeré•œåƒåŠ é€Ÿ</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p /etc/docker<span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span>-<span class="token string">'EOF'</span><span class="token punctuation">{</span>    <span class="token string">"registry-mirrors"</span><span class="token keyword">:</span>    <span class="token punctuation">[</span><span class="token string">"https://ww9b0ehc.mirror.aliyuncs.com"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>EOF</code></pre><h3 id="1-5-å¯åŠ¨"><a href="#1-5-å¯åŠ¨" class="headerlink" title="1.5 å¯åŠ¨"></a>1.5 å¯åŠ¨</h3><pre class=" language-bash"><code class="language-bash">systemctl daemon-reloadsystemctl restart docker</code></pre><h3 id="1-6-æŸ¥çœ‹ç‰ˆæœ¬"><a href="#1-6-æŸ¥çœ‹ç‰ˆæœ¬" class="headerlink" title="1.6 æŸ¥çœ‹ç‰ˆæœ¬"></a>1.6 æŸ¥çœ‹ç‰ˆæœ¬</h3><pre class=" language-bash"><code class="language-bash">docker versiondocker info<span class="token comment" spellcheck="true"># æ·»åŠ å†…æ ¸å‚æ•°é˜²æ­¢æŠ¥é”™</span>vim /etc/sysctl.confnet.ipv4.ip_forward <span class="token operator">=</span> 1net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> 1net.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> 1</code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Curlè¯¦è§£</title>
      <link href="/e7586c26/"/>
      <url>/e7586c26/</url>
      
        <content type="html"><![CDATA[<h1 id="Curlè¯¦è§£"><a href="#Curlè¯¦è§£" class="headerlink" title="Curlè¯¦è§£"></a>Curlè¯¦è§£</h1><h3 id="1-Postè¯·æ±‚"><a href="#1-Postè¯·æ±‚" class="headerlink" title="1.Postè¯·æ±‚"></a>1.Postè¯·æ±‚</h3><pre class=" language-bash"><code class="language-bash">curl -H <span class="token string">"Accept: application/json"</span> -H <span class="token string">"Content-type: application/json"</span> -X POST -d <span class="token string">'{"phone": "18000011005","password": "xxxxx", "status":40,"order_no":"1998708","config":{"loading":true},"data": "123", "appVersion": "1.2.3","CHEN_ZHE_TEST_ONE_TWO_THREE": 1}'</span>  http://192.168.57.80/mjyx-mall-gateway2/web/index.php/auth/login</code></pre><h4 id="è®¾ç½®POST-Header"><a href="#è®¾ç½®POST-Header" class="headerlink" title="è®¾ç½®POST Header"></a>è®¾ç½®POST Header</h4><blockquote><p>-H â€œAccept: application&#x2F;jsonâ€ -H â€œContent-type: application&#x2F;jsonâ€ -X POST -d </p></blockquote><h4 id="è¯·æ±‚å‚æ•°-parames"><a href="#è¯·æ±‚å‚æ•°-parames" class="headerlink" title="è¯·æ±‚å‚æ•° parames"></a>è¯·æ±‚å‚æ•° parames</h4><blockquote><p>â€˜{â€œphoneâ€: â€œ18000011005â€,â€passwordâ€: â€œxxxxxâ€, â€œstatusâ€:4,â€order_noâ€:â€1998708â€,â€configâ€:{â€œloadingâ€:true},â€dataâ€: â€œ123â€, â€œappVersionâ€: â€œ1.2.3â€,â€CHEN_ZHE_TEST_ONE_TWO_THREEâ€: 1}â€™ </p></blockquote><h4 id="è¯·æ±‚è·¯å¾„-URL"><a href="#è¯·æ±‚è·¯å¾„-URL" class="headerlink" title="è¯·æ±‚è·¯å¾„ URL"></a>è¯·æ±‚è·¯å¾„ URL</h4><blockquote><p><a href="http://192.168.57.80/gateway/login">http://192.168.57.80/gateway/login</a></p></blockquote><h3 id="2-æŒ‡å®šUser-Agent"><a href="#2-æŒ‡å®šUser-Agent" class="headerlink" title="2. æŒ‡å®šUser-Agent"></a>2. æŒ‡å®šUser-Agent</h3><p><code>-A</code>å‚æ•°æŒ‡å®šå®¢æˆ·ç«¯çš„ç”¨æˆ·ä»£ç†æ ‡å¤´ï¼Œå³<code>User-Agent</code>ã€‚curl çš„é»˜è®¤ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²æ˜¯<code>curl/[version]</code>ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -A <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36'</span> https://google.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤å°†<code>User-Agent</code>æ”¹æˆ Chrome æµè§ˆå™¨ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -A <span class="token string">''</span> https://google.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤ä¼šç§»é™¤<code>User-Agent</code>æ ‡å¤´ã€‚</p><p>ä¹Ÿå¯ä»¥é€šè¿‡<code>-H</code>å‚æ•°ç›´æ¥æŒ‡å®šæ ‡å¤´ï¼Œæ›´æ”¹<code>User-Agent</code>ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -H <span class="token string">'User-Agent: php/1.0'</span> https://google.com</code></pre></blockquote><h3 id="3-æŒ‡å®šCookie"><a href="#3-æŒ‡å®šCookie" class="headerlink" title="3.æŒ‡å®šCookie"></a>3.æŒ‡å®šCookie</h3><p><code>-b</code>å‚æ•°ç”¨æ¥å‘æœåŠ¡å™¨å‘é€ Cookieã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -b <span class="token string">'foo=bar'</span> https://google.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤ä¼šç”Ÿæˆä¸€ä¸ªæ ‡å¤´<code>Cookie: foo=bar</code>ï¼Œå‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªåä¸º<code>foo</code>ã€å€¼ä¸º<code>bar</code>çš„ Cookieã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -b <span class="token string">'foo1=bar;foo2=bar2'</span> https://google.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤å‘é€ä¸¤ä¸ª Cookieã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -b cookies.txt https://www.google.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤è¯»å–æœ¬åœ°æ–‡ä»¶<code>cookies.txt</code>ï¼Œé‡Œé¢æ˜¯æœåŠ¡å™¨è®¾ç½®çš„ Cookieï¼ˆå‚è§<code>-c</code>å‚æ•°ï¼‰ï¼Œå°†å…¶å‘é€åˆ°æœåŠ¡å™¨ã€‚</p><p><code>-c</code>å‚æ•°å°†æœåŠ¡å™¨è®¾ç½®çš„ Cookie å†™å…¥ä¸€ä¸ªæ–‡ä»¶ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -c cookies.txt https://www.google.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤å°†æœåŠ¡å™¨çš„ HTTP å›åº”æ‰€è®¾ç½® Cookie å†™å…¥æ–‡æœ¬æ–‡ä»¶<code>cookies.txt</code></p><h3 id="4-æŒ‡å®šreferer"><a href="#4-æŒ‡å®šreferer" class="headerlink" title="4.æŒ‡å®šreferer"></a>4.æŒ‡å®šreferer</h3><p><code>-e</code>å‚æ•°ç”¨æ¥è®¾ç½® HTTP çš„æ ‡å¤´<code>Referer</code>ï¼Œè¡¨ç¤ºè¯·æ±‚çš„æ¥æºã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">curl -e <span class="token string">'https://google.com?q=example'</span> https://www.example.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤å°†<code>Referer</code>æ ‡å¤´è®¾ä¸º<code>https://google.com?q=example</code>ã€‚</p><p><code>-H</code>å‚æ•°å¯ä»¥é€šè¿‡ç›´æ¥æ·»åŠ æ ‡å¤´<code>Referer</code>ï¼Œè¾¾åˆ°åŒæ ·æ•ˆæœã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">curl -H <span class="token string">'Referer: https://google.com?q=example'</span> https://www.example.com</code></pre></blockquote><h3 id="5-æŒ‡å®šHeader"><a href="#5-æŒ‡å®šHeader" class="headerlink" title="5.æŒ‡å®šHeader"></a>5.æŒ‡å®šHeader</h3><p><code>-H</code>å‚æ•°æ·»åŠ  HTTP è¯·æ±‚çš„æ ‡å¤´ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -H <span class="token string">'Accept-Language: en-US'</span> https://google.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤æ·»åŠ  HTTP æ ‡å¤´<code>Accept-Language: en-US</code>ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -H <span class="token string">'Accept-Language: en-US'</span> -H <span class="token string">'Secret-Message: xyzzy'</span> https://google.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤æ·»åŠ ä¸¤ä¸ª HTTP æ ‡å¤´ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -d <span class="token string">'{"login": "emma", "pass": "123"}'</span> -H <span class="token string">'Content-Type: application/json'</span> https://google.com/login</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤æ·»åŠ  HTTP è¯·æ±‚çš„æ ‡å¤´æ˜¯<code>Content-Type: application/json</code>ï¼Œç„¶åç”¨<code>-d</code>å‚æ•°å‘é€ JSON æ•°æ®ã€‚</p><h3 id="6-æŒ‡å®šè·³è¿‡SSlç›‘æµ‹"><a href="#6-æŒ‡å®šè·³è¿‡SSlç›‘æµ‹" class="headerlink" title="6.æŒ‡å®šè·³è¿‡SSlç›‘æµ‹"></a>6.æŒ‡å®šè·³è¿‡SSlç›‘æµ‹</h3><p><code>-k</code>å‚æ•°æŒ‡å®šè·³è¿‡ SSL æ£€æµ‹ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -k https://www.example.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤ä¸ä¼šæ£€æŸ¥æœåŠ¡å™¨çš„ SSL è¯ä¹¦æ˜¯å¦æ­£ç¡®ã€‚</p><h3 id="7-è·Ÿéšé‡å®šå‘"><a href="#7-è·Ÿéšé‡å®šå‘" class="headerlink" title="7.è·Ÿéšé‡å®šå‘"></a>7.è·Ÿéšé‡å®šå‘</h3><p><code>-L</code>å‚æ•°ä¼šè®© HTTP è¯·æ±‚è·ŸéšæœåŠ¡å™¨çš„é‡å®šå‘ã€‚curl é»˜è®¤ä¸è·Ÿéšé‡å®šå‘ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -L -d <span class="token string">'tweet=hi'</span> https://api.twitter.com/tweet</code></pre></blockquote><p><code>--limit-rate</code>ç”¨æ¥é™åˆ¶ HTTP è¯·æ±‚å’Œå›åº”çš„å¸¦å®½ï¼Œæ¨¡æ‹Ÿæ…¢ç½‘é€Ÿçš„ç¯å¢ƒã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl --limit-rate 200k https://google.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤å°†å¸¦å®½é™åˆ¶åœ¨æ¯ç§’ 200K å­—èŠ‚ã€‚</p><h3 id="8-ä¸‹è½½æ–‡ä»¶"><a href="#8-ä¸‹è½½æ–‡ä»¶" class="headerlink" title="8.ä¸‹è½½æ–‡ä»¶"></a>8.ä¸‹è½½æ–‡ä»¶</h3><p><code>-o</code>å‚æ•°å°†æœåŠ¡å™¨çš„å›åº”ä¿å­˜æˆæ–‡ä»¶ï¼Œç­‰åŒäº<code>wget</code>å‘½ä»¤ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -o example.html https://www.example.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤å°†<code>www.example.com</code>ä¿å­˜æˆ<code>example.html</code>ã€‚</p><p><code>-O</code>å‚æ•°å°†æœåŠ¡å™¨å›åº”ä¿å­˜æˆæ–‡ä»¶ï¼Œå¹¶å°† URL çš„æœ€åéƒ¨åˆ†å½“ä½œæ–‡ä»¶åã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -O https://www.example.com/foo/bar.html</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤å°†æœåŠ¡å™¨å›åº”ä¿å­˜æˆæ–‡ä»¶ï¼Œæ–‡ä»¶åä¸º<code>bar.html</code>ã€‚</p><h3 id="9-é™é»˜è¾“å‡º"><a href="#9-é™é»˜è¾“å‡º" class="headerlink" title="9.é™é»˜è¾“å‡º"></a>9.é™é»˜è¾“å‡º</h3><p><code>-s</code>å‚æ•°å°†ä¸è¾“å‡ºé”™è¯¯å’Œè¿›åº¦ä¿¡æ¯ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -s https://www.example.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤ä¸€æ—¦å‘ç”Ÿé”™è¯¯ï¼Œä¸ä¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚ä¸å‘ç”Ÿé”™è¯¯çš„è¯ï¼Œä¼šæ­£å¸¸æ˜¾ç¤ºè¿è¡Œç»“æœã€‚</p><p>å¦‚æœæƒ³è®© curl ä¸äº§ç”Ÿä»»ä½•è¾“å‡ºï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -s -o /dev/null https://google.com</code></pre></blockquote><h3 id="10-ç”¨æˆ·è®¤è¯"><a href="#10-ç”¨æˆ·è®¤è¯" class="headerlink" title="10.ç”¨æˆ·è®¤è¯"></a>10.ç”¨æˆ·è®¤è¯</h3><p><code>-u</code>å‚æ•°ç”¨æ¥è®¾ç½®æœåŠ¡å™¨è®¤è¯çš„ç”¨æˆ·åå’Œå¯†ç ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -u <span class="token string">'bob:12345'</span> https://google.com/login</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤è®¾ç½®ç”¨æˆ·åä¸º<code>bob</code>ï¼Œå¯†ç ä¸º<code>12345</code>ï¼Œç„¶åå°†å…¶è½¬ä¸º HTTP æ ‡å¤´<code>Authorization: Basic Ym9iOjEyMzQ1</code>ã€‚</p><p>curl èƒ½å¤Ÿè¯†åˆ« URL é‡Œé¢çš„ç”¨æˆ·åå’Œå¯†ç ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl https://bob:12345@google.com/login</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤èƒ½å¤Ÿè¯†åˆ« URL é‡Œé¢çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå°†å…¶è½¬ä¸ºä¸Šä¸ªä¾‹å­é‡Œé¢çš„ HTTP æ ‡å¤´ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -u <span class="token string">'bob'</span> https://google.com/login</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤åªè®¾ç½®äº†ç”¨æˆ·åï¼Œæ‰§è¡Œåï¼Œcurl ä¼šæç¤ºç”¨æˆ·è¾“å…¥å¯†ç ã€‚</p><h3 id="11-æ˜¾ç¤ºé€šä¿¡è¿‡ç¨‹"><a href="#11-æ˜¾ç¤ºé€šä¿¡è¿‡ç¨‹" class="headerlink" title="11.æ˜¾ç¤ºé€šä¿¡è¿‡ç¨‹"></a>11.æ˜¾ç¤ºé€šä¿¡è¿‡ç¨‹</h3><p><code>-v</code>å‚æ•°è¾“å‡ºé€šä¿¡çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œç”¨äºè°ƒè¯•ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -v https://www.example.com</code></pre></blockquote><p><code>--trace</code>å‚æ•°ä¹Ÿå¯ä»¥ç”¨äºè°ƒè¯•ï¼Œè¿˜ä¼šè¾“å‡ºåŸå§‹çš„äºŒè¿›åˆ¶æ•°æ®ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl --trace - https://www.example.com</code></pre></blockquote><h3 id="12-æŒ‡å®šä»£ç†"><a href="#12-æŒ‡å®šä»£ç†" class="headerlink" title="12.æŒ‡å®šä»£ç†"></a>12.æŒ‡å®šä»£ç†</h3><p><code>-x</code>å‚æ•°æŒ‡å®š HTTP è¯·æ±‚çš„ä»£ç†ã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -x socks5://james:cats@myproxy.com:8080 https://www.example.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤æŒ‡å®š HTTP è¯·æ±‚é€šè¿‡<code>myproxy.com:8080</code>çš„ socks5 ä»£ç†å‘å‡ºã€‚</p><p>å¦‚æœæ²¡æœ‰æŒ‡å®šä»£ç†åè®®ï¼Œé»˜è®¤ä¸º HTTPã€‚</p><blockquote><pre class=" language-bash"><code class="language-bash">$ curl -x james:cats@myproxy.com:8080 https://www.example.com</code></pre></blockquote><p>ä¸Šé¢å‘½ä»¤ä¸­ï¼Œè¯·æ±‚çš„ä»£ç†ä½¿ç”¨ HTTP åè®®ã€‚</p><h3 id="13-æŒ‡å®šè§£æ"><a href="#13-æŒ‡å®šè§£æ" class="headerlink" title="13.æŒ‡å®šè§£æ"></a>13.æŒ‡å®šè§£æ</h3><p><code>--resolve</code> æŒ‡å®šè§£æçš„ip</p><pre class=" language-bash"><code class="language-bash">curl --resolve html.uu898.com:80:125.254.136.140 http://html.uu898.com/protocol/userProtocol_yinsi.htm</code></pre><h3 id="14-æŒ‡å®šè¶…æ—¶æ—¶é—´"><a href="#14-æŒ‡å®šè¶…æ—¶æ—¶é—´" class="headerlink" title="14 æŒ‡å®šè¶…æ—¶æ—¶é—´"></a>14 æŒ‡å®šè¶…æ—¶æ—¶é—´</h3><p><code>--connect-timeout</code>å¯ä»¥æŒ‡å®šè¿æ¥å»ºç«‹çš„è¶…æ—¶æ—¶é—´ è¶…æ—¶æŠ¥é”™<code>curl: (28) connect() timed out!</code></p><p><code>-m</code> æŒ‡å®šè¿æ¥è¿‡ç¨‹æœ€å¤§çš„å…è®¸æ—¶é—´<code>curl: (28) Operation timed out after 2000 milliseconds with 0 bytes received</code></p><pre class=" language-bash"><code class="language-bash">curl -I --connect-timeout 2 -m 5 -o  /dev/null  https://www.baidu.com</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux pidstat å‘½ä»¤è¯¦è§£</title>
      <link href="/e08f072d/"/>
      <url>/e08f072d/</url>
      
        <content type="html"><![CDATA[<p><strong>1.pidstat æ¦‚è¿°</strong><br>pidstatæ˜¯sysstatå·¥å…·çš„ä¸€ä¸ªå‘½ä»¤ï¼Œç”¨äºç›‘æ§å…¨éƒ¨æˆ–æŒ‡å®šè¿›ç¨‹çš„cpuã€å†…å­˜ã€çº¿ç¨‹ã€è®¾å¤‡IOç­‰ç³»ç»Ÿèµ„æºçš„å ç”¨æƒ…å†µã€‚pidstaté¦–æ¬¡è¿è¡Œæ—¶æ˜¾ç¤ºè‡ªç³»ç»Ÿå¯åŠ¨å¼€å§‹çš„å„é¡¹ç»Ÿè®¡ä¿¡æ¯ï¼Œä¹‹åè¿è¡Œpidstatå°†æ˜¾ç¤ºè‡ªä¸Šæ¬¡è¿è¡Œè¯¥å‘½ä»¤ä»¥åçš„ç»Ÿè®¡ä¿¡æ¯ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æŒ‡å®šç»Ÿè®¡çš„æ¬¡æ•°å’Œæ—¶é—´æ¥è·å¾—æ‰€éœ€çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p><hr><p><strong>2.pidstat å®‰è£…</strong><br>pidstat æ˜¯sysstatè½¯ä»¶å¥—ä»¶çš„ä¸€éƒ¨åˆ†ï¼ŒsysstatåŒ…å«å¾ˆå¤šç›‘æ§linuxç³»ç»ŸçŠ¶æ€çš„å·¥å…·ï¼Œå®ƒèƒ½å¤Ÿä»å¤§å¤šæ•°linuxå‘è¡Œç‰ˆçš„è½¯ä»¶æºä¸­è·å¾—ã€‚</p><p>åœ¨Debian&#x2F;Ubuntuç³»ç»Ÿä¸­å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥å®‰è£…:</p><pre class=" language-yaml"><code class="language-yaml">apt<span class="token punctuation">-</span>get install sysstat</code></pre><p>CentOS&#x2F;Fedora&#x2F;RHELç‰ˆæœ¬çš„linuxä¸­åˆ™ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š</p><pre class=" language-yaml"><code class="language-yaml">yum install sysstat</code></pre><hr><p><strong>3.pidstat ç¤ºä¾‹</strong><br>pidstat çš„ç”¨æ³•ï¼š</p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">[</span> é€‰é¡¹ <span class="token punctuation">]</span> <span class="token punctuation">[</span> &lt;æ—¶é—´é—´éš”<span class="token punctuation">></span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> &lt;æ¬¡æ•°<span class="token punctuation">></span> <span class="token punctuation">]</span></code></pre><p>å¸¸ç”¨çš„å‚æ•°ï¼š</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span>uï¼šé»˜è®¤çš„å‚æ•°ï¼Œæ˜¾ç¤ºå„ä¸ªè¿›ç¨‹çš„cpuä½¿ç”¨ç»Ÿè®¡<span class="token punctuation">-</span>rï¼šæ˜¾ç¤ºå„ä¸ªè¿›ç¨‹çš„å†…å­˜ä½¿ç”¨ç»Ÿè®¡<span class="token punctuation">-</span>dï¼šæ˜¾ç¤ºå„ä¸ªè¿›ç¨‹çš„IOä½¿ç”¨æƒ…å†µ<span class="token punctuation">-</span>pï¼šæŒ‡å®šè¿›ç¨‹å·<span class="token punctuation">-</span>wï¼šæ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æƒ…å†µ<span class="token punctuation">-</span>tï¼šæ˜¾ç¤ºé€‰æ‹©ä»»åŠ¡çš„çº¿ç¨‹çš„ç»Ÿè®¡ä¿¡æ¯å¤–çš„é¢å¤–ä¿¡æ¯<span class="token punctuation">-</span>T <span class="token punctuation">{</span> TASK <span class="token punctuation">|</span> CHILD <span class="token punctuation">|</span> ALL <span class="token punctuation">}</span> è¿™ä¸ªé€‰é¡¹æŒ‡å®šäº†pidstatç›‘æ§çš„ã€‚TASKè¡¨ç¤ºæŠ¥å‘Šç‹¬ç«‹çš„taskï¼ŒCHILDå…³é”®å­—è¡¨ç¤ºæŠ¥å‘Šè¿›ç¨‹ä¸‹æ‰€æœ‰çº¿ç¨‹ç»Ÿè®¡ä¿¡æ¯ã€‚ALLè¡¨ç¤ºæŠ¥å‘Šç‹¬ç«‹çš„taskå’Œtaskä¸‹é¢çš„æ‰€æœ‰çº¿ç¨‹ã€‚ æ³¨æ„ï¼štaskå’Œå­çº¿ç¨‹çš„å…¨å±€çš„ç»Ÿè®¡ä¿¡æ¯å’Œpidstaté€‰é¡¹æ— å…³ã€‚è¿™äº›ç»Ÿè®¡ä¿¡æ¯ä¸ä¼šå¯¹åº”åˆ°å½“å‰çš„ç»Ÿè®¡é—´éš”ï¼Œè¿™äº›ç»Ÿè®¡ä¿¡æ¯åªæœ‰åœ¨å­çº¿ç¨‹killæˆ–è€…å®Œæˆçš„æ—¶å€™æ‰ä¼šè¢«æ”¶é›†ã€‚<span class="token punctuation">-</span>Vï¼šç‰ˆæœ¬å·<span class="token punctuation">-</span>hï¼šåœ¨ä¸€è¡Œä¸Šæ˜¾ç¤ºäº†æ‰€æœ‰æ´»åŠ¨ï¼Œè¿™æ ·å…¶ä»–ç¨‹åºå¯ä»¥å®¹æ˜“è§£æã€‚<span class="token punctuation">-</span>Iï¼šåœ¨SMPç¯å¢ƒï¼Œè¡¨ç¤ºä»»åŠ¡çš„CPUä½¿ç”¨ç‡/å†…æ ¸æ•°é‡<span class="token punctuation">-</span>lï¼šæ˜¾ç¤ºå‘½ä»¤åå’Œæ‰€æœ‰å‚æ•°</code></pre><hr><p><strong>ç¤ºä¾‹ä¸€ï¼šæŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹çš„  CPU ä½¿ç”¨æƒ…å†µï¼ˆ -u -p ALLï¼‰</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstatpidstat <span class="token punctuation">-</span>u <span class="token punctuation">-</span>p ALL</code></pre><p>pidstat å’Œ pidstat -u -p ALL æ˜¯ç­‰æ•ˆçš„ã€‚ pidstat é»˜è®¤æ˜¾ç¤ºäº†æ‰€æœ‰è¿›ç¨‹çš„cpuä½¿ç”¨ç‡ã€‚</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3952490352.png"></p><pre class=" language-yaml"><code class="language-yaml">è¯¦ç»†è¯´æ˜PIDï¼šè¿›ç¨‹ID<span class="token directive important">%usrï¼šè¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´å ç”¨cpuçš„ç™¾åˆ†æ¯”</span><span class="token directive important">%systemï¼šè¿›ç¨‹åœ¨å†…æ ¸ç©ºé—´å ç”¨cpuçš„ç™¾åˆ†æ¯”</span><span class="token directive important">%guestï¼šè¿›ç¨‹åœ¨è™šæ‹Ÿæœºå ç”¨cpuçš„ç™¾åˆ†æ¯”</span><span class="token directive important">%CPUï¼šè¿›ç¨‹å ç”¨cpuçš„ç™¾åˆ†æ¯”</span>CPUï¼šå¤„ç†è¿›ç¨‹çš„cpuç¼–å·Commandï¼šå½“å‰è¿›ç¨‹å¯¹åº”çš„å‘½ä»¤</code></pre><hr><p><strong>ç¤ºä¾‹äºŒ:  cpuä½¿ç”¨æƒ…å†µç»Ÿè®¡(-u)</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">-</span>u</code></pre><p>ä½¿ç”¨-ué€‰é¡¹ï¼Œpidstatå°†æ˜¾ç¤ºå„æ´»åŠ¨è¿›ç¨‹çš„cpuä½¿ç”¨ç»Ÿè®¡ï¼Œæ‰§è¡Œâ€pidstat -uâ€ä¸å•ç‹¬æ‰§è¡Œâ€pidstatâ€çš„æ•ˆæœä¸€æ ·ã€‚</p><hr><p><strong>ç¤ºä¾‹ä¸‰ï¼š å†…å­˜ä½¿ç”¨æƒ…å†µç»Ÿè®¡(-r)</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">-</span>r</code></pre><p>ä½¿ç”¨-ré€‰é¡¹ï¼Œpidstatå°†æ˜¾ç¤ºå„æ´»åŠ¨è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨ç»Ÿè®¡ï¼š</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/822281650.png"></p><pre class=" language-yaml"><code class="language-yaml">PIDï¼šè¿›ç¨‹æ ‡è¯†ç¬¦Minflt/s<span class="token punctuation">:</span>ä»»åŠ¡æ¯ç§’å‘ç”Ÿçš„æ¬¡è¦é”™è¯¯ï¼Œä¸éœ€è¦ä»ç£ç›˜ä¸­åŠ è½½é¡µMajflt/s<span class="token punctuation">:</span>ä»»åŠ¡æ¯ç§’å‘ç”Ÿçš„ä¸»è¦é”™è¯¯ï¼Œéœ€è¦ä»ç£ç›˜ä¸­åŠ è½½é¡µVSZï¼šè™šæ‹Ÿåœ°å€å¤§å°ï¼Œè™šæ‹Ÿå†…å­˜çš„ä½¿ç”¨KBRSSï¼šå¸¸é©»é›†åˆå¤§å°ï¼Œéäº¤æ¢åŒºäº”é‡Œå†…å­˜ä½¿ç”¨KBCommandï¼štaskå‘½ä»¤å</code></pre><hr><p><strong>ç¤ºä¾‹å››ï¼šæ˜¾ç¤ºå„ä¸ªè¿›ç¨‹çš„IOä½¿ç”¨æƒ…å†µï¼ˆ-dï¼‰</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">-</span>d</code></pre><p>æŠ¥å‘ŠIOç»Ÿè®¡æ˜¾ç¤ºä»¥ä¸‹ä¿¡æ¯ï¼š<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/920875551.png"></p><pre class=" language-yaml"><code class="language-yaml">PIDï¼šè¿›ç¨‹idkB_rd/sï¼šæ¯ç§’ä»ç£ç›˜è¯»å–çš„KBkB_wr/sï¼šæ¯ç§’å†™å…¥ç£ç›˜KBkB_ccwr/sï¼šä»»åŠ¡å–æ¶ˆçš„å†™å…¥ç£ç›˜çš„KBã€‚å½“ä»»åŠ¡æˆªæ–­è„çš„pagecacheçš„æ—¶å€™ä¼šå‘ç”Ÿã€‚COMMAND<span class="token punctuation">:</span>taskçš„å‘½ä»¤å</code></pre><hr><p><strong>ç¤ºä¾‹äº”ï¼šæ˜¾ç¤ºæ¯ä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æƒ…å†µï¼ˆ-wï¼‰</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">-</span>w <span class="token punctuation">-</span>p 2503</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2038492984.png"></p><pre class=" language-yaml"><code class="language-yaml">PID<span class="token punctuation">:</span>è¿›ç¨‹idCswch/s<span class="token punctuation">:</span>æ¯ç§’ä¸»åŠ¨ä»»åŠ¡ä¸Šä¸‹æ–‡åˆ‡æ¢æ•°é‡Nvcswch/s<span class="token punctuation">:</span>æ¯ç§’è¢«åŠ¨ä»»åŠ¡ä¸Šä¸‹æ–‡åˆ‡æ¢æ•°é‡Command<span class="token punctuation">:</span>å‘½ä»¤å</code></pre><hr><p><strong>ç¤ºä¾‹å…­ï¼šæ˜¾ç¤ºé€‰æ‹©ä»»åŠ¡çš„çº¿ç¨‹çš„ç»Ÿè®¡ä¿¡æ¯å¤–çš„é¢å¤–ä¿¡æ¯ (-t)</strong></p><pre class=" language-yaml"><code class="language-yaml">pidstat <span class="token punctuation">-</span>t <span class="token punctuation">-</span>p 2503</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3915054774.png"></p><pre class=" language-yaml"><code class="language-yaml">TGID<span class="token punctuation">:</span>ä¸»çº¿ç¨‹çš„è¡¨ç¤ºTID<span class="token punctuation">:</span>çº¿ç¨‹id<span class="token directive important">%usrï¼šè¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´å ç”¨cpuçš„ç™¾åˆ†æ¯”</span><span class="token directive important">%systemï¼šè¿›ç¨‹åœ¨å†…æ ¸ç©ºé—´å ç”¨cpuçš„ç™¾åˆ†æ¯”</span><span class="token directive important">%guestï¼šè¿›ç¨‹åœ¨è™šæ‹Ÿæœºå ç”¨cpuçš„ç™¾åˆ†æ¯”</span><span class="token directive important">%CPUï¼šè¿›ç¨‹å ç”¨cpuçš„ç™¾åˆ†æ¯”</span>CPUï¼šå¤„ç†è¿›ç¨‹çš„cpuç¼–å·Commandï¼šå½“å‰è¿›ç¨‹å¯¹åº”çš„å‘½ä»¤</code></pre><p>å‚è€ƒ<a href="https://cloud.tencent.com/developer/article/1130004">https://cloud.tencent.com/developer/article/1130004</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å‹æµ‹å‘½ä»¤stressè¯¦è§£</title>
      <link href="/a32afd17/"/>
      <url>/a32afd17/</url>
      
        <content type="html"><![CDATA[<p><strong>1.å‘½ä»¤ä»‹ç»</strong><br>stressæ˜¯ä¸€ä¸ªlinuxç³»ç»Ÿå‹åŠ›æµ‹è¯•å·¥å…·ï¼Œé¡¾åæ€ä¹‰ä¸»è¦ç”¨æ¥è¿›è¡Œå‹åŠ›æµ‹è¯•ã€‚</p><hr><p><strong>2.å®‰è£…stress</strong></p><pre class=" language-vim"><code class="language-vim">yum <span class="token operator">-</span><span class="token keyword">y</span> install stress</code></pre><hr><p><strong>3.å‚æ•°è¯¦è§£</strong></p><pre class=" language-vim"><code class="language-vim"><span class="token operator">-</span><span class="token operator">?</span> æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯<span class="token operator">-</span>v æ˜¾ç¤ºç‰ˆæœ¬å·<span class="token operator">-</span><span class="token keyword">q</span> ä¸æ˜¾ç¤ºè¿è¡Œä¿¡æ¯<span class="token operator">-</span><span class="token keyword">n</span> æ˜¾ç¤ºå·²å®Œæˆçš„æŒ‡ä»¤æƒ…å†µ<span class="token operator">-</span><span class="token keyword">t</span> <span class="token operator">-</span><span class="token operator">-</span><span class="token builtin">timeout</span> <span class="token keyword">N</span> æŒ‡å®šè¿è¡Œ<span class="token keyword">N</span>ç§’ååœæ­¢   <span class="token operator">-</span><span class="token operator">-</span>backoff <span class="token keyword">N</span> ç­‰å¾…<span class="token keyword">N</span>å¾®å¦™åå¼€å§‹è¿è¡Œ<span class="token operator">-</span><span class="token keyword">c</span> äº§ç”Ÿ<span class="token keyword">n</span>ä¸ªè¿›ç¨‹ æ¯ä¸ªè¿›ç¨‹éƒ½åå¤ä¸åœçš„è®¡ç®—éšæœºæ•°çš„å¹³æ–¹æ ¹<span class="token operator">-</span>i äº§ç”Ÿ<span class="token keyword">n</span>ä¸ªè¿›ç¨‹ æ¯ä¸ªè¿›ç¨‹åå¤è°ƒç”¨<span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼Œ<span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ç”¨äºå°†å†…å­˜ä¸Šçš„å†…å®¹å†™åˆ°ç¡¬ç›˜ä¸Š<span class="token operator">-</span><span class="token keyword">m</span> <span class="token operator">-</span><span class="token operator">-</span>vm <span class="token keyword">n</span> äº§ç”Ÿ<span class="token keyword">n</span>ä¸ªè¿›ç¨‹<span class="token punctuation">,</span>æ¯ä¸ªè¿›ç¨‹ä¸æ–­è°ƒç”¨å†…å­˜åˆ†é…mallocå’Œå†…å­˜é‡Šæ”¾freeå‡½æ•°   <span class="token operator">-</span><span class="token operator">-</span>vm<span class="token operator">-</span>bytes B æŒ‡å®šmallocæ—¶å†…å­˜çš„å­—èŠ‚æ•° ï¼ˆé»˜è®¤256MBï¼‰   <span class="token operator">-</span><span class="token operator">-</span>vm<span class="token operator">-</span>hang <span class="token keyword">N</span> æŒ‡å®šåœ¨freeé’±çš„ç§’æ•°<span class="token operator">-</span><span class="token keyword">d</span> <span class="token operator">-</span><span class="token operator">-</span>hadd <span class="token keyword">n</span> äº§ç”Ÿ<span class="token keyword">n</span>ä¸ªæ‰§è¡Œ<span class="token keyword">write</span>å’Œunlinkå‡½æ•°çš„è¿›ç¨‹   <span class="token operator">-</span>hadd<span class="token operator">-</span>bytes B æŒ‡å®šå†™çš„å­—èŠ‚æ•°   <span class="token operator">-</span><span class="token operator">-</span>hadd<span class="token operator">-</span>noclean ä¸unlink</code></pre><blockquote><p>æ—¶é—´å•ä½å¯ä»¥ä¸ºç§’sï¼Œåˆ†mï¼Œå°æ—¶hï¼Œå¤©dï¼Œå¹´yï¼Œæ–‡ä»¶å¤§å°å•ä½å¯ä»¥ä¸ºKï¼ŒMï¼ŒG</p></blockquote><hr><p><strong>4.å‘½ä»¤ç¤ºèŒƒ</strong></p><p><strong>ï¼ˆ1ï¼‰ ä½¿ç”¨-cé€‰é¡¹å¯¹cpuè¿›è¡Œå‹æµ‹</strong></p><pre class=" language-vim"><code class="language-vim">stress <span class="token operator">-</span><span class="token keyword">c</span> <span class="token number">1</span> <span class="token operator">-</span><span class="token keyword">t</span> <span class="token number">100</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3334698846.png"></p><p>ä½¿ç”¨mpstatå’Œpidstatå‘½ä»¤å¯ä»¥çœ‹åˆ°æ­¤æ—¶cpuä½¿ç”¨ç‡ä¸º100%<br>mpstat -P ALL 5<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1584319245.png"></p><hr><p><strong>ï¼ˆ2ï¼‰ ä½¿ç”¨-ié€‰é¡¹å¯¹ioè¿›è¡Œå‹æµ‹</strong></p><blockquote><p>æ³¨æ„syncï¼ˆï¼‰æ˜¯å°†å†…å­˜ç¼“å†²åŒºä¸­çš„æ•°æ®ç«‹å³å†™å…¥ç£ç›˜ä¸­ï¼Œå¯¹äºæ–°å»ºçš„è™šæ‹Ÿæœºç¼“å†²åŒºå†…æœ¬æ¥å°±æ²¡å¤šå°‘æ•°æ®ï¼Œé‚£å†™åˆ°ç£ç›˜ä¸­çš„æ•°æ®ä¹Ÿå°±ä¸å¤šï¼Œä¹Ÿå°±æ²¡æ³•äº§ç”Ÿ<br>I&#x2F;O<br>å‹åŠ›ã€‚è¿™æ ·å¤§éƒ¨åˆ†å°±éƒ½æ˜¯ç³»ç»Ÿè°ƒç”¨çš„æ¶ˆè€—äº†ï¼Œå¯ä»¥çœ‹åˆ°%iowaitåªæœ‰0.1%ï¼Œè€Œ%systemå´æœ‰98%ï¼ˆ%systemï¼šè¡¨ç¤ºå†…æ ¸è¿›ç¨‹æ‰€ä½¿ç”¨cpuçš„ç™¾åˆ†æ¯”ï¼›%iowaitè¡¨ç¤ºç­‰å¾…IOæ‰€ä½¿ç”¨cpuçš„ç™¾åˆ†æ¯”ï¼‰</p></blockquote><pre class=" language-vim"><code class="language-vim">stress <span class="token operator">-</span>i <span class="token number">1</span> <span class="token operator">-</span><span class="token keyword">t</span> <span class="token number">600</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1310550567.png"></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3950618545.png"></p><p>å¯¹äºè¿™ç§æƒ…å†µæˆ‘ä»¬è¦å»æµ‹IOï¼Œå¯ä»¥ä½¿ç”¨-dé€‰é¡¹ã€‚å†æ¬¡æŸ¥çœ‹å‘ç°iowait å·²ç»é£™ä¸Šæ¥äº†</p><pre class=" language-vim"><code class="language-vim">stress <span class="token operator">-</span><span class="token keyword">d</span> <span class="token number">1</span> <span class="token operator">-</span><span class="token operator">-</span>hdd<span class="token operator">-</span>bytes 1024G</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2646425403.png"></p><hr><p><strong>ï¼ˆ3ï¼‰ ä½¿ç”¨-mé€‰é¡¹å¯¹å†…å­˜è¿›è¡Œå‹æµ‹</strong></p><pre class=" language-vim"><code class="language-vim">stress <span class="token operator">-</span><span class="token keyword">m</span> <span class="token number">1</span> <span class="token operator">-</span><span class="token operator">-</span>vm<span class="token operator">-</span>bytes 1G <span class="token operator">-</span><span class="token operator">-</span>vm<span class="token operator">-</span>hang <span class="token number">10</span>pidstat <span class="token operator">-</span>C <span class="token string">"stress"</span>  <span class="token operator">-</span><span class="token keyword">p</span> ALL <span class="token operator">-</span><span class="token keyword">r</span> <span class="token number">2</span> <span class="token number">1</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2006229297.png"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxå†…æ ¸ä¼˜åŒ–å‚æ•°</title>
      <link href="/d9f22803/"/>
      <url>/d9f22803/</url>
      
        <content type="html"><![CDATA[<pre class=" language-vim"><code class="language-vim"><span class="token builtin">fs</span><span class="token operator">.</span><span class="token keyword">file</span><span class="token operator">-</span>max <span class="token operator">=</span> <span class="token number">999999</span>ï¼šè¿™ä¸ªå‚æ•°è¡¨ç¤ºè¿›ç¨‹ï¼ˆæ¯”å¦‚ä¸€ä¸ªworkerè¿›ç¨‹ï¼‰å¯ä»¥åŒæ—¶æ‰“å¼€çš„æœ€å¤§å¥æŸ„æ•°ï¼Œè¿™ä¸ªå‚æ•°ç›´çº¿é™åˆ¶æœ€å¤§å¹¶å‘è¿æ¥æ•°ï¼Œéœ€æ ¹æ®å®é™…æƒ…å†µé…ç½®ã€‚net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_max_tw_buckets <span class="token operator">=</span> <span class="token number">6000</span> #è¿™ä¸ªå‚æ•°è¡¨ç¤ºæ“ä½œç³»ç»Ÿå…è®¸TIME_WAITå¥—æ¥å­—æ•°é‡çš„æœ€å¤§å€¼ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼ŒTIME_WAITå¥—æ¥å­—å°†ç«‹åˆ»è¢«æ¸…é™¤å¹¶æ‰“å°è­¦å‘Šä¿¡æ¯ã€‚è¯¥å‚æ•°é»˜è®¤ä¸º<span class="token number">180000</span>ï¼Œè¿‡å¤šçš„TIME_WAITå¥—æ¥å­—ä¼šä½¿WebæœåŠ¡å™¨å˜æ…¢ã€‚</code></pre><blockquote><p>æ³¨ï¼šä¸»åŠ¨å…³é—­è¿æ¥çš„æœåŠ¡ç«¯ä¼šäº§ç”ŸTIME_WAITçŠ¶æ€çš„è¿æ¥</p></blockquote><pre class=" language-vim"><code class="language-vim">net<span class="token operator">.</span>ipv4<span class="token operator">.</span>ip_local_port_range <span class="token operator">=</span> <span class="token number">1024</span> <span class="token number">65000</span> #å…è®¸ç³»ç»Ÿæ‰“å¼€çš„ç«¯å£èŒƒå›´ã€‚net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_tw_recycle <span class="token operator">=</span> <span class="token number">1</span> #å¯ç”¨timewaitå¿«é€Ÿå›æ”¶ã€‚net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_tw_reuse <span class="token operator">=</span> <span class="token number">1</span> #å¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME<span class="token operator">-</span>WAIT</code></pre><blockquote><p>socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ã€‚è¿™å¯¹äºæœåŠ¡å™¨æ¥è¯´å¾ˆæœ‰æ„ä¹‰ï¼Œå› ä¸ºæœåŠ¡å™¨ä¸Šæ€»ä¼šæœ‰å¤§é‡TIME-WAITçŠ¶æ€çš„è¿æ¥ã€‚</p></blockquote><pre class=" language-vim"><code class="language-vim">net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_keepalive_time <span class="token operator">=</span> <span class="token number">30</span>ï¼šè¿™ä¸ªå‚æ•°è¡¨ç¤ºå½“keepaliveå¯ç”¨æ—¶ï¼ŒTCPå‘é€keepaliveæ¶ˆæ¯çš„é¢‘åº¦ã€‚é»˜è®¤æ˜¯<span class="token number">2</span>å°æ—¶ï¼Œè‹¥å°†å…¶è®¾ç½®çš„å°ä¸€äº›ï¼Œå¯ä»¥æ›´å¿«åœ°æ¸…ç†æ— æ•ˆçš„è¿æ¥ã€‚net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_syncookies <span class="token operator">=</span> <span class="token number">1</span> #å¼€å¯SYN Cookiesï¼Œå½“å‡ºç°SYNç­‰å¾…é˜Ÿåˆ—æº¢å‡ºæ—¶ï¼Œå¯ç”¨cookiesæ¥å¤„ç†ã€‚net<span class="token operator">.</span>core<span class="token operator">.</span>somaxconn <span class="token operator">=</span> <span class="token number">40960</span> #web åº”ç”¨ä¸­ listen å‡½æ•°çš„ backlog é»˜è®¤ä¼šç»™æˆ‘ä»¬å†…æ ¸å‚æ•°çš„ net<span class="token operator">.</span>core<span class="token operator">.</span>somaxconn é™åˆ¶åˆ°<span class="token number">128</span>ï¼Œè€Œnginxå®šä¹‰çš„NGX_LISTEN_BACKLOG é»˜è®¤ä¸º<span class="token number">511</span>ï¼Œæ‰€ä»¥æœ‰å¿…è¦è°ƒæ•´è¿™ä¸ªå€¼ã€‚</code></pre><blockquote><p>æ³¨ï¼šå¯¹äºä¸€ä¸ªTCPè¿æ¥ï¼ŒServerä¸Clientéœ€è¦é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹æ¥å»ºç«‹ç½‘ç»œè¿æ¥.å½“ä¸‰æ¬¡æ¡æ‰‹æˆåŠŸå,æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç«¯å£çš„çŠ¶æ€ç”±LISTENè½¬å˜ä¸ºESTABLISHED,æ¥ç€è¿™æ¡é“¾è·¯ä¸Šå°±å¯ä»¥å¼€å§‹ä¼ é€æ•°æ®äº†.æ¯ä¸€ä¸ªå¤„äºç›‘å¬(Listen)çŠ¶æ€çš„ç«¯å£,éƒ½æœ‰è‡ªå·±çš„ç›‘å¬é˜Ÿåˆ—.ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦ä¸å¦‚somaxconnå‚æ•°å’Œä½¿ç”¨è¯¥ç«¯å£çš„ç¨‹åºä¸­listen()å‡½æ•°æœ‰å…³</p><p>somaxconn å‚æ•°:å®šä¹‰äº†ç³»ç»Ÿä¸­æ¯ä¸€ä¸ªç«¯å£æœ€å¤§çš„ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦,è¿™æ˜¯ä¸ªå…¨å±€çš„å‚æ•°,é»˜è®¤å€¼ä¸º128ï¼Œå¯¹äºä¸€ä¸ªç»å¸¸å¤„ç†æ–°è¿æ¥çš„é«˜è´Ÿè½½<br>webæœåŠ¡ç¯å¢ƒæ¥è¯´ï¼Œé»˜è®¤çš„ 128 å¤ªå°äº†ã€‚å¤§å¤šæ•°ç¯å¢ƒè¿™ä¸ªå€¼å»ºè®®å¢åŠ åˆ° 1024 æˆ–è€…æ›´å¤šã€‚å¤§çš„ä¾¦å¬é˜Ÿåˆ—å¯¹é˜²æ­¢æ‹’ç»æœåŠ¡ DoS<br>æ”»å‡»ä¹Ÿä¼šæœ‰æ‰€å¸®åŠ©ã€‚</p></blockquote><pre class=" language-vim"><code class="language-vim">net<span class="token operator">.</span>core<span class="token operator">.</span>netdev_max_backlog <span class="token operator">=</span> <span class="token number">262144</span> <span class="token punctuation">:</span>#æ¯ä¸ªç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…çš„é€Ÿç‡æ¯”å†…æ ¸å¤„ç†è¿™äº›åŒ…çš„é€Ÿç‡å¿«æ—¶ï¼Œå…è®¸é€åˆ°é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›®ã€‚net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_max_syn_backlog <span class="token operator">=</span> <span class="token number">262144</span><span class="token punctuation">:</span>#è¿™ä¸ªå‚æ•°æ ‡ç¤ºTCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹é˜¶æ®µæ¥å—SYNè¯·æ±‚é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼Œé»˜è®¤ä¸º<span class="token number">1024</span>ï¼Œå°†å…¶è®¾ç½®å¾—å¤§ä¸€äº›å¯ä»¥ä½¿å‡ºç°Nginxç¹å¿™æ¥ä¸åŠacceptæ–°è¿æ¥çš„æƒ…å†µæ—¶ï¼ŒLinuxä¸è‡³äºä¸¢å¤±å®¢æˆ·ç«¯å‘èµ·çš„è¿æ¥è¯·æ±‚ã€‚net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_rmem <span class="token operator">=</span> <span class="token number">10240</span>  <span class="token number">87380</span>  <span class="token number">12582912</span><span class="token punctuation">:</span>#è¿™ä¸ªå‚æ•°å®šä¹‰äº†TCPæ¥å—ç¼“å­˜ï¼ˆç”¨äºTCPæ¥å—æ»‘åŠ¨çª—å£ï¼‰çš„æœ€å°å€¼ã€é»˜è®¤å€¼ã€æœ€å¤§å€¼ã€‚net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_wmem <span class="token operator">=</span> <span class="token number">10240</span> <span class="token number">87380</span> <span class="token number">12582912</span>ï¼šè¿™ä¸ªå‚æ•°å®šä¹‰äº†TCPå‘é€ç¼“å­˜ï¼ˆç”¨äºTCPå‘é€æ»‘åŠ¨çª—å£ï¼‰çš„æœ€å°å€¼ã€é»˜è®¤å€¼ã€æœ€å¤§å€¼ã€‚net<span class="token operator">.</span>core<span class="token operator">.</span>rmem_default <span class="token operator">=</span> <span class="token number">6291456</span>ï¼šè¿™ä¸ªå‚æ•°è¡¨ç¤ºå†…æ ¸å¥—æ¥å­—æ¥å—ç¼“å­˜åŒºé»˜è®¤çš„å¤§å°ã€‚net<span class="token operator">.</span>core<span class="token operator">.</span>wmem_default <span class="token operator">=</span> <span class="token number">6291456</span>ï¼šè¿™ä¸ªå‚æ•°è¡¨ç¤ºå†…æ ¸å¥—æ¥å­—å‘é€ç¼“å­˜åŒºé»˜è®¤çš„å¤§å°ã€‚net<span class="token operator">.</span>core<span class="token operator">.</span>rmem_max <span class="token operator">=</span> <span class="token number">12582912</span>ï¼šè¿™ä¸ªå‚æ•°è¡¨ç¤ºå†…æ ¸å¥—æ¥å­—æ¥å—ç¼“å­˜åŒºçš„æœ€å¤§å¤§å°ã€‚net<span class="token operator">.</span>core<span class="token operator">.</span>wmem_max <span class="token operator">=</span> <span class="token number">12582912</span>ï¼šè¿™ä¸ªå‚æ•°è¡¨ç¤ºå†…æ ¸å¥—æ¥å­—å‘é€ç¼“å­˜åŒºçš„æœ€å¤§å¤§å°ã€‚net<span class="token operator">.</span>ipv4<span class="token operator">.</span>tcp_syncookies <span class="token operator">=</span> <span class="token number">1</span>ï¼šè¯¥å‚æ•°ä¸æ€§èƒ½æ— å…³ï¼Œç”¨äºè§£å†³TCPçš„SYNæ”»å‡»ã€‚</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨IPerf3å¯¹å¸¦å®½è¿›è¡Œæµ‹é€Ÿ</title>
      <link href="/9958581e/"/>
      <url>/9958581e/</url>
      
        <content type="html"><![CDATA[<p>1.ç®€ä»‹<br>ã€€iperf3æ˜¯ä¸€ä¸ªç½‘ç»œé€Ÿåº¦æµ‹è¯•å·¥å…·ï¼Œæ”¯æŒIPv4ä¸IPv6ï¼Œæ”¯æŒTCPã€UDPã€SCTPä¼ è¾“åè®®ï¼Œå¯åœ¨Windowsã€Mac OS Xã€Linuxã€FreeBSDç­‰å„ç§å¹³å°ä½¿ç”¨ï¼Œæ˜¯ä¸€ä¸ªç®€å•åˆå®ç”¨çš„å°å·¥å…·ã€‚å› æˆ‘å·²é…ç½®å¥½yumæºï¼Œå› æ­¤æ‰§è¡Œyum install iperf3å³å¯å®‰è£…</p><hr><p>2.å¸¸ç”¨å‚æ•°</p><pre class=" language-vim"><code class="language-vim"><span class="token operator">-</span>s æœåŠ¡å™¨æ¨¡å¼ä¸‹è¿è¡Œ<span class="token operator">-</span><span class="token keyword">c</span>  åœ¨å®¢æˆ·ç«¯æ¨¡å¼ä¸‹è¿è¡Œï¼Œè¿æ¥åˆ°çš„ä¸»æœºipã€‚å¦‚æœIperfè¿è¡Œåœ¨æœåŠ¡å™¨æ¨¡å¼ï¼Œå¹¶ä¸”ç”¨<span class="token operator">-</span><span class="token keyword">c</span>å‚æ•°æŒ‡å®šä¸€ä¸ªä¸»æœºï¼Œé‚£ä¹ˆIperfå°†åªæ¥å—æŒ‡å®šä¸»æœºçš„è¿æ¥ã€‚æ­¤å‚æ•°ä¸èƒ½å·¥ä½œäºUDPæ¨¡å¼<span class="token operator">-</span><span class="token keyword">u</span> ä½¿ç”¨UDPè€Œä¸æ˜¯TCP<span class="token operator">-</span><span class="token keyword">b</span> ç›®æ ‡å¸¦å®½ ä»¥ä½<span class="token operator">/</span>ç§’ä¸ºå•ä½ã€‚UDPæ¨¡å¼ä½¿ç”¨çš„å¸¦å®½ï¼Œå•ä½bits<span class="token operator">/</span>secã€‚æ­¤é€‰é¡¹ä¸<span class="token operator">-</span><span class="token keyword">u</span>é€‰é¡¹ç›¸å…³ã€‚é»˜è®¤å€¼æ˜¯<span class="token number">1</span> Mbit<span class="token operator">/</span>sec<span class="token operator">-</span><span class="token keyword">n</span> è¦ä¼ è¾“çš„å­—èŠ‚æ•° M<span class="token operator">-</span><span class="token number">4</span> ä½¿ç”¨ipv4<span class="token operator">-</span><span class="token number">6</span> ä½¿ç”¨ipv6<span class="token operator">-</span><span class="token keyword">p</span> æŒ‡å®šç«¯å£</code></pre><hr><p>3.ä½¿ç”¨æ–¹æ³•</p><pre class=" language-vim"><code class="language-vim">æœåŠ¡å™¨iperf3 <span class="token operator">-</span>s</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/917389051.png"></p><pre class=" language-vim"><code class="language-vim">å®¢æˆ·ç«¯ iperf3 <span class="token operator">-</span><span class="token keyword">c</span> <span class="token number">172.10</span><span class="token operator">.</span><span class="token number">0.2</span> <span class="token operator">-</span><span class="token keyword">b</span> 50M <span class="token operator">-</span><span class="token keyword">n</span> 200M</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4069506333.png"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux è·¯ç”±é…ç½®</title>
      <link href="/1d5f327f/"/>
      <url>/1d5f327f/</url>
      
        <content type="html"><![CDATA[<p>ä¸€ã€å‘½ä»¤æ ¼å¼</p><pre class=" language-vim"><code class="language-vim">route <span class="token punctuation">[</span><span class="token operator">-</span><span class="token keyword">f</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token keyword">p</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>Command <span class="token punctuation">[</span>Destination<span class="token punctuation">]</span> <span class="token punctuation">[</span>mask Netmask<span class="token punctuation">]</span> <span class="token punctuation">[</span>Gateway<span class="token punctuation">]</span> <span class="token punctuation">[</span>metric Metric<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token keyword">if</span> Interface<span class="token punctuation">]</span><span class="token punctuation">]</span></code></pre><hr><p>äºŒã€å‘½ä»¤å‚æ•°</p><pre class=" language-vim"><code class="language-vim"><span class="token operator">-</span><span class="token keyword">c</span> æ˜¾ç¤ºæ›´å¤šä¿¡æ¯<span class="token operator">-</span><span class="token keyword">n</span> ä¸è§£æåå­—<span class="token operator">-</span>v æ˜¾ç¤ºè¯¦ç»†çš„å¤„ç†ä¿¡æ¯<span class="token operator">-</span>F æ˜¾ç¤ºå‘é€ä¿¡æ¯<span class="token operator">-</span>C æ˜¾ç¤ºè·¯ç”±ç¼“å­˜<span class="token operator">-</span><span class="token keyword">f</span> æ¸…é™¤æ‰€æœ‰ç½‘å…³å…¥å£çš„è·¯ç”±è¡¨ã€‚ <span class="token operator">-</span><span class="token keyword">p</span> ä¸ add å‘½ä»¤ä¸€èµ·ä½¿ç”¨æ—¶ä½¿è·¯ç”±å…·æœ‰æ°¸ä¹…æ€§ã€‚add<span class="token punctuation">:</span>æ·»åŠ ä¸€æ¡æ–°è·¯ç”±ã€‚del<span class="token punctuation">:</span>åˆ é™¤ä¸€æ¡è·¯ç”±ã€‚<span class="token operator">-</span>net<span class="token punctuation">:</span>ç›®æ ‡åœ°å€æ˜¯ä¸€ä¸ªç½‘ç»œã€‚<span class="token operator">-</span>host<span class="token punctuation">:</span>ç›®æ ‡åœ°å€æ˜¯ä¸€ä¸ªä¸»æœºã€‚netmask<span class="token punctuation">:</span>å½“æ·»åŠ ä¸€ä¸ªç½‘ç»œè·¯ç”±æ—¶ï¼Œéœ€è¦ä½¿ç”¨ç½‘ç»œæ©ç ã€‚gw<span class="token punctuation">:</span>è·¯ç”±æ•°æ®åŒ…é€šè¿‡ç½‘å…³ã€‚æ³¨æ„ï¼Œä½ æŒ‡å®šçš„ç½‘å…³å¿…é¡»èƒ½å¤Ÿè¾¾åˆ°ã€‚metricï¼šè®¾ç½®è·¯ç”±è·³æ•°ã€‚Command <span class="token punctuation">:</span>æŒ‡å®šæ‚¨æƒ³è¿è¡Œçš„å‘½ä»¤ <span class="token punctuation">(</span>Add<span class="token operator">/</span>Change<span class="token operator">/</span>Delete<span class="token operator">/</span><span class="token keyword">Print</span><span class="token punctuation">)</span>ã€‚ Destination<span class="token punctuation">:</span> æŒ‡å®šè¯¥è·¯ç”±çš„ç½‘ç»œç›®æ ‡ã€‚ mask Netmask<span class="token punctuation">:</span> æŒ‡å®šä¸ç½‘ç»œç›®æ ‡ç›¸å…³çš„ç½‘ç»œæ©ç ï¼ˆä¹Ÿè¢«ç§°ä½œå­ç½‘æ©ç ï¼‰ã€‚ Gateway<span class="token punctuation">:</span> æŒ‡å®šç½‘ç»œç›®æ ‡å®šä¹‰çš„åœ°å€é›†å’Œå­ç½‘æ©ç å¯ä»¥åˆ°è¾¾çš„å‰è¿›æˆ–ä¸‹ä¸€è·ƒç‚¹ IP åœ°å€ã€‚ metric Metric<span class="token punctuation">:</span> ä¸ºè·¯ç”±æŒ‡å®šä¸€ä¸ªæ•´æ•°æˆæœ¬å€¼æ ‡ï¼ˆä» <span class="token number">1</span> è‡³ <span class="token number">9999</span>ï¼‰ï¼Œå½“åœ¨è·¯ç”±è¡¨<span class="token punctuation">(</span>ä¸è½¬å‘çš„æ•°æ®åŒ…ç›®æ ‡åœ°å€æœ€åŒ¹é…<span class="token punctuation">)</span>çš„å¤šä¸ªè·¯ç”±ä¸­è¿›è¡Œé€‰æ‹©æ—¶å¯ä»¥ä½¿ç”¨ã€‚ <span class="token keyword">if</span> Interface<span class="token punctuation">:</span> ä¸ºå¯ä»¥è®¿é—®ç›®æ ‡çš„æ¥å£æŒ‡å®šæ¥å£ç´¢å¼•ã€‚è‹¥è¦è·å¾—ä¸€ä¸ªæ¥å£åˆ—è¡¨å’Œå®ƒä»¬ç›¸åº”çš„æ¥å£ç´¢å¼•ï¼Œä½¿ç”¨ route <span class="token keyword">print</span> å‘½ä»¤çš„æ˜¾ç¤ºåŠŸèƒ½ã€‚å¯ä»¥ä½¿ç”¨åè¿›åˆ¶æˆ–åå…­è¿›åˆ¶å€¼è¿›è¡Œæ¥å£ç´¢å¼•ã€‚</code></pre><hr><p>ä¸‰ã€å‚è€ƒæ¡ˆä¾‹</p><p>1.æ˜¾ç¤ºè·¯ç”±</p><p>route -n<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/240257448.png"></p><p>æ³¨ï¼šFlagsæ ‡å¿—è¯´æ˜ï¼š</p><pre class=" language-vim"><code class="language-vim">U Upè¡¨ç¤ºæ­¤è·¯ç”±å½“å‰ä¸ºå¯åŠ¨çŠ¶æ€H Hostï¼Œè¡¨ç¤ºæ­¤ç½‘å…³ä¸ºä¸€ä¸»æœºG Gatewayï¼Œè¡¨ç¤ºæ­¤ç½‘å…³ä¸ºä¸€è·¯ç”±å™¨R Reinstate Routeï¼Œä½¿ç”¨åŠ¨æ€è·¯ç”±é‡æ–°åˆå§‹åŒ–çš„è·¯ç”±D Dynamically<span class="token punctuation">,</span>æ­¤è·¯ç”±æ˜¯åŠ¨æ€æ€§åœ°å†™å…¥M Modifiedï¼Œæ­¤è·¯ç”±æ˜¯ç”±è·¯ç”±å®ˆæŠ¤ç¨‹åºæˆ–å¯¼å‘å™¨åŠ¨æ€ä¿®æ”¹<span class="token operator">!</span> è¡¨ç¤ºæ­¤è·¯ç”±å½“å‰ä¸ºå…³é—­çŠ¶æ€</code></pre><p>2.æ·»åŠ ç½‘å…³</p><pre class=" language-vim"><code class="language-vim">route add <span class="token operator">-</span>net <span class="token number">224.0</span><span class="token operator">.</span><span class="token number">0.0</span> netmask <span class="token number">240.0</span><span class="token operator">.</span><span class="token number">0.0</span> dev eth0</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1356161704.png"></p><p>3.å±è”½ä¸€æ¡è·¯ç”±</p><pre class=" language-vim"><code class="language-vim">route add <span class="token operator">-</span>net <span class="token number">224.0</span><span class="token operator">.</span><span class="token number">0.0</span> netmask <span class="token number">240.0</span><span class="token operator">.</span><span class="token number">0.0</span> reject</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/113431270.png"></p><p>4.åˆ é™¤è·¯ç”±</p><pre class=" language-vim"><code class="language-vim">route del <span class="token operator">-</span>net <span class="token number">224.0</span><span class="token operator">.</span><span class="token number">0.0</span> netmask <span class="token number">240.0</span><span class="token operator">.</span><span class="token number">0.0</span>route del <span class="token operator">-</span>net <span class="token number">224.0</span><span class="token operator">.</span><span class="token number">0.0</span> netmask <span class="token number">240.0</span><span class="token operator">.</span><span class="token number">0.0</span> reject</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3890504857.png"></p><p>5.æ·»åŠ é»˜è®¤ç½‘å…³</p><pre class=" language-vim"><code class="language-vim">route add default gw <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">0.11</span>route del default gw <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">120.240</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/506673885.png"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxé€šè¿‡topæŸ¥çœ‹cpu&amp;å†…å­˜ä½¿ç”¨æœ€é«˜çš„è¿›ç¨‹</title>
      <link href="/880aa2df/"/>
      <url>/880aa2df/</url>
      
        <content type="html"><![CDATA[<p>å‰è¨€ï¼šä»Šæ—¥ç¢°åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå®¢æˆ·åé¦ˆæ¯æ—¥å‡Œæ™¨3ç‚¹æœåŠ¡å™¨çš„å†…å­˜éƒ½ä¼šé£™å‡ï¼Œä½†æ˜¯ä¹Ÿæ²¡æœ‰å®šæ—¶ä»»åŠ¡ï¼Œæ™šä¸Šä¹Ÿæ²¡æœ‰æ•°æ®å¤‡ä»½ï¼Œæ‰€ä»¥æƒ³è¦é€šè¿‡è„šæœ¬ç›‘æ§ä¸‹å…·ä½“æ˜¯ä»€ä¹ˆè¿›ç¨‹å¯¼è‡´çš„ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨çš„å‘½ä»¤æ˜¯</p><pre class=" language-vim"><code class="language-vim"><span class="token builtin">top</span> <span class="token operator">-</span><span class="token keyword">bn</span> <span class="token number">1</span> <span class="token operator">-</span>i <span class="token operator">-</span><span class="token keyword">c</span></code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼š<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2626793770.png"></p><p>ä½†æ˜¯è¾“å…¥å‰é¢çš„ä¿¡æ¯éƒ½ä¸æ˜¯æˆ‘ä»¬éœ€è¦çš„æ‰€ä»¥éœ€è¦awkç­›é€‰ä¸‹ï¼Œå‘½ä»¤å¦‚ä¸‹</p><pre class=" language-vim"><code class="language-vim"><span class="token builtin">top</span> <span class="token operator">-</span><span class="token keyword">bn</span> <span class="token number">1</span> <span class="token operator">-</span>i <span class="token operator">-</span><span class="token keyword">c</span> |awk <span class="token string">'{ if (NR > 6) print }'</span></code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼š<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3801311281.png"></p><p>æœ€åé€šè¿‡awkç­›é€‰éœ€è¦çš„ä¿¡æ¯å³å¯ï¼Œå‘½ä»¤å¦‚ä¸‹</p><pre class=" language-vim"><code class="language-vim"><span class="token builtin">top</span> <span class="token operator">-</span><span class="token keyword">bn</span> <span class="token number">1</span> <span class="token operator">-</span>i <span class="token operator">-</span><span class="token keyword">c</span> |awk <span class="token string">'{ if (NR > 6) print }'</span> |awk <span class="token string">'{ if ($9 > 0.1) print $1,$9,$12}'</span></code></pre><p>è¾“å‡ºå¦‚ä¸‹ï¼š<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1943897181.png"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Iptables è¯¦è§£</title>
      <link href="/1972c4d3/"/>
      <url>/1972c4d3/</url>
      
        <content type="html"><![CDATA[<p>ä¸€ã€IPtablesç®€ä»‹<br>IPtablesçš„è¡¨ï¼Œé“¾ç»“æ„</p><p>è§„åˆ™é“¾</p><p>è§„åˆ™çš„ä½œç”¨ï¼šå¯¹æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤å¤„ç†</p><p>é“¾çš„ä½œç”¨ï¼šå®¹çº³å„ç§é˜²ç«å¢™è§„åˆ™</p><p>é“¾çš„åˆ†ç±»ä¾æ®ï¼šå¤„ç†æ•°æ®åŒ…çš„ä¸åŒæ—¶æœº</p><p>é»˜è®¤åŒ…æ‹¬5ä¸­è§„åˆ™é“¾</p><p>INPUTï¼šå¤„ç†å…¥ç«™æ•°æ®åŒ…</p><p>OUTPUTï¼šå¤„ç†å‡ºç«™æ•°æ®åŒ…</p><p>FORWARDï¼šå¤„ç†è½¬å‘æ•°æ®åŒ…</p><p>POSTROUTINGï¼šåœ¨è¿›è¡Œè·¯ç”±é€‰æ‹©åå¤„ç†æ•°æ®åŒ…</p><p>PREROUTINGï¼šåœ¨è¿›è¡Œè·¯ç”±é€‰æ‹©å‰å¤„ç†æ•°æ®åŒ…</p><p>è§„åˆ™è¡¨</p><p>è¡¨çš„ä½œç”¨ï¼šå®¹çº³å„ç§è§„åˆ™é“¾</p><p>è¡¨çš„åˆ’åˆ†ä¾æ®ï¼šé˜²ç«å¢™è§„åˆ™çš„ä½œç”¨ç›¸ä¼¼</p><p>é»˜è®¤çš„4ä¸ªè§„åˆ™è¡¨</p><p>rawè¡¨ï¼šç¡®å®šæ˜¯å¦å¯¹æ•°æ®åŒ…è¿›è¡Œè·Ÿè¸ª</p><p>mangleè¡¨ï¼šä¸ºæ•°æ®åŒ…è®¾ç½®æ ‡è®°</p><p>natè¡¨ï¼šä¿®æ”¹æ•°æ®åŒ…çš„æºï¼Œç›®æ ‡IPåœ°å€æˆ–ç«¯å£</p><p>filterè¡¨ï¼šç¡®å®šæ˜¯å¦æ”¾è¡Œè¯¥æ•°æ®åŒ…ï¼ˆè¿‡æ»¤ï¼‰</p><hr><p>äºŒã€å‚æ•°è¯¦è§£</p><pre class=" language-vim"><code class="language-vim"><span class="token operator">-</span>F æ¸…ç©ºè§„åˆ™é“¾ iptables <span class="token operator">-</span>F<span class="token operator">-</span>L æŸ¥çœ‹è§„åˆ™é“¾ iptables <span class="token operator">-</span>L<span class="token operator">-</span>A è¿½åŠ è§„åˆ™ iptables <span class="token operator">-</span>A INPUT<span class="token operator">-</span>D åˆ é™¤è§„åˆ™ iptables <span class="token operator">-</span>D INPUT <span class="token number">1</span><span class="token operator">-</span>R ä¿®æ”¹è§„åˆ™ iptable <span class="token operator">-</span>R INPUT <span class="token number">1</span> <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">120.0</span> <span class="token operator">-</span><span class="token keyword">j</span> DROP<span class="token operator">-</span>I åœ¨å¤´éƒ¨æ’å…¥è§„åˆ™ iptables <span class="token operator">-</span>I INPUT <span class="token number">1</span> <span class="token operator">-</span><span class="token operator">-</span>dport <span class="token number">80</span> <span class="token operator">-</span><span class="token keyword">j</span> ACCEPT<span class="token operator">-</span>L æŸ¥çœ‹è§„åˆ™ iptables <span class="token operator">-</span>L INPUT<span class="token operator">-</span><span class="token keyword">N</span> æ–°çš„è§„åˆ™ iptables <span class="token operator">-</span><span class="token keyword">N</span> allowed<span class="token operator">-</span>V æŸ¥çœ‹iptablesç‰ˆæœ¬ iptables <span class="token operator">-</span>V<span class="token operator">-</span><span class="token keyword">p</span> åè®®ï¼ˆtcp<span class="token operator">/</span>udp<span class="token operator">/</span>icmpï¼‰ iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span><span class="token keyword">p</span> tcp<span class="token operator">-</span>s åŒ¹é…åŸåœ°å€ï¼ŒåŠ <span class="token string">" ! "</span>è¡¨ç¤ºé™¤è¿™ä¸ªIPå¤– iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">1.1</span><span class="token operator">-</span><span class="token keyword">d</span> åŒ¹é…ç›®çš„åœ°å€ iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span><span class="token keyword">d</span> <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">12.1</span><span class="token operator">-</span><span class="token operator">-</span>sport åŒ¹é…æºç«¯å£æµå…¥çš„æ•°æ® iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span><span class="token keyword">p</span> tcp <span class="token operator">-</span><span class="token operator">-</span>sport <span class="token number">22</span><span class="token operator">-</span><span class="token operator">-</span>dport åŒ¹é…ç›®çš„ç«¯å£æµå‡ºçš„æ•°æ® iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span><span class="token keyword">p</span> tcp <span class="token operator">-</span><span class="token operator">-</span>dport <span class="token number">22</span><span class="token operator">-</span>i åŒ¹é…å…¥å£ç½‘å¡æµå…¥çš„æ•°æ® iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span>i eth0<span class="token operator">-</span><span class="token keyword">o</span> åŒ¹é…å‡ºå£ç½‘å¡æµå‡ºçš„æ•°æ® iptables <span class="token operator">-</span>A FORWARD <span class="token operator">-</span><span class="token keyword">o</span> eth0<span class="token operator">-</span><span class="token keyword">j</span> è¦è¿›è¡Œçš„å¤„ç†åŠ¨ä½œ<span class="token punctuation">:</span><span class="token function">DROP</span><span class="token punctuation">(</span>ä¸¢å¼ƒ<span class="token punctuation">)</span>ï¼Œ<span class="token function">REJECT</span><span class="token punctuation">(</span>æ‹’ç»<span class="token punctuation">)</span>ï¼Œ<span class="token function">ACCEPT</span><span class="token punctuation">(</span>æ¥å—<span class="token punctuation">)</span>ï¼Œ<span class="token function">SANT</span><span class="token punctuation">(</span>åŸºäºåŸåœ°å€çš„è½¬æ¢<span class="token punctuation">)</span> iptable <span class="token operator">-</span>A INPUT <span class="token number">1</span> <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">120.0</span> <span class="token operator">-</span><span class="token keyword">j</span> DROP<span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span><span class="token keyword">source</span> æŒ‡å®šSANTè½¬æ¢åçš„åœ°å€ iptables <span class="token operator">-</span><span class="token keyword">t</span> nat <span class="token operator">-</span>A POSTROUTING <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">10.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">-</span><span class="token keyword">j</span> SANT <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span><span class="token keyword">source</span> <span class="token number">172.16</span><span class="token operator">.</span><span class="token number">100.1</span><span class="token operator">-</span><span class="token keyword">t</span> è¡¨å<span class="token punctuation">(</span>rawã€mangleã€natã€filter<span class="token punctuation">)</span> iptables <span class="token operator">-</span><span class="token keyword">t</span> nat<span class="token operator">-</span><span class="token keyword">m</span> ä½¿ç”¨æ‰©å±•æ¨¡å—æ¥è¿›è¡Œæ•°æ®åŒ…çš„åŒ¹é…<span class="token punctuation">(</span>multiport<span class="token operator">/</span>tcp<span class="token operator">/</span>state<span class="token operator">/</span>addrtype<span class="token punctuation">)</span> iptables <span class="token operator">-</span><span class="token keyword">m</span> multiport</code></pre><hr><p>ä¸‰ã€æ¡ˆä¾‹å‚è€ƒ</p><p>åœ¨é“¾çš„æœ«å°¾è¿½åŠ ä¸€æ¡è§„åˆ™</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span>A INPUT <span class="token operator">-</span><span class="token keyword">p</span> tcp <span class="token operator">-</span><span class="token keyword">j</span> ACCEPT</code></pre><p>åœ¨é“¾çš„å¼€å¤´(æˆ–æŒ‡å®šåºå·)æ’å…¥ä¸€æ¡è§„åˆ™</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span>I INPUT <span class="token number">2</span> <span class="token operator">-</span><span class="token keyword">p</span> icmp <span class="token operator">-</span><span class="token keyword">j</span> ACCEPT</code></pre><p>åˆ é™¤é“¾å†…æŒ‡å®šåºå·ï¼ˆæˆ–å†…å®¹ï¼‰çš„ä¸€æ¡è§„åˆ™</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span>D INPUT <span class="token number">3</span></code></pre><p>æ¸…ç©ºæ‰€æœ‰è§„åˆ™</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span>F</code></pre><p>SNATæºåœ°å€è½¬æ¢</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span><span class="token keyword">t</span> nat <span class="token operator">-</span>A POSTROUTING <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">-</span><span class="token keyword">o</span> eth0 <span class="token operator">-</span><span class="token keyword">j</span> SNAT <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span><span class="token keyword">source</span> <span class="token number">218.29</span><span class="token operator">.</span><span class="token number">30.31</span></code></pre><p>MASQUERADE åœ°å€ä¼ªè£…</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span><span class="token keyword">t</span> nat <span class="token operator">-</span>A POSTROUTING <span class="token operator">-</span>s <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token number">24</span> <span class="token operator">-</span><span class="token keyword">o</span> eth0 <span class="token operator">-</span><span class="token keyword">j</span> MASQUERADE</code></pre><p>DNATç›®æ ‡åœ°å€è½¬æ¢</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span><span class="token keyword">t</span> nat <span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>i eth0 <span class="token operator">-</span><span class="token keyword">d</span> <span class="token number">218.29</span><span class="token operator">.</span><span class="token number">30.31</span> <span class="token operator">-</span><span class="token keyword">p</span> tcp <span class="token operator">-</span><span class="token operator">-</span>dport <span class="token number">80</span> <span class="token operator">-</span><span class="token keyword">j</span> DNAT <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span>destination <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">1.6</span></code></pre><p>ä¿®æ”¹ç«¯å£è½¬æ¢</p><pre class=" language-vim"><code class="language-vim">iptables <span class="token operator">-</span><span class="token keyword">t</span> nat <span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>i eth0 <span class="token operator">-</span><span class="token keyword">d</span> <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">11.11</span> <span class="token operator">-</span><span class="token keyword">p</span> tcp <span class="token operator">-</span><span class="token operator">-</span>dport <span class="token number">2346</span> <span class="token operator">-</span><span class="token keyword">j</span> DNAT <span class="token operator">-</span><span class="token operator">-</span><span class="token keyword">to</span><span class="token operator">-</span>destination <span class="token number">192.168</span><span class="token operator">.</span><span class="token number">1.11</span><span class="token punctuation">:</span><span class="token number">22</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8såŸºç¡€å‘½ä»¤</title>
      <link href="/d25065dc/"/>
      <url>/d25065dc/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€kubectl-åŸºæœ¬å‘½ä»¤"><a href="#ä¸€ã€kubectl-åŸºæœ¬å‘½ä»¤" class="headerlink" title="ä¸€ã€kubectl åŸºæœ¬å‘½ä»¤"></a>ä¸€ã€kubectl åŸºæœ¬å‘½ä»¤</h1><p><strong>kubectl get</strong><br>æŸ¥çœ‹podèŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯</p><pre class=" language-xml"><code class="language-xml">kubectl get pods -o wide</code></pre><p>æŸ¥çœ‹deploy</p><pre class=" language-yaml"><code class="language-yaml">kubectl get deploy</code></pre><p>æŸ¥çœ‹service</p><pre class=" language-vim"><code class="language-vim">kubectl get svc</code></pre><hr><p><strong>kubectl create</strong></p><p>åˆ›å»ºpodå¹¶æŒ‡å®šdeploy</p><pre class=" language-vim"><code class="language-vim">kubectl create deploy nginx <span class="token operator">-</span><span class="token operator">-</span>image<span class="token operator">=</span>nginx</code></pre><p>åˆ›å»ºpodå¹¶æŒ‡å®šdeploy å’Œå‰¯æœ¬æ•°é‡ä¸º3</p><pre class=" language-vim"><code class="language-vim">kubectl create deployment my<span class="token operator">-</span>dep <span class="token operator">-</span><span class="token operator">-</span>image<span class="token operator">=</span>nginx <span class="token operator">-</span><span class="token operator">-</span>replicas<span class="token operator">=</span><span class="token number">3</span></code></pre><p>åˆ›å»ºpodå¹¶æŒ‡å®šdeploy å’Œå‰¯æœ¬æ•°é‡ä¸º3 å¼€æ”¾80ç«¯å£</p><pre class=" language-vim"><code class="language-vim">kubectl create deployment my<span class="token operator">-</span>dep <span class="token operator">-</span><span class="token operator">-</span>image<span class="token operator">=</span>nginx <span class="token operator">-</span><span class="token operator">-</span>replicas<span class="token operator">=</span><span class="token number">3</span> <span class="token operator">-</span><span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">80</span></code></pre><p>æ¨¡æ‹Ÿåˆ›å»ºpodï¼Œå¹¶è¾“å‡ºyamlæ–‡ä»¶åˆ°deploy.yamlï¼ˆä¸çœŸæ­£åˆ›å»ºï¼Œåªæ˜¯å‘apiserveræäº¤è¯·æ±‚ï¼‰</p><pre class=" language-docker"><code class="language-docker">kubectl create deployment my<span class="token punctuation">-</span>dep <span class="token punctuation">-</span><span class="token punctuation">-</span>image=nginx <span class="token punctuation">-</span><span class="token punctuation">-</span>replicas=3 <span class="token punctuation">-</span><span class="token punctuation">-</span>port=80 <span class="token punctuation">-</span><span class="token punctuation">-</span>dry<span class="token punctuation">-</span>run=client <span class="token punctuation">-</span>o yaml <span class="token punctuation">></span> deploy.yaml</code></pre><hr><p><strong>kubectl describe</strong><br>æŸ¥çœ‹podè¯¦ç»†ä¿¡æ¯</p><pre class=" language-vim"><code class="language-vim">kubectl describe pod nginx<span class="token operator">-</span>6799fc88d8<span class="token operator">-</span>hr8bg</code></pre><p>æŸ¥çœ‹è°ƒåº¦å™¨è¯¦ç»†ä¿¡æ¯</p><pre class=" language-vim"><code class="language-vim">kubectl describe deploy nginx</code></pre><p>æŸ¥çœ‹serviceè¯¦ç»†ä¿¡æ¯</p><pre class=" language-vim"><code class="language-vim">kubectl describe svc nginx</code></pre><hr><p><strong>kubectl logs</strong><br>æŸ¥çœ‹podæ—¥å¿—</p><pre class=" language-vim"><code class="language-vim">kubectl logs nginx<span class="token operator">-</span>6799fc88d8<span class="token operator">-</span>hr8bg</code></pre><p>æŸ¥çœ‹æ—¥å¿—å¹¶æŒ‡å®šns</p><pre class=" language-vim"><code class="language-vim">kubectl logs nginx<span class="token operator">-</span>6799fc88d8<span class="token operator">-</span>hr8bg <span class="token operator">-</span><span class="token keyword">n</span> default</code></pre><p>åŠ¨æ€è¾“å‡ºæ—¥å¿—</p><pre class=" language-vim"><code class="language-vim">kubectl logs <span class="token operator">-</span><span class="token keyword">f</span> nginx<span class="token operator">-</span>6799fc88d8<span class="token operator">-</span>hr8bg</code></pre><hr><p><strong>kubectl expose</strong><br>æ˜ å°„podç«¯å£</p><pre class=" language-docker"><code class="language-docker">kubectl expose deployment springboot<span class="token punctuation">-</span>k8s <span class="token punctuation">-</span><span class="token punctuation">-</span>port=8080</code></pre><p>æ˜ å°„podç«¯å£ï¼Œå¹¶æŒ‡å®šæ¨¡å¼ä¸ºNodePort</p><pre class=" language-vim"><code class="language-vim">kubectl expose deployment springboot<span class="token operator">-</span>k8s<span class="token operator">-</span><span class="token operator">-</span>port<span class="token operator">=</span><span class="token number">8080</span> <span class="token operator">-</span><span class="token operator">-</span>type<span class="token operator">=</span>NodePort</code></pre><hr><p><strong>kubectl scale</strong><br>ä¿®æ”¹podçš„å‰¯æœ¬æ•°é‡</p><pre class=" language-docker"><code class="language-docker">kubectl scale <span class="token punctuation">-</span><span class="token punctuation">-</span>replicas=5 deploy myapp</code></pre><hr><p><strong>kubectl set image</strong><br>podçš„åŠ¨æ€æ›´æ–°</p><pre class=" language-docker"><code class="language-docker">kubectl set image deploy myapp myapp=ikubernetes/myapp<span class="token punctuation">:</span>v2kubectl rollout status deploy myapp</code></pre><hr><p><strong>kubectl rollout</strong><br>podçš„åŠ¨æ€å›æ»š</p><pre class=" language-docker"><code class="language-docker">kubectl rollout undo deploy myapp</code></pre><hr><p><strong>configmap</strong><br>é€šè¿‡from-literalæŒ‡å®šé…ç½®é¡¹</p><pre class=" language-yaml"><code class="language-yaml">kubectl create configmap nginx<span class="token punctuation">-</span>config <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>literal=nginx_port=80 <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>literal=server_name=myapp.magedu.com</code></pre><p>é€šè¿‡from-fileæŒ‡å®šé…ç½®æ–‡ä»¶</p><pre class=" language-yaml"><code class="language-yaml">kubectl create configmap nginx_www <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>file=./www.conf</code></pre><hr><p><strong>secret</strong><br>æŒ‡å®šmysqlçš„ç™»é™†å¯†ç ï¼ˆsecreté»˜è®¤ä¼šè¿›è¡Œç¼–ç ï¼‰</p><pre class=" language-yaml"><code class="language-yaml">kubectl creare secret generic mysql<span class="token punctuation">-</span>root<span class="token punctuation">-</span>password <span class="token punctuation">-</span><span class="token punctuation">-</span>frome<span class="token punctuation">-</span>literal=password=123456</code></pre><hr><p><strong>explain</strong><br>æŸ¥çœ‹podæ¸…å•åˆ—è¡¨</p><pre class=" language-yaml"><code class="language-yaml">kubectl explain pod.spec</code></pre><hr><p><strong>autoscale</strong><br>å¯¹delpoyè¿›è¡ŒåŠ¨æ€ä¼¸ç¼©</p><pre class=" language-yaml"><code class="language-yaml">kubectl autoscale deployment myapp <span class="token punctuation">-</span><span class="token punctuation">-</span>min=1 <span class="token punctuation">-</span><span class="token punctuation">-</span>max=8 <span class="token punctuation">-</span><span class="token punctuation">-</span>cpu<span class="token punctuation">-</span>percent=60</code></pre><p><strong>K8sé›†ç¾¤é»˜è®¤svcè®¿é—®åŸŸå</strong></p><pre class=" language-docker"><code class="language-docker"><span class="token comment" spellcheck="true">#ç¤ºä¾‹</span>mysvc.myns.svc.cluster.localbash<span class="token punctuation">-</span>4.2<span class="token comment" spellcheck="true"># curl -vo /dev/null http://wiz.wiz.svc.cluster.local</span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current                                 Dload  Upload   Total   Spent    Left  Speed  0     0    0     0    0     0      0      0 <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span>     0* About to connect() to wiz.wiz.svc.cluster.local port 80 (<span class="token comment" spellcheck="true">#0)</span>*   Trying 10.101.24.253<span class="token punctuation">...</span>* Connected to wiz.wiz.svc.cluster.local (10.101.24.253) port 80 (<span class="token comment" spellcheck="true">#0)</span><span class="token punctuation">></span> GET / HTTP/1.1<span class="token punctuation">></span> User<span class="token punctuation">-</span>Agent<span class="token punctuation">:</span> curl/7.29.0<span class="token punctuation">></span> Host<span class="token punctuation">:</span> wiz.wiz.svc.cluster.local<span class="token punctuation">></span> Accept<span class="token punctuation">:</span> */*<span class="token punctuation">></span>&lt; HTTP/1.1 200 OK&lt; Server<span class="token punctuation">:</span> nginx/1.20.1&lt; Date<span class="token punctuation">:</span> Tue<span class="token punctuation">,</span> 02 Nov 2021 08<span class="token punctuation">:</span>43<span class="token punctuation">:</span>37 GMT&lt; Content<span class="token punctuation">-</span>Type<span class="token punctuation">:</span> text/html; charset=utf<span class="token punctuation">-</span>8&lt; Content<span class="token punctuation">-</span>Length<span class="token punctuation">:</span> 2986&lt; Connection<span class="token punctuation">:</span> keep<span class="token punctuation">-</span>alive&lt; Vary<span class="token punctuation">:</span> Accept<span class="token punctuation">-</span>Encoding&lt; Last<span class="token punctuation">-</span>Modified<span class="token punctuation">:</span> Fri<span class="token punctuation">,</span> 15 Oct 2021 04<span class="token punctuation">:</span>13<span class="token punctuation">:</span>04 GMT&lt; Cache<span class="token punctuation">-</span>Control<span class="token punctuation">:</span> max<span class="token punctuation">-</span>age=0&lt;<span class="token punctuation">{</span> <span class="token punctuation">[</span>data not shown<span class="token punctuation">]</span>100  2986  100  2986    0     0   374k      0 <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">:</span><span class="token punctuation">-</span><span class="token punctuation">-</span>  416k* Connection <span class="token comment" spellcheck="true">#0 to host wiz.wiz.svc.cluster.local left intact</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlèµ‹äºˆrootè¶…çº§ç”¨æˆ·æƒé™</title>
      <link href="/bccd58e4/"/>
      <url>/bccd58e4/</url>
      
        <content type="html"><![CDATA[<pre class=" language-yaml"><code class="language-yaml">update mysql.user set Super_priv='Y' where User='root';flush privileges;</code></pre><blockquote><p>æ³¨æ„æƒé™æ›´æ–°å®Œæˆéœ€è¦é€€å‡ºsessioné‡æ–°è¿æ¥ï¼Œå¦åˆ™è¿˜ä¼šæä¾›æ²¡æœ‰æƒé™</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Databases </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlå¸¸ç”¨SQL</title>
      <link href="/ce3ad0fe/"/>
      <url>/ce3ad0fe/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰"><a href="#ä¸€ã€DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰" class="headerlink" title="ä¸€ã€DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰"></a>ä¸€ã€DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰</h1><h3 id="1-1-Create"><a href="#1-1-Create" class="headerlink" title="1.1 Create"></a>1.1 Create</h3><h2 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#åˆ›å»ºæ•°æ®åº“huhuhahei</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> huhuhahei<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#åˆ›å»ºæ•°æ®åº“å¹¶æŒ‡å®šå±æ€§</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> huhuhahei1 <span class="token keyword">charset</span> utf8<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><h2 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#åˆ›å»ºstudentè¡¨</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>student<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>sno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å­¦å·'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>sname<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å­¦ç”Ÿå§“å'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>sage<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å­¦ç”Ÿå¹´é¾„'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>ssex<span class="token punctuation">`</span> <span class="token keyword">enum</span><span class="token punctuation">(</span><span class="token string">'ç”·'</span><span class="token punctuation">,</span><span class="token string">'å¥³'</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'ç”·'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>sbirthday<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>class<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>sno<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token comment" spellcheck="true">#åˆ›å»ºcourseè¡¨</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>course<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>cno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è¯¾ç¨‹å·'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>cname<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è¯¾ç¨‹åç§°'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è¯¾ç¨‹ç¼–å·'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>cno<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token comment" spellcheck="true">#åˆ›å»ºscoreè¡¨</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>score<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>sno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å­¦å·'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>cno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è¯¾ç¨‹å·'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>mark<span class="token punctuation">`</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æˆç»©'</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token comment" spellcheck="true">#åˆ›å»ºteacherè¡¨</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>teacher<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>tno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ•™å¸ˆç¼–å·'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tname<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ•™å¸ˆåç§°'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tage<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ•™å¸ˆå¹´é¾„'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tsex<span class="token punctuation">`</span> <span class="token keyword">enum</span><span class="token punctuation">(</span><span class="token string">'ç”·'</span><span class="token punctuation">,</span><span class="token string">'å¥³'</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'ç”·'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ•™å¸ˆæ€§åˆ«'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>prof<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">'null'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ•™å¸ˆèŒç§°'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>depart<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ•™å¸ˆéƒ¨é—¨'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tno<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8</code></pre><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#æŸ¥çœ‹è¡¨ç»“æ„</span>mysql<span class="token operator">></span> <span class="token keyword">desc</span> score<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+------------+------+-----+---------+-------+</span><span class="token operator">|</span> Field <span class="token operator">|</span> <span class="token keyword">Type</span>       <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> <span class="token keyword">Key</span> <span class="token operator">|</span> <span class="token keyword">Default</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+------------+------+-----+---------+-------+</span><span class="token operator">|</span> sno   <span class="token operator">|</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>    <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span><span class="token operator">|</span> cno   <span class="token operator">|</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>    <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span><span class="token operator">|</span> mark  <span class="token operator">|</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+------------+------+-----+---------+-------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><blockquote><p>æ•°æ®ç±»å‹</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#æ•°æ®ç±»å‹</span><span class="token keyword">int</span>ï¼š æ•´æ•° <span class="token operator">-</span><span class="token number">231</span> <span class="token operator">~</span> <span class="token number">231</span> <span class="token operator">-</span><span class="token number">1</span><span class="token keyword">varchar</span>ï¼šå­—ç¬¦ç±»å‹ ï¼ˆå˜é•¿ï¼‰charï¼š å­—ç¬¦ç±»å‹ ï¼ˆå®šé•¿ï¼‰<span class="token keyword">tinyint</span>ï¼š æ•´æ•° <span class="token operator">-</span><span class="token number">128</span> <span class="token operator">~</span> <span class="token number">128</span><span class="token keyword">enum</span>ï¼š æšä¸¾ç±»å‹<span class="token keyword">datetime</span>ï¼š æ—¶é—´ç±»å‹ å¹´æœˆæ—¥æ—¶åˆ†ç§’<span class="token comment" spellcheck="true">#æ•°æ®å±æ€§</span><span class="token operator">not</span> <span class="token boolean">null</span>ï¼š éç©º<span class="token keyword">primary</span> <span class="token keyword">key</span>ï¼š ä¸»é”®ï¼ˆå”¯ä¸€ä¸”éç©ºçš„ï¼‰<span class="token keyword">auto_increment</span>ï¼š è‡ªå¢ï¼ˆæ­¤åˆ—å¿…é¡»æ˜¯ï¼š<span class="token keyword">primary</span> <span class="token keyword">key</span>æˆ–è€…<span class="token keyword">unique</span> <span class="token keyword">key</span>ï¼‰<span class="token keyword">unique</span> <span class="token keyword">key</span>ï¼š å•ç‹¬çš„å”¯ä¸€çš„<span class="token keyword">default</span>ï¼š é»˜è®¤å€¼unsignedï¼š éè´Ÿæ•°<span class="token keyword">comment</span>ï¼š æ³¨é‡Š</code></pre><h3 id="1-2-Drop"><a href="#1-2-Drop" class="headerlink" title="1.2 Drop"></a>1.2 Drop</h3><h2 id="Database-1"><a href="#Database-1" class="headerlink" title="Database"></a>Database</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#åˆ é™¤æ•°æ®åº“</span>mysql<span class="token operator">></span> <span class="token keyword">drop</span> <span class="token keyword">database</span> huhuhahei<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span></code></pre><h2 id="Table-1"><a href="#Table-1" class="headerlink" title="Table"></a>Table</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#åˆ é™¤è¡¨</span>mysql<span class="token operator">></span> <span class="token keyword">drop</span> <span class="token keyword">table</span> test<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span></code></pre><h3 id="1-3-Alter"><a href="#1-3-Alter" class="headerlink" title="1.3 Alter"></a>1.3 Alter</h3><h2 id="Database-2"><a href="#Database-2" class="headerlink" title="Database"></a>Database</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#ä¿®æ”¹æ•°æ®å±æ€§</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">database</span> huhuhahei1 <span class="token keyword">charset</span> gbk<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><h2 id="Table-2"><a href="#Table-2" class="headerlink" title="Table"></a>Table</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#ä¿®æ”¹è¡¨å</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">rename</span> test2<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æ·»åŠ åˆ—</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">add</span> age <span class="token keyword">int</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#æ·»åŠ å¤šä¸ªåˆ—</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">add</span> test <span class="token keyword">int</span> <span class="token punctuation">,</span><span class="token keyword">add</span> test2 <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#æ·»åŠ åˆ—åˆ°è¡¨é¦–</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">add</span> <span class="token number">aaaa</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">first</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#æ·»åŠ åˆ—åˆ°æŒ‡å®šä½ç½®</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">add</span> <span class="token number">bbb</span> <span class="token keyword">int</span> <span class="token keyword">after</span> age<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#åˆ é™¤åˆ—</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">drop</span> <span class="token number">bbb</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#ä¿®æ”¹åˆ—çš„å±æ€§</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 <span class="token keyword">modify</span> <span class="token number">aaaa</span> <span class="token keyword">int</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#ä¿®æ”¹åˆ—æ˜å’Œå±æ€§</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test2 change <span class="token number">aaaa</span> <span class="token number">aaa</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#ä¿®æ”¹æ•°æ®åº“å­—ç¬¦é›†</span><span class="token keyword">alter</span> <span class="token keyword">database</span> oldboy <span class="token keyword">CHARACTER SET</span> utf8 <span class="token keyword">collate</span> utf8_general_ci<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#ä¿®æ”¹è¡¨å­—ç¬¦é›†</span><span class="token keyword">alter</span> <span class="token keyword">table</span> t1 <span class="token keyword">CHARACTER SET</span> utf8<span class="token punctuation">;</span></code></pre><hr><h1 id="äºŒã€DCLï¼ˆæ•°æ®æ§åˆ¶è¯­è¨€ï¼‰"><a href="#äºŒã€DCLï¼ˆæ•°æ®æ§åˆ¶è¯­è¨€ï¼‰" class="headerlink" title="äºŒã€DCLï¼ˆæ•°æ®æ§åˆ¶è¯­è¨€ï¼‰"></a>äºŒã€DCLï¼ˆæ•°æ®æ§åˆ¶è¯­è¨€ï¼‰</h1><h3 id="2-1-Grant"><a href="#2-1-Grant" class="headerlink" title="2.1 Grant"></a>2.1 Grant</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#åˆ›å»ºtest@127.0.0.1ç”¨æˆ·å¹¶æˆäºˆæ‰€æœ‰æƒé™ï¼ˆéè¶…çº§ç®¡ç†å‘˜ï¼‰</span>mysql<span class="token operator">></span> <span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> test@'<span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token string">' identified by '</span><span class="token number">123</span>'<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#åˆ›å»ºç”¨æˆ·ç»™æˆæƒä¸ºè¶…çº§ç®¡ç†å‘˜</span>mysql<span class="token operator">></span> <span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> test@'<span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token string">' identified by '</span><span class="token number">123</span>' <span class="token keyword">with</span> <span class="token keyword">grant</span> <span class="token keyword">option</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æˆäºˆç”¨æˆ·å•åˆ—æƒé™</span>mysql<span class="token operator">></span> <span class="token keyword">grant</span> <span class="token keyword">select</span><span class="token punctuation">(</span>sno<span class="token punctuation">)</span> <span class="token keyword">on</span> huhuhahei<span class="token punctuation">.</span>score <span class="token keyword">to</span> test11<span class="token variable">@localhost</span> identified <span class="token keyword">by</span> <span class="token string">'123'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æ‰©å±•æƒé™</span>max_queries_per_hourï¼šä¸€ä¸ªç”¨æˆ·æ¯å°æ—¶å¯å‘å‡ºçš„æŸ¥è¯¢æ•°é‡ max_updates_per_hourï¼šä¸€ä¸ªç”¨æˆ·æ¯å°æ—¶å¯å‘å‡ºçš„æ›´æ–°æ•°é‡ max_connetions_per_hourï¼šä¸€ä¸ªç”¨æˆ·æ¯å°æ—¶å¯è¿æ¥åˆ°æœåŠ¡å™¨çš„æ¬¡æ•° max_user_connetionsï¼šå…è®¸åŒæ—¶è¿æ¥æ•°é‡</code></pre><h3 id="2-2-Revoke"><a href="#2-2-Revoke" class="headerlink" title="2.2 Revoke"></a>2.2 Revoke</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#æ”¶å›selectæƒé™</span>mysql<span class="token operator">></span> <span class="token keyword">revoke</span> <span class="token keyword">select</span> <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token variable">@'127.0.0.1'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="ä¸‰ã€DMLï¼ˆæ•°æ®æ“ä½œè¯­è¨€ï¼‰"><a href="#ä¸‰ã€DMLï¼ˆæ•°æ®æ“ä½œè¯­è¨€ï¼‰" class="headerlink" title="ä¸‰ã€DMLï¼ˆæ•°æ®æ“ä½œè¯­è¨€ï¼‰"></a>ä¸‰ã€DMLï¼ˆæ•°æ®æ“ä½œè¯­è¨€ï¼‰</h1><h3 id="3-1-Insert"><a href="#3-1-Insert" class="headerlink" title="3.1 Insert"></a>3.1 Insert</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#æ’å…¥æ•°æ®</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> student<span class="token punctuation">(</span>sno<span class="token punctuation">,</span>sname<span class="token punctuation">,</span>sage<span class="token punctuation">,</span>class<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'å¾å¯¼'</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'æ›¾å¯¼'</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'æå¯¼'</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span></code></pre><h3 id="3-2-Update"><a href="#3-2-Update" class="headerlink" title="3.2 Update"></a>3.2 Update</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#æ›´æ–°æ•°æ®</span>mysql<span class="token operator">></span> <span class="token keyword">update</span> student <span class="token keyword">set</span> sage<span class="token operator">=</span><span class="token string">'100'</span> <span class="token keyword">where</span> sno<span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#å…¨è¡¨æ›´æ–°ï¼ˆ::(ç‹—å¤´)æ…ç”¨ï¼‰</span>mysql<span class="token operator">></span> <span class="token keyword">update</span> student <span class="token keyword">set</span> sage<span class="token operator">=</span><span class="token string">'100'</span> <span class="token keyword">where</span> <span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">3</span>  Changed: <span class="token number">2</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span></code></pre><h3 id="3-3-Delete"><a href="#3-3-Delete" class="headerlink" title="3.3 Delete"></a>3.3 Delete</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#åˆ é™¤æŒ‡å®šæ•°æ®</span>mysql<span class="token operator">></span> <span class="token keyword">delete</span> <span class="token keyword">from</span> test2 <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#åˆ é™¤è¡¨:@(åèˆŒ)</span>mysql<span class="token operator">></span> <span class="token keyword">truncate</span> <span class="token keyword">table</span> test2<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><blockquote><p>ä½¿ç”¨updateä»£æ›¿deleteå®ç°ä¼ªåˆ é™¤</p></blockquote><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#åˆ›å»ºçŠ¶æ€åˆ—</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student <span class="token keyword">add</span> <span class="token keyword">status</span> <span class="token keyword">enum</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#æ›´æ–°ç›®å‰æ‰€æœ‰åˆ—</span>mysql<span class="token operator">></span> <span class="token keyword">update</span> student <span class="token keyword">set</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">3</span>  Changed: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#æ ¹æ®çŠ¶æ€åˆ—æŸ¥è¯¢</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token keyword">status</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----+--------+------+------+---------------------+-------+--------+</span><span class="token operator">|</span> sno <span class="token operator">|</span> sname  <span class="token operator">|</span> sage <span class="token operator">|</span> ssex <span class="token operator">|</span> sbirthday           <span class="token operator">|</span> class <span class="token operator">|</span> <span class="token keyword">status</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----+--------+------+------+---------------------+-------+--------+</span><span class="token operator">|</span>   <span class="token number">1</span> <span class="token operator">|</span> å¾å¯¼   <span class="token operator">|</span>  <span class="token number">100</span> <span class="token operator">|</span> ç”·   <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span>:<span class="token number">19</span>:<span class="token number">51</span> <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">2</span> <span class="token operator">|</span> æ›¾å¯¼   <span class="token operator">|</span>  <span class="token number">100</span> <span class="token operator">|</span> ç”·   <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span>:<span class="token number">19</span>:<span class="token number">51</span> <span class="token operator">|</span>     <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">3</span> <span class="token operator">|</span> æå¯¼   <span class="token operator">|</span>  <span class="token number">100</span> <span class="token operator">|</span> ç”·   <span class="token operator">|</span> <span class="token number">2021</span><span class="token operator">-</span><span class="token number">10</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">17</span>:<span class="token number">19</span>:<span class="token number">51</span> <span class="token operator">|</span>     <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1</span>      <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----+--------+------+------+---------------------+-------+--------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><h1 id="å››ã€DQLï¼ˆæ•°æ®æŸ¥è¯¢è¯­å¥ï¼‰"><a href="#å››ã€DQLï¼ˆæ•°æ®æŸ¥è¯¢è¯­å¥ï¼‰" class="headerlink" title="å››ã€DQLï¼ˆæ•°æ®æŸ¥è¯¢è¯­å¥ï¼‰"></a>å››ã€DQLï¼ˆæ•°æ®æŸ¥è¯¢è¯­å¥ï¼‰</h1><h3 id="4-1-Select"><a href="#4-1-Select" class="headerlink" title="4.1 Select"></a>4.1 Select</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#ç®€å•æŸ¥è¯¢</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> countrycode<span class="token punctuation">,</span>name <span class="token keyword">from</span> city<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#è¡Œçº§æŸ¥è¯¢</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> countrycode<span class="token punctuation">,</span>name <span class="token keyword">from</span> city <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">;</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> countrycode<span class="token punctuation">,</span>name <span class="token keyword">from</span> city <span class="token keyword">limit</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#æ¡ä»¶æŸ¥è¯¢</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>population<span class="token punctuation">,</span>district <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#å¤šæ¡ä»¶æŸ¥è¯¢</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>population <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span> <span class="token operator">and</span> district<span class="token operator">=</span><span class="token string">'Shandong'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#æ¨¡ç³ŠæŸ¥è¯¢</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>population <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span> <span class="token operator">and</span> district<span class="token operator">=</span><span class="token string">'heilongjiang'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#æ’åºæŸ¥è¯¢</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>population<span class="token punctuation">,</span>countrycode <span class="token keyword">from</span> city <span class="token keyword">order</span> <span class="token keyword">by</span> countrycode <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#å€’åºæŸ¥è¯¢</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>population<span class="token punctuation">,</span>countrycode <span class="token keyword">from</span> city <span class="token keyword">order</span> <span class="token keyword">by</span> countrycode <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#èŒƒå›´æŸ¥è¯¢</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> population<span class="token operator">>=</span><span class="token number">1410000</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#ORè¯­å¥ä½¿ç”¨</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span> <span class="token operator">or</span> countrycode<span class="token operator">=</span><span class="token string">'USA'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#INè¯­å¥ä½¿ç”¨</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'CHN'</span><span class="token punctuation">,</span><span class="token string">'USA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#select union all å®ç°orç”¨æ³•</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">union</span> <span class="token keyword">all</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'USA'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#union å®ç°inç”¨æ³•</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">union</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'USA'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#æŸ¥è¯¢è¡¨çš„è¡Œæ•°</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> world<span class="token punctuation">.</span>city<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#å»é‡</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token keyword">distinct</span> countrycode<span class="token punctuation">)</span> <span class="token keyword">from</span> world<span class="token punctuation">.</span>city<span class="token punctuation">;</span></code></pre><h2 id="Selecté«˜çº§ç”¨æ³•"><a href="#Selecté«˜çº§ç”¨æ³•" class="headerlink" title="Selecté«˜çº§ç”¨æ³•"></a>Selecté«˜çº§ç”¨æ³•</h2><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#ä¼ ç»Ÿè¿æ¥æŸ¥è¯¢</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> country<span class="token punctuation">.</span>name<span class="token punctuation">,</span>countrylanguage<span class="token punctuation">.</span>language<span class="token punctuation">,</span>city<span class="token punctuation">.</span>name<span class="token punctuation">,</span>country<span class="token punctuation">.</span>population    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">from</span> city<span class="token punctuation">,</span>country<span class="token punctuation">,</span>countrylanguage    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">where</span> countrylanguage<span class="token punctuation">.</span>countrycode<span class="token operator">=</span>country<span class="token punctuation">.</span>code    <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">and</span> city<span class="token punctuation">.</span>countrycode<span class="token operator">=</span>country<span class="token punctuation">.</span>code    <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">and</span> country<span class="token punctuation">.</span>population<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+-------------+-----------+------------+</span><span class="token operator">|</span> name     <span class="token operator">|</span> language    <span class="token operator">|</span> name      <span class="token operator">|</span> population <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+-------------+-----------+------------+</span><span class="token operator">|</span> Pitcairn <span class="token operator">|</span> Pitcairnese <span class="token operator">|</span> Adamstown <span class="token operator">|</span>         <span class="token number">50</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+-------------+-----------+------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#natural joinæŸ¥è¯¢ï¼ˆè‡ªè¿æ¥çš„è¡¨ä¸­æœ‰å…±åŒçš„åˆ—åç§°ï¼‰</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> city<span class="token punctuation">.</span>name<span class="token punctuation">,</span>countrylanguage<span class="token punctuation">.</span>language<span class="token punctuation">,</span>city<span class="token punctuation">.</span>countrycode    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">from</span> city <span class="token keyword">natural</span> <span class="token keyword">join</span> countrylanguage    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">where</span> population <span class="token operator">=</span> <span class="token number">2352121</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+------------+-------------+</span><span class="token operator">|</span> name      <span class="token operator">|</span> language   <span class="token operator">|</span> countrycode <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+------------+-------------+</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Afrikaans  <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> English    <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Ndebele    <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Northsotho <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Southsotho <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Swazi      <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Tsonga     <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Tswana     <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Venda      <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Xhosa      <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">|</span> Cape Town <span class="token operator">|</span> Zulu       <span class="token operator">|</span> ZAF         <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+------------+-------------+</span><span class="token number">11</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#å†…è¿æ¥join onï¼ˆå°è¡¨é©±åŠ¨å¤§è¡¨ï¼‰</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> city<span class="token punctuation">.</span>name<span class="token punctuation">,</span>city<span class="token punctuation">.</span>countrycode<span class="token punctuation">,</span>country<span class="token punctuation">.</span>name    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">from</span> city <span class="token keyword">join</span> country    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">on</span> city<span class="token punctuation">.</span>countrycode<span class="token operator">=</span>country<span class="token punctuation">.</span>code    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">where</span> city<span class="token punctuation">.</span>population<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+-------------+----------+</span><span class="token operator">|</span> name      <span class="token operator">|</span> countrycode <span class="token operator">|</span> name     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+-------------+----------+</span><span class="token operator">|</span> Adamstown <span class="token operator">|</span> PCN         <span class="token operator">|</span> Pitcairn <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+-------------+----------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#å¤–è¿æ¥ï¼ˆå·¦ï¼‰</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> city<span class="token punctuation">.</span>name<span class="token punctuation">,</span>city<span class="token punctuation">.</span>countrycode<span class="token punctuation">,</span>country<span class="token punctuation">.</span>name    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">from</span> city <span class="token keyword">left</span> <span class="token keyword">join</span> country    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">on</span> city<span class="token punctuation">.</span>countrycode<span class="token operator">=</span>country<span class="token punctuation">.</span>code    <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">and</span> city<span class="token punctuation">.</span>population<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span>å¤–è¿æ¥ï¼ˆå³ï¼‰mysql<span class="token operator">></span> <span class="token keyword">select</span> city<span class="token punctuation">.</span>name<span class="token punctuation">,</span>city<span class="token punctuation">.</span>countrycode<span class="token punctuation">,</span>country<span class="token punctuation">.</span>name    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">from</span> city <span class="token keyword">right</span> <span class="token keyword">join</span> country    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">on</span> city<span class="token punctuation">.</span>countrycode<span class="token operator">=</span>country<span class="token punctuation">.</span>code    <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">and</span> city<span class="token punctuation">.</span>population<span class="token operator">&lt;</span><span class="token number">100</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span></code></pre><h3 id="4-2-Show"><a href="#4-2-Show" class="headerlink" title="4.2 Show"></a>4.2 Show</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">7</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹æ•°æ®åº“åˆ›å»ºsql</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">database</span> huhuhahei<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+--------------------------------------------------------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>  <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Database</span>                                                    <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+--------------------------------------------------------------------+</span><span class="token operator">|</span> huhuhahei <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token punctuation">`</span>huhuhahei<span class="token punctuation">`</span> <span class="token comment" spellcheck="true">/*!40100 DEFAULT CHARACTER SET utf8 */</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------+--------------------------------------------------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹æ•°æ®è¡¨</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------------+</span><span class="token operator">|</span> Tables_in_world <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------------+</span><span class="token operator">|</span> city            <span class="token operator">|</span><span class="token operator">|</span> country         <span class="token operator">|</span><span class="token operator">|</span> countrylanguage <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-----------------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹åˆ›è¡¨è¯­å¥</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> score<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token operator">|</span> <span class="token keyword">Table</span> <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Table</span>                                                                                                                                                                                       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token operator">|</span> score <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>score<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>sno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å­¦å·'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>cno<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è¯¾ç¨‹å·'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>mark<span class="token punctuation">`</span> <span class="token keyword">float</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æˆç»©'</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8        <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">-------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token comment" spellcheck="true">#æŸ¥çœ‹ç°æœ‰æƒé™</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> grants <span class="token keyword">for</span> test<span class="token variable">@'127.0.0.1'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token operator">|</span> Grants <span class="token keyword">for</span> test<span class="token variable">@127.0.0.1</span>                                                                                                                                                                                                                                                                                                                                                                                                                   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token operator">|</span> <span class="token keyword">GRANT</span> <span class="token keyword">INSERT</span><span class="token punctuation">,</span> <span class="token keyword">UPDATE</span><span class="token punctuation">,</span> <span class="token keyword">DELETE</span><span class="token punctuation">,</span> <span class="token keyword">CREATE</span><span class="token punctuation">,</span> <span class="token keyword">DROP</span><span class="token punctuation">,</span> RELOAD<span class="token punctuation">,</span> <span class="token keyword">SHUTDOWN</span><span class="token punctuation">,</span> PROCESS<span class="token punctuation">,</span> <span class="token keyword">FILE</span><span class="token punctuation">,</span> <span class="token keyword">REFERENCES</span><span class="token punctuation">,</span> <span class="token keyword">INDEX</span><span class="token punctuation">,</span> <span class="token keyword">ALTER</span><span class="token punctuation">,</span> <span class="token keyword">SHOW</span> <span class="token keyword">DATABASES</span><span class="token punctuation">,</span> SUPER<span class="token punctuation">,</span> <span class="token keyword">CREATE</span> <span class="token keyword">TEMPORARY</span> <span class="token keyword">TABLES</span><span class="token punctuation">,</span> <span class="token keyword">LOCK</span> <span class="token keyword">TABLES</span><span class="token punctuation">,</span> <span class="token keyword">EXECUTE</span><span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> SLAVE<span class="token punctuation">,</span> <span class="token keyword">REPLICATION</span> CLIENT<span class="token punctuation">,</span> <span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span><span class="token punctuation">,</span> <span class="token keyword">SHOW</span> <span class="token keyword">VIEW</span><span class="token punctuation">,</span> <span class="token keyword">CREATE</span> <span class="token keyword">ROUTINE</span><span class="token punctuation">,</span> <span class="token keyword">ALTER</span> <span class="token keyword">ROUTINE</span><span class="token punctuation">,</span> <span class="token keyword">CREATE</span> <span class="token keyword">USER</span><span class="token punctuation">,</span> EVENT<span class="token punctuation">,</span> <span class="token keyword">TRIGGER</span><span class="token punctuation">,</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLESPACE</span> <span class="token keyword">ON</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'test'</span>@'<span class="token number">127.0</span><span class="token punctuation">.</span><span class="token number">0.1</span><span class="token string">' IDENTIFIED BY PASSWORD '</span><span class="token operator">*</span>23AE809DDACAF96AF0FD78ED04B6A265E05AA257' <span class="token keyword">WITH</span> <span class="token keyword">GRANT</span> <span class="token keyword">OPTION</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹å­—ç¬¦é›†</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">charset</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹æ ¡éªŒè§„åˆ™</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> collation<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹dbæœ€å¤§è¿æ¥æ•°ï¼›</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%connections%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token operator">|</span> Variable_name        <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token operator">|</span> max_connections      <span class="token operator">|</span> <span class="token number">151</span>   <span class="token operator">|</span><span class="token operator">|</span> max_user_connections <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹äº‹åŠ¡éš”ç¦»çº§åˆ«</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">"%iso%"</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+------------------+</span><span class="token operator">|</span> Variable_name <span class="token operator">|</span> <span class="token keyword">Value</span>            <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+------------------+</span><span class="token operator">|</span> tx_isolation  <span class="token operator">|</span> <span class="token keyword">READ</span><span class="token operator">-</span><span class="token keyword">UNCOMMITTED</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>è½¬è½½ <a href="https://blog.driverzeng.com/zenglaoshi/668.html">drz</a></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Databases </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8séƒ¨ç½²ELKåˆ†ææ—¥å¿—</title>
      <link href="/8eafa1a6/"/>
      <url>/8eafa1a6/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ç¯å¢ƒå‡†å¤‡"><a href="#ä¸€-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ä¸€.ç¯å¢ƒå‡†å¤‡"></a>ä¸€.ç¯å¢ƒå‡†å¤‡</h1><p>åˆ›å»ºéœ€è¦çš„å‘½åç©ºé—´å¹¶å‡†å¤‡æŒä¹…åŒ–çš„æ•°æ®ç›®å½•</p><pre class=" language-bash"><code class="language-bash">kubectl create ns logs<span class="token comment" spellcheck="true">#åˆ›å»ºelasticsearchå’Œkibanaçš„æŒä¹…åŒ–ç›®å½•</span><span class="token function">mkdir</span> kibana elk<span class="token comment" spellcheck="true">#ç»™ä¸‹å…¨æƒé™</span><span class="token function">chmod</span> -R 777 kibana elk</code></pre><h1 id="äºŒ-ELKæ¶æ„"><a href="#äºŒ-ELKæ¶æ„" class="headerlink" title="äºŒ.ELKæ¶æ„"></a>äºŒ.ELKæ¶æ„</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/2999989110.jpg"></p><h1 id="ä¸‰-éƒ¨ç½²elasticsearch"><a href="#ä¸‰-éƒ¨ç½²elasticsearch" class="headerlink" title="ä¸‰.éƒ¨ç½²elasticsearch"></a>ä¸‰.éƒ¨ç½²elasticsearch</h1><h3 id="3-1-éƒ¨ç½²pvc"><a href="#3-1-éƒ¨ç½²pvc" class="headerlink" title="3.1 éƒ¨ç½²pvc"></a>3.1 éƒ¨ç½²pvc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> elastic<span class="token punctuation">-</span>logs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> elastic<span class="token punctuation">-</span>logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/elk    <span class="token key atrule">server</span><span class="token punctuation">:</span> master<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> elastic<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> elastic<span class="token punctuation">-</span>logs</code></pre><h3 id="3-2-éƒ¨ç½²deployæ§åˆ¶å™¨"><a href="#3-2-éƒ¨ç½²deployæ§åˆ¶å™¨" class="headerlink" title="3.2 éƒ¨ç½²deployæ§åˆ¶å™¨"></a>3.2 éƒ¨ç½²deployæ§åˆ¶å™¨</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">generation</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging    <span class="token key atrule">version</span><span class="token punctuation">:</span> v1  <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">minReadySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> discovery.type          <span class="token key atrule">value</span><span class="token punctuation">:</span> single<span class="token punctuation">-</span>node        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ES_JAVA_OPTS          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>Xms512m <span class="token punctuation">-</span>Xmx512m        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MINIMUM_MASTER_NODES          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"1"</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/elasticsearch/elasticsearch<span class="token punctuation">:</span>7.12.0<span class="token punctuation">-</span>amd64        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9200</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9200</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9200</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> db          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9300</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> transport          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">limits</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2Gi          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/elasticsearch/data          <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> /sbin/sysctl        <span class="token punctuation">-</span> <span class="token punctuation">-</span>w        <span class="token punctuation">-</span> vm.max_map_count=262144        <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine<span class="token punctuation">:</span><span class="token number">3.6</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging<span class="token punctuation">-</span>init        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">procMount</span><span class="token punctuation">:</span> Default        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> elastic<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>pvc</code></pre><h3 id="3-3-éƒ¨ç½²svc"><a href="#3-3-éƒ¨ç½²svc" class="headerlink" title="3.3 éƒ¨ç½²svc"></a>3.3 éƒ¨ç½²svc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs  <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9200</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> elasticsearch    <span class="token key atrule">selector</span><span class="token punctuation">:</span>     <span class="token key atrule">app</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">-</span>logging</code></pre><h3 id="3-4-äº¤ä»˜k8s"><a href="#3-4-äº¤ä»˜k8s" class="headerlink" title="3.4 äº¤ä»˜k8s"></a>3.4 äº¤ä»˜k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f elastic_pvc.yamlkubectl apply <span class="token punctuation">-</span>f elastic_deploy.yamlkubectl apply <span class="token punctuation">-</span>f elastic_svc.yaml</code></pre><h1 id="å››-é…ç½®logstash"><a href="#å››-é…ç½®logstash" class="headerlink" title="å››.é…ç½®logstash"></a>å››.é…ç½®logstash</h1><h3 id="4-1-é…ç½®logstashé…ç½®æ–‡ä»¶"><a href="#4-1-é…ç½®logstashé…ç½®æ–‡ä»¶" class="headerlink" title="4.1 é…ç½®logstashé…ç½®æ–‡ä»¶"></a>4.1 é…ç½®logstashé…ç½®æ–‡ä»¶</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash<span class="token punctuation">-</span>config  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">logstash.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>    input <span class="token punctuation">{</span>      beats <span class="token punctuation">{</span>        port =<span class="token punctuation">></span> 5016      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    filter <span class="token punctuation">{</span>      grok <span class="token punctuation">{</span>        match =<span class="token punctuation">></span> <span class="token punctuation">{</span> "message" =<span class="token punctuation">></span> "%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>client_ip<span class="token punctuation">}</span> <span class="token punctuation">-</span> %<span class="token punctuation">{</span>USER<span class="token punctuation">:</span>auth<span class="token punctuation">}</span> \<span class="token punctuation">[</span>%<span class="token punctuation">{</span>HTTPDATE<span class="token punctuation">:</span>timestamp<span class="token punctuation">}</span>\<span class="token punctuation">]</span> \"(<span class="token punctuation">?</span><span class="token punctuation">:</span>%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>verb<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>request<span class="token punctuation">}</span>(<span class="token punctuation">?</span><span class="token punctuation">:</span> HTTP/%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>http_version<span class="token punctuation">}</span>)<span class="token punctuation">?</span><span class="token punctuation">|</span><span class="token punctuation">-</span>)\" (%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>domain<span class="token punctuation">}</span><span class="token punctuation">|</span>%<span class="token punctuation">{</span>URIHOST<span class="token punctuation">:</span>domain<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>response<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>bytes<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>referrer<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>agent<span class="token punctuation">}</span> \"(%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>x_forword<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>)\" (%<span class="token punctuation">{</span>URIHOST<span class="token punctuation">:</span>upstream_host<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) (%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>upstream_response<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) (%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>upstream_cache_status<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>upstream_content_type<span class="token punctuation">}</span> (%<span class="token punctuation">{</span>BASE16FLOAT<span class="token punctuation">:</span>upstream_response_time<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) <span class="token punctuation">></span> %<span class="token punctuation">{</span>BASE16FLOAT<span class="token punctuation">:</span>request_time<span class="token punctuation">}</span>" <span class="token punctuation">}</span>        match =<span class="token punctuation">></span> <span class="token punctuation">{</span> "message" =<span class="token punctuation">></span> "%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>upstream_host<span class="token punctuation">}</span> <span class="token punctuation">-</span> %<span class="token punctuation">{</span>USER<span class="token punctuation">:</span>auth<span class="token punctuation">}</span> \<span class="token punctuation">[</span>%<span class="token punctuation">{</span>HTTPDATE<span class="token punctuation">:</span>timestamp<span class="token punctuation">}</span>\<span class="token punctuation">]</span> \"(<span class="token punctuation">?</span><span class="token punctuation">:</span>%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>verb<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>request<span class="token punctuation">}</span>(<span class="token punctuation">?</span><span class="token punctuation">:</span> HTTP/%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>http_version<span class="token punctuation">}</span>)<span class="token punctuation">?</span><span class="token punctuation">|</span><span class="token punctuation">-</span>)\" (%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>domain<span class="token punctuation">}</span><span class="token punctuation">|</span>%<span class="token punctuation">{</span>URIHOST<span class="token punctuation">:</span>domain<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>response<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>bytes<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>referrer<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>agent<span class="token punctuation">}</span> \"%<span class="token punctuation">{</span>IP<span class="token punctuation">:</span>client_ip<span class="token punctuation">}</span>\" (%<span class="token punctuation">{</span>URIHOST<span class="token punctuation">:</span>upstream_host<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) (%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>upstream_response<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) (%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>upstream_cache_status<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>upstream_content_type<span class="token punctuation">}</span> (%<span class="token punctuation">{</span>BASE16FLOAT<span class="token punctuation">:</span>upstream_response_time<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) <span class="token punctuation">></span> %<span class="token punctuation">{</span>BASE16FLOAT<span class="token punctuation">:</span>request_time<span class="token punctuation">}</span>" <span class="token punctuation">}</span>        match =<span class="token punctuation">></span> <span class="token punctuation">{</span> "message" =<span class="token punctuation">></span> "%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>client_ip<span class="token punctuation">}</span> <span class="token punctuation">-</span> (%<span class="token punctuation">{</span>USER<span class="token punctuation">:</span>auth<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) \<span class="token punctuation">[</span>%<span class="token punctuation">{</span>HTTPDATE<span class="token punctuation">:</span>timestamp<span class="token punctuation">}</span>\<span class="token punctuation">]</span> \"%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>verb<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>request<span class="token punctuation">}</span> HTTP/%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>http_version<span class="token punctuation">}</span>\" (%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>domain<span class="token punctuation">}</span><span class="token punctuation">|</span>%<span class="token punctuation">{</span>URIHOST<span class="token punctuation">:</span>domain<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>response<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>bytes<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>referrer<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>agent<span class="token punctuation">}</span> \"(%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>x_forword<span class="token punctuation">}</span><span class="token punctuation">|</span>%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>x_forword<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>)\" (%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>upstream_host<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>)\<span class="token punctuation">:</span>%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>upstream_port<span class="token punctuation">}</span> (%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>upstream_response<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) (%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>upstream_cache_status<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) \"%<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>upstream_content_type<span class="token punctuation">}</span>; charset\=%<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>upstream_content_charset<span class="token punctuation">}</span>\" (%<span class="token punctuation">{</span>BASE16FLOAT<span class="token punctuation">:</span>upstream_response_time<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) <span class="token punctuation">></span> %<span class="token punctuation">{</span>BASE16FLOAT<span class="token punctuation">:</span>request_time<span class="token punctuation">}</span>" <span class="token punctuation">}</span>        match =<span class="token punctuation">></span> <span class="token punctuation">{</span> "message" =<span class="token punctuation">></span> "%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>client_ip<span class="token punctuation">}</span> <span class="token punctuation">-</span> (%<span class="token punctuation">{</span>USER<span class="token punctuation">:</span>auth<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) \<span class="token punctuation">[</span>%<span class="token punctuation">{</span>HTTPDATE<span class="token punctuation">:</span>timestamp<span class="token punctuation">}</span>\<span class="token punctuation">]</span> \"%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>verb<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>request<span class="token punctuation">}</span> HTTP/%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>http_version<span class="token punctuation">}</span>\" (%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>domain<span class="token punctuation">}</span><span class="token punctuation">|</span>%<span class="token punctuation">{</span>URIHOST<span class="token punctuation">:</span>domain<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>response<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>bytes<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>referrer<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>agent<span class="token punctuation">}</span> \"(%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>x_forword<span class="token punctuation">}</span><span class="token punctuation">|</span>%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>x_forword<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>)\" (%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>upstream_host<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>)\<span class="token punctuation">:</span>%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>upstream_port<span class="token punctuation">}</span> (%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>upstream_response<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) (%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>upstream_cache_status<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) \"%<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>upstream_content_type<span class="token punctuation">}</span>;charset\=%<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>upstream_content_charset<span class="token punctuation">}</span>\" (%<span class="token punctuation">{</span>BASE16FLOAT<span class="token punctuation">:</span>upstream_response_time<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) <span class="token punctuation">></span> %<span class="token punctuation">{</span>BASE16FLOAT<span class="token punctuation">:</span>request_time<span class="token punctuation">}</span>" <span class="token punctuation">}</span>        match =<span class="token punctuation">></span> <span class="token punctuation">{</span> "message" =<span class="token punctuation">></span> "%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>client_ip<span class="token punctuation">}</span> <span class="token punctuation">-</span> %<span class="token punctuation">{</span>USER<span class="token punctuation">:</span>auth<span class="token punctuation">}</span> \<span class="token punctuation">[</span>%<span class="token punctuation">{</span>HTTPDATE<span class="token punctuation">:</span>timestamp<span class="token punctuation">}</span>\<span class="token punctuation">]</span> \"(<span class="token punctuation">?</span><span class="token punctuation">:</span>%<span class="token punctuation">{</span>WORD<span class="token punctuation">:</span>verb<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>request<span class="token punctuation">}</span>(<span class="token punctuation">?</span><span class="token punctuation">:</span> HTTP/%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>http_version<span class="token punctuation">}</span>)<span class="token punctuation">?</span><span class="token punctuation">|</span><span class="token punctuation">-</span>)\" %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>response<span class="token punctuation">}</span> (<span class="token punctuation">?</span><span class="token punctuation">:</span>%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>bytes<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>referrer<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>agent<span class="token punctuation">}</span>" <span class="token punctuation">}</span>        match =<span class="token punctuation">></span> <span class="token punctuation">{</span> "message" =<span class="token punctuation">></span> "%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>client_ip<span class="token punctuation">}</span> <span class="token punctuation">-</span> %<span class="token punctuation">{</span>USER<span class="token punctuation">:</span>auth<span class="token punctuation">}</span> \<span class="token punctuation">[</span>%<span class="token punctuation">{</span>HTTPDATE<span class="token punctuation">:</span>timestamp<span class="token punctuation">}</span>\<span class="token punctuation">]</span> \"(%<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>request<span class="token punctuation">}</span>(<span class="token punctuation">?</span><span class="token punctuation">:</span> HTTP/%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>http_version<span class="token punctuation">}</span>)<span class="token punctuation">?</span><span class="token punctuation">|</span><span class="token punctuation">-</span>)\" %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>response<span class="token punctuation">}</span> (<span class="token punctuation">?</span><span class="token punctuation">:</span>%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>bytes<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>referrer<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>agent<span class="token punctuation">}</span>" <span class="token punctuation">}</span>        match =<span class="token punctuation">></span> <span class="token punctuation">{</span> "message" =<span class="token punctuation">></span> "%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>client_ip<span class="token punctuation">}</span> <span class="token punctuation">-</span> %<span class="token punctuation">{</span>USER<span class="token punctuation">:</span>auth<span class="token punctuation">}</span> \<span class="token punctuation">[</span>%<span class="token punctuation">{</span>HTTPDATE<span class="token punctuation">:</span>timestamp<span class="token punctuation">}</span>\<span class="token punctuation">]</span> \"((%<span class="token punctuation">{</span>NOTSPACE<span class="token punctuation">:</span>request<span class="token punctuation">}</span>(<span class="token punctuation">?</span><span class="token punctuation">:</span> HTTP/%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>http_version<span class="token punctuation">}</span>)<span class="token punctuation">?</span><span class="token punctuation">|</span><span class="token punctuation">-</span>)<span class="token punctuation">|</span>)\" %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>response<span class="token punctuation">}</span> (<span class="token punctuation">?</span><span class="token punctuation">:</span>%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>bytes<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>referrer<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>agent<span class="token punctuation">}</span>" <span class="token punctuation">}</span>        match =<span class="token punctuation">></span> <span class="token punctuation">{</span> "message" =<span class="token punctuation">></span> "%<span class="token punctuation">{</span>IPORHOST<span class="token punctuation">:</span>client_ip<span class="token punctuation">}</span> <span class="token punctuation">-</span> %<span class="token punctuation">{</span>USER<span class="token punctuation">:</span>auth<span class="token punctuation">}</span> \<span class="token punctuation">[</span>%<span class="token punctuation">{</span>HTTPDATE<span class="token punctuation">:</span>timestamp<span class="token punctuation">}</span>\<span class="token punctuation">]</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>request<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>response<span class="token punctuation">}</span> (<span class="token punctuation">?</span><span class="token punctuation">:</span>%<span class="token punctuation">{</span>NUMBER<span class="token punctuation">:</span>bytes<span class="token punctuation">}</span><span class="token punctuation">|</span><span class="token punctuation">-</span>) %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>referrer<span class="token punctuation">}</span> %<span class="token punctuation">{</span>QS<span class="token punctuation">:</span>agent<span class="token punctuation">}</span>" <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      geoip <span class="token punctuation">{</span>        source =<span class="token punctuation">></span> "client_ip"      <span class="token punctuation">}</span>      geoip <span class="token punctuation">{</span>        source =<span class="token punctuation">></span> "x_forword_ip"        target =<span class="token punctuation">></span> "x_forword<span class="token punctuation">-</span>geo"      <span class="token punctuation">}</span>      date <span class="token punctuation">{</span>        match =<span class="token punctuation">></span> <span class="token punctuation">[</span> <span class="token string">"timestamp"</span> <span class="token punctuation">,</span> <span class="token string">"dd/MMM/YYYY:HH:mm:ss Z"</span> <span class="token punctuation">]</span>      <span class="token punctuation">}</span>      useragent <span class="token punctuation">{</span>        source =<span class="token punctuation">></span> "agent"        target =<span class="token punctuation">></span> "ua"      <span class="token punctuation">}</span>      mutate <span class="token punctuation">{</span>        split =<span class="token punctuation">></span> <span class="token punctuation">{</span> "x_forword" =<span class="token punctuation">></span> "<span class="token punctuation">,</span> "<span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    output <span class="token punctuation">{</span>      elasticsearch <span class="token punctuation">{</span>        hosts =<span class="token punctuation">></span> <span class="token punctuation">[</span><span class="token string">"10.98.214.187:9200"</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#è¿™é‡Œæ˜¯esçš„svc ip</span>        manage_template =<span class="token punctuation">></span> false        index =<span class="token punctuation">></span> "public<span class="token punctuation">-</span>ngx<span class="token punctuation">-</span>alias"      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>            </code></pre><h3 id="4-2-é…ç½®deploy"><a href="#4-2-é…ç½®deploy" class="headerlink" title="4.2 é…ç½®deploy"></a>4.2 é…ç½®deploy</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>     <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>       <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>         <span class="token key atrule">app</span><span class="token punctuation">:</span> logstash        <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/logstash/logstash<span class="token punctuation">:</span>7.12.0        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5044</span>          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9600</span>          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash<span class="token punctuation">-</span>config          <span class="token comment" spellcheck="true">#mountPath: /usr/share/logstash/logstash-simple.conf</span>          <span class="token comment" spellcheck="true">#mountPath: /usr/share/logstash/config/logstash-sample.conf</span>          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/logstash/pipeline/logstash.conf          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logstash.conf        <span class="token comment" spellcheck="true">#ports:</span>        <span class="token comment" spellcheck="true">#  - containerPort: 80</span>        <span class="token comment" spellcheck="true">#    protocol: TCP</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash<span class="token punctuation">-</span>config        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>          <span class="token comment" spellcheck="true">#defaultMode: 0644</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash<span class="token punctuation">-</span>config</code></pre><h3 id="4-3-é…ç½®svc"><a href="#4-3-é…ç½®svc" class="headerlink" title="4.3 é…ç½®svc"></a>4.3 é…ç½®svc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs  <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> logstash<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5016</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> logstash  <span class="token key atrule">selector</span><span class="token punctuation">:</span>     <span class="token key atrule">app</span><span class="token punctuation">:</span> logstash</code></pre><h3 id="4-4-äº¤ä»˜k8s"><a href="#4-4-äº¤ä»˜k8s" class="headerlink" title="4.4 äº¤ä»˜k8s"></a>4.4 äº¤ä»˜k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f logstash.yamlkubectl apply <span class="token punctuation">-</span>f logstash_deploy.yamlkubectl apply <span class="token punctuation">-</span>f logstash_svc.yaml</code></pre><h1 id="äº”-é…ç½®kinana"><a href="#äº”-é…ç½®kinana" class="headerlink" title="äº”.é…ç½®kinana"></a>äº”.é…ç½®kinana</h1><h3 id="5-1-pvcæ–‡ä»¶"><a href="#5-1-pvcæ–‡ä»¶" class="headerlink" title="5.1 pvcæ–‡ä»¶"></a>5.1 pvcæ–‡ä»¶</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>logs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/kibana    <span class="token key atrule">server</span><span class="token punctuation">:</span> master<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>logs</code></pre><h3 id="5-2-deployæ–‡ä»¶"><a href="#5-2-deployæ–‡ä»¶" class="headerlink" title="5.2 deployæ–‡ä»¶"></a>5.2 deployæ–‡ä»¶</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> kibana        <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker.elastic.co/kibana/kibana<span class="token punctuation">:</span>7.12.0        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5601</span>          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5601</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5601</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ELASTICSEARCH_URL          <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//elasticsearch.logs.svc.cluster.local<span class="token punctuation">:</span><span class="token number">9200</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/kibana/data          <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> es<span class="token punctuation">-</span>persistent<span class="token punctuation">-</span>storage          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>pvc</code></pre><h3 id="5-3-svcé…ç½®"><a href="#5-3-svcé…ç½®" class="headerlink" title="5.3 svcé…ç½®"></a>5.3 svcé…ç½®</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>   <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5601</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">5601</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>     <span class="token key atrule">app</span><span class="token punctuation">:</span> kibana</code></pre><h3 id="5-4-äº¤ä»˜k8s"><a href="#5-4-äº¤ä»˜k8s" class="headerlink" title="5.4 äº¤ä»˜k8s"></a>5.4 äº¤ä»˜k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f kibana_pvc.yamlkubectl apply <span class="token punctuation">-</span>f kibana_deploy.yamlkubectl apply <span class="token punctuation">-</span>f kibana_svc.yaml</code></pre><h1 id="å…­-é…ç½®filebeat"><a href="#å…­-é…ç½®filebeat" class="headerlink" title="å…­.é…ç½®filebeat"></a>å…­.é…ç½®filebeat</h1><h3 id="6-1-deployæ–‡ä»¶"><a href="#6-1-deployæ–‡ä»¶" class="headerlink" title="6.1 deployæ–‡ä»¶"></a>6.1 deployæ–‡ä»¶</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/filebeat<span class="token punctuation">:</span>6.5.1        <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>config          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/filebeat.yml          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> filebeat.yml        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>logs          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/filebeat/logs        <span class="token comment" spellcheck="true">#ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨filebeat</span>        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>          <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"/etc/filebeat.yml"</span><span class="token punctuation">,</span>          <span class="token string">"-e"</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi          <span class="token key atrule">limits</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 500Mi        <span class="token comment" spellcheck="true">#è®¾ç½®è®¿é—®å®¹å™¨çš„ç”¨æˆ·IDæœ¬æ¬¡è®¾ç½®ä¸º0å³è®¿é—®å®¹å™¨ä¸ºrootç”¨æˆ·</span>        <span class="token comment" spellcheck="true">#ä¸è®¾ç½®é»˜è®¤å®¹å™¨ç”¨æˆ·ä¸ºfilebeatåˆ™ä¼šå‡ºç°è®¿é—®æ—¥å¿—æ–‡ä»¶æ²¡æƒé™çš„é—®é¢˜</span>        <span class="token comment" spellcheck="true">#è®¾ç½®è¯¥å‚æ•°ä½¿ç”¨kubelet execç™»å½•å®¹å™¨çš„ç”¨æˆ·ä¸ºrootç”¨æˆ·</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">0</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>config        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>config      <span class="token comment" spellcheck="true">#è¿™é‡ŒæŒ‚è½½çš„æ˜¯nginxçš„æ—¥å¿—ç›®å½•</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>logs        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/logs/blog<span class="token punctuation">-</span>blog<span class="token punctuation">-</span>logs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>51d8fa72<span class="token punctuation">-</span>8d0b<span class="token punctuation">-</span>4bf9<span class="token punctuation">-</span>9271<span class="token punctuation">-</span>2fc7ddc6636d</code></pre><h3 id="6-2-é…ç½®æ–‡ä»¶"><a href="#6-2-é…ç½®æ–‡ä»¶" class="headerlink" title="6.2 é…ç½®æ–‡ä»¶"></a>6.2 é…ç½®æ–‡ä»¶</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">paths</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> /data/logs  <span class="token key atrule">fields</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> k8s    <span class="token key atrule">type</span><span class="token punctuation">:</span> module<span class="token key atrule">filebeat.config.modules</span><span class="token punctuation">:</span>  <span class="token key atrule">path</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>path.config<span class="token punctuation">}</span>/modules.d/*.yml  <span class="token key atrule">reload.enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">setup.template.settings</span><span class="token punctuation">:</span>  <span class="token key atrule">index.number_of_shards</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token key atrule">setup.kibana</span><span class="token punctuation">:</span><span class="token key atrule">output.logstash</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"10.97.125.215:5016"</span><span class="token punctuation">]</span><span class="token key atrule">processors</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">add_host_metadata</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">add_cloud_metadata</span><span class="token punctuation">:</span></code></pre><h3 id="6-3-äº¤ä»˜k8s"><a href="#6-3-äº¤ä»˜k8s" class="headerlink" title="6.3 äº¤ä»˜k8s"></a>6.3 äº¤ä»˜k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl create cm filebeat<span class="token punctuation">-</span>config <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>file=filebeat.yml <span class="token punctuation">-</span>n logskubectl apply <span class="token punctuation">-</span>f filebeat_deploy.yaml</code></pre><h1 id="ä¸ƒ-è®¿é—®kibanaé…ç½®ç´¢å¼•"><a href="#ä¸ƒ-è®¿é—®kibanaé…ç½®ç´¢å¼•" class="headerlink" title="ä¸ƒ.è®¿é—®kibanaé…ç½®ç´¢å¼•"></a>ä¸ƒ.è®¿é—®kibanaé…ç½®ç´¢å¼•</h1><h3 id="7-1-æŸ¥çœ‹svcç¡®è®¤kibanaçš„ç«¯å£"><a href="#7-1-æŸ¥çœ‹svcç¡®è®¤kibanaçš„ç«¯å£" class="headerlink" title="7.1 æŸ¥çœ‹svcç¡®è®¤kibanaçš„ç«¯å£"></a>7.1 æŸ¥çœ‹svcç¡®è®¤kibanaçš„ç«¯å£</h3><pre class=" language-yaml"><code class="language-yaml">kubectl get svc <span class="token punctuation">-</span>n logsNAME            TYPE        CLUSTER<span class="token punctuation">-</span>IP      EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)          AGEelasticsearch   ClusterIP   10.98.214.187   &lt;none<span class="token punctuation">></span>        9200/TCP         22hkibana          NodePort    10.97.10.70     &lt;none<span class="token punctuation">></span>        5601<span class="token punctuation">:</span>30774/TCP   22h</code></pre><p>æµè§ˆå™¨è®¿é—®ipï¼‹30774,å¯ä»¥å‚è€ƒä¹‹å‰çš„ELKæ–‡ç« åˆ›å»ºç´¢å¼•å’Œæ¨¡æ¿<br><a href="https://www.huhuhahei.cn/index.php/archives/281/"># Linuxéƒ¨ç½²ELKï¼ˆäºŒï¼‰</a></p><h1 id="é…ç½®nginxè½¬å‘"><a href="#é…ç½®nginxè½¬å‘" class="headerlink" title="é…ç½®nginxè½¬å‘"></a>é…ç½®nginxè½¬å‘</h1><p>é…ç½®æ–‡ä»¶</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    server {        listen       80;        server_name  localhost;        location / {            proxy_pass http://kibana.logs.svc.cluster.local:5601;        auth_basic "secret";        auth_basic_user_file /usr/local/nginx/conf/.test.db;        }    }</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs</code></pre><p>deployæ–‡ä»¶</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/lnmp_nginx<span class="token punctuation">:</span>v2        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/conf/conf.d/      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">items</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx.conf            <span class="token key atrule">path</span><span class="token punctuation">:</span> add.conf</code></pre><p>svcæ–‡ä»¶</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><p>ingressæ–‡ä»¶</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>   <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> kibana.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /        <span class="token key atrule">backend</span><span class="token punctuation">:</span>           <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><p>å…¨éƒ¨é…ç½®åéœ€è¦è¿›å…¥å®¹å™¨æ·»åŠ å¯†ç è¯¦ç»†é…ç½®å‚è€ƒè¿™ä¸ªæ–‡ç« <br><a href="https://www.huhuhahei.cn/index.php/archives/297/"># ä½¿ç”¨nginxåšåå‘ä»£ç†ä¸ºkibanaç™»é™†æ·»åŠ å¯†ç </a></p>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ansible playbook</title>
      <link href="/ca9d1912/"/>
      <url>/ca9d1912/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ç®€ä»‹"><a href="#ä¸€-ç®€ä»‹" class="headerlink" title="ä¸€.ç®€ä»‹"></a>ä¸€.ç®€ä»‹</h1><h3 id="1-1-playbookå‘½ä»¤"><a href="#1-1-playbookå‘½ä»¤" class="headerlink" title="1.1 playbookå‘½ä»¤"></a>1.1 playbookå‘½ä»¤</h3><p>æ ¼å¼</p><pre class=" language-bash"><code class="language-bash">ansible-playbook <span class="token operator">&lt;</span>filename.yml<span class="token operator">></span> <span class="token punctuation">..</span>. <span class="token punctuation">[</span>options<span class="token punctuation">]</span></code></pre><p>å¸¸è§é€‰é¡¹</p><pre class=" language-bash"><code class="language-bash">--syntax-check      <span class="token comment" spellcheck="true">#è¯­æ³•æ£€æŸ¥,å¯ç¼©å†™ä¸º--syntax,ç›¸å½“äºbash -n</span>-C --check             <span class="token comment" spellcheck="true">#æ¨¡æ‹Ÿæ‰§è¡Œ,å€¼æ£€æµ‹å¯èƒ½ä¼šå‘ç”Ÿçš„æ”¹å˜,ä½†ä¸çœŸæ­£æ‰§è¡Œæ“ä½œ</span>--list-hosts             <span class="token comment" spellcheck="true">#åˆ—å‡ºè¿è¡Œä»»åŠ¡çš„ä¸»æœº</span>--list-tags               <span class="token comment" spellcheck="true">#è´´å‡ºtag</span>--list-tasks              <span class="token comment" spellcheck="true">#åˆ—å‡ºtask</span>--limit ä¸»æœºåˆ—è¡¨       <span class="token comment" spellcheck="true">#åªé’ˆå¯¹ä¸»æœºåˆ—è¡¨ä¸­çš„é“å®šä¸»æœºæ‰§è¡Œ</span>-i INVENTORY         <span class="token comment" spellcheck="true">#æŒ‡å®šä¸»æœºæ¸…å•æ–‡ä»¶,é€šå¸¸ä¸€ä¸ªé¡¹å¯¹åº”ä¸€ä¸ªä¸»æœºæ¸…å•æ–‡ä»¶</span>--start-at-task START_AT_TASK   <span class="token comment" spellcheck="true">#ä»æŒ‡å®štaskå¼€å§‹æ‰§è¡Œ,è€Œéä»å¤´å¼€å§‹,START_AT_TASKä¸ºä»»åŠ¡çš„name</span>-v -vv-vvv        <span class="token comment" spellcheck="true">#æ˜¾ç¤ºè¿‡ç¨‹</span></code></pre><p>èŒƒä¾‹</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master playbook<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#cat hello.yaml </span>---- hosts: all  remote_user: root  tasks:    - name: hello      command: <span class="token function">hostname</span><span class="token punctuation">[</span>root@master playbook<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible-playbook hello.yaml</span><span class="token comment" spellcheck="true">#-Cå‚æ•°åªç›‘æµ‹ä¸æ‰§è¡Œ</span><span class="token punctuation">[</span>root@master playbook<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible-playbook -C hello.yaml</span></code></pre><h1 id="äºŒ-å®æˆ˜åº”ç”¨"><a href="#äºŒ-å®æˆ˜åº”ç”¨" class="headerlink" title="äºŒ.å®æˆ˜åº”ç”¨"></a>äºŒ.å®æˆ˜åº”ç”¨</h1><h3 id="2-1nginx-playbok"><a href="#2-1nginx-playbok" class="headerlink" title="2.1nginx_playbok"></a>2.1nginx_playbok</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create new file      <span class="token key atrule">file</span><span class="token punctuation">:</span> name=/data/newfile state=touch    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install package      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=nginx    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy conf      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/root/ansible/file/index.html dest=/usr/share/nginx/html    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=nginx state=started enabled=yes</code></pre><h3 id="2-2-httpd-palybook"><a href="#2-2-httpd-palybook" class="headerlink" title="2.2 httpd_palybook"></a>2.2 httpd_palybook</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#install httpd</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Instal1 httpd       <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Modify config list port      <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/httpd/conf/httpd.conf        <span class="token key atrule">regexp</span><span class="token punctuation">:</span> <span class="token string">'^Listen'</span>        <span class="token key atrule">line</span><span class="token punctuation">:</span> <span class="token string">'Listen 8080'</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Modify config data1      <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/httpd/conf/httpd.conf        <span class="token key atrule">regexp</span><span class="token punctuation">:</span> <span class="token string">'^DocumentRoot "/var/www/html"'</span>        <span class="token key atrule">line</span><span class="token punctuation">:</span> <span class="token string">'DocumentRoot "/data/html"'</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Modify config data2      <span class="token key atrule">lineinfile</span><span class="token punctuation">:</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/httpd/conf/httpd.conf        <span class="token key atrule">regexp</span><span class="token punctuation">:</span> <span class="token string">'^&lt;Directory "/var/www/html">'</span>        <span class="token key atrule">line</span><span class="token punctuation">:</span> <span class="token string">'&lt;Directory "/data/html">'</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Mkdir website dir      <span class="token key atrule">file</span><span class="token punctuation">:</span> path=/data/html state=directory    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Web html      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/root/ansible/file/index.html dest=/data/html/    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Start service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes</code></pre><h1 id="ä¸‰-Playbookä¸­ä½¿ç”¨handlerså’Œnotify"><a href="#ä¸‰-Playbookä¸­ä½¿ç”¨handlerså’Œnotify" class="headerlink" title="ä¸‰.Playbookä¸­ä½¿ç”¨handlerså’Œnotify"></a>ä¸‰.Playbookä¸­ä½¿ç”¨handlerså’Œnotify</h1><p>Handlersæœ¬è´¨æ˜¯task list ï¼Œç±»ä¼¼äºMySQLä¸­çš„è§¦å‘å™¨è§¦å‘çš„è¡Œä¸ºï¼Œå…¶ä¸­çš„taskä¸å‰è¿°çš„taskå¹¶æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒï¼Œä¸»è¦ç”¨äºå½“å…³æ³¨çš„èµ„æºå‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡‡å–ä¸€å®šçš„æ“ä½œã€‚è€ŒNotifyå¯¹åº”çš„actionå¯ç”¨äºåœ¨æ¯ä¸ªplayçš„æœ€åè¢«è§¦å‘ï¼Œè¿™æ ·å¯é¿å…å¤šæ¬¡æœ‰æ”¹å˜å‘ç”Ÿæ—¶æ¯æ¬¡éƒ½æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œï¼Œä»…åœ¨æ‰€æœ‰çš„å˜åŒ–å‘ç”Ÿå®Œ æˆåä¸€æ¬¡æ€§åœ°æ‰§è¡ŒæŒ‡å®šæ“ä½œã€‚åœ¨notifyä¸­åˆ—å‡ºçš„æ“ä½œç§°ä¸ºhandlerï¼Œä¹Ÿå³notifyä¸­è°ƒç”¨handlerä¸­å®šä¹‰çš„æ“ä½œ<br>æ³¨æ„:</p><ul><li>å¦‚æœå¤šä¸ªtaské€šçŸ¥äº†ç›¸åŒçš„handlersï¼Œ æ­¤handlersä»…ä¼šåœ¨æ‰€æœ‰tasksç»“æŸåè¿è¡Œä¸€ æ¬¡ã€‚</li><li>åªæœ‰notifyå¯¹åº”çš„taskå‘ç”Ÿæ”¹å˜äº†æ‰ä¼šé€šçŸ¥handlersï¼Œ æ²¡æœ‰æ”¹å˜åˆ™ä¸ä¼šè§¦å‘handlers</li><li>handlers  æ˜¯åœ¨æ‰€æœ‰å‰é¢çš„taskséƒ½æˆåŠŸæ‰§è¡Œæ‰ä¼šæ‰§è¡Œ,å¦‚æœå‰é¢ä»»ä½•ä¸€ä¸ªtaskå¤±è´¥,ä¼šå¯¼è‡´handlerè·³è¿‡æ‰§è¡Œ,å¯ä»¥ä½¿ç”¨force_handlers: yes å¼ºåˆ¶æ‰§è¡Œhandler</li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root   <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no   <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install httpd      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd state=present    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install configure file      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=files/httpd.conf dest=/etc/httpd/conf/<span class="token comment" spellcheck="true">#å½“é…ç½®æ–‡ä»¶å†…å®¹æ”¹å˜æ—¶è§¦å‘ä¸‹é¢ä¸¤ä¸ªè§¦å‘å™¨</span>      <span class="token key atrule">notify</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> restart httpd        <span class="token punctuation">-</span> wall    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure apache is running      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enabled=yes  <span class="token key atrule">handlers</span><span class="token punctuation">:</span><span class="token comment" spellcheck="true">#å®šä¹‰è§¦å‘å™¨</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> restart httpd      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=restarted    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wall      <span class="token key atrule">command</span><span class="token punctuation">:</span> wall "The config file is changed"</code></pre><h1 id="å››-Playbookä¸­ä½¿ç”¨tagsç»„ä»¶"><a href="#å››-Playbookä¸­ä½¿ç”¨tagsç»„ä»¶" class="headerlink" title="å››.Playbookä¸­ä½¿ç”¨tagsç»„ä»¶"></a>å››.Playbookä¸­ä½¿ç”¨tagsç»„ä»¶</h1><p>åœ¨playbookæ–‡ä»¶ä¸­ï¼Œå¯ä»¥åˆ©ç”¨tagsç»„ä»¶ï¼Œä¸ºç‰¹å®š task æŒ‡å®šæ ‡ç­¾ï¼Œå½“åœ¨æ‰§è¡Œplaybookæ—¶ï¼Œå¯ä»¥åªæ‰§è¡Œç‰¹å®štagsçš„task,è€Œéæ•´ä¸ªplaybookæ–‡ä»¶</p><p>å¯ä»¥ä¸€ä¸ªtaskå¯¹åº”å¤šä¸ªtag,ä¹Ÿå¯ä»¥å¤šä¸ªtaskå¯¹åº”ä¸€ä¸ªtag</p><p>è¿˜æœ‰å¦å¤–3ä¸ªç‰¹æ®Šå…³é”®å­—ç”¨äºæ ‡ç­¾, tagged, untagged å’Œ all,å®ƒä»¬åˆ†åˆ«æ˜¯ä»…è¿è¡Œå·²æ ‡è®°ï¼Œåªæœ‰æœªæ ‡è®°å’Œæ‰€æœ‰ä»»åŠ¡ã€‚</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> no  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install httpd      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=httpd state=present    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install configure file      copy src=files/httpd.conf dest=/etc/httpd/conf      <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>conf<span class="token punctuation">,</span>file<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">#å†™æˆä¸€è¡Œ</span>        <span class="token punctuation">-</span> conf              <span class="token comment" spellcheck="true">#å†™ä¸ºå¤šè¡Œ</span>        <span class="token punctuation">-</span> file    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start httpd service      <span class="token key atrule">tags</span><span class="token punctuation">:</span> service      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=httpd state=started enable=yes</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ansible ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#ansible-playbook â€“-list-tagshttpd.yml </span><span class="token punctuation">[</span>root@ansible ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#ansible-playbook â€“t conf,servicehttpd.yml </span><span class="token punctuation">[</span>root@ansible ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#ansible-playbook --skip-tags confhttpd.yml </span><span class="token punctuation">[</span>root@ansible ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#ansible-playbook httpd.yml --skip-tags untagged</span></code></pre><h1 id="äº”-Playbookä¸­ä½¿ç”¨å˜é‡"><a href="#äº”-Playbookä¸­ä½¿ç”¨å˜é‡" class="headerlink" title="äº”.## Playbookä¸­ä½¿ç”¨å˜é‡"></a>äº”.## Playbookä¸­ä½¿ç”¨å˜é‡</h1><p>å˜é‡å:  ä»…èƒ½ç”±å­—æ¯,æ•°å­—å’Œä¸‹åˆ’çº¿ç»„æˆ,ä¸”åªèƒ½ä»¥æ•°å­—å¼€å¤´<br>å˜é‡å®šä¹‰:</p><pre class=" language-yaml"><code class="language-yaml">variable=value<span class="token key atrule">variable</span><span class="token punctuation">:</span> value</code></pre><p>è°ƒç”¨æ–¹å¼:<br>é€šè¿‡<code> &#123;&#123; variable_name &#125;&#125;</code> è°ƒç”¨å˜é‡ï¼Œä¸”å˜é‡åå‰åå»ºè®®åŠ ç©ºæ ¼ï¼Œæœ‰æ—¶ç”¨â€<code>&#123;&#123; variable_name &#125;&#125;</code>â€œæ‰ç”Ÿæ•ˆ</p><p>å˜é‡æ¥æº:</p><ul><li>ansible çš„ setup facts è¿œç¨‹ä¸»æœºçš„æ‰€æœ‰å˜é‡éƒ½å¯ç›´æ¥è°ƒç”¨</li><li>é€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šå˜é‡ï¼Œä¼˜å…ˆçº§æœ€é«˜</li></ul><pre class=" language-bash"><code class="language-bash">ansible-playbook -e varname<span class="token operator">=</span>value test.yml</code></pre><ul><li>åœ¨playbookæ–‡ä»¶ä¸­å®šä¹‰</li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">vars</span><span class="token punctuation">:</span>  <span class="token key atrule">var1</span><span class="token punctuation">:</span> value1  <span class="token key atrule">var2</span><span class="token punctuation">:</span> value2</code></pre><ul><li>åœ¨ç‹¬ç«‹çš„å˜é‡YAMLæ–‡ä»¶ä¸­å®šä¹‰</li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all   <span class="token key atrule">vars_files</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> vars.yml</code></pre><ul><li>åœ¨ä¸»æœºæ¸…å•ä¸­å®šä¹‰</li></ul><pre class=" language-bash"><code class="language-bash">ä¸»æœºï¼ˆæ™®é€šï¼‰å˜é‡ï¼šä¸»æœºç»„ä¸­ä¸»æœºå•ç‹¬å®šä¹‰ï¼Œä¼˜å…ˆçº§é«˜äºå…¬å…±å˜é‡ç»„ï¼ˆå…¬å…±ï¼‰å˜é‡ï¼šé’ˆå¯¹ä¸»æœºç»„ä¸­æ‰€æœ‰ä¸»æœºå®šä¹‰ç»Ÿä¸€å˜é‡</code></pre><ul><li>åœ¨é¡¹ç›®ä¸­é’ˆå¯¹ä¸»æœºå’Œä¸»æœºç»„å®šä¹‰</li></ul><pre class=" language-bash"><code class="language-bash">åœ¨é¡¹ç›®ç›®å½•åˆ›å»ºhost_varså’Œgroup_varsç›®å½•</code></pre><ul><li>åœ¨roleä¸­å®šä¹‰</li></ul><p><strong>å˜é‡çš„ä¼˜å…ˆçº§ä»é«˜åˆ°ä½å¦‚ä¸‹</strong></p><pre class=" language-bash"><code class="language-bash">-e é€‰é¡¹å®šä¹‰å˜é‡ --<span class="token operator">></span>playbookä¸­vars_files --<span class="token operator">></span> playbookä¸­varså˜é‡å®šä¹‰ --<span class="token operator">></span>host_vars/ä¸»æœºåæ–‡ä»¶ --<span class="token operator">></span>ä¸»æœºæ¸…å•ä¸­ä¸»æœºå˜é‡--<span class="token operator">></span>group_vars/ä¸»æœºç»„åæ–‡ä»¶--<span class="token operator">></span>group_vars/allæ–‡ä»¶--<span class="token operator">></span> ä¸»æœºæ¸…å•ç»„å˜é‡</code></pre><h1 id="å…­-ä½¿ç”¨setupæ¨¡å—ä¸­å˜é‡"><a href="#å…­-ä½¿ç”¨setupæ¨¡å—ä¸­å˜é‡" class="headerlink" title="å…­ ä½¿ç”¨setupæ¨¡å—ä¸­å˜é‡"></a>å…­ ä½¿ç”¨setupæ¨¡å—ä¸­å˜é‡</h1><p>æœ¬æ¨¡å—è‡ªåŠ¨åœ¨playbookè°ƒç”¨ï¼Œä¸è¦ç”¨ansibleå‘½ä»¤è°ƒç”¨,ç”Ÿæˆçš„ç³»ç»ŸçŠ¶æ€ä¿¡æ¯, å¹¶å­˜æ”¾åœ¨factså˜é‡ä¸­</p><p>facts åŒ…æ‹¬çš„ä¿¡æ¯å¾ˆå¤š,å¦‚: ä¸»æœºå,IP,CPU,å†…å­˜,ç½‘å¡ç­‰</p><p>facts å˜é‡æœ‰ä»¥ä¸‹ä½¿ç”¨åœºæ™¯</p><ul><li>é€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯CPUçš„ä¸ªæ•°ä¿¡æ¯,ä»è€Œç”Ÿæˆä¸åŒçš„Nginxé…ç½®æ–‡ä»¶</li><li>é€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯å†…å­˜å¤§å°ä¿¡æ¯,ä»è€Œç”Ÿæˆä¸åŒçš„memcachedçš„é…ç½®æ–‡ä»¶</li><li>é€šè¿‡factså˜é‡è·å–è¢«æ§ç«¯ä¸»æœºåç§°ä¿¡æ¯,ä»è€Œç”Ÿæˆä¸åŒçš„Zabbixé…ç½®æ–‡ä»¶</li></ul><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master playbook<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m setup -a "filter='ansible_default_ipv4'"</span>10.46.40.183 <span class="token punctuation">|</span> SUCCESS =<span class="token punctuation">></span> <span class="token punctuation">{</span>    <span class="token key atrule">"ansible_facts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token key atrule">"ansible_default_ipv4"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token key atrule">"address"</span><span class="token punctuation">:</span> <span class="token string">"10.46.40.183"</span><span class="token punctuation">,</span>             <span class="token key atrule">"alias"</span><span class="token punctuation">:</span> <span class="token string">"eth0"</span><span class="token punctuation">,</span>             <span class="token key atrule">"broadcast"</span><span class="token punctuation">:</span> <span class="token string">"10.46.255.255"</span><span class="token punctuation">,</span>             <span class="token key atrule">"gateway"</span><span class="token punctuation">:</span> <span class="token string">"10.46.0.1"</span><span class="token punctuation">,</span>             <span class="token key atrule">"interface"</span><span class="token punctuation">:</span> <span class="token string">"eth0"</span><span class="token punctuation">,</span>             <span class="token key atrule">"macaddress"</span><span class="token punctuation">:</span> <span class="token string">"52:54:00:d2:23:85"</span><span class="token punctuation">,</span>             <span class="token key atrule">"mtu"</span><span class="token punctuation">:</span> <span class="token number">1454</span><span class="token punctuation">,</span>             <span class="token key atrule">"netmask"</span><span class="token punctuation">:</span> <span class="token string">"255.255.0.0"</span><span class="token punctuation">,</span>             <span class="token key atrule">"network"</span><span class="token punctuation">:</span> <span class="token string">"10.46.0.0"</span><span class="token punctuation">,</span>             <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"ether"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token key atrule">"discovered_interpreter_python"</span><span class="token punctuation">:</span> <span class="token string">"/usr/bin/python"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>     <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre><p>playbookä¸­ä½¿ç”¨</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> show eth0 ip address      <span class="token key atrule">debug</span><span class="token punctuation">:</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> IP address <span class="token punctuation">{</span><span class="token punctuation">{</span> ansible_eth0.ipv4.address <span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> show eth0 ip address      <span class="token key atrule">debug</span><span class="token punctuation">:</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> IP address <span class="token punctuation">{</span><span class="token punctuation">{</span> ansible_eth0.ipv4.address.split('.')<span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h1 id="ä¸ƒ-registeræ³¨å†Œå˜é‡"><a href="#ä¸ƒ-registeræ³¨å†Œå˜é‡" class="headerlink" title="ä¸ƒ.registeræ³¨å†Œå˜é‡"></a>ä¸ƒ.registeræ³¨å†Œå˜é‡</h1><p>åœ¨playbookä¸­å¯ä»¥ä½¿ç”¨registerå°†æ•è·å‘½ä»¤çš„è¾“å‡ºä¿å­˜åœ¨ä¸´æ—¶å˜é‡ä¸­ï¼Œç„¶åä½¿ç”¨debugæ¨¡å—è¿›è¡Œæ˜¾ç¤ºè¾“å‡º</p><p>èŒƒä¾‹: åˆ©ç”¨debug æ¨¡å—è¾“å‡ºå˜é‡</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> get variable      <span class="token key atrule">shell</span><span class="token punctuation">:</span> hostname      <span class="token key atrule">register</span><span class="token punctuation">:</span> name    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"print variable"</span>      <span class="token key atrule">debug</span><span class="token punctuation">:</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"{{ name }}"</span>                          <span class="token comment" spellcheck="true">#è¾“å‡ºregisteræ³¨å†Œçš„nameå˜é‡çš„å…¨éƒ¨ä¿¡æ¯</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"{{ name.cmd }}"</span>                   <span class="token comment" spellcheck="true">#æ˜¾ç¤ºå‘½ä»¤</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"{{ name.rc }}"</span>                        <span class="token comment" spellcheck="true">#æ˜¾ç¤ºå‘½ä»¤æˆåŠŸä¸å¦</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"{{ name.stdout }}"</span>                 <span class="token comment" spellcheck="true">#æ˜¾ç¤ºå‘½ä»¤çš„è¾“å‡ºç»“æœä¸ºå­—ç¬¦ä¸²å½¢å¼</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"{{ name.stdout_lines }}"</span>        <span class="token comment" spellcheck="true">#æ˜¾ç¤ºå‘½ä»¤çš„è¾“å‡ºç»“æœä¸ºåˆ—è¡¨å½¢å¼</span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"{{ name.stdout_lines[0] }}"</span>     <span class="token comment" spellcheck="true">#æ˜¾ç¤ºå‘½ä»¤çš„è¾“å‡ºç»“æœçš„åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span>        <span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"{{ name['stdout_lines'] }}"</span>       <span class="token comment" spellcheck="true">#æ˜¾ç¤ºå‘½ä»¤çš„æ‰§è¡Œç»“æœä¸ºåˆ—è¡¨å½¢å¼</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ansible </tag>
            
            <tag> DevOps </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ansibleè¯¦è§£</title>
      <link href="/a1695b73/"/>
      <url>/a1695b73/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-Ansibleç®€ä»‹"><a href="#ä¸€-Ansibleç®€ä»‹" class="headerlink" title="ä¸€. Ansibleç®€ä»‹"></a>ä¸€. Ansibleç®€ä»‹</h1><p>Ansibleæ˜¯æ–°å‡ºç°çš„è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ï¼ŒåŸºäºPythonå¼€å‘ï¼Œé›†åˆäº†ä¼—å¤šè¿ç»´å·¥å…·ï¼ˆpuppetã€cfengineã€chefã€funcã€fabricï¼‰çš„ä¼˜ç‚¹ï¼Œå®ç°äº†æ‰¹é‡ç³»ç»Ÿé…ç½®ã€æ‰¹é‡ç¨‹åºéƒ¨ç½²ã€æ‰¹é‡è¿è¡Œå‘½ä»¤ç­‰åŠŸèƒ½ã€‚</p><p>ansibleæ˜¯åŸºäºæ¨¡å—å·¥ä½œçš„ï¼Œæœ¬èº«æ²¡æœ‰æ‰¹é‡éƒ¨ç½²çš„èƒ½åŠ›ã€‚çœŸæ­£å…·æœ‰æ‰¹é‡éƒ¨ç½²çš„æ˜¯ansibleæ‰€è¿è¡Œçš„æ¨¡å—ï¼Œansibleåªæ˜¯æä¾›ä¸€ç§æ¡†æ¶ã€‚ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>è¿æ¥æ’ä»¶connection pluginsï¼šè´Ÿè´£å’Œè¢«ç›‘æ§ç«¯å®ç°é€šä¿¡ï¼›</li><li>host inventoryï¼šæŒ‡å®šæ“ä½œçš„ä¸»æœºï¼Œæ˜¯ä¸€ä¸ªé…ç½®æ–‡ä»¶é‡Œé¢å®šä¹‰ç›‘æ§çš„ä¸»æœºï¼›</li><li>å„ç§æ¨¡å—æ ¸å¿ƒæ¨¡å—ã€commandæ¨¡å—ã€è‡ªå®šä¹‰æ¨¡å—ï¼›</li><li>å€ŸåŠ©äºæ’ä»¶å®Œæˆè®°å½•æ—¥å¿—é‚®ä»¶ç­‰åŠŸèƒ½ï¼›</li><li>playbookï¼šå‰§æœ¬æ‰§è¡Œå¤šä¸ªä»»åŠ¡æ—¶ï¼Œéå¿…éœ€å¯ä»¥è®©èŠ‚ç‚¹ä¸€æ¬¡æ€§è¿è¡Œå¤šä¸ªä»»åŠ¡ã€‚</li></ul><hr><h1 id="äºŒ-Ansbileæ¶æ„"><a href="#äºŒ-Ansbileæ¶æ„" class="headerlink" title="äºŒ.Ansbileæ¶æ„"></a>äºŒ.Ansbileæ¶æ„</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/1060232853.jpg"></p><ul><li>INVENTORYï¼šAnsible ç®¡ ç† ä¸» æœº çš„ æ¸… å• &#x2F;etc&#x2F;anaible&#x2F;hosts</li><li>MODULESï¼šAnsibleæ‰§è¡Œå‘½ä»¤çš„åŠŸèƒ½æ¨¡å—ï¼Œå¤šæ•°ä¸ºå†…ç½®æ ¸å¿ƒæ¨¡å—ï¼Œä¹Ÿå¯è‡ªå®šä¹‰</li><li>PLUGINSï¼šæ¨¡å—åŠŸèƒ½çš„è¡¥å……ï¼Œå¦‚è¿æ¥ç±»å‹æ’ä»¶ã€å¾ªç¯æ’ä»¶ã€å˜é‡æ’ä»¶ã€è¿‡æ»¤æ’ä»¶ç­‰</li><li>APIï¼šä¾›ç¬¬ä¸‰æ–¹ç¨‹åºè°ƒç”¨çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£</li></ul><hr><h1 id="ä¸‰-Ansibleå®‰è£…"><a href="#ä¸‰-Ansibleå®‰è£…" class="headerlink" title="ä¸‰.Ansibleå®‰è£…"></a>ä¸‰.Ansibleå®‰è£…</h1><p>ansibleçš„å®‰è£…æ–¹æ³•æœ‰å¤šç§</p><p>å®˜æ–¹æ–‡æ¡£</p><pre class=" language-bash"><code class="language-bash">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.ht ml</code></pre><ul><li>ubuntu18.04å®‰è£…</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># apt update</span><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># apt install software-properties-common </span><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># apt-add-repository --yes --update ppa:ansible/ansible </span><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># apt install ansible</span><span class="token punctuation">[</span>root@ubuntu1804 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible --version ansible 2.9.17</span>config <span class="token function">file</span> <span class="token operator">=</span> /etc/ansible/ansible.cfgconfigured module search path <span class="token operator">=</span> <span class="token punctuation">[</span>u<span class="token string">'/root/.ansible/plugins/modules'</span>,u<span class="token string">'/usr/share/ansible/plugins/modules'</span><span class="token punctuation">]</span>ansible python module location <span class="token operator">=</span> /usr/lib/python2.7/dist-packages/ansible executable location <span class="token operator">=</span> /usr/bin/ansiblepython version <span class="token operator">=</span> 2.7.17 <span class="token punctuation">(</span>default, Sep 30 2020, 13:38:04<span class="token punctuation">)</span> <span class="token punctuation">[</span>GCC 7.5.0<span class="token punctuation">]</span></code></pre><ul><li>Centoså®‰è£…</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum install ansible -y </span><span class="token punctuation">[</span>root@centos8 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible --version ansible 2.9.16</span>config <span class="token function">file</span> <span class="token operator">=</span> /etc/ansible/ansible.cfgconfigured module search path <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'/root/.ansible/plugins/modules'</span>, <span class="token string">'/usr/share/ansible/plugins/modules'</span><span class="token punctuation">]</span>ansible python module location <span class="token operator">=</span> /usr/lib/python3.6/site-packages/ansible executable location <span class="token operator">=</span> /usr/bin/ansiblepython version <span class="token operator">=</span> 3.6.8 <span class="token punctuation">(</span>default, Apr 16 2020, 01:36:27<span class="token punctuation">)</span> <span class="token punctuation">[</span>GCC 8.3.1 20191121<span class="token punctuation">(</span>Red Hat 8.3.1-5<span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre><ul><li>pipå®‰è£…</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#yum install python-pip </span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#pip install--upgrade pip </span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#pip install ansible --upgrade </span><span class="token punctuation">[</span>root@centos7 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#ansible --version</span>/usr/lib64/python2.7/site-packages/cryptography/ init .py:39: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support <span class="token keyword">for</span> it is now deprecated <span class="token keyword">in</span> cryptography, and will be removed <span class="token keyword">in</span> a future release.CryptographyDeprecationWarning, ansible 2.9.12config <span class="token function">file</span> <span class="token operator">=</span> Noneconfigured module search path <span class="token operator">=</span> <span class="token punctuation">[</span>u<span class="token string">'/root/.ansible/plugins/modules'</span>,u<span class="token string">'/usr/share/ansible/plugins/modules'</span><span class="token punctuation">]</span>ansible python module location <span class="token operator">=</span> /usr/lib/python2.7/site-packages/ansible executable location <span class="token operator">=</span> /usr/bin/ansiblepython version <span class="token operator">=</span> 2.7.5 <span class="token punctuation">(</span>default, Apr2 2020, 13:16:51<span class="token punctuation">)</span> <span class="token punctuation">[</span>GCC 4.8.5 20150623<span class="token punctuation">(</span>Red Hat 4.8.5-39<span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre><hr><h1 id="å››-Ansibleç›¸å…³æ–‡ä»¶"><a href="#å››-Ansibleç›¸å…³æ–‡ä»¶" class="headerlink" title="å››.Ansibleç›¸å…³æ–‡ä»¶"></a>å››.Ansibleç›¸å…³æ–‡ä»¶</h1><h3 id="4-1-é…ç½®æ–‡ä»¶"><a href="#4-1-é…ç½®æ–‡ä»¶" class="headerlink" title="4.1 é…ç½®æ–‡ä»¶"></a>4.1 é…ç½®æ–‡ä»¶</h3><ul><li>&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg   ä¸»é…ç½®æ–‡ä»¶ï¼Œé…ç½®ansibleå·¥ä½œç‰¹æ€§,ä¹Ÿå¯ä»¥åœ¨é¡¹ç›®çš„ç›®å½•ä¸­åˆ›å»ºæ­¤æ–‡ä»¶, å½“å‰ç›®å½•ä¸‹å¦‚æœä¹Ÿæœ‰ansible.cfg,åˆ™æ­¤æ–‡ä»¶ä¼˜å…ˆç”Ÿæ•ˆ,å»ºè®®æ¯ä¸ªé¡¹ç›®ç›®å½•ä¸‹,åˆ›å»ºç‹¬æœ‰çš„ansible.cfgæ–‡  ä»¶</li><li>&#x2F;etc&#x2F;ansible&#x2F;hosts ä¸»æœºæ¸…å•</li><li>&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F; å­˜æ”¾è§’è‰²çš„ç›®å½•</li></ul><h3 id="4-2-ä¸»é…ç½®æ–‡ä»¶"><a href="#4-2-ä¸»é…ç½®æ–‡ä»¶" class="headerlink" title="4.2 ä¸»é…ç½®æ–‡ä»¶"></a>4.2 ä¸»é…ç½®æ–‡ä»¶</h3><p>Ansible çš„é…ç½®æ–‡ä»¶å¯ä»¥æ”¾åœ¨å¤šä¸ªä¸åŒåœ°æ–¹,ä¼˜å…ˆçº§ä»é«˜åˆ°ä½é¡ºåºå¦‚ä¸‹</p><pre class=" language-bash"><code class="language-bash">ANSIBLE_CONFIG            <span class="token comment" spellcheck="true">#ç¯å¢ƒå˜é‡</span>./ansible.cfg                    <span class="token comment" spellcheck="true">#å½“å‰ç›®å½•ä¸‹çš„ansible.cfg</span>~/.ansible.cfg                  <span class="token comment" spellcheck="true">#å½“å‰ç”¨æˆ·å®¶ç›®å½•ä¸‹çš„.ansible.cfg</span>/etc/ansible/ansible.cfg  <span class="token comment" spellcheck="true">#ç³»ç»Ÿé»˜è®¤é…ç½®æ–‡ä»¶</span></code></pre><p>Ansible çš„é»˜è®¤é…ç½®æ–‡ä»¶ &#x2F;etc&#x2F;ansible&#x2F;ansible.cfg ,å…¶ä¸­å¤§éƒ¨åˆ†çš„é…ç½®å†…å®¹æ— éœ€è¿›è¡Œä¿®æ”¹</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>defaults<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#inventory      = /etc/ansible/hosts        #ä¸»æœºåˆ—è¡¨é…ç½®æ–‡ä»¶</span><span class="token comment" spellcheck="true">#library        = /usr/share/my_modules/    #åº“æ–‡ä»¶å­˜æ”¾ç›®å½•</span><span class="token comment" spellcheck="true">#remote_tmp     = ~/.ansible/tmp              #ä¸´æ—¶pyå‘½ä»¤æ–‡ä»¶å­˜æ”¾åœ¨è¿œç¨‹ä¸»æœºçš„ç›®å½•</span><span class="token comment" spellcheck="true">#local_tmp      = ~/.ansible/tmp                  #æœ¬åœ°ä¸´æ—¶å‘½ä»¤æ‰§è¡Œç›®å½•</span><span class="token comment" spellcheck="true">#forks          = 5                                            #é»˜è®¤å¹¶å‘æ•°</span><span class="token comment" spellcheck="true">#sudo_user      = root                                   #é»˜è®¤é€Ÿåº¦ç”¨æˆ·</span><span class="token comment" spellcheck="true">#ask_sudo_pass = True                                 #æ¯æ¬¡æ‰§è¡Œansibleå‘½ä»¤æ˜¯å¦è¯¢é—®sshå¯†ç </span><span class="token comment" spellcheck="true">#host_key_checking = False                          #æ£€æŸ¥å¯¹åº”æœåŠ¡å™¨çš„host_key,å»ºè®®å–æ¶ˆæ­¤è¡Œæ³¨é‡Š,å®ç°ç¬¬ä¸€æ¬¡è¿æ¥è‡ªåŠ¨ä¿¡ä»»ç›®æ ‡ä¸»æœº</span><span class="token comment" spellcheck="true">#log_path = /var/log/ansible.log                  #å»ºè®®å¼€å¯ æ—¥å¿—æ–‡ä»¶å­˜æ”¾ç›®å½•</span><span class="token comment" spellcheck="true">#module_name = command                         #é»˜è®¤çš„æ¨¡å— å¯ä»¥ä¿®æ”¹ä¸ºshellæ¨¡å—</span> <span class="token punctuation">[</span>privilege_escalation<span class="token punctuation">]</span>                                     <span class="token comment" spellcheck="true">#æ™®é€šç”¨æˆ·ææƒé…ç½®</span><span class="token comment" spellcheck="true">#become=True </span><span class="token comment" spellcheck="true">#become_method=sudo </span><span class="token comment" spellcheck="true">#become_user=root</span><span class="token comment" spellcheck="true">#become_ask_pass=False</span></code></pre><h3 id="4-3-Ansibleç›¸å…³å·¥å…·"><a href="#4-3-Ansibleç›¸å…³å·¥å…·" class="headerlink" title="4.3 Ansibleç›¸å…³å·¥å…·"></a>4.3 Ansibleç›¸å…³å·¥å…·</h3><ul><li>&#x2F;usr&#x2F;bin&#x2F;ansibleä¸»ç¨‹åºï¼Œä¸´æ—¶å‘½ä»¤æ‰§è¡Œå·¥å…·</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-docæŸ¥çœ‹é…ç½®æ–‡æ¡£ï¼Œæ¨¡å—åŠŸèƒ½æŸ¥çœ‹å·¥å…·,ç›¸å½“äºman</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-playbookå®šåˆ¶è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œç¼–æ’å‰§æœ¬å·¥å…·,ç›¸å½“äºè„šæœ¬</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-pullè¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„å·¥å…·</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-vaultæ–‡ä»¶åŠ å¯†å·¥å…·</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-consoleåŸºäºConsoleç•Œé¢ä¸ç”¨æˆ·äº¤äº’çš„æ‰§è¡Œå·¥å…·</li><li>&#x2F;usr&#x2F;bin&#x2F;ansible-galaxyä¸‹è½½&#x2F;ä¸Šä¼ ä¼˜ç§€ä»£ç æˆ–Rolesæ¨¡å—çš„å®˜ç½‘å¹³å°</li></ul><h3 id="4-4-ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹"><a href="#4-4-ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="4.4 ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹"></a>4.4 ansibleå‘½ä»¤æ‰§è¡Œè¿‡ç¨‹</h3><ol><li>åŠ è½½è‡ªå·±çš„é…ç½®æ–‡ä»¶,é»˜è®¤&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</li><li>åŠ è½½è‡ªå·±å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚ï¼šcommand</li><li>é€šè¿‡ansibleå°†æ¨¡å—æˆ–å‘½ä»¤ç”Ÿæˆå¯¹åº”çš„ä¸´æ—¶pyæ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶ä¼ è¾“è‡³è¿œç¨‹æœåŠ¡å™¨çš„å¯¹åº”æ‰§è¡Œç”¨æˆ·$HOME&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-æ•°å­—&#x2F;XXX.PYæ–‡ä»¶</li><li>ç»™æ–‡ä»¶+xæ‰§è¡Œ</li><li>æ‰§è¡Œå¹¶è¿”å›ç»“æœ</li><li>åˆ é™¤ä¸´æ—¶pyæ–‡ä»¶ï¼Œé€€å‡º</li></ol><hr><h1 id="äº”-Ansibleå¸¸ç”¨æ¨¡å—"><a href="#äº”-Ansibleå¸¸ç”¨æ¨¡å—" class="headerlink" title="äº”. Ansibleå¸¸ç”¨æ¨¡å—"></a>äº”. Ansibleå¸¸ç”¨æ¨¡å—</h1><h3 id="5-1-Commandæ¨¡å—"><a href="#5-1-Commandæ¨¡å—" class="headerlink" title="5.1 Commandæ¨¡å—"></a>5.1 Commandæ¨¡å—</h3><p>åŠŸèƒ½ï¼šåœ¨è¿œç¨‹ä¸»æœºæ‰§è¡Œå‘½ä»¤ï¼Œæ­¤ä¸ºé»˜è®¤æ¨¡å—ï¼Œå¯å¿½ç•¥-mé€‰é¡¹</p><p>æ³¨æ„ï¼šæ­¤å‘½ä»¤ä¸æ”¯æŒ $VARNAME &lt; &gt; | ; &amp; ç­‰ï¼Œå¯èƒ½ç”¨shellæ¨¡å—å®ç°æ³¨æ„ï¼šæ­¤æ¨¡å—ä¸å…·æœ‰å¹‚ç­‰æ€§<br>èŒƒä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m command -a 'cat /etc/centos-release'</span>10.46.40.183 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>CentOS Linux release 7.6.1810 <span class="token punctuation">(</span>Core<span class="token punctuation">)</span> 10.46.74.222 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>CentOS Linux release 7.6.1810 <span class="token punctuation">(</span>Core<span class="token punctuation">)</span><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m command -a 'ls /root/'</span>10.46.74.222 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span><span class="token function">test</span>10.46.40.183 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span><span class="token function">test</span></code></pre><hr><h3 id="5-2-Shellæ¨¡å—"><a href="#5-2-Shellæ¨¡å—" class="headerlink" title="5.2 Shellæ¨¡å—"></a>5.2 Shellæ¨¡å—</h3><p>åŠŸèƒ½ï¼šå’Œcommandç›¸ä¼¼ï¼Œç”¨shellæ‰§è¡Œå‘½ä»¤,æ”¯æŒå„ç§ç¬¦å·,æ¯”å¦‚:*,$, &gt;</p><p>æ³¨æ„ï¼šæ­¤æ¨¡å—ä¸å…·æœ‰å¹‚ç­‰æ€§<br>èŒƒä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m shell -a 'echo $HOSTNAME'</span>10.46.40.183 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>node0210.46.74.222 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>node01<span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m shell -a "echo 'hello' > /root/test &amp;&amp; cat /root/test"</span>10.46.74.222 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>hello10.46.40.183 <span class="token operator">|</span> CHANGED <span class="token operator">|</span> rc<span class="token operator">=</span>0 <span class="token operator">>></span>hello</code></pre><hr><h3 id="5-3-Scriptæ¨¡å—"><a href="#5-3-Scriptæ¨¡å—" class="headerlink" title="5.3 Scriptæ¨¡å—"></a>5.3 Scriptæ¨¡å—</h3><p>åŠŸèƒ½ï¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šè¿è¡ŒansibleæœåŠ¡å™¨ä¸Šçš„è„šæœ¬(æ— éœ€æ‰§è¡Œæƒé™)</p><p>æ³¨æ„ï¼šæ­¤æ¨¡å—ä¸å…·æœ‰å¹‚ç­‰æ€§<br>èŒƒä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m script -a ./test.sh </span>10.46.74.222 <span class="token operator">|</span> CHANGED <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token string">"changed"</span><span class="token keyword">:</span> true,     <span class="token string">"rc"</span><span class="token keyword">:</span> 0,     <span class="token string">"stderr"</span><span class="token keyword">:</span> <span class="token string">"Shared connection to 10.46.74.222 closed.\r\n"</span>,     <span class="token string">"stderr_lines"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>        <span class="token string">"Shared connection to 10.46.74.222 closed."</span>    <span class="token punctuation">]</span>,     <span class="token string">"stdout"</span><span class="token keyword">:</span> <span class="token string">"10.46.74.222 \r\n"</span>,     <span class="token string">"stdout_lines"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>        <span class="token string">"10.46.74.222 "</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span>10.46.40.183 <span class="token operator">|</span> CHANGED <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token string">"changed"</span><span class="token keyword">:</span> true,     <span class="token string">"rc"</span><span class="token keyword">:</span> 0,     <span class="token string">"stderr"</span><span class="token keyword">:</span> <span class="token string">"Shared connection to 10.46.40.183 closed.\r\n"</span>,     <span class="token string">"stderr_lines"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>        <span class="token string">"Shared connection to 10.46.40.183 closed."</span>    <span class="token punctuation">]</span>,     <span class="token string">"stdout"</span><span class="token keyword">:</span> <span class="token string">"10.46.40.183 \r\n"</span>,     <span class="token string">"stdout_lines"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>        <span class="token string">"10.46.40.183 "</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><hr><h3 id="5-4-Copyæ¨¡å—"><a href="#5-4-Copyæ¨¡å—" class="headerlink" title="5.4 Copyæ¨¡å—"></a>5.4 Copyæ¨¡å—</h3><p>åŠŸèƒ½ï¼šä»ansibleæœåŠ¡å™¨ä¸»æ§ç«¯å¤åˆ¶æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœº</p><p>æ³¨æ„: src&#x3D;file å¦‚æœæ˜¯æ²¡æŒ‡æ˜è·¯å¾„,åˆ™ä¸ºå½“å‰ç›®å½•æˆ–å½“å‰ç›®å½•ä¸‹çš„filesç›®å½•ä¸‹çš„fileæ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -m copy -a "src=./test.sh dest=/root/test.sh owner=root </span><span class="token comment" spellcheck="true">#æŒ‡å®šå†…å®¹ï¼Œç›´æ¥ç”Ÿæˆç›®æ ‡æ–‡ä»¶</span><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible websrvs -m copy -a "content='test line1\ntest line2\n' dest=/tmp/test.txt"</span><span class="token comment" spellcheck="true">#å¤åˆ¶/etcç›®å½•è‡ªèº«,æ³¨æ„/etc/åé¢æ²¡æœ‰</span><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># /ansible websrvs -m copy -a "src=/etc dest=/backup"</span><span class="token comment" spellcheck="true">#å¤åˆ¶/etc/ä¸‹çš„æ–‡ä»¶ï¼Œä¸åŒ…æ‹¬/etc/ç›®å½•è‡ªèº«,æ³¨æ„/etc/åé¢æœ‰/ </span><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible websrvs -m copy -a "src=/etc/ dest=/backup"</span></code></pre><hr><h3 id="5-5-Ger-urlæ¨¡å—"><a href="#5-5-Ger-urlæ¨¡å—" class="headerlink" title="5.5 Ger_urlæ¨¡å—"></a>5.5 Ger_urlæ¨¡å—</h3><p>åŠŸèƒ½:  ç”¨äºå°†æ–‡ä»¶ä»httpã€httpsæˆ–ftpä¸‹è½½åˆ°è¢«ç®¡ç†æœºèŠ‚ç‚¹ä¸Š<br>å¸¸ç”¨å‚æ•°å¦‚ä¸‹ï¼š</p><pre class=" language-bash"><code class="language-bash">url: ä¸‹è½½æ–‡ä»¶çš„URL,æ”¯æŒHTTPï¼ŒHTTPSæˆ–FTPåè®®dest:  ä¸‹è½½åˆ°ç›®æ ‡è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„ï¼‰ï¼Œå¦‚æœç›®æ ‡æ˜¯ä¸€ä¸ªç›®å½•ï¼Œå°±ç”¨æœåŠ¡å™¨ä¸Šé¢æ–‡ä»¶çš„åç§°ï¼Œå¦‚æœç›®æ ‡è®¾ç½®äº†åç§°å°±ç”¨ç›®æ ‡è®¾ç½®çš„åç§°ownerï¼šæŒ‡å®šå±ä¸»groupï¼šæŒ‡å®šå±ç»„modeï¼šæŒ‡å®šæƒé™force:  å¦‚æœyesï¼Œdestä¸æ˜¯ç›®å½•ï¼Œå°†æ¯æ¬¡ä¸‹è½½æ–‡ä»¶ï¼Œå¦‚æœå†…å®¹æ”¹å˜ï¼Œæ›¿æ¢æ–‡ä»¶ã€‚å¦‚æœå¦ï¼Œåˆ™åªæœ‰åœ¨ç›®æ ‡ä¸å­˜åœ¨æ—¶æ‰ä¼šä¸‹è½½è¯¥æ–‡ä»¶checksum: å¯¹ç›®æ ‡æ–‡ä»¶åœ¨ä¸‹è½½åè®¡ç®—æ‘˜è¦ï¼Œä»¥ç¡®ä¿å…¶å®Œæ•´æ€§<span class="token comment" spellcheck="true">#ç¤º ä¾‹ : checksum="sha256:D98291AC[...]B6DC7B97", [checksum="sha256:http://example.com/path/sha256](http://example.com/path/sha256sum.txt)sum.txt"</span>url_username: ç”¨äºHTTPåŸºæœ¬è®¤è¯çš„ç”¨æˆ·åã€‚ å¯¹äºå…è®¸ç©ºå¯†ç çš„ç«™ç‚¹ï¼Œæ­¤å‚æ•°å¯ä»¥ä¸ä½¿ç”¨`url_password<span class="token string">'url_password: ç”¨äºHTTPåŸºæœ¬è®¤è¯çš„å¯†ç ã€‚ å¦‚æœæœªæŒ‡å®š`url_username'</span>å‚æ•°ï¼Œåˆ™ä¸ä¼šä½¿ç”¨`url_password'å‚æ•°validate_certsï¼šå¦‚æœâ€œnoâ€ï¼ŒSSLè¯ä¹¦å°†ä¸ä¼šè¢«éªŒè¯ã€‚ é€‚ç”¨äºè‡ªç­¾åè¯ä¹¦åœ¨ç§æœ‰ç½‘ç«™ä¸Šä½¿ç”¨timeout: URLè¯·æ±‚çš„è¶…æ—¶æ—¶é—´,ç§’ä¸ºå•ä½</code></pre><p>èŒƒä¾‹:</p><pre class=" language-bash"><code class="language-bash">ansible all -m get_url -a <span class="token string">'url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src/nginx.tar.gz'</span></code></pre><hr><h3 id="5-6-Fetchæ¨¡å—"><a href="#5-6-Fetchæ¨¡å—" class="headerlink" title="5.6 Fetchæ¨¡å—"></a>5.6 Fetchæ¨¡å—</h3><p>åŠŸèƒ½ï¼šä»è¿œç¨‹ä¸»æœºæå–æ–‡ä»¶è‡³ansibleçš„ä¸»æ§ç«¯ï¼Œcopyç›¸åï¼Œç›®å‰ä¸æ”¯æŒç›®å½•<br>èŒƒä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ansible all -mfetch -a 'src=/etc/redhat-release dest=/data/os'</span><span class="token punctuation">[</span>root@master ansible<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tree /data/os/</span>/data/os/â”œâ”€â”€ 10.46.40.183â”‚   â””â”€â”€ etcâ”‚       â””â”€â”€ redhat-releaseâ””â”€â”€ 10.46.74.222    â””â”€â”€ etc        â””â”€â”€ redhat-release4 directories, 2 files</code></pre><hr><h3 id="5-7-Fileæ¨¡å—"><a href="#5-7-Fileæ¨¡å—" class="headerlink" title="5.7 Fileæ¨¡å—"></a>5.7 Fileæ¨¡å—</h3><p>åŠŸèƒ½ï¼šè®¾ç½®æ–‡ä»¶å±æ€§,åˆ›å»ºè½¯é“¾æ¥ç­‰<br>èŒƒä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#åˆ›å»ºç©ºæ–‡ä»¶</span>ansible all -m <span class="token function">file</span> -a <span class="token string">'path=/data/test.txt state=touch'</span> ansible all -m <span class="token function">file</span> -a <span class="token string">'path=/data/test.txt state=absent'</span> ansible all -m <span class="token function">file</span> -a <span class="token string">"path=/root/test.sh owner=wang mode=755"</span> <span class="token comment" spellcheck="true">#åˆ›å»ºç›®å½•</span>ansible all -m <span class="token function">file</span> -a <span class="token string">"path=/data/mysql state=directory owner=mysql group=mysql"</span><span class="token comment" spellcheck="true">#åˆ›å»ºè½¯é“¾æ¥</span>ansible all -m <span class="token function">file</span> -a <span class="token string">'src=/data/testfilepath|dest|name=/data/testfile-link state=link'</span><span class="token comment" spellcheck="true">#åˆ›å»ºç›®å½•</span>ansible all -m <span class="token function">file</span> -a <span class="token string">'path=/data/testdir state=directory'</span><span class="token comment" spellcheck="true">#é€’å½’ä¿®æ”¹ç›®å½•å±æ€§,ä½†ä¸é€’å½’è‡³å­ç›®å½•</span>ansible all -m <span class="token function">file</span> -a <span class="token string">"path=/data/mysql state=directory owner=mysql group=mysql"</span><span class="token comment" spellcheck="true">#é€’å½’ä¿®æ”¹ç›®å½•åŠå­ç›®å½•çš„å±æ€§</span>ansible all -m <span class="token function">file</span> -a <span class="token string">"path=/data/mysql state=directory owner=mysql group=mysql recurse=yes"</span>``</code></pre><hr><h3 id="5-8-Unarchiveæ¨¡å—"><a href="#5-8-Unarchiveæ¨¡å—" class="headerlink" title="5.8 Unarchiveæ¨¡å—"></a>5.8 Unarchiveæ¨¡å—</h3><p>åŠŸèƒ½ï¼šè§£åŒ…è§£å‹ç¼©<br>å®ç°æœ‰ä¸¤ç§ç”¨æ³•ï¼š</p><ol><li>å°†ansibleä¸»æœºä¸Šçš„å‹ç¼©åŒ…ä¼ åˆ°è¿œç¨‹ä¸»æœºåè§£å‹ç¼©è‡³ç‰¹å®šç›®å½•ï¼Œè®¾ç½®copy&#x3D;yes</li><li>å°†è¿œç¨‹ä¸»æœºä¸Šçš„æŸä¸ªå‹ç¼©åŒ…è§£å‹ç¼©åˆ°æŒ‡å®šè·¯å¾„ä¸‹ï¼Œè®¾ç½®copy&#x3D;no<br>å¸¸è§å‚æ•°ï¼š</li></ol><pre class=" language-bash"><code class="language-bash">copyï¼šé»˜è®¤ä¸ºyesï¼Œå½“copy<span class="token operator">=</span>yesï¼Œæ‹·è´çš„æ–‡ä»¶æ˜¯ä»ansibleä¸»æœºå¤åˆ¶åˆ°è¿œç¨‹ä¸»æœºä¸Šï¼Œå¦‚æœè®¾ç½®ä¸ºcopy<span class="token operator">=</span>noï¼Œä¼šåœ¨è¿œç¨‹ä¸»æœºä¸Šå¯»æ‰¾srcæºæ–‡ä»¶remote_srcï¼šå’ŒcopyåŠŸèƒ½ä¸€æ ·ä¸”äº’æ–¥ï¼Œyesè¡¨ç¤ºåœ¨è¿œç¨‹ä¸»æœºï¼Œä¸åœ¨ansibleä¸»æœºï¼Œnoè¡¨ç¤ºæ–‡ä»¶åœ¨ansibleä¸»æœºä¸Šsrcï¼šæºè·¯å¾„ï¼Œå¯ä»¥æ˜¯ansibleä¸»æœºä¸Šçš„è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯è¿œç¨‹ä¸»æœº<span class="token punctuation">(</span>è¢«ç®¡ç†ç«¯æˆ–è€…ç¬¬ä¸‰æ–¹ä¸»æœº<span class="token punctuation">)</span>ä¸Šçš„è·¯å¾„ï¼Œå¦‚æœ  æ˜¯è¿œç¨‹ä¸»æœºä¸Šçš„è·¯å¾„ï¼Œåˆ™éœ€è¦è®¾ç½®copy<span class="token operator">=</span>nodestï¼šè¿œç¨‹ä¸»æœºä¸Šçš„ç›®æ ‡è·¯å¾„modeï¼šè®¾ç½®è§£å‹ç¼©åçš„æ–‡ä»¶æƒé™</code></pre><pre class=" language-bash"><code class="language-bash">ansible all -m unarchive -a <span class="token string">'src=/usr/local/src/nginx.tar.gz dest=/usr/local copy=no'</span>ansible all -m unarchive -a <span class="token string">'src=./file/nginx-1.18.0.tar.gz dest=/tmp copy=yes'</span></code></pre><hr><h3 id="5-9-Archiveæ¨¡å—"><a href="#5-9-Archiveæ¨¡å—" class="headerlink" title="5.9 Archiveæ¨¡å—"></a>5.9 Archiveæ¨¡å—</h3><p>åŠŸèƒ½ï¼šæ‰“åŒ…å‹ç¼©ä¿å­˜åœ¨è¢«ç®¡ç†èŠ‚ç‚¹<br>èŒƒä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash">ansible all -m archive -a <span class="token string">'path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=root mode=0600'</span></code></pre><hr><h3 id="5-10-Hostnameæ¨¡å—"><a href="#5-10-Hostnameæ¨¡å—" class="headerlink" title="5.10 Hostnameæ¨¡å—"></a>5.10 Hostnameæ¨¡å—</h3><p>åŠŸèƒ½ï¼šç®¡ç†ä¸»æœºå<br>èŒƒä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash">ansible node1 -m <span class="token function">hostname</span> -a <span class="token string">"name=websrv"</span>ansible 10.0.0.18 -m <span class="token function">hostname</span> -a <span class="token string">'name=huhuhahei'</span></code></pre><h3 id="5-11-Cronæ¨¡å—"><a href="#5-11-Cronæ¨¡å—" class="headerlink" title="5.11 Cronæ¨¡å—"></a>5.11 Cronæ¨¡å—</h3><p>åŠŸèƒ½ï¼šè®¡åˆ’ä»»åŠ¡</p><p>æ”¯æŒæ—¶é—´ï¼šminuteï¼Œhourï¼Œdayï¼Œmonthï¼Œweekday</p><p>èŒƒä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash">ansible all -m <span class="token function">cron</span> -a <span class="token string">"minute=* weekday=1,4,5 job='/usr/bin/wall warnging' name=warn"</span><span class="token comment" spellcheck="true">#ç¦ç”¨è®¡åˆ’ä»»åŠ¡</span>ansible all -m <span class="token function">cron</span> -a <span class="token string">"minute=* weekday=1,4,5 job='/usr/bin/wall warnging' name=warn disabled=yes"</span><span class="token comment" spellcheck="true">#åˆ é™¤è®¡åˆ’ä»»åŠ¡</span>ansible all -m <span class="token function">cron</span> -a <span class="token string">"state=absent name=warn"</span></code></pre><h3 id="5-12-Yumæ¨¡å—"><a href="#5-12-Yumæ¨¡å—" class="headerlink" title="5.12 Yumæ¨¡å—"></a>5.12 Yumæ¨¡å—</h3><p>åŠŸèƒ½ï¼š</p><p>yum ç®¡ç†è½¯ä»¶åŒ…ï¼Œåªæ”¯æŒRHELï¼ŒCentOSï¼Œfedoraï¼Œä¸æ”¯æŒUbuntuå…¶å®ƒç‰ˆæœ¬</p><p>apt æ¨¡å—ç®¡ç† Debian ç›¸å…³ç‰ˆæœ¬çš„è½¯ä»¶åŒ…</p><p>èŒƒä¾‹:</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å®‰è£…vsftpd</span>ansible all -m yum -a <span class="token string">"name=vsftpd"</span><span class="token comment" spellcheck="true">#å¸è½½</span>ansible all -m yum -a <span class="token string">"name=vsftpd state=absent"</span><span class="token comment" spellcheck="true">#å®‰è£…ç½‘ç»œä¸­çš„rpmåŒ…</span>ansible all -m yum -a <span class="token string">"name=https://mirror.tuna.tsinghua.edu.cn/zabbix/zabbix/5.2/rhel/7/x86_64/zabbix-agent-5.2.5-1.el7.x86_64.rpm validate_certs=no"</span><span class="token comment" spellcheck="true">#æ¸…é™¤ç¼“å­˜å®‰è£…è½¯ä»¶åŒ…</span>ansible all -m yum -a <span class="token string">"name=dstat update_cache=yes"</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹æ‰€æœ‰å®‰è£…åŒ…</span>ansible all -m yum -a <span class="token string">"list=installed"</span></code></pre><h3 id="5-13-Service-æ¨¡å—"><a href="#5-13-Service-æ¨¡å—" class="headerlink" title="5.13 Service æ¨¡å—"></a>5.13 Service æ¨¡å—</h3><p>åŠŸèƒ½ï¼šç®¡ç†æœåŠ¡<br>èŒƒä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å¯åŠ¨æœåŠ¡å¹¶å¼€æœºè‡ªå¯</span>ansible all -m <span class="token function">service</span> -a <span class="token string">"name=httpd state=started enabled=yes"</span><span class="token comment" spellcheck="true">#å…³é—­æœåŠ¡</span>ansible all -m <span class="token function">service</span> -a <span class="token string">"name=httpd state=stopped enabled=yes"</span></code></pre><h3 id="5-14-Useræ¨¡å—"><a href="#5-14-Useræ¨¡å—" class="headerlink" title="5.14 Useræ¨¡å—"></a>5.14 Useræ¨¡å—</h3><p>åŠŸèƒ½ï¼šç®¡ç†ç”¨æˆ·<br>èŒƒä¾‹:</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#åˆ›å»ºç”¨æˆ·</span>ansible all -m user -a <span class="token string">'name=user1 comment="test user" uid=2048 home=/app/user1 group=root'</span>ansible all -m user -a <span class="token string">'name=nginx comment=nginx uid=88 group=root groups="root,daemon" shell=/sbin/nologin system=yes create_home=no home=/data/nginx non_unique=yes'</span><span class="token comment" spellcheck="true">#åˆ é™¤ç”¨æˆ·</span>ansible all -m user -a <span class="token string">'name=nginx state=absent remove=yes'</span></code></pre><h3 id="5-15-Groupæ¨¡å—"><a href="#5-15-Groupæ¨¡å—" class="headerlink" title="5.15 Groupæ¨¡å—"></a>5.15 Groupæ¨¡å—</h3><p>åŠŸèƒ½ï¼šç®¡ç†ç»„<br>èŒƒä¾‹ï¼š</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#åˆ›å»ºç»„</span>ansible all -m group -a <span class="token string">'name=nginx gid=88 system=yes'</span><span class="token comment" spellcheck="true">#åˆ é™¤ç»„</span>ansible all -m group -a <span class="token string">'name=nginx state=absent'</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ansible </tag>
            
            <tag> DevOps </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ceph å—å­˜å‚¨ä½¿ç”¨</title>
      <link href="/e37d425d/"/>
      <url>/e37d425d/</url>
      
        <content type="html"><![CDATA[<h1 id="Cephå—å­˜å‚¨ä½¿ç”¨"><a href="#Cephå—å­˜å‚¨ä½¿ç”¨" class="headerlink" title="Cephå—å­˜å‚¨ä½¿ç”¨"></a>Cephå—å­˜å‚¨ä½¿ç”¨</h1><ul><li>åˆ›å»ºä¸€ä¸ªå­˜å‚¨å—</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rbd create mypool/rbd-demo1.img --size 10Gash<span class="token comment" spellcheck="true">#æŸ¥çœ‹</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rbd -p mypool <span class="token function">ls</span>rbd-demo.img<span class="token comment" spellcheck="true">#æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rbd info mypool/rbd-demo.imgrbd image <span class="token string">'rbd-demo.img'</span><span class="token keyword">:</span>    size 10 GiB <span class="token keyword">in</span> 2560 objects    order 22 <span class="token punctuation">(</span>4 MiB objects<span class="token punctuation">)</span>    id: 37bd6b8b4567    block_name_prefix: rbd_data.37bd6b8b4567    format: 2    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten    op_features:     flags:     create_timestamp: Sat Dec  4 18:51:43 2021<span class="token comment" spellcheck="true">#å»é™¤rbdè®¾å¤‡ç‰¹æ€§</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rbd feature disable ceph-demo/rbd-demo.img exclusive-lock</span><span class="token comment" spellcheck="true">#åˆ é™¤å—è®¾å¤‡</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rbd <span class="token function">rm</span> mypool/rbd-demo1.imgRemoving image: 100% complete<span class="token punctuation">..</span>.done.</code></pre><ul><li>å®¢æˆ·ç«¯æŒ‚è½½è®¾å¤‡</li></ul><p>å®¢æˆ·ç«¯éœ€è¦å®‰è£…cephç¨‹åº</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install ceph</span><span class="token comment" spellcheck="true">#æ‹·è´é…ç½®æ–‡ä»¶åˆ°å®¢æˆ·ç«¯</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy admin 10.46.8.18</span></code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æŒ‚è½½</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ <span class="token function">sudo</span> rbd map mypool/rbd-demo.img/dev/rbd0<span class="token comment" spellcheck="true">#æŸ¥çœ‹è®¾å¤‡</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ rbd device list<span class="token function">id</span> pool   image        snap device    0  mypool rbd-demo.img -    /dev/rbd0 <span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ lsblk NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINTrbd0   252:0    0  10G  0 disk vda    253:0    0  40G  0 disk â””â”€vda1 253:1    0  40G  0 part /<span class="token comment" spellcheck="true">#æ ¼å¼åŒ–æŒ‚è½½ä½¿ç”¨</span><span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ <span class="token function">sudo</span> mkfs.xfs /dev/rbd0meta-data<span class="token operator">=</span>/dev/rbd0              isize<span class="token operator">=</span>512    agcount<span class="token operator">=</span>16, agsize<span class="token operator">=</span>163840 blks         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>512   attr<span class="token operator">=</span>2, projid32bit<span class="token operator">=</span>1         <span class="token operator">=</span>                       crc<span class="token operator">=</span>1        finobt<span class="token operator">=</span>0, sparse<span class="token operator">=</span>0data     <span class="token operator">=</span>                       bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2621440, imaxpct<span class="token operator">=</span>25         <span class="token operator">=</span>                       sunit<span class="token operator">=</span>1024   swidth<span class="token operator">=</span>1024 blksnaming   <span class="token operator">=</span>version 2              bsize<span class="token operator">=</span>4096   ascii-ci<span class="token operator">=</span>0 ftype<span class="token operator">=</span>1log      <span class="token operator">=</span>internal log           bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2560, version<span class="token operator">=</span>2         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>512   sunit<span class="token operator">=</span>8 blks, lazy-count<span class="token operator">=</span>1realtime <span class="token operator">=</span>none                   extsz<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>0, rtextents<span class="token operator">=</span>0<span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">mkdir</span> /mnt/rbd-demo<span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">mount</span> /dev/rbd0 /mnt/rbd-demo<span class="token punctuation">[</span>cephadm@ceph-admin ceph-cluster<span class="token punctuation">]</span>$ <span class="token function">df</span> -ThFilesystem     Type      Size  Used Avail Use% Mounted ondevtmpfs       devtmpfs  947M     0  947M   0% /devtmpfs          tmpfs     959M     0  959M   0% /dev/shmtmpfs          tmpfs     959M   17M  943M   2% /runtmpfs          tmpfs     959M     0  959M   0% /sys/fs/cgroup/dev/vda1      xfs        40G  2.1G   38G   6% /tmpfs          tmpfs     192M     0  192M   0% /run/user/0/dev/rbd0      xfs        10G   33M   10G   1% /mnt/rbd-demo<span class="token comment" spellcheck="true">#æµ‹è¯•è¯»å†™</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># echo "huhuhahei" > test</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test</span>huhuhahei</code></pre><ul><li>å—è®¾å¤‡æ‰©å®¹</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rbd resize mypool/rbd-demo.img --size 20G</span>Resizing image: 100% complete<span class="token punctuation">..</span>.done.<span class="token comment" spellcheck="true">#æŸ¥çœ‹å·²ç»æ‰©å®¹ç”Ÿæ•ˆ</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rbd info mypool/rbd-demo.img</span>rbd image <span class="token string">'rbd-demo.img'</span><span class="token keyword">:</span>    size 20 GiB <span class="token keyword">in</span> 5120 objects    order 22 <span class="token punctuation">(</span>4 MiB objects<span class="token punctuation">)</span>    id: 37bd6b8b4567    block_name_prefix: rbd_data.37bd6b8b4567    format: 2    features: layering    op_features:     flags:     create_timestamp: Sat Dec  4 18:51:43 2021<span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># lsblk </span>NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINTrbd0   252:0    0  20G  0 disk /mnt/rbd-demovda    253:0    0  40G  0 disk â””â”€vda1 253:1    0  40G  0 part /<span class="token comment" spellcheck="true">#ä½†æ˜¯æ–‡ä»¶ç³»ç»Ÿæ²¡æœ‰å¢åŠ  è¿˜æ˜¯10G</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -h</span>Filesystem      Size  Used Avail Use% Mounted ondevtmpfs        947M     0  947M   0% /devtmpfs           959M     0  959M   0% /dev/shmtmpfs           959M   17M  943M   2% /runtmpfs           959M     0  959M   0% /sys/fs/cgroup/dev/vda1        40G  2.1G   38G   6% /tmpfs           192M     0  192M   0% /run/user/0/dev/rbd0        10G   33M   10G   1% /mnt/rbd-demo<span class="token comment" spellcheck="true">#ä½¿ç”¨xfs_growfsæ‰©å®¹xfsæ–‡ä»¶ç³»ç»Ÿ</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># xfs_growfs /dev/rbd0</span>meta-data<span class="token operator">=</span>/dev/rbd0              isize<span class="token operator">=</span>512    agcount<span class="token operator">=</span>16, agsize<span class="token operator">=</span>163840 blks         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>512   attr<span class="token operator">=</span>2, projid32bit<span class="token operator">=</span>1         <span class="token operator">=</span>                       crc<span class="token operator">=</span>1        finobt<span class="token operator">=</span>0 spinodes<span class="token operator">=</span>0data     <span class="token operator">=</span>                       bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2621440, imaxpct<span class="token operator">=</span>25         <span class="token operator">=</span>                       sunit<span class="token operator">=</span>1024   swidth<span class="token operator">=</span>1024 blksnaming   <span class="token operator">=</span>version 2              bsize<span class="token operator">=</span>4096   ascii-ci<span class="token operator">=</span>0 ftype<span class="token operator">=</span>1log      <span class="token operator">=</span>internal               bsize<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>2560, version<span class="token operator">=</span>2         <span class="token operator">=</span>                       sectsz<span class="token operator">=</span>512   sunit<span class="token operator">=</span>8 blks, lazy-count<span class="token operator">=</span>1realtime <span class="token operator">=</span>none                   extsz<span class="token operator">=</span>4096   blocks<span class="token operator">=</span>0, rtextents<span class="token operator">=</span>0data blocks changed from 2621440 to 5242880<span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -Th</span>Filesystem     Type      Size  Used Avail Use% Mounted ondevtmpfs       devtmpfs  947M     0  947M   0% /devtmpfs          tmpfs     959M     0  959M   0% /dev/shmtmpfs          tmpfs     959M   17M  943M   2% /runtmpfs          tmpfs     959M     0  959M   0% /sys/fs/cgroup/dev/vda1      xfs        40G  2.1G   38G   6% /tmpfs          tmpfs     192M     0  192M   0% /run/user/0/dev/rbd0      xfs        20G   34M   20G   1% /mnt/rbd-demo<span class="token comment" spellcheck="true">#æŸ¥çœ‹å·²ç»æ‰©å®¹å®Œæˆ 20G</span></code></pre><ul><li>HEALTH_WARNä¿®å¤</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph -s</span>  cluster:    id:     b5fa13e6-6b7f-4eeb-bac3-a7b6bc535109    health: HEALTH_WARN            application not enabled on 1 pool<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#è¿™ä¸ªæŠ¥é”™æ˜¯ä¹‹å‰åˆ›å»ºå—è®¾å¤‡æ²¡æœ‰æŒ‡å®šç±»å‹ </span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool application enable mypool rbd</span>enabled application <span class="token string">'rbd'</span> on pool <span class="token string">'mypool'</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool application get mypool</span><span class="token punctuation">{</span>    <span class="token string">"rbd"</span><span class="token keyword">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</span><span class="token punctuation">[</span>root@ceph-admin rbd-demo<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph health detail</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ceph å¯¹è±¡å­˜å‚¨ä½¿ç”¨</title>
      <link href="/ef7636ef/"/>
      <url>/ef7636ef/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-é…ç½®Radosgw"><a href="#ä¸€-é…ç½®Radosgw" class="headerlink" title="ä¸€.é…ç½®Radosgw"></a>ä¸€.é…ç½®Radosgw</h1><h3 id="1-1-åˆ›å»ºradosgw"><a href="#1-1-åˆ›å»ºradosgw" class="headerlink" title="1.1 åˆ›å»ºradosgw"></a>1.1 åˆ›å»ºradosgw</h3><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy rgw create node-1</span>---nts/ceph-radosgw@rgw.node-1.service to /usr/lib/systemd/system/ceph-radosgw@.service.<span class="token punctuation">[</span>node-1<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: systemctl start ceph-radosgw@rgw.node-1<span class="token punctuation">[</span>node-1<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: systemctl <span class="token function">enable</span> ceph.target<span class="token punctuation">[</span>ceph_deploy.rgw<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> The Ceph Object Gateway <span class="token punctuation">(</span>RGW<span class="token punctuation">)</span> is now running on host node-1 and default port 7480<span class="token comment" spellcheck="true">#è®¿é—®url </span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># curl http://node-1:7480</span><span class="token operator">&lt;</span>?xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span>?<span class="token operator">></span><span class="token operator">&lt;</span>ListAllMyBucketsResult xmlns<span class="token operator">=</span><span class="token string">"http://s3.amazonaws.com/doc/2006-03-01/"</span><span class="token operator">></span><span class="token operator">&lt;</span>Owner<span class="token operator">></span><span class="token operator">&lt;</span>ID<span class="token operator">></span>anonymous<span class="token operator">&lt;</span>/ID<span class="token operator">></span><span class="token operator">&lt;</span>DisplayName<span class="token operator">></span><span class="token operator">&lt;</span>/DisplayName<span class="token operator">></span><span class="token operator">&lt;</span>/Owner<span class="token operator">></span><span class="token operator">&lt;</span>Buckets<span class="token operator">></span><span class="token operator">&lt;</span>/Buckets<span class="token operator">></span><span class="token operator">&lt;</span>/ListAllMyBucketsResult<span class="token operator">></span><span class="token comment" spellcheck="true">#å¯ä»¥æ­£å¸¸æ‰“å¼€è¯æ˜å®‰è£…æ²¡æœ‰é—®é¢˜</span></code></pre><h3 id="1-2-ä¿®æ”¹radosgwè®¿é—®ç«¯å£"><a href="#1-2-ä¿®æ”¹radosgwè®¿é—®ç«¯å£" class="headerlink" title="1.2 ä¿®æ”¹radosgwè®¿é—®ç«¯å£"></a>1.2 ä¿®æ”¹radosgwè®¿é—®ç«¯å£</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ä¿®æ”¹é…ç½®æ–‡ä»¶ æ·»åŠ </span><span class="token punctuation">[</span>client.rgw.node-1<span class="token punctuation">]</span>rgw_frontends <span class="token operator">=</span> <span class="token string">"civetweb port=80"</span><span class="token comment" spellcheck="true">#æ‹·è´é…ç½®æ–‡ä»¶åˆ°å…¶ä»–èŠ‚ç‚¹</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy --overwrite-conf config push node-1 node-2 node-3 </span><span class="token comment" spellcheck="true">#é‡å¯æœåŠ¡</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl restart ceph-radosgw.target </span><span class="token comment" spellcheck="true">#ç¡®è®¤æ˜¯å¦ç”Ÿæ•ˆ</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># netstat -anpt | grep :80</span>tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      40358/radosgw</code></pre><h1 id="äºŒ-ä½¿ç”¨s3æ–¹å¼è®¿é—®ceph"><a href="#äºŒ-ä½¿ç”¨s3æ–¹å¼è®¿é—®ceph" class="headerlink" title="äºŒ.ä½¿ç”¨s3æ–¹å¼è®¿é—®ceph"></a>äºŒ.ä½¿ç”¨s3æ–¹å¼è®¿é—®ceph</h1><h3 id="2-1-ä½¿ç”¨sdkè®¿é—®"><a href="#2-1-ä½¿ç”¨sdkè®¿é—®" class="headerlink" title="2.1 ä½¿ç”¨sdkè®¿é—®"></a>2.1 ä½¿ç”¨sdkè®¿é—®</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#åˆ›å»ºç”¨æˆ·</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># radosgw-admin user create --uid ceph-s3-user --display-name "Ceph S3 User Demo"</span><span class="token comment" spellcheck="true">#ç¼–å†™python sdk</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install python-boto</span><span class="token function">import</span> boto.s3.connectionaccess_key <span class="token operator">=</span> <span class="token string">'HWOT3KMNOG1V2xxxxxx'</span>secret_key <span class="token operator">=</span> <span class="token string">'7GxvrRfevA5cyiOy207J2Sn5RmIdoYyP7kixxxx'</span>conn <span class="token operator">=</span> boto.connect_s3<span class="token punctuation">(</span>        aws_access_key_id<span class="token operator">=</span>access_key,        aws_secret_access_key<span class="token operator">=</span>secret_key,        host<span class="token operator">=</span><span class="token string">'10.46.36.234'</span>, port<span class="token operator">=</span>80,        is_secure<span class="token operator">=</span>False, calling_format<span class="token operator">=</span>boto.s3.connection.OrdinaryCallingFormat<span class="token punctuation">(</span><span class="token punctuation">)</span>,       <span class="token punctuation">)</span>bucket <span class="token operator">=</span> conn.create_bucket<span class="token punctuation">(</span><span class="token string">'ceph-s3-bucket'</span><span class="token punctuation">)</span><span class="token keyword">for</span> bucket <span class="token keyword">in</span> conn.get_all_buckets<span class="token punctuation">(</span><span class="token punctuation">)</span>:    print <span class="token string">"{name} {created}"</span>.format<span class="token punctuation">(</span>        name<span class="token operator">=</span>bucket.name,        created<span class="token operator">=</span>bucket.creation_date,    <span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æ‰§è¡Œ</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># python s3client.py </span>ceph-s3-bucket 2021-12-05T06:17:12.784Z<span class="token comment" spellcheck="true">#ä¸Šä¼ æ–‡ä»¶ä¹Ÿæ˜¯éœ€è¦ç¼–å†™sdkä¸Šä¼ ,ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ æˆ‘ä»¬æ˜¯ç”¨ç¬¬äºŒç§æ–¹æ³•</span></code></pre><h3 id="2-2-s3cmdè®¿é—®"><a href="#2-2-s3cmdè®¿é—®" class="headerlink" title="2.2 s3cmdè®¿é—®"></a>2.2 s3cmdè®¿é—®</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å®‰è£…s3cmdå·¥å…·</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install s3cmd</span><span class="token comment" spellcheck="true">#é…ç½®</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd --configure</span>Enter new values or accept defaults <span class="token keyword">in</span> brackets with Enter.Refer to user manual <span class="token keyword">for</span> detailed description of all options.Access key and Secret key are your identifiers <span class="token keyword">for</span> Amazon S3. Leave them empty <span class="token keyword">for</span> using the <span class="token function">env</span> variables.Access Key: HWOT3KMNOG1xxxxxxxx Secret Key: 7GxvrRfevA5cyiOy207J2Sn5RmIxxxxxxxxDefault Region <span class="token punctuation">[</span>US<span class="token punctuation">]</span>: Use <span class="token string">"s3.amazonaws.com"</span> <span class="token keyword">for</span> S3 Endpoint and not modify it to the target Amazon S3.S3 Endpoint <span class="token punctuation">[</span>s3.amazonaws.com<span class="token punctuation">]</span>: 10.46.36.234Use <span class="token string">"%(bucket)s.s3.amazonaws.com"</span> to the target Amazon S3. <span class="token string">"%(bucket)s"</span> and <span class="token string">"%(location)s"</span> vars can be used<span class="token keyword">if</span> the target S3 system supports dns based buckets.DNS-style bucket+hostname:port template <span class="token keyword">for</span> accessing a bucket <span class="token punctuation">[</span>%<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>s.s3.amazonaws.com<span class="token punctuation">]</span>: 10.46.36.234:80/%<span class="token punctuation">(</span>bucket<span class="token punctuation">)</span>s       Encryption password is used to protect your files from readingby unauthorized persons <span class="token keyword">while</span> <span class="token keyword">in</span> transfer to S3Encryption password: Path to GPG program <span class="token punctuation">[</span>/usr/bin/gpg<span class="token punctuation">]</span>: When using secure HTTPS protocol all communication with Amazon S3servers is protected from 3rd party eavesdropping. This method isslower than plain HTTP, and can only be proxied with Python 2.7 or newerUse HTTPS protocol <span class="token punctuation">[</span>Yes<span class="token punctuation">]</span>: noOn some networks all internet access must go through a HTTP proxy.Try setting it here <span class="token keyword">if</span> you can<span class="token string">'t connect to S3 directlyHTTP Proxy server name: New settings:  Access Key: HWOT3KMNOG1V2Txxxxx  Secret Key: 7GxvrRfevA5cyiOy207J2Snxxxxxxx  Default Region: US  S3 Endpoint: 10.46.36.234  DNS-style bucket+hostname:port template for accessing a bucket: 10.46.36.234:80/%(bucket)s  Encryption password:   Path to GPG program: /usr/bin/gpg  Use HTTPS protocol: False  HTTP Proxy server name:   HTTP Proxy server port: 0Test access with supplied credentials? [Y/n] yPlease wait, attempting to list all buckets...Success. Your access key and secret key worked fine :-)Now verifying that encryption works...Not configured. Never mind.Save settings? [y/N] yConfiguration saved to '</span>/root/.s3cfg'</code></pre><p>s3cmdå¸¸ç”¨å‘½ä»¤</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æŸ¥çœ‹ç›®å‰çš„bucket</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd ls</span>2021-12-05 06:17  s3://ceph-s3-bucket<span class="token comment" spellcheck="true">#åˆ›å»ºbucket</span><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd mb s3://s3cmd-demo</span>ERROR: S3 error: 403 <span class="token punctuation">(</span>SignatureDoesNotMatch<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#å¦‚æœæœ‰ä¸‹é¢æŠ¥é”™ éœ€è¦ä¿®æ”¹s3cmdé…ç½®æ–‡ä»¶</span>signature_v2 <span class="token operator">=</span> True<span class="token comment" spellcheck="true">#å°†æ­¤é…ç½®å¼€å¯</span><span class="token comment" spellcheck="true">#æµ‹è¯•ä¸Šä¼ æ–‡ä»¶</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd  put /etc/hosts s3://s3cmd-demo/hosts</span>upload: <span class="token string">'/etc/hosts'</span> -<span class="token operator">></span> <span class="token string">'s3://s3cmd-demo/hosts'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span> 266 of 266   100% <span class="token keyword">in</span>    0s    15.60 KB/s  <span class="token keyword">done</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹æ–‡ä»¶</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd ls s3://s3cmd-demo</span>2021-12-05 06:49          380  s3://s3cmd-demo/fstab2021-12-05 06:50          266  s3://s3cmd-demo/hosts<span class="token comment" spellcheck="true">#ä¸Šä¼ ç›®å½•</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd  put /etc s3://s3cmd-demo/etc/ --recursive</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹ç›®å½•æ–‡ä»¶</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd ls s3://s3cmd-demo/etc/etc/</span><span class="token comment" spellcheck="true">#ä¸‹è½½æ–‡ä»¶</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd get s3://s3cmd-demo/etc/etc/yum.conf yum.download</span>download: <span class="token string">'s3://s3cmd-demo/etc/etc/yum.conf'</span> -<span class="token operator">></span> <span class="token string">'yum.download'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span> 1066 of 1066   100% <span class="token keyword">in</span>    0s    65.45 KB/s  <span class="token keyword">done</span><span class="token comment" spellcheck="true">#åˆ é™¤æ–‡ä»¶</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd rm --recursive s3://s3cmd-demo/etc/</span></code></pre><p>#æ³¨ å¦‚æœæœ‰æµ‹è¯•ä¸Šä¼ æŠ¥é”™ 416 å¯ä»¥å‚è€ƒä¸‹é¢çš„æ–¹æ³•ä¿®å¤</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node-1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># s3cmd put /etc/fstab s3://s3cmd-demo/fstab</span>upload: <span class="token string">'/etc/fstab'</span> -<span class="token operator">></span> <span class="token string">'s3://s3cmd-demo/fstab'</span>  <span class="token punctuation">[</span>1 of 1<span class="token punctuation">]</span>380 of 380   100% <span class="token keyword">in</span>    0s   800.52 B/s  <span class="token keyword">done</span>ERROR: S3 error: 416 <span class="token punctuation">(</span>InvalidRange<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#ä¿®æ”¹é…ç½®æ–‡ä»¶globalæ·»åŠ </span>mon_max_pg_per_osd <span class="token operator">=</span> 300<span class="token comment" spellcheck="true">#å°†é…ç½®æ–‡ä»¶åˆ†å‘å…¶ä»–èŠ‚ç‚¹</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy --overwrite-conf config push node-1 node-2 node-3</span><span class="token comment" spellcheck="true">#é‡å¯monå’Œmgrè¿›ç¨‹æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦é‡å¯</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl restart ceph-mgr@node-1</span><span class="token punctuation">[</span>root@node-1 ceph-deploy<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl restart ceph-mon@node-1</span><span class="token comment" spellcheck="true">#å†æ¬¡æµ‹è¯•åº”è¯¥å°±å¯ä»¥æ­£å¸¸ä¸Šä¼ äº†</span></code></pre><h1 id="ä¸‰-ä½¿ç”¨swiftæ–¹å¼è®¿é—®ceph"><a href="#ä¸‰-ä½¿ç”¨swiftæ–¹å¼è®¿é—®ceph" class="headerlink" title="ä¸‰.ä½¿ç”¨swiftæ–¹å¼è®¿é—®ceph"></a>ä¸‰.ä½¿ç”¨swiftæ–¹å¼è®¿é—®ceph</h1><h3 id="3-1-é…ç½®swift"><a href="#3-1-é…ç½®swift" class="headerlink" title="3.1 é…ç½®swift"></a>3.1 é…ç½®swift</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æ ¹æ®ä¹‹å‰çš„ç”¨æˆ·åˆ›å»ºswiftç”¨æˆ·</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># radosgw-admin subuser create --uid ceph-s3-user  --subuser=ceph-s3-user:swift --access=full</span><span class="token comment" spellcheck="true">#åˆ›å»ºå…¬ç§é’¥</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># radosgw-admin key create --subuser=ceph-s3-user:swift --key-type=swift --gen-secret</span><span class="token comment" spellcheck="true">#å®‰è£…swiftå®¢æˆ·ç«¯å·¥å…·</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install python-pip</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># pip install --upgrade python-swiftclient</span></code></pre><h3 id="3-2-swiftå®¢æˆ·ç«¯ä½¿ç”¨"><a href="#3-2-swiftå®¢æˆ·ç«¯ä½¿ç”¨" class="headerlink" title="3.2 swiftå®¢æˆ·ç«¯ä½¿ç”¨"></a>3.2 swiftå®¢æˆ·ç«¯ä½¿ç”¨</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ç›´æ¥è®¿é—®</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift -A http://10.46.36.234/auth -U ceph-s3-user:swift -K SgNvHZvkjpDIHudg281qb3rbA33DJd39UoCYnHbl list</span><span class="token comment" spellcheck="true">#ç›´æ¥è®¿é—®å‚æ•°æ¯”è¾ƒå¤š æ¯”è¾ƒéº»çƒ¦å¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡è®¿é—®</span><span class="token function">export</span> ST_AUTH<span class="token operator">=</span>http://10.46.36.234/auth<span class="token function">export</span> ST_USER<span class="token operator">=</span>ceph-s3-user:swift<span class="token function">export</span> ST_KEY<span class="token operator">=</span>SgNvHZvkjpDIHudg281qb3rbA33DJd39UoCYnHbl<span class="token comment" spellcheck="true">#ç›´æ¥å‘½ä»¤è®¿é—®</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift list</span>ceph-s3-buckets3cmd-demo<span class="token comment" spellcheck="true">#åˆ›å»ºbucket</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift post swift-demo</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift list</span>ceph-s3-buckets3cmd-demoswift-dem<span class="token comment" spellcheck="true">#ä¸Šä¼ æ–‡ä»¶</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift upload swift-demo/hosts /etc/hosts</span>hosts/etc/hosts<span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift list swift-demo </span>hosts/etc/hosts<span class="token comment" spellcheck="true">#ä¸Šä¼ æ–‡ä»¶å¤¹</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift upload swift-demo/etc/ /etc</span><span class="token comment" spellcheck="true">#ä¸‹è½½æ–‡ä»¶</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift download swift-demo etc/etc/passwd </span>etc/etc/passwd <span class="token punctuation">[</span>auth 0.004s, headers 0.007s, total 0.007s, 0.336 MB/s<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#åˆ é™¤æ–‡ä»¶</span><span class="token punctuation">[</span>root@node-1 etc<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># swift delete swift-demo etc/etc/yum.repos.d/CentOS-fasttrack.repo</span>etc/etc/yum.repos.d/CentOS-fasttrack.repo</code></pre>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ceph æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨</title>
      <link href="/bff996ef/"/>
      <url>/bff996ef/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-é…ç½®filesystem"><a href="#ä¸€-é…ç½®filesystem" class="headerlink" title="ä¸€.é…ç½®filesystem"></a>ä¸€.é…ç½®filesystem</h1><h3 id="1-1-é…ç½®mdsæœåŠ¡"><a href="#1-1-é…ç½®mdsæœåŠ¡" class="headerlink" title="1.1 é…ç½®mdsæœåŠ¡"></a>1.1 é…ç½®mdsæœåŠ¡</h3><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-deploy mds create node</span>---<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">[</span>WARNIN<span class="token punctuation">]</span> Created symlink from /etc/systemd/system/ceph-mds.target.wants/ceph-mds@node.service to /usr/lib/systemd/system/ceph-mds@.service.<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: systemctl start ceph-mds@node<span class="token punctuation">[</span>node<span class="token punctuation">]</span><span class="token punctuation">[</span>INFO  <span class="token punctuation">]</span> Running command: systemctl <span class="token function">enable</span> ceph.target</code></pre><h3 id="1-2-åˆ›å»ºpool"><a href="#1-2-åˆ›å»ºpool" class="headerlink" title="1.2 åˆ›å»ºpool"></a>1.2 åˆ›å»ºpool</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#éœ€è¦åˆ›å»ºä¸¤ä¸ªpoolåˆ†åˆ«å­˜å‚¨metadataå’Œdata</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool create cephfs_metadata 16 16</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool create cephfs_data 10 10</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹pool</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph osd pool ls</span>huhuhahei.rgw.rootdefault.rgw.controldefault.rgw.metadefault.rgw.logdefault.rgw.buckets.indexdefault.rgw.buckets.datacephfs_metadatacephfs_data<span class="token comment" spellcheck="true">#åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph fs new cephfs-demo cephfs_metadata cephfs_data</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph fs ls</span>name: cephfs-demo, metadata pool: cephfs_metadata, data pools: <span class="token punctuation">[</span>cephfs_data <span class="token punctuation">]</span></code></pre><h3 id="1-3-å†…æ ¸æ€æŒ‚è½½"><a href="#1-3-å†…æ ¸æ€æŒ‚è½½" class="headerlink" title="1.3 å†…æ ¸æ€æŒ‚è½½"></a>1.3 å†…æ ¸æ€æŒ‚è½½</h3><p>å®¢æˆ·ç«¯éœ€è¦è¿™ä¸ªåŒ… å¯ä»¥yumå®‰è£…</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rpm -qf /usr/sbin/mount.ceph</span>ceph-common-14.2.22-0.el7.x86_64</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#åˆ›å»ºç›®å½•æŒ‚è½½</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /cephfs</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mount -t ceph master:6789:/ /cephfs -o name=admin</span><span class="token comment" spellcheck="true">#ç¡®è®¤</span><span class="token punctuation">[</span>root@master ceph-cluster<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -Th</span>/dev/rbd1         xfs        10G   87M   10G   1% /backup10.46.8.18:6789:/ ceph       47G     0   47G   0% /cephfs<span class="token comment" spellcheck="true">#è¿™é‡Œé»˜è®¤çš„ç©ºé—´å¤§å°å°±æ˜¯cephé›†ç¾¤çš„æ€»ç©ºé—´</span></code></pre><h3 id="1-4-ç”¨æˆ·æ€æŒ‚è½½"><a href="#1-4-ç”¨æˆ·æ€æŒ‚è½½" class="headerlink" title="1.4 ç”¨æˆ·æ€æŒ‚è½½"></a>1.4 ç”¨æˆ·æ€æŒ‚è½½</h3><p>éœ€è¦å®‰è£…åŒ…</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master cephfuse<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install ceph-fuse</span><span class="token punctuation">[</span>root@master cephfuse<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># rpm -qa ceph-fuse</span>ceph-fuse-14.2.22-0.el7.x86_64<span class="token comment" spellcheck="true">#æŒ‚è½½</span><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /cephfuse</span><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ceph-fuse -n client.admin -m node:6789 /cephfuse</span>ceph-fuse<span class="token punctuation">[</span>3688325<span class="token punctuation">]</span>: starting ceph client2021-12-06 14:58:36.599 7fb6268e0f80 -1 init, newargv <span class="token operator">=</span> 0x556cff6153e0 newargc<span class="token operator">=</span>9<span class="token comment" spellcheck="true">#æŸ¥çœ‹</span><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># df -h</span>/dev/rbd1           10G   87M   10G   1% /backup10.46.8.18:6789:/   47G     0   47G   0% /cephfsceph-fuse           47G     0   47G   0% /cephfuse<span class="token comment" spellcheck="true">#ä¹‹å‰æŒ‚è½½çš„æ–‡ä»¶ä¹Ÿæ˜¯å…±äº«çš„</span><span class="token punctuation">[</span>root@master cephfuse<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll</span>total 1-rw-r--r-- 1 root root 10 Dec  6 14:50 <span class="token function">test</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rabbitmqå•èŠ‚ç‚¹å®‰è£…é…ç½®</title>
      <link href="/35052cd1/"/>
      <url>/35052cd1/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ç®€ä»‹"><a href="#ä¸€-ç®€ä»‹" class="headerlink" title="ä¸€. ç®€ä»‹"></a>ä¸€. ç®€ä»‹</h1><h3 id="1-1-RabbitMQä»‹ç»"><a href="#1-1-RabbitMQä»‹ç»" class="headerlink" title="1.1 RabbitMQä»‹ç»"></a>1.1 RabbitMQä»‹ç»</h3><p>æ¶ˆæ¯ç³»ç»Ÿé€šè¿‡å°†æ¶ˆæ¯çš„å‘é€å’Œæ¥æ”¶åˆ†ç¦»æ¥å®ç°åº”ç”¨ç¨‹åºçš„å¼‚æ­¥å’Œè§£å¶ã€‚<br>æˆ–è®¸ä½ æ­£åœ¨è€ƒè™‘è¿›è¡Œæ•°æ®æŠ•é€’ï¼Œéé˜»å¡æ“ä½œæˆ–æ¨é€é€šçŸ¥ã€‚æˆ–è®¸ä½ æƒ³è¦å®ç°å‘å¸ƒï¼è®¢é˜…ï¼Œå¼‚æ­¥å¤„ç†ï¼Œæˆ–è€…å·¥ä½œé˜Ÿåˆ—ã€‚æ‰€æœ‰è¿™äº›éƒ½å±äºæ¶ˆæ¯ç³»ç»Ÿçš„æ¨¡å¼ã€‚<br>RabbitMQæ˜¯ä¸€ä¸ªæ¶ˆæ¯ä»£ç†ï¼Œä¸€ä¸ªæ¶ˆæ¯ç³»ç»Ÿçš„åª’ä»‹ã€‚å®ƒå¯ä»¥ä¸ºä½ çš„åº”ç”¨æä¾›ä¸€ä¸ªé€šç”¨çš„æ¶ˆæ¯å‘é€å’Œæ¥æ”¶å¹³å°ï¼Œå¹¶ä¸”ä¿è¯æ¶ˆæ¯å†ä¼ è¾“è¿‡ç¨‹ä¸­çš„å®‰å…¨ã€‚<br>RabbitMQæ˜¯ä¸€ä¸ªåœ¨AMQPåè®®æ ‡å‡†ä¸Šå®Œæ•´çš„ã€å¯å¤ç”¨çš„ä¼ä¸šæ¶ˆæ¯ç³»ç»Ÿã€‚å®ƒéµå¾ªMozilla Public Licenseå¼€æºåè®®ï¼Œé‡‡ç”¨Erlangè¯­è¨€å®ç°çš„å·¥ä¸šçº§çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><h3 id="1-2-RabbitMQè¿è¡ŒåŸç†"><a href="#1-2-RabbitMQè¿è¡ŒåŸç†" class="headerlink" title="1.2 RabbitMQè¿è¡ŒåŸç†"></a>1.2 RabbitMQè¿è¡ŒåŸç†</h3><p>RabbitMQçš„ä¸¤å¤§æ ¸å¿ƒç»„ä»¶æ˜¯Exchangeå’ŒQueueï¼Œä»¥ä¸‹æ˜¯å®ƒçš„è¿è¡ŒåŸç†å›¾ï¼š<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/1943029678.png"></p><h3 id="1-3-RabbitMQé‡è¦æœ¯è¯­"><a href="#1-3-RabbitMQé‡è¦æœ¯è¯­" class="headerlink" title="1.3 RabbitMQé‡è¦æœ¯è¯­"></a>1.3 RabbitMQé‡è¦æœ¯è¯­</h3><ol><li>Server(broker): æ¥å—å®¢æˆ·ç«¯è¿æ¥ï¼Œå®ç°AMQPæ¶ˆæ¯é˜Ÿåˆ—å’Œè·¯ç”±åŠŸèƒ½çš„è¿›ç¨‹ã€‚</li><li>Vitual Host: è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿæ¦‚å¿µï¼Œç±»ä¼¼äºæƒé™æ§åˆ¶ç»„ï¼Œä¸€ä¸ªVitual Hosté‡Œé¢å¯ä»¥æœ‰è‹¥å¹²ä¸ªExchangeå’ŒQueueï¼Œä½†æ˜¯æƒé™æ§åˆ¶çš„æœ€å°ç²’åº¦æ˜¯Vitual Hostã€‚</li><li>Exchange: æ¥æ”¶ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®Bindingè§„åˆ™å°†æ¶ˆæ¯è·¯ç”±ç»™æœåŠ¡å™¨ä¸­çš„é˜Ÿåˆ—ã€‚ExchangeTypeå†³å®šäº†Exchangeè·¯ç”±æ¶ˆæ¯çš„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼Œåœ¨RabbitMQä¸­ï¼ŒExchangeTypeæœ‰directã€Fanoutå’ŒTopicä¸‰ç§ï¼Œä¸åŒç±»å‹çš„Exchangeè·¯ç”±çš„è¡Œä¸ºæ˜¯ä¸ä¸€æ ·çš„ã€‚</li><li>Message Queue: æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”¨äºå­˜å‚¨è¿˜æœªè¢«æ¶ˆè´¹è€…æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚</li><li>Message: ç”±Headerå’ŒBodyç»„æˆï¼ŒHeaderæ˜¯ç”±ç”Ÿäº§è€…æ·»åŠ çš„å„ç§å±æ€§çš„é›†åˆï¼ŒåŒ…æ‹¬Messageæ˜¯å¦è¢«æŒä¹…åŒ–ã€ç”±å“ªä¸ªMessage Queueæ¥å—ã€ä¼˜å…ˆçº§æ˜¯å¤šå°‘ç­‰ã€‚è€Œbodyæ˜¯çœŸæ­£éœ€è¦ä¼ è¾“çš„APPæ•°æ®ã€‚</li><li>BindingKey: æ‰€è°“ç»‘å®šå°±æ˜¯å°†ä¸€ä¸ªç‰¹å®šçš„ä¸€ä¸ªExchangeå’Œä¸€ä¸ªç‰¹å®šçš„Queueç»‘å®šèµ·æ¥ï¼Œç»‘å®šå…³é”®å­—ç§°ä¸ºBindingKeyã€‚</li></ol><h1 id="äºŒ-å®‰è£…"><a href="#äºŒ-å®‰è£…" class="headerlink" title="äºŒ.å®‰è£…"></a>äºŒ.å®‰è£…</h1><p>rabbitmqæ˜¯é€šè¿‡Erlangè¯­è¨€ç¼–å†™æ‰€ä»¥éœ€è¦Erlangç¯å¢ƒ</p><h3 id="2-1-é…ç½®Erlangç¯å¢ƒ"><a href="#2-1-é…ç½®Erlangç¯å¢ƒ" class="headerlink" title="2.1 é…ç½®Erlangç¯å¢ƒ"></a>2.1 é…ç½®Erlangç¯å¢ƒ</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å®‰è£…ä¾èµ–</span>yum <span class="token function">install</span> â€“y epel-release ncurses-devel gcc openssl openssl-devel socat</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ä¸‹è½½å®‰è£…åŒ…</span><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/taråŒ…/Rabbitmq/otp_src_20.0.tar.gz</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ç¼–è¯‘å®‰è£…</span><span class="token function">tar</span> -xzvf otp_src_20.0.tar.gz<span class="token function">cd</span> otp_src_20.0./configure -prefix<span class="token operator">=</span>/usr/local/erlang<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#é…ç½®ç¯å¢ƒå˜é‡</span><span class="token function">vi</span> /etc/profileER_LANG<span class="token operator">=</span>/usr/local/erlang/binPATH<span class="token operator">=</span><span class="token variable">$PATH</span><span class="token keyword">:</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$JRE_HOME</span>/bin:<span class="token variable">$MAVEN_HOME</span>/bin:<span class="token variable">$ER_LANG</span><span class="token keyword">:</span><span class="token function">source</span> /etc/profile</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æµ‹è¯•</span>erl -versionErlang <span class="token punctuation">(</span>SMP,ASYNC_THREADS<span class="token punctuation">)</span> <span class="token punctuation">(</span>BEAM<span class="token punctuation">)</span> emulator version 10.4</code></pre><h3 id="2-2-å®‰è£…rabbitmq"><a href="#2-2-å®‰è£…rabbitmq" class="headerlink" title="2.2 å®‰è£…rabbitmq"></a>2.2 å®‰è£…rabbitmq</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ä¸‹è½½rpmåŒ…</span><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/taråŒ…/Rabbitmq/rabbitmq-server-3.6.15-1.el6.noarch.rpmyum <span class="token function">install</span> rabbitmq-server-3.6.15-1.el6.noarch.rpm</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å¯åŠ¨å¹¶é…ç½®å¼€æœºè‡ªå¯</span>systemctl start rabbitmq-serversystemctl <span class="token function">enable</span> rabbitmq-serversystemctl status rabbitmq-serverâ— rabbitmq-server.service - LSB: Enable AMQP <span class="token function">service</span> provided by RabbitMQ broker   Loaded: loaded <span class="token punctuation">(</span>/etc/rc.d/init.d/rabbitmq-server<span class="token punctuation">;</span> bad<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Thu 2021-12-23 11:10:55 CST<span class="token punctuation">;</span> 20min ago     Docs: man:systemd-sysv-generator<span class="token punctuation">(</span>8<span class="token punctuation">)</span>   CGroup: /system.slice/rabbitmq-server.service           â”œâ”€43082 /bin/sh /etc/rc.d/init.d/rabbitmq-server start           â”œâ”€43101 /bin/bash -c <span class="token function">ulimit</span> -S -c 0 <span class="token operator">></span>/dev/null 2<span class="token operator">></span><span class="token operator">&amp;</span>1 <span class="token punctuation">;</span> /usr/<span class="token punctuation">..</span>.           â””â”€43103 /bin/sh /usr/sbin/rabbitmq-serverDec 23 11:10:45 10-46-155-130 systemd<span class="token punctuation">[</span>1<span class="token punctuation">]</span>: Starting LSB: Enable AMQP s<span class="token punctuation">..</span><span class="token punctuation">..</span>Dec 23 11:10:45 10-46-155-130 su<span class="token punctuation">[</span>42974<span class="token punctuation">]</span>: <span class="token punctuation">(</span>to rabbitmq<span class="token punctuation">)</span> root on none</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å®‰è£…æ’ä»¶</span>rabbitmq-plugins <span class="token function">enable</span> rabbitmq_management<span class="token comment" spellcheck="true">#èµ‹äºˆæƒé™</span><span class="token function">chown</span> -R rabbitmq:rabbitmq /var/lib/rabbitmq/<span class="token comment" spellcheck="true">#æ·»åŠ ç”¨æˆ·</span>rabbitmqctl add_user admin passwordrabbitmqctl set_user_tags admin administratorrabbitmqctl set_permissions -p / admin â€œ.*â€ â€œ.*â€ â€œ.*â€</code></pre><p>è®¿é—®æµ‹è¯•<br>ip+15672<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/12/1987447132.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> ä¸­é—´ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Rabbitmqé›†ç¾¤é…ç½®</title>
      <link href="/acda943d/"/>
      <url>/acda943d/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ç¯å¢ƒå‡†å¤‡"><a href="#ä¸€-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ä¸€. ç¯å¢ƒå‡†å¤‡"></a>ä¸€. ç¯å¢ƒå‡†å¤‡</h1><p>ç¯å¢ƒå¦‚ä¸‹</p><table><thead><tr><th>ä¸»æœºå</th><th>ip</th></tr></thead><tbody><tr><td>rabbitmq01</td><td>10.9.132.128</td></tr><tr><td>rabbitmq02</td><td>10.9.67.10</td></tr></tbody></table><p>å•èŠ‚ç‚¹éƒ¨ç½²å¯ä»¥å‚è€ƒä¸Šä¸€ç¯‡æ–‡ç« </p><h1 id="äºŒ-éƒ¨ç½²é›†ç¾¤"><a href="#äºŒ-éƒ¨ç½²é›†ç¾¤" class="headerlink" title="äºŒ. éƒ¨ç½²é›†ç¾¤"></a>äºŒ. éƒ¨ç½²é›†ç¾¤</h1><h3 id="2-1-ä¿®æ”¹host"><a href="#2-1-ä¿®æ”¹host" class="headerlink" title="2.1 ä¿®æ”¹host"></a>2.1 ä¿®æ”¹host</h3><pre class=" language-bash"><code class="language-bash">10.9.132.128 rabbitmq0110.9.67.10 rabbitmq02</code></pre><h3 id="2-2-ä¿®æ”¹erlang-cookieæ–‡ä»¶ä¸­cookieå€¼ä¸€è‡´"><a href="#2-2-ä¿®æ”¹erlang-cookieæ–‡ä»¶ä¸­cookieå€¼ä¸€è‡´" class="headerlink" title="2.2 ä¿®æ”¹erlang.cookieæ–‡ä»¶ä¸­cookieå€¼ä¸€è‡´"></a>2.2 ä¿®æ”¹erlang.cookieæ–‡ä»¶ä¸­cookieå€¼ä¸€è‡´</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">cat</span> /var/lib/rabbitmq/.erlang.cookie YIHXTAVFVTEWSDSXWVLY<span class="token function">chmod</span> 600 /var/lib/rabbitmq/.erlang.cookie</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</span>rabbitmqctl cluster_statusCluster status of node rabbit@rabbitmq01<span class="token punctuation">[</span><span class="token punctuation">{</span>nodes,<span class="token punctuation">[</span><span class="token punctuation">{</span>disc,<span class="token punctuation">[</span>rabbit@rabbitmq01<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>running_nodes,<span class="token punctuation">[</span>rabbit@rabbitmq01<span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>cluster_name,<span class="token operator">&lt;&lt;</span><span class="token string">"rabbit@rabbitmq01"</span><span class="token operator">>></span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>partitions,<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>alarms,<span class="token punctuation">[</span><span class="token punctuation">{</span>rabbit@rabbitmq01,<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">#åœæ­¢æœåŠ¡</span>rabbitmqctl stop_app<span class="token comment" spellcheck="true">#åŠ å…¥é›†ç¾¤</span>rabbitmqctl join_cluster --ram rabbit@rabbitmq02<span class="token comment" spellcheck="true">#å¯åŠ¨æœåŠ¡</span>rabbitmqctl start_app<span class="token comment" spellcheck="true">#å†æ¬¡æŸ¥çœ‹é›†ç¾¤</span>rabbitmqctl cluster_statusCluster status of node rabbit@rabbitmq01<span class="token punctuation">[</span><span class="token punctuation">{</span>nodes,<span class="token punctuation">[</span><span class="token punctuation">{</span>disc,<span class="token punctuation">[</span>rabbit@rabbitmq02<span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>ram,<span class="token punctuation">[</span>rabbit@rabbitmq01<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>running_nodes,<span class="token punctuation">[</span>rabbit@rabbitmq02,rabbit@rabbitmq01<span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>cluster_name,<span class="token operator">&lt;&lt;</span><span class="token string">"rabbit@rabbitmq01"</span><span class="token operator">>></span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>partitions,<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>, <span class="token punctuation">{</span>alarms,<span class="token punctuation">[</span><span class="token punctuation">{</span>rabbit@rabbitmq02,<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span>rabbit@rabbitmq01,<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span></code></pre><h3 id="2-3-å¼€å¯HA-é•œåƒé˜Ÿåˆ—"><a href="#2-3-å¼€å¯HA-é•œåƒé˜Ÿåˆ—" class="headerlink" title="2.3 å¼€å¯HA é•œåƒé˜Ÿåˆ—"></a>2.3 å¼€å¯HA é•œåƒé˜Ÿåˆ—</h3><pre class=" language-bash"><code class="language-bash">rabbitmqctl set_policy -p / ha <span class="token string">"^"</span> <span class="token string">'{"ha-mode":"all"}'</span>Setting policy <span class="token string">"ha"</span> <span class="token keyword">for</span> pattern <span class="token string">"^"</span> to <span class="token string">"{\"ha-mode\":\"all\"}"</span> with priority <span class="token string">"0"</span>rabbitmqctl list_policies -p /Listing policies/haall^<span class="token punctuation">{</span><span class="token string">"ha-mode"</span><span class="token keyword">:</span><span class="token string">"all"</span><span class="token punctuation">}</span>0</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> ä¸­é—´ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Node.jsç¯å¢ƒé…ç½®</title>
      <link href="/9676ee43/"/>
      <url>/9676ee43/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ä¸‹è½½å®‰è£…åŒ…"><a href="#ä¸€-ä¸‹è½½å®‰è£…åŒ…" class="headerlink" title="ä¸€ ä¸‹è½½å®‰è£…åŒ…"></a>ä¸€ ä¸‹è½½å®‰è£…åŒ…</h1><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/taråŒ…/Node.js/node-v10.15.3-linux-x64.tar.xz<span class="token comment" spellcheck="true">#å®˜ç½‘ä¸‹è½½åœ°å€ http://maven.apache.org/download.cgi</span></code></pre><h1 id="äºŒ-è§£å‹é…ç½®ç¯å¢ƒ"><a href="#äºŒ-è§£å‹é…ç½®ç¯å¢ƒ" class="headerlink" title="äºŒ è§£å‹é…ç½®ç¯å¢ƒ"></a>äºŒ è§£å‹é…ç½®ç¯å¢ƒ</h1><pre class=" language-bash"><code class="language-bash"><span class="token function">tar</span> -xvf node-v10.15.3-linux-x64.tar.xz<span class="token function">mv</span> node-v10.15.3-linux-x64 nodejs<span class="token function">cd</span> nodejs/<span class="token function">ln</span> -s /root/nodejs/bin/node /usr/local/bin/node<span class="token function">ln</span> -s /root/nodejs/bin/npm /usr/local/bin/npm</code></pre><h1 id="ä¸‰-æµ‹è¯•"><a href="#ä¸‰-æµ‹è¯•" class="headerlink" title="ä¸‰ æµ‹è¯•"></a>ä¸‰ æµ‹è¯•</h1><pre class=" language-bash"><code class="language-bash"><span class="token function">npm</span> -v6.4.1node -vv10.15.3</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jdk1.8&amp;Mavenç¯å¢ƒé…ç½®</title>
      <link href="/9f29a45e/"/>
      <url>/9f29a45e/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-é…ç½®JDKç¯å¢ƒ"><a href="#ä¸€-é…ç½®JDKç¯å¢ƒ" class="headerlink" title="ä¸€ é…ç½®JDKç¯å¢ƒ"></a>ä¸€ é…ç½®JDKç¯å¢ƒ</h1><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ä¸‹è½½rpmåŒ…</span><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/taråŒ…/tomcat/jdk-8u171-linux-x64.rpm</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å®‰è£…</span>rpm -ivh jdk-8u171-linux-x64.rpm</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#é…ç½®ç¯å¢ƒå˜é‡</span><span class="token function">export</span> JAVA_HOME<span class="token operator">=</span>/usr/java/jdk1.8.0_171-amd64<span class="token function">export</span> CLASSPATH<span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/lib/tools.jar:<span class="token variable">$JAVA_HOME</span>/lib/dt.jar<span class="token function">export</span> PATH<span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$PATH</span><span class="token comment" spellcheck="true">#ç”Ÿæ•ˆ</span><span class="token function">source</span> /etc/profile</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æµ‹è¯•</span>java -versionjava version <span class="token string">"1.8.0_171"</span>Java<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> SE Runtime Environment <span class="token punctuation">(</span>build 1.8.0_171-b11<span class="token punctuation">)</span>Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> 64-Bit Server VM <span class="token punctuation">(</span>build 25.171-b11, mixed mode<span class="token punctuation">)</span></code></pre><h1 id="äºŒ-Mavené…ç½®"><a href="#äºŒ-Mavené…ç½®" class="headerlink" title="äºŒ Mavené…ç½®"></a>äºŒ Mavené…ç½®</h1><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ä¸‹è½½</span><span class="token function">wget</span> kode.huhuhahei.cn/kodexplorer/taråŒ…/Maven/apache-maven-3.8.4-bin.tar.gz</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#ç¯å¢ƒé…ç½®</span><span class="token function">tar</span> xf apache-maven-3.8.4-bin.tar.gz<span class="token function">mv</span> apache-maven-3.8.4 /usr/local/<span class="token comment" spellcheck="true">#ä¿®æ”¹ç¯å¢ƒå˜é‡</span><span class="token function">export</span> MAVEN_HOME<span class="token operator">=</span>/usr/local/apache-maven-3.6.1<span class="token function">export</span> PATH<span class="token operator">=</span><span class="token variable">$MAVEN_HOME</span>/bin:<span class="token variable">$PATH</span><span class="token comment" spellcheck="true">#ç”Ÿæ•ˆ</span><span class="token function">source</span> /etc/profile</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æµ‹è¯•</span>mvn -vApache Maven 3.8.4 <span class="token punctuation">(</span>9b656c72d54e5bacbed989b64718c159fe39b537<span class="token punctuation">)</span>Maven home: /usr/local/apache-maven-3.8.4Java version: 1.8.0_171, vendor: Oracle Corporation, runtime: /usr/java/jdk1.8.0_171-amd64/jreDefault locale: en_US, platform encoding: UTF-8OS name: <span class="token string">"linux"</span>, version: <span class="token string">"3.10.0-1160.49.1.el7.x86_64"</span>, arch: <span class="token string">"amd64"</span>, family: <span class="token string">"unix"</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xxl-jobåˆ†å¸ƒå¼è°ƒåº¦ç³»ç»Ÿéƒ¨ç½²</title>
      <link href="/cc07b68b/"/>
      <url>/cc07b68b/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€.å‰è¨€"></a>ä¸€.å‰è¨€</h1><h3 id="1-1-ç®€ä»‹"><a href="#1-1-ç®€ä»‹" class="headerlink" title="1.1 ç®€ä»‹"></a>1.1 ç®€ä»‹</h3><p>XXL-JOBæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œå…¶æ ¸å¿ƒè®¾è®¡ç›®æ ‡æ˜¯å¼€å‘è¿…é€Ÿã€å­¦ä¹ ç®€å•ã€è½»é‡çº§ã€æ˜“æ‰©å±•ã€‚ç°å·²å¼€æ”¾æºä»£ç å¹¶æ¥å…¥å¤šå®¶å…¬å¸çº¿ä¸Šäº§å“çº¿ï¼Œå¼€ç®±å³ç”¨ã€‚<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/1565206452.png"></p><h1 id="äºŒ-é¡¹ç›®éƒ¨ç½²"><a href="#äºŒ-é¡¹ç›®éƒ¨ç½²" class="headerlink" title="äºŒ.é¡¹ç›®éƒ¨ç½²"></a>äºŒ.é¡¹ç›®éƒ¨ç½²</h1><h3 id="2-1-æ‹‰å–ä»£ç æ„å»º"><a href="#2-1-æ‹‰å–ä»£ç æ„å»º" class="headerlink" title="2.1 æ‹‰å–ä»£ç æ„å»º"></a>2.1 æ‹‰å–ä»£ç æ„å»º</h3><p><a href="https://github.com/xuxueli/xxl-job">Githubåœ°å€</a><br>å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œä¸‹è½½æ‰“å¥½çš„å‹ç¼©åŒ… ä¸‹è½½å®Œæˆä¹‹åè§£å‹å³å¯<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/1367955538.jpg"></p><p>mavenæ„å»º(è¿™é‡Œéœ€è¦javaå’Œmavenç¯å¢ƒ æ²¡æœ‰çš„å¯ä»¥çœ‹ä¹‹å‰çš„æ–‡æ¡£)</p><pre class=" language-bash"><code class="language-bash">/usr/local/apache-maven-3.8.4/bin/mvn -f pom.xml clean <span class="token function">install</span></code></pre><p>æ„å»ºå®Œæˆä¼š<code>xxl-job-admin</code>å‡ºç°è¿™ä¸ª<code>target</code>ç›®å½•ä¸‹é¢æ˜¯æ„å»ºå®Œæˆçš„jaråŒ…</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master target<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll</span>total 39992drwxr-xr-x 7 root root      131 Jan 11 13:46 classesdrwxr-xr-x 3 root root       25 Jan 11 13:46 generated-sourcesdrwxr-xr-x 2 root root       28 Jan 11 13:46 maven-archiverdrwxr-xr-x 3 root root       35 Jan 11 13:46 maven-status-rw-r--r-- 1 root root 38997788 Jan 11 13:47 xxl-job-admin-2.3.0.jar-rw-r--r-- 1 root root  1950567 Jan 11 13:46 xxl-job-admin-2.3.0.jar.original</code></pre><h3 id="2-2-é…ç½®æ•°æ®åº“"><a href="#2-2-é…ç½®æ•°æ®åº“" class="headerlink" title="2.2 é…ç½®æ•°æ®åº“"></a>2.2 é…ç½®æ•°æ®åº“</h3><p>åˆ›å»ºç”¨æˆ·å’Œæ•°æ®åº“</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>xxl_job<span class="token punctuation">`</span> <span class="token keyword">default</span> <span class="token keyword">character set</span> utf8mb4 <span class="token keyword">collate</span> utf8mb4_unicode_ci<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token punctuation">`</span>xxl_job<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token punctuation">`</span>xxl_job<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'xxljob'</span>@'<span class="token operator">%</span><span class="token string">' IDENTIFIED BY '</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>'<span class="token punctuation">;</span></code></pre><p>åˆå§‹åŒ–sql</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># XXL-JOB v2.3.1-SNAPSHOT</span><span class="token comment" spellcheck="true"># Copyright (c) 2015-present, xuxueli.</span><span class="token keyword">CREATE</span> <span class="token keyword">database</span> <span class="token keyword">if</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>xxl_job<span class="token punctuation">`</span> <span class="token keyword">default</span> <span class="token keyword">character set</span> utf8mb4 <span class="token keyword">collate</span> utf8mb4_unicode_ci<span class="token punctuation">;</span><span class="token keyword">use</span> <span class="token punctuation">`</span>xxl_job<span class="token punctuation">`</span><span class="token punctuation">;</span><span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>job_group<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨ä¸»é”®ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>job_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>add_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>author<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä½œè€…'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>alarm_email<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æŠ¥è­¦é‚®ä»¶'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>schedule_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'NONE'</span> <span class="token keyword">COMMENT</span> <span class="token string">'è°ƒåº¦ç±»å‹'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>schedule_conf<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è°ƒåº¦é…ç½®ï¼Œå€¼å«ä¹‰å–å†³äºè°ƒåº¦ç±»å‹'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>misfire_strategy<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'DO_NOTHING'</span> <span class="token keyword">COMMENT</span> <span class="token string">'è°ƒåº¦è¿‡æœŸç­–ç•¥'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_route_strategy<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨è·¯ç”±ç­–ç•¥'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_handler<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨ä»»åŠ¡handler'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_param<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨ä»»åŠ¡å‚æ•°'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_block_strategy<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'é˜»å¡å¤„ç†ç­–ç•¥'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_timeout<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä»»åŠ¡æ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_fail_retry_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å¤±è´¥é‡è¯•æ¬¡æ•°'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUEç±»å‹'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_source<span class="token punctuation">`</span> <span class="token keyword">mediumtext</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUEæºä»£ç '</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_remark<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUEå¤‡æ³¨'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_updatetime<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUEæ›´æ–°æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>child_jobid<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å­ä»»åŠ¡IDï¼Œå¤šä¸ªé€—å·åˆ†éš”'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_status<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'è°ƒåº¦çŠ¶æ€ï¼š0-åœæ­¢ï¼Œ1-è¿è¡Œ'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_last_time<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¸Šæ¬¡è°ƒåº¦æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_next_time<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¸‹æ¬¡è°ƒåº¦æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_log<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>job_group<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨ä¸»é”®ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>job_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä»»åŠ¡ï¼Œä¸»é”®ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_address<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨åœ°å€ï¼Œæœ¬æ¬¡æ‰§è¡Œçš„åœ°å€'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_handler<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨ä»»åŠ¡handler'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_param<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨ä»»åŠ¡å‚æ•°'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_sharding_param<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨ä»»åŠ¡åˆ†ç‰‡å‚æ•°ï¼Œæ ¼å¼å¦‚ 1/2'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>executor_fail_retry_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å¤±è´¥é‡è¯•æ¬¡æ•°'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è°ƒåº¦-æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_code<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è°ƒåº¦-ç»“æœ'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_msg<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'è°ƒåº¦-æ—¥å¿—'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>handle_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œ-æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>handle_code<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œ-çŠ¶æ€'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>handle_msg<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œ-æ—¥å¿—'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>alarm_status<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å‘Šè­¦çŠ¶æ€ï¼š0-é»˜è®¤ã€1-æ— éœ€å‘Šè­¦ã€2-å‘Šè­¦æˆåŠŸã€3-å‘Šè­¦å¤±è´¥'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>I_trigger_time<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trigger_time<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>I_handle_code<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>handle_code<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_log_report<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>trigger_day<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è°ƒåº¦-æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>running_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'è¿è¡Œä¸­-æ—¥å¿—æ•°é‡'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>suc_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡ŒæˆåŠŸ-æ—¥å¿—æ•°é‡'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>fail_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå¤±è´¥-æ—¥å¿—æ•°é‡'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>i_trigger_day<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>trigger_day<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_logglue<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>job_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä»»åŠ¡ï¼Œä¸»é”®ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUEç±»å‹'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_source<span class="token punctuation">`</span> <span class="token keyword">mediumtext</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUEæºä»£ç '</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>glue_remark<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'GLUEå¤‡æ³¨'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>add_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_registry<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>registry_group<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>registry_key<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>registry_value<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>i_g_k_v<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>registry_group<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>registry_key<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>registry_value<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_group<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨AppName'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>title<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨åç§°'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>address_type<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨åœ°å€ç±»å‹ï¼š0=è‡ªåŠ¨æ³¨å†Œã€1=æ‰‹åŠ¨å½•å…¥'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>address_list<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'æ‰§è¡Œå™¨åœ°å€åˆ—è¡¨ï¼Œå¤šåœ°å€é€—å·åˆ†éš”'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_user<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è´¦å·'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å¯†ç '</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'è§’è‰²ï¼š0-æ™®é€šç”¨æˆ·ã€1-ç®¡ç†å‘˜'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>permission<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'æƒé™ï¼šæ‰§è¡Œå™¨IDåˆ—è¡¨ï¼Œå¤šä¸ªé€—å·åˆ†å‰²'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>i_username<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>xxl_job_lock<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>lock_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'é”åç§°'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>lock_name<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>xxl_job_group<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>title<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>address_list<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'xxl-job-executor-sample'</span><span class="token punctuation">,</span> <span class="token string">'ç¤ºä¾‹æ‰§è¡Œå™¨'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'2018-11-03 22:21:31'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>xxl_job_info<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>job_group<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>job_desc<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>add_time<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>author<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>alarm_email<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>schedule_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>schedule_conf<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>misfire_strategy<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_route_strategy<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_handler<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_param<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_block_strategy<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_timeout<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>executor_fail_retry_count<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>glue_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>glue_source<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>glue_remark<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>glue_updatetime<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>child_jobid<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'æµ‹è¯•ä»»åŠ¡1'</span><span class="token punctuation">,</span> <span class="token string">'2018-11-03 22:21:31'</span><span class="token punctuation">,</span> <span class="token string">'2018-11-03 22:21:31'</span><span class="token punctuation">,</span> <span class="token string">'XXL'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'CRON'</span><span class="token punctuation">,</span> <span class="token string">'0 0 0 * * ? *'</span><span class="token punctuation">,</span> <span class="token string">'DO_NOTHING'</span><span class="token punctuation">,</span> <span class="token string">'FIRST'</span><span class="token punctuation">,</span> <span class="token string">'demoJobHandler'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'SERIAL_EXECUTION'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'BEAN'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'GLUEä»£ç åˆå§‹åŒ–'</span><span class="token punctuation">,</span> <span class="token string">'2018-11-03 22:21:31'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>xxl_job_user<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>username<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>password<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>permission<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'admin'</span><span class="token punctuation">,</span> <span class="token string">'e10adc3949ba59abbe56e057f20f883e'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>xxl_job_lock<span class="token punctuation">`</span> <span class="token punctuation">(</span> <span class="token punctuation">`</span>lock_name<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span> <span class="token string">'schedule_lock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">commit</span><span class="token punctuation">;</span></code></pre><h3 id="2-3-äº¤ä»˜k8s"><a href="#2-3-äº¤ä»˜k8s" class="headerlink" title="2.3 äº¤ä»˜k8s"></a>2.3 äº¤ä»˜k8s</h3><p>deploy</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin  <span class="token key atrule">name</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> XXL_JOB_ACCESSTOKEN          <span class="token key atrule">value</span><span class="token punctuation">:</span> *****************        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPRING_DATASOURCE_URL          <span class="token key atrule">value</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//mysql.blog.svc.cluster.local<span class="token punctuation">:</span>3306/xxl_job<span class="token punctuation">?</span>Unicode=true<span class="token important">&amp;characterEncoding</span>=UTF<span class="token punctuation">-</span>8<span class="token important">&amp;useSSL</span>=false        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPRING_DATASOURCE_USERNAME          <span class="token key atrule">value</span><span class="token punctuation">:</span> xxljob        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPRING_DATASOURCE_PASSWORD          <span class="token key atrule">value</span><span class="token punctuation">:</span> *********        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/xxl<span class="token punctuation">-</span>job<span class="token punctuation">:</span>v2.3.0        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> harbor<span class="token punctuation">-</span>huhuhahei        <span class="token key atrule">name</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span></code></pre><p>svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> xxljob<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> xxljob    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> xxl<span class="token punctuation">-</span>job<span class="token punctuation">-</span>admin  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><p><code>kubectl apply -f .</code> éƒ¨ç½²</p><h3 id="2-4-æŸ¥çœ‹"><a href="#2-4-æŸ¥çœ‹" class="headerlink" title="2.4 æŸ¥çœ‹"></a>2.4 æŸ¥çœ‹</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/1083008058.png"></p>]]></content>
      
      
      <categories>
          
          <category> å¼€æºé¡¹ç›® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Neo4j å›¾å½¢æ•°æ®åº“éƒ¨ç½²</title>
      <link href="/b7e47e6a/"/>
      <url>/b7e47e6a/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€.å‰è¨€"></a>ä¸€.å‰è¨€</h1><h3 id="1-1-ç®€ä»‹"><a href="#1-1-ç®€ä»‹" class="headerlink" title="1.1 ç®€ä»‹"></a>1.1 ç®€ä»‹</h3><p><a href="https://baike.baidu.com/item/Neo4j">Neo4j</a>æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„,NOSQLå›¾å½¢æ•°æ®åº“ï¼Œå®ƒå°†ç»“æ„åŒ–æ•°æ®å­˜å‚¨åœ¨ç½‘ç»œä¸Šè€Œä¸æ˜¯è¡¨ä¸­ã€‚å®ƒæ˜¯ä¸€ä¸ª<a href="https://baike.baidu.com/item/%E5%B5%8C%E5%85%A5%E5%BC%8F/575465">åµŒå…¥å¼</a>çš„ã€åŸºäº<a href="https://baike.baidu.com/item/%E7%A3%81%E7%9B%98/2842227">ç£ç›˜</a>çš„ã€å…·å¤‡å®Œå…¨çš„äº‹åŠ¡ç‰¹æ€§çš„JavaæŒä¹…åŒ–å¼•æ“ï¼Œä½†æ˜¯å®ƒå°†ç»“æ„åŒ–æ•°æ®å­˜å‚¨åœ¨ç½‘ç»œ(ä»æ•°å­¦è§’åº¦å«åšå›¾)ä¸Šè€Œä¸æ˜¯è¡¨ä¸­ã€‚Neo4jä¹Ÿå¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å›¾å¼•æ“ï¼Œè¯¥å¼•æ“å…·æœ‰æˆç†Ÿæ•°æ®åº“çš„æ‰€æœ‰ç‰¹æ€§ã€‚ç¨‹åºå‘˜å·¥ä½œåœ¨ä¸€ä¸ªé¢å‘å¯¹è±¡çš„ã€çµæ´»çš„ç½‘ç»œç»“æ„ä¸‹è€Œä¸æ˜¯ä¸¥æ ¼ã€é™æ€çš„è¡¨ä¸­â€”â€”ä½†æ˜¯ä»–ä»¬å¯ä»¥äº«å—åˆ°å…·å¤‡å®Œå…¨çš„äº‹åŠ¡ç‰¹æ€§ã€ä¼ä¸šçº§çš„æ•°æ®åº“çš„æ‰€æœ‰å¥½å¤„ã€‚</p><h1 id="äºŒ-å®‰è£…é…ç½®"><a href="#äºŒ-å®‰è£…é…ç½®" class="headerlink" title="äºŒ.å®‰è£…é…ç½®"></a>äºŒ.å®‰è£…é…ç½®</h1><h3 id="2-1-éƒ¨ç½²masterèŠ‚ç‚¹"><a href="#2-1-éƒ¨ç½²masterèŠ‚ç‚¹" class="headerlink" title="2.1 éƒ¨ç½²masterèŠ‚ç‚¹"></a>2.1 éƒ¨ç½²masterèŠ‚ç‚¹</h3><p>masterä½¿ç”¨stséƒ¨ç½²</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> neo4j  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2 </span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core        <span class="token key atrule">image</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">:</span>3.5.5<span class="token punctuation">-</span>enterprise   <span class="token comment" spellcheck="true"># å®˜æ–¹é•œåƒï¼Œ3.5.5ä¼ä¸šç‰ˆ</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># è¿™é‡Œé€šè¿‡envï¼Œé…ç½®é•œåƒç¯å¢ƒå‚æ•°ï¼Œè¿™æ˜¯å› ä¸ºæ­¤é•œåƒæ˜¯é€šè¿‡è¿™æ ·æ¥è¿›è¡Œé…ç½®å‚æ•°çš„</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_ACCEPT_LICENSE_AGREEMENT    <span class="token comment" spellcheck="true"># æ¥å—è¯ä¹¦åè®®ï¼Œå¿…é¡»çš„</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"yes"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_dbms_connectors_default__advertised__address  <span class="token comment" spellcheck="true"># æŒ‡å®šè‡ªèº«podçš„ipåœ°å€ï¼Œé»˜è®¤ä¸ºlocalhostï¼Œåœ¨é›†ç¾¤ä¸­å¿…é¡»æ³¨æ˜è‡ªèº«åœ°å€ï¼Œè¿™é‡Œç›´æ¥ç”¨ip</span>            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>              <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.podIP          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_dbms_mode  <span class="token comment" spellcheck="true"># èŠ‚ç‚¹çš„æ¨¡å¼ï¼Œé€‰æ‹©COREï¼Œå°±æ˜¯æ ¸å¿ƒèŠ‚ç‚¹</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"CORE"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_AUTH   <span class="token comment" spellcheck="true"># ä¸€å®šè¦è‡ªå®šä¹‰åˆå§‹éªŒè¯çš„ç”¨æˆ·å/å¯†ç </span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"neo4j/*******"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_minimum__core__cluster__size__at__formation            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"2"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_minimum__core__cluster__size__at__runtime            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"2"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_discovery__type  <span class="token comment" spellcheck="true"># é»˜è®¤é›†ç¾¤å‘ç°æ–¹å¼ä¸ºLISTï¼Œè¿™é‡Œå†™ä¸å†™éƒ½è¡Œ</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"LIST"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_initial__discovery__members  <span class="token comment" spellcheck="true"># æ‰‹åŠ¨å†™æ˜é›†ç¾¤ä¸­æ‰€æœ‰æˆå‘˜çš„ip:portï¼Œ5000ç«¯å£ä¸ºé›†ç¾¤å‘ç°ç«¯å£</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"neo4j-core-0.neo4j.svc.cluster.local:5000,neo4j-core-1.neo4j.svc.cluster.local:5000"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_discovery__advertised__address  <span class="token comment" spellcheck="true"># ä¸‹é¢è¿™ä¸‰ä¸ªå¿…é¡»å®šä¹‰ï¼Œä¸ºèŠ‚ç‚¹è‡ªèº«çš„ip:portï¼Œç›¸å½“äºèŠ‚ç‚¹è‡ªèº«çš„åç§°ï¼Œå› ä¸ºé»˜è®¤æ˜¯ä¼šç”¨è‡ªèº«hostnameï¼Œä½†æ˜¯åœ¨k8sä¸­ï¼Œæ— æ³•å•å•é€šè¿‡hostnameè§£æåˆ°ipåœ°å€ï¼Œè¿™æ ·å®šä¹‰çš„è‡ªèº«åœ°å€ä¼šæ— æ³•è¯†åˆ«</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> $(NEO4J_dbms_connectors_default__advertised__address)<span class="token punctuation">:</span><span class="token number">5000</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causalClustering_transactionAdvertisedAddress            <span class="token key atrule">value</span><span class="token punctuation">:</span> $(NEO4J_dbms_connectors_default__advertised__address)<span class="token punctuation">:</span><span class="token number">6000</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causalClustering_raftAdvertisedAddress            <span class="token key atrule">value</span><span class="token punctuation">:</span> $(NEO4J_dbms_connectors_default__advertised__address)<span class="token punctuation">:</span><span class="token number">7000</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/neo4j  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ReadWriteOnce      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 50Gi      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>storageclass      <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem</code></pre><p>masterèŠ‚ç‚¹svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> neo4j<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">-</span>core  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort      <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7474</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31474</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7474</span>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">name</span><span class="token punctuation">:</span> blot      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7687</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31687</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7687</span></code></pre><h3 id="2-2-éƒ¨ç½²slaveèŠ‚ç‚¹"><a href="#2-2-éƒ¨ç½²slaveèŠ‚ç‚¹" class="headerlink" title="2.2 éƒ¨ç½²slaveèŠ‚ç‚¹"></a>2.2 éƒ¨ç½²slaveèŠ‚ç‚¹</h3><p>slaveä½¿ç”¨deployéƒ¨ç½²</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> neo4j  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica        <span class="token key atrule">image</span><span class="token punctuation">:</span> neo4j<span class="token punctuation">:</span>3.5.5<span class="token punctuation">-</span>enterprise        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">env</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_ACCEPT_LICENSE_AGREEMENT            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"yes"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_dbms_connectors_default__advertised__address            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>              <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.podIP          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_dbms_mode   <span class="token comment" spellcheck="true"># æŒ‡å®šæ¨¡å¼ä¸ºåªè¯»èŠ‚ç‚¹æ¨¡å¼</span>            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"READ_REPLICA"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_AUTH            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"neo4j/*******"</span>             <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_discovery__type            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"LIST"</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NEO4J_causal__clustering_initial__discovery__members            <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"neo4j-core-0.neo4j.svc.cluster.local:5000,neo4j-core-1.neo4j.svc.cluster.local:5000"</span></code></pre><p>slave svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> neo4j<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> neorj<span class="token punctuation">-</span>read<span class="token punctuation">-</span>replica  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7687</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7687</span></code></pre><p>åˆ›å»ºnamespaceå¹¶éƒ¨ç½²</p><pre class=" language-yaml"><code class="language-yaml">kubectl create ns neo4jkubectl apply <span class="token punctuation">-</span>f .</code></pre><h3 id="2-3-webé¡µé¢è®¿é—®"><a href="#2-3-webé¡µé¢è®¿é—®" class="headerlink" title="2.3 webé¡µé¢è®¿é—®"></a>2.3 webé¡µé¢è®¿é—®</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/1622614954.png"></p>]]></content>
      
      
      <categories>
          
          <category> Databases </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Databases </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitlab k8séƒ¨ç½²</title>
      <link href="/5a0dac76/"/>
      <url>/5a0dac76/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€.å‰è¨€"></a>ä¸€.å‰è¨€</h1><h3 id="1-1-ç®€ä»‹"><a href="#1-1-ç®€ä»‹" class="headerlink" title="1.1 ç®€ä»‹"></a>1.1 ç®€ä»‹</h3><p>GitLab æ˜¯ä¸€ä¸ªç”¨äºä»“åº“ç®¡ç†ç³»ç»Ÿçš„å¼€æºé¡¹ç›®ï¼Œä½¿ç”¨<a href="https://baike.baidu.com/item/Git">Git</a>ä½œä¸ºä»£ç ç®¡ç†å·¥å…·ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ­å»ºèµ·æ¥çš„WebæœåŠ¡ã€‚å®‰è£…æ–¹æ³•æ˜¯å‚è€ƒGitLabåœ¨GitHubä¸Šçš„Wikié¡µé¢ã€‚</p><h1 id="äºŒ-éƒ¨ç½²"><a href="#äºŒ-éƒ¨ç½²" class="headerlink" title="äºŒ.éƒ¨ç½²"></a>äºŒ.éƒ¨ç½²</h1><h3 id="2-1-åˆ›å»ºæŒä¹…åŒ–ç›®å½•"><a href="#2-1-åˆ›å»ºæŒä¹…åŒ–ç›®å½•" class="headerlink" title="2.1 åˆ›å»ºæŒä¹…åŒ–ç›®å½•"></a>2.1 åˆ›å»ºæŒä¹…åŒ–ç›®å½•</h3><pre class=" language-yaml"><code class="language-yaml">mkdir /data/<span class="token punctuation">{</span>gitlab_etc<span class="token punctuation">,</span>gitlab_log<span class="token punctuation">,</span>gitlab_opt<span class="token punctuation">,</span>gitlab_postgresql_data<span class="token punctuation">}</span></code></pre><h3 id="2-2-åˆ›å»ºå‘½åç©ºé—´"><a href="#2-2-åˆ›å»ºå‘½åç©ºé—´" class="headerlink" title="2.2 åˆ›å»ºå‘½åç©ºé—´"></a>2.2 åˆ›å»ºå‘½åç©ºé—´</h3><pre class=" language-yaml"><code class="language-yaml">kubectl create namespace gitlab</code></pre><h3 id="2-3-é…ç½®postgresqlå’Œredis"><a href="#2-3-é…ç½®postgresqlå’Œredis" class="headerlink" title="2.3 é…ç½®postgresqlå’Œredis"></a>2.3 é…ç½®postgresqlå’Œredis</h3><p>postgresql é…ç½®</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># pv</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>data  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>data<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/gitlab_postgresql_data    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18<span class="token comment" spellcheck="true"># pvc</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>data<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5432</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab      <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab        <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>12.6<span class="token punctuation">-</span>alpine          <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_USER              <span class="token key atrule">value</span><span class="token punctuation">:</span> gitlab            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_DB              <span class="token key atrule">value</span><span class="token punctuation">:</span> gitlabhq_production            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_PASSWORD              <span class="token key atrule">value</span><span class="token punctuation">:</span> bogeusepg            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5432</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> exec pg_isready <span class="token punctuation">-</span>U gitlab <span class="token punctuation">-</span>h 127.0.0.1 <span class="token punctuation">-</span>p 5432 <span class="token punctuation">-</span>d gitlabhq_production            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">110</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> exec pg_isready <span class="token punctuation">-</span>U gitlab <span class="token punctuation">-</span>h 127.0.0.1 <span class="token punctuation">-</span>p 5432 <span class="token punctuation">-</span>d gitlabhq_production            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">20</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">resources</span><span class="token punctuation">:</span>            <span class="token key atrule">requests</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi            <span class="token key atrule">limits</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/postgresql/data      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>postgresql<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc</code></pre><p>redis é…ç½®</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> backend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> backend<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> backend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab      <span class="token key atrule">tier</span><span class="token punctuation">:</span> backend  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab        <span class="token key atrule">tier</span><span class="token punctuation">:</span> backend    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>6.2.0<span class="token punctuation">-</span>alpine3.13          <span class="token key atrule">name</span><span class="token punctuation">:</span> redis          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">"redis-server"</span>          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">"--requirepass"</span>            <span class="token punctuation">-</span> <span class="token string">"bogeuseredis"</span><span class="token comment" spellcheck="true">#          resources:</span><span class="token comment" spellcheck="true">#            requests:</span><span class="token comment" spellcheck="true">#              cpu: "1"</span><span class="token comment" spellcheck="true">#              memory: 2Gi</span><span class="token comment" spellcheck="true">#            limits:</span><span class="token comment" spellcheck="true">#              cpu: "1"</span><span class="token comment" spellcheck="true">#              memory: 2Gi</span>          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> redis          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> <span class="token string">"redis-cli ping"</span>            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> <span class="token string">"redis-cli ping"</span>            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> /bin/sh        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          ulimit -n 65536          mount -o remount rw /sys          echo never > /sys/kernel/mm/transparent_hugepage/enabled          mount -o remount rw /proc/sys          echo 2000 > /proc/sys/net/core/somaxconn          echo 1 > /proc/sys/vm/overcommit_memory</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/acs/busybox<span class="token punctuation">:</span>v1.29.2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>redis        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">procMount</span><span class="token punctuation">:</span> Default</code></pre><p>äº¤ä»˜k8s</p><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f postgres.yaml <span class="token punctuation">-</span>n gitlabkubectl apply <span class="token punctuation">-</span>f redis.yaml <span class="token punctuation">-</span>n gitlab</code></pre><h3 id="2-4-é…ç½®gitlab"><a href="#2-4-é…ç½®gitlab" class="headerlink" title="2.4 é…ç½®gitlab"></a>2.4 é…ç½®gitlab</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># pv</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>etc  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>etc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/gitlab_etc    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18<span class="token comment" spellcheck="true"># pvc</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>etc<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>etc<span class="token comment" spellcheck="true"># pv</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>log  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>log<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/gitlab_log    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18<span class="token comment" spellcheck="true"># pvc</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>log<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>log      <span class="token comment" spellcheck="true"># pv</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>opt  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>opt<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/gitlab_opt    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18<span class="token comment" spellcheck="true"># pvc</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>opt<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>opt<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>ui      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>ssh      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">22</span>      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">22</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>cb<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>admin<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> gitlab      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/gitlab<span class="token punctuation">-</span>ce<span class="token punctuation">:</span>13.8.6<span class="token punctuation">-</span>ce.0          <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab          <span class="token key atrule">resources</span><span class="token punctuation">:</span>            <span class="token key atrule">requests</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 400m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2200Mi            <span class="token key atrule">limits</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 2000m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 2800Mi          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GITLAB_OMNIBUS_CONFIG              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">                postgresql['enable'] = false                gitlab_rails['db_username'] = "gitlab"                gitlab_rails['db_password'] = "bogeusepg"                gitlab_rails['db_host'] = "postgresql"                gitlab_rails['db_port'] = "5432"                gitlab_rails['db_database'] = "gitlabhq_production"                gitlab_rails['db_adapter'] = 'postgresql'                gitlab_rails['db_encoding'] = 'utf8'                redis['enable'] = false                gitlab_rails['redis_host'] = 'redis'                gitlab_rails['redis_port'] = '6379'                gitlab_rails['redis_password'] = 'bogeuseredis'                gitlab_rails['gitlab_shell_ssh_port'] = 22                external_url 'http://git.huhuhahei.cn/'                nginx['listen_port'] = 80                nginx['listen_https'] = false                #-------------------------------------------                gitlab_rails['gitlab_email_enabled'] = true                gitlab_rails['gitlab_email_from'] = 'admin@huhuhahei.cn'                gitlab_rails['gitlab_email_display_name'] = 'huhuhahei'                gitlab_rails['gitlab_email_reply_to'] = 'gitlab@boge.com'                gitlab_rails['gitlab_default_can_create_group'] = true                gitlab_rails['gitlab_username_changing_enabled'] = true                gitlab_rails['smtp_enable'] = true                gitlab_rails['smtp_address'] = "smtp.exmail.qq.com"                gitlab_rails['smtp_port'] = 465                gitlab_rails['smtp_user_name'] = "gitlab@boge.com"                gitlab_rails['smtp_password'] = "bogesendmail"                gitlab_rails['smtp_domain'] = "exmail.qq.com"                gitlab_rails['smtp_authentication'] = "login"                gitlab_rails['smtp_enable_starttls_auto'] = true                gitlab_rails['smtp_tls'] = true                #-------------------------------------------                # å…³é—­ promethues                prometheus['enable'] = false                # å…³é—­ grafana                grafana['enable'] = false                # å‡å°‘å†…å­˜å ç”¨                unicorn['worker_memory_limit_min'] = "200 * 1 &lt;&lt; 20"                unicorn['worker_memory_limit_max'] = "300 * 1 &lt;&lt; 20"                # å‡å°‘ sidekiq çš„å¹¶å‘æ•°                sidekiq['concurrency'] = 16                # å‡å°‘ postgresql æ•°æ®åº“ç¼“å­˜                postgresql['shared_buffers'] = "256MB"                # å‡å°‘ postgresql æ•°æ®åº“å¹¶å‘æ•°é‡                postgresql['max_connections'] = 8                # å‡å°‘è¿›ç¨‹æ•°   worker=CPUæ ¸æ•°+1                unicorn['worker_processes'] = 2                nginx['worker_processes'] = 2                puma['worker_processes'] = 2                # puma['per_worker_max_memory_mb'] = 850                # ä¿ç•™3å¤©å¤‡ä»½çš„æ•°æ®æ–‡ä»¶                gitlab_rails['backup_keep_time'] = 259200                #-------------------------------------------</span>          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> <span class="token string">"curl -s http://127.0.0.1/-/health|grep -w 'GitLab OK'"</span>            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">120</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> <span class="token string">"curl -s http://127.0.0.1/-/health|grep -w 'GitLab OK'"</span>            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">120</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/gitlab              <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab1            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/gitlab              <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab2            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/opt/gitlab              <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab3            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime              <span class="token key atrule">name</span><span class="token punctuation">:</span> tz<span class="token punctuation">-</span>config      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab1          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>etc<span class="token punctuation">-</span>pvc        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab2          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>log<span class="token punctuation">-</span>pvc        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab3          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> gitlab<span class="token punctuation">-</span>opt<span class="token punctuation">-</span>pvc        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tz<span class="token punctuation">-</span>config          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/share/zoneinfo/Asia/Shanghai      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">0</span>        <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">0</span></code></pre><p>ingress é…ç½®</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab<span class="token comment" spellcheck="true">#  annotations:</span><span class="token comment" spellcheck="true">#    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"</span><span class="token comment" spellcheck="true">#    nginx.ingress.kubernetes.io/proxy-body-size: "20m"</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> git.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix        <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">service</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> gitlab            <span class="token key atrule">port</span><span class="token punctuation">:</span>              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><p>äº¤ä»˜k8s</p><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f gitlab_ingress.yaml <span class="token punctuation">-</span>n gitlabkubectl apply <span class="token punctuation">-</span>f gitlab.yaml <span class="token punctuation">-</span>n gitlab</code></pre><h3 id="2-5-è®¿é—®æµ‹è¯•"><a href="#2-5-è®¿é—®æµ‹è¯•" class="headerlink" title="2.5 è®¿é—®æµ‹è¯•"></a>2.5 è®¿é—®æµ‹è¯•</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/3771605948.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> å¼€æºé¡¹ç›® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitå¸¸ç”¨å‘½ä»¤æ€»ç»“</title>
      <link href="/3b0bf668/"/>
      <url>/3b0bf668/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-æ–‡ä»¶æ“ä½œ"><a href="#ä¸€-æ–‡ä»¶æ“ä½œ" class="headerlink" title="ä¸€.æ–‡ä»¶æ“ä½œ"></a>ä¸€.æ–‡ä»¶æ“ä½œ</h1><h3 id="1-1-æ·»åŠ "><a href="#1-1-æ·»åŠ " class="headerlink" title="1.1 æ·»åŠ "></a>1.1 æ·»åŠ </h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> add <span class="token operator">&lt;</span>filename<span class="token operator">></span>                     //æ·»åŠ åˆ°æš‚å­˜åŒºï¼ˆstage<span class="token punctuation">)</span><span class="token function">git</span> add <span class="token keyword">.</span>                              //å…¨éƒ¨æäº¤åˆ°æš‚å­˜åŒº</code></pre><h3 id="1-2-æäº¤"><a href="#1-2-æäº¤" class="headerlink" title="1.2 æäº¤"></a>1.2 æäº¤</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> commit -m <span class="token operator">&lt;</span>description<span class="token operator">></span>           //æäº¤åˆ°æœ¬åœ°åº“<span class="token punctuation">(</span>å¿…é¡»å…ˆadd<span class="token punctuation">)</span><span class="token function">git</span> commit -am                        //å¯æäº¤æœªaddæ–‡ä»¶ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬æœªåˆ›å»ºæ–‡ä»¶<span class="token function">git</span> commit --amend -m <span class="token string">"description"</span>                    //è¿™ä¸ªå‘½ä»¤ä¼šå°†æš‚å­˜åŒºä¸­çš„æ–‡ä»¶æäº¤ã€‚ å¦‚æœè‡ªä¸Šæ¬¡æäº¤ä»¥æ¥ä½ è¿˜æœªåšä»»ä½•ä¿®æ”¹<span class="token punctuation">(</span>ä¾‹å¦‚ï¼Œåœ¨ä¸Šæ¬¡æäº¤åé©¬ä¸Šæ‰§è¡Œäº†æ­¤å‘½ä»¤<span class="token punctuation">)</span>ï¼Œé‚£ä¹ˆå¿«ç…§ä¼šä¿æŒä¸å˜ï¼Œè€Œä½ æ‰€ä¿®æ”¹çš„åªæ˜¯æäº¤ä¿¡æ¯ã€‚</code></pre><h3 id="1-3-åˆ é™¤"><a href="#1-3-åˆ é™¤" class="headerlink" title="1.3 åˆ é™¤"></a>1.3 åˆ é™¤</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> <span class="token function">rm</span> <span class="token operator">&lt;</span>file<span class="token operator">></span>             //ä»æš‚å­˜åŒºåˆ é™¤ï¼ˆstage<span class="token punctuation">)</span>  <span class="token function">git</span> <span class="token function">rm</span> -f <span class="token operator">&lt;</span>file<span class="token operator">></span>          //åˆ é™¤ä¹‹å‰ä¿®æ”¹è¿‡å¹¶ä¸”å·²ç»æ”¾åˆ°æš‚å­˜åŒºåŸŸ<span class="token function">git</span> <span class="token function">rm</span> --cached <span class="token operator">&lt;</span>file<span class="token operator">></span>    //å¦‚æœæŠŠæ–‡ä»¶ä»æš‚å­˜åŒºåŸŸç§»é™¤ï¼Œä½†ä»ç„¶å¸Œæœ›ä¿ç•™åœ¨å½“å‰å·¥ä½œç›®å½•ä¸­ï¼Œæ¢å¥è¯è¯´ï¼Œä»…æ˜¯ä»è·Ÿè¸ªæ¸…å•ä¸­åˆ é™¤</code></pre><h3 id="1-4-æ’¤é”€"><a href="#1-4-æ’¤é”€" class="headerlink" title="1.4 æ’¤é”€"></a>1.4 æ’¤é”€</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> HEAD<span class="token function">git</span> HEAD~        //ä¸Šä¸€ä¸ªç‰ˆæœ¬<span class="token function">git</span> HEAD~100     //å¾€ä¸Š100ä¸ªç‰ˆæœ¬<span class="token comment" spellcheck="true">#æ’¤é”€add</span><span class="token function">git</span> checkout <span class="token operator">&lt;</span>file<span class="token operator">></span>          //æ¢å¤æœªæäº¤çš„æ›´æ”¹<span class="token function">git</span> reset HEAD <span class="token operator">&lt;</span>file<span class="token operator">></span>        //å–æ¶ˆä¹‹å‰ <span class="token function">git</span> add æ·»åŠ <span class="token comment" spellcheck="true">#æ’¤é”€commit</span><span class="token function">git</span> reset --hard HEAD~              //å›é€€åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬<span class="token function">git</span> reset --hard <span class="token operator">&lt;</span>commit ID<span class="token operator">></span>        //å›é€€åˆ°æŒ‡å®šç‰ˆæœ¬</code></pre><h1 id="äºŒ-åˆ†æ”¯æ“ä½œ"><a href="#äºŒ-åˆ†æ”¯æ“ä½œ" class="headerlink" title="äºŒ.åˆ†æ”¯æ“ä½œ"></a>äºŒ.åˆ†æ”¯æ“ä½œ</h1><h3 id="2-1-åˆ›å»ºåˆ†æ”¯"><a href="#2-1-åˆ›å»ºåˆ†æ”¯" class="headerlink" title="2.1 åˆ›å»ºåˆ†æ”¯"></a>2.1 åˆ›å»ºåˆ†æ”¯</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> branch <span class="token operator">&lt;</span>branch name<span class="token operator">></span>               //åˆ›å»ºåˆ†æ”¯<span class="token function">git</span> checkout <span class="token operator">&lt;</span>branch name<span class="token operator">></span>             //åˆ‡æ¢åˆ°åˆ†æ”¯<span class="token function">git</span> checkout -b <span class="token operator">&lt;</span>branch name<span class="token operator">></span>          //åˆ›å»ºå¹¶åˆ‡æ¢åˆ°åˆ†æ”¯</code></pre><h3 id="2-2-åˆ é™¤åˆ†æ”¯"><a href="#2-2-åˆ é™¤åˆ†æ”¯" class="headerlink" title="2.2 åˆ é™¤åˆ†æ”¯"></a>2.2 åˆ é™¤åˆ†æ”¯</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> branch -d <span class="token operator">&lt;</span>branch name<span class="token operator">></span><span class="token function">git</span> branch -D <span class="token operator">&lt;</span>branch name<span class="token operator">></span>       //å¼ºåˆ¶åˆ é™¤åˆ†æ”¯</code></pre><h3 id="2-3-æŸ¥çœ‹åˆ†æ”¯"><a href="#2-3-æŸ¥çœ‹åˆ†æ”¯" class="headerlink" title="2.3 æŸ¥çœ‹åˆ†æ”¯"></a>2.3 æŸ¥çœ‹åˆ†æ”¯</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> branch <span class="token operator">&lt;</span>name<span class="token operator">></span><span class="token function">git</span> branch -a      //æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯<span class="token function">git</span> branch -r      //æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯</code></pre><h3 id="2-4-é‡å‘½ååˆ†æ”¯"><a href="#2-4-é‡å‘½ååˆ†æ”¯" class="headerlink" title="2.4 é‡å‘½ååˆ†æ”¯"></a>2.4 é‡å‘½ååˆ†æ”¯</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> branch -m <span class="token operator">&lt;</span>old name<span class="token operator">></span> <span class="token operator">&lt;</span>new name<span class="token operator">></span></code></pre><h3 id="2-5-åˆå¹¶åˆ†æ”¯"><a href="#2-5-åˆå¹¶åˆ†æ”¯" class="headerlink" title="2.5 åˆå¹¶åˆ†æ”¯"></a>2.5 åˆå¹¶åˆ†æ”¯</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> checkout master                    //åˆ‡æ¢åˆ°master<span class="token function">git</span> merge <span class="token operator">&lt;</span>branch name<span class="token operator">></span>                //åˆå¹¶åˆ†æ”¯</code></pre><h1 id="ä¸‰-æ‹‰å–å’Œæäº¤"><a href="#ä¸‰-æ‹‰å–å’Œæäº¤" class="headerlink" title="ä¸‰.æ‹‰å–å’Œæäº¤"></a>ä¸‰.æ‹‰å–å’Œæäº¤</h1><h3 id="3-1-æ‹‰å–æ•°æ®"><a href="#3-1-æ‹‰å–æ•°æ®" class="headerlink" title="3.1 æ‹‰å–æ•°æ®"></a>3.1 æ‹‰å–æ•°æ®</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> pull origin master</code></pre><h3 id="3-2-æ¨é€æœ¬åœ°æ•°æ®åˆ°è¿œç¨‹ä»“åº“"><a href="#3-2-æ¨é€æœ¬åœ°æ•°æ®åˆ°è¿œç¨‹ä»“åº“" class="headerlink" title="3.2 æ¨é€æœ¬åœ°æ•°æ®åˆ°è¿œç¨‹ä»“åº“"></a>3.2 æ¨é€æœ¬åœ°æ•°æ®åˆ°è¿œç¨‹ä»“åº“</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">git</span> push origin master</code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DevOps </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sé…ç½®log-pilotæ”¶é›†æœåŠ¡æ—¥å¿—</title>
      <link href="/2f425938/"/>
      <url>/2f425938/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€.å‰è¨€"></a>ä¸€.å‰è¨€</h1><h3 id="1-1-ç®€ä»‹"><a href="#1-1-ç®€ä»‹" class="headerlink" title="1.1 ç®€ä»‹"></a>1.1 ç®€ä»‹</h3><p>Log-Pilotå…·æœ‰è‡ªåŠ¨å‘ç°æœºåˆ¶: å®¹å™¨é…ç½®å¥½tagåå°±ä¼šè¢«é‡‡é›†ç»„ä»¶å‘ç°<br>CheckPointå¥æŸ„ä¿æŒçš„æœºåˆ¶: å¯¹äºæ—¥å¿—æ–‡ä»¶çš„å¥æŸ„åšè·Ÿè¸ª<br>è‡ªåŠ¨æ—¥å¿—æ•°æ®æ‰“æ ‡: é€šè¿‡å¯¹å®¹å™¨åŠ tagï¼Œè¿™ä¸ªtagä¼šè¢«è®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œå–å‡ºæ—¥å¿—çš„æ—¶å€™å°±å¯ä»¥é€šè¿‡è¿™ä¸ªtagæ¥åŒºåˆ†æ•°æ®<br>æœ‰æ•ˆåº”å¯¹åŠ¨æ€é…ç½®: å®¹å™¨æ‰©ç¼©å®¹çš„æ—¶å€™èƒ½å¤Ÿè‡ªåŠ¨å¤„ç†<br>æ—¥å¿—é‡å¤å’Œä¸¢å¤±ä»¥åŠæ—¥å¿—æºæ ‡è®°ç­‰é—®é¢˜: é€šè¿‡å¥æŸ„ä¿æŒå®ç°</p><h1 id="äºŒ-éƒ¨ç½²æœåŠ¡"><a href="#äºŒ-éƒ¨ç½²æœåŠ¡" class="headerlink" title="äºŒ.éƒ¨ç½²æœåŠ¡"></a>äºŒ.éƒ¨ç½²æœåŠ¡</h1><h3 id="2-1-é…ç½®log-pilot"><a href="#2-1-é…ç½®log-pilot" class="headerlink" title="2.1 é…ç½®log-pilot"></a>2.1 é…ç½®log-pilot</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>pilot  <span class="token key atrule">name</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>pilot  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>pilot  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>pilot    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NODE_NAME          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>              <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> spec.nodeName        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PILOT_LOG_PREFIX          <span class="token key atrule">value</span><span class="token punctuation">:</span> aliyun        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LOGGING_OUTPUT          <span class="token key atrule">value</span><span class="token punctuation">:</span> elasticsearch        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ELASTICSEARCH_HOSTS          <span class="token key atrule">value</span><span class="token punctuation">:</span> elasticsearch.logs<span class="token punctuation">:</span><span class="token number">9200</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/log<span class="token punctuation">-</span>pilot<span class="token punctuation">:</span>filebeat<span class="token punctuation">-</span>7.9.2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /pilot/healthz          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">2</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>pilot        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">limits</span><span class="token punctuation">:</span>            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 500Mi          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 200Mi        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>            <span class="token key atrule">add</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> SYS_ADMIN        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/docker.sock          <span class="token key atrule">name</span><span class="token punctuation">:</span> sock        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host          <span class="token key atrule">name</span><span class="token punctuation">:</span> root          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/filebeat          <span class="token key atrule">name</span><span class="token punctuation">:</span> varlib        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/filebeat          <span class="token key atrule">name</span><span class="token punctuation">:</span> varlog        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime          <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime          <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule        <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/docker.sock          <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">""</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> sock      <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /          <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">""</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> root      <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/filebeat          <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate        <span class="token key atrule">name</span><span class="token punctuation">:</span> varlib      <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/log/filebeat          <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate        <span class="token key atrule">name</span><span class="token punctuation">:</span> varlog      <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime          <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">""</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate</code></pre><p>äº¤ä»˜k8s</p><pre class=" language-bash"><code class="language-bash">kubectl apply -f log-pilot_ds.yaml</code></pre><p>æŸ¥çœ‹çŠ¶æ€</p><pre class=" language-bash"><code class="language-bash">kubectl get po -n logs <span class="token operator">|</span> <span class="token function">grep</span> log-pilog-pilot-fs5nt                  1/1     Running   0          46mlog-pilot-nrkwn                  1/1     Running   0          46mlog-pilot-tpvmb                  1/1     Running   0          46m</code></pre><h1 id="ä¸‰-æœåŠ¡å†…é…ç½®æ—¥å¿—æ”¶é›†"><a href="#ä¸‰-æœåŠ¡å†…é…ç½®æ—¥å¿—æ”¶é›†" class="headerlink" title="ä¸‰.æœåŠ¡å†…é…ç½®æ—¥å¿—æ”¶é›†"></a>ä¸‰.æœåŠ¡å†…é…ç½®æ—¥å¿—æ”¶é›†</h1><h3 id="3-1æ”¶é›†å®¹å™¨stdout"><a href="#3-1æ”¶é›†å®¹å™¨stdout" class="headerlink" title="3.1æ”¶é›†å®¹å™¨stdout"></a>3.1æ”¶é›†å®¹å™¨stdout</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_note<span class="token punctuation">-</span>stdout          <span class="token key atrule">value</span><span class="token punctuation">:</span> stdout</code></pre><p>é€šè¿‡å®¹å™¨ä¸­æ·»åŠ envå®ç°è‡ªåŠ¨æ‹‰å–æ—¥å¿—</p><p>esç›´æ¥æ·»åŠ ç´¢å¼•å³å¯<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/376998505.jpg"></p><h3 id="3-2-æ”¶é›†æœåŠ¡æ—¥å¿—"><a href="#3-2-æ”¶é›†æœåŠ¡æ—¥å¿—" class="headerlink" title="3.2 æ”¶é›†æœåŠ¡æ—¥å¿—"></a>3.2 æ”¶é›†æœåŠ¡æ—¥å¿—</h3><p>é…ç½®å¦‚ä¸‹ éœ€è¦æ·»åŠ æ—¥å¿—è·¯å¾„ ä¸”æŒ‚è½½æ•°æ®å·</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_note<span class="token punctuation">-</span>logs     <span class="token key atrule">value</span><span class="token punctuation">:</span> /wiz/logs/*.log  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /wiz/logs     <span class="token key atrule">name</span><span class="token punctuation">:</span> wiz<span class="token punctuation">-</span>log<span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token key atrule">name</span><span class="token punctuation">:</span> wiz<span class="token punctuation">-</span>log</code></pre><p>esä¸­æŸ¥çœ‹</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/1222845714.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> ELK </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> EFK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis-insighté…ç½®</title>
      <link href="/c065ae07/"/>
      <url>/c065ae07/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€.å‰è¨€"></a>ä¸€.å‰è¨€</h1><h3 id="1-1-ä»‹ç»"><a href="#1-1-ä»‹ç»" class="headerlink" title="1.1 ä»‹ç»"></a>1.1 ä»‹ç»</h3><p>RedisInsightæ—¨åœ¨äºç®€åŒ–Redisåº”ç”¨ç¨‹åºå¼€å‘ã€‚</p><h3 id="1-2-åŠŸèƒ½ä»‹ç»"><a href="#1-2-åŠŸèƒ½ä»‹ç»" class="headerlink" title="1.2 åŠŸèƒ½ä»‹ç»"></a>1.2 åŠŸèƒ½ä»‹ç»</h3><ul><li>å¯è§†åŒ–å¹¶ä¸Redisæ•°æ®åº“äº¤äº’<br>æ‰«æç°æœ‰å¯†é’¥ï¼Œæ·»åŠ æ–°å¯†é’¥ï¼Œæ‰§è¡ŒCRUDæˆ–æ‰¹é‡æ“ä½œã€‚ä»¥æ¼‚äº®çš„æ‰“å°JSONå¯¹è±¡æ ¼å¼æ˜¾ç¤ºå¯¹è±¡ï¼Œå¹¶æ”¯æŒå‹å¥½çš„é”®ç›˜å¯¼èˆªã€‚</li><li>å¯¹Redisæ¨¡å—çš„å†…ç½®æ”¯æŒ<br>æŸ¥è¯¢ã€å¯è§†åŒ–å’Œäº¤äº’å¼æ“ä½œå›¾å½¢ã€æµå’Œæ—¶é—´åºåˆ—æ•°æ®ã€‚ä½¿ç”¨å¤šè¡ŒæŸ¥è¯¢ç¼–è¾‘å™¨ç”ŸæˆæŸ¥è¯¢ã€æµè§ˆç»“æœã€ä¼˜åŒ–å’Œå¿«é€Ÿè¿­ä»£ã€‚æ”¯æŒRedisJSONã€RediSearchã€RedisGraphã€Streamsã€RedisTimeSerieså’ŒRedisGearsã€‚</li><li>Redisçš„å†…å­˜åˆ†æ<br>ç¦»çº¿åˆ†æå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œé€šè¿‡å¯†é’¥æ¨¡å¼ã€å¯†é’¥è¿‡æœŸå’Œé«˜çº§æœç´¢æ¥ç¡®å®šå†…å­˜é—®é¢˜ï¼Œè€Œä¸å½±å“Redisçš„æ€§èƒ½ã€‚åˆ©ç”¨å»ºè®®å‡å°‘å†…å­˜ä½¿ç”¨ã€‚</li><li>Trace Rediså‘½ä»¤<br>è¯†åˆ«é¡¶é”®ã€é”®æ¨¡å¼å’Œå‘½ä»¤ã€‚æŒ‰ç¾¤é›†æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„å®¢æˆ·ç«¯IPåœ°å€ã€å¯†é’¥æˆ–å‘½ä»¤è¿›è¡Œç­›é€‰ã€‚æœ‰æ•ˆåœ°è°ƒè¯•Luaè„šæœ¬</li><li>ç›´è§‚çš„CLI<br>å½“ä¸€ä¸ªGUIè¿˜ä¸å¤Ÿæ—¶ï¼Œæˆ‘ä»¬çš„å‘½ä»¤è¡Œç•Œé¢åˆ©ç”¨redis cliæä¾›è¯­æ³•é«˜äº®æ˜¾ç¤ºå’Œè‡ªåŠ¨å®Œæˆï¼Œå¹¶ä½¿ç”¨é›†æˆçš„å¸®åŠ©æ¥æä¾›ç›´è§‚çš„å³æ—¶å¸®åŠ©ã€‚</li></ul><h1 id="äºŒ-å®‰è£…é…ç½®"><a href="#äºŒ-å®‰è£…é…ç½®" class="headerlink" title="äºŒ.å®‰è£…é…ç½®"></a>äºŒ.å®‰è£…é…ç½®</h1><h3 id="2-1-å®‰è£…"><a href="#2-1-å®‰è£…" class="headerlink" title="2.1 å®‰è£…"></a>2.1 å®‰è£…</h3><ol><li>Deployment</li></ol><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># RedisInsight deployment with name 'redisinsight'</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redisinsight <span class="token comment" spellcheck="true">#deployment name</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redisinsight <span class="token comment" spellcheck="true">#deployment label</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment" spellcheck="true">#a single replica pod</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> redisinsight <span class="token comment" spellcheck="true">#which pods is the deployment managing, as defined by the pod template</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#pod template</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> redisinsight <span class="token comment" spellcheck="true">#label for pod/s</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> redisinsight<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>claim      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init          <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /bin/sh            <span class="token punctuation">-</span> <span class="token string">'-c'</span>            <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">              chown -R 1001 /db</span>          <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /db          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>  redisinsight <span class="token comment" spellcheck="true">#Container name (DNS_LABEL, unique)</span>          <span class="token key atrule">image</span><span class="token punctuation">:</span> redislabs/redisinsight<span class="token punctuation">:</span>latest <span class="token comment" spellcheck="true">#repo/image</span>          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment" spellcheck="true">#Always pull image</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> db <span class="token comment" spellcheck="true">#Pod volumes to mount into the container's filesystem. Cannot be updated.</span>            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /db          <span class="token key atrule">ports</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8001 </span><span class="token comment" spellcheck="true">#exposed container port and protocol</span>            <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</code></pre><ol start="2"><li>pvc</li></ol><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redisinsight<span class="token punctuation">-</span>pv<span class="token punctuation">-</span>claim  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redisinsight<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>storageclass</code></pre><ol start="3"><li>svc</li></ol><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redisinsight<span class="token punctuation">-</span>service<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8001</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redisinsight</code></pre><h3 id="2-2-äº¤ä»˜k8s"><a href="#2-2-äº¤ä»˜k8s" class="headerlink" title="2.2 äº¤ä»˜k8s"></a>2.2 äº¤ä»˜k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f .</code></pre><h3 id="webé¡µé¢æŸ¥çœ‹"><a href="#webé¡µé¢æŸ¥çœ‹" class="headerlink" title="webé¡µé¢æŸ¥çœ‹"></a>webé¡µé¢æŸ¥çœ‹</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/3852309014.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Yearning SQLå®¡æ ¸å·¥å…·ä¸‹è½½</title>
      <link href="/b50f8db9/"/>
      <url>/b50f8db9/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€.å‰è¨€"></a>ä¸€.å‰è¨€</h1><h3 id="1-1-ç®€ä»‹"><a href="#1-1-ç®€ä»‹" class="headerlink" title="1.1 ç®€ä»‹"></a>1.1 ç®€ä»‹</h3><p><strong>Yearning</strong> é¢å‘ä¸­å°å‹ä¼ä¸šçš„è½»é‡çº§MySQL SQLè¯­å¥å®¡æ ¸å¹³å°.æä¾›æŸ¥è¯¢å®¡è®¡ï¼ŒSQLå®¡æ ¸ç­‰å¤šç§åŠŸèƒ½.</p><h1 id="äºŒ-å®‰è£…"><a href="#äºŒ-å®‰è£…" class="headerlink" title="äºŒ.å®‰è£…"></a>äºŒ.å®‰è£…</h1><h3 id="2-1-ä¸‹è½½å‹ç¼©åŒ…"><a href="#2-1-ä¸‹è½½å‹ç¼©åŒ…" class="headerlink" title="2.1 ä¸‹è½½å‹ç¼©åŒ…"></a>2.1 ä¸‹è½½å‹ç¼©åŒ…</h3><p><a href="https://github.com/cookieY/Yearning/releases/download/2.3.5/Yearning-2.3.5-linux-amd64.zip">ç‚¹å‡»ä¸‹è½½</a></p><p>è§£å‹æ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash">unzip Yearning-2.3.5-linux-amd64.zip</code></pre><p>æŸ¥çœ‹å¸®åŠ©</p><pre class=" language-bash"><code class="language-bash">./Yearning --helpYearning Mysqlæ•°æ®å®¡æ ¸å¹³å° <span class="token punctuation">(</span>Version: 2.3.4 Neptune<span class="token punctuation">)</span>Usage:  ./Yearning <span class="token punctuation">[</span>Global Options<span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">{</span>command<span class="token punctuation">}</span> <span class="token punctuation">[</span>--option <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>argument <span class="token punctuation">..</span>.<span class="token punctuation">]</span>Global Options:  -h, --help              Display the <span class="token function">help</span> information      --no-color          Disable color when outputting message      --no-interactive    Disable interactive confirmation operations      --no-progress       Disable display progress message      --verbose           Set error reporting level<span class="token punctuation">(</span>quiet 0 - 4 debug<span class="token punctuation">)</span> <span class="token punctuation">(</span>default 1<span class="token punctuation">)</span>  -V, --version           Display app version informationAvailable Commands:  genac        Generate auto complete scripts <span class="token keyword">for</span> current application <span class="token punctuation">(</span>alias: gen-ac<span class="token punctuation">)</span>  <span class="token function">install</span>      Yearningå®‰è£…åŠæ•°æ®åˆå§‹åŒ–  migrate      ç ´åæ€§ç‰ˆæœ¬å‡çº§ä¿®å¤  reset_super  é‡ç½®è¶…çº§ç®¡ç†å‘˜å¯†ç   run          å¯åŠ¨Yearning  <span class="token function">help</span>         Display <span class="token function">help</span> informationUse <span class="token string">"./Yearning {COMMAND} -h"</span> <span class="token keyword">for</span> <span class="token function">more</span> information about a <span class="token function">command</span></code></pre><h3 id="2-2-é…ç½®æ•°æ®åº“"><a href="#2-2-é…ç½®æ•°æ®åº“" class="headerlink" title="2.2 é…ç½®æ•°æ®åº“"></a>2.2 é…ç½®æ•°æ®åº“</h3><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>Mysql<span class="token punctuation">]</span>Db <span class="token operator">=</span> <span class="token string">"Yearning"</span>                <span class="token comment" spellcheck="true">#æœåŠ¡è¿æ¥æ‰€éœ€è¦è¿æ¥çš„æ•°æ®åº“</span>Host <span class="token operator">=</span> <span class="token string">"192.168.0.10"</span>        <span class="token comment" spellcheck="true">#mysqlåœ°å€</span>Port <span class="token operator">=</span> <span class="token string">"3306"</span>                       <span class="token comment" spellcheck="true">#ç«¯å£</span>Password <span class="token operator">=</span> <span class="token string">"123456"</span>          <span class="token comment" spellcheck="true">#å¯†ç </span>User <span class="token operator">=</span> <span class="token string">"root"</span>                       <span class="token comment" spellcheck="true">#ç”¨æˆ·</span><span class="token punctuation">[</span>General<span class="token punctuation">]</span>SecretKey <span class="token operator">=</span> <span class="token string">"FtUDyUgelhkDWtHi"</span>      <span class="token comment" spellcheck="true">#åŠ å¯†è§£å¯†æ‰€éœ€è¦çš„key</span>Hours <span class="token operator">=</span> 4</code></pre><h3 id="2-3-åˆ¶ä½œé•œåƒ"><a href="#2-3-åˆ¶ä½œé•œåƒ" class="headerlink" title="2.3 åˆ¶ä½œé•œåƒ"></a>2.3 åˆ¶ä½œé•œåƒ</h3><pre class=" language-yaml"><code class="language-yaml">FROM alpine<span class="token punctuation">:</span><span class="token number">3.12</span>LABEL maintainer="HenryYee<span class="token punctuation">-</span>2020/11/16"EXPOSE 8000COPY Yearning  /opt/YearningCOPY conf.toml /opt/conf.tomlRUN echo "http<span class="token punctuation">:</span>//mirrors.ustc.edu.cn/alpine/v3.12/main/" <span class="token punctuation">></span> /etc/apk/repositories &amp;&amp; \      apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache tzdata libc6<span class="token punctuation">-</span>compat &amp;&amp; \      ln <span class="token punctuation">-</span>sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; \      echo "Asia/Shanghai" <span class="token punctuation">></span><span class="token punctuation">></span> /etc/timezone &amp;&amp; \      echo 'hosts<span class="token punctuation">:</span> files mdns4_minimal <span class="token punctuation">[</span>NOTFOUND=return<span class="token punctuation">]</span> dns mdns4' <span class="token punctuation">></span><span class="token punctuation">></span> /etc/nsswitch.confWORKDIR /optCMD /opt/Yearning install &amp;&amp; /opt/Yearning run</code></pre><pre class=" language-bash"><code class="language-bash">docker build <span class="token keyword">.</span> -t yearning:1.0</code></pre><h3 id="2-4-äº¤ä»˜k8s"><a href="#2-4-äº¤ä»˜k8s" class="headerlink" title="2.4 äº¤ä»˜k8s"></a>2.4 äº¤ä»˜k8s</h3><p>Deployment</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment" spellcheck="true"># for versions before 1.8.0 use apps/v1beta1</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> yearning  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yearning<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> yearning  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> yearning    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yearning        <span class="token key atrule">image</span><span class="token punctuation">:</span> yearning<span class="token punctuation">:</span><span class="token number">1.0</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8000</span>        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span></code></pre><p>svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> yearning <span class="token comment" spellcheck="true">#TODO: to specify your service name</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ops  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yearning<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yearning <span class="token comment" spellcheck="true">#TODO: change label selector to match your backend pod</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8000</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><pre class=" language-bash"><code class="language-bash">kubectl apply -f <span class="token keyword">.</span></code></pre><h1 id="ä¸‰-è®¿é—®æµ‹è¯•"><a href="#ä¸‰-è®¿é—®æµ‹è¯•" class="headerlink" title="ä¸‰.è®¿é—®æµ‹è¯•"></a>ä¸‰.è®¿é—®æµ‹è¯•</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/4270559722.jpg"><br>é»˜è®¤ç”¨æˆ·åå¯†ç <br>admin&#x2F;Yearning_admin<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/3863493400.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> å¼€æºé¡¹ç›® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sé…ç½®Mongoé›†ç¾¤</title>
      <link href="/660145b4/"/>
      <url>/660145b4/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h1><p>éšç€å‘å±• k8så¯¹äºæœ‰çŠ¶æ€åº”ç”¨çš„é€‚åº”å·²ç»è¶Šæ¥è¶Šå¥½ ä¸‹é¢å°±é’ˆå¯¹mongo dbçš„éƒ¨ç½²ä¸ºå¤§å®¶åˆ†äº«ä¸‹k8s stsæ§åˆ¶å™¨çš„ä½¿ç”¨</p><hr><h1 id="äºŒ-éƒ¨ç½²"><a href="#äºŒ-éƒ¨ç½²" class="headerlink" title="äºŒ éƒ¨ç½²"></a>äºŒ éƒ¨ç½²</h1><h3 id="2-1-ç¯å¢ƒå‡†å¤‡"><a href="#2-1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.1 ç¯å¢ƒå‡†å¤‡"></a>2.1 ç¯å¢ƒå‡†å¤‡</h3><p>æ•°æ®åº“è¿™ç§æ ¸å¿ƒç»„ä»¶ é¦–å…ˆéœ€è¦å‡†å¤‡æŒä¹…åŒ–çš„æ•°æ®å· è¿™é‡Œå°±ä½¿ç”¨scåŠ¨æ€å­˜å‚¨æ¥ä½œä¸ºåº•å±‚å­˜å‚¨</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>mongo<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>mongo<span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain<span class="token key atrule">volumeBindingMode</span><span class="token punctuation">:</span> Immediate</code></pre><p>åˆ›å»ºns</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo</code></pre><p>é…ç½®cm</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>keyfile  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">key.txt</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>    nX24aaT7/WOQKOfchxP66kulNNdjSn5LpsE/RbDL7gwMIqZ424WQVCOJzRV5YMw9    fQ0pz591I+U+G2/iP8PEPF6po1/rLKi1LotoKV+ubh336N/TCMzi86OH3aibNVyC    ydhbw6hTrtYxaZatxyKHZ7C8K39su05T0cDh1iqCYDBEkxUh5zYUafwfxa5GC5Ar    +NGiDhrZJXj+fjGBhUOBA8yl0fG7V5lx56PIJ7u9M+EaFoJcoYembSZ40A/JRcmO    wV76/5sng1HQ0A016xh3WPFrUkSrie3RqmpjTP/gx7sej3fiheOxNmjjFYcR4Fof    Y3VH+MXs0qJm4HIcJUIEnYInunFlsbpyrSFu77sgfXuL/zYkozK3CPaK5+kZZCfY    FqsTxo9xWI9D8QVpXlSU7Pbj4g8DatHBjAxQWgDgEFxABhypILz56RsDybQ8aNtX    OWuEhJJUvjAMEYutTOSM80ATYSFh+XbB19n5SthDfcz9RvJ+XMdn6biBZwS46vqb    oKWaM2U7lpNC2ZvhEAfGYsHwPfs98ak4O1n1iYQVeohC+TkQdrJQk5sppMp2bu5b    hcG0qrYOWgjXS3EayMMAwYKBAcyb0sCugFIY4KeCl3RMzJpnSVL916LwXuOaHRTb    SkFrbgEapveUaGB+NCARJq/NUi2sA16gpGVoLVYctJCHnJVNhTQ1bH32I7PULiL8    6fae3gLs6yTbC8Isdn4CqkJP4yB7ae8z9VOYpTouP7YblJaGfcQ/pGD0xWVCj4BL    IXhsEygotZj+3RySpFFwedX/Ku5JDMlA7FDbwNguUBPUtO6a8osiw5jSb8wplFXZ    ei8LgkyGx6onVrIgzuQv0CDm9tUpdgNuf8d7CYYWLyZBpTuBFrbJdnWQ1ViigRq5    wlKzb2yL76KxiIch4JwL61XTC/6+k5K2opGimAP8Ebft9tfB0M38cFfrdD7PJCL5    x7c9cfDxO4O56DNzpPimyW6pJ6nw</code></pre><h3 id="2-2-é…ç½®sts"><a href="#2-2-é…ç½®sts" class="headerlink" title="2.2 é…ç½®sts"></a>2.2 é…ç½®sts</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">environment</span><span class="token punctuation">:</span> test      <span class="token key atrule">role</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">environment</span><span class="token punctuation">:</span> test        <span class="token key atrule">role</span><span class="token punctuation">:</span> mongo      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">kubesphere.io/restartedAt</span><span class="token punctuation">:</span> <span class="token string">'2022-03-05T07:52:33.099Z'</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>keyfile          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>keyfile            <span class="token key atrule">items</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> key.txt                <span class="token key atrule">path</span><span class="token punctuation">:</span> key.txt            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> fix<span class="token punctuation">-</span>permissions          <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/busybox          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> sh            <span class="token punctuation">-</span> <span class="token string">'-c'</span>            <span class="token punctuation">-</span> <span class="token punctuation">></span><span class="token punctuation">-</span>              cp /data/key.txt /data/db/key &amp;&amp; chown 999<span class="token punctuation">:</span>999 /data/db/key &amp;&amp;              chmod 400 /data/db/key  &amp;&amp; ls <span class="token punctuation">-</span>l /data/          <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/db            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>keyfile              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/key.txt              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> key.txt          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo          <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/mongo<span class="token punctuation">:</span>4.2.8          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> docker<span class="token punctuation">-</span>entrypoint.sh            <span class="token punctuation">-</span> <span class="token string">'--replSet'</span>            <span class="token punctuation">-</span> rs0            <span class="token punctuation">-</span> <span class="token string">'--bind_ip'</span>            <span class="token punctuation">-</span> 0.0.0.0            <span class="token punctuation">-</span> <span class="token string">'--auth'</span>            <span class="token punctuation">-</span> <span class="token string">'--clusterAuthMode'</span>            <span class="token punctuation">-</span> keyFile            <span class="token punctuation">-</span> <span class="token string">'--keyFile'</span>            <span class="token punctuation">-</span> /data/db/key          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_INITDB_ROOT_USERNAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> root            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_INITDB_ROOT_PASSWORD              <span class="token key atrule">value</span><span class="token punctuation">:</span> dSJN52PuSqn          <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/db            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>keyfile              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/key.txt              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> key.txt          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>sidecar          <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/k8s<span class="token punctuation">-</span>mongo<span class="token punctuation">-</span>sidecar          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KUBERNETES_POD_LABELS              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'role=mongo,environment=test'</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KUBERNETES_NAMESPACE              <span class="token key atrule">value</span><span class="token punctuation">:</span> mongo            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_USERNAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> root            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_PASSWORD              <span class="token key atrule">value</span><span class="token punctuation">:</span> dSJN52PuSqn            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MONGO_DATABASE              <span class="token key atrule">value</span><span class="token punctuation">:</span> admin            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KUBERNETES_SERVICE_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> mongo          <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim      <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1      <span class="token key atrule">metadata</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo        <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">spec</span><span class="token punctuation">:</span>        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> ReadWriteOnce        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 20Gi        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>mongo        <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem      <span class="token key atrule">status</span><span class="token punctuation">:</span>        <span class="token key atrule">phase</span><span class="token punctuation">:</span> Pending  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> OrderedReady  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">0</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span></code></pre><p>å› ä¸ºmongo-sidecaréœ€è¦ç›‘æ§mongoçŠ¶æ€æ‰€ä»¥éœ€è¦åˆ›å»ºClusterRoleBinding</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span><span class="token key atrule">name</span><span class="token punctuation">:</span> mongo<span class="token punctuation">-</span>default<span class="token punctuation">-</span>view<span class="token key atrule">roleRef</span><span class="token punctuation">:</span><span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">name</span><span class="token punctuation">:</span> view<span class="token key atrule">subjects</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount  <span class="token key atrule">name</span><span class="token punctuation">:</span> default  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default</code></pre><h3 id="2-3-é…ç½®svc"><a href="#2-3-é…ç½®svc" class="headerlink" title="2.3 é…ç½®svc"></a>2.3 é…ç½®svc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">27017</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">27017</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">role</span><span class="token punctuation">:</span> mongo  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None</code></pre><h3 id="2-4-äº¤ä»˜k8s"><a href="#2-4-äº¤ä»˜k8s" class="headerlink" title="2.4 äº¤ä»˜k8s"></a>2.4 äº¤ä»˜k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f .</code></pre><hr><h1 id="ä¸‰-éªŒè¯"><a href="#ä¸‰-éªŒè¯" class="headerlink" title="ä¸‰ éªŒè¯"></a>ä¸‰ éªŒè¯</h1><h3 id="3-1-è¿æ¥æµ‹è¯•"><a href="#3-1-è¿æ¥æµ‹è¯•" class="headerlink" title="3.1 è¿æ¥æµ‹è¯•"></a>3.1 è¿æ¥æµ‹è¯•</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># mongo -uroot -p dSJN52PuSqn</span>MongoDB shell version v4.2.8connecting to: mongodb://127.0.0.1:27017/?compressors<span class="token operator">=</span>disabled<span class="token operator">&amp;</span>gssapiServiceName<span class="token operator">=</span>mongodbImplicit session: session <span class="token punctuation">{</span> <span class="token string">"id"</span> <span class="token keyword">:</span> UUID<span class="token punctuation">(</span><span class="token string">"8f142a74-c99c-48df-8c37-5107f846e4a5"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>MongoDB server version: 4.2.8Server has startup warnings:2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> ** WARNING: /sys/kernel/mm/transparent_hugepage/enabled is <span class="token string">'always'</span><span class="token keyword">.</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> **        We suggest setting it to <span class="token string">'never'</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> ** WARNING: /sys/kernel/mm/transparent_hugepage/defrag is <span class="token string">'always'</span><span class="token keyword">.</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span> **        We suggest setting it to <span class="token string">'never'</span>2022-03-05T07:53:05.774+0000 I  CONTROL  <span class="token punctuation">[</span>initandlisten<span class="token punctuation">]</span>---Enable MongoDB's <span class="token function">free</span> cloud-based monitoring service, <span class="token function">which</span> will <span class="token keyword">then</span> receive and displaymetrics about your deployment <span class="token punctuation">(</span>disk utilization, CPU, operation statistics, etc<span class="token punctuation">)</span>.The monitoring data will be available on a MongoDB website with a unique URL accessible to youand anyone you share the URL with. MongoDB may use this information to <span class="token function">make</span> productimprovements and to suggest MongoDB products and deployment options to you.To <span class="token function">enable</span> <span class="token function">free</span> monitoring, run the following command: db.enableFreeMonitoring<span class="token punctuation">(</span><span class="token punctuation">)</span>To permanently disable this reminder, run the following command: db.disableFreeMonitoring<span class="token punctuation">(</span><span class="token punctuation">)</span>---rs0:PRIMARY<span class="token operator">></span> rs.statusfunction<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> db._adminCommand<span class="token punctuation">(</span><span class="token string">"replSetGetStatus"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>rs0:PRIMARY<span class="token operator">></span> rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token string">"set"</span> <span class="token keyword">:</span> <span class="token string">"rs0"</span>,        <span class="token string">"date"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:10.117Z"</span><span class="token punctuation">)</span>,        <span class="token string">"myState"</span> <span class="token keyword">:</span> 1,        <span class="token string">"term"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>,        <span class="token string">"syncingTo"</span> <span class="token keyword">:</span> <span class="token string">""</span>,        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">""</span>,        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> -1,        <span class="token string">"heartbeatIntervalMillis"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>2000<span class="token punctuation">)</span>,        <span class="token string">"majorityVoteCount"</span> <span class="token keyword">:</span> 2,        <span class="token string">"writeMajorityCount"</span> <span class="token keyword">:</span> 2,        <span class="token string">"optimes"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                <span class="token string">"lastCommittedOpTime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"lastCommittedWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07.713Z"</span><span class="token punctuation">)</span>,                <span class="token string">"readConcernMajorityOpTime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"readConcernMajorityWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07.713Z"</span><span class="token punctuation">)</span>,                <span class="token string">"appliedOpTime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"durableOpTime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"lastAppliedWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07.713Z"</span><span class="token punctuation">)</span>,                <span class="token string">"lastDurableWallTime"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07.713Z"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>,        <span class="token string">"lastStableRecoveryTimestamp"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469057, 1<span class="token punctuation">)</span>,        <span class="token string">"lastStableCheckpointTimestamp"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469057, 1<span class="token punctuation">)</span>,        <span class="token string">"electionCandidateMetrics"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                <span class="token string">"lastElectionReason"</span> <span class="token keyword">:</span> <span class="token string">"electionTimeout"</span>,                <span class="token string">"lastElectionDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T07:53:17.358Z"</span><span class="token punctuation">)</span>,                <span class="token string">"electionTerm"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>,                <span class="token string">"lastCommittedOpTimeAtElection"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646466756, 1<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>2<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"lastSeenOpTimeAtElection"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646466769, 2<span class="token punctuation">)</span>,                        <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>4<span class="token punctuation">)</span>                <span class="token punctuation">}</span>,                <span class="token string">"numVotesNeeded"</span> <span class="token keyword">:</span> 2,                <span class="token string">"priorityAtElection"</span> <span class="token keyword">:</span> 1,                <span class="token string">"electionTimeoutMillis"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>10000<span class="token punctuation">)</span>,                <span class="token string">"numCatchUpOps"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,                <span class="token string">"newTermStartDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T07:53:17.393Z"</span><span class="token punctuation">)</span>,                <span class="token string">"wMajorityWriteAvailabilityDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T07:53:17.729Z"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>,        <span class="token string">"members"</span> <span class="token keyword">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                        <span class="token string">"_id"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"mongo-0.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"health"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"state"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"stateStr"</span> <span class="token keyword">:</span> <span class="token string">"PRIMARY"</span>,                        <span class="token string">"uptime"</span> <span class="token keyword">:</span> 2287,                        <span class="token string">"optime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>,                        <span class="token string">"optimeDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"syncingTo"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> -1,                        <span class="token string">"infoMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"electionTime"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646466797, 1<span class="token punctuation">)</span>,                        <span class="token string">"electionDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T07:53:17Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"configVersion"</span> <span class="token keyword">:</span> 6,                        <span class="token string">"self"</span> <span class="token keyword">:</span> true,                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>                <span class="token punctuation">}</span>,                <span class="token punctuation">{</span>                        <span class="token string">"_id"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"mongo-2.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"health"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"state"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"stateStr"</span> <span class="token keyword">:</span> <span class="token string">"SECONDARY"</span>,                        <span class="token string">"uptime"</span> <span class="token keyword">:</span> 2284,                        <span class="token string">"optime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>,                        <span class="token string">"optimeDurable"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>,                        <span class="token string">"optimeDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"optimeDurableDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeat"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:09.817Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatRecv"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:09.807Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"pingMs"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncingTo"</span> <span class="token keyword">:</span> <span class="token string">"mongo-0.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">"mongo-0.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"infoMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"configVersion"</span> <span class="token keyword">:</span> 6                <span class="token punctuation">}</span>,                <span class="token punctuation">{</span>                        <span class="token string">"_id"</span> <span class="token keyword">:</span> 3,                        <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"mongo-1.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"health"</span> <span class="token keyword">:</span> 1,                        <span class="token string">"state"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"stateStr"</span> <span class="token keyword">:</span> <span class="token string">"SECONDARY"</span>,                        <span class="token string">"uptime"</span> <span class="token keyword">:</span> 2260,                        <span class="token string">"optime"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>,                        <span class="token string">"optimeDurable"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                                <span class="token string">"ts"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                                <span class="token string">"t"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>5<span class="token punctuation">)</span>                        <span class="token punctuation">}</span>,                        <span class="token string">"optimeDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"optimeDurableDate"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:07Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeat"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:09.222Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatRecv"</span> <span class="token keyword">:</span> ISODate<span class="token punctuation">(</span><span class="token string">"2022-03-05T08:31:09.430Z"</span><span class="token punctuation">)</span>,                        <span class="token string">"pingMs"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span>0<span class="token punctuation">)</span>,                        <span class="token string">"lastHeartbeatMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"syncingTo"</span> <span class="token keyword">:</span> <span class="token string">"mongo-2.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"syncSourceHost"</span> <span class="token keyword">:</span> <span class="token string">"mongo-2.mongo.mongo.svc.cluster.local:27017"</span>,                        <span class="token string">"syncSourceId"</span> <span class="token keyword">:</span> 2,                        <span class="token string">"infoMessage"</span> <span class="token keyword">:</span> <span class="token string">""</span>,                        <span class="token string">"configVersion"</span> <span class="token keyword">:</span> 6                <span class="token punctuation">}</span>        <span class="token punctuation">]</span>,        <span class="token string">"ok"</span> <span class="token keyword">:</span> 1,        <span class="token string">"<span class="token variable">$clusterTime</span>"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                <span class="token string">"clusterTime"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span>,                <span class="token string">"signature"</span> <span class="token keyword">:</span> <span class="token punctuation">{</span>                        <span class="token string">"hash"</span> <span class="token keyword">:</span> BinData<span class="token punctuation">(</span>0,<span class="token string">"LxAPsQBDq0Bx33yC0PzRJWFMbbM="</span><span class="token punctuation">)</span>,                        <span class="token string">"keyId"</span> <span class="token keyword">:</span> NumberLong<span class="token punctuation">(</span><span class="token string">"7071495762592399364"</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span>        <span class="token punctuation">}</span>,        <span class="token string">"operationTime"</span> <span class="token keyword">:</span> Timestamp<span class="token punctuation">(</span>1646469067, 1<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>åˆ›å»ºæ•°æ®åº“æµ‹è¯•</p><pre class=" language-bash"><code class="language-bash">rs0:PRIMARY<span class="token operator">></span> use <span class="token function">test</span>switched to db <span class="token function">test</span>rs0:PRIMARY<span class="token operator">></span> db.users.insertMany<span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">..</span>.      name: <span class="token string">"bob"</span>, age: 42, status: <span class="token string">"A"</span>, <span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token punctuation">..</span>.      name: <span class="token string">"ahn"</span>, age: 22, status: <span class="token string">"A"</span>, <span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token punctuation">..</span>.      name: <span class="token string">"xi"</span>, age: 34, status: <span class="token string">"D"</span>, <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token string">"acknowledged"</span> <span class="token keyword">:</span> true,        <span class="token string">"insertedIds"</span> <span class="token keyword">:</span> <span class="token punctuation">[</span>                ObjectId<span class="token punctuation">(</span><span class="token string">"62232018adef03bcf644f4d6"</span><span class="token punctuation">)</span>,                ObjectId<span class="token punctuation">(</span><span class="token string">"62232018adef03bcf644f4d7"</span><span class="token punctuation">)</span>,                ObjectId<span class="token punctuation">(</span><span class="token string">"62232018adef03bcf644f4d8"</span><span class="token punctuation">)</span>        <span class="token punctuation">]</span><span class="token punctuation">}</span>rs0:PRIMARY<span class="token operator">></span> show collections<span class="token function">users</span>rs0:PRIMARY<span class="token operator">></span> db.user.find<span class="token punctuation">(</span><span class="token punctuation">)</span>rs0:PRIMARY<span class="token operator">></span> db.users.find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token keyword">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"62232018adef03bcf644f4d6"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"bob"</span>, <span class="token string">"age"</span> <span class="token keyword">:</span> 42, <span class="token string">"status"</span> <span class="token keyword">:</span> <span class="token string">"A"</span> <span class="token punctuation">}</span><span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token keyword">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"62232018adef03bcf644f4d7"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"ahn"</span>, <span class="token string">"age"</span> <span class="token keyword">:</span> 22, <span class="token string">"status"</span> <span class="token keyword">:</span> <span class="token string">"A"</span> <span class="token punctuation">}</span><span class="token punctuation">{</span> <span class="token string">"_id"</span> <span class="token keyword">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">"62232018adef03bcf644f4d8"</span><span class="token punctuation">)</span>, <span class="token string">"name"</span> <span class="token keyword">:</span> <span class="token string">"xi"</span>, <span class="token string">"age"</span> <span class="token keyword">:</span> 34, <span class="token string">"status"</span> <span class="token keyword">:</span> <span class="token string">"D"</span> <span class="token punctuation">}</span></code></pre><p>ä¸ºæ•°æ®åº“åˆ›å»ºç”¨æˆ·</p><pre class=" language-yaml"><code class="language-yaml">rs0<span class="token punctuation">:</span>PRIMARY<span class="token punctuation">></span> use testswitched to db testrs0<span class="token punctuation">:</span>PRIMARY<span class="token punctuation">></span> db.createUser(<span class="token punctuation">{</span><span class="token key atrule">user</span><span class="token punctuation">:</span> <span class="token string">"jim"</span><span class="token punctuation">,</span> <span class="token key atrule">pwd</span><span class="token punctuation">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span> <span class="token key atrule">roles</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> <span class="token string">"dbOwner"</span><span class="token punctuation">,</span> <span class="token key atrule">db</span><span class="token punctuation">:</span> <span class="token string">"test"</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>)Successfully added user<span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token key atrule">"user"</span> <span class="token punctuation">:</span> <span class="token string">"jim"</span><span class="token punctuation">,</span>        <span class="token key atrule">"roles"</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                        <span class="token key atrule">"role"</span> <span class="token punctuation">:</span> <span class="token string">"dbOwner"</span><span class="token punctuation">,</span>                        <span class="token key atrule">"db"</span> <span class="token punctuation">:</span> <span class="token string">"test"</span>                <span class="token punctuation">}</span>        <span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mongo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Databases </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nexusæœ¬åœ°mavanä»“åº“æ­å»º</title>
      <link href="/f797207e/"/>
      <url>/f797207e/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ç®€ä»‹"><a href="#ä¸€-ç®€ä»‹" class="headerlink" title="ä¸€ ç®€ä»‹"></a>ä¸€ ç®€ä»‹</h1><p><a href="https://link.zhihu.com/?target=http://nexus.sonatype.org/">Nexus</a> æ˜¯Mavenä»“åº“ç®¡ç†å™¨ï¼Œå¦‚æœä½ ä½¿ç”¨Mavenï¼Œä½ å¯ä»¥ä»<a href="https://link.zhihu.com/?target=http://repo1.maven.org/maven2/">Mavenä¸­å¤®ä»“åº“</a> ä¸‹è½½æ‰€éœ€è¦çš„æ„ä»¶ï¼ˆartifactï¼‰ï¼Œä½†è¿™é€šå¸¸ä¸æ˜¯ä¸€ä¸ªå¥½çš„åšæ³•ï¼Œä½ åº”è¯¥åœ¨æœ¬åœ°æ¶è®¾ä¸€ä¸ªMavenä»“åº“æœåŠ¡å™¨ï¼Œåœ¨ä»£ç†è¿œç¨‹ä»“åº“çš„åŒæ—¶ç»´æŠ¤æœ¬åœ°ä»“åº“ï¼Œä»¥èŠ‚çœå¸¦å®½å’Œæ—¶é—´ï¼ŒNexuså°±å¯ä»¥æ»¡è¶³è¿™æ ·çš„éœ€è¦ã€‚æ­¤å¤–ï¼Œä»–è¿˜æä¾›äº†å¼ºå¤§çš„ä»“åº“ç®¡ç†åŠŸèƒ½ï¼Œæ„ä»¶æœç´¢åŠŸèƒ½ï¼Œå®ƒåŸºäºRESTï¼Œå‹å¥½çš„UIæ˜¯ä¸€ä¸ªextjsçš„RESTå®¢æˆ·ç«¯ï¼Œå®ƒå ç”¨è¾ƒå°‘çš„å†…å­˜ï¼ŒåŸºäºç®€å•æ–‡ä»¶ç³»ç»Ÿè€Œéæ•°æ®åº“ã€‚è¿™äº›ä¼˜ç‚¹ä½¿å…¶æ—¥è¶‹æˆä¸ºæœ€æµè¡Œçš„Mavenä»“åº“ç®¡ç†å™¨</p><hr><h1 id="äºŒ-å®‰è£…é…ç½®"><a href="#äºŒ-å®‰è£…é…ç½®" class="headerlink" title="äºŒ å®‰è£…é…ç½®"></a>äºŒ å®‰è£…é…ç½®</h1><h3 id="2-1-ç¯å¢ƒå‡†å¤‡"><a href="#2-1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.1 ç¯å¢ƒå‡†å¤‡"></a>2.1 ç¯å¢ƒå‡†å¤‡</h3><p>éœ€è¦æœ‰é»˜è®¤å­˜å‚¨ æˆ‘è¿™è¾¹ä½¿ç”¨çš„æ˜¯sc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin    <span class="token key atrule">pv.kubernetes.io/bind-completed</span><span class="token punctuation">:</span> <span class="token string">'yes'</span>    <span class="token key atrule">pv.kubernetes.io/bound-by-controller</span><span class="token punctuation">:</span> <span class="token string">'yes'</span>    <span class="token key atrule">volume.beta.kubernetes.io/storage-provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>k8s  <span class="token key atrule">finalizers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> kubernetes.io/pvc<span class="token punctuation">-</span>protection<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">volumeName</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>8ac315a8<span class="token punctuation">-</span>fdac<span class="token punctuation">-</span>460d<span class="token punctuation">-</span>9c95<span class="token punctuation">-</span>41d0a7bc7e7e  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>k8s  <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem</code></pre><h3 id="2-2-é…ç½®deploy"><a href="#2-2-é…ç½®deploy" class="headerlink" title="2.2 é…ç½®deploy"></a>2.2 é…ç½®deploy</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">deployment.kubernetes.io/revision</span><span class="token punctuation">:</span> <span class="token string">'5'</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nexus      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> nexus      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus<span class="token punctuation">-</span>data          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> nexus<span class="token punctuation">-</span>data<span class="token punctuation">-</span>pvc      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> adddirperm          <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/busybox          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /bin/sh            <span class="token punctuation">-</span> <span class="token string">'-c'</span>            <span class="token punctuation">-</span> <span class="token string">'chown -R ${USER_ID}:${USER_ID} ${DATA_DIR}'</span>          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATA_DIR              <span class="token key atrule">value</span><span class="token punctuation">:</span> /nexus<span class="token punctuation">-</span>data            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> USER_ID              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'200'</span>          <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus<span class="token punctuation">-</span>data              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /nexus<span class="token punctuation">-</span>data          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus          <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/nexus3<span class="token punctuation">:</span>3.20.1          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8081</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">resources</span><span class="token punctuation">:</span>            <span class="token key atrule">requests</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 500m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus<span class="token punctuation">-</span>data              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /nexus<span class="token punctuation">-</span>data          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span></code></pre><h3 id="2-3-é…ç½®svc"><a href="#2-3-é…ç½®svc" class="headerlink" title="2.3 é…ç½®svc"></a>2.3 é…ç½®svc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nexus<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>neuxs      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8081</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> nexus  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster</code></pre><hr><h1 id="ä¸‰-è®¿é—®æµ‹è¯•"><a href="#ä¸‰-è®¿é—®æµ‹è¯•" class="headerlink" title="ä¸‰ è®¿é—®æµ‹è¯•"></a>ä¸‰ è®¿é—®æµ‹è¯•</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/1062911246.png"></p>]]></content>
      
      
      <categories>
          
          <category> å¼€æºé¡¹ç›® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sæ­å»ºYApiç®¡ç†å¹³å°</title>
      <link href="/3dba2979/"/>
      <url>/3dba2979/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ç®€ä»‹"><a href="#ä¸€-ç®€ä»‹" class="headerlink" title="ä¸€ ç®€ä»‹"></a>ä¸€ ç®€ä»‹</h1><p>æ—¨åœ¨ä¸ºå¼€å‘ã€äº§å“ã€æµ‹è¯•äººå‘˜æä¾›æ›´ä¼˜é›…çš„æ¥å£ç®¡ç†æœåŠ¡ã€‚å¯ä»¥å¸®åŠ©å¼€å‘è€…è½»æ¾åˆ›å»ºã€å‘å¸ƒã€ç»´æŠ¤ API</p><h3 id="1-1-å¹³å°ä»‹ç»"><a href="#1-1-å¹³å°ä»‹ç»" class="headerlink" title="1.1 å¹³å°ä»‹ç»"></a>1.1 å¹³å°ä»‹ç»</h3><p>YApi æ˜¯<strong>é«˜æ•ˆ</strong> ã€<strong>æ˜“ç”¨</strong> ã€<strong>åŠŸèƒ½å¼ºå¤§</strong> çš„ api ç®¡ç†å¹³å°ï¼Œæ—¨åœ¨ä¸ºå¼€å‘ã€äº§å“ã€æµ‹è¯•äººå‘˜æä¾›æ›´ä¼˜é›…çš„æ¥å£ç®¡ç†æœåŠ¡ã€‚å¯ä»¥å¸®åŠ©å¼€å‘è€…è½»æ¾åˆ›å»ºã€å‘å¸ƒã€ç»´æŠ¤ APIï¼ŒYApi è¿˜ä¸ºç”¨æˆ·æä¾›äº†ä¼˜ç§€çš„äº¤äº’ä½“éªŒï¼Œå¼€å‘äººå‘˜åªéœ€åˆ©ç”¨å¹³å°æä¾›çš„æ¥å£æ•°æ®å†™å…¥å·¥å…·ä»¥åŠç®€å•çš„ç‚¹å‡»æ“ä½œå°±å¯ä»¥å®ç°æ¥å£çš„ç®¡ç†ã€‚</p><h3 id="1-2-å¹³å°ç‰¹æ€§"><a href="#1-2-å¹³å°ç‰¹æ€§" class="headerlink" title="1.2 å¹³å°ç‰¹æ€§"></a>1.2 å¹³å°ç‰¹æ€§</h3><ul><li>åŸºäº Json5 å’Œ Mockjs å®šä¹‰æ¥å£è¿”å›æ•°æ®çš„ç»“æ„å’Œæ–‡æ¡£ï¼Œæ•ˆç‡æå‡å¤šå€</li><li>æ‰å¹³åŒ–æƒé™è®¾è®¡ï¼Œå³ä¿è¯äº†å¤§å‹ä¼ä¸šçº§é¡¹ç›®çš„ç®¡ç†ï¼Œåˆä¿è¯äº†æ˜“ç”¨æ€§</li><li>ç±»ä¼¼ postman çš„æ¥å£è°ƒè¯•</li><li>è‡ªåŠ¨åŒ–æµ‹è¯•, æ”¯æŒå¯¹ Response æ–­è¨€</li><li>MockServer é™¤æ”¯æŒæ™®é€šçš„éšæœº mock å¤–ï¼Œè¿˜å¢åŠ äº† Mock æœŸæœ›åŠŸèƒ½ï¼Œæ ¹æ®è®¾ç½®çš„è¯·æ±‚è¿‡æ»¤è§„åˆ™ï¼Œè¿”å›æœŸæœ›æ•°æ®</li><li>æ”¯æŒ postman, har, swagger æ•°æ®å¯¼å…¥</li><li>å…è´¹å¼€æºï¼Œå†…ç½‘éƒ¨ç½²ï¼Œä¿¡æ¯å†ä¹Ÿä¸æ€•æ³„éœ²äº†</li></ul><h1 id="äºŒ-éƒ¨ç½²"><a href="#äºŒ-éƒ¨ç½²" class="headerlink" title="äºŒ éƒ¨ç½²"></a>äºŒ éƒ¨ç½²</h1><h3 id="2-1-ç¯å¢ƒå‡†å¤‡"><a href="#2-1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.1 ç¯å¢ƒå‡†å¤‡"></a>2.1 ç¯å¢ƒå‡†å¤‡</h3><p>YApiæœåŠ¡ä¾èµ–äºmongodb ä½œä¸ºåº•å±‚å­˜å‚¨,æ‰€ä»¥æ­å»ºæœåŠ¡ä¹‹å‰éœ€è¦é…ç½®mongoç¯å¢ƒ,è¿™é‡Œå¯ä»¥å‚è€ƒå‰é¢çš„æ–‡ç« <br><a href="https://www.huhuhahei.cn/index.php/archives/491/">Mongoé›†ç¾¤æ­å»º</a></p><h3 id="2-2-é…ç½®æœåŠ¡"><a href="#2-2-é…ç½®æœåŠ¡" class="headerlink" title="2.2 é…ç½®æœåŠ¡"></a>2.2 é…ç½®æœåŠ¡</h3><h4 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a>deploy</h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">deployment.kubernetes.io/revision</span><span class="token punctuation">:</span> <span class="token string">'7'</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> yapi      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">kubesphere.io/restartedAt</span><span class="token punctuation">:</span> <span class="token string">'2022-03-07T07:07:24.975Z'</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi<span class="token punctuation">-</span>config          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi<span class="token punctuation">-</span>config            <span class="token key atrule">items</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> config.json                <span class="token key atrule">path</span><span class="token punctuation">:</span> config.json            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'harbor.huhuhahei.cn/huhuhahei/yapi:1.9.1'</span>          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi<span class="token punctuation">-</span>config              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt/yapi/config.json              <span class="token key atrule">subPath</span><span class="token punctuation">:</span> config.json          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span></code></pre><h4 id="svc"><a href="#svc" class="headerlink" title="svc"></a>svc</h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3000</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31257</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.98.149.20  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster</code></pre><h4 id="configmap"><a href="#configmap" class="headerlink" title="configmap"></a>configmap</h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> yapi<span class="token punctuation">-</span>config  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> yapi  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubesphere.io/creator</span><span class="token punctuation">:</span> admin<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">config.json</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>    <span class="token punctuation">{</span>       <span class="token key atrule">"port"</span><span class="token punctuation">:</span> <span class="token string">"3000"</span><span class="token punctuation">,</span>       <span class="token key atrule">"adminAccount"</span><span class="token punctuation">:</span> <span class="token string">"admin@admin.com"</span><span class="token punctuation">,</span>       <span class="token key atrule">"db"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>          <span class="token key atrule">"connectString"</span><span class="token punctuation">:</span> <span class="token string">"mongodb://mongo-0.mongo.mongo:27017,mongo-1.mongo.mongo:27017,mongo-2.mongo.mongo:27017/yapi?replicaSet=rs0"</span><span class="token punctuation">,</span>          <span class="token key atrule">"user"</span><span class="token punctuation">:</span> <span class="token string">"yapi"</span><span class="token punctuation">,</span>          <span class="token key atrule">"pass"</span><span class="token punctuation">:</span> <span class="token string">"yapi"</span>       <span class="token punctuation">}</span>    <span class="token punctuation">}</span></code></pre><h3 id="2-3-äº¤ä»˜k8s"><a href="#2-3-äº¤ä»˜k8s" class="headerlink" title="2.3 äº¤ä»˜k8s"></a>2.3 äº¤ä»˜k8s</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f .</code></pre><h3 id="åˆå§‹åŒ–æ•°æ®åº“"><a href="#åˆå§‹åŒ–æ•°æ®åº“" class="headerlink" title="åˆå§‹åŒ–æ•°æ®åº“"></a>åˆå§‹åŒ–æ•°æ®åº“</h3><p>è¿™é‡Œéœ€è¦è¿›å…¥å®¹å™¨è¿›è¡Œåˆå§‹åŒ–ç”¨æˆ·å¦åˆ™adminç”¨æˆ·æ— æ³•ç™»å½•</p><pre class=" language-yaml"><code class="language-yaml">rm <span class="token punctuation">-</span>f /opt/yapi/init.locknode /opt/yapi/vendors/server/install.js<span class="token comment" spellcheck="true"># åˆå§‹åŒ–åadmin ç”¨æˆ·:admin@admin.com å¯†ç :ymfe.org</span></code></pre><h1 id="ä¸‰-ç™»å½•"><a href="#ä¸‰-ç™»å½•" class="headerlink" title="ä¸‰ ç™»å½•"></a>ä¸‰ ç™»å½•</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/155352285.png"></p>]]></content>
      
      
      <categories>
          
          <category> å¼€æºé¡¹ç›® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sæ­å»ºrook-operator cephç®¡ç†å¹³å°</title>
      <link href="/75ed946c/"/>
      <url>/75ed946c/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h1><p>Rook æ˜¯ä¸€ä¸ªå¼€æºçš„<strong>äº‘åŸç”Ÿå­˜å‚¨ç¼–æ’å™¨</strong> ï¼Œä¸ºå„ç§å­˜å‚¨è§£å†³æ–¹æ¡ˆæä¾›å¹³å°ã€æ¡†æ¶å’Œæ”¯æŒï¼Œä»¥ä¸äº‘åŸç”Ÿç¯å¢ƒè¿›è¡ŒåŸç”Ÿé›†æˆã€‚</p><p>Rook å°†å­˜å‚¨è½¯ä»¶è½¬å˜ä¸ºè‡ªæˆ‘ç®¡ç†ã€è‡ªæˆ‘æ‰©å±•å’Œè‡ªæˆ‘ä¿®å¤çš„å­˜å‚¨æœåŠ¡ã€‚å®ƒé€šè¿‡è‡ªåŠ¨åŒ–éƒ¨ç½²ã€å¼•å¯¼ã€é…ç½®ã€ä¾›åº”ã€æ‰©å±•ã€å‡çº§ã€è¿ç§»ã€ç¾éš¾æ¢å¤ã€ç›‘æ§å’Œèµ„æºç®¡ç†æ¥å®ç°è¿™ä¸€ç‚¹ã€‚Rook ä½¿ç”¨åº•å±‚äº‘åŸç”Ÿå®¹å™¨ç®¡ç†ã€è°ƒåº¦å’Œç¼–æ’å¹³å°æä¾›çš„è®¾æ–½æ¥å±¥è¡Œå…¶èŒè´£ã€‚</p><p>Rook åˆ©ç”¨æ‰©å±•ç‚¹æ·±åº¦é›†æˆåˆ°äº‘åŸç”Ÿç¯å¢ƒä¸­ï¼Œå¹¶ä¸ºè°ƒåº¦ã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€èµ„æºç®¡ç†ã€å®‰å…¨æ€§ã€ç›‘æ§å’Œç”¨æˆ·ä½“éªŒæä¾›æ— ç¼ä½“éªŒã€‚</p><h1 id="äºŒ-æ­å»º"><a href="#äºŒ-æ­å»º" class="headerlink" title="äºŒ æ­å»º"></a>äºŒ æ­å»º</h1><h3 id="2-1-ç¯å¢ƒå‡†å¤‡"><a href="#2-1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="2.1 ç¯å¢ƒå‡†å¤‡"></a>2.1 ç¯å¢ƒå‡†å¤‡</h3><p>éœ€è¦ç¡®ä¿èŠ‚ç‚¹ä¸­æœ‰æœªåˆå§‹åŒ–çš„ç£ç›˜</p><p>ä»£ç ä¸‹è½½</p><p><code>git clone --single-branch --branch master https://github.com/rook/rook.git</code></p><h3 id="2-2-åˆ›å»ºrook-operater"><a href="#2-2-åˆ›å»ºrook-operater" class="headerlink" title="2.2 åˆ›å»ºrook-operater"></a>2.2 åˆ›å»ºrook-operater</h3><pre class=" language-yaml"><code class="language-yaml">kubectl create <span class="token punctuation">-</span>f crds.yaml <span class="token punctuation">-</span>f common.yaml <span class="token punctuation">-</span>f operator.yaml</code></pre><p>ç¡®è®¤operatorå¯åŠ¨æˆåŠŸæ—¢å¯ç»§ç»­éƒ¨ç½²</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master rbd<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n rook-ceph | grep oper</span>rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>757546f8c7<span class="token punctuation">-</span>l9bmc             1/1     Running     0          158m</code></pre><h3 id="2-3-åˆ›å»ºceph-cluster"><a href="#2-3-åˆ›å»ºceph-cluster" class="headerlink" title="2.3 åˆ›å»ºceph-cluster"></a>2.3 åˆ›å»ºceph-cluster</h3><p>é…ç½®å¯ä»¥å‚è€ƒclusterçš„yamlæ–‡ä»¶è‡ªå®šä¹‰ä¿®æ”¹</p><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f cluster<span class="token punctuation">-</span>test.yaml</code></pre><p>å¾…ä¸‹é¢æœåŠ¡å…¨éƒ¨å¯åŠ¨å®Œæˆ å¤§éƒ¨åˆ†é…ç½®å°±å®Œæˆäº†::(æ»‘ç¨½)</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master rbd<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n rook-ceph </span>NAME                                            READY   STATUS      RESTARTS   AGEcsi<span class="token punctuation">-</span>cephfsplugin<span class="token punctuation">-</span>4psdt                          3/3     Running     0          124mcsi<span class="token punctuation">-</span>cephfsplugin<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>5dc75bb888<span class="token punctuation">-</span>5rt4z   6/6     Running     0          131mcsi<span class="token punctuation">-</span>cephfsplugin<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>5dc75bb888<span class="token punctuation">-</span>k4jf7   6/6     Running     0          131mcsi<span class="token punctuation">-</span>cephfsplugin<span class="token punctuation">-</span>zqc8r                          3/3     Running     0          124mcsi<span class="token punctuation">-</span>rbdplugin<span class="token punctuation">-</span>7vtwg                             3/3     Running     0          126mcsi<span class="token punctuation">-</span>rbdplugin<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>65cb5fd9c6<span class="token punctuation">-</span>m2l2x      6/6     Running     0          127mcsi<span class="token punctuation">-</span>rbdplugin<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>65cb5fd9c6<span class="token punctuation">-</span>wh8bx      6/6     Running     0          127mcsi<span class="token punctuation">-</span>rbdplugin<span class="token punctuation">-</span>qr9sw                             3/3     Running     0          126mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>mgr<span class="token punctuation">-</span>a<span class="token punctuation">-</span>6c7886c46d<span class="token punctuation">-</span>d57ps                1/1     Running     0          150mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>mon<span class="token punctuation">-</span>a<span class="token punctuation">-</span>5576f996f8<span class="token punctuation">-</span>2vhq8                1/1     Running     0          154mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>mon<span class="token punctuation">-</span>b<span class="token punctuation">-</span>556b78cd67<span class="token punctuation">-</span>tlblh                1/1     Running     0          152mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>757546f8c7<span class="token punctuation">-</span>l9bmc             1/1     Running     0          160mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>osd<span class="token punctuation">-</span>0<span class="token punctuation">-</span>8495c46d54<span class="token punctuation">-</span>96rd2                1/1     Running     0          148mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>osd<span class="token punctuation">-</span>1<span class="token punctuation">-</span>5d55f9f5cf<span class="token punctuation">-</span>z9cxk                1/1     Running     0          148mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>osd<span class="token punctuation">-</span>prepare<span class="token punctuation">-</span>master<span class="token punctuation">-</span>pfpgk              0/1     Completed   0          149mrook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>osd<span class="token punctuation">-</span>prepare<span class="token punctuation">-</span>node01<span class="token punctuation">-</span>shktt              0/1     Completed   0          149m</code></pre><p>è¿™æ˜¯å¯ä»¥ç™»å½•èŠ‚ç‚¹æŸ¥çœ‹ç£ç›˜æ˜¯å¦å·²ç»æ ¼å¼åŒ–ä¸ºcephçš„æ ¼å¼</p><pre class=" language-bash"><code class="language-bash">NAME   MAJ:MIN RM SIZE RO TYPE MOUNTPOINTvda    253:0    0  60G  0 disk â””â”€vda1 253:1    0  60G  0 part /vdb    253:16   0  50G  0 disk /datavdc    253:32   0  50G  0 disk â””â”€ceph--b422438d--be03--4318--bd73--a2d54607831d-osd--block--8b14a4eb--0d37--40c3--a78a--6deadd4ded77       252:0    0  50G  0 lvm</code></pre><h3 id="2-4-éƒ¨ç½²cephå·¥å…·"><a href="#2-4-éƒ¨ç½²cephå·¥å…·" class="headerlink" title="2.4 éƒ¨ç½²cephå·¥å…·"></a>2.4 éƒ¨ç½²cephå·¥å…·</h3><pre class=" language-yaml"><code class="language-yaml">kubectl create <span class="token punctuation">-</span>f toolbox.yaml</code></pre><p>å¯åŠ¨æˆåŠŸå°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªå·¥å…·æ‰§è¡Œcephçš„å‘½ä»¤</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master rbd<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n rook-ceph exec -it deploy/rook-ceph-tools -- ceph -s</span>  cluster:    id:     7a065ad6-efcf-4b94-9df8-ac6e30375a83    health: HEALTH_OK   services:    mon: 2 daemons, quorum a,b <span class="token punctuation">(</span>age 2h<span class="token punctuation">)</span>    mgr: a<span class="token punctuation">(</span>active, since 2h<span class="token punctuation">)</span>    osd: 2 osds: 2 up <span class="token punctuation">(</span>since 2h<span class="token punctuation">)</span>, 2 <span class="token keyword">in</span> <span class="token punctuation">(</span>since 2h<span class="token punctuation">)</span>   data:    pools:   2 pools, 64 pgs    objects: 17 objects, 21 MiB    usage:   32 MiB used, 100 GiB / 100 GiB avail    pgs:     64 active+clean</code></pre><h3 id="2-5-éƒ¨ç½²ceph-dashboard"><a href="#2-5-éƒ¨ç½²ceph-dashboard" class="headerlink" title="2.5 éƒ¨ç½²ceph dashboard"></a>2.5 éƒ¨ç½²ceph dashboard</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f  dashboard<span class="token punctuation">-</span>external<span class="token punctuation">-</span>http.yaml</code></pre><p>éƒ¨ç½²å®ŒæˆæŸ¥çœ‹svcç«¯å£æ—¢å¯webè®¿é—®</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æŸ¥çœ‹å¯†ç </span>kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath<span class="token operator">=</span><span class="token string">"{['data']['password']}"</span> <span class="token operator">|</span> base64 --decode <span class="token operator">&amp;&amp;</span> <span class="token keyword">echo</span><span class="token comment" spellcheck="true">#å¯†ç ï¼š NHaYC4%)5F.Js*%7tO$y</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/2106452900.png"></p><h1 id="ä¸‰-é…ç½®RDB-Storageclasså­˜å‚¨"><a href="#ä¸‰-é…ç½®RDB-Storageclasså­˜å‚¨" class="headerlink" title="ä¸‰ é…ç½®RDB Storageclasså­˜å‚¨"></a>ä¸‰ é…ç½®RDB Storageclasså­˜å‚¨</h1><h3 id="3-1-åˆ›å»ºStorageclass"><a href="#3-1-åˆ›å»ºStorageclass" class="headerlink" title="3.1 åˆ›å»ºStorageclass"></a>3.1 åˆ›å»ºStorageclass</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f storageclass<span class="token punctuation">-</span>test.yaml</code></pre><p>æŸ¥çœ‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master rbd<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get sc</span>rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block (default)   rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com   Delete          Immediate           true                   32m</code></pre><h3 id="3-2-ä½¿ç”¨podæŒ‚è½½æµ‹è¯•"><a href="#3-2-ä½¿ç”¨podæŒ‚è½½æµ‹è¯•" class="headerlink" title="3.2 ä½¿ç”¨podæŒ‚è½½æµ‹è¯•"></a>3.2 ä½¿ç”¨podæŒ‚è½½æµ‹è¯•</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>ceph<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>pvc<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> rbd<span class="token punctuation">-</span>pvc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block</code></pre><p>ç™»å½•podæŸ¥çœ‹æ˜¯å¦æ­£å¸¸æŒ‚è½½</p><pre class=" language-yaml"><code class="language-yaml">/ <span class="token comment" spellcheck="true"># df -h</span>Filesystem                Size      Used Available Use% Mounted onoverlay                  60.0G     39.2G     20.8G  65% /tmpfs                    64.0M         0     64.0M   0% /devtmpfs                     3.8G         0      3.8G   0% /sys/fs/cgroup/dev/vda1                60.0G     39.2G     20.8G  65% /dev/termination<span class="token punctuation">-</span>log/dev/vda1                60.0G     39.2G     20.8G  65% /etc/resolv.conf/dev/vda1                60.0G     39.2G     20.8G  65% /etc/hostname/dev/vda1                60.0G     39.2G     20.8G  65% /etc/hostsshm                      64.0M         0     64.0M   0% /dev/shm/dev/rbd0               975.9M      2.5M    957.4M   0% /usr/share/nginx/html</code></pre><p>ç›®å½•æ­£å¸¸æŒ‚è½½</p><h1 id="å››-é…ç½®Cephfs-Storageclasså­˜å‚¨"><a href="#å››-é…ç½®Cephfs-Storageclasså­˜å‚¨" class="headerlink" title="å›› é…ç½®Cephfs Storageclasså­˜å‚¨"></a>å›› é…ç½®Cephfs Storageclasså­˜å‚¨</h1><h3 id="4-1-é…ç½®mdsæœåŠ¡"><a href="#4-1-é…ç½®mdsæœåŠ¡" class="headerlink" title="4.1 é…ç½®mdsæœåŠ¡"></a>4.1 é…ç½®mdsæœåŠ¡</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f filesystem.yaml</code></pre><p>ç¡®è®¤æœåŠ¡å¯åŠ¨</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master examples<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n rook-ceph | grep mds</span>rook-ceph-mds-myfs-a-6b85579bfb-zm999           1/1     Running     0          22mrook-ceph-mds-myfs-b-b98899f44-q88ps            1/1     Running     0          22m</code></pre><h3 id="4-2-åˆ›å»ºStorageclass"><a href="#4-2-åˆ›å»ºStorageclass" class="headerlink" title="4.2 åˆ›å»ºStorageclass"></a>4.2 åˆ›å»ºStorageclass</h3><pre class=" language-yaml"><code class="language-yaml">kubectl apply <span class="token punctuation">-</span>f storageclass.yaml</code></pre><p>æŸ¥çœ‹ç¡®è®¤</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get sc</span>rook-ceph-block   rook-ceph.rbd.csi.ceph.com      Delete          Immediate           <span class="token boolean">true</span>                   88mrook-cephfs       rook-ceph.cephfs.csi.ceph.com   Delete          Immediate           <span class="token boolean">true</span>                   48m</code></pre><h3 id="4-3-æµ‹è¯•æ–‡ä»¶å…±äº«"><a href="#4-3-æµ‹è¯•æ–‡ä»¶å…±äº«" class="headerlink" title="4.3 æµ‹è¯•æ–‡ä»¶å…±äº«"></a>4.3 æµ‹è¯•æ–‡ä»¶å…±äº«</h3><p>åˆ›å»ºä¸¤ä¸ªpod</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span><span class="token number">2</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>demo<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span><span class="token number">1</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>demo<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> cephfs<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>demo<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>cephfs</code></pre><p>ä¸€ä¸ªå®¹å™¨åˆ›å»ºæ–‡ä»¶ ç™»å½•å…¶ä»–å®¹å™¨ç¡®è®¤æ˜¯å¦å¯ä»¥çœ‹åˆ°</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it pod-vol-ceph-1 /bin/sh</span>kubectl exec <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed in a future version. Use kubectl exec <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead./ <span class="token comment" spellcheck="true"># touch /usr/share/nginx/html/test</span></code></pre><p>ç™»å½•å¦ä¸€ä¸ªå®¹å™¨æµ‹è¯•</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master cephfs<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it pod-vol-ceph-2 /bin/sh</span>kubectl exec <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> is DEPRECATED and will be removed in a future version. Use kubectl exec <span class="token punctuation">[</span>POD<span class="token punctuation">]</span> <span class="token punctuation">-</span><span class="token punctuation">-</span> <span class="token punctuation">[</span>COMMAND<span class="token punctuation">]</span> instead./ <span class="token comment" spellcheck="true"># ls /usr/share/nginx/html/</span>index.html  test</code></pre>]]></content>
      
      
      <categories>
          
          <category> å¼€æºé¡¹ç›® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8séƒ¨ç½²postgresql</title>
      <link href="/3bb5eb95/"/>
      <url>/3bb5eb95/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€ å‰è¨€"></a>ä¸€ å‰è¨€</h1><p>æˆ‘è¿™é‡Œæ˜¯ä½¿ç”¨deployment éƒ¨ç½²çš„ä¸€èˆ¬ç”¨äºæµ‹è¯•å’Œå¼€å‘ç¯å¢ƒæœåŠ¡éœ€æ±‚,ç”Ÿäº§ç¯å¢ƒå»ºè®®è¿˜æ˜¯ä½¿ç”¨å…¬æœ‰äº‘</p><h1 id="äºŒ-éƒ¨ç½²"><a href="#äºŒ-éƒ¨ç½²" class="headerlink" title="äºŒ éƒ¨ç½²"></a>äºŒ éƒ¨ç½²</h1><h3 id="2-1-é…ç½®æŒä¹…å·"><a href="#2-1-é…ç½®æŒä¹…å·" class="headerlink" title="2.1 é…ç½®æŒä¹…å·"></a>2.1 é…ç½®æŒä¹…å·</h3><p>æˆ‘è¿™é‡Œscä½¿ç”¨çš„rbdçš„storageclass</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>postgresql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteOnce  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>cephfs</code></pre><h3 id="2-2-é…ç½®deploy"><a href="#2-2-é…ç½®deploy" class="headerlink" title="2.2 é…ç½®deploy"></a>2.2 é…ç½®deploy</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab      <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab        <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span>12.6<span class="token punctuation">-</span>alpine          <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_USER              <span class="token key atrule">value</span><span class="token punctuation">:</span> gitlab            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_DB              <span class="token key atrule">value</span><span class="token punctuation">:</span> gitlabhq_production            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POSTGRES_PASSWORD              <span class="token key atrule">value</span><span class="token punctuation">:</span> bogeusepg            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">5432</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> exec pg_isready <span class="token punctuation">-</span>U gitlab <span class="token punctuation">-</span>h 127.0.0.1 <span class="token punctuation">-</span>p 5432 <span class="token punctuation">-</span>d gitlabhq_production            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">110</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">exec</span><span class="token punctuation">:</span>              <span class="token key atrule">command</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> sh              <span class="token punctuation">-</span> <span class="token punctuation">-</span>c              <span class="token punctuation">-</span> exec pg_isready <span class="token punctuation">-</span>U gitlab <span class="token punctuation">-</span>h 127.0.0.1 <span class="token punctuation">-</span>p 5432 <span class="token punctuation">-</span>d gitlabhq_production            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">20</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">resources</span><span class="token punctuation">:</span>            <span class="token key atrule">requests</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi            <span class="token key atrule">limits</span><span class="token punctuation">:</span>              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>              <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/postgresql/data      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>postgresql</code></pre><h3 id="2-3-åˆ›å»ºsvc"><a href="#2-3-åˆ›å»ºsvc" class="headerlink" title="2.3 åˆ›å»ºsvc"></a>2.3 åˆ›å»ºsvc</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> postgresql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5432</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> gitlab    <span class="token key atrule">tier</span><span class="token punctuation">:</span> postgreSQL</code></pre>]]></content>
      
      
      <categories>
          
          <category> Pgsql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Databases </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8séƒ¨ç½² Skywalkingç›‘æ§åº”ç”¨æ€§èƒ½</title>
      <link href="/8d9023df/"/>
      <url>/8d9023df/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-ç®€ä»‹"><a href="#ä¸€-ç®€ä»‹" class="headerlink" title="ä¸€ ç®€ä»‹"></a>ä¸€ ç®€ä»‹</h1><p><strong>SkyWalking</strong> æ˜¯ä¸€ä¸ª<strong>APM</strong> ï¼ˆåº”ç”¨ç¨‹åºæ€§èƒ½ç›‘è§†å™¨ï¼‰ç³»ç»Ÿï¼Œä¸“é—¨ä¸º<strong>å¾®æœåŠ¡ï¼Œäº‘åŸç”Ÿå’ŒåŸºäºå®¹å™¨</strong> ï¼ˆDockerï¼ŒKubernetesï¼ŒMesosï¼‰çš„ä½“ç³»ç»“æ„è€Œè®¾è®¡ã€‚<br><strong>SkyWalking</strong> çš„åŠŸèƒ½åŒ…æ‹¬å¯¹<strong>Cloud Native</strong> ä½“ç³»ç»“æ„ä¸­çš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç›‘è§†ï¼Œè·Ÿè¸ªï¼Œè¯Šæ–­åŠŸèƒ½ã€‚æ ¸å¿ƒåŠŸèƒ½å¦‚ä¸‹:</p><ul><li>æœåŠ¡ã€æœåŠ¡å®ä¾‹ã€ç«¯ç‚¹æŒ‡æ ‡åˆ†æ</li><li>æ ¹æœ¬åŸå› åˆ†æï¼Œåœ¨è¿è¡Œæ—¶åˆ†æä»£ç </li><li>æœåŠ¡æ‹“æ‰‘å›¾åˆ†æ</li><li>æœåŠ¡ã€æœåŠ¡å®ä¾‹å’Œç«¯ç‚¹ä¾èµ–å…³ç³»åˆ†æ</li><li>æ£€æµ‹æ…¢é€ŸæœåŠ¡å’Œç«¯ç‚¹</li><li>æ€§èƒ½ä¼˜åŒ–</li><li>åˆ†å¸ƒå¼è·Ÿè¸ªå’Œä¸Šä¸‹æ–‡ä¼ æ’­</li><li>æ•°æ®åº“è®¿é—®æŒ‡æ ‡ï¼Œæ£€æµ‹æ…¢é€Ÿæ•°æ®åº“è®¿é—®è¯­å¥ï¼ˆåŒ…æ‹¬SQLè¯­å¥ï¼‰</li><li>æŠ¥è­¦</li><li>æµè§ˆå™¨æ€§èƒ½ç›‘æ§</li></ul><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><p>skywalking_ns.yaml</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking</code></pre><hr><p>oap-serviceaccount.yaml</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">release</span><span class="token punctuation">:</span> 8.3.0  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">release</span><span class="token punctuation">:</span> 8.3.0<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">,</span><span class="token string">"configmaps"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">release</span><span class="token punctuation">:</span> 8.3.0<span class="token key atrule">rules</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">,</span> <span class="token string">"endpoints"</span><span class="token punctuation">,</span> <span class="token string">"services"</span><span class="token punctuation">]</span>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"extensions"</span><span class="token punctuation">]</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"deployments"</span><span class="token punctuation">,</span> <span class="token string">"replicasets"</span><span class="token punctuation">]</span>  <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">release</span><span class="token punctuation">:</span> 8.3.0<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">release</span><span class="token punctuation">:</span> 8.3.0<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server<span class="token key atrule">subjects</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking</code></pre><hr><p>sky-deployment.yaml</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE          <span class="token key atrule">value</span><span class="token punctuation">:</span> elasticsearch7        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_NAMESPACE          <span class="token key atrule">value</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>cluster        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_CLUSTER_NODES          <span class="token key atrule">value</span><span class="token punctuation">:</span> elasticsearch.logs<span class="token punctuation">:</span><span class="token number">9200</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_SUPER_DATASET_INDEX_SHARDS_FACTOR          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"6"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_BULK_ACTIONS          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"4000"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_FLUSH_INTERVAL          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"30"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_QUERY_MAX_SIZE          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"10000"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_QUERY_SEGMENT_SIZE          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"500"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_STORAGE_ES_QUERY_PROFILE_TASK_SIZE          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"500"</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor33.huhuhahei.com/library/apache/skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server<span class="token punctuation">:</span>8.5.0<span class="token punctuation">-</span>es7        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skywalking  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.111.92.41  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30258</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">12800</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">12800</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30320</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">11800</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">11800</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">-</span>oap<span class="token punctuation">-</span>server  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><hr><p>sky-uideploy.yaml</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skyui  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> skyui  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> skyui    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_OAP_ADDRESS          <span class="token key atrule">value</span><span class="token punctuation">:</span> skywalking<span class="token punctuation">:</span><span class="token number">12800</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SW_TIMEOUT          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"20000"</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/library/apache/skywalking<span class="token punctuation">-</span>ui<span class="token punctuation">:</span>8.5.0        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">name</span><span class="token punctuation">:</span> skyui        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> skyui  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> skywalking<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.96.154.174  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>admin    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30185</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> skyui  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><h1 id="ä¸‰-è®¿é—®æŸ¥çœ‹"><a href="#ä¸‰-è®¿é—®æŸ¥çœ‹" class="headerlink" title="ä¸‰ è®¿é—®æŸ¥çœ‹"></a>ä¸‰ è®¿é—®æŸ¥çœ‹</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/3481571111.png"><br>æœåŠ¡ç«¯å·²ç»é…ç½®å¥½äº† åé¢å¯ä»¥æ¥å…¥agentç«¯</p>]]></content>
      
      
      <categories>
          
          <category> å¼€æºé¡¹ç›® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx 1.78ç¼–è¯‘å®‰è£…</title>
      <link href="/6abca5b8/"/>
      <url>/6abca5b8/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€-å®‰è£…"><a href="#ä¸€-å®‰è£…" class="headerlink" title="ä¸€ å®‰è£…"></a><strong>ä¸€ å®‰è£…</strong></h2><h3 id="1-1-å®‰è£…æ‰€ä»¥è¦ä¾èµ–"><a href="#1-1-å®‰è£…æ‰€ä»¥è¦ä¾èµ–" class="headerlink" title="1.1 å®‰è£…æ‰€ä»¥è¦ä¾èµ–"></a><strong>1.1 å®‰è£…æ‰€ä»¥è¦ä¾èµ–</strong></h3><pre class=" language-bash"><code class="language-bash">yum -y <span class="token function">install</span> gcc gcc-c++ lrzsz pcre-devel zlib-devel openssl openssl-devel</code></pre><h3 id="1-2-è§£å‹æ–‡ä»¶"><a href="#1-2-è§£å‹æ–‡ä»¶" class="headerlink" title="1.2 è§£å‹æ–‡ä»¶"></a><strong>1.2 è§£å‹æ–‡ä»¶</strong></h3><pre class=" language-bash"><code class="language-bash">curl -O http://kode.huhuhahei.cn/index.php?user/publicLink\<span class="token operator">&amp;</span>fid<span class="token operator">=</span>568dTMagXT7m-kmKWLpMy2Ium_O4mHbu6RypnzB8lOtS3cv6ZLXBz_VHvo4RIQRIeTsiExnsM2dKgfwWwERLc-mYsQz0G5HMzFcXIqPjr_YxsEpgvx8kZW7ROA\<span class="token operator">&amp;</span>file_name<span class="token operator">=</span>/nginx-1.17.8.tar.gzcurl -O http://kode.huhuhahei.cn/index.php?user/publicLink\<span class="token operator">&amp;</span>fid<span class="token operator">=</span>5893HDAqQsezkGTjTgdBpdWi1P3rXIdkydzX4ycPbFm4T6dcsUcvUEMpSNk4cnsjjN4TcfR56sDiSJeCRcM7dqJg8Dmfo5f7eO_0YftvwTkFukXd3sT88wuqR3cHetk\<span class="token operator">&amp;</span>file_name<span class="token operator">=</span>/nginx-module-vts.tar.gzcurl -O http://kode.huhuhahei.cn/index.php?user/publicLink\<span class="token operator">&amp;</span>fid<span class="token operator">=</span>1dcez7qeWIZHjLkOUxlkHeB745k1j20xnRlpCvUertRwRBSi_ESaGXhZj8FYGPfwdZ7sSHUWTMM5Qq0Na7YjwVpR8OsbIGT4RZy1E8mo3cxanSFSY5xZBo6QbrbYuX6V0icUbzQ0DoDNGJjcMw\<span class="token operator">&amp;</span>file_name<span class="token operator">=</span>/headers-more-nginx-module-0.33.tar.gz</code></pre><pre class=" language-bash"><code class="language-bash"><span class="token function">tar</span> xf nginx-1.17.8.tar.gz -C /usr/src<span class="token function">tar</span> xf nginx-module-vts.tar.gz -C /usr/src/<span class="token function">tar</span> xf headers-more-nginx-module-0.33.tar.gz -C /usr/src/</code></pre><h3 id="1-3-ç¼–è¯‘"><a href="#1-3-ç¼–è¯‘" class="headerlink" title="1.3 ç¼–è¯‘"></a><strong>1.3 ç¼–è¯‘</strong></h3><pre class=" language-bash"><code class="language-bash"><span class="token function">cd</span> /usr/src/nginx-1.17.8/./configure --prefix<span class="token operator">=</span>/usr/local/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_sub_module --add-module<span class="token operator">=</span><span class="token punctuation">..</span>/headers-more-nginx-module-0.33 --with-stream --with-stream_ssl_preread_module --add-module<span class="token operator">=</span><span class="token punctuation">..</span>/nginx-module-vts/</code></pre><h3 id="1-4-å®‰è£…"><a href="#1-4-å®‰è£…" class="headerlink" title="1.4 å®‰è£…"></a><strong>1.4 å®‰è£…</strong></h3><pre class=" language-bash"><code class="language-bash"><span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><h2 id="äºŒ-ä¼˜åŒ–"><a href="#äºŒ-ä¼˜åŒ–" class="headerlink" title="äºŒ ä¼˜åŒ–"></a><strong>äºŒ ä¼˜åŒ–</strong></h2><h3 id="2-1-åˆ›å»ºè½¯è¿æ¥"><a href="#2-1-åˆ›å»ºè½¯è¿æ¥" class="headerlink" title="2.1 åˆ›å»ºè½¯è¿æ¥"></a><strong>2.1 åˆ›å»ºè½¯è¿æ¥</strong></h3><pre class=" language-bash"><code class="language-bash"><span class="token function">ln</span> -s /usr/local/nginx/sbin/* /usr/local/sbin/</code></pre><h3 id="2-2-åˆ›å»ºserveræ§åˆ¶"><a href="#2-2-åˆ›å»ºserveræ§åˆ¶" class="headerlink" title="2.2 åˆ›å»ºserveræ§åˆ¶"></a><strong>2.2 åˆ›å»ºserveræ§åˆ¶</strong></h3><pre class=" language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment" spellcheck="true">#chkconfig: - 99 20</span><span class="token comment" spellcheck="true">#description:Nginx Service l Control Script</span>PROG<span class="token operator">=</span><span class="token string">"/usr/local/nginx/sbin/nginx"</span>PIDF<span class="token operator">=</span><span class="token string">"/usr/local/nginx/logs/nginx.pid"</span><span class="token keyword">case</span> <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token keyword">in</span>        start<span class="token punctuation">)</span>        <span class="token variable">$PROG</span><span class="token punctuation">;</span><span class="token punctuation">;</span>        stop<span class="token punctuation">)</span>        <span class="token function">kill</span> -s QUIT <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $PIDF<span class="token variable">)</span></span><span class="token punctuation">;</span><span class="token punctuation">;</span>        restart<span class="token punctuation">)</span>        <span class="token variable">$0</span> stop        <span class="token variable">$0</span> start<span class="token punctuation">;</span><span class="token punctuation">;</span>        reload<span class="token punctuation">)</span>        <span class="token function">kill</span> -s HUP <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $PIDF<span class="token variable">)</span></span><span class="token punctuation">;</span><span class="token punctuation">;</span>        *<span class="token punctuation">)</span>        <span class="token keyword">echo</span> <span class="token string">"Usage: <span class="token variable">$0</span> {start|stop|restart|reload}"</span>        <span class="token keyword">exit</span> 1esac<span class="token keyword">exit</span> 0</code></pre><p><strong>æ·»åŠ æƒé™</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">chmod</span> +x /etc/init.d/nginx</code></pre><p><strong>æ·»åŠ chkconfig</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">chkconfig</span> --add nginx</code></pre><p><strong>å¯åŠ¨æœåŠ¡</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">service</span> nginx start</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ansibleéƒ¨ç½²squidä»£ç†</title>
      <link href="/5624b5ae/"/>
      <url>/5624b5ae/</url>
      
        <content type="html"><![CDATA[<h3 id="Ansibleéƒ¨ç½²squidä»£ç†"><a href="#Ansibleéƒ¨ç½²squidä»£ç†" class="headerlink" title="Ansibleéƒ¨ç½²squidä»£ç†"></a><strong>Ansibleéƒ¨ç½²squidä»£ç†</strong></h3><p><strong>squid ansibleéƒ¨ç½²æ–‡æ¡£</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> vps.1  <span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install squid      <span class="token key atrule">yum</span><span class="token punctuation">:</span> name=squid    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy passwd      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/opt/ansible/passwd dest=/etc/squid/passwd    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> copy config      <span class="token key atrule">copy</span><span class="token punctuation">:</span> src=/opt/ansible/squid.conf dest=/etc/squid/squid.conf    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> stop firewlld      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=firewalld state=stopped enabled=no    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> start squid      <span class="token key atrule">service</span><span class="token punctuation">:</span> name=squid state=started enabled=yes</code></pre><p><strong>Squid é…ç½®æ–‡ä»¶</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Recommended minimum configuration:</span><span class="token comment" spellcheck="true">#</span>auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/passwdauth_param basic realm proxyacl authenticated proxy_auth REQUIREDhttp_access allow authenticated<span class="token comment" spellcheck="true"># Example rule allowing access from your local networks.</span><span class="token comment" spellcheck="true"># Adapt to list your (internal) IP networks from where browsing</span><span class="token comment" spellcheck="true"># should be allowed</span>acl localnet src 10.0.0.0/8 <span class="token comment" spellcheck="true"># RFC1918 possible internal network</span>acl localnet src 172.16.0.0/12  <span class="token comment" spellcheck="true"># RFC1918 possible internal network</span>acl localnet src 192.168.0.0/16 <span class="token comment" spellcheck="true"># RFC1918 possible internal network</span>acl localnet src fc00<span class="token punctuation">:</span><span class="token punctuation">:</span>/7       <span class="token comment" spellcheck="true"># RFC 4193 local private network range</span>acl localnet src fe80<span class="token punctuation">:</span><span class="token punctuation">:</span>/10      <span class="token comment" spellcheck="true"># RFC 4291 link-local (directly plugged) machines</span>acl SSL_ports port 443acl Safe_ports port 80    <span class="token comment" spellcheck="true"># http</span>acl Safe_ports port 21    <span class="token comment" spellcheck="true"># ftp</span>acl Safe_ports port 443   <span class="token comment" spellcheck="true"># https</span>acl Safe_ports port 70    <span class="token comment" spellcheck="true"># gopher</span>acl Safe_ports port 210   <span class="token comment" spellcheck="true"># wais</span>acl Safe_ports port 1025<span class="token punctuation">-</span><span class="token number">65535  </span><span class="token comment" spellcheck="true"># unregistered ports</span>acl Safe_ports port 280   <span class="token comment" spellcheck="true"># http-mgmt</span>acl Safe_ports port 488   <span class="token comment" spellcheck="true"># gss-http</span>acl Safe_ports port 591   <span class="token comment" spellcheck="true"># filemaker</span>acl Safe_ports port 777   <span class="token comment" spellcheck="true"># multiling http</span>acl CONNECT method CONNECT<span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Recommended minimum Access Permission configuration:</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Deny requests to certain unsafe ports</span>http_access deny <span class="token tag">!Safe_ports</span><span class="token comment" spellcheck="true"># Deny CONNECT to other than secure SSL ports</span>http_access allow CONNECT <span class="token tag">!SSL_ports</span><span class="token comment" spellcheck="true"># Only allow cachemgr access from localhost</span>http_access allow localhost managerhttp_access deny manager<span class="token comment" spellcheck="true"># We strongly recommend the following be uncommented to protect innocent</span><span class="token comment" spellcheck="true"># web applications running on the proxy server who think the only</span><span class="token comment" spellcheck="true"># one who can access services on "localhost" is a local user</span><span class="token comment" spellcheck="true">#http_access deny to_localhost</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS</span><span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Example rule allowing access from your local networks.</span><span class="token comment" spellcheck="true"># Adapt localnet in the ACL section to list your (internal) IP networks</span><span class="token comment" spellcheck="true"># from where browsing should be allowed</span>http_access allow localnethttp_access allow localhost<span class="token comment" spellcheck="true"># And finally deny all other access to this proxy</span>http_access deny all<span class="token comment" spellcheck="true"># Squid normally listens to port 3128</span>http_port 8080<span class="token comment" spellcheck="true"># Uncomment and adjust the following to add a disk cache directory.</span><span class="token comment" spellcheck="true">#cache_dir ufs /var/spool/squid 100 16 256</span><span class="token comment" spellcheck="true"># Leave coredumps in the first cache dir</span>coredump_dir /var/spool/squid<span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># Add any of your own refresh_pattern entries above these.</span><span class="token comment" spellcheck="true">#</span>refresh_pattern ^ftp<span class="token punctuation">:</span>   1440  20% 10080refresh_pattern ^gopher<span class="token punctuation">:</span>  1440  0%  1440refresh_pattern <span class="token punctuation">-</span>i (/cgi<span class="token punctuation">-</span>bin/<span class="token punctuation">|</span>\<span class="token punctuation">?</span>) 0 0%  0refresh_pattern .   0 20% 4320</code></pre><p><strong>åˆ›å»ºå¯†ç æ–‡ä»¶</strong></p><pre class=" language-yaml"><code class="language-yaml">htpasswd <span class="token punctuation">-</span>c /opt/ansible/passwd test<span class="token comment" spellcheck="true"># é»˜è®¤å¯†ç 123456</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> DevOps </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DevOps </tag>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginxä»£ç†æ·»åŠ ç¼“å­˜</title>
      <link href="/2eab2259/"/>
      <url>/2eab2259/</url>
      
        <content type="html"><![CDATA[<h3 id="æ·»åŠ é…ç½®"><a href="#æ·»åŠ é…ç½®" class="headerlink" title="æ·»åŠ é…ç½®"></a><strong>æ·»åŠ é…ç½®</strong></h3><p><strong>nginx.confæ·»åŠ ç¼“å­˜é…ç½®</strong></p><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">proxy_cache_path</span> <span class="token operator">/</span>data<span class="token operator">/</span>cache levels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span> keys_zone<span class="token operator">=</span>cache_one<span class="token punctuation">:</span>200m inactive<span class="token operator">=</span>1d max_size<span class="token operator">=</span>30g<span class="token punctuation">;</span></code></pre><p><strong>nginx å­é…ç½®æ–‡ä»¶ä¸­å¼•ç”¨é…ç½®</strong></p><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span> <span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>htm<span class="token operator">|</span>html<span class="token operator">|</span>css<span class="token operator">|</span>js<span class="token operator">|</span><span class="token keyword">flv</span><span class="token operator">|</span>ico<span class="token operator">|</span>swf<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">proxy_pass</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>huhuhahei<span class="token punctuation">.</span>cn<span class="token punctuation">;</span>                <span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>                <span class="token keyword">proxy_cache</span> cache_one<span class="token punctuation">;</span>                <span class="token keyword">proxy_cache_valid</span> <span class="token number">200</span> <span class="token number">302</span> 1h<span class="token punctuation">;</span>                <span class="token keyword">proxy_cache_valid</span> <span class="token number">301</span> 1d<span class="token punctuation">;</span>                <span class="token keyword">proxy_cache_valid</span> any 1m<span class="token punctuation">;</span>                <span class="token keyword">include</span> conf<span class="token punctuation">.</span>d<span class="token operator">/</span>steam_sub_filter<span class="token punctuation">.</span>conf<span class="token punctuation">;</span>                <span class="token keyword">expires</span> 30d<span class="token punctuation">;</span>        <span class="token punctuation">}</span></code></pre><p><strong>é…ç½®å®Œæˆé‡å¯nginx</strong></p><pre class=" language-bash"><code class="language-bash">nginx -s reload</code></pre><p><strong>æŸ¥çœ‹ç¼“å­˜ç›®å½•æ˜¯å¦æœ‰ç”Ÿæˆæ–‡ä»¶</strong></p><pre class=" language-bash"><code class="language-bash">ll cache/total 100drwx------  18 nobody root     150 Mar 26 16:00 ./drwxr-xr-x   5 root   root      48 Apr 11 11:27 <span class="token punctuation">..</span>/drwx------ 167 nobody nogroup 4096 Apr 20 14:21 0/drwx------ 171 nobody nogroup 4096 Apr 20 14:20 1/drwx------ 157 nobody nogroup 4096 Apr 20 10:55 2/drwx------ 165 nobody nogroup 4096 Apr 20 10:55 3/drwx------ 177 nobody nogroup 4096 Apr 20 11:33 4/drwx------ 170 nobody nogroup 4096 Apr 20 14:21 5/drwx------ 176 nobody nogroup 4096 Apr 20 14:21 6/drwx------ 163 nobody nogroup 4096 Apr 20 07:14 7/drwx------ 169 nobody nogroup 4096 Apr 20 04:22 8/drwx------ 162 nobody nogroup 4096 Apr 20 14:21 9/drwx------ 164 nobody nogroup 4096 Apr 20 14:20 a/drwx------ 174 nobody nogroup 4096 Apr 20 11:33 b/drwx------ 180 nobody nogroup 4096 Apr 20 10:55 c/drwx------ 179 nobody nogroup 4096 Apr 20 14:20 d/drwx------ 160 nobody nogroup 4096 Apr 20 10:15 e/drwx------ 169 nobody nogroup 4096 Apr 20 10:58 f</code></pre><p><strong>æ–‡ä»¶æ­£å¸¸ç”Ÿæˆ è¯æ˜ç¼“å­˜é…ç½®å·²ç»ç”Ÿæ•ˆ</strong></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Goproxy ä»£ç†éƒ¨ç½²</title>
      <link href="/7b9f226b/"/>
      <url>/7b9f226b/</url>
      
        <content type="html"><![CDATA[<p><strong>goproxyå®‰è£…é…ç½®(è¿™æ¬¡ä¸‹è½½çš„æ˜¯å•†ä¸šç‰ˆæœ¬çš„)</strong></p><pre class=" language-yaml"><code class="language-yaml">curl <span class="token punctuation">-</span>L https<span class="token punctuation">:</span>//mirrors.host900.com/https<span class="token punctuation">:</span>//github.com/snail007/goproxy/blob/master/install_auto_commercial.sh <span class="token punctuation">|</span> bash</code></pre><p><strong>å®‰è£…å®Œæˆï¼Œé…ç½®ç›®å½•æ˜¯&#x2F;etc&#x2F;proxy</strong></p><p><strong>å•†ä¸šç‰ˆæœ¬æ¿€æ´»</strong></p><pre class=" language-bash"><code class="language-bash">proxy http</code></pre><p><strong>æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤ä¸éœ€è¦æ“ä½œä¼šè‡ªåŠ¨åœæ­¢ç„¶åå†ç›®å½•ä¸‹å›å‡ºç°ä¸€ä¸ª.txtç»“å°¾çš„é—®é¢˜ä»¶,é‡Œé¢çš„å†…å®¹å°±æ˜¯æœºå™¨ç </strong></p><p><strong>æ¿€æ´»æ–¹æ³•å‚è€ƒ</strong></p><p><a href="https://snail007.host900.com/goproxy/page/free_vs_commercial/">https://snail007.host900.com/goproxy/page/free_vs_commercial&#x2F;</a></p><p><strong>æœåŠ¡å¯åŠ¨</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">nohup</span> proxy http -a test:123456:0:0 -t tcp -p <span class="token string">"0.0.0.0:8081"</span> -T tcp -P <span class="token string">"0.0.0.0:8080"</span> <span class="token operator">&amp;</span></code></pre><pre class=" language-bash"><code class="language-bash">å‚æ•°ä»‹ç»http ä½¿ç”¨httpåè®®è¿›è¡Œä»£ç†-a åˆ¶å®šç”¨æˆ·è®¤è¯ ç”¨æˆ·å:å¯†ç :æœ€å¤§è¿æ¥æ•°:é€Ÿåº¦é™åˆ¶-t æŒ‡å®šåè®®-p ç›‘å¬ç«¯å£-T åç«¯æœåŠ¡åè®®-P åç«¯æœåŠ¡åœ°å€å’Œç«¯å£</code></pre><p>å®˜æ–¹æ–‡æ¡£<a href="https://snail007.host900.com/goproxy/manual/zh/#/?id=_2tcp%e4%bb%a3%e7%90%86">goproxy</a></p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®°å½•ä¸€ä¸ªnacoséƒ¨ç½²æŠ¥é”™å¤„ç†è¿‡ç¨‹</title>
      <link href="/5d7d0bc/"/>
      <url>/5d7d0bc/</url>
      
        <content type="html"><![CDATA[<p>K8sé»˜è®¤åªæœ‰readyçš„podæ‰èƒ½è¢«ä½œä¸ºsvcçš„åç«¯,ä½†æœ‰æ—¶å¸Œæœ›å³ä½¿podæ²¡æœ‰å‡†å¤‡å°±ç»ªï¼ŒæœåŠ¡å‘ç°æœºåˆ¶ä¹Ÿèƒ½å¤Ÿå‘ç°æ‰€æœ‰åŒ¹é…æœåŠ¡æ ‡ç­¾é€‰æ‹©å™¨çš„pod<br>é’ˆå¯¹è¿™ä¸ªéœ€æ±‚å¯ä»¥é…ç½®ä¸€ä¸ªæ³¨é‡Š</p><pre class=" language-bash"><code class="language-bash">service.alpha.kubernetes.io/tolerate-unready-endpointsï¼štrue</code></pre><p>è¡¨ç¤ºå…è®¸å°†æœªå°±ç»ªçš„podä½œä¸ºåç«¯æœåŠ¡<br>Nacosçš„svcå°±éœ€è¦è¿™ä¸ªé…ç½®</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">service.alpha.kubernetes.io/tolerate-unready-endpoints</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> server      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7848</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None</code></pre><p>ä½†æ˜¯ä»Šæ—¥éƒ¨ç½²æ–°çš„é›†ç¾¤å‘ç°ä¼šå‡ºç°è¿™ä¸ªæŠ¥é”™</p><pre class=" language-bash"><code class="language-bash">2022/05/10 19:04:03 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:04 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:05 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:06 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:07 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:08 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:09 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:10 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:11 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:12 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:13 lookup nacos-headless on 192.168.0.10:53: no such host2022/05/10 19:04:14 lookup nacos-headless on 192.168.0.10:53: no such host</code></pre><p>çœ‹æŠ¥é”™æ˜¯æ— æ³•è§£æsvcçš„åŸŸå ä½†æ˜¯è¿™ä¸ªåŸŸååˆä¸å¤ªå¯¹ svcçš„åŸŸåä¸åº”è¯¥æ˜¯è¿™ä¸ªå‘€::(æ€’)è¿™ä¸ªæŠ¥é”™ä¸Šç½‘æœç´¢ä¹Ÿæ²¡æœ‰è®°å½• ä¸€é¡¿æ“ä½œåçœ‹åˆ°æ–°çš„é›†ç¾¤æ˜¯1.20ç‰ˆæœ¬çš„ å¿½ç„¶æƒ³åˆ°æ˜¯ä¸æ˜¯æœ‰åœ°æ–¹å’Œæ–°ç‰ˆæœ¬ä¸é€‚é…å‘¢</p><p>ä¸Šç½‘ä¸€æœè¿˜çœŸæ‰¾åˆ° è¿™ä¸ªæ³¨é‡Šå¯èƒ½ä¼šåœ¨æ–°ç‰ˆæœ¬è¢«å»æ‰<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/05/2014853700.png"></p><p>äºæ˜¯æ·»åŠ æ–°çš„å­—æ®µ<code> publishNotReadyAddresses: true</code><br>å†æ¬¡å¯åŠ¨æœç„¶å¯åŠ¨æˆåŠŸäº†</p><pre class=" language-bash"><code class="language-bash">NAME      READY   STATUS    RESTARTS   AGEnacos-0   1/1     Running   0          5m31snacos-1   1/1     Running   0          4m9snacos-2   1/1     Running   0          2m10s</code></pre><p>ä¸ç¦æ„Ÿå¹ çœŸçš„æ˜¯ä¸€ä¸ªå°é…ç½® èƒ½è®©äººå¿™æ´»ä¸€ä¸‹åˆ:@(å†…ä¼¤)<br>è®°å½•ä¸‹ çœ‹çœ‹æ˜¯å¦æœ‰äººä¼šç¢°åˆ°è¿™ä¸ªé—®é¢˜</p>]]></content>
      
      
      <categories>
          
          <category> å¼€æºé¡¹ç›® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fortioå‹æµ‹å·¥å…·é…ç½®</title>
      <link href="/2d5d1649/"/>
      <url>/2d5d1649/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-Fortioç®€ä»‹"><a href="#ä¸€-Fortioç®€ä»‹" class="headerlink" title="ä¸€.Fortioç®€ä»‹"></a>ä¸€.Fortioç®€ä»‹</h1><p>Fortioè¿™ä¸ªåå­—æ¥è‡ªå¸Œè…Šè¯­Ï†Î¿ÏÏ„Î¯Î¿ï¼Œæ„æ€æ˜¯è´Ÿè½½&#x2F;è´Ÿæ‹…ã€‚æœ€åˆæ˜¯Istioçš„è´Ÿè½½æµ‹è¯•å·¥å…·ï¼Œç°åœ¨ä¸ºç‹¬ç«‹çš„é¡¹ç›®ã€‚</p><p>Fortioæ˜¯ä¸€ä¸ªå¿«é€Ÿï¼Œå°å‹ï¼ˆ3Mb dockeræ˜ åƒï¼Œå…·æœ‰æœ€å°çš„ä¾èµ–æ€§ï¼‰ï¼Œå¯é‡ç”¨ï¼Œå¯åµŒå…¥çš„goåº“ä»¥åŠå‘½ä»¤è¡Œå·¥å…·å’ŒæœåŠ¡å™¨è¿›ç¨‹ï¼Œè¯¥æœåŠ¡å™¨åŒ…æ‹¬ç®€å•çš„Web UIå’Œç»“æœçš„å›¾å½¢è¡¨ç¤ºï¼ˆå‡ä¸ºå•ä¸ªå»¶è¿Ÿå›¾ï¼‰ä»¥åŠå¤šé‡ç»“æœæ¯”è¾ƒæœ€å°ï¼Œæœ€å¤§ï¼Œå¹³å‡ï¼Œqpså’Œç™¾åˆ†ä½å›¾ã€‚</p><h1 id="äºŒ-Fortioéƒ¨ç½²"><a href="#äºŒ-Fortioéƒ¨ç½²" class="headerlink" title="äºŒ.Fortioéƒ¨ç½²"></a>äºŒ.Fortioéƒ¨ç½²</h1><p>yamlæ–‡ä»¶</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> fortio  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio    <span class="token key atrule">service</span><span class="token punctuation">:</span> fortio<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> http  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> fortio<span class="token punctuation">-</span>deploy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># This annotation causes Envoy to serve cluster.outbound statistics via 15000/stats</span>        <span class="token comment" spellcheck="true"># in addition to the stats normally served by Istio. The Circuit Breaking example task</span>        <span class="token comment" spellcheck="true"># gives an example of inspecting Envoy stats via proxy config.</span>        <span class="token key atrule">proxy.istio.io/config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>          <span class="token key atrule">proxyStatsMatcher</span><span class="token punctuation">:</span>            <span class="token key atrule">inclusionPrefixes</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">"cluster.outbound"</span>            <span class="token punctuation">-</span> <span class="token string">"cluster_manager"</span>            <span class="token punctuation">-</span> <span class="token string">"listener_manager"</span>            <span class="token punctuation">-</span> <span class="token string">"server"</span>            <span class="token punctuation">-</span> <span class="token string">"cluster.xds-grpc"</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> fortio    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> fortio        <span class="token key atrule">image</span><span class="token punctuation">:</span> fortio/fortio<span class="token punctuation">:</span>latest_release        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>fortio        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8079</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span>ping</code></pre><h1 id="ä¸‰-å‹åŠ›æµ‹è¯•"><a href="#ä¸‰-å‹åŠ›æµ‹è¯•" class="headerlink" title="ä¸‰.å‹åŠ›æµ‹è¯•"></a>ä¸‰.å‹åŠ›æµ‹è¯•</h1><h3 id="1-ç®€å•è®¿é—®"><a href="#1-ç®€å•è®¿é—®" class="headerlink" title="1.ç®€å•è®¿é—®"></a>1.ç®€å•è®¿é—®</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">export</span> FORTIO_POD<span class="token operator">=</span><span class="token punctuation">$(</span>kubectl get pods -l app<span class="token operator">=</span>fortio -o <span class="token string">'jsonpath={.items[0].metadata.name}'</span><span class="token punctuation">)</span>kubectl <span class="token function">exec</span> <span class="token string">"<span class="token variable">$FORTIO_POD</span>"</span> -c fortio -- /usr/bin/fortio curl -quiet http://www.huhuhahei.cn</code></pre><h3 id="2-å‘é€å¹¶å‘æ•°ä¸º-2-çš„è¿æ¥ï¼ˆ-c-2ï¼‰ï¼Œè¯·æ±‚-20-æ¬¡ï¼ˆ-n-20ï¼‰"><a href="#2-å‘é€å¹¶å‘æ•°ä¸º-2-çš„è¿æ¥ï¼ˆ-c-2ï¼‰ï¼Œè¯·æ±‚-20-æ¬¡ï¼ˆ-n-20ï¼‰" class="headerlink" title="2.å‘é€å¹¶å‘æ•°ä¸º 2 çš„è¿æ¥ï¼ˆ-c 2ï¼‰ï¼Œè¯·æ±‚ 20 æ¬¡ï¼ˆ-n 20ï¼‰"></a>2.å‘é€å¹¶å‘æ•°ä¸º 2 çš„è¿æ¥ï¼ˆ<code>-c 2</code>ï¼‰ï¼Œè¯·æ±‚ 20 æ¬¡ï¼ˆ<code>-n 20</code>ï¼‰</h3><pre class=" language-bash"><code class="language-bash">kubectl <span class="token function">exec</span> <span class="token string">"<span class="token variable">$FORTIO_POD</span>"</span> -c fortio -- /usr/bin/fortio load -c 2 -qps 0 -n 20 -loglevel Warning https://www.huhuhahei.cn</code></pre><blockquote><p>å‘½ä»¤è§£é‡Šå¦‚ä¸‹ï¼š</p><p>-c è¡¨ç¤ºå¹¶å‘æ•°</p><p>-n ä¸€å…±å¤šå°‘è¯·æ±‚</p><p>-qps æ¯ç§’æŸ¥è¯¢æ•°ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶</p><p>-loglevel æŒ‡å®šæ—¥å¿—çº§åˆ«</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®°å½•ä¸€ä¸ªCephé›†ç¾¤æ•°æ®å·æŒ‚è½½çš„é—®é¢˜</title>
      <link href="/7eaaabae/"/>
      <url>/7eaaabae/</url>
      
        <content type="html"><![CDATA[<p>å½“æˆ‘ä»¬ç”¨cephåšk8sçš„åŠ¨æ€å­˜å‚¨æ—¶,ç‰¹åˆ«æ˜¯ä½¿ç”¨rdbå­˜å‚¨,åœ¨podé‡å¯æ˜¯æ€»ä¼šé‡åˆ°æ— æ³•æŒ‚è½½pvcçš„é—®é¢˜</p><p>å…³é”®æŠ¥é”™</p><pre class=" language-bash"><code class="language-bash">MountVolume.WaitForAttach failed <span class="token keyword">for</span> volume <span class="token string">"pvc-9bb7c438-2328-47ed-bfbd-c261d111644e"</span> <span class="token keyword">:</span> rbd image k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47 is still being used</code></pre><p>è¿™é‡Œæ˜¾ç¤ºpvcå·²ç»è¢«å…¶ä»–çš„podä½¿ç”¨äº†,æ ¹æœ¬åŸå› æ˜¯ä¹‹å‰çš„podåˆ é™¤ä½†æ˜¯æŒ‚è½½çš„rbdæ–‡ä»¶å¹¶æ²¡æœ‰åˆ é™¤</p><p>è§£å†³æ–¹æ³•æ˜¯éœ€è¦åœ¨cephé›†ç¾¤æŸ¥çœ‹è¿™ä¸ªrbdæ–‡ä»¶æŒ‚è½½çš„ä½ç½®</p><pre class=" language-bash"><code class="language-bash">rbd info k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47<span class="token comment" spellcheck="true">#é€šè¿‡è¿™ä¸ªå‘½ä»¤å¯ä»¥æŸ¥çœ‹åˆ°è¿™ä¸ªrbdæ–‡ä»¶çš„ä¿¡æ¯</span>rbd image <span class="token string">'kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47'</span><span class="token keyword">:</span>    size 10 GiB <span class="token keyword">in</span> 2560 objects    order 22 <span class="token punctuation">(</span>4 MiB objects<span class="token punctuation">)</span>    snapshot_count: 0    id: 3bfff12997ae2    block_name_prefix: rbd_data.3bfff12997ae2    format: 2    features:    op_features:    flags:    create_timestamp: Sat Dec 25 11:55:16 2021    access_timestamp: Sat Dec 25 11:55:16 2021    modify_timestamp: Sat Dec 25 11:55:16 2021</code></pre><pre class=" language-bash"><code class="language-bash">rados listwatchers -p k8s-pool rbd_header.3bfff12997ae2watcher<span class="token operator">=</span>192.168.0.135:0/1321540337 client.685758 cookie<span class="token operator">=</span>18446462598732840974<span class="token comment" spellcheck="true">#ä¸Šé¢çš„å‘½ä»¤å¯ä»¥æŸ¥çœ‹åˆ°è¿™ä¸ªrbdæ–‡ä»¶æŒ‚è½½çš„èŠ‚ç‚¹</span></code></pre><p>æŸ¥çœ‹åˆ°å…·ä½“çš„èŠ‚ç‚¹åˆ°èŠ‚ç‚¹ä¸ŠæŸ¥çœ‹rbdæ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash"><span class="token function">ls</span> /dev/rbd/k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47 -llrwxrwxrwx 1 root root 10 May 27 15:46 /dev/rbd/k8s-pool/kubernetes-dynamic-pvc-841601fa-f1e8-40a0-b173-77161c03bc47 -<span class="token operator">></span> <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/rbd7</code></pre><p>å¯ä»¥æŸ¥çœ‹å…·ä½“çš„rbdæ–‡ä»¶,ç„¶åå¸è½½æ‰</p><pre class=" language-bash"><code class="language-bash">rbd unmap -o force /dev/rbd7</code></pre><p>åœ¨è§‚å¯Ÿpodå°±å¯ä»¥æ­£å¸¸æŒ‚è½½äº†</p>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ceph </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Promethuesé€šè¿‡node_exportç›‘æ§linuxæœåŠ¡å™¨</title>
      <link href="/93493f88/"/>
      <url>/93493f88/</url>
      
        <content type="html"><![CDATA[<p><strong>1.node_exportä¸‹è½½</strong><br>è¿™é‡Œç›´æ¥ä½¿ç”¨wgetä¸‹è½½ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å®˜ç½‘ä¸‹è½½<a href="https://prometheus.io/download/#node_exporter">https://prometheus.io/download/#node_exporter</a></p><pre class=" language-yaml"><code class="language-yaml">wget https<span class="token punctuation">:</span>//github.com/prometheus/node_exporter/releases/download/v1.2.2/node_exporter<span class="token punctuation">-</span>1.2.2.linux<span class="token punctuation">-</span>amd64.tar.gz</code></pre><hr><p><strong>2.å®‰è£…</strong></p><pre class=" language-yaml"><code class="language-yaml">tar xf node_exporter<span class="token punctuation">-</span>1.2.2.linux<span class="token punctuation">-</span>amd64.tar.gzmv node_exporter<span class="token punctuation">-</span>1.2.2.linux<span class="token punctuation">-</span>amd64 /usr/local/node_exporterr</code></pre><hr><p><strong>3.å¯åŠ¨æœåŠ¡</strong></p><pre class=" language-yaml"><code class="language-yaml">cd /usr/local/node_exporternohup ./node_exporter <span class="token punctuation">></span> node_export.log &amp;</code></pre><hr><p><strong>4.promethuesæ·»åŠ job</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'Linux'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">'106.75.x.x:9100'</span></code></pre><hr><p><strong>5.grafana æ·»åŠ æ¨¡æ¿å¹¶å±•ç¤º</strong><br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/1224276126.jpg"><br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2525040169.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheusé€šè¿‡Pushgatewayç›‘æ§ç½‘ç»œé“¾è·¯</title>
      <link href="/d4b67256/"/>
      <url>/d4b67256/</url>
      
        <content type="html"><![CDATA[<p><strong>1.dockerå¯åŠ¨pushgateway</strong></p><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>itd <span class="token punctuation">-</span><span class="token punctuation">-</span>name PushGateway <span class="token punctuation">-</span>p 9091<span class="token punctuation">:</span>9091 prom/pushgateway</code></pre><hr><p><strong>2.æœåŠ¡å™¨å†…ç¼–å†™è„šæœ¬ç›‘æ§ç½‘ç»œå¹¶å°†æ ¼å¼è½¬åŒ–ä¸ºprometheusæ”¯æŒçš„</strong></p><p>&#96;&#96;&#96;yaml<br>#!&#x2F;bin&#x2F;bash<br>#<br>#####################################<br>#@brief åŠŸèƒ½ï¼šç›‘æ§ç½‘è·¯ä¸¢åŒ…ç‡å’Œå»¶è¿Ÿ -s æ˜¯ä¸€ä¸ªpingåŒ…çš„å¤§å° -W æ˜¯å»¶è¿Ÿtimeout -c æ˜¯å‘ç”Ÿå¤šå°‘æ•°æ®åŒ…<br>#@author xiajing<br>#@version 1.0<br>#@date 2021&#x2F;01&#x2F;13<br>#@log no<br>#####################################<br>#shell Env<br>#pingå‘åŒ…æ•°<br>c_times&#x3D;200<br>#IPåˆ—è¡¨æ•°ç»„<br>ip_arr&#x3D;( 118.193.x.x)<br>for (( i &#x3D; 0; i &lt; $</p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Pushgateway </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheusé…ç½®nginxç›‘æ§</title>
      <link href="/bd372af0/"/>
      <url>/bd372af0/</url>
      
        <content type="html"><![CDATA[<p>æœ¬ç¯‡ä¸»è¦ä»‹ç»é€šè¿‡nginx-vtsæ¥è·å–nginxç›‘æ§æƒ…å†µ <strong>1.nginxç¼–è¯‘å®‰è£…éœ€è¦æ·»åŠ vtsæ¨¡å—</strong></p><pre class=" language-bash"><code class="language-bash">./configure --prefix<span class="token operator">=</span>/usr/local/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_stub_status_module --add-module<span class="token operator">=</span><span class="token punctuation">..</span>/nginx-module-vts/ --with-http_ssl_module<span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><p>nginx -VæŸ¥çœ‹æ¨¡å—æ˜¯å¦æ·»åŠ æˆåŠŸ <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/644249520.png"></p><p><strong>2.nginxé…ç½®æ–‡ä»¶æ·»åŠ é…ç½®</strong></p><pre class=" language-bash"><code class="language-bash">httpä¸‹é…ç½®è¿™ä¸¤ä¸ªå‚æ•°vhost_traffic_status_zone<span class="token punctuation">;</span>vhost_traffic_status_filter_by_host on<span class="token punctuation">;</span>serveræ®µserver <span class="token punctuation">{</span>        listen 8089<span class="token punctuation">;</span>        server_name localhost<span class="token punctuation">;</span>        root html<span class="token punctuation">;</span>        index index.html index.php<span class="token punctuation">;</span>    location /status <span class="token punctuation">{</span>                        vhost_traffic_status_display<span class="token punctuation">;</span>                        vhost_traffic_status_display_format html<span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><strong>3.é…ç½®å®Œæˆé‡å¯æœåŠ¡ é€šè¿‡ip+prot&#x2F;statusè®¿é—®</strong></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/462020058.png"></p><p><strong>4.nginx-vts-exporterä¸‹è½½å¹¶é…ç½®</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> -c https://github.com/hnlq715/nginx-vts-exporter/releases/download/v0.9.1/nginx-vts-exporter-0.9.1.linux-amd64.tar.gz<span class="token function">mkdir</span> /usr/local/nginx-vts-exporter<span class="token function">tar</span> xf nginx-vts-exporter-0.9.1.linux-amd64.tar.gz -C /usr/local/nginx-vts-exporter<span class="token function">nohup</span> ./nginx-vts-exporter -nginx.scrape_timeout 10 -nginx.scrape_uri http://172.19.0.3:8082/status/format/json <span class="token operator">&amp;</span></code></pre><p><strong>5.promethuesæ·»åŠ é…ç½®</strong></p><pre class=" language-bash"><code class="language-bash">- job_name: <span class="token string">'Nginx'</span>    static_configs:    - targets:      - <span class="token string">'106.75.x.x:9913'</span></code></pre><p><strong>6.grafanaå¯¼å…¥æ¨¡æ¿å¹¶æŸ¥çœ‹</strong></p><blockquote><p>å¯¼å…¥nginxæ¨¡æ¿</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/501805390.png"></p><blockquote><p>ç»“æœå±•ç¤º</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/3857789207.png"></p><p>[[[<strong>1</strong>]   ]   ]    <a href="https://www.huhuhahei.cn/usr/uploads/2021/08/644249520.png">https://www.huhuhahei.cn/usr/uploads/2021/08/644249520.png</a> </p><p>[[[<strong>2</strong>]   ]   ]    <a href="http://www.huhuhahei.cn/usr/uploads/2021/08/462020058.png">http://www.huhuhahei.cn/usr/uploads/2021/08/462020058.png</a> </p><p>[[[<strong>3</strong>]   ]   ]    <a href="https://www.huhuhahei.cn/usr/uploads/2021/08/501805390.png">https://www.huhuhahei.cn/usr/uploads/2021/08/501805390.png</a> </p><p>[[[<strong>4</strong>]   ]   ]    <a href="https://www.huhuhahei.cn/usr/uploads/2021/08/3857789207.png">https://www.huhuhahei.cn/usr/uploads/2021/08/3857789207.png</a> </p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Prometheusç›‘æ§Mysql</title>
      <link href="/db43c3bf/"/>
      <url>/db43c3bf/</url>
      
        <content type="html"><![CDATA[<p><strong>1.å®‰è£…mysql_exporter</strong></p><pre class=" language-yaml"><code class="language-yaml">wget  https<span class="token punctuation">:</span>//github.com/prometheus/mysqld_exporter/releases/download/v0.12.1/mysqld_exporter<span class="token punctuation">-</span>0.12.1.linux<span class="token punctuation">-</span>amd64.tar.gz</code></pre><p>è§£å‹</p><pre class=" language-yaml"><code class="language-yaml">tar zxvf mysqld_exporter<span class="token punctuation">-</span>0.12.1.linux<span class="token punctuation">-</span>amd64.tar.gzmv mysqld_exporter<span class="token punctuation">-</span>0.12.1.linux<span class="token punctuation">-</span>amd64 /usr/local/mysql_exportercd /usr/local/mysql_exporter</code></pre><hr><p><strong>2.åœ¨mysqlä¸­åˆ›å»ºexporterç”¨æˆ·å¹¶èµ‹äºˆæƒé™</strong></p><pre class=" language-yaml"><code class="language-yaml">CREATE USER 'exporter'@'localhost' IDENTIFIED BY '123456';  GRANT PROCESS<span class="token punctuation">,</span> REPLICATION CLIENT<span class="token punctuation">,</span> SELECT ON *.* TO 'exporter'@'localhost';flush privileges;</code></pre><hr><p><strong>3.åˆ›å»ºé…ç½®æ–‡ä»¶</strong></p><pre class=" language-yaml"><code class="language-yaml">vim /usr/local/mysql_exporter/.my.cnf<span class="token punctuation">[</span>client<span class="token punctuation">]</span>user=exporterpassword=000000</code></pre><hr><p><strong>4.å¯åŠ¨</strong></p><pre class=" language-yaml"><code class="language-yaml">nohup ./mysqld_exporter <span class="token punctuation">-</span><span class="token punctuation">-</span>config.my<span class="token punctuation">-</span>cnf=.my.cnf &amp;</code></pre><hr><p><strong>5.æµ‹è¯•è®¿é—®ipï¼š9104</strong><br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2077839008.png"></p><hr><p><strong>6.Prometheusæ·»åŠ èŠ‚ç‚¹</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'Mysql'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">'10.7.110.221:9104'</span></code></pre><hr><p><strong>7.Grafanaæ·»åŠ æ¨¡æ¿7362åæŸ¥çœ‹ç›‘æ§</strong></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2547906164.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Operatorç›‘æ§Ingress-nginx</title>
      <link href="/717770d1/"/>
      <url>/717770d1/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€åˆ›å»ºServiceMonitor"><a href="#ä¸€ã€åˆ›å»ºServiceMonitor" class="headerlink" title="ä¸€ã€åˆ›å»ºServiceMonitor"></a>ä¸€ã€åˆ›å»ºServiceMonitor</h1><p>yamlæ–‡ä»¶å¦‚ä¸‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>scraping  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s    <span class="token key atrule">path</span><span class="token punctuation">:</span> /metrics    <span class="token key atrule">port</span><span class="token punctuation">:</span> metrics  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> app  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx</code></pre><p>åˆ›å»ºå¹¶æŸ¥çœ‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@master servicemonitor<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f servicemonitor.yaml</span><span class="token punctuation">[</span>root@master servicemonitor<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get servicemonitor -n ingress-nginx</span>NAME                     AGEnginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>scraping   4h18m</code></pre><h1 id="äºŒã€æŸ¥çœ‹Prometheusæ—¥å¿—"><a href="#äºŒã€æŸ¥çœ‹Prometheusæ—¥å¿—" class="headerlink" title="äºŒã€æŸ¥çœ‹Prometheusæ—¥å¿—"></a>äºŒã€æŸ¥çœ‹Prometheusæ—¥å¿—</h1><pre class=" language-yaml"><code class="language-yaml">level=error ts=2020<span class="token punctuation">-</span>12<span class="token punctuation">-</span>13T09<span class="token punctuation">:</span>52<span class="token punctuation">:</span>35.565Z caller=klog.go<span class="token punctuation">:</span>96 component=k8s_client_runtime func=ErrorDepth msg="/app/discovery/kubernetes/kubernetes.go<span class="token punctuation">:</span><span class="token key atrule">426</span><span class="token punctuation">:</span> Failed to watch <span class="token important">*v1</span>.Endpoints<span class="token punctuation">:</span> failed to list <span class="token important">*v1</span>.Endpoints<span class="token punctuation">:</span> endpoints is forbidden<span class="token punctuation">:</span> User \"system<span class="token punctuation">:</span>serviceaccount<span class="token punctuation">:</span>monitoring<span class="token punctuation">:</span>prometheus<span class="token punctuation">-</span>k8s\" cannot list resource \"endpoints\" in API group \"\" in the namespace \"ingress<span class="token punctuation">-</span>nginx\""</code></pre><p>å¯ä»¥çœ‹åˆ°æ˜¯prometheusæƒé™ä¸è¶³ éœ€è¦ä¿®æ”¹ä¸‹prometheusçš„clusterrole</p><pre class=" language-yaml"><code class="language-yaml">kubectl edit clusterrole prometheus<span class="token punctuation">-</span>k8s</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#rulesçš„å†…å®¹ä¿®æ”¹ä¸ºä»¥ä¸‹å‚æ•°</span><span class="token key atrule">rules</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">""</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> nodes  <span class="token punctuation">-</span> services  <span class="token punctuation">-</span> endpoints  <span class="token punctuation">-</span> pods  <span class="token punctuation">-</span> nodes/proxy  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> get  <span class="token punctuation">-</span> list  <span class="token punctuation">-</span> watch<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">""</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> configmaps  <span class="token punctuation">-</span> nodes/metrics  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> get<span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> /metrics  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> get</code></pre><p>å†æ¬¡æŸ¥çœ‹prometheusä¸Šå·²ç»æ­£å¸¸äº†</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>serviceMonitor/ingress-nginx/nginx-ingress-scraping/0 <span class="token punctuation">(</span>2/2 up<span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre><h1 id="ä¸‰ã€Grafanaæ·»åŠ æ¨¡æ¿"><a href="#ä¸‰ã€Grafanaæ·»åŠ æ¨¡æ¿" class="headerlink" title="ä¸‰ã€Grafanaæ·»åŠ æ¨¡æ¿"></a>ä¸‰ã€Grafanaæ·»åŠ æ¨¡æ¿</h1><p>ingress-nginxæ¨¡æ¿id <code>9614</code></p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1026964335.png"></p><p>æŸ¥çœ‹ç›‘æ§<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/2909168757.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Operator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Operatorç›‘æ§ETCD</title>
      <link href="/a00be237/"/>
      <url>/a00be237/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€é…ç½®etcdè¯ä¹¦åˆ°prometheus"><a href="#ä¸€ã€é…ç½®etcdè¯ä¹¦åˆ°prometheus" class="headerlink" title="ä¸€ã€é…ç½®etcdè¯ä¹¦åˆ°prometheus"></a>ä¸€ã€é…ç½®etcdè¯ä¹¦åˆ°prometheus</h1><p>å¯¹äº etcd é›†ç¾¤ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ºäº†å®‰å…¨éƒ½ä¼šå¼€å¯ https è¯ä¹¦è®¤è¯çš„æ–¹å¼ï¼Œæ‰€ä»¥è¦æƒ³è®© Prometheus è®¿é—®åˆ° etcd é›†ç¾¤çš„ç›‘æ§æ•°æ®ï¼Œå°±éœ€è¦æä¾›ç›¸åº”çš„è¯ä¹¦æ ¡éªŒã€‚è¿™é‡Œé…ç½®çš„æ˜¯kubeadm</p><p>æŸ¥çœ‹è¯ä¹¦æ–‡ä»¶ä½ç½®</p><pre><code>[root@master servicemonitor]# kubectl get pod etcd-master -n kube-system -o yaml......volumeMounts:    - mountPath: /var/lib/etcd      name: etcd-data    - mountPath: /etc/kubernetes/pki/etcd      name: etcd-certs</code></pre><p>å¯ä»¥çœ‹åˆ°etcd-certsæŒ‚è½½è·¯å¾„æ˜¯&#x2F;etc&#x2F;kubernetes&#x2F;pki&#x2F;etcd</p><p>è·å–è¯ä¹¦æ–‡ä»¶åç”Ÿæˆsecret æŒ‚è½½åˆ°pormetheus</p><pre><code>kubectl -n monitoring create secret generic etcd-certs --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.crt --from-file=/etc/kubernetes/pki/etcd/healthcheck-client.key --from-file=/etc/kubernetes/pki/etcd/ca.crt</code></pre><h1 id="äºŒã€é…ç½®prometheus"><a href="#äºŒã€é…ç½®prometheus" class="headerlink" title="äºŒã€é…ç½®prometheus"></a>äºŒã€é…ç½®prometheus</h1><pre><code>[root@master servicemonitor]# kubectl -n monitoring edit prometheus k8s#specæ·»åŠ ä¸‹é¢å­—æ®µspec......  secrets:  - etcd-certs#ä¿å­˜é€€å‡º è¿›å…¥prometheusç¡®è®¤è¯ä¹¦æ˜¯å¦é…ç½®æˆåŠŸ[root@master servicemonitor]# kubectl -n monitoring exec -it prometheus-k8s-0 -c prometheus  -- sh/prometheus $ ls /etc/prometheus/secrets/etcd-certs/ca.crt                  healthcheck-client.crt  healthcheck-client.key#è¯ä¹¦å·²ç»é…ç½®æˆåŠŸ</code></pre><h1 id="ä¸‰ã€åˆ›å»ºServiceMonitor"><a href="#ä¸‰ã€åˆ›å»ºServiceMonitor" class="headerlink" title="ä¸‰ã€åˆ›å»ºServiceMonitor"></a>ä¸‰ã€åˆ›å»ºServiceMonitor</h1><p>ServiceMonitor</p><pre><code>apiVersion: monitoring.coreos.com/v1kind: ServiceMonitormetadata:  name: etcd-k8s  namespace: monitoring  labels:    k8s-app: etcd-k8sspec:  jobLabel: k8s-app  endpoints:  - port: port    interval: 30s    scheme: https    tlsConfig:      caFile: /etc/prometheus/secrets/etcd-certs/ca.crt      certFile: /etc/prometheus/secrets/etcd-certs/healthcheck-client.crt      keyFile: /etc/prometheus/secrets/etcd-certs/healthcheck-client.key      insecureSkipVerify: true  selector:    matchLabels:      k8s-app: etcd  namespaceSelector:    matchNames:    - kube-system</code></pre><p>server</p><pre><code>apiVersion: v1kind: Servicemetadata:  name: etcd-k8s  namespace: kube-system  labels:    k8s-app: etcdspec:  type: ClusterIP  clusterIP: None  ports:  - name: port    port: 2379    protocol: TCP---apiVersion: v1kind: Endpointsmetadata:  name: etcd-k8s  namespace: kube-system  labels:    k8s-app: etcdsubsets:- addresses:  - ip: 10.46.8.18    nodeName: etcd-master  ports:  - name: port    port: 2379    protocol: TCP</code></pre><p>apply</p><pre><code>[root@master servicemonitor]# kubectl apply -f etcd_servicemonitor.yaml[root@master servicemonitor]# kubectl apply -f etcdService.yaml</code></pre><p>å¯ä»¥æŸ¥çœ‹prometheusä¸­ç›‘æ§å·²ç»æœ‰äº† <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1569924190.png"></p><p>grafanaæ·»åŠ ç›‘æ§ æ¨¡æ¿3070 æ•ˆæœå¦‚ä¸‹ <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1217887458.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Operator </tag>
            
            <tag> ETCD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxéƒ¨ç½²process_exporterç›‘æ§è¿›ç¨‹æƒ…å†µ</title>
      <link href="/7f800f4/"/>
      <url>/7f800f4/</url>
      
        <content type="html"><![CDATA[<p><strong>1.ç®€ä»‹</strong> process-exporterä¸»è¦ç”¨æ¥åšè¿›ç¨‹ç›‘æ§ï¼Œæ¯”å¦‚æŸä¸ªæœåŠ¡çš„è¿›ç¨‹æ•°ã€æ¶ˆè€—äº†å¤šå°‘CPUã€å†…å­˜ã€IOèµ„æºç­‰</p><p><strong>2.å®‰è£…é…ç½®</strong></p><pre><code>wget http://github.com/ncabatoff/process-exporter/releases/download/v0.7.2/process-exporter-0.7.2.linux-amd64.tar.gztar -xvf process-exporter-0.7.2.linux-amd64.tar.gz  -C /usr/local/cd /usr/local/ln -s process-exporter-0.7.2.linux-amd64 process_exportercd process_exporter/ln -s process-exporter process_exportermkdir logs</code></pre><p><strong>3.æ·»åŠ éœ€è¦ç›‘æ§çš„è¿›ç¨‹é…ç½®ï¼ˆéœ€è¦è‡ªå·±åˆ›å»ºï¼‰</strong> é…ç½®æ–‡ä»¶è·¯å¾„<code>/usr/local/process_exporter/config.yaml</code></p><pre><code>process_names:  - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot;    cmdline:    - &#39;elasticsearch&#39;  - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot;    cmdline:    - &#39;logstash&#39;  - name: &quot;&#123;&#123;.Matches&#125;&#125;&quot;    cmdline:    - &#39;kibana&#39;</code></pre><p><strong>4.å¯åŠ¨</strong></p><pre><code>nohup ./process-exporter  -config.path=&quot;config.yaml&quot;  -web.listen-address=&quot;:9256&quot;&gt;&gt; logs/process-exporter.log 2&gt;&amp;1 &amp;#-config.path æŒ‡å®šè¿›ç¨‹é…ç½®æ–‡ä»¶#-web.listen-address æŒ‡å®šç›‘å¬ç«¯å£</code></pre><p><strong>5.prometheusæ·»åŠ å¯¹åº”é…ç½®</strong></p><pre><code>- job_name: &#39;process&#39;    static_configs:      - targets: [&#39;106.75.x.x:9256&#39;]</code></pre><p><strong>6.grafanaæ·»åŠ å¯¹åº”æ¨¡æ¿</strong> <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/3998995538.png"> æœ€ç»ˆå±•ç¤º <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2866754558.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxéƒ¨ç½²Alertmanagerå¯¹prometheusç›‘æ§è¿›è¡Œå‘Šè­¦</title>
      <link href="/e5fe49d2/"/>
      <url>/e5fe49d2/</url>
      
        <content type="html"><![CDATA[<p><strong>1.ç®€ä»‹</strong><br>Prometheuså‘å‡ºå‘Šè­¦æ—¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ã€‚é¦–å…ˆï¼ŒPrometheusæŒ‰å‘Šè­¦è§„åˆ™(rule_filesé…ç½®å—)å‘Alertmanagerå‘é€å‘Šè­¦ï¼ˆå³å‘Šè­¦è§„åˆ™æ˜¯åœ¨Prometheusä¸Šå®šä¹‰çš„ï¼‰ã€‚ç„¶åï¼Œç”±Alertmanageræ¥ç®¡ç†è¿™äº›å‘Šè­¦ï¼ŒåŒ…æ‹¬å»é‡(Deduplicating)ã€åˆ†ç»„(Grouping)ã€é™éŸ³(silencing)ã€æŠ‘åˆ¶(inhibition)ã€èšåˆ(aggregation )ï¼Œæœ€ç»ˆå°†é¢è¦å‘å‡ºçš„å‘Šè­¦é€šè¿‡ç”µå­é‚®ä»¶ã€webhookç­‰æ–¹å¼å°†å‘Šè­¦é€šçŸ¥è·¯ç”±(route)ç»™å¯¹åº”çš„è”ç³»äºº</p><hr><p><strong>2.å®‰è£…Alertmanager</strong></p><pre class=" language-yaml"><code class="language-yaml">wget http<span class="token punctuation">:</span>//github.com/prometheus/alertmanager/releases/download/v0.20.0/alertmanager<span class="token punctuation">-</span>0.20.0.linux<span class="token punctuation">-</span>amd64.tar.gztar <span class="token punctuation">-</span>xvf alertmanager<span class="token punctuation">-</span>0.20.0.linux<span class="token punctuation">-</span>amd64.tar.gz mv alertmanager<span class="token punctuation">-</span>0.20.0.linux<span class="token punctuation">-</span>amd64 /usr/local/alertmanager</code></pre><hr><p><strong>3.ç¼–è¾‘é…ç½®æ–‡ä»¶</strong><br>é…ç½®æ–‡ä»¶è·¯å¾„<code>/usr/local/alertmanager/alertmanager.yml</code></p><p>é…ç½®å¦‚ä¸‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">global</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true">#å…¨å±€é…ç½®</span>  <span class="token key atrule">resolve_timeout</span><span class="token punctuation">:</span> 5m    <span class="token key atrule">smtp_smarthost</span><span class="token punctuation">:</span> <span class="token string">'smtp.163.com:465'</span>  <span class="token comment" spellcheck="true">#smtpæœåŠ¡å™¨çš„åœ°å€ æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯163çš„</span>  <span class="token key atrule">smtp_from</span><span class="token punctuation">:</span> <span class="token string">'liyonghui_1997@163.com'</span>  <span class="token comment" spellcheck="true">#å‘é€é‚®ä»¶ä½¿ç”¨çš„é‚®ç®±</span>  <span class="token key atrule">smtp_auth_username</span><span class="token punctuation">:</span> <span class="token string">'liyonghui_1997@163.com'</span> <span class="token comment" spellcheck="true">#ç”¨äºå‘é€é‚®ä»¶æ—¶ç™»å½•é‚®ç®±æœåŠ¡å™¨çš„é‚®ç®±åœ°å€</span>  <span class="token key atrule">smtp_auth_password</span><span class="token punctuation">:</span> <span class="token string">'DRHMxxxxxxxxx'</span> <span class="token comment" spellcheck="true">#é‚®ç®±æˆæƒç  å¯ä»¥åœ¨163çš„é‚®ç®±è®¾ç½®ä¸­è·å–</span>  <span class="token key atrule">smtp_require_tls</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">templates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">'/usr/local/alertmanager/template/default.tmpl'</span> <span class="token comment" spellcheck="true">#å‘é€é‚®ä»¶çš„æ¨¡æ¿ ä¸éœ€è¦çš„è¯å¯ä»¥ä¸é…ç½®çš„ ä½†æ˜¯Alertmanageré»˜è®¤æ¨¡æ¿å‘Šè­¦é¡¹ä¸ç›´è§‚ ä¸”æ—¶é—´æ˜¯UTCæ—¶é—´æŸ¥çœ‹ä¸æ–¹ä¾¿</span><span class="token key atrule">route</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#é»˜è®¤è·¯ç”±è§„åˆ™</span>  <span class="token key atrule">group_by</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">]</span>  <span class="token key atrule">group_wait</span><span class="token punctuation">:</span> 30s  <span class="token comment" spellcheck="true">#ç»„ç­‰å¾…åŒç»„å‘Šè­¦é»˜è®¤ç­‰å¾…30s</span>  <span class="token key atrule">group_interval</span><span class="token punctuation">:</span> 1m  <span class="token comment" spellcheck="true">#å½“ä¸€ä¸ªæ–°çš„å‘Šè­¦ç»„è¢«åˆ›å»ºæ—¶ï¼Œéœ€è¦ç­‰å¾…'group_wait'åæ‰å‘é€åˆå§‹é€šçŸ¥ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨å‘é€ç­‰å¾…å‰èƒ½èšåˆæ›´å¤šå…·æœ‰ç›¸åŒæ ‡ç­¾çš„å‘Šè­¦ï¼Œæœ€ååˆå¹¶ä¸ºä¸€ä¸ªé€šçŸ¥å‘é€</span>  <span class="token key atrule">repeat_interval</span><span class="token punctuation">:</span> 5m <span class="token comment" spellcheck="true">#å‘Šè­¦å‘é€é—´éš”æ—¶é—´</span>  <span class="token key atrule">receiver</span><span class="token punctuation">:</span> <span class="token string">'mail'</span><span class="token key atrule">receivers</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'mail'</span> <span class="token comment" spellcheck="true">#å‘é€æ–¹å¼</span>  <span class="token key atrule">email_configs</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#æ¥å—æ–¹çš„é‚®ç®±</span>  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">'www.2668416023@foxmail.com'</span>    <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true  </span><span class="token comment" spellcheck="true">#æ˜¯å¦å‘é€æ¢å¤å‘Šè­¦</span>    <span class="token key atrule">html</span><span class="token punctuation">:</span> <span class="token string">'{{ template "default.html" . }}'</span>  <span class="token comment" spellcheck="true">#æ¨¡æ¿çš„é…ç½®è§„åˆ™ å¦‚æœä¸æƒ³é…ç½®çš„è¿™é‡Œå¯ä»¥å¿½ç•¥</span>    <span class="token key atrule">headers</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token key atrule">Subject</span><span class="token punctuation">:</span> <span class="token string">"{{ .GroupLabels.SortedPairs.Values }} [{{ .Status | toUpper }}:{{ .Alerts.Firing | len }}]"</span> <span class="token punctuation">}</span>  <span class="token key atrule">inhibit_rules</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#å‘Šè­¦æŠ‘åˆ¶è§„åˆ™</span>  <span class="token punctuation">-</span> <span class="token key atrule">source_match</span><span class="token punctuation">:</span>      <span class="token key atrule">severity</span><span class="token punctuation">:</span> <span class="token string">'critical'</span>    <span class="token key atrule">target_match</span><span class="token punctuation">:</span>      <span class="token key atrule">severity</span><span class="token punctuation">:</span> <span class="token string">'warning'</span>    <span class="token key atrule">equal</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'alertname'</span><span class="token punctuation">,</span> <span class="token string">'dev'</span><span class="token punctuation">,</span> <span class="token string">'instance'</span><span class="token punctuation">]</span></code></pre><p>æ¨¡æ¿é…ç½®<br>è·¯å¾„<code>/usr/local/alertmanager/template/default.tmpl</code></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">{</span><span class="token punctuation">{</span> define "default.html" <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> if gt (len .Alerts.Firing) 0 <span class="token punctuation">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .Status <span class="token punctuation">|</span> toUpper <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .Alerts.Firing <span class="token punctuation">|</span> len <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">{</span> range $i<span class="token punctuation">,</span> $alert <span class="token punctuation">:</span>= .Alerts <span class="token punctuation">}</span><span class="token punctuation">}</span>&lt;pre<span class="token punctuation">></span>å‘Šè­¦èŠ‚ç‚¹ï¼š<span class="token punctuation">{</span><span class="token punctuation">{</span> index $alert.Labels "instance" <span class="token punctuation">}</span><span class="token punctuation">}</span>å‘Šè­¦æœåŠ¡ï¼š<span class="token punctuation">{</span><span class="token punctuation">{</span> index $alert.Labels "alertname" <span class="token punctuation">}</span><span class="token punctuation">}</span>æŠ¥è­¦è¯¦æƒ…ï¼š<span class="token punctuation">{</span><span class="token punctuation">{</span> index $alert.Annotations "summary" <span class="token punctuation">}</span><span class="token punctuation">}</span>å¼€å§‹æ—¶é—´ï¼š<span class="token punctuation">{</span><span class="token punctuation">{</span> $alert.StartsAt.Local <span class="token punctuation">}</span><span class="token punctuation">}</span>&lt;/pre<span class="token punctuation">></span><span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> if gt (len .Alerts.Resolved) 0 <span class="token punctuation">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .Status <span class="token punctuation">|</span> toUpper <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token punctuation">{</span> .Alerts.Resolved <span class="token punctuation">|</span> len <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">{</span> range $i<span class="token punctuation">,</span> $alert <span class="token punctuation">:</span>= .Alerts <span class="token punctuation">}</span><span class="token punctuation">}</span>&lt;pre<span class="token punctuation">></span>æ¢å¤èŠ‚ç‚¹ï¼š<span class="token punctuation">{</span><span class="token punctuation">{</span> index $alert.Labels "instance" <span class="token punctuation">}</span><span class="token punctuation">}</span>æ¢å¤æœåŠ¡ï¼š<span class="token punctuation">{</span><span class="token punctuation">{</span> index $alert.Labels "alertname" <span class="token punctuation">}</span><span class="token punctuation">}</span>çŠ¶ <span class="token punctuation">?</span> <span class="token punctuation">?</span>æ€ï¼š<span class="token punctuation">{</span><span class="token punctuation">{</span> index $alert.Status <span class="token punctuation">}</span><span class="token punctuation">}</span>å¼€å§‹æ—¶é—´ï¼š<span class="token punctuation">{</span><span class="token punctuation">{</span> $alert.StartsAt.Local <span class="token punctuation">}</span><span class="token punctuation">}</span>æ¢å¤æ—¶é—´ï¼š<span class="token punctuation">{</span><span class="token punctuation">{</span> $alert.EndsAt.Local <span class="token punctuation">}</span><span class="token punctuation">}</span>&lt;/pre<span class="token punctuation">></span><span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>é…ç½®å®Œæˆåå¯ä»¥ä½¿ç”¨è‡ªå¸¦çš„å·¥å…·æ£€æŸ¥ä¸‹æ ¼å¼</p><pre class=" language-yaml"><code class="language-yaml">./amtool check<span class="token punctuation">-</span>config alertmanager.ymlChecking 'alertmanager.yml'  SUCCESS<span class="token key atrule">Found</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> global config <span class="token punctuation">-</span> route <span class="token punctuation">-</span> 1 inhibit rules <span class="token punctuation">-</span> 1 receivers <span class="token punctuation">-</span> 1 templates  SUCCESS</code></pre><hr><p><strong>4.å¯åŠ¨</strong><br>æˆ‘æ˜¯ä½¿ç”¨çš„nohupå¯åŠ¨çš„ ä¹Ÿå¯ä»¥ä½¿ç”¨systemctlæ¥å¯åŠ¨</p><pre class=" language-yaml"><code class="language-yaml">nohup /usr/local/alertmanager/alertmanager <span class="token punctuation">-</span><span class="token punctuation">-</span>config.file=/usr/local/alertmanager/alertmanager.yml <span class="token punctuation">-</span><span class="token punctuation">-</span>storage.path=/usr/local/alertmanager/data <span class="token punctuation">-</span><span class="token punctuation">-</span>web.listen<span class="token punctuation">-</span>address=0.0.0.0<span class="token punctuation">:</span>9093 <span class="token punctuation">-</span><span class="token punctuation">-</span>data.retention=120h<span class="token punctuation">></span><span class="token punctuation">></span> /usr/local/alertmanager/logs/alertmanager.log 2<span class="token punctuation">></span><span class="token important">&amp;1</span> &amp;</code></pre><p>æŸ¥çœ‹è¿›ç¨‹æ˜¯å¦æ­£å¸¸è¿è¡Œ</p><pre class=" language-yaml"><code class="language-yaml">ps <span class="token punctuation">-</span>ef <span class="token punctuation">|</span> grep alerroot     16687 30885  0 15<span class="token punctuation">:</span>08 pts/1    00<span class="token punctuation">:</span>00<span class="token punctuation">:</span>00 grep <span class="token punctuation">-</span><span class="token punctuation">-</span>color=auto alerroot     30680     1  0 13<span class="token punctuation">:</span>16 <span class="token punctuation">?</span>        00<span class="token punctuation">:</span>00<span class="token punctuation">:</span>05 /usr/local/alertmanager/alertmanager <span class="token punctuation">-</span><span class="token punctuation">-</span>config.file=/usr/local/alertmanager/alertmanager.yml <span class="token punctuation">-</span><span class="token punctuation">-</span>storage.path=/usr/local/alertmanager/data <span class="token punctuation">-</span><span class="token punctuation">-</span>web.listen<span class="token punctuation">-</span>address=0.0.0.0<span class="token punctuation">:</span>9093 <span class="token punctuation">-</span><span class="token punctuation">-</span>data.retention=120h</code></pre><hr><p><strong>5.prometheusæ·»åŠ é…ç½®</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">alerting</span><span class="token punctuation">:</span>  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token string">'118.193.x.x:9093'</span> <span class="token comment" spellcheck="true">#AlertmanagerèŠ‚ç‚¹</span><span class="token comment" spellcheck="true"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span><span class="token key atrule">rule_files</span><span class="token punctuation">:</span>   <span class="token punctuation">-</span> <span class="token string">"rules/*_rules.yml"</span>   <span class="token comment" spellcheck="true">#å‘Šè­¦è§„åˆ™é…ç½®æ–‡ä»¶</span>   <span class="token punctuation">-</span> <span class="token string">"rules/*_alerts.yml"</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'alertmanager'</span>    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'118.193.37.64:9093'</span><span class="token punctuation">]</span></code></pre><p>é‡è½½é…ç½®</p><pre class=" language-yaml"><code class="language-yaml">kill <span class="token punctuation">-</span>HUP 18892</code></pre><p>é…ç½®æ²¡é—®é¢˜çš„è¯ å°±å¯ä»¥åœ¨prometheusç•Œé¢çœ‹åˆ°Alertmanager<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/939254483.jpg"></p><hr><p><strong>6.é…ç½®å‘Šè­¦è§„åˆ™</strong><br>åˆ†ä¸ºä¸¤ä¸ªæ–‡ä»¶ï¼š<br><code>node_alerts.yml</code>è¿™ä¸ªä¸»è¦é…ç½®å‘Šè­¦çš„é˜ˆå€¼å’Œå‘é€çš„æ–‡æœ¬<br><code>node_rules.yml</code>ä¸»è¦é…ç½®å‘Šè­¦çš„è§„åˆ™</p><p>é…ç½®å¦‚ä¸‹<br><code>node_rules.yml</code></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> node_rules    <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_cpu_usage      <span class="token key atrule">expr</span><span class="token punctuation">:</span> 100 <span class="token punctuation">-</span> avg(irate(node_cpu_seconds_total<span class="token punctuation">{</span>mode="idle"<span class="token punctuation">}</span><span class="token punctuation">[</span>1m<span class="token punctuation">]</span>)) by (instance) * 100      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_type</span><span class="token punctuation">:</span> CPU_monitor    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_1m_load      <span class="token key atrule">expr</span><span class="token punctuation">:</span> node_load1      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_yepe</span><span class="token punctuation">:</span> load1m_monitor    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_mem_usage      <span class="token key atrule">expr</span><span class="token punctuation">:</span> 100 <span class="token punctuation">-</span> (node_memory_MemAvailable_bytes)/(node_memory_MemTotal_bytes) * 100      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_type</span><span class="token punctuation">:</span> Memory_monitor    <span class="token punctuation">-</span> <span class="token key atrule">record</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_root_partition_predit      <span class="token key atrule">expr</span><span class="token punctuation">:</span> node_filesystem_free_bytes<span class="token punctuation">{</span>device="/dev/vda1"<span class="token punctuation">,</span> mountpoint="/"<span class="token punctuation">}</span>/(1024<span class="token important">*1024</span><span class="token important">*1024</span>)      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">metric_type</span><span class="token punctuation">:</span> root_partition_monitor</code></pre><p><code>node_alerts.yml</code></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> node_alerts    <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> CPUä½¿ç”¨ç‡      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_cpu_usage <span class="token punctuation">></span> 80      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> ä¸»æœº <span class="token punctuation">{</span><span class="token punctuation">{</span> $labels.instance <span class="token punctuation">}</span><span class="token punctuation">}</span> çš„ CPUä½¿ç”¨ç‡æŒç»­1åˆ†é’Ÿè¶…å‡ºé˜ˆå€¼<span class="token punctuation">,</span>å½“å‰ä¸º <span class="token punctuation">{</span><span class="token punctuation">{</span>humanize $value<span class="token punctuation">}</span><span class="token punctuation">}</span> %        <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> ç³»ç»Ÿä¸€åˆ†é’Ÿè´Ÿè½½      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_1m_load <span class="token punctuation">></span> 20      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">severity</span><span class="token punctuation">:</span> warning      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> ä¸»æœº <span class="token punctuation">{</span><span class="token punctuation">{</span> $labels.instance <span class="token punctuation">}</span><span class="token punctuation">}</span> çš„ 1åˆ†è´Ÿè½½è¶…å‡ºé˜ˆå€¼<span class="token punctuation">,</span>å½“å‰ä¸º <span class="token punctuation">{</span><span class="token punctuation">{</span>humanize $value<span class="token punctuation">}</span><span class="token punctuation">}</span>        <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> å†…å­˜ä½¿ç”¨ç‡      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_mem_usage <span class="token punctuation">></span> 80      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> ä¸»æœº <span class="token punctuation">{</span><span class="token punctuation">{</span> $labels.instance <span class="token punctuation">}</span><span class="token punctuation">}</span> çš„ å†…å­˜ ä½¿ç”¨ç‡æŒç»­1åˆ†é’Ÿè¶…å‡ºé˜ˆå€¼<span class="token punctuation">,</span>å½“å‰ä¸º <span class="token punctuation">{</span><span class="token punctuation">{</span>humanize $value<span class="token punctuation">}</span><span class="token punctuation">}</span> %        <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> ç³»ç»Ÿç›˜ç£ç›˜ä½¿ç”¨      <span class="token key atrule">expr</span><span class="token punctuation">:</span> instance<span class="token punctuation">:</span>node_root_partition_predit &lt; 10      <span class="token key atrule">for</span><span class="token punctuation">:</span> 1m      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">summary</span><span class="token punctuation">:</span> ä¸»æœº <span class="token punctuation">{</span><span class="token punctuation">{</span> $labels.instance <span class="token punctuation">}</span><span class="token punctuation">}</span> çš„ æ ¹åˆ†åŒº å‰©ä½™å¯ç”¨ç©ºé—´åªæœ‰ <span class="token punctuation">{</span><span class="token punctuation">{</span>humanize $value<span class="token punctuation">}</span><span class="token punctuation">}</span>GB<span class="token punctuation">,</span>ï¼Œè¯·åŠæ—¶æ‰©å®¹å’Œæ¸…ç†ç©ºé—´<span class="token tag">!!!!!</span></code></pre><p>é…ç½®å®Œæˆé‡è½½<code>kill -HUP 18892</code></p><p>è®¿é—®prometheusç•Œé¢å³å¯æŸ¥çœ‹é…ç½®çš„è§„åˆ™<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/1841199424.jpg"><br>å‘Šè­¦çš„çŠ¶æ€<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/3354612842.jpg"></p><hr><p><strong>7.æµ‹è¯•</strong><br>å‹æµ‹cpuçœ‹ä¸‹æ˜¯å¦å¯ä»¥æ­£å¸¸æ”¶åˆ°å‘Šè­¦</p><p><code>stress -c 2 -t 100000</code></p><p>prometheusæŸ¥çœ‹å‘Šè­¦è§„åˆ™å·²ç»å˜ä¸ºpendingçŠ¶æ€ è¯æ˜å·²ç»æ£€æµ‹åˆ°è¿™ä¸ªå‘Šè­¦<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/1183408278.jpg"><br>æ ¹æ®é…ç½®ä¸€åˆ†é’Ÿä¼šå¦‚æœæ²¡æœ‰æ¢å¤ä¼šå˜ä¸ºfiringçŠ¶æ€<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2775594136.jpg"><br>ç¨ç­‰ä¸‰åç§’å³å¯æ”¶åˆ°å‘Šè­¦<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2705797334.jpg"><br>å–æ¶ˆå‹æµ‹ç¨åä¼šæ”¶åˆ°æ¢å¤å‘Šè­¦<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/08/2428281774.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Prometheus </tag>
            
            <tag> Alertmanager </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s Operateréƒ¨ç½²prometheus</title>
      <link href="/1fd45d82/"/>
      <url>/1fd45d82/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h1><h3 id="1-1-Prometheus-Operatorå·¥ä½œåŸç†"><a href="#1-1-Prometheus-Operatorå·¥ä½œåŸç†" class="headerlink" title="1.1 Prometheus Operatorå·¥ä½œåŸç†"></a>1.1 Prometheus Operatorå·¥ä½œåŸç†</h3><p>ä»æ¦‚å¿µä¸Šæ¥è®²Operatorå°±æ˜¯é’ˆå¯¹ç®¡ç†ç‰¹å®šåº”ç”¨ç¨‹åºçš„ï¼Œåœ¨KubernetesåŸºæœ¬çš„Resourceå’ŒControllerçš„æ¦‚å¿µä¸Šï¼Œä»¥æ‰©å±•Kubernetes apiçš„å½¢å¼ã€‚å¸®åŠ©ç”¨æˆ·åˆ›å»ºï¼Œé…ç½®å’Œç®¡ç†å¤æ‚çš„æœ‰çŠ¶æ€åº”ç”¨ç¨‹åºã€‚ä»è€Œå®ç°ç‰¹å®šåº”ç”¨ç¨‹åºçš„å¸¸è§æ“ä½œä»¥åŠè¿ç»´è‡ªåŠ¨åŒ–ã€‚</p><p>åœ¨Kubernetesä¸­æˆ‘ä»¬ä½¿ç”¨Deploymentã€DamenSetï¼ŒStatefulSetæ¥ç®¡ç†åº”ç”¨Workloadï¼Œä½¿ç”¨Serviceï¼ŒIngressæ¥ç®¡ç†åº”ç”¨çš„è®¿é—®æ–¹å¼ï¼Œä½¿ç”¨ConfigMapå’ŒSecretæ¥ç®¡ç†åº”ç”¨é…ç½®ã€‚æˆ‘ä»¬åœ¨é›†ç¾¤ä¸­å¯¹è¿™äº›èµ„æºçš„åˆ›å»ºï¼Œæ›´æ–°ï¼Œåˆ é™¤çš„åŠ¨ä½œéƒ½ä¼šè¢«è½¬æ¢ä¸ºäº‹ä»¶(Event)ï¼ŒKubernetesçš„Controller Managerè´Ÿè´£ç›‘å¬è¿™äº›äº‹ä»¶å¹¶è§¦å‘ç›¸åº”çš„ä»»åŠ¡æ¥æ»¡è¶³ç”¨æˆ·çš„æœŸæœ›ã€‚è¿™ç§æ–¹å¼æˆ‘ä»¬æˆä¸ºå£°æ˜å¼ï¼Œç”¨æˆ·åªéœ€è¦å…³å¿ƒåº”ç”¨ç¨‹åºçš„æœ€ç»ˆçŠ¶æ€ï¼Œå…¶å®ƒçš„éƒ½é€šè¿‡Kubernetesæ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆï¼Œé€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å¤§å¤§ç®€åŒ–åº”ç”¨çš„é…ç½®ç®¡ç†å¤æ‚åº¦ã€‚</p><p>è€Œé™¤äº†è¿™äº›åŸç”Ÿçš„Resourceèµ„æºä»¥å¤–ï¼ŒKubernetesè¿˜å…è®¸ç”¨æˆ·æ·»åŠ è‡ªå·±çš„è‡ªå®šä¹‰èµ„æº(Custom Resource)ã€‚å¹¶ä¸”é€šè¿‡å®ç°è‡ªå®šä¹‰Controlleræ¥å®ç°å¯¹Kubernetesçš„æ‰©å±•ã€‚</p><p>å¦‚ä¸‹æ‰€ç¤ºï¼Œæ˜¯Prometheus Operatorçš„æ¶æ„ç¤ºæ„å›¾ï¼š<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/814160233.png"><br>Prometheusçš„æœ¬è´¨å°±æ˜¯ä¸€ç»„ç”¨æˆ·è‡ªå®šä¹‰çš„CRDèµ„æºä»¥åŠControllerçš„å®ç°ï¼ŒPrometheus Operatorè´Ÿè´£ç›‘å¬è¿™äº›è‡ªå®šä¹‰èµ„æºçš„å˜åŒ–ï¼Œå¹¶ä¸”æ ¹æ®è¿™äº›èµ„æºçš„å®šä¹‰è‡ªåŠ¨åŒ–åœ°å®Œæˆå¦‚Prometheus Serverè‡ªèº«ä»¥åŠé…ç½®çš„è‡ªåŠ¨åŒ–ç®¡ç†å·¥ä½œã€‚</p><h3 id="1-2-Prometheus-Operatorä½œç”¨"><a href="#1-2-Prometheus-Operatorä½œç”¨" class="headerlink" title="1.2 Prometheus Operatorä½œç”¨"></a>1.2 Prometheus Operatorä½œç”¨</h3><p>è¦äº†è§£Prometheus Operatorèƒ½åšä»€ä¹ˆï¼Œå…¶å®å°±æ˜¯è¦äº†è§£Prometheus Operatorä¸ºæˆ‘ä»¬æä¾›äº†å“ªäº›è‡ªå®šä¹‰çš„Kubernetesèµ„æºï¼Œåˆ—å‡ºäº†Prometheus Operatorç›®å‰æä¾›çš„ï¸4ç±»èµ„æºï¼š</p><ul><li>Prometheusï¼šå£°æ˜å¼åˆ›å»ºå’Œç®¡ç†Prometheus Serverå®ä¾‹ï¼›</li><li>ServiceMonitorï¼šè´Ÿè´£å£°æ˜å¼çš„ç®¡ç†ç›‘æ§é…ç½®ï¼›</li><li>PrometheusRuleï¼šè´Ÿè´£å£°æ˜å¼çš„ç®¡ç†å‘Šè­¦é…ç½®ï¼›</li><li>Alertmanagerï¼šå£°æ˜å¼çš„åˆ›å»ºå’Œç®¡ç†Alertmanagerå®ä¾‹ã€‚</li></ul><p>ç®€è¨€ä¹‹ï¼ŒPrometheus Operatorèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·è‡ªåŠ¨åŒ–çš„åˆ›å»ºä»¥åŠç®¡ç†Prometheus Serverä»¥åŠå…¶ç›¸åº”çš„é…ç½®ã€‚</p><h1 id="äºŒã€å®æˆ˜é…ç½®"><a href="#äºŒã€å®æˆ˜é…ç½®" class="headerlink" title="äºŒã€å®æˆ˜é…ç½®"></a>äºŒã€å®æˆ˜é…ç½®</h1><h3 id="2-1éƒ¨ç½²Prometheus-Operator"><a href="#2-1éƒ¨ç½²Prometheus-Operator" class="headerlink" title="2.1éƒ¨ç½²Prometheus Operator"></a>2.1éƒ¨ç½²Prometheus Operator</h3><pre class=" language-docker"><code class="language-docker"><span class="token comment" spellcheck="true">#githubé¡¹ç›®åœ°å€ï¼Œç›´æ¥ä½¿ç”¨gitæ‹‰ä¸‹æ¥å³å¯</span>https<span class="token punctuation">:</span>//github.com/prometheus<span class="token punctuation">-</span>operator/kube<span class="token punctuation">-</span>prometheus<span class="token punctuation">[</span>root@k8smaster ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#git clone https://github.com/prometheus-operator/kube-prometheus</span><span class="token comment" spellcheck="true">#ä¸»è¦ä½¿ç”¨é¡¹ç›®ç›®å½•ä¸º`manifests`</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># pwd</span>/root/kube<span class="token punctuation">-</span>prometheus/manifests<span class="token comment" spellcheck="true">#å¼€å§‹åˆ›å»ºæ‰€æœ‰æœåŠ¡</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span>kubectl create <span class="token punctuation">-</span>f ./setup<span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span>kubectl create <span class="token punctuation">-</span>f .<span class="token comment" spellcheck="true">#éƒ¨ç½²å®Œæˆç¡®è®¤</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring get all</span>NAME                                       READY   STATUS    RESTARTS   AGEpod/alertmanager<span class="token punctuation">-</span>main<span class="token punctuation">-</span>0                    2/2     Running   0          13dpod/alertmanager<span class="token punctuation">-</span>main<span class="token punctuation">-</span>1                    2/2     Running   0          13dpod/alertmanager<span class="token punctuation">-</span>main<span class="token punctuation">-</span>2                    2/2     Running   0          13dpod/blackbox<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>6798fb5bb4<span class="token punctuation">-</span>64knd     3/3     Running   0          13dpod/grafana<span class="token punctuation">-</span>77f997786c<span class="token punctuation">-</span>4gbrh               1/1     Running   0          3h58mpod/kube<span class="token punctuation">-</span>state<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>bdb774b4d<span class="token punctuation">-</span>mkrvk     3/3     Running   0          13dpod/node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>hn54g                    2/2     Running   0          13dpod/node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>jjxmr                    2/2     Running   0          13dpod/node<span class="token punctuation">-</span>exporter<span class="token punctuation">-</span>qnppx                    2/2     Running   0          13dpod/prometheus<span class="token punctuation">-</span>adapter<span class="token punctuation">-</span>5b8db7955f<span class="token punctuation">-</span>6s97n    1/1     Running   0          13dpod/prometheus<span class="token punctuation">-</span>adapter<span class="token punctuation">-</span>5b8db7955f<span class="token punctuation">-</span>bp9bb    1/1     Running   0          13dpod/prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0                       2/2     Running   0          5h20mpod/prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>1                       2/2     Running   0          5h20mpod/prometheus<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>5685494db7<span class="token punctuation">-</span>tphkp   2/2     Running   0          13d<span class="token punctuation">...</span><span class="token punctuation">...</span>.</code></pre><h3 id="2-2-webç•Œé¢æŸ¥çœ‹"><a href="#2-2-webç•Œé¢æŸ¥çœ‹" class="headerlink" title="2.2 webç•Œé¢æŸ¥çœ‹"></a>2.2 webç•Œé¢æŸ¥çœ‹</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#é€šè¿‡æŸ¥çœ‹serverç«¯å£è®¿é—®webç•Œé¢</span><span class="token punctuation">[</span>root@k8smaster manifests<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get svc -n monitoring</span>NAME                    TYPE        CLUSTER<span class="token punctuation">-</span>IP       EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)prometheus<span class="token punctuation">-</span>k8s          NodePort    10.107.194.41    &lt;none<span class="token punctuation">></span>        9090<span class="token punctuation">:</span>32523/TC</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/586635708.png"></p><blockquote><p>æ‰€æœ‰ç›‘æ§éƒ½æ­£å¸¸å³å¯æ‰“å¼€grafanaæŸ¥çœ‹æœåŠ¡è‡ªå¸¦çš„ç›‘æ§é¢æ¿</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/1635828218.png"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Prometheus </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockeréƒ¨ç½²cadvisorç›‘æ§å®¹å™¨</title>
      <link href="/985781f7/"/>
      <url>/985781f7/</url>
      
        <content type="html"><![CDATA[<p><strong>1.æœåŠ¡å™¨ç›´æ¥dockerå¯åŠ¨cadvisorå®¹å™¨</strong></p><pre><code>docker run -d --volume=/:/rootfs:ro --volume=/var/run:/var/run:ro --volume=/sys:/sys:ro --volume=/var/lib/docker/:/var/lib/docker:ro --volume=/dev/disk:/dev/disk:ro --publish=8080:8080 --detach=true --name=bj_agent_docker google/cadvisor:latest</code></pre><blockquote><p>ä¸»è¦æ–¹å¼å°±æ˜¯é€šè¿‡æ˜ å°„æœ¬åœ°æ–‡ä»¶æ¥ç›‘æ§å®¹å™¨ä¸­cpuï¼Œå†…å­˜ï¼Œç½‘ç»œçš„ä½¿ç”¨æƒ…å†µ</p></blockquote><p><strong>2.å®¹å™¨å¯åŠ¨å®Œæˆå¯ä»¥è®¿é—®ip:8080æ‰“å¼€cadvisoré¡µé¢</strong> <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3454901946.jpg"></p><p><strong>3.prometheusæ·»åŠ ç›‘æ§é¡¹</strong></p><pre><code>- job_name: &#39;docker&#39;    static_configs:    - targets:      - &#39;106.75.x.x:8080&#39;</code></pre><p><strong>4.é‡è½½é…ç½®</strong></p><pre><code>kill -HUP 14083</code></pre><p><strong>5.grafanaæŸ¥çœ‹ç›‘æ§</strong> <img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4223136120.jpg"></p><p>[[<strong>1</strong>]   ]   <a href="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3454901946.jpg">https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3454901946.jpg</a> </p><p>[[<strong>2</strong>]   ]    <a href="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4223136120.jpg">https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4223136120.jpg</a> </p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨Dockeréƒ¨ç½²Prometheus+Grafanaç›‘æ§äº‘ä¸»æœº</title>
      <link href="/db991cc/"/>
      <url>/db991cc/</url>
      
        <content type="html"><![CDATA[<p><strong>1.éœ€è¦å…ˆæ·»åŠ prometheusçš„é»˜è®¤é…ç½®æ–‡ä»¶</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># my global config</span><span class="token key atrule">global</span><span class="token punctuation">:</span>  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span>     15s <span class="token comment" spellcheck="true"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span>  <span class="token key atrule">evaluation_interval</span><span class="token punctuation">:</span> 15s <span class="token comment" spellcheck="true"># Evaluate rules every 15 seconds. The default is every 1 minute.</span>  <span class="token comment" spellcheck="true"># scrape_timeout is set to the global default (10s).</span> <span class="token comment" spellcheck="true"># Alertmanager configuration</span><span class="token key atrule">alerting</span><span class="token punctuation">:</span>  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> alertmanager<span class="token punctuation">:</span><span class="token number">9093</span> <span class="token comment" spellcheck="true"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span><span class="token key atrule">rule_files</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># - "first_rules.yml"</span>  <span class="token comment" spellcheck="true"># - "second_rules.yml"</span> <span class="token comment" spellcheck="true"># A scrape configuration containing exactly one endpoint to scrape:</span><span class="token comment" spellcheck="true"># Here it's Prometheus itself.</span><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># The job name is added as a label `job=&lt;job_name>` to any timeseries scraped from this config.</span>  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'prometheus'</span>     <span class="token comment" spellcheck="true"># metrics_path defaults to '/metrics'</span>    <span class="token comment" spellcheck="true"># scheme defaults to 'http'.</span>    <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 5s    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9090'</span><span class="token punctuation">]</span></code></pre><hr><p><strong>2.ç›´æ¥ç›´æ¥ä½¿ç”¨å®˜æ–¹é•œåƒå¯åŠ¨</strong></p><blockquote><p>æˆ‘è¿™è¾¹æ–‡ä»¶æ˜¯åœ¨&#x2F;tmpä¸‹çš„</p></blockquote><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name=promethues <span class="token punctuation">-</span>p 9090<span class="token punctuation">:</span>9090 <span class="token punctuation">-</span>v /tmp/prometheus.yml<span class="token punctuation">:</span>/etc/prometheus/prometheus.yml prom/prometheus</code></pre><blockquote><p>é»˜è®¤ç«¯å£æ˜¯9090 å¯ä»¥ç›´æ¥ipï¼šprotè®¿é—®</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4279283483.jpg"></p><blockquote><p>é¡µé¢å¯ä»¥æ­£å¸¸æ‰“å¼€ è¯æ˜prometheuså·²ç»å®‰è£…å®Œæˆ</p></blockquote><hr><p><strong>3.å®‰è£…ç›‘æ§èŠ‚ç‚¹node_exporter</strong></p><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span>p 9100<span class="token punctuation">:</span>9100 <span class="token punctuation">-</span>v "/proc<span class="token punctuation">:</span>/host/proc<span class="token punctuation">:</span>ro" <span class="token punctuation">-</span>v "/sys<span class="token punctuation">:</span>/host/sys<span class="token punctuation">:</span>ro" <span class="token punctuation">-</span>v "/<span class="token punctuation">:</span>/rootfs<span class="token punctuation">:</span>ro"  prom/node<span class="token punctuation">-</span>exporter</code></pre><blockquote><p>é»˜è®¤ç«¯å£æ˜¯9100 å¯ä»¥ç›´æ¥ipï¼šprotè®¿é—®ç¡®è®¤æ˜¯å¦å·²ç»æ”¶é›†åˆ°æ•°æ®</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2013638144.jpg"></p><blockquote><p>ä¹Ÿå¯ä»¥åœ¨prometheusä¸­æŸ¥çœ‹æ˜¯å¦æœ‰æ•°æ®</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1268918424.jpg"></p><hr><p><strong>4.å®‰è£…grafanaåšé¡µé¢å±•ç¤º</strong></p><pre class=" language-yaml"><code class="language-yaml">docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name=grafana <span class="token punctuation">-</span>p 3000<span class="token punctuation">:</span>3000 grafana/grafana</code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3958860042.jpg"></p><blockquote><p>é»˜è®¤è´¦å·å¯†ç å‡ä¸ºadmin</p><p>æ·»åŠ æ•°æ®æºé€‰æ‹©prometheusï¼Œurlé€‰æ‹©promethuesè®¿é—®é“¾æ¥ï¼Œå¹¶ä¿å­˜</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2130166801.jpg"></p><blockquote><p>å¯¼å…¥æ¨¡æ¿é€‰æ‹©9276ï¼ˆå¯ä»¥è‡ªå·±é€‰æ‹©å–œæ¬¢çš„ï¼‰å¹¶ä¿å­˜</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/1685660091.jpg"></p><blockquote><p>æŸ¥çœ‹ç›‘æ§</p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3583263766.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> Monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Prometheus </tag>
            
            <tag> Grafana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockeréƒ¨ç½²smokepingç›‘æ§ç½‘ç»œè´¨é‡</title>
      <link href="/ce36882f/"/>
      <url>/ce36882f/</url>
      
        <content type="html"><![CDATA[<p><strong>1.ç®€ä»‹</strong></p><p>smokepingæ˜¯ä¸€æ¬¾ç›‘æ§ç½‘ç»œç¨³å®šçš„å¼€æºè½¯ä»¶ï¼Œé€šè¿‡å®ƒå¯ä»¥ç›‘æ§åˆ°æœ¬åœ°åˆ°å„åœ°çš„ç½‘ç»œçŠ¶å†µï¼Œå¦‚å»¶æ—¶ï¼Œä¸¢åŒ…ï¼Œå¹¶é€šè¿‡rrdtoolåˆ¶å›¾æ–¹å¼ï¼Œå›¾å½¢åŒ–åœ°å±•ç¤ºç½‘ç»œçš„å»¶æ—¶ã€‚</p><hr><p><strong>2.é…ç½®</strong></p><blockquote><p>åˆ›å»ºä¸€ä¸ªç›®å½•åšæ•°æ®æŒä¹…åŒ–<br>mkdir -p &#x2F;data&#x2F;smokeping</p></blockquote><blockquote><p>é˜²ç«å¢™æ”¾è¡Œ11111ç«¯å£å¹¶ä½¿ç”¨dockeråˆ›å»º</p></blockquote><pre class=" language-yaml"><code class="language-yaml">docker create <span class="token punctuation">-</span><span class="token punctuation">-</span>name=smokeping <span class="token punctuation">-</span>e TZ=Asia/Chongqing <span class="token punctuation">-</span>p 11111<span class="token punctuation">:</span>80 <span class="token punctuation">-</span><span class="token punctuation">-</span>restart unless<span class="token punctuation">-</span>stopped <span class="token punctuation">-</span>v /data/smokeping/data<span class="token punctuation">:</span>/data <span class="token punctuation">-</span>v /data/smokeping/config<span class="token punctuation">:</span>/config linuxserver/smokeping</code></pre><blockquote><p>è®¿é—® <a href="http://ip:11111/">http://ip:11111</a></p></blockquote><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/205928601.png"></p><hr><p><strong>3.é…ç½®æ–‡ä»¶ï¼ˆä¸»è¦æœ‰ä¸‰ä¸ªï¼‰</strong></p><blockquote><p>Database</p></blockquote><pre class=" language-yaml"><code class="language-yaml">*** Database ***step     = 60pings    = 60<span class="token comment" spellcheck="true"># consfn mrhb steps total</span>AVERAGE  0.5   1  1008AVERAGE  0.5  12  4320    MIN  0.5  12  4320    MAX  0.5  12  4320AVERAGE  0.5 144   720    MAX  0.5 144   720    MIN  0.5 144   720</code></pre><blockquote><p>Presentation ä¸»è¦æ˜¯ smokeping çš„å›¾è¡¨å’Œç¬¬ä¸€æ çš„è®¾ç½®</p></blockquote><pre class=" language-yaml"><code class="language-yaml">*** Presentation ***template = /etc/smokeping/basepage.htmlcharset  = utf<span class="token punctuation">-</span><span class="token number">8</span>+ chartsmenu = æ’è¡Œæ¦œtitle = æ’è¡Œæ¦œ++ stddevsorter = StdDev(entries=<span class="token punctuation">></span>4)title = ç»¼åˆæŒ‡æ ‡æ’åmenu = ç»¼åˆæŒ‡æ ‡format = ç»¼åˆæŒ‡æ•° %f++ maxsorter = Max(entries=<span class="token punctuation">></span>5)title = æœ€å¤§å»¶è¿Ÿmenu = æœ€å¤§å»¶è¿Ÿformat = æœ€å¤§å»¶è¿Ÿæ—¶é—´ %f ç§’++ losssorter = Loss(entries=<span class="token punctuation">></span>5)title = ä¸¢åŒ…ç‡menu = ä¸¢åŒ…ç‡format = ä¸¢åŒ… %f++ mediansorter = Median(entries=<span class="token punctuation">></span>5)title = ä¸­é—´æ•°æ®åŒ…å»¶è¿Ÿmenu = ä¸­é—´æ•°æ®åŒ…å»¶è¿Ÿformat = ä¸­é—´æ•°æ®åŒ…å»¶è¿Ÿ RTT %f ç§’+ overviewwidth = 600height = 50range = 10h+ detailwidth = 600height = 200unison_tolerance = 2"Last 1 Hours"    1h"Last 24 Hours"   24h"Last 7 Days"     7d"Last 30 Days"   30d<span class="token comment" spellcheck="true">#+ hierarchies</span><span class="token comment" spellcheck="true">#++ owner</span><span class="token comment" spellcheck="true">#title = Host Owner</span><span class="token comment" spellcheck="true">#++ location</span><span class="token comment" spellcheck="true">#title = Location</span></code></pre><blockquote><p>Targets å†…åˆ™æ˜¯ç›‘æ§çš„ä¸»ä½“</p></blockquote><pre class=" language-yaml"><code class="language-yaml">Targets   probe = FPing        menu = Top title = Network Latency Grapher remark = Welcome to the SmokePing website of WORKS Company. \             Here you will learn all about the latency of our network.        + InternetSites        + baidu menu = ç™¾åº¦ title = ç™¾åº¦        ++ baidu menu = ç™¾åº¦ title = ç™¾åº¦ host = www.baidu.com        +Europe</code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlä¿®æ”¹éäº‹åŠ¡å¼•æ“</title>
      <link href="/1aa41b34/"/>
      <url>/1aa41b34/</url>
      
        <content type="html"><![CDATA[<p>1.Mysqlè·å–éäº‹åŠ¡å¼•æ“çš„å‘½ä»¤</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> table_schema database_name<span class="token punctuation">,</span>table_name<span class="token punctuation">,</span><span class="token keyword">engine</span> <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">tables</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">,</span><span class="token string">'information_schema'</span><span class="token punctuation">,</span><span class="token string">'performance_schema'</span><span class="token punctuation">,</span><span class="token string">'sys'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token keyword">engine</span> <span class="token operator">&lt;></span> <span class="token string">'InnoDB'</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/248870415.png"></p><hr><p>2.è·å–ä¿®æ”¹å­˜å‚¨å¼•æ“çš„è„šæœ¬ï¼ˆæ‰§è¡Œè¡¨ä¸­çš„è¯­å¥å³å¯ä¿®æ”¹éäº‹åŠ¡å¼•æ“ï¼‰</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> CONCAT<span class="token punctuation">(</span><span class="token string">'ALTER TABLE'</span><span class="token punctuation">,</span>table_schema<span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span>table_name<span class="token punctuation">,</span><span class="token string">'ENGINE=InnoDB;'</span><span class="token punctuation">)</span> sql_text <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span><span class="token keyword">TABLES</span> <span class="token keyword">WHERE</span> table_schema <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">,</span><span class="token string">'information_schema'</span><span class="token punctuation">,</span><span class="token string">'performance_schema'</span><span class="token punctuation">,</span><span class="token string">'sys'</span><span class="token punctuation">)</span><span class="token operator">AND</span> <span class="token keyword">engine</span> <span class="token operator">&lt;></span> <span class="token string">'InnoDB'</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/473742447.png"></p><hr><p>3.æ‰§è¡Œè¯­å¥ä¿®æ”¹<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2944975847.png"></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlæ¸…ç†binlogæ—¥å¿—</title>
      <link href="/ba01084/"/>
      <url>/ba01084/</url>
      
        <content type="html"><![CDATA[<p>Mysql æ¸…ç†binlogæ—¥å¿—</p><p>1.MySQL Binlogä»‹ç»</p><p>MySQL Binlogæ˜¯ä»¥äº‹ä»¶å½¢å¼è®°å½•æ‰€æœ‰DDL(Data Definition Language æ•°æ®å®šä¹‰è¯­è¨€ï¼šCreateã€Dropå’ŒAlter)å’ŒDML(Data Manipulation Language æ•°æ®æ“æ§è¯­è¨€ï¼šInsertã€Deleteå’ŒUpdate)æ“ä½œçš„äºŒè¿›åˆ¶æ—¥å¿—ã€‚</p><p>Binlogæ—¥å¿—çš„ä¸¤ä¸ªé‡è¦çš„ä½¿ç”¨åœºæ™¯ï¼š</p><p>ï¼ˆ1ï¼‰MySQLä¸»ä»å¤åˆ¶</p><p>ï¼ˆ2ï¼‰æ•°æ®åº“å›æ¡£[æ•°æ®æ¢å¤]</p><hr><p>2.MySQL Binlogè¿‡æœŸæ—¶é—´</p><p>MySQLé»˜è®¤Binlogè¿‡æœŸæ—¶é—´æ˜¯7å¤©ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ï¼šBinlogæ—¥å¿—è¿‡æœŸæ—¶é—´æ˜¯æŒ‰ç…§æœ€æ–°ä¸€ä¸ªBinlogæ—¶é—´t1å‡7ï¼Œè€Œä¸æ˜¯å½“å‰æ—¶é—´å‡7ã€‚æ¯”å¦‚ï¼šä»Šå¤©æ˜¯14å·ï¼Œè€Œæœ€æ–°Binlogæœ€åçš„ä¿®æ”¹æ—¶é—´æ˜¯9å·ï¼Œé‚£ä¹ˆå‡ å·ä¹‹å‰çš„Binlogä¼šè¢«æ¸…ç†å‘¢ï¼Ÿç­”æ¡ˆå¯èƒ½æœ‰ç‚¹å‡ºä¹æ„æ–™ï¼Œæ²¡é”™æ˜¯9-7&#x3D;2ï¼Œå³2å·ä¹‹å‰çš„Binlogä¼šè¢«è‡ªåŠ¨æ¸…ç†ã€‚</p><hr><p>3.MySQL Binlogæ—¥å¿—æ¸…ç†</p><p>æŸ¥çœ‹binlogæ–‡ä»¶åˆ—è¡¨</p><blockquote><p>show binary logs;</p></blockquote><p>æŸ¥çœ‹å½“å‰å†™çš„binglog</p><blockquote><p>show master status\G</p></blockquote><p>æ–¹å¼ä¸€ï¼šæ¸…ç†é™¤mysql-bin.000003æ—¥å¿—ä»¥å¤–çš„æ‰€æœ‰binlogæ—¥å¿—</p><blockquote><p>purge binary logs to â€œmysql-bin.000003â€;</p></blockquote><p>æ–¹å¼äºŒï¼šæ¸…ç†begin_timeæ—¶é—´ç‚¹å‰çš„æ—¥å¿—</p><blockquote><p>purge binary logs before â€œ$begin_timeâ€;<br>æ—¥æœŸæ ¼å¼ï¼šâ€™2018-02-01 12:00:00â€™;</p></blockquote><hr><p>4.MySQL Binlogæ—¥å¿—å®šæ—¶æ¸…ç†è„šæœ¬</p><p>è¯¦æƒ…å‚è€ƒï¼š<a href="https://blogs.starcto.com/purge-binary-logs/">https://blogs.starcto.com/purge-binary-logs/</a></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlä¿®æ”¹å¯†ç </title>
      <link href="/f3a1699d/"/>
      <url>/f3a1699d/</url>
      
        <content type="html"><![CDATA[<p>Mysqlä¿®æ”¹å¯†ç çš„æ–¹æ³•</p><p>1.ä½¿ç”¨set password æ–¹å¼ä¿®æ”¹</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">set</span> password <span class="token keyword">for</span> root<span class="token variable">@localhost</span> <span class="token operator">=</span> password<span class="token punctuation">(</span><span class="token string">'123456'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3836760803.png"></p><hr><p>2.ä½¿ç”¨mysqladminä¿®æ”¹</p><pre class=" language-sql"><code class="language-sql">mysqladmin <span class="token operator">-</span>u root <span class="token operator">-</span>p123456 password <span class="token number">12345678</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/3822327575.png"></p><hr><p>3.ä½¿ç”¨update userè¡¨çš„æ–¹å¼æ¥ä¿®æ”¹</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">UPDATE</span> mysql<span class="token punctuation">.</span><span class="token keyword">user</span> <span class="token keyword">SET</span> authentication_string<span class="token operator">=</span>PASSWORD<span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span> <span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">;</span>flush <span class="token keyword">privileges</span><span class="token punctuation">;</span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/4000690710.png"></p><p>æ³¨ï¼šmysql5.7ä»¥ä¸‹ åº”è¯¥éœ€è¦æŠŠauthentication_stringæ›¿æ¢ä¸ºpassword</p><hr><p>4.å¿˜è®°å¯†ç å¯ä»¥é€‰æ‹©è¿™ä¸ªæ–¹æ³•</p><p>ä¿®æ”¹myslé…ç½®æ–‡ä»¶æ·»åŠ skip-grant-tablesï¼ˆå¯åŠ¨MySQLæœåŠ¡çš„æ—¶å€™è·³è¿‡æƒé™è¡¨è®¤è¯ï¼‰<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/2702070504.png"></p><p>é‡å¯mysqld å¹¶ä½¿ç”¨mysql -uroot -p ç›´æ¥å›è½¦ç™»é™†<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/07/297340355.png"></p><p>ä½¿ç”¨ç¬¬ä¸‰ç§æ–¹æ³•æ¥ä¿®æ”¹å¯†ç </p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlæ•°æ®è¡¨æŸåæ¢å¤</title>
      <link href="/55893a1f/"/>
      <url>/55893a1f/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><p>æŸæ—¥ç™»é™†å‘ç°mysqlè¡¨æŸåï¼Œæ— æ³•å¯åŠ¨ ï¼Œå¯ä»¥å€Ÿç”¨å¦‚ä¸‹æ–¹æ³•æ¢å¤ã€‚</p><h1 id="äºŒã€æ¢å¤"><a href="#äºŒã€æ¢å¤" class="headerlink" title="äºŒã€æ¢å¤"></a>äºŒã€æ¢å¤</h1><h2 id="å¯åŠ¨ä¸€ä¸ªæ–°åº“"><a href="#å¯åŠ¨ä¸€ä¸ªæ–°åº“" class="headerlink" title="å¯åŠ¨ä¸€ä¸ªæ–°åº“"></a>å¯åŠ¨ä¸€ä¸ªæ–°åº“</h2><pre class=" language-sql"><code class="language-sql"><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqld_safe --defaults-file=/data/3308/my.conf &amp;</span><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ps -ef | grep 3308</span>root     <span class="token number">25776</span> <span class="token number">17533</span>  <span class="token number">0</span> <span class="token number">10</span>:<span class="token number">11</span> pts<span class="token operator">/</span><span class="token number">1</span>    <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">/</span>bin<span class="token operator">/</span>sh <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysqld_safe <span class="token comment" spellcheck="true">--defaults-file=/data/3308/my.conf</span>mysql    <span class="token number">25927</span> <span class="token number">25776</span>  <span class="token number">0</span> <span class="token number">10</span>:<span class="token number">11</span> pts<span class="token operator">/</span><span class="token number">1</span>    <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysqld <span class="token comment" spellcheck="true">--defaults-file=/data/3308/my.conf --basedir=/application/mysql/ --datadir=/data/3308/data --plugin-dir=/application/mysql//lib/plugin --user=mysql --log-error=db.err --pid-file=db.pid --socket=/data/3308/data/mysql.sock --port=3308</span>root     <span class="token number">25950</span> <span class="token number">17533</span>  <span class="token number">0</span> <span class="token number">10</span>:<span class="token number">12</span> pts<span class="token operator">/</span><span class="token number">1</span>    <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> grep <span class="token comment" spellcheck="true">--color=auto 3308</span></code></pre><h2 id="ç™»é™†3308æ¢å¤æ•°æ®"><a href="#ç™»é™†3308æ¢å¤æ•°æ®" class="headerlink" title="ç™»é™†3308æ¢å¤æ•°æ®"></a>ç™»é™†3308æ¢å¤æ•°æ®</h2><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#åˆ›å»ºworldåº“</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> world<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#ä½¿ç”¨ä¹‹å‰çš„å»ºè¡¨è¯­å¥åˆ›å»ºæ•°æ®è¡¨</span>mysql<span class="token operator">></span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>city<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>ID<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>Name<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">35</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>CountryCode<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>District<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token punctuation">`</span>Population<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>ID<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token keyword">KEY</span> <span class="token punctuation">`</span>CountryCode<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>CountryCode<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token operator">-</span><span class="token operator">></span>   <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_district<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>District<span class="token punctuation">`</span><span class="token punctuation">)</span>    <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">4080</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>latin1<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#ç›®å‰æ˜¯æ²¡æœ‰æ•°æ®çš„</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city<span class="token punctuation">;</span>Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#åˆ é™¤è¡¨ç©ºé—´</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> world<span class="token punctuation">.</span>city <span class="token keyword">discard</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æ‹·è´æŸåè¡¨çš„è¡¨ç©ºé—´</span><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cp -a /application/mysql/data/world/city.ibd /data/3307/data/world/</span><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll /data/3307/data/world/</span>total <span class="token number">736</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql   8710 Nov  4 14:41 city.frm</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql 737280 Nov  2 16:26 city.ibd</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql     61 Nov  4 14:39 db.opt</span><span class="token comment" spellcheck="true">#å¯¼å…¥è¡¨ç©ºé—´</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> world<span class="token punctuation">.</span>city <span class="token keyword">import</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æ•°æ®æ¢å¤</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">limit</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+----------------+-------------+---------------+------------+</span><span class="token operator">|</span> ID <span class="token operator">|</span> Name           <span class="token operator">|</span> CountryCode <span class="token operator">|</span> District      <span class="token operator">|</span> Population <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+----------------+-------------+---------------+------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> Kabul          <span class="token operator">|</span> AFG         <span class="token operator">|</span> Kabol         <span class="token operator">|</span>    <span class="token number">1780000</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> Qandahar       <span class="token operator">|</span> AFG         <span class="token operator">|</span> Qandahar      <span class="token operator">|</span>     <span class="token number">237500</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> Herat          <span class="token operator">|</span> AFG         <span class="token operator">|</span> Herat         <span class="token operator">|</span>     <span class="token number">186800</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> Mazar<span class="token number">-e</span><span class="token operator">-</span>Sharif <span class="token operator">|</span> AFG         <span class="token operator">|</span> Balkh         <span class="token operator">|</span>     <span class="token number">127800</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> Amsterdam      <span class="token operator">|</span> NLD         <span class="token operator">|</span> Noord<span class="token operator">-</span>Holland <span class="token operator">|</span>     <span class="token number">731200</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+----------------+-------------+---------------+------------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql CSRè‡ªåŠ¨æ¢å¤</title>
      <link href="/fa85a72c/"/>
      <url>/fa85a72c/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€æ•°æ®ä¿®æ”¹åæ²¡æœ‰commit-ä¹Ÿæ²¡æœ‰è®°å½•redo-log"><a href="#ä¸€ã€æ•°æ®ä¿®æ”¹åæ²¡æœ‰commit-ä¹Ÿæ²¡æœ‰è®°å½•redo-log" class="headerlink" title="ä¸€ã€æ•°æ®ä¿®æ”¹åæ²¡æœ‰commit ä¹Ÿæ²¡æœ‰è®°å½•redo.log"></a>ä¸€ã€æ•°æ®ä¿®æ”¹åæ²¡æœ‰commit ä¹Ÿæ²¡æœ‰è®°å½•redo.log</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/1584144069.jpg"><br><strong>æ•°æ®æ›´æ–°åï¼Œå°šæœªcommitè®¾å¤‡æ–­ç”µã€‚æœåŠ¡å¯åŠ¨åè‡ªåŠ¨åŠ è½½æ•°æ®è¿›å…¥å†…å­˜ï¼Œå› ä¸ºredo.logæ— æ•°æ®ï¼Œæ‰€ä»¥æ•°æ®æ ¹æ®undo.logæ‹æ‘„çš„å¿«ç…§å›æ»šå¹¶é‡æ–°è½ç›˜</strong></p><h1 id="äºŒã€æ•°æ®æ²¡æœ‰commit-ä½†æ˜¯å†™å…¥äº†redo-log"><a href="#äºŒã€æ•°æ®æ²¡æœ‰commit-ä½†æ˜¯å†™å…¥äº†redo-log" class="headerlink" title="äºŒã€æ•°æ®æ²¡æœ‰commit,ä½†æ˜¯å†™å…¥äº†redo.log"></a>äºŒã€æ•°æ®æ²¡æœ‰commit,ä½†æ˜¯å†™å…¥äº†redo.log</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/447963019.png"><br><strong>redo bufferæ ¹æ®å‚æ•°å®šæ—¶å†™å…¥redo.logï¼Œä½†å®é™…äº‹åŠ¡å¹¶æœªçœŸæ­£æäº¤ã€‚æ­¤æ—¶è®¾å¤‡æ–­ç”µï¼ŒæœåŠ¡å¯åŠ¨ååŠ è½½æ•°æ®åˆ°å†…å­˜ã€‚</strong></p><ul><li>é¦–å…ˆæ ¹æ®redo.logè®°å½•å˜æ›´ä¿¡æ¯ä¿®æ”¹data bufferæ•°æ® å°†id 1ä¿®æ”¹ä¸º2</li><li>åœ¨æ ¹æ®undo bufferä¿¡æ¯ å‘ç°æ²¡æœ‰commit å†æ¬¡å°†æ•°æ®è¿›è¡Œå›æ»š å°†id 2ä¿®æ”¹ä¸º1</li><li>æœ€åå°†id&#x3D;1 lsn&#x3D;100 txid&#x3D;100 å†™å…¥ç£ç›˜</li></ul><h1 id="ä¸‰ã€äº‹åŠ¡æˆåŠŸcommit"><a href="#ä¸‰ã€äº‹åŠ¡æˆåŠŸcommit" class="headerlink" title="ä¸‰ã€äº‹åŠ¡æˆåŠŸcommit"></a>ä¸‰ã€äº‹åŠ¡æˆåŠŸcommit</h1><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/39761923.png"><br>äº‹åŠ¡æˆåŠŸæäº¤ï¼Œå˜æ›´å†™å…¥redo.log å¹¶ä¸”undo.logè®°å½•commit</p><ul><li>é¦–å…ˆæ ¹æ®redo.logè®°å½•å˜æ›´ä¿¡æ¯ä¿®æ”¹data bufferæ•°æ® å°†id 1ä¿®æ”¹ä¸º2</li><li>undo.logæœ‰è®°å½•commitå› æ­¤æ•°æ®ä¸ä¼šå‘ç”Ÿå›æ»š</li><li>å°†id&#x3D;2 lsn&#x3D;101 txid&#x3D;101å†™å…¥ç£ç›˜</li></ul>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlæ ¹æ®binlogæ¢å¤æ•°æ®</title>
      <link href="/a6515af6/"/>
      <url>/a6515af6/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€å‡†å¤‡æ•°æ®"><a href="#ä¸€ã€å‡†å¤‡æ•°æ®" class="headerlink" title="ä¸€ã€å‡†å¤‡æ•°æ®"></a>ä¸€ã€å‡†å¤‡æ•°æ®</h1><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#åˆ›å»ºdb</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token number">db1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token number">db2</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token comment" spellcheck="true">#db1åˆ›å»ºè¡¨å¹¶æ’å…¥æµ‹è¯•æ•°æ®</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> <span class="token number">db1</span><span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> ti<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> ti <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">5</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">5</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ti<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#db2åˆ›å»ºè¡¨å¹¶æ’å…¥æ•°æ®</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> <span class="token number">db2</span><span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> t2<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> t2 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t2<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="äºŒã€æ¨¡æ‹Ÿåˆ é™¤æ•°æ®"><a href="#äºŒã€æ¨¡æ‹Ÿåˆ é™¤æ•°æ®" class="headerlink" title="äºŒã€æ¨¡æ‹Ÿåˆ é™¤æ•°æ®"></a>äºŒã€æ¨¡æ‹Ÿåˆ é™¤æ•°æ®</h1><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">drop</span> <span class="token keyword">table</span> ti<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="ä¸‰ã€ä½¿ç”¨binlogæ¢å¤"><a href="#ä¸‰ã€ä½¿ç”¨binlogæ¢å¤" class="headerlink" title="ä¸‰ã€ä½¿ç”¨binlogæ¢å¤"></a>ä¸‰ã€ä½¿ç”¨binlogæ¢å¤</h1><p>ä½¿ç”¨mysqlbinlogå·¥å…·æŸ¥çœ‹æ—¥å¿—çš„èµ·å§‹ç‚¹</p><pre class=" language-sql"><code class="language-sql">mysqlbinlog <span class="token comment" spellcheck="true">--base64-output=decode-rows -vvv /application/mysql/data/mysql-bin.000008</span><span class="token comment" spellcheck="true">#èµ·ç‚¹</span><span class="token comment" spellcheck="true"># at 2787</span><span class="token comment" spellcheck="true">#211108 13:26:12 server id 1  end_log_pos 2878 CRC32 0x0357015f Querythread_id=exec_time=0error_code=0</span><span class="token keyword">SET</span> <span class="token keyword">TIMESTAMP</span><span class="token operator">=</span><span class="token number">1636349172</span><span class="token comment" spellcheck="true">/*!*/</span><span class="token punctuation">;</span><span class="token keyword">create</span> <span class="token keyword">database</span> <span class="token number">db1</span><span class="token comment" spellcheck="true">#ç»“æŸ</span><span class="token comment" spellcheck="true"># at 3722</span><span class="token comment" spellcheck="true">#211108 13:29:20 server id 1  end_log_pos 3753 CRC32 0x958a7d9c Xid = 230</span><span class="token keyword">COMMIT</span><span class="token comment" spellcheck="true">/*!*/</span><span class="token punctuation">;</span></code></pre><p>æˆªå–è¿™ä¸€æ®µæ—¥å¿—ï¼Œä½†æ˜¯æˆ‘ä»¬ä¼šå‘ç°è¿™ä¸€æ®µæ—¥å¿—ä¸åªæœ‰db1çš„æ“ä½œè¿˜æœ‰db2çš„æ“ä½œ æˆ‘ä»¬éœ€è¦æˆªå–db1åº“çš„ æ‰€ä»¥éœ€è¦æ·»åŠ å‚æ•°-d</p><pre class=" language-sql"><code class="language-sql">mysqlbinlog <span class="token operator">-</span><span class="token number">d</span> <span class="token number">db1</span> <span class="token comment" spellcheck="true">--start-position=2787 --stop-position=3722 /application/mysql/data/mysql-bin.000008 >/tmp/back2.sql</span></code></pre><p>ç™»é™†dbå¯¼å…¥æ•°æ®</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#å…ˆå…³é—­binlogè®°å½•</span>mysql<span class="token operator">></span> <span class="token keyword">set</span> sql_log_bin<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#å¯¼å…¥æˆªå–çš„binlog</span>mysql<span class="token operator">></span> source <span class="token operator">/</span>tmp<span class="token operator">/</span>back2<span class="token punctuation">.</span>sql<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹æ•°æ®å·²ç»æ¢å¤</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> <span class="token number">db1</span><span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+</span><span class="token operator">|</span> Tables_in_db1 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+</span><span class="token operator">|</span> ti            <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">---------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ti<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">4</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">5</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>å½“ç„¶è¿™ä¸ªæ–¹æ³•å…¶å®å±€é™æ€§æ¯”è¾ƒå¤§åªèƒ½æ¢å¤è¿‘æœŸçš„æ•°æ® å¦‚æœæ˜¯å¾ˆæ—©ä¹‹å‰åˆ›å»ºçš„åº“çš„è¯ ä»£ä»·å°±æ¯”è¾ƒå¤§äº†</p><ul><li>1ï¼‰å¯ä»¥ç”¨å¤‡ä»½æ¢å¤+çŸ­æ—¶é—´å†…äºŒè¿›åˆ¶æ—¥å¿—ï¼Œæ¢å¤åˆ°æ•…éšœä¹‹å‰</li><li>2ï¼‰éå®˜æ–¹æ–¹æ³•ï¼Œbinlog2sqlï¼Œbinlogå–åï¼Œç±»ä¼¼äºOracleçš„flushback</li><li>3ï¼‰å»¶æ—¶ä»åº“</li></ul><hr><h1 id="å››ã€binlogæ—¥å¿—çš„æ—¥å¸¸æ“ä½œ"><a href="#å››ã€binlogæ—¥å¿—çš„æ—¥å¸¸æ“ä½œ" class="headerlink" title="å››ã€binlogæ—¥å¿—çš„æ—¥å¸¸æ“ä½œ"></a>å››ã€binlogæ—¥å¿—çš„æ—¥å¸¸æ“ä½œ</h1><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#ç‰©ç†æŸ¥çœ‹</span><span class="token punctuation">[</span>root<span class="token variable">@db01</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll /application/mysql/data/</span><span class="token operator">-</span>rw<span class="token operator">-</span>rw<span class="token comment" spellcheck="true">---- 1 mysql mysql      285 Mar  6  2017 mysql-bin.000001</span><span class="token comment" spellcheck="true">#å‘½ä»¤è¡ŒæŸ¥çœ‹</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">binary</span> logs<span class="token punctuation">;</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹binlogäº‹ä»¶</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> binlog events <span class="token operator">in</span> <span class="token string">'mysql-bin.000007'</span><span class="token punctuation">;</span></code></pre><p>è®¾ç½®binlogä¿ç•™æ—¶é—´</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#ä¸´æ—¶ç”Ÿæ•ˆ</span><span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> expire_logs_days <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#æ°¸ä¹…ç”Ÿæ•ˆ</span><span class="token punctuation">[</span>root<span class="token variable">@db01</span> <span class="token keyword">data</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># vim /etc/my.cnf</span><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>expire_logs_days <span class="token operator">=</span> <span class="token number">7</span></code></pre><p>æ¸…é™¤binlog</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#æ ¹æ®æ—¶é—´åˆ é™¤</span><span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS BEFORE <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> INTERVAL <span class="token number">3</span> day<span class="token punctuation">;</span><span class="token comment" spellcheck="true">#æ ¹æ®æ–‡ä»¶ååˆ é™¤</span><span class="token keyword">PURGE</span> <span class="token keyword">BINARY</span> LOGS <span class="token keyword">TO</span> <span class="token string">'mysql-bin.000010'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">#é‡ç½®binlog</span>mysql<span class="token operator">></span> reset master<span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlå¼€å¯æ…¢æ—¥å¿—</title>
      <link href="/414a2e2c/"/>
      <url>/414a2e2c/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€å¼€å¯æ…¢æ—¥å¿—å‚æ•°"><a href="#ä¸€ã€å¼€å¯æ…¢æ—¥å¿—å‚æ•°" class="headerlink" title="ä¸€ã€å¼€å¯æ…¢æ—¥å¿—å‚æ•°"></a>ä¸€ã€å¼€å¯æ…¢æ—¥å¿—å‚æ•°</h1><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#æŒ‡å®šæ˜¯å¦å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—</span>slow_query_log <span class="token operator">=</span> <span class="token number">1</span><span class="token comment" spellcheck="true">#æŒ‡å®šæ…¢æ—¥å¿—æ–‡ä»¶å­˜æ”¾ä½ç½®ï¼ˆé»˜è®¤åœ¨dataï¼‰</span>slow_query_log_file<span class="token operator">=</span><span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>slow<span class="token punctuation">.</span>log<span class="token comment" spellcheck="true">#è®¾å®šæ…¢æŸ¥è¯¢çš„é˜€å€¼(é»˜è®¤10s)</span>long_query_time<span class="token operator">=</span><span class="token number">0.05</span><span class="token comment" spellcheck="true">#ä¸ä½¿ç”¨ç´¢å¼•çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯å¦è®°å½•åˆ°æ—¥å¿—</span>log_queries_not_using_indexes</code></pre><hr><h1 id="äºŒã€Mysqldumpslow"><a href="#äºŒã€Mysqldumpslow" class="headerlink" title="äºŒã€Mysqldumpslow"></a>äºŒã€Mysqldumpslow</h1><pre class=" language-bash"><code class="language-bash">å‚æ•°è¯´æ˜:-s:æ˜¯è¡¨ç¤ºæŒ‰ç…§ä½•ç§æ–¹å¼æ’åºï¼Œcã€tã€lã€råˆ†åˆ«æ˜¯æŒ‰ç…§è®°å½•æ¬¡æ•°ã€æ—¶é—´ã€æŸ¥è¯¢æ—¶é—´ã€è¿”å›çš„è®°å½•æ•°æ¥æ’åºï¼Œacã€atã€alã€arï¼Œè¡¨ç¤ºç›¸åº”çš„å€’å™ï¼›-t:æ˜¯top nçš„æ„æ€ï¼Œå³ä¸ºè¿”å›å‰é¢å¤šå°‘æ¡çš„æ•°æ®ï¼›-g:åè¾¹å¯ä»¥å†™ä¸€ä¸ªæ­£åˆ™åŒ¹é…æ¨¡å¼ï¼Œå¤§å°å†™ä¸æ•æ„Ÿçš„ï¼›</code></pre><pre class=" language-sql"><code class="language-sql"><span class="token punctuation">[</span>root<span class="token variable">@db</span> <span class="token operator">~</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqldumpslow -s c -t 10 /application/mysql/data/slow.log</span>Reading mysql slow query log <span class="token keyword">from</span> <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>slow<span class="token punctuation">.</span>logCount: <span class="token number">8</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>69s <span class="token punctuation">(</span>5s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">insert</span> <span class="token keyword">into</span> city_new <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city_newCount: <span class="token number">2</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>24s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">275000.0</span> <span class="token punctuation">(</span><span class="token number">550000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city_new <span class="token keyword">limit</span> NCount: <span class="token number">1</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>04s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>01s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">0.0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">create</span> <span class="token keyword">table</span> city_new <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cityCount: <span class="token number">1</span>  Time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>66s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Lock</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">.</span>00s <span class="token punctuation">(</span>0s<span class="token punctuation">)</span>  <span class="token keyword">Rows</span><span class="token operator">=</span><span class="token number">1.0</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> root<span class="token punctuation">[</span>root<span class="token punctuation">]</span><span class="token variable">@localhost</span>  <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> city_newDied at <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token operator">/</span>bin<span class="token operator">/</span>mysqldumpslow line <span class="token number">161</span><span class="token punctuation">,</span> <span class="token operator">&lt;></span> chunk <span class="token number">10</span><span class="token punctuation">.</span></code></pre><hr><h1 id="ä¸‰ã€pt-query-digestæ—¥å¿—åˆ†æå·¥å…·"><a href="#ä¸‰ã€pt-query-digestæ—¥å¿—åˆ†æå·¥å…·" class="headerlink" title="ä¸‰ã€pt-query-digestæ—¥å¿—åˆ†æå·¥å…·"></a>ä¸‰ã€pt-query-digestæ—¥å¿—åˆ†æå·¥å…·</h1><p>ä¸‹è½½</p><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> https://downloads.percona.com/downloads/percona-toolkit/3.3.1/binary/redhat/7/x86_64/percona-toolkit-3.3.1-1.el7.x86_64.rpm</code></pre><p>yumå®‰è£…</p><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> -y percona-toolkit-3.3.1-1.el7.x86_64.rpm</code></pre><p>åˆ†ææ—¥å¿—</p><pre class=" language-bash"><code class="language-bash">pt-query-digest /application/mysql/data/slow.log</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlç‰©ç†å¤‡ä»½ä¹‹Xtrabackup</title>
      <link href="/247e674/"/>
      <url>/247e674/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€Xtrabackupä»‹ç»"><a href="#ä¸€ã€Xtrabackupä»‹ç»" class="headerlink" title="ä¸€ã€Xtrabackupä»‹ç»"></a>ä¸€ã€Xtrabackupä»‹ç»</h1><p>MySQLå†·å¤‡ã€<code>mysqldump</code>ã€MySQLçƒ­æ‹·è´éƒ½æ— æ³•å®ç°å¯¹æ•°æ®åº“è¿›è¡Œå¢é‡å¤‡ä»½ã€‚åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­å¢é‡å¤‡ä»½æ˜¯éå¸¸å®ç”¨çš„ï¼Œå¦‚æœæ•°æ®å¤§äº50Gæˆ–100Gï¼Œå­˜å‚¨ç©ºé—´è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æ¯å¤©è¿›è¡Œå®Œæ•´å¤‡ä»½ï¼Œå¦‚æœæ¯å¤©äº§ç”Ÿçš„æ•°æ®é‡è¾ƒå¤§ï¼Œéœ€è¦å®šåˆ¶æ•°æ®å¤‡ä»½ç­–ç•¥ã€‚ä¾‹å¦‚æ¯å‘¨å®ç”¨å®Œæ•´å¤‡ä»½ï¼Œå‘¨ä¸€åˆ°å‘¨å…­å®ç”¨å¢é‡å¤‡ä»½ã€‚è€Œ<code>Percona-Xtrabackup</code>å°±æ˜¯ä¸ºäº†å®ç°å¢é‡å¤‡ä»½è€Œå‡ºç°çš„ä¸€æ¬¾ä¸»æµå¤‡ä»½å·¥å…·ï¼Œ<code>xtrabakackup</code>æœ‰2ä¸ªå·¥å…·ï¼Œåˆ†åˆ«æ˜¯<code>xtrabakup</code>ã€<code>innobakupe</code>ã€‚</p><p><code>Percona-xtrabackup</code>æ˜¯ <code>Percona</code>å…¬å¸å¼€å‘çš„ä¸€ä¸ªç”¨äºMySQLæ•°æ®åº“ç‰©ç†çƒ­å¤‡çš„å¤‡ä»½å·¥å…·ï¼Œæ”¯æŒMySQLã€Percona serverå’ŒMariaDBï¼Œå¼€æºå…è´¹ï¼Œæ˜¯ç›®å‰è¾ƒä¸ºå—æ¬¢è¿çš„ä¸»æµå¤‡ä»½å·¥å…·ã€‚xtrabackupåªèƒ½å¤‡ä»½innoDBå’ŒxtraDBä¸¤ç§æ•°æ®å¼•æ“çš„è¡¨ï¼Œè€Œä¸èƒ½å¤‡ä»½MyISAMæ•°æ®è¡¨ã€‚</p><hr><h1 id="äºŒã€Xtrabackupé…ç½®"><a href="#äºŒã€Xtrabackupé…ç½®" class="headerlink" title="äºŒã€Xtrabackupé…ç½®"></a>äºŒã€Xtrabackupé…ç½®</h1><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å®‰è£…ä¾èµ–</span>yum -y <span class="token function">install</span> perl perl-devel libaio libaio-devel perl-Time-HiRes perl-DBD-MySQL<span class="token comment" spellcheck="true">#ä¸‹è½½Xtrabackup</span><span class="token function">wget</span> <span class="token string">"https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.4/binary/redhat/6/x86_64/percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm"</span><span class="token comment" spellcheck="true">#å®‰è£…</span>yum localinstall percona-xtrabackup-24-2.4.4-1.el6.x86_64.rpm</code></pre><hr><h1 id="ä¸‰ã€æµ‹è¯•å…¨é‡å¤‡ä»½æ¢å¤"><a href="#ä¸‰ã€æµ‹è¯•å…¨é‡å¤‡ä»½æ¢å¤" class="headerlink" title="ä¸‰ã€æµ‹è¯•å…¨é‡å¤‡ä»½æ¢å¤"></a>ä¸‰ã€æµ‹è¯•å…¨é‡å¤‡ä»½æ¢å¤</h1><p>å…¨é‡å¤‡ä»½</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp /backup/full</code></pre><p>å¤‡ä»½å®Œæˆç›®å½•</p><pre class=" language-bash"><code class="language-bash">drwxr-x--- 2 root root      122 Nov  9 17:50 backup-rw-r----- 1 root root      430 Nov  9 17:50 backup-my.cnfdrwxr-x--- 2 root root       56 Nov  9 17:50 binlogdrwxr-x--- 2 root root       50 Nov  9 17:50 blogdrwxr-x--- 2 root root       62 Nov  9 17:50 ceshidrwxr-x--- 2 root root       54 Nov  9 17:50 chayidrwxr-x--- 2 root root       56 Nov  9 17:50 chayi2drwxr-x--- 2 root root       48 Nov  9 17:50 db1drwxr-x--- 2 root root       48 Nov  9 17:50 db2drwxr-x--- 2 root root       20 Nov  9 17:50 hhhhdrwxr-x--- 2 root root       92 Nov  9 17:50 huhuhaheidrwxr-x--- 2 root root       20 Nov  9 17:50 huhuhahei1-rw-r----- 1 root root 79691776 Nov  9 17:50 ibdata1-rw-r----- 1 root root 52428800 Nov  9 17:50 ibdata2drwxr-x--- 2 root root       60 Nov  9 17:50 inc1drwxr-x--- 2 root root       60 Nov  9 17:50 inc2drwxr-x--- 2 root root     4096 Nov  9 17:50 mysqldrwxr-x--- 2 root root       76 Nov  9 17:50 oldboydrwxr-x--- 2 root root     4096 Nov  9 17:50 performance_schemadrwxr-x--- 2 root root      160 Nov  9 17:50 slow_query_logdrwxr-x--- 2 root root      284 Nov  9 17:50 <span class="token function">test</span>drwxr-x--- 2 root root       66 Nov  9 17:50 test_binlogdrwxr-x--- 2 root root       76 Nov  9 17:50 wordpressdrwxr-x--- 2 root root      184 Nov  9 17:50 world-rw-r----- 1 root root       21 Nov  9 17:50 xtrabackup_binlog_info    <span class="token comment" spellcheck="true">#è®°å½•binlogæ–‡ä»¶åå’Œbinlogçš„ä½ç½®ç‚¹</span>-rw-r----- 1 root root      117 Nov  9 17:50 xtrabackup_checkpoints    <span class="token comment" spellcheck="true">#å¤‡ä»½çš„ç±»å‹ã€çŠ¶æ€å’ŒLSNçŠ¶æ€ä¿¡æ¯æ–‡ä»¶  </span>-rw-r----- 1 root root      458 Nov  9 17:50 xtrabackup_info    <span class="token comment" spellcheck="true">#å¤‡ä»½æ±‡æ€»ä¿¡æ¯</span>-rw-r----- 1 root root     2560 Nov  9 17:50 xtrabackup_logfile    <span class="token comment" spellcheck="true">#å¤‡ä»½çš„redoæ–‡ä»¶</span></code></pre><p>æ¨¡æ‹Ÿmysqlæ•°æ®ä¸¢å¤±</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å…³é—­æ•°æ®åº“</span>/etc/init.d/mysqld stopShutting down MySQL<span class="token punctuation">..</span> SUCCESS<span class="token comment" spellcheck="true">#åˆ é™¤æ•°æ®ç›®å½•</span><span class="token function">rm</span> -rf /application/mysql/data/</code></pre><p>å‡†å¤‡å¤‡ä»½<br>å°†redoè¿›è¡Œé‡åšï¼Œå·²æäº¤çš„å†™åˆ°æ•°æ®æ–‡ä»¶ï¼Œæœªæäº¤çš„ä½¿ç”¨undoå›æ»šï¼Œæ¨¡æ‹ŸCSRçš„è¿‡ç¨‹</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log /backup/full</code></pre><p>æ‹·è´æ•°æ®</p><pre class=" language-bash"><code class="language-bash">innobackupex --copy-back /backup/full</code></pre><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„æ¢å¤æ•°æ®æ—¶æ²¡æœ‰æŒ‡å®šæ•°æ®ç›®å½• é»˜è®¤ä¼šä»&#x2F;etc&#x2F;my.cnfä¸­å¯»æ‰¾ æ‰€ä»¥é…ç½®æ–‡ä»¶ä¸­éœ€è¦æŒ‡å®šæ•°æ®åº“ç›®å½•</p></blockquote><p>ç»™æ‹·è´çš„dataç›®å½•æƒé™</p><pre class=" language-bash"><code class="language-bash"><span class="token function">chown</span> -R mysql:mysql /application/mysql/data/</code></pre><p>å¯åŠ¨æ•°æ®åº“</p><pre class=" language-bash"><code class="language-bash">/etc/init.d/mysqld startStarting MySQL.Logging to <span class="token string">'/application/mysql/data/db.err'</span><span class="token keyword">.</span>SUCCESS<span class="token operator">!</span></code></pre><p>ç¡®è®¤æ•°æ®æ¢å¤</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> <span class="token keyword">backup</span>             <span class="token operator">|</span><span class="token operator">|</span> binlog             <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> ceshi              <span class="token operator">|</span><span class="token operator">|</span> chayi              <span class="token operator">|</span><span class="token operator">|</span> chayi2             <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">db1</span>                <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">db2</span>                <span class="token operator">|</span><span class="token operator">|</span> hhhh               <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> huhuhahei1         <span class="token operator">|</span><span class="token operator">|</span> inc1               <span class="token operator">|</span><span class="token operator">|</span> inc2               <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> oldboy             <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> slow_query_log     <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> test_binlog        <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">|</span> world              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">22</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec</code></pre><hr><h1 id="å››ã€æµ‹è¯•å¢é‡å¤‡ä»½"><a href="#å››ã€æµ‹è¯•å¢é‡å¤‡ä»½" class="headerlink" title="å››ã€æµ‹è¯•å¢é‡å¤‡ä»½"></a>å››ã€æµ‹è¯•å¢é‡å¤‡ä»½</h1><p>å…ˆè¿›è¡Œå…¨é‡å¤‡ä»½</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp /backup/full</code></pre><p>æ¨¡æ‹Ÿå¢åŠ æ•°æ®</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test1<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> test1<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> test1<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> test1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>è¿›è¡Œå¢é‡å¤‡ä»½</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp --incremental --incremental-basedir<span class="token operator">=</span>/backup/full /backup/test1--incrementalï¼šå¼€å¯å¢é‡å¤‡ä»½åŠŸèƒ½--incremental-basedirï¼šä¸Šä¸€æ¬¡å¤‡ä»½çš„è·¯å¾„</code></pre><p>ç¡®è®¤å¤‡ä»½æ˜¯å¦å®Œæ•´</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å…¨å¤‡</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-backupedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160492594last_lsn <span class="token operator">=</span> 160492594compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#å¢å¤‡</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test1/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160492594to_lsn <span class="token operator">=</span> 160498235last_lsn <span class="token operator">=</span> 160498235compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>å¯ä»¥çœ‹åˆ°å¢å¤‡çš„from_lsnæ˜¯å…¨å¤‡çš„last_lsn è¯æ˜æ•°æ®æ˜¯å®Œæ•´çš„</p><p>å†æ¬¡æ¨¡æ‹Ÿå¢åŠ æ•°æ®</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test2<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> test2<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> test2<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> test2 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">3</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test2<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>è¿›è¡Œç¬¬äºŒæ¬¡å¢é‡å¤‡ä»½</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp --incremental --incremental-basedir<span class="token operator">=</span>/backup/test1 /backup/test2</code></pre><p>å†æ¬¡ç¡®è®¤å¤‡ä»½å®Œæ•´æ€§</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å…¨å¤‡</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-backupedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160492594last_lsn <span class="token operator">=</span> 160492594compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#å¢å¤‡</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test1/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160492594to_lsn <span class="token operator">=</span> 160498235last_lsn <span class="token operator">=</span> 160498235compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#äºŒæ¬¡å¢å¤‡</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test2/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160498235to_lsn <span class="token operator">=</span> 160503761last_lsn <span class="token operator">=</span> 160503761compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>å¯ä»¥å‘ç°æ•°æ®æ˜¯å®Œæ•´çš„</p><p>æ¨¡æ‹Ÿæ•°æ®ä¸¢å¤±</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å…³é—­æ•°æ®åº“</span>/etc/init.d/mysqld stopShutting down MySQL<span class="token punctuation">..</span> SUCCESS<span class="token comment" spellcheck="true">#åˆ é™¤æ•°æ®ç›®å½•</span><span class="token function">rm</span> -rf /application/mysql/data/</code></pre><p>å‡†å¤‡å¤‡ä»½<br>1ï¼‰full+inc1+inc2<br>2ï¼‰éœ€è¦å°†inc1å’Œinc2æŒ‰é¡ºåºåˆå¹¶åˆ°fullä¸­<br>3ï¼‰åˆ†æ­¥éª¤è¿›è¡Œâ€“apply-log</p><p>ç¬¬ä¸€æ­¥ï¼šåœ¨å…¨å¤‡ä¸­apply-logæ—¶ï¼Œåªåº”ç”¨redoï¼Œä¸åº”ç”¨undo</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --redo-only /backup/full</code></pre><p>ç¬¬äºŒæ­¥ï¼šåˆå¹¶inc1åˆå¹¶åˆ°fullä¸­ï¼Œå¹¶ä¸”apply-logï¼Œåªåº”ç”¨redoï¼Œä¸åº”ç”¨undo</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --redo-only --incremental-dir<span class="token operator">=</span>/backup/test1 /backup/full</code></pre><p>ç¬¬ä¸‰æ­¥ï¼šåˆå¹¶inc2åˆå¹¶åˆ°fullä¸­ï¼Œredoå’Œundoéƒ½åº”ç”¨</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --incremental-dir<span class="token operator">=</span>/backup/test2 /backup/full</code></pre><p>ç¬¬å››æ­¥ï¼šæ•´ä½“fullæ‰§è¡Œapply-logï¼Œredoå’Œundoéƒ½åº”ç”¨</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log /backup/full</code></pre><p>ç¡®è®¤æ•°æ®å®Œæ•´</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-preparedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160503761last_lsn <span class="token operator">=</span> 160503761compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>æ¢å¤æ•°æ®</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æ‹·è´æ•°æ®</span>innobackupex --copy-back /backup/full<span class="token comment" spellcheck="true">#æƒé™</span><span class="token function">chown</span> -R mysql:mysql /application/mysql/data<span class="token comment" spellcheck="true">#å¯åŠ¨</span>/etc/init.d/mysqld start</code></pre><p>ç¡®è®¤æ•°æ®æ˜¯å¦æ¢å¤</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test1<span class="token punctuation">.</span>test1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> secmysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test2<span class="token punctuation">.</span>test2<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><h1 id="äº”ã€æµ‹è¯•å·®å¼‚å¤‡ä»½"><a href="#äº”ã€æµ‹è¯•å·®å¼‚å¤‡ä»½" class="headerlink" title="äº”ã€æµ‹è¯•å·®å¼‚å¤‡ä»½"></a>äº”ã€æµ‹è¯•å·®å¼‚å¤‡ä»½</h1><p>é¦–å…ˆè¿˜æ˜¯è¿›è¡Œå¢é‡å¤‡ä»½</p><pre class=" language-bash"><code class="language-bash">innobackupex --no-timestamp /backup/full</code></pre><p>æ¨¡æ‹Ÿæ•°æ®å˜æ›´</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> chayi1<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> chayi1<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ERROR <span class="token number">1046</span> <span class="token punctuation">(</span>3D000<span class="token punctuation">)</span>: <span class="token keyword">No</span> <span class="token keyword">database</span> selectedmysql<span class="token operator">></span> <span class="token keyword">use</span> chayi1<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> chayi1<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> chayi1 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">2</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>æ¨¡æ‹Ÿç¬¬äºŒæ¬¡æ•°æ®å˜åŒ–</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> chayi2<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">use</span> chayi2<span class="token punctuation">;</span><span class="token keyword">Database</span> changedmysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">table</span> chayi22<span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> secï¼‰mysql<span class="token operator">></span> <span class="token keyword">insert</span> <span class="token keyword">into</span> chayi22 <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">2</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi22<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>ç¡®è®¤æ•°æ®å®Œæ•´æ€§</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å…¨å¤‡</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat full/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> full-backupedfrom_lsn <span class="token operator">=</span> 0to_lsn <span class="token operator">=</span> 160504901last_lsn <span class="token operator">=</span> 160504901compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#ç¬¬ä¸€æ¬¡å·®å¼‚å¤‡ä»½</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat chayi1/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160504901to_lsn <span class="token operator">=</span> 160510578last_lsn <span class="token operator">=</span> 160510578compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0<span class="token comment" spellcheck="true">#ç¬¬äºŒæ¬¡å·®å¼‚å¤‡ä»½</span><span class="token punctuation">[</span>root@db backup<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat chayi2/xtrabackup_checkpoints</span>backup_type <span class="token operator">=</span> incrementalfrom_lsn <span class="token operator">=</span> 160504901to_lsn <span class="token operator">=</span> 160517449last_lsn <span class="token operator">=</span> 160517449compact <span class="token operator">=</span> 0recover_binlog_info <span class="token operator">=</span> 0</code></pre><p>å¯ä»¥å‘ç°å·®å¼‚å¤‡ä»½ç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡çš„èµ·ç‚¹éƒ½æ˜¯901</p><p>æ¨¡æ‹Ÿæ•°æ®ä¸¢å¤±</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#å…³é—­æ•°æ®åº“</span>/etc/init.d/mysqld stopShutting down MySQL<span class="token punctuation">..</span> SUCCESS<span class="token comment" spellcheck="true">#åˆ é™¤æ•°æ®ç›®å½•</span><span class="token function">rm</span> -rf /application/mysql/data/</code></pre><p>å‡†å¤‡æ•°æ®</p><p>ç¬¬ä¸€æ­¥ï¼šåœ¨å…¨å¤‡ä¸­apply-logæ—¶ï¼Œåªåº”ç”¨redoï¼Œä¸åº”ç”¨undo</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --redo-only /backup/full</code></pre><p>ç¬¬äºŒæ­¥ï¼šåˆå¹¶æœ€åä¸€æ¬¡å·®å¼‚å¤‡ä»½ï¼Œredo undoéƒ½åš</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log --incremental-dir<span class="token operator">=</span>/backup/chayi2 /backup/full</code></pre><p>ç¬¬ä¸‰æ­¥ï¼šæ•´ä½“fullæ‰§è¡Œapply-logï¼Œredoå’Œundoéƒ½åº”ç”¨</p><pre class=" language-bash"><code class="language-bash">innobackupex --apply-log /backup/full</code></pre><p>æ¢å¤æ•°æ®</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#æ‹·è´æ•°æ®</span>innobackupex --copy-back /backup/full<span class="token comment" spellcheck="true">#æƒé™</span><span class="token function">chown</span> -R mysql:mysql /application/mysql/data<span class="token comment" spellcheck="true">#å¯åŠ¨</span>/etc/init.d/mysqld start</code></pre><p>æµ‹è¯•æ•°æ®æ˜¯å¦æ¢å¤</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi1<span class="token punctuation">.</span>chayi1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> chayi2<span class="token punctuation">.</span>chayi22<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span> id   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlé€»è¾‘å¤‡ä»½ä¹‹Mysqldump</title>
      <link href="/23a9b713/"/>
      <url>/23a9b713/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€mysqldumpç®€ä»‹"><a href="#ä¸€ã€mysqldumpç®€ä»‹" class="headerlink" title="ä¸€ã€mysqldumpç®€ä»‹"></a>ä¸€ã€mysqldumpç®€ä»‹</h1><p><code>mysqldump</code>æ˜¯<code>mysql</code>è‡ªå¸¦çš„é€»è¾‘å¤‡ä»½å·¥å…·ï¼Œå®ƒçš„å¤‡ä»½åŸç†æ˜¯é€šè¿‡åè®®è¿æ¥åˆ° <code>MySQL</code> æ•°æ®åº“ï¼Œå°†éœ€è¦å¤‡ä»½çš„æ•°æ®æŸ¥è¯¢å‡ºæ¥ï¼Œå°†æŸ¥è¯¢å‡ºçš„æ•°æ®è½¬æ¢æˆå¯¹åº”çš„<code>insert</code> è¯­å¥ï¼Œå½“æˆ‘ä»¬éœ€è¦è¿˜åŸè¿™äº›æ•°æ®æ—¶ï¼Œåªè¦æ‰§è¡Œè¿™äº› <code>insert</code> è¯­å¥ï¼Œå³å¯å°†å¯¹åº”çš„æ•°æ®è¿˜åŸã€‚</p><hr><h1 id="äºŒã€å¤‡ä»½å‘½ä»¤"><a href="#äºŒã€å¤‡ä»½å‘½ä»¤" class="headerlink" title="äºŒã€å¤‡ä»½å‘½ä»¤"></a>äºŒã€å¤‡ä»½å‘½ä»¤</h1><p><strong>2.1å‘½ä»¤æ ¼å¼</strong></p><pre class=" language-mysql"><code class="language-mysql">mysqldump [é€‰é¡¹] æ•°æ®åº“å [è¡¨å] > è„šæœ¬å</code></pre><p><strong>2.2 é€‰é¡¹è¯´æ˜</strong></p><table><thead><tr><th>å‚æ•°å</th><th>ç¼©å†™</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>â€“host</td><td>-h</td><td>æœåŠ¡å™¨IPåœ°å€</td></tr><tr><td>â€“port</td><td>-P</td><td>æœåŠ¡å™¨ç«¯å£å·</td></tr><tr><td>â€“user</td><td>-u</td><td>MySQL ç”¨æˆ·å</td></tr><tr><td>â€“pasword</td><td>-p</td><td>MySQL å¯†ç </td></tr><tr><td>â€“databases</td><td></td><td>æŒ‡å®šè¦å¤‡ä»½çš„æ•°æ®åº“</td></tr><tr><td>â€“all-databases</td><td></td><td>å¤‡ä»½mysqlæœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰æ•°æ®åº“</td></tr><tr><td>â€“compact</td><td></td><td>å‹ç¼©æ¨¡å¼ï¼Œäº§ç”Ÿæ›´å°‘çš„è¾“å‡º</td></tr><tr><td>â€“comments</td><td></td><td>æ·»åŠ æ³¨é‡Šä¿¡æ¯</td></tr><tr><td>â€“complete-insert</td><td></td><td>è¾“å‡ºå®Œæˆçš„æ’å…¥è¯­å¥</td></tr><tr><td>â€“lock-tables</td><td></td><td>å¤‡ä»½å‰ï¼Œé”å®šæ‰€æœ‰æ•°æ®åº“è¡¨</td></tr><tr><td>â€“no-create-db&#x2F;â€“no-create-info</td><td></td><td>ç¦æ­¢ç”Ÿæˆåˆ›å»ºæ•°æ®åº“è¯­å¥</td></tr><tr><td>â€“force</td><td></td><td>å½“å‡ºç°é”™è¯¯æ—¶ä»ç„¶ç»§ç»­å¤‡ä»½æ“ä½œ</td></tr><tr><td>â€“default-character-set</td><td></td><td>æŒ‡å®šé»˜è®¤å­—ç¬¦é›†</td></tr><tr><td>â€“add-locks</td><td></td><td>å¤‡ä»½æ•°æ®åº“è¡¨æ—¶é”å®šæ•°æ®åº“è¡¨</td></tr></tbody></table><p><strong>2.3æ¼”ç¤º</strong><br>å¤‡ä»½æŒ‡å®šæ•°æ®åº“</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -uroot -p -h 172.19.0.3 typecho > typecho.sql</code></pre><p>å¤‡ä»½æ‰€æœ‰æ•°æ®åº“</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -uroot -p --all-databases > all.db</code></pre><p>å¤‡ä»½æŒ‡å®šæ•°æ®åº“æŒ‡å®šè¡¨</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -u root -p -h 172.19.0.3 typecho.typecho_access_log > typecho.db2</code></pre><p>å¤‡ä»½æŒ‡å®šæ’é™¤æŸäº›è¡¨</p><pre class=" language-mysql"><code class="language-mysql">mysqldump -uroot -p test --ignore-table=test.t1 --ignore-table=test.t2 > /backup/mysqldump/test2.db</code></pre><p>-Bï¼šæŒ‡å®šåº“å¤‡ä»½</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>B <span class="token number">db1</span> <span class="token operator">></span><span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span><span class="token number">db2</span><span class="token punctuation">.</span>sql</code></pre><p>-dï¼šä»…è¡¨ç»“æ„</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span><span class="token number">d</span> <span class="token comment" spellcheck="true">--master-data=1 >/backup/full4.sql</span></code></pre><p>-tï¼šä»…æ•°æ®</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span>t <span class="token comment" spellcheck="true">--master-data=1 >/backup/full4.sql</span></code></pre><p>â€“single-transactionï¼šå¿«ç…§å¤‡ä»½ï¼ˆçƒ­å¤‡ï¼‰</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span>R <span class="token comment" spellcheck="true">--triggers --single-transaction --master-data=2 >/backup/full6.sql</span></code></pre><p>gzip:å‹ç¼©å¤‡ä»½ï¼ˆçƒ­å¤‡å¸¸ç”¨ï¼‰</p><pre class=" language-sql"><code class="language-sql">mysqldump <span class="token operator">-</span>A <span class="token operator">-</span>R <span class="token comment" spellcheck="true">--triggers --single-transaction --master-data=2 | gzip >/backup/full_$(date +%F).sql.gz</span><span class="token comment" spellcheck="true">#zcatç›´æ¥å¯¼å‡ºå‹ç¼©</span>zcat <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span>full1<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>gz <span class="token operator">></span> <span class="token operator">/</span><span class="token keyword">backup</span><span class="token operator">/</span>full2<span class="token punctuation">.</span>sql</code></pre><hr><h1 id="ä¸‰ã€æ•°æ®å¯¼å…¥"><a href="#ä¸‰ã€æ•°æ®å¯¼å…¥" class="headerlink" title="ä¸‰ã€æ•°æ®å¯¼å…¥"></a>ä¸‰ã€æ•°æ®å¯¼å…¥</h1><p>3.1dbå‘½ä»¤å¯¼å…¥ï¼ˆéœ€è¦ç¡®è®¤è¿™ä¸ªåº“æˆ–è€…è¡¨å­˜åœ¨ï¼‰</p><pre class=" language-mysql"><code class="language-mysql">mysql -u root -p -h 10.102.175.143 typecho < ./typecho.sql</code></pre><p>3.2 soureå¯¼å…¥</p><pre class=" language-mysql"><code class="language-mysql">mysql > use db_namemysql > source /backup/mysqldump/db_name.db</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlå»¶è¿Ÿå¤åˆ¶ã€åŠåŒæ­¥å¤åˆ¶ã€è¿‡æ»¤å¤åˆ¶ã€GTIDå¤åˆ¶</title>
      <link href="/b0f44f6e/"/>
      <url>/b0f44f6e/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€å»¶è¿Ÿå¤åˆ¶"><a href="#ä¸€ã€å»¶è¿Ÿå¤åˆ¶" class="headerlink" title="ä¸€ã€å»¶è¿Ÿå¤åˆ¶"></a>ä¸€ã€å»¶è¿Ÿå¤åˆ¶</h1><h2 id="ä¸»åº“æ“ä½œ"><a href="#ä¸»åº“æ“ä½œ" class="headerlink" title="ä¸»åº“æ“ä½œ"></a>ä¸»åº“æ“ä½œ</h2><p>ä¿®æ”¹é…ç½®æ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span><span class="token comment" spellcheck="true">#å¼€å¯binlog</span>log-bin<span class="token operator">=</span>mysql-binbinlog_format<span class="token operator">=</span>row<span class="token comment" spellcheck="true">#è®¾ç½®server_id</span>server_id<span class="token operator">=</span>1</code></pre><p>é‡å¯db</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># /etc/init.d/mysqld restart</span>Shutting down MySQL<span class="token punctuation">..</span><span class="token punctuation">..</span> SUCCESS<span class="token operator">!</span>Starting MySQL. SUCCESS<span class="token operator">!</span></code></pre><p>æ•°æ®åº“ä¸­åˆ›å»ºå¤åˆ¶ç”¨æˆ·</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">grant</span> <span class="token keyword">replication</span> slave <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> rep@'<span class="token operator">%</span><span class="token string">' indetified by '</span><span class="token number">123456</span>'<span class="token punctuation">;</span></code></pre><hr><h2 id="ä»åº“æ“ä½œ"><a href="#ä»åº“æ“ä½œ" class="headerlink" title="ä»åº“æ“ä½œ"></a>ä»åº“æ“ä½œ</h2><p>ä¿®æ”¹é…ç½®æ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#è®¾ç½®server_id éœ€è¦ä¸ç­‰äº1</span>server_id<span class="token operator">=</span>7</code></pre><p>æŸ¥çœ‹ä¸»åº“binlog</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+----------+--------------+------------------+-------------------+</span><span class="token operator">|</span> <span class="token keyword">File</span>             <span class="token operator">|</span> Position <span class="token operator">|</span> Binlog_Do_DB <span class="token operator">|</span> Binlog_Ignore_DB <span class="token operator">|</span> Executed_Gtid_Set <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+----------+--------------+------------------+-------------------+</span><span class="token operator">|</span> mysql<span class="token operator">-</span>bin<span class="token number">.000006</span> <span class="token operator">|</span>      <span class="token number">120</span> <span class="token operator">|</span>              <span class="token operator">|</span>                  <span class="token operator">|</span>                   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+----------+--------------+------------------+-------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>ä»åº“change master</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> change master <span class="token keyword">to</span> master_host<span class="token operator">=</span><span class="token string">'192.168.0.49'</span><span class="token punctuation">,</span>master_user<span class="token operator">=</span><span class="token string">'rep'</span><span class="token punctuation">,</span>master_password<span class="token operator">=</span><span class="token string">'123456'</span><span class="token punctuation">,</span>master_log_file<span class="token operator">=</span><span class="token string">'mysql-bin.000006'</span><span class="token punctuation">,</span>master_log_pos<span class="token operator">=</span><span class="token number">120</span><span class="token punctuation">,</span>master_delay<span class="token operator">=</span><span class="token number">3600</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token keyword">warnings</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">start</span> slave<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event                  Master_Host: <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.49</span>                  Master_User: rep                  Master_Port: <span class="token number">3306</span>                Connect_Retry: <span class="token number">60</span>              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000006</span>   <span class="token comment" spellcheck="true">#ä¸»åº“ç›®å‰çš„binlogæ—¥å¿—</span>          Read_Master_Log_Pos: <span class="token number">120</span>              <span class="token comment" spellcheck="true">#ä¸»åº“ç›®å‰çš„binlogæ—¥å¿—posç‚¹</span>               Relay_Log_File: <span class="token number">db</span><span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token number">.000002</span>                                                Relay_Log_Pos: <span class="token number">283</span>        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000006</span>             Slave_IO_Running: Yes            Slave_SQL_Running: Yes              Replicate_Do_DB:          Replicate_Ignore_DB:           Replicate_Do_Table:       Replicate_Ignore_Table:      Replicate_Wild_Do_Table:  Replicate_Wild_Ignore_Table:                   Last_Errno: <span class="token number">0</span>                   Last_Error:                 Skip_Counter: <span class="token number">0</span>          Exec_Master_Log_Pos: <span class="token number">120</span>              Relay_Log_Space: <span class="token number">453</span>              Until_Condition: None               Until_Log_File:                Until_Log_Pos: <span class="token number">0</span>           Master_SSL_Allowed: <span class="token keyword">No</span>           Master_SSL_CA_File:           Master_SSL_CA_Path:              Master_SSL_Cert:            Master_SSL_Cipher:               Master_SSL_Key:        Seconds_Behind_Master: <span class="token number">0</span>Master_SSL_Verify_Server_Cert: <span class="token keyword">No</span>                Last_IO_Errno: <span class="token number">0</span>                Last_IO_Error:               Last_SQL_Errno: <span class="token number">0</span>               Last_SQL_Error:  Replicate_Ignore_Server_Ids:             Master_Server_Id: <span class="token number">1</span>                  Master_UUID: <span class="token number">32ab32d8</span><span class="token operator">-</span><span class="token number">414f</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">9cba</span><span class="token operator">-</span><span class="token number">5254003a3847</span>             Master_Info_File: <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span><span class="token number">3307</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>master<span class="token punctuation">.</span>info                    SQL_Delay: <span class="token number">3600</span>                  <span class="token comment" spellcheck="true">#ä»åº“å»¶è¿Ÿ3600sæ‰§è¡Œsql</span>          SQL_Remaining_Delay: <span class="token boolean">NULL</span>        <span class="token comment" spellcheck="true">#è·ç¦»ä¸‹æ¬¡æ‰§è¡Œsqlçš„æ—¶é—´</span>      Slave_SQL_Running_State: Slave has <span class="token keyword">read</span> <span class="token keyword">all</span> relay log<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> the slave I<span class="token operator">/</span>O thread <span class="token keyword">to</span> <span class="token keyword">update</span> it           Master_Retry_Count: <span class="token number">86400</span>                  Master_Bind:      Last_IO_Error_Timestamp:     Last_SQL_Error_Timestamp:               Master_SSL_Crl:           Master_SSL_Crlpath:           Retrieved_Gtid_Set:            Executed_Gtid_Set:                Auto_Position: <span class="token number">0</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="äºŒã€åŠåŒæ­¥å¤åˆ¶"><a href="#äºŒã€åŠåŒæ­¥å¤åˆ¶" class="headerlink" title="äºŒã€åŠåŒæ­¥å¤åˆ¶"></a>äºŒã€åŠåŒæ­¥å¤åˆ¶</h1><h2 id="ä¸»åº“æ“ä½œ-1"><a href="#ä¸»åº“æ“ä½œ-1" class="headerlink" title="ä¸»åº“æ“ä½œ"></a>ä¸»åº“æ“ä½œ</h2><p>å¼€å¯åŠåŒæ­¥é…ç½®</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#æŸ¥çœ‹æ˜¯å¦æ”¯æŒåŠ¨æ€å¼€å¯</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> variables <span class="token operator">like</span> <span class="token string">'have_dynamic_loading'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token operator">|</span> Variable_name        <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token operator">|</span> have_dynamic_loading <span class="token operator">|</span> YES   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------------------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#å®‰è£…æ’ä»¶</span>mysql<span class="token operator">></span> INSTALL PLUGIN rpl_semi_sync_master <span class="token keyword">SONAME</span><span class="token string">'semisync_master.so'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#å¼€å¯æ’ä»¶</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#è®¾ç½®é»˜è®¤çš„è¶…æ—¶æ—¶é—´</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_master_timeout <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span><span class="token string">'rpl%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------------------------+----------+</span><span class="token operator">|</span> Variable_name                      <span class="token operator">|</span> <span class="token keyword">Value</span>    <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------------------------+----------+</span><span class="token operator">|</span> rpl_semi_sync_master_enabled       <span class="token operator">|</span> <span class="token keyword">ON</span>       <span class="token operator">|</span><span class="token operator">|</span> rpl_semi_sync_master_timeout       <span class="token operator">|</span> <span class="token number">1000</span>     <span class="token operator">|</span><span class="token operator">|</span> rpl_semi_sync_master_trace_level   <span class="token operator">|</span> <span class="token number">32</span>       <span class="token operator">|</span><span class="token operator">|</span> rpl_semi_sync_master_wait_no_slave <span class="token operator">|</span> <span class="token keyword">ON</span>       <span class="token operator">|</span><span class="token operator">|</span> rpl_stop_slave_timeout             <span class="token operator">|</span> <span class="token number">31536000</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">------------------------------------+----------+</span><span class="token number">5</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>æ°¸ä¹…å¼€å¯</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>rpl_semi_sync_master_enabled<span class="token operator">=</span>1rpl_semi_sync_master_timeout<span class="token operator">=</span>1000</code></pre><hr><h2 id="ä»åº“æ“ä½œ-1"><a href="#ä»åº“æ“ä½œ-1" class="headerlink" title="ä»åº“æ“ä½œ"></a>ä»åº“æ“ä½œ</h2><p>å¼€å¯é…ç½®</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> INSTALL PLUGIN rpl_semi_sync_slave <span class="token keyword">SONAME</span><span class="token string">'semisync_slave.so'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_slave_enabled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#é‡å¯ioçº¿ç¨‹ï¼ˆå¦‚æœä¹‹å‰æ²¡æœ‰é…ç½®ä¸»ä»çš„è¯ è¿˜éœ€è¦change masterï¼‰</span>mysql<span class="token operator">></span> stop slave io_thread<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">start</span> slave io_thread<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>æŸ¥çœ‹å¹¶éªŒè¯</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#ä¸»åº“æ·»åŠ æ•°æ®æµ‹è¯•åŒæ­¥æƒ…å†µ</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test3<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test4<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">295</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">590</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">ON</span>    <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">416</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">833</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token comment" spellcheck="true">#è¿™é‡Œæ˜¯2 è¯æ˜åˆšæ‰ä¸¤æ¡sqlèµ°äº†åŠåŒæ­¥å¤åˆ¶</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#å…³é—­åŠåŒæ­¥åœ¨æµ‹è¯•</span>mysql<span class="token operator">></span> <span class="token keyword">SET</span> <span class="token keyword">GLOBAL</span> rpl_semi_sync_master_enabled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test5<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> test6<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'rpl_semi%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Variable_name                              <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token operator">|</span> Rpl_semi_sync_master_clients               <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_avg_wait_time     <span class="token operator">|</span> <span class="token number">295</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_wait_time         <span class="token operator">|</span> <span class="token number">590</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_net_waits             <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_times              <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_no_tx                 <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token comment" spellcheck="true">#OFFè¡¨ç¤ºåŠåŒæ­¥å…³é—­</span><span class="token operator">|</span> Rpl_semi_sync_master_status                <span class="token operator">|</span> <span class="token keyword">OFF</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_timefunc_failures     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_avg_wait_time      <span class="token operator">|</span> <span class="token number">416</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_wait_time          <span class="token operator">|</span> <span class="token number">833</span>   <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_tx_waits              <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_pos_backtraverse <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token operator">|</span> Rpl_semi_sync_master_wait_sessions         <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span><span class="token comment" spellcheck="true">#è¿˜æ˜¯2è¯æ˜åˆšæ‰ä¸¤æ¡sql æ²¡æœ‰èµ°åŠåŒæ­¥</span><span class="token operator">|</span> Rpl_semi_sync_master_yes_tx                <span class="token operator">|</span> <span class="token number">2</span>     <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------------------------------+-------+</span><span class="token number">14</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><hr><h1 id="ä¸‰ã€è¿‡æ»¤å¤åˆ¶"><a href="#ä¸‰ã€è¿‡æ»¤å¤åˆ¶" class="headerlink" title="ä¸‰ã€è¿‡æ»¤å¤åˆ¶"></a>ä¸‰ã€è¿‡æ»¤å¤åˆ¶</h1><h2 id="é…ç½®å‚æ•°"><a href="#é…ç½®å‚æ•°" class="headerlink" title="é…ç½®å‚æ•°"></a>é…ç½®å‚æ•°</h2><p>å¯ä»¥é€‰æ‹©åœ¨ä¸»åº“é…ç½® ä¹Ÿå¯ä»¥åœ¨ä»åº“</p><p>ä¸»åº“ï¼š</p><p>ç™½åå•:åªè®°å½•ç™½åå•ä¸­åˆ—å‡ºçš„åº“çš„äºŒè¿›åˆ¶æ—¥å¿—</p><pre class=" language-bash"><code class="language-bash">binlog-do-db</code></pre><p>é»‘åå•ï¼šä¸è®°å½•é»‘åå•åˆ—å‡ºçš„åº“çš„äºŒè¿›åˆ¶æ—¥å¿—</p><pre class=" language-bash"><code class="language-bash">binlog-ignore-db</code></pre><p>ä»åº“ï¼š</p><p>ç™½åå•ï¼šåªæ‰§è¡Œç™½åå•ä¸­åˆ—å‡ºçš„åº“æˆ–è€…è¡¨çš„ä¸­ç»§æ—¥å¿—</p><pre class=" language-bash"><code class="language-bash">--replicate-do-db<span class="token operator">=</span>test--replicate-do-table<span class="token operator">=</span>test.t1--replicate-wild-do-table<span class="token operator">=</span>test.t2</code></pre><p>é»‘åå•ï¼šä¸æ‰§è¡Œé»‘åå•ä¸­åˆ—å‡ºçš„åº“æˆ–è€…è¡¨çš„ä¸­ç»§æ—¥å¿—</p><pre class=" language-bash"><code class="language-bash">--replicate-ignore-db--replicate-ignore-table--replicate-wild-ignore-table</code></pre><p>è¿™é‡Œæµ‹è¯•ä»åº“é…ç½®</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#é…ç½®æ–‡ä»¶æ·»åŠ </span>replicate<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span><span class="token number">db</span><span class="token operator">=</span>wangzherongyao<span class="token comment" spellcheck="true">#é‡å¯ä»åº“ç”Ÿæ•ˆ</span>mysqladmin <span class="token operator">-</span>uroot <span class="token operator">-</span>p3308 <span class="token operator">-</span>S <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span><span class="token number">3308</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>mysql<span class="token punctuation">.</span>sock <span class="token keyword">shutdown</span>mysqld_safe <span class="token comment" spellcheck="true">--defaults-file=/data/3308/my.conf &amp;</span></code></pre><p>æŸ¥çœ‹å¤åˆ¶çŠ¶æ€ï¼ˆä¸€æ ·éœ€è¦ä¹‹å‰é…ç½®ä¸»ä»ï¼‰</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event                  Master_Host: <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.49</span>                  Master_User: rep                  Master_Port: <span class="token number">3306</span>                Connect_Retry: <span class="token number">60</span>              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000009</span>          Read_Master_Log_Pos: <span class="token number">335</span>               Relay_Log_File: <span class="token number">db</span><span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token number">.000010</span>                Relay_Log_Pos: <span class="token number">498</span>        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000009</span>             Slave_IO_Running: Yes            Slave_SQL_Running: Yes              Replicate_Do_DB: wangzherongyao  <span class="token comment" spellcheck="true">#è¿™é‡Œæ˜¾ç¤ºçš„å°±æ˜¯å¤åˆ¶ç™½åå•</span></code></pre><p>æµ‹è¯•</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#ä¸»åº“åˆ›å»ºæ•°æ®</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> wangzherongyao<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">create</span> <span class="token keyword">database</span> lol<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> <span class="token keyword">backup</span>             <span class="token operator">|</span><span class="token operator">|</span> binlog             <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> ceshi              <span class="token operator">|</span><span class="token operator">|</span> chayi1             <span class="token operator">|</span><span class="token operator">|</span> chayi2             <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> huhuhahei1         <span class="token operator">|</span><span class="token operator">|</span> lol                <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> oldboy             <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> slow_query_log     <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> test1              <span class="token operator">|</span><span class="token operator">|</span> test2              <span class="token operator">|</span><span class="token operator">|</span> test3              <span class="token operator">|</span><span class="token operator">|</span> test4              <span class="token operator">|</span><span class="token operator">|</span> test5              <span class="token operator">|</span><span class="token operator">|</span> test6              <span class="token operator">|</span><span class="token operator">|</span> test_binlog        <span class="token operator">|</span><span class="token operator">|</span> wangzherongyao     <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">|</span> world              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">25</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#ä»åº“æŸ¥çœ‹</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">databases</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> <span class="token keyword">Database</span>           <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token operator">|</span> information_schema <span class="token operator">|</span><span class="token operator">|</span> <span class="token keyword">backup</span>             <span class="token operator">|</span><span class="token operator">|</span> binlog             <span class="token operator">|</span><span class="token operator">|</span> blog               <span class="token operator">|</span><span class="token operator">|</span> ceshi              <span class="token operator">|</span><span class="token operator">|</span> chayi1             <span class="token operator">|</span><span class="token operator">|</span> chayi2             <span class="token operator">|</span><span class="token operator">|</span> huhuhahei          <span class="token operator">|</span><span class="token operator">|</span> huhuhahei1         <span class="token operator">|</span><span class="token operator">|</span> mysql              <span class="token operator">|</span><span class="token operator">|</span> oldboy             <span class="token operator">|</span><span class="token operator">|</span> performance_schema <span class="token operator">|</span><span class="token operator">|</span> slow_query_log     <span class="token operator">|</span><span class="token operator">|</span> test               <span class="token operator">|</span><span class="token operator">|</span> test1              <span class="token operator">|</span><span class="token operator">|</span> test2              <span class="token operator">|</span><span class="token operator">|</span> test3              <span class="token operator">|</span><span class="token operator">|</span> test4              <span class="token operator">|</span><span class="token operator">|</span> test5              <span class="token operator">|</span><span class="token operator">|</span> test6              <span class="token operator">|</span><span class="token operator">|</span> test_binlog        <span class="token operator">|</span><span class="token operator">|</span> wangzherongyao     <span class="token operator">|</span><span class="token operator">|</span> wordpress          <span class="token operator">|</span><span class="token operator">|</span> world              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">--------------------+</span><span class="token number">24</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#å¯ä»¥å‘ç°ä»åº“æ˜¯æ²¡æœ‰æ–°åˆ›å»ºçš„lolåº“çš„ åªå¤åˆ¶äº†wangzherongyao</span></code></pre><h1 id="å››ã€GTIDå¤åˆ¶"><a href="#å››ã€GTIDå¤åˆ¶" class="headerlink" title="å››ã€GTIDå¤åˆ¶"></a>å››ã€GTIDå¤åˆ¶</h1><h2 id="é…ç½®æ–‡ä»¶éœ€è¦æ·»åŠ å‚æ•°"><a href="#é…ç½®æ–‡ä»¶éœ€è¦æ·»åŠ å‚æ•°" class="headerlink" title="é…ç½®æ–‡ä»¶éœ€è¦æ·»åŠ å‚æ•°"></a>é…ç½®æ–‡ä»¶éœ€è¦æ·»åŠ å‚æ•°</h2><h2 id="ä¸»åº“"><a href="#ä¸»åº“" class="headerlink" title="ä¸»åº“"></a>ä¸»åº“</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#mysqldä¸‹æ·»åŠ  </span><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>gtid_mode<span class="token operator">=</span>ONenforce_gtid_consistencylog-slave-updatesbinlog_format<span class="token operator">=</span>rowlog-bin<span class="token operator">=</span>mysql-binserver_id<span class="token operator">=</span>1</code></pre><h2 id="ä»åº“"><a href="#ä»åº“" class="headerlink" title="ä»åº“"></a>ä»åº“</h2><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>gtid_mode<span class="token operator">=</span>ONenforce_gtid_consistencylog-slave-updatesserver_id<span class="token operator">=</span>5log-bin<span class="token operator">=</span>mysql-binbinlog_format<span class="token operator">=</span>row</code></pre><p>ä¿®æ”¹åéƒ½éœ€è¦é‡å¯</p><pre class=" language-bash"><code class="language-bash">/etc/init.d/mysqld restart</code></pre><p>åˆ›å»ºå¤åˆ¶ç”¨æˆ·</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">grant</span> <span class="token keyword">replication</span> slave <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> rep@'<span class="token operator">%</span><span class="token string">' identified by '</span><span class="token number">123</span>'<span class="token punctuation">;</span></code></pre><p>ä»åº“change master</p><pre class=" language-sql"><code class="language-sql">change master <span class="token keyword">to</span> master_host<span class="token operator">=</span><span class="token string">'10.60.222.142'</span><span class="token punctuation">,</span> master_user<span class="token operator">=</span><span class="token string">'rep'</span><span class="token punctuation">,</span>master_password<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">,</span>master_auto_position<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span></code></pre><p>æŸ¥çœ‹</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1</span><span class="token punctuation">.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>               Slave_IO_State: Waiting <span class="token keyword">for</span> master <span class="token keyword">to</span> send event                  Master_Host: <span class="token number">10.60</span><span class="token punctuation">.</span><span class="token number">222.142</span>                  Master_User: rep                  Master_Port: <span class="token number">3306</span>                Connect_Retry: <span class="token number">60</span>              Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000001</span>          Read_Master_Log_Pos: <span class="token number">2009</span>               Relay_Log_File: <span class="token number">10</span><span class="token operator">-</span><span class="token number">60</span><span class="token operator">-</span><span class="token number">92</span><span class="token operator">-</span><span class="token number">80</span><span class="token operator">-</span>relay<span class="token operator">-</span>bin<span class="token number">.000002</span>                Relay_Log_Pos: <span class="token number">2219</span>        Relay_Master_Log_File: mysql<span class="token operator">-</span>bin<span class="token number">.000001</span>             Slave_IO_Running: Yes            Slave_SQL_Running: Yes              Replicate_Do_DB:          Replicate_Ignore_DB:           Replicate_Do_Table:       Replicate_Ignore_Table:      Replicate_Wild_Do_Table:  Replicate_Wild_Ignore_Table:                   Last_Errno: <span class="token number">0</span>                   Last_Error:                 Skip_Counter: <span class="token number">0</span>          Exec_Master_Log_Pos: <span class="token number">2009</span>              Relay_Log_Space: <span class="token number">2429</span>              Until_Condition: None               Until_Log_File:                Until_Log_Pos: <span class="token number">0</span>           Master_SSL_Allowed: <span class="token keyword">No</span>           Master_SSL_CA_File:           Master_SSL_CA_Path:              Master_SSL_Cert:            Master_SSL_Cipher:               Master_SSL_Key:        Seconds_Behind_Master: <span class="token number">0</span>Master_SSL_Verify_Server_Cert: <span class="token keyword">No</span>                Last_IO_Errno: <span class="token number">0</span>                Last_IO_Error:               Last_SQL_Errno: <span class="token number">0</span>               Last_SQL_Error:  Replicate_Ignore_Server_Ids:             Master_Server_Id: <span class="token number">1</span>                  Master_UUID: <span class="token number">4c8ebc2b</span><span class="token operator">-</span><span class="token number">42d5</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">a6aa</span><span class="token operator">-</span><span class="token number">52540094f3a0</span>             Master_Info_File: <span class="token operator">/</span>application<span class="token operator">/</span>mysql<span class="token number">-5.6</span><span class="token punctuation">.</span><span class="token number">40</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>master<span class="token punctuation">.</span>info                    SQL_Delay: <span class="token number">0</span>          SQL_Remaining_Delay: <span class="token boolean">NULL</span>      Slave_SQL_Running_State: Slave has <span class="token keyword">read</span> <span class="token keyword">all</span> relay log<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> the slave I<span class="token operator">/</span>O thread <span class="token keyword">to</span> <span class="token keyword">update</span> it           Master_Retry_Count: <span class="token number">86400</span>                  Master_Bind:      Last_IO_Error_Timestamp:     Last_SQL_Error_Timestamp:               Master_SSL_Crl:           Master_SSL_Crlpath:           Retrieved_Gtid_Set: <span class="token number">4c8ebc2b</span><span class="token operator">-</span><span class="token number">42d5</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">a6aa</span><span class="token operator">-</span><span class="token number">52540094f3a0</span>:<span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span>     <span class="token comment" spellcheck="true">#ioçº¿ç¨‹æ”¶åˆ°çš„GTID</span>            Executed_Gtid_Set: <span class="token number">4c8ebc2b</span><span class="token operator">-</span><span class="token number">42d5</span><span class="token operator">-</span><span class="token number">11ec</span><span class="token operator">-</span><span class="token number">a6aa</span><span class="token operator">-</span><span class="token number">52540094f3a0</span>:<span class="token number">1</span><span class="token operator">-</span><span class="token number">5</span>     <span class="token comment" spellcheck="true">#sqlçº¿ç¨‹æ‰§è¡Œçš„GTID</span>                Auto_Position: <span class="token number">1</span>              <span class="token comment" spellcheck="true">#æ˜¯å¦å¼€å¯GTID</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>ä¸»åº“æŸ¥çœ‹</p><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>processlist <span class="token keyword">where</span> Command <span class="token operator">like</span> <span class="token string">'%Binlog%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+---------------------+------+------------------+------+------------------------------------------------------------------+------+</span><span class="token operator">|</span> ID <span class="token operator">|</span> <span class="token keyword">USER</span> <span class="token operator">|</span> HOST                <span class="token operator">|</span> DB   <span class="token operator">|</span> COMMAND          <span class="token operator">|</span> TIME <span class="token operator">|</span> STATE                                                            <span class="token operator">|</span> INFO <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+---------------------+------+------------------+------+------------------------------------------------------------------+------+</span><span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> rep  <span class="token operator">|</span> <span class="token number">10.60</span><span class="token punctuation">.</span><span class="token number">157.113</span>:<span class="token number">24552</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Binlog <span class="token keyword">Dump</span> GTID <span class="token operator">|</span> <span class="token number">1284</span> <span class="token operator">|</span> Master has sent <span class="token keyword">all</span> binlog <span class="token keyword">to</span> slave<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> binlog <span class="token keyword">to</span> <span class="token number">be</span> up <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> rep  <span class="token operator">|</span> <span class="token number">10.60</span><span class="token punctuation">.</span><span class="token number">92.80</span>:<span class="token number">40700</span>   <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Binlog <span class="token keyword">Dump</span> GTID <span class="token operator">|</span> <span class="token number">1262</span> <span class="token operator">|</span> Master has sent <span class="token keyword">all</span> binlog <span class="token keyword">to</span> slave<span class="token punctuation">;</span> waiting <span class="token keyword">for</span> binlog <span class="token keyword">to</span> <span class="token number">be</span> up <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+---------------------+------+------------------+------+------------------------------------------------------------------+------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql ç´¢å¼•ç®¡ç†</title>
      <link href="/ad2c14ec/"/>
      <url>/ad2c14ec/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€ç´¢å¼•ç®—æ³•ç®€ä»‹"><a href="#ä¸€ã€ç´¢å¼•ç®—æ³•ç®€ä»‹" class="headerlink" title="ä¸€ã€ç´¢å¼•ç®—æ³•ç®€ä»‹"></a>ä¸€ã€ç´¢å¼•ç®—æ³•ç®€ä»‹</h1><h3 id="1-1-B-Tree"><a href="#1-1-B-Tree" class="headerlink" title="1.1 B+Tree"></a>1.1 B+Tree</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/460933094.png"></p><hr><h3 id="1-2-B-Tree"><a href="#1-2-B-Tree" class="headerlink" title="1.2 B*Tree"></a>1.2 B*Tree</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/11/3363888615.png"></p><hr><h1 id="äºŒã€ç´¢å¼•ç®¡ç†"><a href="#äºŒã€ç´¢å¼•ç®¡ç†" class="headerlink" title="äºŒã€ç´¢å¼•ç®¡ç†"></a>äºŒã€ç´¢å¼•ç®¡ç†</h1><h3 id="2-1-åŸºç¡€æ¦‚å¿µ"><a href="#2-1-åŸºç¡€æ¦‚å¿µ" class="headerlink" title="2.1 åŸºç¡€æ¦‚å¿µ"></a>2.1 åŸºç¡€æ¦‚å¿µ</h3><pre class=" language-sql"><code class="language-sql">ç´¢å¼•å»ºç«‹åœ¨è¡¨çš„åˆ—ä¸Š<span class="token punctuation">(</span>å­—æ®µ<span class="token punctuation">)</span>çš„ã€‚åœ¨<span class="token keyword">where</span>åé¢çš„åˆ—å»ºç«‹ç´¢å¼•æ‰ä¼šåŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚pages<span class="token operator">&lt;</span><span class="token comment" spellcheck="true">---ç´¢å¼•ï¼ˆå±æ€§ï¼‰&lt;----æŸ¥æ•°æ®ã€‚</span></code></pre><hr><h3 id="2-2-ç´¢å¼•åˆ†ç±»"><a href="#2-2-ç´¢å¼•åˆ†ç±»" class="headerlink" title="2.2 ç´¢å¼•åˆ†ç±»"></a>2.2 ç´¢å¼•åˆ†ç±»</h3><pre class=" language-sql"><code class="language-sql">ä¸»é”®ç´¢å¼•æ™®é€šç´¢å¼•<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>å”¯ä¸€ç´¢å¼•</code></pre><hr><h3 id="2-3-ç´¢å¼•åˆ›å»º"><a href="#2-3-ç´¢å¼•åˆ›å»º" class="headerlink" title="2.3 ç´¢å¼•åˆ›å»º"></a>2.3 ç´¢å¼•åˆ›å»º</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#åˆ›å»ºæ™®é€šç´¢å¼•</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_id<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#åˆ›å»ºä¸»é”®ç´¢å¼•</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> pri_name<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#åˆ›å»ºå”¯ä¸€ç´¢å¼•</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">unique</span> <span class="token keyword">key</span> uni_age<span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹ç´¢å¼•</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> student1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> <span class="token keyword">Table</span>    <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> Index_type <span class="token operator">|</span><span class="token keyword">Comment</span> <span class="token operator">|</span> Index_comment <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>  <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> name        <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span> uni_age  <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> age         <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_id   <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id          <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#åˆ é™¤ç´¢å¼•</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">drop</span> <span class="token keyword">key</span> idx_id<span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#æ·»åŠ å‰ç¼€ç´¢å¼•</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_name<span class="token punctuation">(</span>name<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment" spellcheck="true">#åˆ›å»ºè”åˆç´¢å¼•</span>mysql<span class="token operator">></span> <span class="token keyword">alter</span> <span class="token keyword">table</span> student1 <span class="token keyword">add</span> <span class="token keyword">index</span> idx_all<span class="token punctuation">(</span>id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>age<span class="token punctuation">,</span>sex<span class="token punctuation">)</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>Records: <span class="token number">0</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>mysql<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">index</span> <span class="token keyword">from</span> student1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> <span class="token keyword">Table</span>    <span class="token operator">|</span> Non_unique <span class="token operator">|</span> Key_name <span class="token operator">|</span> Seq_in_index <span class="token operator">|</span> Column_name <span class="token operator">|</span> Collation <span class="token operator">|</span> Cardinality <span class="token operator">|</span> Sub_part <span class="token operator">|</span> Packed <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> Index_type <span class="token operator">|</span><span class="token keyword">Comment</span> <span class="token operator">|</span> Index_comment <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span> id          <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">2</span> <span class="token operator">|</span> name        <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span>      <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">3</span> <span class="token operator">|</span> age         <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">|</span> student1 <span class="token operator">|</span>          <span class="token number">1</span> <span class="token operator">|</span> idx_all  <span class="token operator">|</span>            <span class="token number">4</span> <span class="token operator">|</span> sex         <span class="token operator">|</span> A         <span class="token operator">|</span>           <span class="token number">0</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>   <span class="token operator">|</span> YES  <span class="token operator">|</span> <span class="token keyword">BTREE</span>      <span class="token operator">|</span>        <span class="token operator">|</span>               <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------------+----------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span><span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token comment" spellcheck="true">#æ³¨ è”åˆç´¢å¼•ä¸»è¦é’ˆå¯¹å¤šæ¡ä»¶æŸ¥è¯¢ï¼Œå› æ­¤éœ€è¦æŠŠæœ€å¸¸ç”¨çš„æ¡ä»¶æ”¾åˆ°æœ€å‰é¢ è§„åˆ™éµå¾ªå‰ç¼€ç”Ÿæ•ˆç‰¹æ€§</span></code></pre><hr><h3 id="2-4-ç´¢å¼•åˆ›å»ºè§„åˆ™"><a href="#2-4-ç´¢å¼•åˆ›å»ºè§„åˆ™" class="headerlink" title="2.4 ç´¢å¼•åˆ›å»ºè§„åˆ™"></a>2.4 ç´¢å¼•åˆ›å»ºè§„åˆ™</h3><ol><li>åˆ›å»ºå”¯ä¸€ç´¢å¼•</li><li>å¦‚æœè¯¥åˆ—é‡å¤å€¼è¾ƒå¤šï¼Œé‡‡ç”¨è”åˆç´¢å¼•</li><li>ç»å¸¸éœ€è¦æ’åºã€åˆ†ç»„å’Œè”åˆæ“ä½œçš„å­—æ®µå»ºç«‹ç´¢å¼•</li><li>å¸¸ä½œä¸ºæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µå»ºç«‹ç´¢å¼•</li><li>ç´¢å¼•å­—æ®µçš„å€¼å¾ˆé•¿ï¼Œå°½é‡ä½¿ç”¨å‰ç¼€ç´¢å¼•</li><li>é™åˆ¶ç´¢å¼•æ•°ç›®</li><li>åˆ é™¤ä¸å†ä½¿ç”¨æˆ–è€…å¾ˆå°‘ä½¿ç”¨çš„ç´ å¼•</li></ol><hr><h3 id="2-5-ç´¢å¼•ä¼˜åŒ–è§„åˆ™"><a href="#2-5-ç´¢å¼•ä¼˜åŒ–è§„åˆ™" class="headerlink" title="2.5 ç´¢å¼•ä¼˜åŒ–è§„åˆ™"></a>2.5 ç´¢å¼•ä¼˜åŒ–è§„åˆ™</h3><ol><li><p>æ²¡æœ‰æŸ¥è¯¢æ¡ä»¶ï¼Œæˆ–è€…æŸ¥è¯¢æ¡ä»¶æ²¡æœ‰ç´¢å¼•ã€‚</p><ul><li>aï¼‰æ·»åŠ æŸ¥è¯¢æ¡ä»¶ã€‚</li><li>bï¼‰ä¸ºæŸ¥è¯¢æ¡ä»¶åˆ›å»ºç´ å¼•</li></ul></li><li><p>æŸ¥è¯¢ç»“æœé›†æ˜¯åŸè¡¨ä¸­çš„å¤§éƒ¨åˆ†æ•°æ®ï¼Œåº”è¯¥æ˜¯25%ä»¥ä¸Šä¸èµ°ç´¢å¼•aï¼‰ä½¿ç”¨limitå»æŸ¥è¯¢æ•°æ®</p></li><li><p>ç´¢å¼•æœ¬èº«æŸåï¼ˆå¤±æ•ˆï¼‰ï¼Œä¸èµ°ç´¢å¼•</p><ul><li>aï¼‰ç›‘æ§ç´¢å¼•</li><li>bï¼‰åˆ é™¤ç´¢å¼•ï¼Œé‡æ–°å»ºç«‹ç´ å¼•</li></ul></li><li><p>ä½¿ç”¨å‡½æ•°åœ¨ç´¢å¼•åˆ—ä¸Šæˆ–è€…å¯¹ç´¢å¼•åˆ—è¿›è¡Œè¿ç®—ï¼Œä¸èµ°ç´¢å¼•</p></li><li><p>éšå¼è½¬æ¢å¯¼è‡´ç´¢å¼•å¤±æ•ˆ</p></li><li><p>&lt;&gt;ï¼Œnot in ä¸èµ°ç´¢å¼•</p></li><li><p>like%â€ç™¾åˆ†å·åœ¨æœ€å‰é¢ä¸èµ°ç´¢å¼•</p></li><li><p>å•ç‹¬å¼•ç”¨è”åˆç´¢å¼•é‡Œéç¬¬ä¸€ä½ç½®çš„ç´¢å¼•åˆ—.</p></li></ol><hr><h1 id="ä¸‰ã€Explainä½¿ç”¨"><a href="#ä¸‰ã€Explainä½¿ç”¨" class="headerlink" title="ä¸‰ã€Explainä½¿ç”¨"></a>ä¸‰ã€Explainä½¿ç”¨</h1><h3 id="3-1-Explainè¯¦è§£"><a href="#3-1-Explainè¯¦è§£" class="headerlink" title="3.1 Explainè¯¦è§£"></a>3.1 Explainè¯¦è§£</h3><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#å‘½ä»¤å¸¸è§ä½¿ç”¨æ–¹æ³•</span>mysql<span class="token operator">></span>  <span class="token keyword">explain</span> <span class="token keyword">select</span> name<span class="token punctuation">,</span>countrycode <span class="token keyword">from</span> city <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><blockquote><p>å„å­—æ®µå«ä¹‰</p></blockquote><ul><li><strong>id</strong>: selectæŸ¥è¯¢çš„åºåˆ—å·,åŒ…å«ä¸€ç»„æ•°å­—ï¼Œè¡¨ç¤ºæŸ¥è¯¢ä¸­æ‰§è¡Œselectå­å¥æˆ–æ“ä½œè¡¨çš„é¡ºåº</li><li><strong>select_type</strong>: æŸ¥è¯¢çš„ç±»å‹ï¼Œä¸»è¦æ˜¯ç”¨äºåŒºåˆ«,æ™®é€šæŸ¥è¯¢ã€è”åˆæŸ¥è¯¢ã€å­æŸ¥è¯¢ç­‰çš„å¤æ‚æŸ¥è¯¢ï¼ˆSIMPLEï¼ŒPRIMARYï¼ŒDERIVEDï¼ŒSUBQUERYï¼ŒDEPENDENT SUBQUERYï¼ŒUNCACHEABLE SUBQUREYç­‰ï¼‰</li><li><strong>table</strong>ï¼šæ˜¾ç¤ºè¿™ä¸€è¡Œçš„æ•°æ®æ˜¯å…³äºå“ªå¼ è¡¨çš„</li><li><strong>type</strong>ï¼štypeæ˜¾ç¤ºçš„æ˜¯è®¿é—®ç±»å‹ï¼Œæ˜¯è¾ƒä¸ºé‡è¦çš„ä¸€ä¸ªæŒ‡æ ‡ï¼Œç»“æœå€¼ä»æœ€å¥½åˆ°æœ€åä¾æ¬¡æ˜¯ï¼š system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range(å°½é‡ä¿è¯) &gt; index &gt; ALLã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¾—ä¿è¯æŸ¥è¯¢è‡³å°‘è¾¾åˆ°rangeçº§åˆ«ï¼Œæœ€å¥½èƒ½è¾¾åˆ°refã€‚</li><li><strong>possible_keys</strong>ï¼šæ˜¾ç¤ºå¯èƒ½åº”ç”¨åœ¨è¿™å¼ è¡¨ä¸­çš„ç´¢å¼•ï¼Œä¸€ä¸ªæˆ–å¤šä¸ªã€‚æŸ¥è¯¢æ¶‰åŠåˆ°çš„å­—æ®µä¸Šè‹¥å­˜åœ¨ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å°†è¢«åˆ—å‡ºï¼Œä½†ä¸ä¸€å®šè¢«æŸ¥è¯¢å®é™…ä½¿ç”¨</li><li><strong>key</strong>ï¼šå®é™…ä½¿ç”¨çš„ç´¢å¼•ã€‚å¦‚æœä¸ºNULLï¼Œåˆ™æ²¡æœ‰ä½¿ç”¨ç´¢å¼•</li><li><strong>key_len</strong>ï¼šè¡¨ç¤ºç´¢å¼•ä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œå¯é€šè¿‡è¯¥åˆ—è®¡ç®—æŸ¥è¯¢ä¸­ä½¿ç”¨çš„ç´¢å¼•çš„é•¿åº¦ã€‚</li><li><strong>ref</strong>ï¼šæ˜¾ç¤ºç´¢å¼•çš„å“ªä¸€åˆ—è¢«ä½¿ç”¨äº†ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œæ˜¯ä¸€ä¸ªå¸¸æ•°ã€‚å“ªäº›åˆ—æˆ–å¸¸é‡è¢«ç”¨äºæŸ¥æ‰¾ç´¢å¼•åˆ—ä¸Šçš„å€¼</li><li><strong>rows</strong>ï¼šrowsåˆ—æ˜¾ç¤ºMySQLè®¤ä¸ºå®ƒæ‰§è¡ŒæŸ¥è¯¢æ—¶å¿…é¡»æ£€æŸ¥çš„è¡Œæ•°ã€‚ï¼ˆè¶Šå°‘è¶Šå¥½ï¼‰</li><li><strong>Extra</strong>ï¼šåŒ…å«ä¸é€‚åˆåœ¨å…¶ä»–åˆ—ä¸­æ˜¾ç¤ºä½†ååˆ†é‡è¦çš„é¢å¤–ä¿¡æ¯<ul><li><strong>Using filesort</strong><br>è¯´æ˜mysqlä¼šå¯¹æ•°æ®ä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨çš„ç´¢å¼•æ’åºï¼Œè€Œä¸æ˜¯æŒ‰ç…§è¡¨å†…çš„ç´¢å¼•é¡ºåºè¿›è¡Œè¯»å–ã€‚</li><li><strong>Using temporary</strong><br>ä½¿äº†ç”¨ä¸´æ—¶è¡¨ä¿å­˜ä¸­é—´ç»“æœ,MySQLåœ¨å¯¹æŸ¥è¯¢ç»“æœæ’åºæ—¶ä½¿ç”¨ä¸´æ—¶è¡¨ã€‚å¸¸è§äºæ’åº order by å’Œåˆ†ç»„æŸ¥è¯¢ group byã€‚</li><li><strong>USING index</strong><br>è¡¨ç¤ºç›¸åº”çš„selectæ“ä½œä¸­ä½¿ç”¨äº†è¦†ç›–ç´¢å¼•(Covering Index)ï¼Œé¿å…è®¿é—®äº†è¡¨çš„æ•°æ®è¡Œï¼Œæ•ˆç‡ä¸é”™ï¼</li><li><strong>Using where</strong><br>è¡¨æ˜ä½¿ç”¨äº†whereè¿‡æ»¤</li><li><strong>using join buffer</strong><br>ä½¿ç”¨äº†è¿æ¥ç¼“å­˜ï¼š</li><li><strong>impossible where</strong><br>whereå­å¥çš„å€¼æ€»æ˜¯falseï¼Œä¸èƒ½ç”¨æ¥è·å–ä»»ä½•å…ƒç»„</li><li><strong>select tables optimized away</strong><br>åœ¨æ²¡æœ‰GROUPBYå­å¥çš„æƒ…å†µä¸‹ï¼ŒåŸºäºç´¢å¼•ä¼˜åŒ–MIN&#x2F;MAXæ“ä½œæˆ–è€…</li></ul></li></ul><hr><h3 id="3-2-Typeå­—æ®µåˆ†æ"><a href="#3-2-Typeå­—æ®µåˆ†æ" class="headerlink" title="3.2 Typeå­—æ®µåˆ†æ"></a>3.2 Typeå­—æ®µåˆ†æ</h3><ul><li>ALLï¼šå…¨è¡¨æ‰«æ</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">4188</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>indexï¼šFull Index Scanï¼Œindexä¸ALLåŒºåˆ«ä¸ºindexç±»å‹åªéå†ç´¢å¼•æ ‘ã€‚</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> countrycode <span class="token keyword">from</span> city <span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> CountryCode <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">4188</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>rangeï¼šç´¢å¼•èŒƒå›´æ‰«æï¼Œå¯¹ç´¢å¼•çš„æ‰«æå¼€å§‹äºæŸä¸€ç‚¹ï¼Œè¿”å›åŒ¹é…å€¼åŸŸçš„è¡Œã€‚æ˜¾è€Œæ˜“è§çš„ç´¢å¼•èŒƒå›´æ‰«ææ˜¯å¸¦æœ‰betweenæˆ–è€…whereå­å¥é‡Œå¸¦æœ‰&lt;,&gt;æŸ¥è¯¢</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">'CHN'</span><span class="token punctuation">,</span><span class="token string">'USA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-----------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra                 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-----------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> range <span class="token operator">|</span> CountryCode   <span class="token operator">|</span> CountryCode <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>  <span class="token number">637</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+-------------+---------+------+------+-----------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>refï¼šä½¿ç”¨éå”¯ä¸€ç´¢å¼•æ‰«ææˆ–è€…å”¯ä¸€ç´¢å¼•çš„å‰ç¼€æ‰«æï¼Œè¿”å›åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„è®°å½•è¡Œã€‚</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> countrycode<span class="token operator">=</span><span class="token string">'CHN'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+-------------+---------+-------+------+-----------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra                 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+-------------+---------+-------+------+-----------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> ref  <span class="token operator">|</span> CountryCode   <span class="token operator">|</span> CountryCode <span class="token operator">|</span> <span class="token number">3</span>       <span class="token operator">|</span> const <span class="token operator">|</span>  <span class="token number">363</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+-------------+---------+-------+------+-----------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>eq_refï¼šç±»ä¼¼refï¼ŒåŒºåˆ«å°±åœ¨ä½¿ç”¨çš„ç´¢å¼•æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œå¯¹äºæ¯ä¸ªç´¢å¼•é”®å€¼ï¼Œè¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•åŒ¹é…ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¤šè¡¨è¿æ¥ä¸­ä½¿ç”¨primary keyæˆ–è€… unique keyä½œä¸ºå…³è”æ¡ä»¶A</li><li>constã€systemï¼šå½“MySQLå¯¹æŸ¥è¯¢æŸéƒ¨åˆ†è¿›è¡Œä¼˜åŒ–ï¼Œå¹¶è½¬æ¢ä¸ºä¸€ä¸ªå¸¸é‡æ—¶ï¼Œä½¿ç”¨è¿™äº›ç±»å‹è®¿é—®ã€‚</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> city  <span class="token operator">|</span> const <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><ul><li>NULLï¼šMySQLåœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­åˆ†è§£è¯­å¥ï¼Œæ‰§è¡Œæ—¶ç”šè‡³ä¸ç”¨è®¿é—®è¡¨æˆ–ç´¢å¼•ï¼Œä¾‹å¦‚ä»ä¸€ä¸ªç´¢å¼•åˆ—é‡Œé€‰å–æœ€å°å€¼å¯ä»¥é€šè¿‡å•ç‹¬ç´¢å¼•æŸ¥æ‰¾å®Œæˆã€‚</li></ul><pre class=" language-sql"><code class="language-sql">mysql<span class="token operator">></span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> city <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">10000000000000000000000000</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-----------------------------------------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> Extra   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-----------------------------------------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Impossible <span class="token keyword">WHERE</span> noticed <span class="token keyword">after</span> reading const <span class="token keyword">tables</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+-------+------+---------------+------+---------+------+------+-----------------------------------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span></code></pre><p>è½¬è½½ï¼š<a href="https://blog.driverzeng.com/zenglaoshi/668.html">drz</a></p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql 5.6é…ç½®å¤šå®ä¾‹</title>
      <link href="/2d4ca71e/"/>
      <url>/2d4ca71e/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€å‡†å¤‡ç¯å¢ƒ"><a href="#ä¸€ã€å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="ä¸€ã€å‡†å¤‡ç¯å¢ƒ"></a>ä¸€ã€å‡†å¤‡ç¯å¢ƒ</h1><h3 id="1-1-åˆ›å»ºæ•°æ®ç›®å½•å‡†å¤‡é…ç½®æ–‡ä»¶"><a href="#1-1-åˆ›å»ºæ•°æ®ç›®å½•å‡†å¤‡é…ç½®æ–‡ä»¶" class="headerlink" title="1.1 åˆ›å»ºæ•°æ®ç›®å½•å‡†å¤‡é…ç½®æ–‡ä»¶"></a>1.1 åˆ›å»ºæ•°æ®ç›®å½•å‡†å¤‡é…ç½®æ–‡ä»¶</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /data/{3307,3308}</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat 3307/my.conf</span><span class="token punctuation">[</span>mysqld<span class="token punctuation">]</span>basedir=/application/mysql/datadir=/data/3307/datasocket=/data/3307/data/mysql.sockport=3307log_err=/data/3307/mysql.errlog<span class="token punctuation">-</span>bin=/data/3307/mysql<span class="token punctuation">-</span>binserver_id=7<span class="token comment" spellcheck="true">#å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°3308</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cp 3307/my.conf 3308/</span><span class="token comment" spellcheck="true">#ç»™æ•°æ®ç›®å½•å±ä¸»å±ç»„</span>chown <span class="token punctuation">-</span>R mysql<span class="token punctuation">:</span>mysql /data</code></pre><h1 id="äºŒã€é…ç½®å¯åŠ¨"><a href="#äºŒã€é…ç½®å¯åŠ¨" class="headerlink" title="äºŒã€é…ç½®å¯åŠ¨"></a>äºŒã€é…ç½®å¯åŠ¨</h1><h3 id="2-1-åˆå§‹åŒ–"><a href="#2-1-åˆå§‹åŒ–" class="headerlink" title="2.1 åˆå§‹åŒ–"></a>2.1 åˆå§‹åŒ–</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#éœ€è¦åˆ°mysqlå®‰è£…ç›®å½•ä¸‹çš„scriptä¸­æ‰§è¡Œ</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cd /application/mysql/scripts/</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./mysql_install_db --defaults-file=/data/3307/my.conf --basedir=/application/mysql --datadir=/data/3307/data</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ./mysql_install_db --defaults-file=/data/3308/my.conf --basedir=/application/mysql --datadir=/data/3308/data</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹ç›®å½•ç»“æœ</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tree -L 2 /data</span>/dataâ”œâ”€â”€ 3307â”‚   â”œâ”€â”€ dataâ”‚   â”œâ”€â”€ my.confâ”‚   â”œâ”€â”€ mysql<span class="token punctuation">-</span>bin.000001â”‚   â”œâ”€â”€ mysql<span class="token punctuation">-</span>bin.000002â”‚   â”œâ”€â”€ mysql<span class="token punctuation">-</span>bin.000003â”‚   â”œâ”€â”€ mysql<span class="token punctuation">-</span>bin.indexâ”‚   â””â”€â”€ mysql.errâ””â”€â”€ 3308    â”œâ”€â”€ data    â”œâ”€â”€ my.conf    â”œâ”€â”€ mysql<span class="token punctuation">-</span>bin.000001    â”œâ”€â”€ mysql<span class="token punctuation">-</span>bin.000002    â”œâ”€â”€ mysql<span class="token punctuation">-</span>bin.000003    â”œâ”€â”€ mysql<span class="token punctuation">-</span>bin.index    â””â”€â”€ mysql.err</code></pre><h3 id="2-2-å¯åŠ¨"><a href="#2-2-å¯åŠ¨" class="headerlink" title="2.2 å¯åŠ¨"></a>2.2 å¯åŠ¨</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqld_safe --defaults-file=/data/3307/my.conf &amp;</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqld_safe --defaults-file=/data/3308/my.conf &amp;</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹ç«¯å£ç¡®è®¤æ˜¯å¦å¯åŠ¨</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># netstat -anpt</span>Active Internet connections (servers and established)Proto Recv<span class="token punctuation">-</span>Q Send<span class="token punctuation">-</span>Q Local Address           Foreign Address         State       PID/Program nametcp        0      0 0.0.0.0<span class="token punctuation">:</span>22              0.0.0.0<span class="token punctuation">:</span>*               LISTEN      1530/sshdtcp        0      0 127.0.0.1<span class="token punctuation">:</span>25            0.0.0.0<span class="token punctuation">:</span>*               LISTEN      1182/mastertcp        0     52 192.168.0.49<span class="token punctuation">:</span>22         106.75.220.2<span class="token punctuation">:</span>54310      ESTABLISHED 17531/sshd<span class="token punctuation">:</span> root@pttcp        0      0 192.168.0.49<span class="token punctuation">:</span>22         106.75.220.2<span class="token punctuation">:</span>58731      ESTABLISHED 8275/sshd<span class="token punctuation">:</span> root@ptstcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>22                   <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      1530/sshdtcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span>1<span class="token punctuation">:</span>25                  <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      1182/mastertcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>3306                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      17293/mysqldtcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>3307                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      16924/mysqldtcp6       0      0 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>3308                 <span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>*                    LISTEN      17104/mysqld</code></pre><h3 id="2-3-ä¿®æ”¹å¯†ç "><a href="#2-3-ä¿®æ”¹å¯†ç " class="headerlink" title="2.3 ä¿®æ”¹å¯†ç "></a>2.3 ä¿®æ”¹å¯†ç </h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqladmin -uroot -p -S /data/3307/data/mysql.sock password '3307'</span>Enter password<span class="token punctuation">:</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysqladmin -uroot -p -S /data/3308/data/mysql.sock password '3308'</span>Enter password<span class="token punctuation">:</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.</code></pre><h3 id="2-4-ç™»é™†ç¡®è®¤"><a href="#2-4-ç™»é™†ç¡®è®¤" class="headerlink" title="2.4 ç™»é™†ç¡®è®¤"></a>2.4 ç™»é™†ç¡®è®¤</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql -uroot -p3307 -S /data/3307/data/mysql.sock -e "show variables like 'server_id';"</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 7     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql -uroot -p3308 -S /data/3308/data/mysql.sock -e "show variables like 'server_id';"</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 8     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+</code></pre><h1 id="ä¸‰ã€è°ƒä¼˜"><a href="#ä¸‰ã€è°ƒä¼˜" class="headerlink" title="ä¸‰ã€è°ƒä¼˜"></a>ä¸‰ã€è°ƒä¼˜</h1><h3 id="3-1-é…ç½®å¯åŠ¨è„šæœ¬"><a href="#3-1-é…ç½®å¯åŠ¨è„šæœ¬" class="headerlink" title="3.1 é…ç½®å¯åŠ¨è„šæœ¬"></a>3.1 é…ç½®å¯åŠ¨è„šæœ¬</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /usr/local/bin/mysql3307</span>mysql <span class="token punctuation">-</span>uroot <span class="token punctuation">-</span>p3307 <span class="token punctuation">-</span>S /data/3307/data/mysql.sock<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># chmod 700 /usr/local/bin/mysql3307</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /usr/local/bin/mysql3308</span>mysql <span class="token punctuation">-</span>uroot <span class="token punctuation">-</span>p3308 <span class="token punctuation">-</span>S /data/3308/data/mysql.sock<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># chmod 700 /usr/local/bin/mysql3308</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#æµ‹è¯•è¿æ¥</span><span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql3307</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.Welcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 11Server version<span class="token punctuation">:</span> 5.6.40<span class="token punctuation">-</span>log Source distributionCopyright (c) 2000<span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql<span class="token punctuation">></span> show variables like 'server_id';+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 7     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+1 row in set (0.00 sec)<span class="token punctuation">[</span>root@db data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mysql3308</span><span class="token key atrule">Warning</span><span class="token punctuation">:</span> Using a password on the command line interface can be insecure.Welcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 4Server version<span class="token punctuation">:</span> 5.6.40<span class="token punctuation">-</span>log Source distributionCopyright (c) 2000<span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql<span class="token punctuation">></span> show variables like 'server_id';+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> Variable_name <span class="token punctuation">|</span> Value <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+<span class="token punctuation">|</span> server_id     <span class="token punctuation">|</span> 8     <span class="token punctuation">|</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">---</span>+<span class="token punctuation">---</span><span class="token punctuation">---</span><span class="token punctuation">-</span>+1 row in set (0.00 sec)</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Msql 5.6.40ç¼–è¯‘å®‰è£…</title>
      <link href="/61745c5a/"/>
      <url>/61745c5a/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€å‡†å¤‡ç¯å¢ƒ"><a href="#ä¸€ã€å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="ä¸€ã€å‡†å¤‡ç¯å¢ƒ"></a><strong>ä¸€ã€å‡†å¤‡ç¯å¢ƒ</strong></h1><h3 id="1-1-å®‰è£…åŒ…"><a href="#1-1-å®‰è£…åŒ…" class="headerlink" title="1.1 å®‰è£…åŒ…"></a>1.1 å®‰è£…åŒ…</h3><p>å¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªé¡µé¢ä¸‹è½½ï¼Œä¹Ÿå¯ä»¥åˆ°å®˜ç½‘ä¸‹è½½mysql.com</p><p><a href="https://video-emlog.cn-sh2.ufileos.com/mysql-5.6.40.tar.gz">mysql-5.6.40.tar.gz</a></p><h3 id="1-2-å®‰è£…éœ€è¦çš„ä¾èµ–"><a href="#1-2-å®‰è£…éœ€è¦çš„ä¾èµ–" class="headerlink" title="1.2 å®‰è£…éœ€è¦çš„ä¾èµ–"></a>1.2 å®‰è£…éœ€è¦çš„ä¾èµ–</h3><pre class=" language-bash"><code class="language-bash">curl -O http://kode.huhuhahei.cn/index.php?user/publicLink\<span class="token operator">&amp;</span>fid<span class="token operator">=</span>2493D9TIfgnJtc4FvMKOj1EJ5_skR0B695C3of0ZsbNu2mp0WCIPHYOfdZXyzQ6aBAUQbYWtb6pVAhQBB1jzdpFW5M2TxJZtyLLchhvJUUSFGXLuXI5xaocqSsBdj0LsGhA\<span class="token operator">&amp;</span>file_name<span class="token operator">=</span>/mysql-5.6.40.tar.gz</code></pre><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> -y ncurses-devel libaio-devel cmake gcc-c++ autoconf lrzsz</code></pre><h3 id="1-3-è§£å‹taråŒ…"><a href="#1-3-è§£å‹taråŒ…" class="headerlink" title="1.3 è§£å‹taråŒ…"></a>1.3 è§£å‹taråŒ…</h3><pre class=" language-yaml"><code class="language-yaml">tar xf mysql<span class="token punctuation">-</span>5.6.40.tar.gzcd mysql<span class="token punctuation">-</span>5.6.40</code></pre><h1 id="äºŒã€ç¼–è¯‘é…ç½®"><a href="#äºŒã€ç¼–è¯‘é…ç½®" class="headerlink" title="äºŒã€ç¼–è¯‘é…ç½®"></a><strong>äºŒã€ç¼–è¯‘é…ç½®</strong></h1><h3 id="2-1-ç¼–è¯‘"><a href="#2-1-ç¼–è¯‘" class="headerlink" title="2.1 ç¼–è¯‘"></a>2.1 ç¼–è¯‘</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#åˆ›å»ºå®‰è£…ç›®å½•</span>mkdir /application</code></pre><pre class=" language-yaml"><code class="language-yaml">cmake . <span class="token punctuation">-</span>DCMAKE_INSTALL_PREFIX=/application/mysql<span class="token punctuation">-</span>5.6.40 <span class="token punctuation">-</span>DMYSQL_DATADIR=/application/mysql<span class="token punctuation">-</span>5.6.40/data <span class="token punctuation">-</span>DMYSQL_UNIX_ADDR=/application/mysql<span class="token punctuation">-</span>5.6.40/tmp/mysql.sock <span class="token punctuation">-</span>DDEFAULT_CHARSET=utf8 <span class="token punctuation">-</span>DDEFAULT_COLLATION=utf8_general_ci <span class="token punctuation">-</span>DWITH_EXTRA_CHARSETS=all <span class="token punctuation">-</span>DWITH_INNOBASE_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITH_FEDERATED_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITH_BLACKHOLE_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITHOUT_EXAMPLE_STORAGE_ENGINE=1 <span class="token punctuation">-</span>DWITH_ZLIB=bundled<span class="token punctuation">-</span>DWITH_SSL=bundled <span class="token punctuation">-</span>DENABLED_LOCAL_INFILE=1 <span class="token punctuation">-</span>DWITH_EMBEDDED_SERVER=1 <span class="token punctuation">-</span>DENABLE_DOWNLOADS=1 <span class="token punctuation">-</span>DWITH_DEBUG=0</code></pre><pre class=" language-yaml"><code class="language-yaml">make &amp;&amp; make install</code></pre><h1 id="ä¸‰ã€é…ç½®ä¼˜åŒ–"><a href="#ä¸‰ã€é…ç½®ä¼˜åŒ–" class="headerlink" title="ä¸‰ã€é…ç½®ä¼˜åŒ–"></a><strong>ä¸‰ã€é…ç½®ä¼˜åŒ–</strong></h1><h3 id="3-1-æ–‡ä»¶è·¯å¾„è°ƒä¼˜"><a href="#3-1-æ–‡ä»¶è·¯å¾„è°ƒä¼˜" class="headerlink" title="3.1 æ–‡ä»¶è·¯å¾„è°ƒä¼˜"></a>3.1 æ–‡ä»¶è·¯å¾„è°ƒä¼˜</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#åˆ›å»ºç”¨æˆ·</span>useradd mysql <span class="token punctuation">-</span>s /sbin/nologin <span class="token punctuation">-</span>M<span class="token comment" spellcheck="true">#åˆ›å»ºsocketæ–‡ä»¶ç›®å½•</span>mkdir <span class="token punctuation">-</span>p /application/mysql<span class="token punctuation">-</span>5.6.40/tmp<span class="token comment" spellcheck="true">#é…ç½®è½¯è¿æ¥</span>ln <span class="token punctuation">-</span>s /application/mysql<span class="token punctuation">-</span>5.6.40/ /application/mysql<span class="token comment" spellcheck="true">#å¤åˆ¶é…ç½®æ–‡ä»¶</span>cp support<span class="token punctuation">-</span>files/my<span class="token punctuation">-</span>default.cnf /etc/my.cnf<span class="token comment" spellcheck="true">#é…ç½®å¯åŠ¨å‘½ä»¤</span>cp support<span class="token punctuation">-</span>files/mysql.server /etc/init.d/mysqld<span class="token comment" spellcheck="true">#ä¿®æ”¹å±ä¸»å±ç»„</span>chown <span class="token punctuation">-</span>R mysql<span class="token punctuation">:</span>mysql /application/mysqlchown <span class="token punctuation">-</span>R mysql<span class="token punctuation">:</span>mysql /application/mysql<span class="token punctuation">-</span>5.6.40/</code></pre><h3 id="3-2-åˆå§‹åŒ–æ•°æ®åº“"><a href="#3-2-åˆå§‹åŒ–æ•°æ®åº“" class="headerlink" title="3.2 åˆå§‹åŒ–æ•°æ®åº“"></a>3.2 åˆå§‹åŒ–æ•°æ®åº“</h3><pre class=" language-yaml"><code class="language-yaml">cd scripts/./mysql_install_db <span class="token punctuation">-</span><span class="token punctuation">-</span>user=mysql <span class="token punctuation">-</span><span class="token punctuation">-</span>basedir=/application/mysql/ <span class="token punctuation">-</span><span class="token punctuation">-</span>datadir=/application/mysql/data</code></pre><h3 id="3-3-é…ç½®ç¯å¢ƒå˜é‡"><a href="#3-3-é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="3.3 é…ç½®ç¯å¢ƒå˜é‡"></a>3.3 é…ç½®ç¯å¢ƒå˜é‡</h3><pre class=" language-yaml"><code class="language-yaml">cat /etc/profile.d/mysql.shexport PATH="/application/mysql/bin<span class="token punctuation">:</span>$PATH"source /etc/profile.d/mysql.sh</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#å¯åŠ¨mysql</span>/etc/init.d/mysqld start<span class="token comment" spellcheck="true">#å¯ä»¥ç™»é™†äº†</span>mysqlWelcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 1Server version<span class="token punctuation">:</span> 5.6.40 Source distributionCopyright (c) 2000<span class="token punctuation">,</span> <span class="token number">2018</span><span class="token punctuation">,</span> Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.mysql<span class="token punctuation">></span></code></pre><h3 id="3-4-é…ç½®systemctlæ§åˆ¶"><a href="#3-4-é…ç½®systemctlæ§åˆ¶" class="headerlink" title="3.4 é…ç½®systemctlæ§åˆ¶"></a>3.4 é…ç½®systemctlæ§åˆ¶</h3><pre class=" language-yaml"><code class="language-yaml">cat /usr/lib/systemd/system/mysqld.service<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>Description=MySQL ServerDocumentation=man<span class="token punctuation">:</span>mysqld(8)Documentation=https<span class="token punctuation">:</span>//dev.mysql.com/doc/refman/en/using<span class="token punctuation">-</span>systemd.htmlAfter=network.targetAfter=syslog.target<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>WantedBy=multi<span class="token punctuation">-</span>user.target<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>User=mysqlGroup=mysqlExecStart=/application/mysql/bin/mysqld <span class="token punctuation">-</span><span class="token punctuation">-</span>defaults<span class="token punctuation">-</span>file=/etc/my.cnfLimitNOFILE = 5000</code></pre><pre class=" language-yaml"><code class="language-yaml">systemctl start mysqldsystemctl status mysqldâ— mysqld.service <span class="token punctuation">-</span> MySQL Server   <span class="token key atrule">Loaded</span><span class="token punctuation">:</span> loaded (/usr/lib/systemd/system/mysqld.service; disabled; vendor preset<span class="token punctuation">:</span> disabled)   <span class="token key atrule">Active</span><span class="token punctuation">:</span> active (running) since Thu 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 CST; 8s ago     <span class="token key atrule">Docs</span><span class="token punctuation">:</span> man<span class="token punctuation">:</span>mysqld(8)           https<span class="token punctuation">:</span>//dev.mysql.com/doc/refman/en/using<span class="token punctuation">-</span>systemd.html Main PID<span class="token punctuation">:</span> 12236 (mysqld)    <span class="token key atrule">Tasks</span><span class="token punctuation">:</span> <span class="token number">21</span>   <span class="token key atrule">CGroup</span><span class="token punctuation">:</span> /system.slice/mysqld.service           â””â”€12236 /application/mysql/bin/mysqld <span class="token punctuation">-</span><span class="token punctuation">-</span>defaults<span class="token punctuation">-</span>file=/etc/my.cnfOct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>tOct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>7Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> S<span class="token punctuation">...</span>6Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> I<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span>  <span class="token punctuation">...</span>;Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> S<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> E<span class="token punctuation">...</span>sOct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> 2021<span class="token punctuation">-</span>10<span class="token punctuation">-</span>28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 12236 <span class="token punctuation">[</span>Note<span class="token punctuation">]</span> /<span class="token punctuation">...</span>.Oct 28 14<span class="token punctuation">:</span>41<span class="token punctuation">:</span>09 192<span class="token punctuation">-</span>168<span class="token punctuation">-</span>0<span class="token punctuation">-</span>49 mysqld<span class="token punctuation">[</span><span class="token number">12236</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token key atrule">Version</span><span class="token punctuation">:</span> '5.6.40'  socket<span class="token punctuation">:</span> '/appli<span class="token punctuation">...</span>n<span class="token key atrule">Hint</span><span class="token punctuation">:</span> Some lines were ellipsized<span class="token punctuation">,</span> use <span class="token punctuation">-</span>l to show in full.</code></pre>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Operator éƒ¨ç½²æœåŠ¡æ•°æ®æŒä¹…åŒ–</title>
      <link href="/f26ab3f9/"/>
      <url>/f26ab3f9/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h1><h3 id="1-1"><a href="#1-1" class="headerlink" title="1.1"></a>1.1</h3><p>é»˜è®¤ä½¿ç”¨<code>Operator</code>éƒ¨ç½²çš„<code>prometheus</code>å’Œ<code>grafana</code>å­˜å‚¨æ•°æ®éƒ½æ˜¯ä½¿ç”¨çš„<code>emptyDir</code>æ ¼å¼çš„ï¼Œæ‰€ä»¥æœåŠ¡é‡å¯åæ•°æ®å°±ä¼šæ¸…ç©ºï¼Œç”Ÿäº§ç¯å¢ƒè‚¯å®šæ˜¯ä¸è¡Œçš„æ‰€ä»¥éœ€è¦å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜</p><h1 id="äºŒã€é…ç½®"><a href="#äºŒã€é…ç½®" class="headerlink" title="äºŒã€é…ç½®"></a>äºŒã€é…ç½®</h1><h3 id="2-1-PrometheusæŒä¹…åŒ–"><a href="#2-1-PrometheusæŒä¹…åŒ–" class="headerlink" title="2.1 PrometheusæŒä¹…åŒ–"></a>2.1 PrometheusæŒä¹…åŒ–</h3><p>prometheusä½¿ç”¨çš„æ˜¯stsæ§åˆ¶å™¨ï¼Œè¿™è¾¹ç›´æ¥ä½¿ç”¨StorageClass</p><p>é¦–å…ˆéœ€è¦åˆ›å»ºStorageClasså­˜å‚¨ï¼ˆéœ€è¦é…ç½®nfs è¿™é‡Œå°±ä¸å¤šèµ˜è¿°äº†ï¼‰</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat nfs-sc.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01  </span><span class="token comment" spellcheck="true"># æ­¤å¤„ä¾›åº”è€…åå­—ä¾›storageclassè°ƒç”¨</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># å¡«å…¥NFSçš„åœ°å€</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/lnmp/prometheus_data  <span class="token comment" spellcheck="true"># å¡«å…¥NFSæœåŠ¡å™¨æŒ‚è½½çš„ç›®å½•</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># å¡«å…¥NFSçš„åœ°å€</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/lnmp/prometheus_data   <span class="token comment" spellcheck="true"># å¡«å…¥NFSæœåŠ¡å™¨æŒ‚è½½çš„ç›®å½•</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span><span class="token comment" spellcheck="true"># Supported policies: Deleteã€ Retain ï¼Œ default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#å¯åŠ¨</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nfs-sc.yaml</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n kube-system</span>NAME                                       READY   STATUS    RESTARTS   AGnfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>01<span class="token punctuation">-</span>7f7ccdb7bb<span class="token punctuation">-</span>nfsxb        1/1     Running   0          5h10m<span class="token comment" spellcheck="true">#ä¿®æ”¹prometheuså­˜å‚¨é…ç½®</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring edit prometheus k8s</span>spec<span class="token punctuation">...</span><span class="token punctuation">...</span>  <span class="token key atrule">storage</span><span class="token punctuation">:</span>    <span class="token key atrule">volumeClaimTemplate</span><span class="token punctuation">:</span>      <span class="token key atrule">spec</span><span class="token punctuation">:</span>        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> ReadWriteMany        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi        <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge<span class="token comment" spellcheck="true">#ç¨åå¯ä»¥çœ‹åˆ°StorageClassä¼šè‡ªåŠ¨åˆ›å»ºPVCå’ŒPV</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc -n monitoring</span>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEprometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0   Bound    pvc<span class="token punctuation">-</span>263e60ad<span class="token punctuation">-</span>44c1<span class="token punctuation">-</span>41a8<span class="token punctuation">-</span>9f2a<span class="token punctuation">-</span>77a35f507ad0   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       6h7mprometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>1   Bound    pvc<span class="token punctuation">-</span>73ee2d7f<span class="token punctuation">-</span>180c<span class="token punctuation">-</span>40b9<span class="token punctuation">-</span>925a<span class="token punctuation">-</span>0bddc58c4604   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       6h7m<span class="token comment" spellcheck="true">#ç™»é™†podæŸ¥çœ‹æŒ‚è½½</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it -n monitoring prometheus-k8s-0 -- /bin/sh</span>/prometheus $ df <span class="token punctuation">-</span>hFilesystem                Size      Used Available Use% Mounted onoverlay                  40.0G     13.1G     26.8G  33% /tmpfs                    64.0M         0     64.0M   0% /devtmpfs                     1.9G         0      1.9G   0% /sys/fs/cgroup10.7.48.223<span class="token punctuation">:</span>/data/lnmp/prometheus_data/monitoring<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>db<span class="token punctuation">-</span>prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>0<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>263e60ad<span class="token punctuation">-</span>44c1<span class="token punctuation">-</span>41a8<span class="token punctuation">-</span>9f2a<span class="token punctuation">-</span>77a35f507ad0/prometheus<span class="token punctuation">-</span>db</code></pre><h3 id="2-2GrafanaæŒä¹…åŒ–"><a href="#2-2GrafanaæŒä¹…åŒ–" class="headerlink" title="2.2GrafanaæŒä¹…åŒ–"></a>2.2GrafanaæŒä¹…åŒ–</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#åˆ›å»ºGrafanaçš„pvc</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat grafana-pvc.yaml</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>boge  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token comment" spellcheck="true">#éƒ¨ç½²</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f grafana-pvc.yaml</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹pvcæ˜¯å¦åˆ›å»º</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc -n monitoring</span>NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEgrafana                              Bound    pvc<span class="token punctuation">-</span>c16d1015<span class="token punctuation">-</span>f1ed<span class="token punctuation">-</span>40be<span class="token punctuation">-</span>bfb2<span class="token punctuation">-</span>d980377692ea   5Gi        RWX            nfs<span class="token punctuation">-</span>boge       5h23m<span class="token comment" spellcheck="true">#ç¼–è¾‘grafanaçš„deploymentèµ„æºé…ç½®</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n monitoring edit deployments.apps grafan</span><span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>storage<span class="token comment" spellcheck="true">#æ›´æ”¹ä¸º</span><span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grafana<span class="token punctuation">-</span>storage      <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>        <span class="token key atrule">claimName</span><span class="token punctuation">:</span> grafana<span class="token comment" spellcheck="true">#åŒæ—¶å»ºè®®æ·»åŠ ç¯å¢ƒå˜é‡é…ç½®é»˜è®¤å¯†ç </span><span class="token key atrule">env</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_SECURITY_ADMIN_USER<span class="token key atrule">value</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GF_SECURITY_ADMIN_PASSWORD<span class="token key atrule">value</span><span class="token punctuation">:</span> admin321<span class="token comment" spellcheck="true">#ä¿å­˜é€€å‡º</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Operator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubeadmå¸è½½</title>
      <link href="/b7046e9b/"/>
      <url>/b7046e9b/</url>
      
        <content type="html"><![CDATA[<h1 id="åˆ é™¤kubeadmæ„å»ºçš„Kubernetesé›†ç¾¤"><a href="#åˆ é™¤kubeadmæ„å»ºçš„Kubernetesé›†ç¾¤" class="headerlink" title="åˆ é™¤kubeadmæ„å»ºçš„Kubernetesé›†ç¾¤"></a>åˆ é™¤kubeadmæ„å»ºçš„Kubernetesé›†ç¾¤</h1><p>æ‰€æœ‰é€šè¿‡ <a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/deployment/bootstrap_kubernetes_single/kubeadm.html#kubeadm">kubeadm</a> å·¥å…·æ„å»ºçš„Kubernetesé›†ç¾¤ä»¥åŠèŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥é€šè¿‡ <code>kubeadm</code> å·¥å…·åå‘å¸è½½(åˆ é™¤)ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„æ“ä½œã€‚æˆ‘çš„å®è·µæ˜¯å› ä¸ºåœ¨å¼€å‘æµ‹è¯•ç¯å¢ƒï¼Œ <a href="https://cloud-atlas.readthedocs.io/zh_CN/latest/kubernetes/administer/kubeadm_administer/upgrade_kubeadm_cluster.html#upgrade-kubeadm-cluster">å‡çº§kubeadmé›†ç¾¤</a> å¤±è´¥ï¼Œä¸ºäº†å¿«é€Ÿå¼€å§‹ä¸‹ä¸€é˜¶æ®µæµ‹è¯•å·¥ä½œï¼Œæ‰€ä»¥å‡†å¤‡é‡å»ºKubernetesé›†ç¾¤ã€‚</p><p><code>kubeadm reset</code> å‘½ä»¤æ‰§è¡Œä¼šæç¤º:</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> WARNING: Changes made to this host by <span class="token string">'kubeadm init'</span> or <span class="token string">'kubeadm join'</span> will be reverted.<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Are you sure you want to proceed? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>:</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡æ˜¯åŠ å…¥é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹ï¼Œè¿˜æ˜¯åˆå§‹åŒ–çš„ç®¡æ§èŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥ç”¨è¿™ä¸ªå·¥å…·åå‘æ“ä½œ</p><p>æ£€æŸ¥é›†ç¾¤:</p><pre class=" language-bash"><code class="language-bash">kubectl get nodes</code></pre><p>å½“å‰èŠ‚ç‚¹:</p><pre class=" language-bash"><code class="language-bash">NAME         STATUS   ROLES    AGE    VERSIONpi-master1   Ready    master   241d   v1.20.9pi-worker1   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.20.9pi-worker2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.21.3zcloud       Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>   127d   v1.21.3</code></pre><p>é¦–å…ˆåœ¨ <code>zcloud</code> ä¸Šæ‰§è¡ŒèŠ‚ç‚¹æ¸…ç†:</p><pre class=" language-bash"><code class="language-bash">kubeadm reset<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> WARNING: Changes made to this host by <span class="token string">'kubeadm init'</span> or <span class="token string">'kubeadm join'</span> will be reverted.<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Are you sure you want to proceed? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: y</code></pre><p>æç¤ºä¿¡æ¯:</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checksW0728 23:50:09.914348 3734557 removeetcdmember.go:79<span class="token punctuation">]</span> <span class="token punctuation">[</span>reset<span class="token punctuation">]</span> No kubeadm config, using etcd pod spec to get data directory<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> No etcd config found. Assuming external etcd<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Please, manually reset etcd to prevent further issues<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Stopping the kubelet <span class="token function">service</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Unmounting mounted directories <span class="token keyword">in</span> <span class="token string">"/var/lib/kubelet"</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of config directories: <span class="token punctuation">[</span>/etc/kubernetes/manifests /etc/kubernetes/pki<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting files: <span class="token punctuation">[</span>/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of stateful directories: <span class="token punctuation">[</span>/var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni<span class="token punctuation">]</span>The reset process does not clean CNI configuration. To <span class="token keyword">do</span> so, you must remove /etc/cni/net.dThe reset process does not reset or clean up iptables rules or IPVS tables.If you wish to reset iptables, you must <span class="token keyword">do</span> so manually by using the <span class="token string">"iptables"</span> command.If your cluster was setup to utilize IPVS, run ipvsadm --clear <span class="token punctuation">(</span>or similar<span class="token punctuation">)</span>to reset your system's IPVS tables.The reset process does not clean your kubeconfig files and you must remove them manually.Please, check the contents of the <span class="token variable">$HOME</span>/.kube/config file.</code></pre><p>å¯ä»¥çœ‹åˆ° <code>reset</code> è¿‡ç¨‹ä¸ä¼šæ¸…ç†CNIé…ç½®ï¼Œä¹Ÿä¸ä¼šæ¸…ç†iptablesè§„åˆ™ï¼Œä¸¤è€…éœ€è¦æ‰‹å·¥å¤„ç†</p><p>å®Œæˆä»¥åï¼Œåœ¨ç®¡æ§æœåŠ¡å™¨ä¸Šæ£€æŸ¥ï¼Œå¯ä»¥çœ‹åˆ°è¯¥å·¥ä½œèŠ‚ç‚¹å·²ç» <code>NotReady</code></p><pre class=" language-bash"><code class="language-bash">kubectl get nodes</code></pre><p>æ˜¾ç¤º:</p><pre class=" language-bash"><code class="language-bash">NAME         STATUS     ROLES    AGE    VERSIONpi-master1   Ready      master   241d   v1.20.9pi-worker1   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.20.9pi-worker2   Ready      <span class="token operator">&lt;</span>none<span class="token operator">></span>   237d   v1.21.3zcloud       NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>   127d   v1.21.3</code></pre><p>åˆ é™¤èŠ‚ç‚¹:</p><pre class=" language-bash"><code class="language-bash">kubectl delete node zcloud</code></pre><p>åœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šå†æ‰§è¡Œä¸€æ¬¡æ¸…ç† <code>iptables</code> å’Œ <code>cni</code></p><pre class=" language-bash"><code class="language-bash"><span class="token function">rm</span> -rf /etc/cni/net.diptables -F</code></pre><p>æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹æ¸…ç†ä»¥åï¼Œæœ€åæ‰§è¡Œç®¡æ§èŠ‚ç‚¹å¸è½½:</p><pre class=" language-bash"><code class="language-bash">kubeadm reset</code></pre><p>è¾“å‡ºä¿¡æ¯:</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Removing info <span class="token keyword">for</span> node <span class="token string">"pi-master1"</span> from the ConfigMap <span class="token string">"kubeadm-config"</span> <span class="token keyword">in</span> the <span class="token string">"kube-system"</span> NamespaceW0729 00:23:55.555252 3406560 removeetcdmember.go:61<span class="token punctuation">]</span> <span class="token punctuation">[</span>reset<span class="token punctuation">]</span> failed to remove etcd member: error syncing endpoints with etcd: context deadline exceeded, please manually remove this etcd member using etcdctl<span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Stopping the kubelet <span class="token function">service</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Unmounting mounted directories <span class="token keyword">in</span> <span class="token string">"/var/lib/kubelet"</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of config directories: <span class="token punctuation">[</span>/etc/kubernetes/manifests /etc/kubernetes/pki<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting files: <span class="token punctuation">[</span>/etc/kubernetes/admin.conf /etc/kubernetes/kubelet.conf /etc/kubernetes/bootstrap-kubelet.conf /etc/kubernetes/controller-manager.conf /etc/kubernetes/scheduler.conf<span class="token punctuation">]</span><span class="token punctuation">[</span>reset<span class="token punctuation">]</span> Deleting contents of stateful directories: <span class="token punctuation">[</span>/var/lib/etcd /var/lib/kubelet /var/lib/dockershim /var/run/kubernetes /var/lib/cni<span class="token punctuation">]</span>The reset process does not clean CNI configuration. To <span class="token keyword">do</span> so, you must remove /etc/cni/net.dThe reset process does not reset or clean up iptables rules or IPVS tables.If you wish to reset iptables, you must <span class="token keyword">do</span> so manually by using the <span class="token string">"iptables"</span> command.If your cluster was setup to utilize IPVS, run ipvsadm --clear <span class="token punctuation">(</span>or similar<span class="token punctuation">)</span>to reset your system's IPVS tables.The reset process does not clean your kubeconfig files and you must remove them manually.Please, check the contents of the <span class="token variable">$HOME</span>/.kube/config file.</code></pre><p>æ¸…ç†å®Œå¥½å¹²å‡€:</p><pre class=" language-bash"><code class="language-bash">root@pi-master1:~<span class="token comment" spellcheck="true"># docker ps</span>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMESroot@pi-master1:~<span class="token comment" spellcheck="true"># docker ps --all</span>CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> kubeadm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sä¸­é…ç½®lnmpç¯å¢ƒ</title>
      <link href="/eb76ee24/"/>
      <url>/eb76ee24/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€é…ç½®ç”¨äºå­˜å‚¨çš„NFSæœåŠ¡"><a href="#ä¸€ã€é…ç½®ç”¨äºå­˜å‚¨çš„NFSæœåŠ¡" class="headerlink" title="ä¸€ã€é…ç½®ç”¨äºå­˜å‚¨çš„NFSæœåŠ¡"></a>ä¸€ã€é…ç½®ç”¨äºå­˜å‚¨çš„NFSæœåŠ¡</h1><h3 id="1-1æœåŠ¡ç«¯é…ç½®-nfs"><a href="#1-1æœåŠ¡ç«¯é…ç½®-nfs" class="headerlink" title="1.1æœåŠ¡ç«¯é…ç½® nfs"></a>1.1æœåŠ¡ç«¯é…ç½® nfs</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#yumå®‰è£…</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install nfs-utils</span><span class="token comment" spellcheck="true">#ç¼–è¾‘ é…ç½®æ–‡ä»¶ ï¼ˆç¡®ä¿ç›®å½•å­˜åœ¨ï¼‰</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># vim /etc/exports</span>/data/lnmp 10.7.0.0/16(rw<span class="token punctuation">,</span>no_root_squash)<span class="token comment" spellcheck="true">#å¯åŠ¨æœåŠ¡</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl start nfs</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># systemctl status  nfs</span>â— nfs<span class="token punctuation">-</span>server.service <span class="token punctuation">-</span> NFS server and services   <span class="token key atrule">Loaded</span><span class="token punctuation">:</span> loaded (/usr/lib/systemd/system/nfs<span class="token punctuation">-</span>server.service; disabled; vendor preset<span class="token punctuation">:</span> disabled)  <span class="token key atrule">Drop-In</span><span class="token punctuation">:</span> /run/systemd/generator/nfs<span class="token punctuation">-</span>server.service.d           â””â”€order<span class="token punctuation">-</span>with<span class="token punctuation">-</span>mounts.conf   <span class="token key atrule">Active</span><span class="token punctuation">:</span> active (exited) since Sat 2021<span class="token punctuation">-</span>09<span class="token punctuation">-</span>11 17<span class="token punctuation">:</span>32<span class="token punctuation">:</span>16 HKT; 1 weeks 0 days ago Main PID<span class="token punctuation">:</span> 21698 (code=exited<span class="token punctuation">,</span> status=0/SUCCESS)    <span class="token key atrule">Tasks</span><span class="token punctuation">:</span> <span class="token number">0</span>   <span class="token key atrule">Memory</span><span class="token punctuation">:</span> 0B   <span class="token key atrule">CGroup</span><span class="token punctuation">:</span> /system.slice/nfs<span class="token punctuation">-</span>server.service<span class="token comment" spellcheck="true">#showmountç¡®è®¤</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># showmount -e</span>Export list for k8smaster<span class="token punctuation">:</span>/data/lnmp 10.7.0.0/16</code></pre><h3 id="1-2å®¢æˆ·ç«¯æŒ‚è½½æœåŠ¡"><a href="#1-2å®¢æˆ·ç«¯æŒ‚è½½æœåŠ¡" class="headerlink" title="1.2å®¢æˆ·ç«¯æŒ‚è½½æœåŠ¡"></a>1.2å®¢æˆ·ç«¯æŒ‚è½½æœåŠ¡</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#å®‰è£…nfså®¢æˆ·ç«¯ </span><span class="token punctuation">[</span>root@k8snode ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># yum -y install nfs-utils.x86_64</span><span class="token comment" spellcheck="true">#showmount -eæŸ¥çœ‹</span><span class="token punctuation">[</span>root@k8snode ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># showmount -e 10.7.48.223</span>Export list for 10.7.48.223<span class="token punctuation">:</span>/data/lnmp 10.7.0.0/16<span class="token comment" spellcheck="true">#åˆ›å»ºæŒ‚è½½ç‚¹æŒ‚è½½</span><span class="token punctuation">[</span>root@k8snode data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mkdir /data</span><span class="token punctuation">[</span>root@k8snode data<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># mount -t nfs 10.7.48.223/data/lnmp /data</span></code></pre><h1 id="äºŒ-ã€é…ç½®LNMPç¯å¢ƒ"><a href="#äºŒ-ã€é…ç½®LNMPç¯å¢ƒ" class="headerlink" title="äºŒ ã€é…ç½®LNMPç¯å¢ƒ"></a>äºŒ ã€é…ç½®LNMPç¯å¢ƒ</h1><h3 id="2-1mysqlé…ç½®æ¸…å•"><a href="#2-1mysqlé…ç½®æ¸…å•" class="headerlink" title="2.1mysqlé…ç½®æ¸…å•"></a>2.1mysqlé…ç½®æ¸…å•</h3><p>é…ç½®å‰å…ˆåˆ›å»ºéœ€è¦çš„å‘½åç©ºé—´</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create ns  lnmp</span></code></pre><p>mysqlæ¸…å•é…ç½®å¦‚ä¸‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pass              <span class="token key atrule">key</span><span class="token punctuation">:</span> password        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lnmp<span class="token punctuation">-</span>mysql          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lnmp<span class="token punctuation">-</span>mysql        <span class="token key atrule">nfs</span><span class="token punctuation">:</span>         <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token comment" spellcheck="true">#nfs serveræœåŠ¡å™¨IP</span>         <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/data/lnmp/mysql"</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql</code></pre><p>è¿™é‡Œé¢mysql å¯†ç æ˜¯é€šè¿‡ç¯å¢ƒ å˜é‡çš„æ–¹å¼å¯¼å…¥çš„å¯†ç é…ç½®å‚è€ƒä¸‹é¢æ–¹æ³•</p><pre class=" language-yaml"><code class="language-yaml">kubectl create secret generic mysql<span class="token punctuation">-</span>pass <span class="token punctuation">-</span><span class="token punctuation">-</span>from<span class="token punctuation">-</span>literal=password=123456 <span class="token punctuation">-</span>n lnmp</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#å¯åŠ¨</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f mysql.yaml -n lnmp</span>deployment.apps/mysql createdservice/mysql unchanged<span class="token comment" spellcheck="true">#æŸ¥çœ‹podçŠ¶æ€</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po  -n lnmp</span>NAME                        READY   STATUS    RESTARTS   AGEmysql<span class="token punctuation">-</span>6cc8488986<span class="token punctuation">-</span>2wf62      1/1     Running   0          13m<span class="token comment" spellcheck="true">#æŸ¥çœ‹svcåœ°å€å¹¶ç¡®è®¤ç«¯å£è¿é€šæ€§</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get svc  -n lnmp</span>NAME        TYPE        CLUSTER<span class="token punctuation">-</span>IP      EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)        AGEmysql       ClusterIP   10.97.108.119   &lt;none<span class="token punctuation">></span>        3306/TCP       2d20h<span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># telnet  10.97.108.119  3306</span>Trying 10.97.108.119<span class="token punctuation">...</span>Connected to 10.97.108.119.Escape character is '^<span class="token punctuation">]</span>'<span class="token comment" spellcheck="true">#ç«¯å£å¯ä»¥æ­£å¸¸è®¿é—®mysqlçš„é…ç½®å°±æ˜¯æ­£å¸¸çš„</span></code></pre><h3 id="2-2-nginx-phpé…ç½®æ¸…å•"><a href="#2-2-nginx-phpé…ç½®æ¸…å•" class="headerlink" title="2.2 nginx+phpé…ç½®æ¸…å•"></a>2.2 nginx+phpé…ç½®æ¸…å•</h3><p>æ¸…å•æ–‡ä»¶å¦‚ä¸‹</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com/user<span class="token punctuation">-</span>sum/php        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/www/html/       <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>shenzhen.aliyuncs.com/user<span class="token punctuation">-</span>sum/alpine<span class="token punctuation">:</span>nginx1.18.0        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/conf.d/       <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data        <span class="token key atrule">nfs</span><span class="token punctuation">:</span>         <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token comment" spellcheck="true">#nfs serveræœåŠ¡å™¨IP</span>         <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">"/data/lnmp/app"</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf         <span class="token key atrule">items</span><span class="token punctuation">:</span>         <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> default.conf           <span class="token key atrule">path</span><span class="token punctuation">:</span> add.conf <span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30010</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php</code></pre><p>nginxæœåŠ¡é…ç½®æ–‡ä»¶</p><pre class=" language-yaml"><code class="language-yaml">server <span class="token punctuation">{</span>    listen       80;    server_name  localhost;    location / <span class="token punctuation">{</span>        root   /usr/share/nginx/html;        index  index.html index.htm;    <span class="token punctuation">}</span>    error_page   500 502 503 504  /50x.html;    location = /50x.html <span class="token punctuation">{</span>        root   /usr/share/nginx/html;    <span class="token punctuation">}</span>    location ~ \.php$ <span class="token punctuation">{</span>        fastcgi_pass   127.0.0.1<span class="token punctuation">:</span>9000;        fastcgi_index  index.php;        fastcgi_param  SCRIPT_FILENAME  /var/www/html/$fastcgi_script_name;        include        fastcgi_params;    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#åˆ›å»ºconfigmap</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create cm ngin-conf --from-file=default.conf -n lnmp</span><span class="token comment" spellcheck="true">#å¯åŠ¨</span><span class="token punctuation">[</span>root@k8smaster lnmp<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nginx-php.yaml -n lnmp</span></code></pre><h3 id="2-3æµ‹è¯•"><a href="#2-3æµ‹è¯•" class="headerlink" title="2.3æµ‹è¯•"></a>2.3æµ‹è¯•</h3><p>æµ‹è¯• phpè¿é€šæ€§</p><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#åˆ›å»ºæµ‹è¯•æ–‡ä»¶æµ‹è¯•</span><span class="token punctuation">[</span>root@k8snode app<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat test.php </span>&lt;<span class="token punctuation">?</span>php phpinfo(); <span class="token punctuation">?</span><span class="token punctuation">></span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/3394303815.png"></p><p>æµ‹è¯• mysqlè¿é€šæ€§</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8snode app<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat mysql.php </span>&lt;h1<span class="token punctuation">></span>Test php<span class="token punctuation">-</span>mysql &lt;/h1<span class="token punctuation">></span>&lt;<span class="token punctuation">?</span>phpmysqli_connect('10.97.108.119'<span class="token punctuation">,</span><span class="token string">'root'</span><span class="token punctuation">,</span>'123456') or die('failed');echo 'success';phpinfo();<span class="token punctuation">?</span><span class="token punctuation">></span></code></pre><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/3128067845.png"><br>è‡³æ­¤é…ç½®å®Œæˆåé¢å°±å¯ä»¥å§è‡ªå·±çš„é¡¹ç›®æ”¾åˆ°nginxå·¥ä½œç›®å½•æ„‰å¿«çš„ç©è€äº†(à¹‘â€¢Ì€ã…â€¢Ìà¸…)</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> lnmp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sæ•°æ®æŒä¹…åŒ–StorageClass</title>
      <link href="/c062e948/"/>
      <url>/c062e948/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a><strong>ä¸€ã€ç®€ä»‹</strong></h1><h3 id="1-1ä»€ä¹ˆæ˜¯StorageClass"><a href="#1-1ä»€ä¹ˆæ˜¯StorageClass" class="headerlink" title="1.1ä»€ä¹ˆæ˜¯StorageClass"></a><strong>1.1ä»€ä¹ˆæ˜¯StorageClass</strong></h3><p>Kubernetesæä¾›äº†ä¸€å¥—å¯ä»¥è‡ªåŠ¨åˆ›å»ºPVçš„æœºåˆ¶ï¼Œå³ï¼šDynamic Provisioningã€‚è€Œè¿™ä¸ªæœºåˆ¶çš„æ ¸å¿ƒåœ¨äºStorageClassè¿™ä¸ªAPIå¯¹è±¡ã€‚</p><p>StorageClasså¯¹è±¡ä¼šå®šä¹‰ä¸‹é¢ä¸¤éƒ¨åˆ†å†…å®¹:</p><ul><li>PVçš„å±æ€§ã€‚æ¯”å¦‚ï¼Œå­˜å‚¨ç±»å‹ï¼ŒVolumeçš„å¤§å°ç­‰ã€‚</li><li>åˆ›å»ºè¿™ç§PVéœ€è¦ç”¨åˆ°çš„å­˜å‚¨æ’ä»¶ï¼Œå³å­˜å‚¨åˆ¶å¤‡å™¨ã€‚<br>æœ‰äº†è¿™ä¸¤ä¸ªä¿¡æ¯ä¹‹åï¼ŒKuberneteså°±èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·æäº¤çš„PVCï¼Œæ‰¾åˆ°ä¸€ä¸ªå¯¹åº”çš„StorageClassï¼Œä¹‹åKuberneteså°±ä¼šè°ƒç”¨è¯¥StorageClasså£°æ˜çš„å­˜å‚¨æ’ä»¶ï¼Œè¿›è€Œåˆ›å»ºå‡ºéœ€è¦çš„PVã€‚</li></ul><p>ä½†æ˜¯å…¶å®ä½¿ç”¨èµ·æ¥æ˜¯ä¸€ä»¶å¾ˆç®€å•çš„äº‹æƒ…ï¼Œä½ åªéœ€è¦æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œç¼–å†™YAMLæ–‡ä»¶å³å¯ï¼Œç„¶åä½¿ç”¨kubectl createå‘½ä»¤æ‰§è¡Œå³å¯ã€‚</p><hr><h3 id="1-2StorageClassæ¶æ„"><a href="#1-2StorageClassæ¶æ„" class="headerlink" title="1.2StorageClassæ¶æ„"></a><strong>1.2StorageClassæ¶æ„</strong></h3><p>åœ¨åŠ¨æ€èµ„æºä¾›åº”æ¨¡å¼ä¸‹ï¼Œé€šè¿‡StorageClasså’ŒPVCå®Œæˆèµ„æºåŠ¨æ€ç»‘å®šï¼ˆç³»ç»Ÿè‡ªåŠ¨ç”ŸæˆPVï¼‰ï¼Œå¹¶ä¾›Podä½¿ç”¨çš„å­˜å‚¨ç®¡ç†æœºåˆ¶ã€‚<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/10/3784991912.png"></p><hr><h1 id="äºŒã€åˆ›å»º"><a href="#äºŒã€åˆ›å»º" class="headerlink" title="äºŒã€åˆ›å»º"></a><strong>äºŒã€åˆ›å»º</strong></h1><h3 id="2-1åˆ›å»ºStorageClasså­˜å‚¨æœåŠ¡"><a href="#2-1åˆ›å»ºStorageClasså­˜å‚¨æœåŠ¡" class="headerlink" title="2.1åˆ›å»ºStorageClasså­˜å‚¨æœåŠ¡"></a><strong>2.1åˆ›å»ºStorageClasså­˜å‚¨æœåŠ¡</strong></h3><p>åˆ©ç”¨nfs-client-provisioneræ¥ç”Ÿæˆä¸€ä¸ªåŸºäºnfsçš„StorageClassï¼Œéƒ¨ç½²é…ç½®yamlé…ç½®å¦‚ä¸‹ï¼Œä¿æŒä¸ºnfs-sc.yamlï¼š</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumes"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"persistentvolumeclaims"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storage.k8s.io"</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"storageclasses"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"events"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"endpoints"</span><span class="token punctuation">]</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"patch"</span><span class="token punctuation">]</span><span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01  </span><span class="token comment" spellcheck="true"># æ­¤å¤„ä¾›åº”è€…åå­—ä¾›storageclassè°ƒç”¨</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># å¡«å…¥NFSçš„åœ°å€</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/lnmp/test  <span class="token comment" spellcheck="true"># å¡«å…¥NFSæŒ‚è½½çš„ç›®å½•</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223   <span class="token comment" spellcheck="true"># å¡«å…¥NFSçš„åœ°å€</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/lnmp/test   <span class="token comment" spellcheck="true"># å¡«å…¥NFSæŒ‚è½½çš„ç›®å½•</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>test<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span><span class="token number">01</span><span class="token comment" spellcheck="true"># Supported policies: Deleteã€ Retain ï¼Œ default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#éƒ¨ç½²æœåŠ¡</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nfs-sc.yaml</span><span class="token comment" spellcheck="true">#å› ä¸ºæ˜¯åå‘ç³»ç»Ÿå±‚é¢çš„æœåŠ¡æ‰€ä»¥æ”¾åˆ°äº†kube-systemå‘½åç©ºé—´</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl -n kube-system get pod</span><span class="token comment" spellcheck="true">#æŸ¥çœ‹scçŠ¶æ€</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get sc</span>NAME       PROVISIONER          RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGEnfs<span class="token punctuation">-</span>test   nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>01   Retain          Immediate           false             2m43s</code></pre><hr><h3 id="2-2-åŸºäºSCåˆ›å»ºPVCæµ‹è¯•"><a href="#2-2-åŸºäºSCåˆ›å»ºPVCæµ‹è¯•" class="headerlink" title="2.2 åŸºäºSCåˆ›å»ºPVCæµ‹è¯•"></a><strong>2.2 åŸºäºSCåˆ›å»ºPVCæµ‹è¯•</strong></h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>sc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>test  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ReadWriteMany  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Mi</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f pvc-sc.yaml</span>persistentvolumeclaim/pvc<span class="token punctuation">-</span>sc created<span class="token comment" spellcheck="true">#æŸ¥çœ‹pvå’Œpvc</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pv</span>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                                           STORAGECLASS   REASON   AGEpvc<span class="token punctuation">-</span>bc40c73b<span class="token punctuation">-</span>cf4a<span class="token punctuation">-</span>4c2d<span class="token punctuation">-</span>a551<span class="token punctuation">-</span>c2fdbd7e245a   1Mi        RWX            Retain        Bound      default/pvc<span class="token punctuation">-</span>sc                                  nfs<span class="token punctuation">-</span>test             52s<span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pvc</span>NAME     STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEpvc<span class="token punctuation">-</span>sc   Bound    pvc<span class="token punctuation">-</span>bc40c73b<span class="token punctuation">-</span>cf4a<span class="token punctuation">-</span>4c2d<span class="token punctuation">-</span>a551<span class="token punctuation">-</span>c2fdbd7e245a   1Mi        RWX         nfs<span class="token punctuation">-</span>test       2m31s</code></pre><p>ä½¿ç”¨nginxæµ‹è¯•</p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># æˆ‘ä»¬è¿™é‡Œå°†nginxå®¹å™¨é»˜è®¤çš„é¡µé¢ç›®å½•æŒ‚è½½</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>files            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"/usr/share/nginx/html"</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html<span class="token punctuation">-</span>files          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>sc</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl apply -f nginx.yaml</span>deployment.apps/nginx created<span class="token comment" spellcheck="true">#æŸ¥çœ‹podæ˜¯å¦è¿è¡Œ</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po</span>NAME                     READY   STATUS    RESTARTS   AGEnginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m   1/1     Running   0          46s<span class="token comment" spellcheck="true">#è¿›å…¥podæµ‹è¯•æ˜¯å¦è®¾ç½®æˆåŠŸ</span><span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl exec -it nginx-76f5df5fcf-f8x9m -- bash</span>root@nginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m<span class="token punctuation">:</span>/<span class="token comment" spellcheck="true"># echo 'test' > /usr/share/nginx/html/index.html</span>root@nginx<span class="token punctuation">-</span>76f5df5fcf<span class="token punctuation">-</span>f8x9m<span class="token punctuation">:</span>/<span class="token comment" spellcheck="true"># exit</span>exit<span class="token punctuation">[</span>root@k8smaster StorageClass<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat /data/lnmp/test/default-pvc-sc-pvc-bc40c73b-cf4a-4c2d-a551-c2fdbd7e245a/index.html</span>test</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8så¼ºåˆ¶åˆ é™¤Terminatingçš„å‘½åç©ºé—´</title>
      <link href="/fafe3e8d/"/>
      <url>/fafe3e8d/</url>
      
        <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨æ—¥å¸¸çš„k8sç»´æŠ¤ä¸­ï¼Œç»å¸¸é‡åˆ°k8såˆ é™¤å‘½åç©ºé—´ä¸€ç›´å¤„äºTerminatingçš„çŠ¶æ€ è®©äººæŠ“ç‹‚::(æ€’) ä¸‹é¢æ€»ç»“ä¸‹å¼ºåˆ¶åˆ é™¤çš„æ–¹æ³•</p><h3 id="1-1-å°†nsèµ„æºä¿å­˜ä¸ºjsonæ–‡ä»¶"><a href="#1-1-å°†nsèµ„æºä¿å­˜ä¸ºjsonæ–‡ä»¶" class="headerlink" title="1.1 å°†nsèµ„æºä¿å­˜ä¸ºjsonæ–‡ä»¶"></a>1.1 å°†nsèµ„æºä¿å­˜ä¸ºjsonæ–‡ä»¶</h3><pre class=" language-bash"><code class="language-bash">kubectl get ns istio-system -o json <span class="token operator">></span>istis.json</code></pre><h3 id="2-1-åˆ é™¤jsonæ–‡ä»¶finalizerså­—æ®µ"><a href="#2-1-åˆ é™¤jsonæ–‡ä»¶finalizerså­—æ®µ" class="headerlink" title="2.1 åˆ é™¤jsonæ–‡ä»¶finalizerså­—æ®µ"></a>2.1 åˆ é™¤jsonæ–‡ä»¶finalizerså­—æ®µ</h3><pre class=" language-json"><code class="language-json"><span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"finalizers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token string">"kubernetes"</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre><h3 id="3-1å¯åŠ¨ä¸€ä¸ªkube-proxy"><a href="#3-1å¯åŠ¨ä¸€ä¸ªkube-proxy" class="headerlink" title="3.1å¯åŠ¨ä¸€ä¸ªkube proxy"></a>3.1å¯åŠ¨ä¸€ä¸ªkube proxy</h3><pre class=" language-bash"><code class="language-bash">kubectl proxy --port<span class="token operator">=</span>8081</code></pre><p>åœ¨å¯åŠ¨ä¸€ä¸ªç»ˆç«¯å¹¶æ‰§è¡Œä¸‹é¢å‘½ä»¤</p><pre class=" language-bash"><code class="language-bash">curl -k -H <span class="token string">"Content-Type: application/json"</span> -X PUT --data-binary @istis.json http://127.0.0.1:8081/api/v1/namespaces/istio-system/finalize</code></pre><p>å†æ¬¡æŸ¥çœ‹å°±å‘ç°å·²ç»æ­£å¸¸åˆ é™¤è¿™ä¸ªnsäº†::(æ»‘ç¨½)</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sé…ç½®ingress-nginxæš´éœ²æœåŠ¡</title>
      <link href="/3033822e/"/>
      <url>/3033822e/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h1><h4 id="1-1-ä»‹ç»"><a href="#1-1-ä»‹ç»" class="headerlink" title="1.1 ä»‹ç»"></a><strong>1.1 ä»‹ç»</strong></h4><p>åœ¨kubernetesä¸­ï¼ŒPODï¼ŒSVCçš„IPåœ°å€åªèƒ½é›†ç¾¤å†…éƒ¨ä½¿ç”¨ï¼Œé›†ç¾¤å¤–éƒ¨æ˜¯æ— æ³•è®¿é—®çš„ã€‚</p><p>ä¸ºäº†èƒ½è®©å¤–éƒ¨çš„åº”ç”¨è®¿é—®è¿›æ¥ï¼Œkubernetesæä¾›äº†å¦‚ä¸‹å‡ ç§æ–¹æ¡ˆï¼š</p><ul><li>NodePort</li><li>LoadBalancer</li><li>Ingress</li></ul><h4 id="1-2-å·¥ä½œåŸç†"><a href="#1-2-å·¥ä½œåŸç†" class="headerlink" title="1.2 å·¥ä½œåŸç†"></a><strong>1.2 å·¥ä½œåŸç†</strong></h4><ul><li>æœ¬è´¨ï¼š7å±‚http&#x2F;httpsä»£ç†</li><li>ingress controlleré€šè¿‡å’Œkubernetes apiserveräº¤äº’ï¼ŒåŠ¨æ€çš„è·å–é›†ç¾¤ä¸­çš„ingressè§„åˆ™</li><li>è§£æingressè§„åˆ™ï¼Œç”ŸæˆproxyæœåŠ¡çš„é…ç½®ï¼Œæ¯”å¦‚nginxé…ç½®</li><li>å†å†™åˆ°ingress proxyçš„podä¸­ï¼Œå¦‚æœpodè¿è¡Œçš„æ˜¯nginxæœåŠ¡ï¼Œå°±ç”Ÿæˆnginxé…ç½®ï¼Œå¹¶æ”¾åˆ°&#x2F;etc&#x2F;nginx&#x2F;nginx.confä¸­</li><li>ç„¶åreloadæœåŠ¡</li></ul><h1 id="äºŒã€é…ç½®"><a href="#äºŒã€é…ç½®" class="headerlink" title="äºŒã€é…ç½®"></a><strong>äºŒã€é…ç½®</strong></h1><h4 id="2-1-ingress-controlleré…ç½®"><a href="#2-1-ingress-controlleré…ç½®" class="headerlink" title="2.1 ingress-controlleré…ç½®"></a><strong>2.1 ingress-controlleré…ç½®</strong></h4><blockquote><p>é…ç½®å¦‚ä¸‹</p></blockquote><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps      <span class="token punctuation">-</span> endpoints      <span class="token punctuation">-</span> nodes      <span class="token punctuation">-</span> pods      <span class="token punctuation">-</span> secrets      <span class="token punctuation">-</span> namespaces      <span class="token punctuation">-</span> services    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"extensions"</span>      <span class="token punctuation">-</span> <span class="token string">"networking.k8s.io"</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> list      <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> events    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create      <span class="token punctuation">-</span> patch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"extensions"</span>      <span class="token punctuation">-</span> <span class="token string">"networking.k8s.io"</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ingresses/status    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> update  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> create  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">""</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> configmaps    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"ingress-controller-leader-nginx"</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> get      <span class="token punctuation">-</span> update<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount    <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>lb  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10254</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>configuration  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">keep-alive</span><span class="token punctuation">:</span> <span class="token string">"75"</span>  <span class="token key atrule">keep-alive-requests</span><span class="token punctuation">:</span> <span class="token string">"100"</span>  <span class="token key atrule">upstream-keepalive-connections</span><span class="token punctuation">:</span> <span class="token string">"10000"</span>  <span class="token key atrule">upstream-keepalive-requests</span><span class="token punctuation">:</span> <span class="token string">"100"</span>  <span class="token key atrule">upstream-keepalive-timeout</span><span class="token punctuation">:</span> <span class="token string">"60"</span>  <span class="token key atrule">allow-backend-server-header</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">enable-underscores-in-headers</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">generate-request-id</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">http-redirect-code</span><span class="token punctuation">:</span> <span class="token string">"301"</span>  <span class="token key atrule">ignore-invalid-headers</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">log-format-upstream</span><span class="token punctuation">:</span> '<span class="token punctuation">{</span><span class="token key atrule">"@timestamp"</span><span class="token punctuation">:</span> <span class="token string">"$time_iso8601"</span><span class="token punctuation">,</span><span class="token key atrule">"remote_addr"</span><span class="token punctuation">:</span> <span class="token string">"$remote_addr"</span><span class="token punctuation">,</span><span class="token key atrule">"x-forward-for"</span><span class="token punctuation">:</span> <span class="token string">"$proxy_add_x_forwarded_for"</span><span class="token punctuation">,</span><span class="token key atrule">"request_id"</span><span class="token punctuation">:</span> <span class="token string">"$req_id"</span><span class="token punctuation">,</span><span class="token key atrule">"remote_user"</span><span class="token punctuation">:</span> <span class="token string">"$remote_user"</span><span class="token punctuation">,</span><span class="token key atrule">"bytes_sent"</span><span class="token punctuation">:</span> $bytes_sent<span class="token punctuation">,</span><span class="token key atrule">"request_time"</span><span class="token punctuation">:</span> $request_time<span class="token punctuation">,</span><span class="token key atrule">"status"</span><span class="token punctuation">:</span> $status<span class="token punctuation">,</span><span class="token key atrule">"vhost"</span><span class="token punctuation">:</span> <span class="token string">"$host"</span><span class="token punctuation">,</span><span class="token key atrule">"request_proto"</span><span class="token punctuation">:</span> <span class="token string">"$server_protocol"</span><span class="token punctuation">,</span><span class="token key atrule">"path"</span><span class="token punctuation">:</span> <span class="token string">"$uri"</span><span class="token punctuation">,</span><span class="token key atrule">"request_query"</span><span class="token punctuation">:</span> <span class="token string">"$args"</span><span class="token punctuation">,</span><span class="token key atrule">"request_length"</span><span class="token punctuation">:</span> $request_length<span class="token punctuation">,</span><span class="token key atrule">"duration"</span><span class="token punctuation">:</span> $request_time<span class="token punctuation">,</span><span class="token key atrule">"method"</span><span class="token punctuation">:</span> <span class="token string">"$request_method"</span><span class="token punctuation">,</span><span class="token key atrule">"http_referrer"</span><span class="token punctuation">:</span> <span class="token string">"$http_referer"</span><span class="token punctuation">,</span><span class="token key atrule">"http_user_agent"</span><span class="token punctuation">:</span>  <span class="token string">"$http_user_agent"</span><span class="token punctuation">,</span>"upstream<span class="token punctuation">-</span>sever"<span class="token punctuation">:</span><span class="token string">"$proxy_upstream_name"</span><span class="token punctuation">,</span>"proxy_alternative_upstream_name"<span class="token punctuation">:</span><span class="token string">"$proxy_alternative_upstream_name"</span><span class="token punctuation">,</span>"upstream_addr"<span class="token punctuation">:</span><span class="token string">"$upstream_addr"</span><span class="token punctuation">,</span>"upstream_response_length"<span class="token punctuation">:</span>$upstream_response_length<span class="token punctuation">,</span>"upstream_response_time"<span class="token punctuation">:</span>$upstream_response_time<span class="token punctuation">,</span>"upstream_status"<span class="token punctuation">:</span>$upstream_status<span class="token punctuation">}</span>'  <span class="token key atrule">max-worker-connections</span><span class="token punctuation">:</span> <span class="token string">"65536"</span>  <span class="token key atrule">worker-processes</span><span class="token punctuation">:</span> <span class="token string">"2"</span>  <span class="token key atrule">proxy-body-size</span><span class="token punctuation">:</span> 20m  <span class="token key atrule">proxy-connect-timeout</span><span class="token punctuation">:</span> <span class="token string">"10"</span>  <span class="token key atrule">proxy_next_upstream</span><span class="token punctuation">:</span> error timeout http_502  <span class="token key atrule">reuse-port</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">server-tokens</span><span class="token punctuation">:</span> <span class="token string">"false"</span>  <span class="token key atrule">ssl-ciphers</span><span class="token punctuation">:</span> ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>kEDH+AESGCM<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>ECDHE<span class="token punctuation">-</span>ECDSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>DSS<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>DHE<span class="token punctuation">-</span>RSA<span class="token punctuation">-</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>GCM<span class="token punctuation">-</span>SHA384<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>SHA256<span class="token punctuation">:</span>AES128<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES256<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span>AES<span class="token punctuation">:</span>CAMELLIA<span class="token punctuation">:</span>DES<span class="token punctuation">-</span>CBC3<span class="token punctuation">-</span>SHA<span class="token punctuation">:</span><span class="token tag">!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA</span>  <span class="token key atrule">ssl-protocols</span><span class="token punctuation">:</span> TLSv1 TLSv1.1 TLSv1.2  <span class="token key atrule">ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"false"</span>  <span class="token key atrule">worker-cpu-affinity</span><span class="token punctuation">:</span> auto<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp<span class="token punctuation">-</span>services  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> udp<span class="token punctuation">-</span>services  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">component.version</span><span class="token punctuation">:</span> <span class="token string">"v0.30.0"</span>    <span class="token key atrule">component.revision</span><span class="token punctuation">:</span> <span class="token string">"v1"</span><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>nginx      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">prometheus.io/port</span><span class="token punctuation">:</span> <span class="token string">"10254"</span>        <span class="token key atrule">prometheus.io/scrape</span><span class="token punctuation">:</span> <span class="token string">"true"</span>        <span class="token key atrule">scheduler.alpha.kubernetes.io/critical-pod</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>node<span class="token punctuation">-</span>critical      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                  <span class="token key atrule">values</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> ingress<span class="token punctuation">-</span>nginx              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname            <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">100</span>        <span class="token key atrule">nodeAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>            <span class="token key atrule">nodeSelectorTerms</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> type                <span class="token key atrule">operator</span><span class="token punctuation">:</span> NotIn                <span class="token key atrule">values</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> virtual<span class="token punctuation">-</span>kubelet      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/acs/aliyun<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">:</span>v0.30.0.2<span class="token punctuation">-</span>9597b3685<span class="token punctuation">-</span>aliyun          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/nginx<span class="token punctuation">-</span>configuration            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tcp<span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/tcp<span class="token punctuation">-</span>services            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>udp<span class="token punctuation">-</span>services<span class="token punctuation">-</span>configmap=$(POD_NAMESPACE)/udp<span class="token punctuation">-</span>services            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>publish<span class="token punctuation">-</span>service=$(POD_NAMESPACE)/nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>lb            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>annotations<span class="token punctuation">-</span>prefix=nginx.ingress.kubernetes.io            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>enable<span class="token punctuation">-</span>dynamic<span class="token punctuation">-</span>certificates=true            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>v=2          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>            <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>            <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>              <span class="token key atrule">drop</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> ALL              <span class="token key atrule">add</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> NET_BIND_SERVICE            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">101</span>          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https              <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>              <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>            <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/localtime            <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime            <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> localtime        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/localtime          <span class="token key atrule">type</span><span class="token punctuation">:</span> File      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> /bin/sh        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          mount -o remount rw /proc/sys          sysctl -w net.core.somaxconn=65535          sysctl -w net.ipv4.ip_local_port_range="1024 65535"          sysctl -w fs.file-max=1048576          sysctl -w fs.inotify.max_user_instances=16384          sysctl -w fs.inotify.max_user_watches=524288          sysctl -w fs.inotify.max_queued_events=16384</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/acs/busybox<span class="token punctuation">:</span>v1.29.2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>sysctl        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">procMount</span><span class="token punctuation">:</span> Default</code></pre><h4 id="2-2é…ç½®ç”¨äºæµ‹è¯•çš„nginx-pod"><a href="#2-2é…ç½®ç”¨äºæµ‹è¯•çš„nginx-pod" class="headerlink" title="2.2é…ç½®ç”¨äºæµ‹è¯•çš„nginx pod"></a><strong>2.2é…ç½®ç”¨äºæµ‹è¯•çš„nginx pod</strong></h4><blockquote><p>yamlæ¸…å•å¦‚ä¸‹</p></blockquote><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx</code></pre><h4 id="2-3é…ç½®ingress"><a href="#2-3é…ç½®ingress" class="headerlink" title="2.3é…ç½®ingress"></a><strong>2.3é…ç½®ingress</strong></h4><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nginx.boge.com      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">paths</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /          <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix          <span class="token key atrule">backend</span><span class="token punctuation">:</span>            <span class="token key atrule">service</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx              <span class="token key atrule">port</span><span class="token punctuation">:</span>                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><h4 id="2-4-éƒ¨ç½²"><a href="#2-4-éƒ¨ç½²" class="headerlink" title="2.4 éƒ¨ç½²"></a><strong>2.4 éƒ¨ç½²</strong></h4><blockquote><p>yamlæ¸…å•ä¸­æœ‰æŒ‡å®šnodeselector æ‰€ä»¥éœ€è¦ç¡®è®¤nodeéƒ½æœ‰è¿™ä¸ªæ ‡ç­¾ï¼Œpodæ‰ä¼šè¢«æ­£å¸¸è°ƒåº¦</p></blockquote><pre class=" language-yaml"><code class="language-yaml">kubectl label node 10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>48<span class="token punctuation">-</span>223 boge/ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>ready=truekubectl label node 10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>110<span class="token punctuation">-</span>221 boge/ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>ready=true<span class="token comment" spellcheck="true">#æ ‡ç­¾é…ç½®å®Œæˆå³å¯å¯åŠ¨ingress-controller</span>kubectl apply <span class="token punctuation">-</span>f ingress.yaml<span class="token comment" spellcheck="true"># æŸ¥çœ‹podæ˜¯å¦éƒ½æ­£å¸¸è¿è¡Œ</span>kubectl <span class="token punctuation">-</span>n ingress<span class="token punctuation">-</span>nginx get pod <span class="token punctuation">-</span>o wideNAME                             READY   STATUS    RESTARTS   AGE   IP             NODE           NOMINATED NODE   READINESS GATESnginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>6pgmj   1/1     Running   0          70m   10.7.110.221   10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>110<span class="token punctuation">-</span>221   &lt;none<span class="token punctuation">></span>           &lt;none<span class="token punctuation">></span>nginx<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>gfksc   1/1     Running   0          70m   10.7.48.223    10<span class="token punctuation">-</span>7<span class="token punctuation">-</span>48<span class="token punctuation">-</span>223    &lt;none<span class="token punctuation">></span>           &lt;none<span class="token punctuation">></span><span class="token comment" spellcheck="true">#å¯åŠ¨nginx deploy</span>kubectl apply <span class="token punctuation">-</span>f nginx.yaml<span class="token comment" spellcheck="true">#å¯åŠ¨ingress</span>kubectl apply <span class="token punctuation">-</span>f nginx<span class="token punctuation">-</span>ingress.yaml<span class="token comment" spellcheck="true">#æŸ¥çœ‹ingressèµ„æº</span>kubectl get ingressNAME            CLASS    HOSTS            ADDRESS          PORTS   AGEnginx<span class="token punctuation">-</span>ingress   &lt;none<span class="token punctuation">></span>   nginx.boge.com   10.102.200.157   80      70m</code></pre><h1 id="ä¸‰ã€æµ‹è¯•"><a href="#ä¸‰ã€æµ‹è¯•" class="headerlink" title="ä¸‰ã€æµ‹è¯•"></a><strong>ä¸‰ã€æµ‹è¯•</strong></h1><pre class=" language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">#å¯ä»¥åœ¨å…¶ä»–çš„èŠ‚ç‚¹ï¼Œç»‘å®šhostsæµ‹è¯•</span>curl nginx.boge.com&lt;<span class="token tag">!DOCTYPE</span> html<span class="token punctuation">></span>&lt;html<span class="token punctuation">></span>&lt;head<span class="token punctuation">></span>&lt;title<span class="token punctuation">></span>Welcome to nginx<span class="token tag">!&lt;/title></span>&lt;style<span class="token punctuation">></span>html <span class="token punctuation">{</span> <span class="token key atrule">color-scheme</span><span class="token punctuation">:</span> light dark; <span class="token punctuation">}</span>body <span class="token punctuation">{</span> <span class="token key atrule">width</span><span class="token punctuation">:</span> 35em; margin<span class="token punctuation">:</span> 0 auto;<span class="token key atrule">font-family</span><span class="token punctuation">:</span> Tahoma<span class="token punctuation">,</span> Verdana<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans<span class="token punctuation">-</span>serif; <span class="token punctuation">}</span>&lt;/style<span class="token punctuation">></span>&lt;/head<span class="token punctuation">></span>&lt;body<span class="token punctuation">></span>&lt;h1<span class="token punctuation">></span>Welcome to nginx<span class="token tag">!&lt;/h1></span>&lt;p<span class="token punctuation">></span>If you see this page<span class="token punctuation">,</span> the nginx web server is successfully installed andworking. Further configuration is required.&lt;/p<span class="token punctuation">></span>&lt;p<span class="token punctuation">></span>For online documentation and support please refer to&lt;a href="http<span class="token punctuation">:</span>//nginx.org/"<span class="token punctuation">></span>nginx.org&lt;/a<span class="token punctuation">></span>.&lt;br/<span class="token punctuation">></span>Commercial support is available at&lt;a href="http<span class="token punctuation">:</span>//nginx.com/"<span class="token punctuation">></span>nginx.com&lt;/a<span class="token punctuation">></span>.&lt;/p<span class="token punctuation">></span>&lt;p<span class="token punctuation">></span>&lt;em<span class="token punctuation">></span>Thank you for using nginx.&lt;/em<span class="token punctuation">></span>&lt;/p<span class="token punctuation">></span>&lt;/body<span class="token punctuation">></span>&lt;/html<span class="token punctuation">></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8sé…ç½®4å±‚è½¬å‘nginx</title>
      <link href="/54433e83/"/>
      <url>/54433e83/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å››å±‚è½¬å‘å’Œä¸ƒå±‚è½¬å‘"><a href="#ä¸€-å››å±‚è½¬å‘å’Œä¸ƒå±‚è½¬å‘" class="headerlink" title="ä¸€ å››å±‚è½¬å‘å’Œä¸ƒå±‚è½¬å‘"></a>ä¸€ å››å±‚è½¬å‘å’Œä¸ƒå±‚è½¬å‘</h1><h3 id="1-1å››å±‚è´Ÿè½½å‡è¡¡"><a href="#1-1å››å±‚è´Ÿè½½å‡è¡¡" class="headerlink" title="1.1å››å±‚è´Ÿè½½å‡è¡¡"></a>1.1å››å±‚è´Ÿè½½å‡è¡¡</h3><p>å››å±‚è´Ÿè½½å‡è¡¡å·¥ä½œåœ¨OSIæ¨¡å‹çš„ä¼ è¾“å±‚ï¼Œç”±äºåœ¨ä¼ è¾“å±‚ï¼Œåªæœ‰TCP&#x2F;UDPåè®®ï¼Œè¿™ä¸¤ç§åè®®ä¸­é™¤äº†åŒ…å«æºIPã€ç›®æ ‡IPä»¥å¤–ï¼Œè¿˜åŒ…å«æºç«¯å£å·åŠç›®çš„ç«¯å£å·ã€‚å››å±‚è´Ÿè½½å‡è¡¡æœåŠ¡å™¨åœ¨æ¥å—åˆ°å®¢æˆ·ç«¯è¯·æ±‚åï¼Œä»¥åé€šè¿‡ä¿®æ”¹æ•°æ®åŒ…çš„åœ°å€ä¿¡æ¯ï¼ˆIP+ç«¯å£å·ï¼‰å°†æµé‡è½¬å‘åˆ°åº”ç”¨æœåŠ¡å™¨ã€‚</p><h3 id="1-2ä¸ƒå±‚è´Ÿè½½å‡è¡¡"><a href="#1-2ä¸ƒå±‚è´Ÿè½½å‡è¡¡" class="headerlink" title="1.2ä¸ƒå±‚è´Ÿè½½å‡è¡¡"></a>1.2ä¸ƒå±‚è´Ÿè½½å‡è¡¡</h3><p>ä¸ƒå±‚è´Ÿè½½å‡è¡¡å·¥ä½œåœ¨OSIæ¨¡å‹çš„åº”ç”¨å±‚ï¼Œåº”ç”¨å±‚åè®®è¾ƒå¤šï¼Œå¸¸ç”¨httpã€radiusã€dnsç­‰ã€‚ä¸ƒå±‚è´Ÿè½½å°±å¯ä»¥åŸºäºè¿™äº›åè®®æ¥è´Ÿè½½ã€‚è¿™äº›åº”ç”¨å±‚åè®®ä¸­ä¼šåŒ…å«å¾ˆå¤šæœ‰æ„ä¹‰çš„å†…å®¹ã€‚æ¯”å¦‚åŒä¸€ä¸ªWebæœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡ï¼Œé™¤äº†æ ¹æ®IPåŠ ç«¯å£è¿›è¡Œè´Ÿè½½å¤–ï¼Œè¿˜å¯æ ¹æ®ä¸ƒå±‚çš„URLã€æµè§ˆå™¨ç±»åˆ«ã€è¯­è¨€æ¥å†³å®šæ˜¯å¦è¦è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/1508471474.jpeg"></p><h1 id="äºŒ-Nginx4å±‚è½¬å‘çš„é…ç½®"><a href="#äºŒ-Nginx4å±‚è½¬å‘çš„é…ç½®" class="headerlink" title="äºŒ Nginx4å±‚è½¬å‘çš„é…ç½®"></a>äºŒ Nginx4å±‚è½¬å‘çš„é…ç½®</h1><p>ç”Ÿäº§ä¸šåŠ¡ä¸­å¾ˆå¤šç«¯å£åªèƒ½ä½¿ç”¨tcpè¿æ¥ æ¯”å¦‚mysql ssh è¿™äº›ç«¯å£æ˜¯æ— æ³•ä½¿ç”¨æ™®é€šçš„7å±‚ä»£ç†è¿›è¡Œè½¬å‘çš„ å› æ­¤éœ€è¦æˆ‘ä»¬é…ç½®nginxçš„å››å±‚è½¬å‘</p><h3 id="2-1-Nginx-Dockerfileé…ç½®"><a href="#2-1-Nginx-Dockerfileé…ç½®" class="headerlink" title="2.1 Nginx Dockerfileé…ç½®"></a>2.1 Nginx Dockerfileé…ç½®</h3><p>åˆ›å»ºNginx Dockerfile nginxç¼–è¯‘éœ€è¦â€“with-stream æ¨¡å— å¦åˆ™æ— æ³•é…ç½®</p><pre class=" language-bash"><code class="language-bash">FROM centos:7.8.2003MAINTAINER huhuhaheiADD nginx-1.12.0.tar.gz /optRUN yum -y <span class="token function">install</span> gcc gcc-c++ lrzsz pcre-devel zlib-devel openssl openssl-devel <span class="token operator">&amp;&amp;</span> <span class="token function">useradd</span> -M -s /sbin/nologin nginx <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> /opt/nginx-1.12.0/ <span class="token operator">&amp;&amp;</span> ./configure --prefix<span class="token operator">=</span>/usr/local/nginx --user<span class="token operator">=</span>nginx --group<span class="token operator">=</span>nginx --with-http_stub_status_module --with-http_ssl_module --with-stream <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token function">install</span></code></pre><h3 id="2-2-åˆ›å»ºè½¬å‘çš„é…ç½®æ–‡ä»¶"><a href="#2-2-åˆ›å»ºè½¬å‘çš„é…ç½®æ–‡ä»¶" class="headerlink" title="2.2 åˆ›å»ºè½¬å‘çš„é…ç½®æ–‡ä»¶"></a>2.2 åˆ›å»ºè½¬å‘çš„é…ç½®æ–‡ä»¶</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">nginx.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    user  root;    worker_processes  auto;    error_log  logs/error.log  info;    pid        logs/nginx.pid;</span>    events <span class="token punctuation">{</span>        use epoll;    <span class="token punctuation">}</span>    stream <span class="token punctuation">{</span>      upstream backend <span class="token punctuation">{</span>          server *****<span class="token punctuation">:</span>8080 max_fails=3 fail_timeout=30s;      <span class="token punctuation">}</span>      server <span class="token punctuation">{</span>          listen 8080;          proxy_connect_timeout 1s;          proxy_timeout 3s;          proxy_pass backend;      <span class="token punctuation">}</span>      log_format proxy '$remote_addr <span class="token punctuation">[</span>$time_local<span class="token punctuation">]</span>'                '$protocol $status $bytes_sent $bytes_received'                '$session_time "$upstream_addr" '                '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';            access_log /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>access.log proxy ;      error_log  /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>error.log warn ;          <span class="token punctuation">}</span>    http <span class="token punctuation">{</span>        include       /usr/local/nginx/conf/mime.types;        default_type  application/octet<span class="token punctuation">-</span>stream;      <span class="token punctuation">}</span></code></pre><h3 id="2-3-åˆ›å»ºNginx-deployæ–‡ä»¶"><a href="#2-3-åˆ›å»ºNginx-deployæ–‡ä»¶" class="headerlink" title="2.3 åˆ›å»ºNginx deployæ–‡ä»¶"></a>2.3 åˆ›å»ºNginx deployæ–‡ä»¶</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf            <span class="token key atrule">items</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx.conf                <span class="token key atrule">path</span><span class="token punctuation">:</span> nginx.conf            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">420</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs          <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx          <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'harbor.huhuhahei.cn/test/nginx_proxy:v2'</span>          <span class="token key atrule">command</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> ./usr/local/nginx/sbin/nginx          <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token string">'-g daemon off;'</span>            <span class="token punctuation">-</span> <span class="token string">'-c'</span>            <span class="token punctuation">-</span> /opt/nginx.conf          <span class="token key atrule">ports</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_proxy<span class="token punctuation">-</span>access<span class="token punctuation">-</span>log              <span class="token key atrule">value</span><span class="token punctuation">:</span> /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>access.log            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> aliyun_logs_proxy<span class="token punctuation">-</span>error<span class="token punctuation">-</span>log              <span class="token key atrule">value</span><span class="token punctuation">:</span> /usr/local/nginx/logs/tcp<span class="token punctuation">-</span>error.log            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai          <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>conf              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> logs              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/logs/          <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log          <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span></code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> proxy<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> proxy      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8sé›†ç¾¤å†…é…ç½®corednsè§£æ</title>
      <link href="/69f5e54a/"/>
      <url>/69f5e54a/</url>
      
        <content type="html"><![CDATA[<p>ç¼–è¾‘corednsçš„confmap</p><pre class=" language-bash"><code class="language-bash">kubectl -n kube-system edit configmaps coredns</code></pre><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">Corefile</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    .:53 {        errors        health        ready</span><span class="token comment" spellcheck="true"># æ·»åŠ ä¸‹é¢</span>        log        rewrite stop <span class="token punctuation">{</span>          name regex git.boge.com gitlab.gitlab<span class="token punctuation">-</span>ver130806.svc.cluster.local<span class="token comment" spellcheck="true"># å°†åŸŸåè§£æåˆ°é»˜è®¤çš„svcåŸŸå</span>          answer name gitlab.gitlab<span class="token punctuation">-</span>ver130806.svc.cluster.local git.boge.com<span class="token comment" spellcheck="true"># åå‘è§£æ</span>        <span class="token punctuation">}</span><span class="token comment" spellcheck="true"># </span>        kubernetes cluster.local in<span class="token punctuation">-</span>addr.arpa ip6.arpa <span class="token punctuation">{</span>          pods verified          fallthrough in<span class="token punctuation">-</span>addr.arpa ip6.arpa        <span class="token punctuation">}</span>        autopath @kubernetes        prometheus <span class="token punctuation">:</span><span class="token number">9153</span>        forward . /etc/resolv.conf        cache 30        loop        reload        loadbalance    <span class="token punctuation">}</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> coredns  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system  </code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8såŸºç¡€yamlæ–‡ä»¶</title>
      <link href="/b19e20d5/"/>
      <url>/b19e20d5/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€åŸºç¡€Podé…ç½®"><a href="#ä¸€ã€åŸºç¡€Podé…ç½®" class="headerlink" title="ä¸€ã€åŸºç¡€Podé…ç½®"></a>ä¸€ã€åŸºç¡€Podé…ç½®</h1><p><strong>nginxï¼š</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>    <span class="token punctuation">-</span> <span class="token string">"-c"</span>    <span class="token punctuation">-</span> <span class="token string">"sleep 3600"</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd</code></pre><hr><p><strong>å­˜æ´»æ€§æ¢é’ˆé…ç½®ï¼š</strong><br>exec</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>pod  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"touch /tmp/healthy sleep 60; rm -f /tmp/healthy; sleep 3600"</span><span class="token punctuation">]</span>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">exec</span><span class="token punctuation">:</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"-e"</span><span class="token punctuation">,</span><span class="token string">"/tmp/healthy"</span><span class="token punctuation">]</span>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></code></pre><p>HttpGet</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>httpget  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> liveness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> http        <span class="token key atrule">path</span><span class="token punctuation">:</span> /index.html      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span></code></pre><hr><p><strong>å°±ç»ªæ€§æ¢é’ˆï¼š</strong><br>HttpGet</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness<span class="token punctuation">-</span>httpget  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> readiness<span class="token punctuation">-</span>exec<span class="token punctuation">-</span>cpntainer    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>        <span class="token key atrule">port</span><span class="token punctuation">:</span> http        <span class="token key atrule">path</span><span class="token punctuation">:</span> /index.html      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">3</span></code></pre><hr><h1 id="äºŒã€è°ƒåº¦å™¨åŸºç¡€é…ç½®"><a href="#äºŒã€è°ƒåº¦å™¨åŸºç¡€é…ç½®" class="headerlink" title="äºŒã€è°ƒåº¦å™¨åŸºç¡€é…ç½®"></a>äºŒã€è°ƒåº¦å™¨åŸºç¡€é…ç½®</h1><p><strong>ReplicaSet</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp      <span class="token key atrule">release</span><span class="token punctuation">:</span> canary  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp        <span class="token key atrule">release</span><span class="token punctuation">:</span> canary        <span class="token key atrule">environment</span><span class="token punctuation">:</span> qa    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>container        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><hr><p><strong>Deployment</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> php        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/lnmp_php<span class="token punctuation">:</span>v1        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9000</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/html      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> harbor.huhuhahei.cn/huhuhahei/lnmp_nginx<span class="token punctuation">:</span>v2        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/html        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/local/nginx/conf/conf.d/        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>logs          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/nginx      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>data        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> blog<span class="token punctuation">-</span>nginx      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>logs        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> blog<span class="token punctuation">-</span>logs      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>         <span class="token key atrule">name</span><span class="token punctuation">:</span> ngin<span class="token punctuation">-</span>conf         <span class="token key atrule">items</span><span class="token punctuation">:</span>         <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx.conf           <span class="token key atrule">path</span><span class="token punctuation">:</span> add.conf</code></pre><p><strong>DaemonSet</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> redis      <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> redis        <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis        <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>4.0<span class="token punctuation">-</span>alpine        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat<span class="token punctuation">-</span>ds  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat      <span class="token key atrule">release</span><span class="token punctuation">:</span> stable  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> filebeat        <span class="token key atrule">release</span><span class="token punctuation">:</span> stable    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> filebeat        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/filebeat<span class="token punctuation">:</span>5.6.5<span class="token punctuation">-</span>alpine        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_HOST          <span class="token key atrule">value</span><span class="token punctuation">:</span> redis.default.svc.cluster.local        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REDIS_LOG_LEVEL          <span class="token key atrule">value</span><span class="token punctuation">:</span> info</code></pre><p><strong>statefulset</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>statefulset  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp        <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> web        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myappdata          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> myappdata    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"ReadWriteOnce"</span> <span class="token punctuation">]</span>      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi</code></pre><h1 id="ä¸‰ã€Serviceé…ç½®"><a href="#ä¸‰ã€Serviceé…ç½®" class="headerlink" title="ä¸‰ã€Serviceé…ç½®"></a>ä¸‰ã€Serviceé…ç½®</h1><p><strong>NodePort</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">release</span><span class="token punctuation">:</span> canary  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.99.99.99  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30080</span></code></pre><p><strong>ClusterIP</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> redis    <span class="token key atrule">role</span><span class="token punctuation">:</span> logstor  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.97.97.97  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span></code></pre><h1 id="å››ã€æŒä¹…å·é…ç½®"><a href="#å››ã€æŒä¹…å·é…ç½®" class="headerlink" title="å››ã€æŒä¹…å·é…ç½®"></a>å››ã€æŒä¹…å·é…ç½®</h1><p><strong>emptyDir</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>port  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>latest    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data/    <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>    <span class="token punctuation">-</span> <span class="token string">"-c"</span>    <span class="token punctuation">-</span> <span class="token string">"while true; do echo $(date) >> /data/index.html; sleep 2;done"</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">disktype</span><span class="token punctuation">:</span> ssd  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p><strong>hostpath</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>hostpath  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/pod/volume1      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate</code></pre><p><strong>nfs</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>nfs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">nfs</span><span class="token punctuation">:</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/test      <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223</code></pre><p><strong>PV</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv001  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0001<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v1    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv002  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0002<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v2    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv003  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0003<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v3    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv004  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0004<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v4    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv005  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0005<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/v5    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.7.48.223  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">,</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi<span class="token punctuation">---</span></code></pre><p><strong>pvc</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypvc  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteMany"</span><span class="token punctuation">]</span>  <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token key atrule">requests</span><span class="token punctuation">:</span>      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 6Gi<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>vol<span class="token punctuation">-</span>pvc<span class="token punctuation">-</span>nfs  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html/  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> html    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> mypvc</code></pre><h1 id="äº”ã€é…ç½®ä¸­å¿ƒï¼ˆconfigmapï¼‰"><a href="#äº”ã€é…ç½®ä¸­å¿ƒï¼ˆconfigmapï¼‰" class="headerlink" title="äº”ã€é…ç½®ä¸­å¿ƒï¼ˆconfigmapï¼‰"></a>äº”ã€é…ç½®ä¸­å¿ƒï¼ˆconfigmapï¼‰</h1><p><strong>é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥é…ç½®</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>cm<span class="token punctuation">-</span><span class="token number">1</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NGINX_SERVER_PORT      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config          <span class="token key atrule">key</span><span class="token punctuation">:</span> nginx_port    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NGINX_SERVER_NAME      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config          <span class="token key atrule">key</span><span class="token punctuation">:</span> server_name</code></pre><p><strong>é€šè¿‡é…ç½®æ–‡ä»¶æ³¨å…¥</strong></p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>cm<span class="token punctuation">-</span><span class="token number">2</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp    <span class="token key atrule">image</span><span class="token punctuation">:</span> ikubernetes/myapp<span class="token punctuation">:</span>v1    <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginxconf      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/nginx/config.d/      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginxconf    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>config</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ingressé«˜çº§é…ç½®</title>
      <link href="/893a2674/"/>
      <url>/893a2674/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-é…ç½®ingressè·¯å¾„é‡å†™"><a href="#ä¸€-é…ç½®ingressè·¯å¾„é‡å†™" class="headerlink" title="ä¸€.é…ç½®ingressè·¯å¾„é‡å†™"></a>ä¸€.é…ç½®ingressè·¯å¾„é‡å†™</h1><p>è‹¥åç«¯è·¯å¾„æ˜¯&#x2F;app é»˜è®¤è®¿é—®æ˜¯ä¸å¸¦è·¯å¾„çš„ä¼šå¯¼è‡´å‡ºç°404çš„æƒ…å†µ å› æ­¤éœ€è¦é…ç½®ä¸‹è·¯å¾„é‡å†™</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/app-root</span><span class="token punctuation">:</span> /nacos  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>discovery<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> port<span class="token punctuation">-</span>forward<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> nacos.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nacos          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /nacos</code></pre><hr><h1 id="äºŒ-é…ç½®ingressç™½åå•è®¿é—®"><a href="#äºŒ-é…ç½®ingressç™½åå•è®¿é—®" class="headerlink" title="äºŒ.é…ç½®ingressç™½åå•è®¿é—®"></a>äºŒ.é…ç½®ingressç™½åå•è®¿é—®</h1><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/whitelist-source-range</span><span class="token punctuation">:</span> 117.50.34.153  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> prometheus.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">9090</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix</code></pre><p>å…¶ä»–ipè®¿é—®æµ‹è¯•</p><pre class=" language-yaml"><code class="language-yaml">curl <span class="token punctuation">-</span>I prometheus.huhuhahei.cnHTTP/1.1 403 Forbidden<span class="token key atrule">Date</span><span class="token punctuation">:</span> Fri<span class="token punctuation">,</span> 04 Mar 2022 03<span class="token punctuation">:</span>08<span class="token punctuation">:</span>38 GMT<span class="token key atrule">Content-Type</span><span class="token punctuation">:</span> text/html<span class="token key atrule">Content-Length</span><span class="token punctuation">:</span> <span class="token number">146</span><span class="token key atrule">Connection</span><span class="token punctuation">:</span> keep<span class="token punctuation">-</span>alive</code></pre><p>ç™½åå•è®¿é—®æµ‹è¯•</p><pre class=" language-bash"><code class="language-bash">curl -I prometheus.huhuhahei.cnHTTP/1.1 405 Method Not AllowedDate: Fri, 04 Mar 2022 03:10:19 GMTContent-Type: text/plain<span class="token punctuation">;</span> charset<span class="token operator">=</span>utf-8Content-Length: 19Connection: keep-aliveAllow: GET, OPTIONSX-Content-Type-Options: nosniff</code></pre><hr><h1 id="ä¸‰-é…ç½®ç™»å½•éªŒè¯"><a href="#ä¸‰-é…ç½®ç™»å½•éªŒè¯" class="headerlink" title="ä¸‰. é…ç½®ç™»å½•éªŒè¯"></a>ä¸‰. é…ç½®ç™»å½•éªŒè¯</h1><p>é¦–å…ˆéœ€è¦åˆ›å»ºå¯†ç æ–‡ä»¶</p><pre class=" language-bash"><code class="language-bash">htpasswd -c auth adminNew password: Re-type new password: Adding password <span class="token keyword">for</span> user admin</code></pre><p>åˆ›å»ºsecret</p><pre class=" language-bash"><code class="language-bash">kubectl create secret generic  kibana-auth --from-file<span class="token operator">=</span>auth -n logssecret/kibana-auth created</code></pre><p>é…ç½®ingress</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-realm</span><span class="token punctuation">:</span> Need to longin    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-secret</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>auth    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-type</span><span class="token punctuation">:</span> basic  <span class="token key atrule">name</span><span class="token punctuation">:</span> kibana<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> kibana.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kibana          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">5601</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /</code></pre><p>ç™»å½•æµ‹è¯•</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/1537476990.png"></p><hr><h1 id="å››-é…ç½®åŸŸåé‡å®šå‘"><a href="#å››-é…ç½®åŸŸåé‡å®šå‘" class="headerlink" title="å››.é…ç½®åŸŸåé‡å®šå‘"></a>å››.é…ç½®åŸŸåé‡å®šå‘</h1><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/permanent-redirect</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//www.huhuhahei.cn  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> logs<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> web.huhuhahei.cn    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kibana          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">5601</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /</code></pre><p>æµ‹è¯•</p><pre class=" language-bash"><code class="language-bash">curl -I web.huhuhahei.cnHTTP/1.1 301 Moved PermanentlyDate: Fri, 04 Mar 2022 03:30:07 GMTContent-Type: text/htmlContent-Length: 162Connection: keep-aliveLocation: https://www.huhuhahei.cn</code></pre><h3 id="äº”-é…ç½®è·¨åŸŸ"><a href="#äº”-é…ç½®è·¨åŸŸ" class="headerlink" title="äº”.é…ç½®è·¨åŸŸ"></a>äº”.é…ç½®è·¨åŸŸ</h3><pre class=" language-yaml"><code class="language-yaml">    <span class="token key atrule">nginx.ingress.kubernetes.io/Access-Control-Allow-Origin</span><span class="token punctuation">:</span> <span class="token string">'*'</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/cors-allow-headers</span><span class="token punctuation">:</span> DNT<span class="token punctuation">,</span>X<span class="token punctuation">-</span>CustomHeader<span class="token punctuation">,</span>Keep<span class="token punctuation">-</span>Alive<span class="token punctuation">,</span>User<span class="token punctuation">-</span>Agent<span class="token punctuation">,</span>X<span class="token punctuation">-</span>Requested<span class="token punctuation">-</span>With<span class="token punctuation">,</span>If<span class="token punctuation">-</span>Modified<span class="token punctuation">-</span>Since<span class="token punctuation">,</span>Cache<span class="token punctuation">-</span>Control<span class="token punctuation">,</span>Content<span class="token punctuation">-</span>Type<span class="token punctuation">,</span>Authorization    <span class="token key atrule">nginx.ingress.kubernetes.io/cors-allow-methods</span><span class="token punctuation">:</span> PUT<span class="token punctuation">,</span> GET<span class="token punctuation">,</span> POST<span class="token punctuation">,</span> OPTIONS    <span class="token key atrule">nginx.ingress.kubernetes.io/cors-allow-origin</span><span class="token punctuation">:</span> <span class="token string">'*'</span></code></pre><h3 id="å…­-é…ç½®é™é€Ÿ"><a href="#å…­-é…ç½®é™é€Ÿ" class="headerlink" title="å…­.é…ç½®é™é€Ÿ"></a>å…­.é…ç½®é™é€Ÿ</h3><ul><li><code>nginx.ingress.kubernetes.io/limit-connections</code>ï¼šå…è®¸æ¥è‡ªå•ä¸ª IP åœ°å€çš„å¹¶å‘è¿æ¥æ•°ã€‚è¶…è¿‡æ­¤é™åˆ¶æ—¶è¿”å› 503 é”™è¯¯ã€‚</li><li><code>nginx.ingress.kubernetes.io/limit-rps</code>ï¼šæ¯ç§’ä»ç»™å®š IP æ¥å—çš„è¯·æ±‚æ•°ã€‚çªå‘é™åˆ¶è®¾ç½®ä¸ºæ­¤é™åˆ¶ä¹˜ä»¥çªå‘å€æ•°ï¼Œé»˜è®¤å€æ•°ä¸º 5ã€‚å½“å®¢æˆ·ç«¯è¶…è¿‡æ­¤é™åˆ¶æ—¶ï¼Œè¿”å›<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">limit-req-status-code </a>*<strong>default:*</strong> 503ã€‚</li><li><code>nginx.ingress.kubernetes.io/limit-rpm</code>ï¼šæ¯åˆ†é’Ÿä»ç»™å®š IP æ¥å—çš„è¯·æ±‚æ•°ã€‚çªå‘é™åˆ¶è®¾ç½®ä¸ºæ­¤é™åˆ¶ä¹˜ä»¥çªå‘å€æ•°ï¼Œé»˜è®¤å€æ•°ä¸º 5ã€‚å½“å®¢æˆ·ç«¯è¶…è¿‡æ­¤é™åˆ¶æ—¶ï¼Œè¿”å›<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">limit-req-status-code </a>*<strong>default:*</strong> 503ã€‚</li><li><code>nginx.ingress.kubernetes.io/limit-burst-multiplier</code>: çªå‘å¤§å°é™åˆ¶ç‡çš„ä¹˜æ•°ã€‚é»˜è®¤çªå‘ä¹˜æ•°ä¸º 5ï¼Œæ­¤æ³¨é‡Šè¦†ç›–é»˜è®¤ä¹˜æ•°ã€‚å½“å®¢æˆ·ç«¯è¶…è¿‡æ­¤é™åˆ¶æ—¶ï¼Œè¿”å›<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#limit-req-status-code">limit-req-status-code </a>*<strong>default:*</strong> 503ã€‚</li><li><code>nginx.ingress.kubernetes.io/limit-rate-after</code>ï¼šåˆå§‹åƒå­—èŠ‚æ•°ï¼Œä¹‹åå¯¹ç»™å®šè¿æ¥çš„å“åº”çš„è¿›ä¸€æ­¥ä¼ è¾“å°†å—åˆ°é€Ÿç‡é™åˆ¶ã€‚æ­¤åŠŸèƒ½å¿…é¡»åœ¨å¯ç”¨<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#proxy-buffering">ä»£ç†ç¼“å†²</a>çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</li><li><code>nginx.ingress.kubernetes.io/limit-rate</code>ï¼šæ¯ç§’å…è®¸å‘é€åˆ°ç»™å®šè¿æ¥çš„åƒå­—èŠ‚æ•°ã€‚é›¶å€¼ç¦ç”¨é€Ÿç‡é™åˆ¶ã€‚æ­¤åŠŸèƒ½å¿…é¡»åœ¨å¯ç”¨<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#proxy-buffering">ä»£ç†ç¼“å†²</a>çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚</li><li><code>nginx.ingress.kubernetes.io/limit-whitelist</code>ï¼šè¦ä»é€Ÿç‡é™åˆ¶ä¸­æ’é™¤çš„å®¢æˆ·ç«¯ IP æºèŒƒå›´ã€‚è¯¥å€¼æ˜¯ä¸€ä¸ªé€—å·åˆ†éš”çš„ CIDR åˆ—è¡¨ã€‚</li></ul><h3 id="ä¸ƒ-å¼ºåˆ¶è·³è½¬https"><a href="#ä¸ƒ-å¼ºåˆ¶è·³è½¬https" class="headerlink" title="ä¸ƒ.å¼ºåˆ¶è·³è½¬https"></a>ä¸ƒ.å¼ºåˆ¶è·³è½¬https</h3><pre class=" language-yaml"><code class="language-yaml">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span> /    <span class="token key atrule">nginx.ingress.kubernetes.io/force-ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"true"</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"true"</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/preserve-trailing-slash</span><span class="token punctuation">:</span> <span class="token string">"true"</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ingress-nginxé…ç½® httpsè®¿é—®</title>
      <link href="/f619b970/"/>
      <url>/f619b970/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€ã€é…ç½®è¯ä¹¦"><a href="#ä¸€ã€é…ç½®è¯ä¹¦" class="headerlink" title="ä¸€ã€é…ç½®è¯ä¹¦"></a>ä¸€ã€é…ç½®è¯ä¹¦</h1><h3 id="1-1-åˆ›å»ºè¯ä¹¦secret"><a href="#1-1-åˆ›å»ºè¯ä¹¦secret" class="headerlink" title="1.1 åˆ›å»ºè¯ä¹¦secret"></a>1.1 åˆ›å»ºè¯ä¹¦secret</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8smaster TSL<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl create secret  tls huhuhahei  --key=private.key --cert=public.pem  -n  lnmp</span>secret/huhuhahei created</code></pre><h1 id="äºŒ-ã€é…ç½®Ingress"><a href="#äºŒ-ã€é…ç½®Ingress" class="headerlink" title="äºŒ ã€é…ç½®Ingress"></a>äºŒ ã€é…ç½®Ingress</h1><h3 id="2-1-åˆ›å»ºingress"><a href="#2-1-åˆ›å»ºingress" class="headerlink" title="2.1  åˆ›å»ºingress"></a>2.1  åˆ›å»ºingress</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>ingress<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">tls</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> web.huhuhahei.cn    <span class="token punctuation">-</span> <span class="token key atrule">secretName</span><span class="token punctuation">:</span> huhuhahei  <span class="token key atrule">rules</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> web.huhuhahei.cn      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">paths</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /          <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix          <span class="token key atrule">backend</span><span class="token punctuation">:</span>            <span class="token key atrule">service</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>php              <span class="token key atrule">port</span><span class="token punctuation">:</span>                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre><h1 id="ä¸‰-ã€æµ‹è¯•"><a href="#ä¸‰-ã€æµ‹è¯•" class="headerlink" title="ä¸‰ ã€æµ‹è¯•"></a>ä¸‰ ã€æµ‹è¯•</h1><h3 id="3-1æµè§ˆå™¨æŸ¥çœ‹è¯ä¹¦"><a href="#3-1æµè§ˆå™¨æŸ¥çœ‹è¯ä¹¦" class="headerlink" title="3.1æµè§ˆå™¨æŸ¥çœ‹è¯ä¹¦"></a>3.1æµè§ˆå™¨æŸ¥çœ‹è¯ä¹¦</h3><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2021/09/207112106.png"></p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockeræ¸…ç†æ— ç”¨é•œåƒåŠå·ç»„å ç”¨çš„ç©ºé—´</title>
      <link href="/2d895da1/"/>
      <url>/2d895da1/</url>
      
        <content type="html"><![CDATA[<p>ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œæ€»æ˜¯ä¼šé‡åˆ°æœåŠ¡å™¨ç£ç›˜è¢«dockerå æ»¡çš„æƒ…å†µ<br>æ¯”å¦‚è¿™æ ·<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/03/479329848.jpg"><br>ä¹Ÿå°±è·‘äº†å‡ ä¸ªå®¹å™¨ï¼Œè«åå…¶å¦™ç£ç›˜å°±æ²¡äº†::(æ³ª)<br>äºæ˜¯ä¸Šç½‘æ‰¾æ–¹æ¡ˆ</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system df </span>TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLEImages          46        46        14.44GB   435MB <span class="token punctuation">(</span>3%<span class="token punctuation">)</span>Containers      121       108       1.359GB   3.478kB <span class="token punctuation">(</span>0%<span class="token punctuation">)</span>Local Volumes   32        2         5.273GB   5.273GB <span class="token punctuation">(</span>100%<span class="token punctuation">)</span></code></pre><p>è¿™ä¸ªå‘½ä»¤å¯ä»¥æŸ¥çœ‹ç›®å‰æˆ‘ä»¬å¯ä»¥æ¸…ç†çš„dockerç¼“å­˜ï¼Œåˆ†åˆ«ä¸ºé•œåƒï¼Œå®¹å™¨ï¼Œæ•°æ®å·</p><p>å¯ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ¸…ç†</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system prune -a</span>WARNING<span class="token operator">!</span> This will remove:  - all stopped containers  - all networks not used by at least one container  - all dangling images  - all dangling build cacheAre you sure you want to continue? <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span> y</code></pre><p>-a å‚æ•°æ¸…ç†çš„æ›´åŠ å½»åº• å¯ä»¥å°†æ²¡æœ‰å®¹å™¨ä½¿ç”¨Dockeré•œåƒéƒ½åˆ æ‰ã€‚æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªå‘½ä»¤ä¼šæŠŠä½ æš‚æ—¶å…³é—­çš„å®¹å™¨ï¼Œä»¥åŠæš‚æ—¶æ²¡æœ‰ç”¨åˆ°çš„Dockeré•œåƒéƒ½åˆ æ‰äº†â€¦â€¦æ‰€ä»¥ä½¿ç”¨ä¹‹å‰ä¸€å®šè¦æƒ³æ¸…æ¥šå¶ã€‚</p><p>æ¸…ç†åå‘ç°ç©ºé—´å¹¶æ²¡æœ‰å‡å°‘ ä»”ç»†æŸ¥çœ‹å‘ç°æ˜¯32ç£ç›˜ ä½†æ˜¯åªæœ‰2ä¸ªå†ç”¨ åœ¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤çœ‹çœ‹</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker volume ls -qf dangling=true</span>0d322472e941707dc9cdf72ae21647ace2e866d061781c1b3102f026454ff1bb0fd37de5d1b7e9a7b047ef7564dc2f7cff9a430e091afaf8b3bce80d967160795cf16842c76f2b5ac32a37bb4cff4b1b691a1323b59db01adcf0569966746d919cb673514123500c7f6f0c0c777d99813c6489832638c261bfaffb9cea01c30f23e3eb4e2c4ce36b484278c882a4ff77b8b73a0afcb42f9d4fb4bbd9da04b30551a3a18fe7339d97627c894d636a07503244f15f05a945f8ba0e326e53bac4fd61bc3ad6461da6f126e6191509e7964a34c8b9514a2c488462e9b2a465ddd54189c4921a2c858db86534e0924f5f64786dfcb193b95d98bb468eb2b4e401443c146ee0f6e0a42cdfa112a69780637f6a28120fdd56d129e3f697c68a01e6791b176b4fa0c65897c355aafff690bf7a97b419ecf9877b1d518b8574cf86b88971517bd77537b86937ec43778a171b027ed3200f9ba4405740343dc748a366103b540c32012f161afee2abab0ea62f9621612c99392d51bbb266c4e8953f8e3302976d1335e32ea78551c0b8ebf96cd626d5cdae78379a4e3b685672ff30911628Â·Â·Â·Â·</code></pre><p>å¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šæ²¡æœ‰æŒ‚è½½çš„ç£ç›˜</p><p>å¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤æ¸…ç†</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker volume rm $(docker volume ls -qf dangling=true)</span>0d322472e941707dc9cdf72ae21647ace2e866d061781c1b3102f026454ff1bb0fd37de5d1b7e9a7b047ef7564dc2f7cff9a430e091afaf8b3bce80d967160795cf16842c76f2b5ac32a37bb4cff4b1b691a1323b59db01adcf0569966746d919cb673514123500c7f6f0c0c777d99813c6489832638c261bfaffb9cea01c30f23e3eb4e2c4ce36b484278c882a4ff77b8b73a0afcb42f9d4fb4bbd9da04b30551a3a18fe7339d97627c894d636a07503244f15f05a945f8ba0e326e53bac4fd61bc3ad6461da6f126e6191509e7964a34c8b9514a2c488462e9b2a465ddd541</code></pre><p>æ¸…ç†å®Œæˆå†æ¬¡æŸ¥çœ‹</p><pre class=" language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node01 docker<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system df </span>TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLEImages          46        46        14.44GB   435MB <span class="token punctuation">(</span>3%<span class="token punctuation">)</span>Containers      121       108       1.359GB   3.478kB <span class="token punctuation">(</span>0%<span class="token punctuation">)</span>Local Volumes   2         2         0B        0BBuild Cache     0         0         0B        0B</code></pre><p>å½“ç„¶ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ¸…ç†æ— tagçš„é•œåƒ</p><pre class=" language-bash"><code class="language-bash">docker rmi <span class="token punctuation">$(</span>docker images <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"^&lt;none>"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">"{print <span class="token variable">$3</span>}"</span><span class="token punctuation">)</span></code></pre><p>æ‰‹åŠ¨æ¸…ç†å…³é—­çš„å®¹å™¨</p><pre class=" language-bash"><code class="language-bash">docker <span class="token function">ps</span> -a <span class="token operator">|</span> <span class="token function">grep</span> Exit <span class="token operator">|</span> <span class="token function">cut</span> -d <span class="token string">' '</span> -f 1 <span class="token operator">|</span> <span class="token function">xargs</span> docker <span class="token function">rm</span></code></pre><p>ç©ºé—´å·²ç»ä¸‹æ¥äº† ::(é…·)</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¡æ­»å¯¼è‡´K8sNodeèŠ‚ç‚¹NotReady</title>
      <link href="/undefined/"/>
      <url>/undefined/</url>
      
        <content type="html"><![CDATA[<p>æŸå¤©å‘ç°æµ‹è¯•ç¯å¢ƒèŠ‚ç‚¹å¿½ç„¶å˜ä¸ºNotRead å¯¼è‡´æœåŠ¡å¼‚å¸¸:@(å†…ä¼¤)<br>ç°è±¡æ˜¯è¿™æ ·çš„<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/4059467715.png"><br>describeæŸ¥çœ‹æ˜¯è¿™æ ·çš„<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/3548693712.png"><br>åˆæ­¥æ„Ÿè§‰æ˜¯èŠ‚ç‚¹æœ‰é—®é¢˜äº† ä¸€èˆ¬å‡ºç°èŠ‚ç‚¹NotReadyæ— éæ˜¯ èŠ‚ç‚¹CPU å†…å­˜ ç£ç›˜ å’Œç½‘ç»œå‡ºé—®é¢˜äº†<br>ç»“æœè¿™æ ·ä¸€æ’æŸ¥ å‘ç°éƒ½æ²¡é—®é¢˜:@(å–·è¡€)<br>ä¸‹é¢åªèƒ½çœ‹ä¸‹kubeletå’Œdockerçš„çŠ¶æ€å’Œæ—¥å¿—<br>kubelet</p><pre class=" language-bash"><code class="language-bash">systemctl status kubeletâ— kubelet.service - Kubernetes KubeletLoaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/kubelet.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2022-02-14 11:04:52 CST<span class="token punctuation">;</span> 3min 28s agoDocs: https://github.com/GoogleCloudPlatform/kubernetesProcess: 24722 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/systemd/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24719 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/pids/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24716 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/memory/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24713 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/hugetlb/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24710 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/cpuset/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Process: 24707 ExecStartPre<span class="token operator">=</span>/bin/mkdir -p /sys/fs/cgroup/cpuacct/system.slice <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span></code></pre><p>docker</p><pre class=" language-bash"><code class="language-bash">systemctl status dockerâ— docker.service - Docker Application Container EngineLoaded: loaded <span class="token punctuation">(</span>/etc/systemd/system/docker.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon 2022-02-14 11:04:42 CST<span class="token punctuation">;</span> 6s agoDocs: http://docs.docker.ioProcess: 24482 ExecStartPost<span class="token operator">=</span>/sbin/iptables -I FORWARD -s 0.0.0.0/0 -j ACCEPT <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, status<span class="token operator">=</span>0/SUCCESS<span class="token punctuation">)</span>Main PID: 24480 <span class="token punctuation">(</span>dockerd<span class="token punctuation">)</span>Tasks: 123Memory: 946.6MCGroup: /system.slice/docker.service</code></pre><p>ä¸¤ä¸ªçŠ¶æ€éƒ½æ˜¯runningçŠ¶æ€ åªèƒ½çœ‹ä¸‹æ—¥å¿—ä¿¡æ¯äº†<br>æŸ¥çœ‹kubeletæ—¥å¿—ä¿¡æ¯<br><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/1507988096.png"></p><p>å¯ä»¥çœ‹åˆ°kubeletè¿æ¥dockeræœ‰é—®é¢˜ ä¸€ç›´åœ¨é‡å¯</p><p>åªèƒ½åœ¨çœ‹ä¸‹dockeræ—¥å¿—ä¿¡æ¯äº†</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/02/3767755695.png"><br>çœ‹è¿™ä¸ªæŠ¥é”™åœ¨ç½‘ä¸Šæœç´¢æ²¡ä»€ä¹ˆå‘ç° äºæ˜¯æˆ‘å¥½å¥‡docker psäº†ä¸‹ å‘ç°ä¸€ç›´å¡æ­»æ²¡æœ‰è¾“å‡º<br>è¿™å°±å¾ˆå¥‡æ€ª dockeræœåŠ¡æ­£å¸¸ ä¸åº”è¯¥æ²¡æœ‰è¾“å‡ºå‘€ äºæ˜¯åˆæ˜¯ä¸€ç•ªç™¾åº¦æ‰¾åˆ°ä¸€ä¸ªç±»ä¼¼çš„<br><a href="https://www.bianchengquan.com/article/155669.html">https://www.bianchengquan.com/article/155669.html</a><br>å‘ç°åº”è¯¥æ˜¯dockerç‰ˆæœ¬è¿‡ä½è§¦å‘çš„ç‰ˆæœ¬ä¸å…¼å®¹ ä¸´æ—¶å…ˆkillæ‰runcè¿›ç¨‹åé‡å¯kubeletå’Œdockerå°±æ¢å¤äº† åé¢è¿˜æ˜¯è¦æ—¶å¸¸å…³æ³¨æœåŠ¡çš„ç‰ˆæœ¬</p>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NACOSéƒ¨ç½²</title>
      <link href="/c2586a0/"/>
      <url>/c2586a0/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¸€-å‰è¨€"><a href="#ä¸€-å‰è¨€" class="headerlink" title="ä¸€.å‰è¨€"></a>ä¸€.å‰è¨€</h1><h3 id="1-1ç®€ä»‹"><a href="#1-1ç®€ä»‹" class="headerlink" title="1.1ç®€ä»‹"></a>1.1ç®€ä»‹</h3><p><a href="https://so.csdn.net/so/search?q=Nacos">Nacos</a>æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾æ”¯æŒæœåŠ¡æ³¨å†Œä¸å‘ç°ï¼Œé…ç½®ç®¡ç†ä»¥åŠå¾®æœåŠ¡ç®¡ç†çš„ç»„ä»¶ã€‚ç”¨æ¥å–ä»£ä»¥å‰å¸¸ç”¨çš„æ³¨å†Œä¸­å¿ƒï¼ˆzookeeper , eurekaç­‰ç­‰ï¼‰ï¼Œä»¥åŠé…ç½®ä¸­å¿ƒï¼ˆspring cloud configç­‰ç­‰ï¼‰ã€‚Nacosæ˜¯é›†æˆäº†æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒçš„åŠŸèƒ½ï¼Œåšåˆ°äº†äºŒåˆä¸€ã€‚</p><h1 id="äºŒ-Nacoséƒ¨ç½²"><a href="#äºŒ-Nacoséƒ¨ç½²" class="headerlink" title="äºŒ.Nacoséƒ¨ç½²"></a>äºŒ.Nacoséƒ¨ç½²</h1><h3 id="2-1-åˆ›å»ºæ•°æ®åº“ç”¨æˆ·å¹¶åˆå§‹åŒ–é…ç½®"><a href="#2-1-åˆ›å»ºæ•°æ®åº“ç”¨æˆ·å¹¶åˆå§‹åŒ–é…ç½®" class="headerlink" title="2.1 åˆ›å»ºæ•°æ®åº“ç”¨æˆ·å¹¶åˆå§‹åŒ–é…ç½®"></a>2.1 åˆ›å»ºæ•°æ®åº“ç”¨æˆ·å¹¶åˆå§‹åŒ–é…ç½®</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> nacos <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span><span class="token keyword">grant</span> <span class="token keyword">all</span> <span class="token keyword">privileges</span> <span class="token keyword">on</span> nacos<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> nacos@'<span class="token operator">%</span><span class="token string">' identified by '</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>' <span class="token keyword">with</span> <span class="token keyword">grant</span> <span class="token keyword">option</span><span class="token punctuation">;</span>flush privilages<span class="token punctuation">;</span></code></pre><p>å¯¼å…¥nacosåˆå§‹åŒ–sql</p><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* * Copyright 1999-2018 Alibaba Group Holding Ltd. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * *      http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   æ•°æ®åº“å…¨å = nacos_config   */</span><span class="token comment" spellcheck="true">/*   è¡¨åç§° = config_info   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_use<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>effect<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c_schema<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfo_datagrouptenant<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   æ•°æ®åº“å…¨å = nacos_config   */</span><span class="token comment" spellcheck="true">/*   è¡¨åç§° = config_info_aggr   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_aggr<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'datum_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'å†…å®¹'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfoaggr_datagrouptenantdatum<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>datum_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'å¢åŠ ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   æ•°æ®åº“å…¨å = nacos_config   */</span><span class="token comment" spellcheck="true">/*   è¡¨åç§° = config_info_beta   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_beta<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>beta_ips<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'betaIps'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfobeta_datagrouptenant<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_beta'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   æ•°æ®åº“å…¨å = nacos_config   */</span><span class="token comment" spellcheck="true">/*   è¡¨åç§° = config_info_tag   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_info_tag<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'content'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'md5'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span> <span class="token keyword">COMMENT</span> <span class="token string">'source user'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'source ip'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configinfotag_datagrouptenanttag<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_info_tag'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   æ•°æ®åº“å…¨å = nacos_config   */</span><span class="token comment" spellcheck="true">/*   è¡¨åç§° = config_tags_relation   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>config_tags_relation<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tag_type'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'data_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'group_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>nid<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>nid<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_configtagrelation_configidtag<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tag_type<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'config_tag_relation'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   æ•°æ®åº“å…¨å = nacos_config   */</span><span class="token comment" spellcheck="true">/*   è¡¨åç§° = group_capacity   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>group_capacity<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¸»é”®ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Group IDï¼Œç©ºå­—ç¬¦è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>quota<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">usage</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä½¿ç”¨é‡'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°ï¼Œï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æœ€å¤§å˜æ›´å†å²æ•°é‡'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_group_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>group_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'é›†ç¾¤ã€å„Groupå®¹é‡ä¿¡æ¯è¡¨'</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   æ•°æ®åº“å…¨å = nacos_config   */</span><span class="token comment" spellcheck="true">/*   è¡¨åç§° = his_config_info   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>his_config_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>nid<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>data_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>group_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>app_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'app_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>content<span class="token punctuation">`</span> <span class="token keyword">longtext</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>md5<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_user<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>src_ip<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>op_type<span class="token punctuation">`</span> char<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'ç§Ÿæˆ·å­—æ®µ'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>nid<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_gmt_create<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_gmt_modified<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_did<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>data_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'å¤šç§Ÿæˆ·æ”¹é€ '</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token comment" spellcheck="true">/*   æ•°æ®åº“å…¨å = nacos_config   */</span><span class="token comment" spellcheck="true">/*   è¡¨åç§° = tenant_capacity   */</span><span class="token comment" spellcheck="true">/******************************************/</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tenant_capacity<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¸»é”®ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'Tenant ID'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>quota<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'é…é¢ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">usage</span><span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä½¿ç”¨é‡'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªé…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'èšåˆå­é…ç½®æœ€å¤§ä¸ªæ•°'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_aggr_size<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'å•ä¸ªèšåˆæ•°æ®çš„å­é…ç½®å¤§å°ä¸Šé™ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œ0è¡¨ç¤ºä½¿ç”¨é»˜è®¤å€¼'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>max_history_count<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> unsigned <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'æœ€å¤§å˜æ›´å†å²æ•°é‡'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'ç§Ÿæˆ·å®¹é‡ä¿¡æ¯è¡¨'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tenant_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>kp<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'kp'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_id'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_name'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>tenant_desc<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'tenant_desc'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>create_source<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'create_source'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'åˆ›å»ºæ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'ä¿®æ”¹æ—¶é—´'</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk_tenant_info_kptenantid<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>kp<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_tenant_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>tenant_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8_bin <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'tenant_info'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>password<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>enabled<span class="token punctuation">`</span> <span class="token keyword">boolean</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>roles<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>idx_user_role<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">ASC</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">ASC</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>permissions<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>role<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>resource<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>    <span class="token keyword">UNIQUE</span> <span class="token keyword">INDEX</span> <span class="token punctuation">`</span>uk_role_permission<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>role<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>resource<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token keyword">action</span><span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> users <span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu'</span><span class="token punctuation">,</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> roles <span class="token punctuation">(</span>username<span class="token punctuation">,</span> role<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'nacos'</span><span class="token punctuation">,</span> <span class="token string">'ROLE_ADMIN'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="2-2-åˆ›å»ºå­˜å‚¨"><a href="#2-2-åˆ›å»ºå­˜å‚¨" class="headerlink" title="2.2 åˆ›å»ºå­˜å‚¨"></a>2.2 åˆ›å»ºå­˜å‚¨</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner      <span class="token key atrule">containers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner          <span class="token key atrule">image</span><span class="token punctuation">:</span> jmgao1983/nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>latest          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes          <span class="token key atrule">env</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME              <span class="token key atrule">value</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos  <span class="token comment" spellcheck="true"># æ­¤å¤„ä¾›åº”è€…åå­—ä¾›storageclassè°ƒç”¨</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER              <span class="token key atrule">value</span><span class="token punctuation">:</span> 10.46.8.18   <span class="token comment" spellcheck="true"># å¡«å…¥NFSçš„åœ°å€</span>            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/nacos_data  <span class="token comment" spellcheck="true"># å¡«å…¥NFSæœåŠ¡å™¨æŒ‚è½½çš„ç›®å½•</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>            <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.46.8.18   <span class="token comment" spellcheck="true"># å¡«å…¥NFSçš„åœ°å€</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/nacos_data   <span class="token comment" spellcheck="true"># å¡«å…¥NFSæœåŠ¡å™¨æŒ‚è½½çš„ç›®å½•</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>nacos<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>nacos<span class="token comment" spellcheck="true"># Supported policies: Deleteã€ Retain ï¼Œ default is Delete</span><span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain</code></pre><h3 id="2-3-åˆ›å»ºmysqlé…ç½®æ–‡ä»¶"><a href="#2-3-åˆ›å»ºmysqlé…ç½®æ–‡ä»¶" class="headerlink" title="2.3 åˆ›å»ºmysqlé…ç½®æ–‡ä»¶"></a>2.3 åˆ›å»ºmysqlé…ç½®æ–‡ä»¶</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">mysql.db.name</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">mysql.host</span><span class="token punctuation">:</span> mysql.blog.svc.cluster.local  <span class="token key atrule">mysql.password</span><span class="token punctuation">:</span> *******  <span class="token key atrule">mysql.port</span><span class="token punctuation">:</span> <span class="token string">"3306"</span>  <span class="token key atrule">mysql.user</span><span class="token punctuation">:</span> nacos<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm</code></pre><h3 id="2-4-åˆ›å»ºstsæ§åˆ¶å™¨"><a href="#2-4-åˆ›å»ºstsæ§åˆ¶å™¨" class="headerlink" title="2.4 åˆ›å»ºstsæ§åˆ¶å™¨"></a>2.4 åˆ›å»ºstsæ§åˆ¶å™¨</h3><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> OrderedReady  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                <span class="token key atrule">values</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> nacos            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_REPLICAS          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"3"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SERVICE_NAME          <span class="token key atrule">value</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOMAIN_NAME          <span class="token key atrule">value</span><span class="token punctuation">:</span> cluster.local        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAMESPACE          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>              <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_DB_NAME          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.db.name              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_HOST          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.host              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PORT          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.port              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_USER          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.user              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_SERVICE_PASSWORD          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql.password              <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>cm        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_SERVER_PORT          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"8848"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NACOS_APPLICATION_PORT          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"8848"</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PREFER_HOST_MODE          <span class="token key atrule">value</span><span class="token punctuation">:</span> hostname        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMS          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMX          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> JVM_XMN          <span class="token key atrule">value</span><span class="token punctuation">:</span> 256m        <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>server<span class="token punctuation">:</span>2.0.1        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>port          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>          <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>          <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>          <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>        <span class="token key atrule">resources</span><span class="token punctuation">:</span>          <span class="token key atrule">requests</span><span class="token punctuation">:</span>            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512m        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/plugins/peer<span class="token punctuation">-</span>finder          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/data          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> data        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/logs          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> logs      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>finder<span class="token punctuation">-</span>plugin<span class="token punctuation">:</span><span class="token number">1.1</span>        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always        <span class="token key atrule">name</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder<span class="token punctuation">-</span>plugin<span class="token punctuation">-</span>install        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /home/nacos/plugins/peer<span class="token punctuation">-</span>finder          <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> peer<span class="token punctuation">-</span>finder  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>      <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1    <span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> data    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ReadWriteOnce      <span class="token key atrule">resources</span><span class="token punctuation">:</span>        <span class="token key atrule">requests</span><span class="token punctuation">:</span>          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 50Gi      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>storageclass      <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem</code></pre><h3 id="2-5-åˆ›å»ºsvc"><a href="#2-5-åˆ›å»ºsvc" class="headerlink" title="2.5 åˆ›å»ºsvc"></a>2.5 åˆ›å»ºsvc</h3><p>nacos_headless.svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">service.alpha.kubernetes.io/tolerate-unready-endpoints</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>headless<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> server    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> client<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> raft<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> old<span class="token punctuation">-</span>raft<span class="token punctuation">-</span>rpc    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">7848</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</code></pre><p>nacos_svc</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>service<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span><span class="token number">8</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9848</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9848</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> grpc<span class="token punctuation">-</span><span class="token number">9</span>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9849</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9849</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nacos  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort</code></pre><p>éƒ¨ç½²å®Œæˆå³å¯webè®¿é—®</p><p><img src="https://huhuhahei.oss-cn-hangzhou.aliyuncs.com/blog/images/blog/2022/01/2162338859.png"></p>]]></content>
      
      
      <categories>
          
          <category> K8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¼€æºé¡¹ç›® </tag>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
